<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شركة عراق سيل </title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;600;700;800;900&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/arabic-reshaper/2.2.3/arabic-reshaper.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bidi-pdf/0.1.0/bidi-pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f0f0f0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: rgba(128, 28, 50, 0.2);
            --border-light: rgba(128, 28, 50, 0.1);
            --primary-color: #801c32;
            --primary-hover: #a52d45;
            --shadow-sm: rgba(128, 28, 50, 0.05);
            --shadow-md: rgba(128, 28, 50, 0.15);
            --shadow-lg: rgba(128, 28, 50, 0.25);
            --card-bg: #ffffff;
            --sidebar-bg: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            --nav-bg: rgba(255, 255, 255, 0.6);
            --nav-hover: rgba(128, 28, 50, 0.06);
            --input-bg: #ffffff;
            --input-border: rgba(128, 28, 50, 0.2);
            --modal-bg: #ffffff;
            --table-bg: #ffffff;
            --table-header: #801c32;
            --table-border: #ddd;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #3a3a3a;
            --text-primary: #f5f5f5;
            --text-secondary: #d0d0d0;
            --text-tertiary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.15);
            --border-light: rgba(255, 255, 255, 0.1);
            --primary-color: #ff4757;
            --primary-hover: #ff6b7a;
            --shadow-sm: rgba(0, 0, 0, 0.3);
            --shadow-md: rgba(0, 0, 0, 0.5);
            --shadow-lg: rgba(0, 0, 0, 0.7);
            --card-bg: #2d2d2d;
            --sidebar-bg: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            --nav-bg: rgba(45, 45, 45, 0.8);
            --nav-hover: rgba(255, 71, 87, 0.15);
            --input-bg: #3a3a3a;
            --input-border: rgba(255, 255, 255, 0.2);
            --modal-bg: #2d2d2d;
            --table-bg: #2d2d2d;
            --table-header: #ff4757;
            --table-border: #444444;
        }

        [data-theme="dark"] * {
            text-shadow: none;
        }

        [data-theme="dark"] .nav-text,
        [data-theme="dark"] .nav-item,
        [data-theme="dark"] .section-title,
        [data-theme="dark"] .agent-name-title,
        [data-theme="dark"] .info-value,
        [data-theme="dark"] .result-card h3,
        [data-theme="dark"] .result-card .count {
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .text-primary,
        [data-theme="dark"] body,
        [data-theme="dark"] .main-content {
            color: var(--text-primary);
            font-weight: 400;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', 'Segoe UI', 'Arial', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        html, body {
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            position: relative;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            letter-spacing: 0.01em;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            -webkit-overflow-scrolling: touch;
            margin: 0;
            padding: 0;
        }

        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, var(--shadow-sm) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, var(--shadow-sm) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            opacity: 0.5;
        }

        [data-theme="dark"] body::before {
            opacity: 0.3;
        }

        .container {
            display: flex;
            width: 100%;
            max-width: 100vw;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .sidebar {
            width: 240px;
            max-width: 240px;
            background: var(--sidebar-bg);
            border-left: 3px solid var(--primary-color);
            box-shadow: 4px 0 20px var(--shadow-md);
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px 0;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.3s ease, background 0.3s ease, border-color 0.3s ease;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            box-sizing: border-box;
        }

        .sidebar.hidden {
            transform: translateX(100%);
        }

        .sidebar-toggle-btn {
            position: fixed;
            right: 20px;
            top: 8px;
            z-index: 1002;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            box-shadow: 0 1px 3px var(--shadow-sm);
            transition: all 0.3s ease;
            font-weight: 700;
        }

        .sidebar.hidden ~ .sidebar-toggle-btn,
        .sidebar.hidden + .sidebar-toggle-btn {
            display: flex;
        }

        .sidebar-toggle-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 2px 6px var(--shadow-md);
        }


        .theme-toggle-btn-small {
            position: fixed;
            left: 20px;
            top: 22px;
            z-index: 1002;
            width: 32px;
            height: 32px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            padding: 0;
            margin: 0;
            box-shadow: 0 1px 3px var(--shadow-sm);
        }

        .theme-toggle-btn-small:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 2px 6px var(--shadow-md);
        }

        .theme-toggle-btn-small:active {
            transform: scale(0.95) rotate(0deg);
        }

        .theme-toggle-btn-small span {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        [data-theme="dark"] .theme-toggle-btn-small span {
            transform: rotate(180deg);
        }

        #loginScreen[style*="display: flex"] ~ .sidebar-toggle-btn,
        #loginScreen[style*="display: block"] ~ .sidebar-toggle-btn {
            display: none !important;
        }

        #dashboard[style*="display: none"] ~ .sidebar-toggle-btn,
        #dashboard[style*="display: none"] .sidebar-toggle-btn,
        #dashboard[style*="display: none"] ~ .theme-toggle-btn-small,
        #dashboard[style*="display: none"] .theme-toggle-btn-small {
            display: none !important;
        }

        #loginScreen[style*="display: flex"] ~ .theme-toggle-btn-small,
        #loginScreen[style*="display: block"] ~ .theme-toggle-btn-small {
            display: none !important;
        }

        .sidebar-header {
            padding: 20px 20px 16px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 12px;
            transition: border-color 0.3s ease;
        }

        .sidebar-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 12px;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            font-weight: 900;
            text-align: center;
            letter-spacing: 1px;
            margin: 8px 0 0;
            flex: 1;
            line-height: 1.2;
            transition: color 0.3s ease;
        }


        .sidebar-nav {
            flex: 1;
            padding: 8px 12px;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            margin-bottom: 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            color: #1a1a1a;
            font-weight: 600;
            font-size: 0.95rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            position: relative;
            overflow: hidden;
            background: var(--nav-bg);
            border: 1px solid transparent;
            backdrop-filter: blur(10px);
            line-height: 1.5;
        }

        [data-theme="dark"] .nav-item {
            color: #f5f5f5;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-color), var(--primary-hover));
            transform: translateX(100%);
            transition: transform 0.25s ease;
            border-radius: 0 8px 8px 0;
        }

        .nav-item::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            width: 0;
            height: 0;
            background: var(--shadow-sm);
            border-radius: 50%;
            transform: translate(50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
        }

        .nav-item:hover::after {
            width: 200px;
            height: 200px;
        }

        .nav-item:hover::before,
        .nav-item.active::before {
            transform: translateX(0);
        }

        .nav-item:hover {
            background: var(--nav-hover);
            border-color: var(--border-color);
            transform: translateX(-3px);
            box-shadow: 0 2px 8px var(--shadow-md);
            color: var(--primary-color);
        }

        .nav-item.active {
            background: linear-gradient(90deg, var(--nav-hover), var(--nav-bg));
            border-color: var(--primary-color);
            border-width: 1px;
            color: var(--primary-color);
            box-shadow: 0 3px 12px var(--shadow-md);
            transform: translateX(-3px);
            font-weight: 600;
        }

        .nav-icon {
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nav-text {
            flex: 1;
            font-size: 0.95rem;
            font-weight: 600;
            letter-spacing: 0.2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            color: #1a1a1a;
        }

        [data-theme="dark"] .nav-text {
            color: #f5f5f5;
        }

        .sidebar-footer {
            padding: 12px 20px;
            border-top: 2px solid var(--border-color);
            margin-top: 8px;
            transition: border-color 0.3s ease;
        }

        .user-info-sidebar {
            color: var(--primary-color);
            font-size: 14px;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .date-info-sidebar {
            color: #1a1a1a;
            font-size: 12px;
            text-align: center;
            transition: color 0.3s ease;
            font-weight: 600;
        }

        [data-theme="dark"] .date-info-sidebar {
            color: #f5f5f5;
        }

        .main-content {
            flex: 1;
            margin-right: 280px;
            padding: 50px 45px;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            width: calc(100% - 280px);
            max-width: calc(100% - 280px);
            overflow-x: hidden;
            position: relative;
            z-index: 1;
            box-sizing: border-box;
        }

        .main-content.sidebar-hidden {
            margin-right: 0;
            width: 100%;
            max-width: 100%;
        }

        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            width: 100%;
        }

        .login-form {
            background: var(--card-bg);
            padding: 60px 50px;
            border-radius: 30px;
            box-shadow: 0 20px 60px var(--shadow-md);
            width: 100%;
            max-width: 480px;
            text-align: center;
            border: 3px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .login-form::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
            transition: background 0.3s ease;
        }

        .login-logo {
            font-size: 3.5rem;
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .login-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 35px;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: bold;
            transition: color 0.3s ease;
        }

        .form-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--input-border);
            border-radius: 15px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: right;
            background: var(--input-bg);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.5;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 20px var(--shadow-md);
            transform: translateY(-2px);
            background: var(--input-bg);
            font-weight: 600;
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px var(--shadow-md);
        }

        .login-btn:hover {
            transform: translateY(-3px);
            background: var(--primary-hover);
            box-shadow: 0 12px 35px var(--shadow-lg);
        }

        .login-btn:active {
            transform: translateY(-1px);
        }

        .dashboard {
            display: none;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            position: relative;
            box-sizing: border-box;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tab-content.active {
            display: block;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .section {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 30px;
            border: 2px solid var(--border-light);
            box-shadow: 
                0 10px 30px var(--shadow-sm),
                0 5px 15px var(--shadow-sm);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            overflow-x: hidden;
            color: var(--text-primary);
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        #percentageResults.section {
            overflow: visible;
            overflow-x: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        #percentageTableContainer {
            width: 100% !important;
            max-width: 100% !important;
            box-sizing: border-box !important;
            overflow-x: auto !important;
            overflow-y: auto !important;
            will-change: scroll-position;
            contain: layout style paint;
            position: relative;
            isolation: isolate;
        }

        #percentageTableContainer::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        #percentageTableContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #percentageTableContainer::-webkit-scrollbar-thumb {
            background: #801c32;
            border-radius: 4px;
        }

        #percentageTableContainer::-webkit-scrollbar-thumb:hover {
            background: #a52d45;
        }

        #percentageTable {
            width: auto;
            min-width: 100%;
            table-layout: auto;
            border-collapse: collapse;
            box-sizing: border-box;
            display: table;
        }

        #percentageTable th,
        #percentageTable td {
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        #agentPercentageTab {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        #agentPercentageTab .section {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(128, 28, 50, 0.05) 50%,
                transparent 70%
            );
            transform: rotate(45deg);
            transition: all 0.6s ease;
            opacity: 0;
        }

        .section:hover::before {
            animation: shine 1.5s ease-in-out;
            opacity: 1;
        }

        @keyframes shine {
            0% { transform: rotate(45deg) translateX(-100%) translateY(-100%); }
            100% { transform: rotate(45deg) translateX(100%) translateY(100%); }
        }

        .section:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 
                0 20px 50px var(--shadow-md),
                0 10px 30px var(--shadow-sm);
            border-color: var(--primary-color);
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary-color);
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-color);
            display: flex;
            align-items: center;
            gap: 15px;
            letter-spacing: 1px;
            position: relative;
            transition: color 0.3s ease, border-color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.4;
        }

        .file-upload {
            border: 3px dashed var(--primary-color);
            border-radius: 20px;
            padding: 50px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s ease;
            margin-bottom: 30px;
            background: var(--bg-secondary);
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 10px 30px var(--shadow-sm),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .file-upload::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(128, 28, 50, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .file-upload:hover::before {
            left: 100%;
        }

        .file-upload:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 
                0 20px 50px var(--shadow-md),
                0 10px 30px var(--shadow-sm),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
        }

        .file-upload.dragover {
            transform: scale(1.05);
            box-shadow: 
                0 25px 60px rgba(128, 28, 50, 0.2),
                0 15px 40px rgba(128, 28, 50, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            border-color: #801c32;
        }

        .file-upload p {
            margin: 0;
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary-color);
            position: relative;
            z-index: 2;
            letter-spacing: 0.8px;
            transition: color 0.3s ease;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 800;
            margin: 10px 8px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.15),
                0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #ffffff;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.5;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.6s ease;
        }

        .btn:active::before {
            width: 400px;
            height: 400px;
        }

        .btn-primary {
            background: var(--primary-color);
            box-shadow: 
                0 8px 25px var(--shadow-md),
                0 4px 15px var(--shadow-sm);
        }

        .btn-primary:hover {
            transform: translateY(-5px) scale(1.05);
            background: var(--primary-hover);
            box-shadow: 
                0 15px 40px var(--shadow-lg),
                0 8px 25px var(--shadow-md);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 
                0 8px 25px rgba(16, 185, 129, 0.4),
                0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-5px) scale(1.05);
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 
                0 15px 40px rgba(16, 185, 129, 0.5),
                0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            box-shadow: 
                0 8px 25px rgba(245, 158, 11, 0.4),
                0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            transform: translateY(-5px) scale(1.05);
            background: linear-gradient(135deg, #d97706, #b45309);
            box-shadow: 
                0 15px 40px rgba(245, 158, 11, 0.5),
                0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            color: #ffffff;
            border-color: rgba(239, 68, 68, 0.5);
        }

        .btn-danger:hover {
            background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(239, 68, 68, 0.4),
                0 0 20px rgba(239, 68, 68, 0.3);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
            padding: 10px;
        }

        .agents-grid-improved {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
            padding: 0;
            width: 100%;
            box-sizing: border-box;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 18px 15px;
            text-align: center;
            box-shadow: 
                0 6px 20px var(--shadow-sm),
                0 3px 10px var(--shadow-sm);
            border: 2px solid var(--border-light);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(128, 28, 50, 0.1), transparent);
            transition: left 0.6s ease;
        }

        .result-card:hover::before {
            left: 100%;
        }

        .result-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 
                0 12px 30px var(--shadow-md),
                0 6px 20px var(--shadow-sm);
            border-color: var(--primary-color);
        }

        .result-card.bronze {
            border-top: 3px solid #f59e0b;
        }

        .result-card.silver {
            border-top: 3px solid #94a3b8;
        }

        .result-card.gold {
            border-top: 3px solid #fbbf24;
        }

        .result-card.platinum {
            border-top: 3px solid #a855f7;
        }

        .result-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 2;
            text-transform: uppercase;
            transition: color 0.3s ease;
        }

        .result-card .count {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-color);
            margin-bottom: 12px;
            line-height: 1.1;
            position: relative;
            z-index: 2;
            transition: color 0.3s ease;
        }

        .result-card .amount {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            z-index: 2;
            margin: 8px 0;
            padding: 6px 0;
            border-top: 1px solid var(--border-light);
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        .result-card .amount:first-of-type {
            border-top: none;
        }

        .agent-info {
            background: var(--card-bg);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 
                0 15px 40px var(--shadow-md),
                0 8px 25px var(--shadow-sm);
            position: relative;
            overflow: hidden;
            border: 3px solid var(--primary-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .agent-info::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(128, 28, 50, 0.05), transparent);
            transform: rotate(45deg);
            animation: float 8s ease-in-out infinite;
        }

        .agent-info h3 {
            margin-bottom: 25px;
            font-size: 2rem;
            font-weight: 900;
            position: relative;
            z-index: 2;
            color: var(--primary-color);
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: color 0.3s ease;
        }

        .agent-info p {
            position: relative;
            z-index: 2;
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .hidden {
            display: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 60px 40px;
            background: var(--card-bg);
            border-radius: 25px;
            margin: 30px 0;
            box-shadow: 
                0 15px 40px var(--shadow-md),
                0 8px 25px var(--shadow-sm);
            border: 3px solid var(--primary-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .spinner {
            border: 5px solid var(--shadow-sm);
            border-top: 5px solid var(--primary-color);
            border-right: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
            box-shadow: 
                0 0 30px var(--shadow-md),
                0 6px 20px var(--shadow-sm);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: var(--primary-color);
            font-weight: 800;
            font-size: 1.2rem;
            letter-spacing: 1px;
            transition: color 0.3s ease;
        }

        .error-message {
            background: var(--card-bg);
            color: #e53e3e;
            padding: 20px 30px;
            border-radius: 20px;
            margin: 25px 0;
            border: 3px solid #e53e3e;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 
                0 10px 30px var(--shadow-md),
                0 5px 15px var(--shadow-sm);
            letter-spacing: 0.5px;
            transition: background-color 0.3s ease;
        }

        .success-message {
            background: var(--card-bg);
            color: var(--primary-color);
            padding: 20px 30px;
            border-radius: 20px;
            margin: 25px 0;
            border: 3px solid var(--primary-color);
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 
                0 10px 30px var(--shadow-md),
                0 5px 15px var(--shadow-sm);
            animation: fadeInUp 0.5s ease;
            letter-spacing: 0.5px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
                border-left: none;
                border-bottom: 2px solid #801c32;
            }

            .main-content {
                margin-right: 0;
                padding: 20px;
            }

            .results-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .section {
                padding: 25px 20px;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .btn {
                padding: 12px 24px;
                font-size: 14px;
                margin: 8px 4px;
            }

            .file-upload {
                padding: 30px 20px;
            }

            .login-form {
                margin: 20px;
                padding: 40px 25px;
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .section:nth-child(odd) {
            animation: slideInLeft 0.6s ease-out;
        }

        .section:nth-child(even) {
            animation: slideInRight 0.6s ease-out;
        }

        .date-time-bar {
            width: 100%;
            text-align: center;
            margin: 10px 0 0 0;
        }
        #currentDateTime {
            font-size: 1.3rem;
            font-weight: 700;
            color: #801c32;
            background: #ffffff;
            padding: 12px 28px;
            border-radius: 8px;
            display: inline-block;
            letter-spacing: 2px;
            box-shadow: 
                0 4px 15px rgba(128, 28, 50, 0.15),
                0 0 0 1px rgba(128, 28, 50, 0.2);
            position: relative;
            z-index: 2;
            margin-top: 15px;
            border: 2px solid #801c32;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            
            .dashboard, 
            .dashboard * {
                visibility: visible;
            }
            
            .login-screen {
                display: none !important;
            }
            
            .dashboard {
                display: block !important;
            }
            
            .header {
                background: #667eea !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .tabs {
                display: none;
            }
            
            .tab-content {
                display: block !important;
            }
            
            .tab-content:not(.active) {
                display: none !important;
            }
            
            .btn {
                display: none;
            }
            
            .file-upload {
                display: none;
            }
            
            .results-grid {
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .result-card {
                break-inside: avoid;
                page-break-inside: avoid;
                border: 1px solid #ccc !important;
            }
            
            .agent-info {
                background: #28a745 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        .sidebar-header .author-name {
            font-size: 0.75rem;
            font-weight: 500;
            color: #2C5F8D;
            text-align: center;
            margin: 8px auto 0;
            letter-spacing: 0.5px;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(44, 95, 141, 0.1) 0%, rgba(44, 95, 141, 0.15) 100%);
            border-radius: 6px;
            border: 1px solid rgba(44, 95, 141, 0.3);
            display: inline-block;
            width: auto;
            max-width: calc(100% - 20px);
            transition: all 0.25s ease;
            box-shadow: 0 1px 4px rgba(44, 95, 141, 0.1);
            cursor: pointer;
        }

        .sidebar-header .author-name:hover {
            background: linear-gradient(135deg, rgba(44, 95, 141, 0.15) 0%, rgba(44, 95, 141, 0.2) 100%);
            border-color: rgba(44, 95, 141, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(44, 95, 141, 0.2);
            color: #1e4a6b;
        }

        .author-info-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 24px;
            padding: 0;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25), 0 10px 30px rgba(128, 28, 50, 0.15);
            border: 2px solid #801c32;
            z-index: 10001;
            min-width: 480px;
            max-width: 600px;
            width: 90%;
            animation: popupFadeIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        [data-theme="dark"] .author-info-popup {
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            border-color: #ff4757;
        }

        .author-info-popup.show {
            display: block;
        }

        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.85);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            backdrop-filter: blur(6px);
            transition: opacity 0.3s ease;
        }

        .popup-overlay.show {
            display: block;
            animation: overlayFadeIn 0.3s ease;
        }

        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .popup-close {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 36px;
            height: 36px;
            background: rgba(128, 28, 50, 0.1);
            border: 2px solid #801c32;
            border-radius: 50%;
            color: #801c32;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
            line-height: 1;
        }

        .popup-close:hover {
            background: #801c32;
            color: white;
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(128, 28, 50, 0.4);
        }

        [data-theme="dark"] .popup-close {
            background: rgba(255, 71, 87, 0.15);
            border-color: #ff4757;
            color: #ff4757;
        }

        [data-theme="dark"] .popup-close:hover {
            background: #ff4757;
            color: white;
        }

        .popup-header {
            text-align: center;
            margin: 0;
            padding: 30px 40px 20px;
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            color: white;
            position: relative;
        }

        [data-theme="dark"] .popup-header {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
        }

        .popup-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .popup-header h2 {
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .popup-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 30px 40px;
            background: var(--bg-primary);
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 2px solid var(--border-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-direction: row-reverse;
            position: relative;
            overflow: hidden;
        }

        .info-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #801c32 0%, #a52d45 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        [data-theme="dark"] .info-item::before {
            background: linear-gradient(180deg, #ff4757 0%, #ff6b7a 100%);
        }

        .info-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary-color);
            transform: translateX(-8px) translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-md);
        }

        .info-item:hover::before {
            transform: scaleY(1);
        }

        .info-icon {
            font-size: 1.8rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.1) 0%, rgba(128, 28, 50, 0.15) 100%);
            border-radius: 12px;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .info-icon {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.15) 0%, rgba(255, 71, 87, 0.25) 100%);
        }

        .info-item:hover .info-icon {
            transform: scale(1.1) rotate(5deg);
            background: linear-gradient(135deg, rgba(128, 28, 50, 0.2) 0%, rgba(128, 28, 50, 0.3) 100%);
        }

        [data-theme="dark"] .info-item:hover .info-icon {
            background: linear-gradient(135deg, rgba(255, 71, 87, 0.25) 0%, rgba(255, 71, 87, 0.35) 100%);
        }

        .info-text {
            flex: 0 0 auto;
            color: #1a1a1a;
            font-size: 0.9rem;
            font-weight: 600;
            min-width: 120px;
            text-align: left;
        }

        [data-theme="dark"] .info-text {
            color: #f5f5f5;
        }

        .info-value {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1rem;
            flex: 1;
            text-align: left;
            direction: ltr;
            white-space: nowrap;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .info-value {
            color: #ff6b7a;
        }

        .info-item:hover .info-value {
            color: var(--primary-color);
        }

        [data-theme="dark"] .info-item:hover .info-value {
            color: #ff4757;
        }

        .info-action {
            padding: 8px 18px;
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 700;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.3);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .info-action {
            background: linear-gradient(135deg, #ff4757 0%, #ff6b7a 100%);
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
        }

        .info-action::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.5s ease, height 0.5s ease;
        }

        .info-action:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 16px rgba(128, 28, 50, 0.4);
        }

        [data-theme="dark"] .info-action:hover {
            box-shadow: 0 4px 16px rgba(255, 71, 87, 0.4);
        }

        .info-action:hover::before {
            width: 300px;
            height: 300px;
        }

        .info-action:active {
            transform: translateY(0) scale(1);
        }

        .settings-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }

        .settings-section {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: var(--text-primary);
        }

        .settings-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #801c32, #a52d45);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .settings-section:hover {
            box-shadow: 0 4px 20px rgba(128, 28, 50, 0.15);
            border-color: rgba(128, 28, 50, 0.3);
            transform: translateY(-2px);
        }

        .settings-section:hover::before {
            opacity: 1;
        }

        .settings-section h4 {
            color: var(--primary-color);
            margin-bottom: 18px;
            font-size: 1.1rem;
            font-weight: 700;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 12px;
            letter-spacing: 0.3px;
            transition: color 0.3s ease, border-color 0.3s ease;
        }

        .settings-group {
            margin-bottom: 18px;
        }

        .settings-group:last-child {
            margin-bottom: 0;
        }

        .settings-group label {
            display: block;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .settings-group label {
            color: #f5f5f5;
        }

        .settings-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--input-border);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--input-bg);
            color: var(--text-primary);
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            line-height: 1.5;
        }

        .settings-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--shadow-sm);
            background: var(--input-bg);
            font-weight: 600;
        }

        .settings-input:hover {
            border-color: var(--border-color);
        }

        .settings-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .settings-checkbox:hover {
            background: rgba(128, 28, 50, 0.05);
        }

        .settings-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #801c32;
        }

        .settings-section .btn {
            margin-top: 12px;
            width: 100%;
        }

        .settings-section .btn:not(:last-child) {
            margin-bottom: 10px;
        }

        .activity-log-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(128, 28, 50, 0.1);
            border: 1px solid rgba(128, 28, 50, 0.2);
            max-height: 600px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 12px;
            margin-bottom: 10px;
            background: rgba(128, 28, 50, 0.05);
            border-radius: 8px;
            border-right: 4px solid #801c32;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .activity-item:hover {
            background: rgba(128, 28, 50, 0.1);
            transform: translateX(-3px);
        }

        .activity-item .activity-icon {
            font-size: 1.5rem;
            margin-left: 10px;
        }

        .activity-item .activity-details {
            flex: 1;
        }

        .activity-item .activity-time {
            color: #1a1a1a;
            font-size: 0.85rem;
            font-weight: 600;
        }

        [data-theme="dark"] .activity-item .activity-time {
            color: #f5f5f5;
        }

        .agent-card {
            background: #ffffff;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 6px 20px rgba(128, 28, 50, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(128, 28, 50, 0.15);
            border-color: #801c32;
        }

        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .agent-card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #801c32;
        }

        .agent-card-actions {
            display: flex;
            gap: 10px;
        }

        .agent-card-actions button {
            padding: 8px 15px;
            font-size: 0.9rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: #2C5F8D;
            color: white;
        }

        .btn-send {
            background: #25D366;
            color: white;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
        }

        .agent-card-improved {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px 20px;
            border: 2px solid rgba(128, 28, 50, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
            display: flex;
            flex-direction: row;
            align-items: stretch;
            gap: 20px;
            color: #1a1a1a;
            width: 100%;
            box-sizing: border-box;
            min-height: 100px;
        }

        [data-theme="dark"] .agent-card-improved {
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: #f5f5f5;
        }

        .agent-card-improved::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-color), var(--primary-hover));
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .agent-card-improved:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(128, 28, 50, 0.12);
            border-color: var(--primary-color);
        }

        .agent-card-improved:hover::before {
            transform: translateX(0);
        }

        .agent-card-header-improved {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            flex: 0 0 220px;
            min-width: 220px;
            max-width: 220px;
            gap: 8px;
            padding-right: 16px;
            border-right: 1px solid rgba(128, 28, 50, 0.1);
            box-sizing: border-box;
        }

        .agent-name-section {
            flex: 1;
            min-width: 0;
            width: 100%;
            overflow: hidden;
            box-sizing: border-box;
        }

        .agent-name-title {
            font-size: 1.05rem;
            font-weight: 800;
            color: #1a1a1a;
            margin: 0 0 4px 0;
            line-height: 1.4;
            letter-spacing: 0.2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            transition: color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }

        [data-theme="dark"] .agent-name-title {
            color: #f5f5f5;
        }

        .agent-name-subtitle {
            font-size: 0.8rem;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 6px 0;
            line-height: 1.4;
            transition: color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            box-sizing: border-box;
        }

        [data-theme="dark"] .agent-name-subtitle {
            color: #f5f5f5;
        }

        .agent-badge {
            display: inline-block;
            padding: 3px 8px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 700;
            box-shadow: 0 1px 4px rgba(40, 167, 69, 0.2);
            margin-top: 4px;
            letter-spacing: 0.1px;
        }

        .agent-badge-empty {
            display: inline-block;
            padding: 3px 8px;
            background: rgba(128, 28, 50, 0.08);
            color: #1a1a1a;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            margin-top: 4px;
            border: 1px solid rgba(128, 28, 50, 0.15);
        }

        [data-theme="dark"] .agent-badge-empty {
            color: #f5f5f5;
        }

        .agent-actions-improved {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-end;
            min-width: 180px;
            max-width: 200px;
            box-sizing: border-box;
        }

        .btn-action {
            padding: 6px 10px;
            min-width: 60px;
            width: auto;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.05px;
            white-space: nowrap;
            line-height: 1.3;
            flex-shrink: 0;
        }

        .btn-action:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
        }

        .btn-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-action-edit {
            background: linear-gradient(135deg, #2C5F8D, #1e4a6b);
        }

        .btn-action-edit:hover:not(:disabled) {
            background: linear-gradient(135deg, #1e4a6b, #153d5c);
        }

        .btn-action-send {
            background: linear-gradient(135deg, #25D366, #128C7E);
        }

        .btn-action-send:hover:not(:disabled) {
            background: linear-gradient(135deg, #128C7E, #0d6e5f);
        }

        .btn-action-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-action-delete:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }


        .agent-info-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            flex: 0 0 auto;
            min-width: 200px;
            max-width: 250px;
            padding-right: 16px;
            border-right: 1px solid rgba(128, 28, 50, 0.1);
            box-sizing: border-box;
        }

        .info-item-improved {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(128, 28, 50, 0.04);
            border-radius: 8px;
            transition: all 0.25s ease;
            border: 1px solid rgba(128, 28, 50, 0.1);
            white-space: nowrap;
            margin: 0;
            box-sizing: border-box;
            width: 100%;
            clear: both;
        }

        .info-item-improved:hover {
            background: rgba(128, 28, 50, 0.08);
            border-color: rgba(128, 28, 50, 0.2);
        }

        .info-label {
            font-weight: 600;
            color: #1a1a1a;
            min-width: 45px;
            font-size: 0.75rem;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .info-label {
            color: #f5f5f5;
        }

        .info-value {
            font-weight: 700;
            color: #1a1a1a;
            flex: 1;
            text-align: right;
            direction: ltr;
            font-size: 0.8rem;
            word-break: break-all;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .info-value {
            color: #f5f5f5;
        }

        .info-label-empty {
            color: #1a1a1a;
            font-style: italic;
            font-size: 0.85rem;
            text-align: center;
            width: 100%;
            padding: 8px;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .info-label-empty {
            color: #f5f5f5;
        }

        .agent-reports-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            flex: 1;
            min-width: 300px;
            box-sizing: border-box;
        }

        .reports-grid {
            display: flex;
            flex-direction: row;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .report-item {
            padding: 8px 14px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
            min-width: 90px;
            white-space: nowrap;
        }

        .report-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .report-item:hover::before {
            left: 100%;
        }

        .report-item:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: rgba(128, 28, 50, 0.3);
        }

        .report-basic {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #fbbf24;
        }

        .report-advanced {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: #3b82f6;
        }

        .report-twomonths {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-color: #6366f1;
        }

        .report-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
            letter-spacing: 0.1px;
        }

        [data-theme="dark"] .report-label {
            color: #f5f5f5;
        }

        .report-value {
            font-size: 0.85rem;
            font-weight: 900;
            color: #1a1a1a;
            line-height: 1.2;
        }

        [data-theme="dark"] .report-value {
            color: #f5f5f5;
        }

        .currency {
            font-size: 0.75rem;
            font-weight: 600;
            color: #1a1a1a;
        }

        [data-theme="dark"] .currency {
            color: #f5f5f5;
        }

        .agent-total-section {
            background: linear-gradient(135deg, #801c32 0%, #a52d45 100%);
            padding: 10px 16px;
            border-radius: 8px;
            text-align: center;
            color: white;
            box-shadow: 0 2px 8px rgba(128, 28, 50, 0.2);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 140px;
            white-space: nowrap;
        }

        .agent-total-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .total-label {
            font-size: 0.75rem;
            font-weight: 700;
            margin-bottom: 4px;
            opacity: 0.95;
            letter-spacing: 0.2px;
            position: relative;
            z-index: 1;
        }

        .total-value {
            font-size: 1.1rem;
            font-weight: 900;
            line-height: 1.2;
            position: relative;
            z-index: 1;
        }

        .total-value .currency {
            font-size: 0.9rem;
            opacity: 0.95;
            color: rgba(255, 255, 255, 0.98);
            font-weight: 700;
        }

        .no-reports-message {
            text-align: center;
            padding: 10px 12px;
            background: rgba(128, 28, 50, 0.04);
            border-radius: 8px;
            border: 1px dashed rgba(128, 28, 50, 0.25);
            margin: 0;
            box-sizing: border-box;
            width: 100%;
            clear: both;
        }

        .no-reports-message p {
            color: #999;
            font-size: 0.75rem;
            margin: 0;
            font-style: italic;
            line-height: 1.4;
            padding: 0;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10002;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        [data-theme="dark"] .modal {
            background: rgba(0, 0, 0, 0.8);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--modal-bg);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-lg);
            border: 3px solid var(--primary-color);
            color: var(--text-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            transition: border-color 0.3s ease;
        }

        .modal-header h3 {
            color: var(--primary-color);
            font-size: 1.5rem;
            transition: color 0.3s ease;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 2rem;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: var(--nav-hover);
        }

        #whatsappQRCode canvas {
            border: 3px solid #801c32;
            border-radius: 10px;
            padding: 10px;
            background: white;
        }

        .message-customization {
            max-width: 700px;
            width: 95%;
        }

        .offer-options {
            margin: 20px 0;
            padding: 15px;
            background: rgba(128, 28, 50, 0.05);
            border-radius: 10px;
        }

        .offer-options h4 {
            color: #801c32;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .offer-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .offer-checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }

        .offer-checkbox-item:hover {
            border-color: #801c32;
            background: rgba(128, 28, 50, 0.05);
        }

        .offer-checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .offer-checkbox-item label {
            cursor: pointer;
            font-weight: 600;
            flex: 1;
            margin: 0;
        }

        .message-textarea,
        textarea,
        select {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            font-weight: 500;
            line-height: 1.6;
        }

        .message-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Tajawal', 'Segoe UI', 'Arial', sans-serif;
            font-weight: 500;
            resize: vertical;
            direction: rtl;
            text-align: right;
            line-height: 1.6;
        }

        .message-textarea:focus {
            outline: none;
            border-color: #801c32;
            box-shadow: 0 0 0 3px rgba(128, 28, 50, 0.1);
            font-weight: 600;
        }

        .message-preview {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.95rem;
            direction: rtl;
            text-align: right;
        }

        .preview-label {
            font-weight: 700;
            color: #801c32;
            margin-bottom: 10px;
            display: block;
        }

        .info-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .info-btn {
            padding: 8px 15px;
            background: #2C5F8D;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .info-btn:hover {
            background: #1e4a6b;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="dashboard" class="dashboard">
            <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" title="إظهار/إخفاء القائمة الجانبية">
                ☰
            </button>
            <button class="theme-toggle-btn-small" id="themeToggleBtn" onclick="toggleTheme()" title="الوضع المظلم/الفاتح">
                <span id="themeToggleIcon">🌙</span>
            </button>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-header-row">
                        <h1>شركة عراق سيل </h1>
                    </div>
                    <div class="author-name" onclick="showAuthorInfo()">Ameer Helwas</div>
                </div>
                <div class="sidebar-nav">
                    <div class="nav-item active" onclick="switchTab('basic')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">العرض المجاني</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('advanced')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">3 أشهر مخفض</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('twoMonths')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">شهرين مخفض</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('agents')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">إدارة الوكلاء</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('agentPercentage')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">نسبة الوكلاء</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('summary')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">الملخص العام</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('settings')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">الإعدادات</span>
                    </div>
                    <div class="nav-item" onclick="switchTab('activity')">
                        <span class="nav-icon"></span>
                        <span class="nav-text">سجل العمليات</span>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <div class="user-info-sidebar">
                        <span id="currentUser">مرحباً</span>
                    </div>
                    <div class="date-info-sidebar" id="currentDateTime"></div>
                </div>
            </div>

            <div class="main-content">

            <div id="basicTab" class="tab-content active">
                <div class="section">
                    <h3 class="section-title">
                         رفع Excel الوكيل لحساب العرض المجاني
                    </h3>
                    <div class="file-upload" id="basicFileUpload">
                        <p> اسحب ملف Excel أو CSV هنا أو انقر للاختيار</p>
                        <input type="file" id="basicFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                    <div id="basicFileName" class="success-message hidden"></div>
                </div>

                <div class="section">
                    <h3 class="section-title">
                         تحليل بيانات العرض المجاني
                    </h3>
                    <p style="color: #1a1a1a; margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                    
                    </p>
                    <button class="btn btn-primary" onclick="analyzeBasicData()">
                         تحليل البيانات
                    </button>
                    <button class="btn btn-warning" onclick="resetBasicResults()">
                         مسح النتائج
                    </button>
                </div>

                <div id="basicResults" class="section hidden">
                    <h3 class="section-title">
                         نتائج العرض المجاني
                    </h3>
                    <div id="basicAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="basicResultsGrid"></div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveBasicReport()">
 حفظ التقرير
                        </button>
                        <button class="btn btn-warning" onclick="exportBasicData()">
 تصدير البيانات
                        </button>
                        <button class="btn btn-success" onclick="exportBasicDetailsToExcel()">
 تصدير Excel بالتفاصيل
                        </button>
                    </div>
                </div>

                <div id="basicLoading" class="loading">
                    <div class="spinner"></div>
                    <p>جاري تحليل بيانات العرض المجاني...</p>
                </div>
            </div>

            <div id="advancedTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
 رفع Excel الوكيل لحساب العرض المخفض لثلاث أشهر
                    </h3>
                    <div class="file-upload" id="advancedFileUpload">
                        <p> اسحب ملف Excel أو CSV هنا أو انقر للاختيار</p>
                        <input type="file" id="advancedFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                    <div id="advancedFileName" class="success-message hidden"></div>
                </div>

                <div class="section">
                    <h3 class="section-title">
                         تحليل العرض المخفض لثلاث أشهر
                    </h3>
                    <p style="color: #1a1a1a; margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                         يتم حساب التفعيل عند وجود 3 اشتراكات لنفس المستخدم خلال 5 أيام<br>
                         مقارنة أسعار العرض المخفض مع الأسعار الرسمية لحساب الراجع للوكيل
                    </p>
                    <button class="btn btn-primary" onclick="analyzeAdvancedData()">
                         تحليل التفعيلات
                    </button>
                    <button class="btn btn-warning" onclick="resetAdvancedResults()">
                         مسح النتائج
                    </button>
                </div>

                <div id="advancedResults" class="section hidden">
                    <h3 class="section-title">
                         تفاصيل الاشتراكات والمبالغ 
                    </h3>
                    <div id="advancedAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="advancedResultsGrid"></div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveAdvancedReport()">
 حفظ التقرير
                        </button>
                        <button class="btn btn-warning" onclick="exportAdvancedData()">
 تصدير للوكيل
                        </button>
                        <button class="btn btn-success" onclick="exportAdvancedDetailsToExcel()">
 تصدير Excel بالتفاصيل
                        </button>
                    </div>
                </div>

                <div id="advancedLoading" class="loading">
                    <div class="spinner"></div>
                    <p>جاري تحليل العرض المخفض لثلاث أشهر...</p>
                </div>
            </div>

            <div id="twoMonthsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
 رفع Excel الوكيل لحساب العرض المخفض لشهرين
                    </h3>
                    <div class="file-upload" id="twoMonthsFileUpload">
                        <p> اسحب ملف Excel أو CSV هنا أو انقر للاختيار</p>
                        <input type="file" id="twoMonthsFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                    </div>
                    <div id="twoMonthsFileName" class="success-message hidden"></div>
                </div>

                <div class="section">
                    <h3 class="section-title">
                         تحليل العرض المخفض لشهرين
                    </h3>
                    <p style="color: #1a1a1a; margin-bottom: 15px; font-size: 1rem; font-weight: 600;">
                         يتم حساب التفعيل عند وجود 2 اشتراكات لنفس المستخدم خلال 5 أيام<br>
                         مقارنة أسعار العرض المخفض مع الأسعار الرسمية لحساب الراجع للوكيل
                    </p>
                    <button class="btn btn-primary" onclick="analyzeTwoMonthsData()">
                         تحليل التفعيلات
                    </button>
                    <button class="btn btn-warning" onclick="resetTwoMonthsResults()">
                         مسح النتائج
                    </button>
                </div>

                <div id="twoMonthsResults" class="section hidden">
                    <h3 class="section-title">
                         تفاصيل الاشتراكات والمبالغ 
                    </h3>
                    <div id="twoMonthsAgentInfo" class="agent-info"></div>
                    <div class="results-grid" id="twoMonthsResultsGrid"></div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveTwoMonthsReport()">
 حفظ التقرير
                        </button>
                        <button class="btn btn-warning" onclick="exportTwoMonthsData()">
 تصدير للوكيل
                        </button>
                        <button class="btn btn-success" onclick="exportTwoMonthsDetailsToExcel()">
 تصدير Excel بالتفاصيل
                        </button>
                    </div>
                </div>

                <div id="twoMonthsLoading" class="loading">
                    <div class="spinner"></div>
                    <p>جاري تحليل العرض المخفض لشهرين...</p>
                </div>
            </div>

            <div id="agentsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> إدارة الوكلاء</h3>
                    
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                        <button class="btn btn-primary" onclick="showAddAgentModal()"> إضافة وكيل جديد</button>
                        <button class="btn btn-success" onclick="refreshAgentsList()"> تحديث القائمة</button>
                    </div>
                    
                    <div class="agents-controls" style="margin-bottom: 20px; padding: 15px; background: rgba(128, 28, 50, 0.05); border-radius: 12px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; position: relative; z-index: 10;">
                        <div style="flex: 1; min-width: 250px; position: relative; z-index: 10;">
                            <input type="text" id="agentSearchInput" class="settings-input" placeholder="بحث عن وكيل..." onkeyup="filterAgents()" style="width: 100%; position: relative; z-index: 10; pointer-events: auto;">
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center; position: relative; z-index: 10;">
                            <label style="font-weight: 600; color: #1a1a1a;">ترتيب حسب:</label>
                            <select id="agentSortSelect" class="settings-input" onchange="sortAgents()" style="min-width: 180px; position: relative; z-index: 10; pointer-events: auto;">
                                <option value="name">الاسم (أ-ي)</option>
                                <option value="name-desc">الاسم (ي-أ)</option>
                                <option value="total-desc">الإجمالي (الأعلى أولاً)</option>
                                <option value="total-asc">الإجمالي (الأقل أولاً)</option>
                                <option value="reports-desc">عدد التقارير (الأكثر أولاً)</option>
                                <option value="reports-asc">عدد التقارير (الأقل أولاً)</option>
                            </select>
                        </div>
                        <div style="color: #1a1a1a; font-size: 0.9rem; font-weight: 600;">
                            <span id="agentsCount">0</span> وكيل
                        </div>
                    </div>
                    
                    <div id="agentsList" class="agents-grid-improved"></div>
                </div>
            </div>

            <div id="summaryTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title">
 الملخص العام لجميع الوكلاء
                    </h3>
                    <p style="color: #1a1a1a; margin-bottom: 20px; font-size: 1rem; font-weight: 600;">
                        يعرض هذا القسم ملخص شامل لجميع الوكلاء وعروضهم المحسوبة
                    </p>
                    <button class="btn btn-primary" onclick="refreshSummary()">
 تحديث الملخص
                    </button>
                    <button class="btn btn-success" onclick="exportSummaryToExcel()">
 تصدير Excel للملخص
                    </button>
                </div>

                <div id="summaryResults" class="section">
                    <h3 class="section-title">
 ملخص الوكلاء
                    </h3>
                    <div id="summaryContent">
                        <p style="text-align: center; color: #999; padding: 40px;">
                            لا توجد بيانات للعرض. يرجى تحليل بيانات الوكلاء أولاً
                        </p>
                    </div>
                </div>

                <div id="summaryTotals" class="section hidden">
                    <h3 class="section-title">
                         الإجماليات العامة
                    </h3>
                    <div class="results-grid" id="summaryTotalsGrid"></div>
                </div>
            </div>

            <div id="agentPercentageTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> نسبة الوكلاء</h3>
                    <p style="color: #1a1a1a; margin-bottom: 20px; font-size: 1rem; font-weight: 600;">
                    </p>
                    
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(128, 28, 50, 0.05); border-radius: 12px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">اختر الوكيل:</label>
                        <select id="selectedAgentForPercentage" class="settings-input" style="width: 100%; margin-bottom: 15px; position: relative; z-index: 10; pointer-events: auto;">
                            <option value="">-- اختر وكيل --</option>
                        </select>
                        
                        <div id="agentFileUploadSection" style="display: none;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">رفع ملف Excel للوكيل:</label>
                            <div class="file-upload" id="percentageFileUpload">
                                <p> اسحب ملف Excel هنا أو انقر للاختيار</p>
                                <input type="file" id="percentageFileInput" accept=".xlsx,.xls" style="display: none;">
                            </div>
                            <div id="percentageFileName" class="success-message hidden" style="margin-top: 10px;"></div>
                            
                            <div style="margin-top: 15px;">
                                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #801c32;">النسبة</label>
                                <input type="number" id="percentageRateSelect" class="settings-input" value="16" min="0" max="100" step="0.01" style="width: 200px; position: relative; z-index: 10; pointer-events: auto;" onchange="updatePercentageRate()">
                                <p style="margin-top: 5px; font-size: 0.85rem; color: #1a1a1a; font-weight: 600;" id="percentageRateInfo">
                                    سيتم استخدام النسبة المحفوظة للوكيل (16% افتراضي)
                                </p>
                            </div>
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button class="btn btn-primary" onclick="analyzeAgentPercentageData()"> تحليل بيانات الوكيل</button>
                                <button class="btn btn-warning" onclick="resetPercentageData()"> مسح البيانات</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="percentageResults" class="section hidden" style="padding: 20px; overflow: visible; overflow-x: hidden; width: 100%; max-width: 100%; box-sizing: border-box;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; width: 100%; max-width: 100%; box-sizing: border-box;">
                        <h3 class="section-title" style="margin: 0; font-size: 1.3rem; padding-bottom: 10px;"> بيانات نسبة الوكلاء</h3>
                        <button class="btn btn-success" onclick="exportPercentageToExcel()" style="padding: 8px 16px; font-size: 0.85rem;">
                            تصدير Excel
                        </button>
                    </div>
                    <div id="percentageTableContainer" style="overflow-x: auto; overflow-y: auto; max-height: 70vh; width: 100%; max-width: 100%; position: relative; z-index: 1; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; box-sizing: border-box; will-change: scroll-position; contain: layout style paint;">
                        <table id="percentageTable" style="width: auto; min-width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; table-layout: auto; box-sizing: border-box;">
                            <thead>
                                <tr style="background: #801c32; color: white;">
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">اسم الوكيل</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">رقم الهاتف</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">النسبة (%)</th>
                                    <th colspan="5" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600;">المبالغ</th>
                                    <th colspan="8" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem; font-weight: 600;">عدد التفعيلات</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">نسبة الوكيل</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">استقطاعات</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">غرامات</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">النسبة الصافية</th>
                                    <th rowspan="2" style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; vertical-align: middle; font-size: 0.75rem; font-weight: 600;">إجراءات</th>
                                </tr>
                                <tr style="background: #801c32; color: white;">
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.T</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.P</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.G</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.S</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.B</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.P%</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.G%</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.S%</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">IQ.B%</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">P</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">G</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">S</th>
                                    <th style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.7rem; font-weight: 500;">B</th>
                                </tr>
                            </thead>
                            <tbody id="percentageTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settingsTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> الإعدادات</h3>
                    <div class="settings-container">
                        <div class="settings-section">
                            <h4> إعدادات واتساب</h4>
                            <div id="whatsappStatus" style="margin-bottom: 0; padding: 16px; background: rgba(128, 28, 50, 0.05); border-radius: 8px; border: 1px solid rgba(128, 28, 50, 0.1);">
                                <p style="margin-bottom: 12px; font-size: 0.85rem; color: #1a1a1a; line-height: 1.6; font-weight: 600;">
                                    <strong style="color: #801c32;">ملاحظة:</strong> أدخل رقم هاتفك المرتبط بـ WhatsApp لاستخدام إرسال الرسائل المباشر
                                </p>
                                <p style="margin-bottom: 12px; font-size: 0.9rem;">
                                    <strong style="color: #333;">حالة الاتصال:</strong> 
                                    <span id="whatsappConnectionStatus" style="color: #e53e3e; font-weight: 600;">غير متصل</span>
                                </p>
                                <div id="whatsappQRCode" style="text-align: center; margin: 15px 0;"></div>
                                <button class="btn btn-primary" onclick="connectWhatsApp()" style="width: 100%; margin-top: 0;"> إعداد WhatsApp</button>
                                <button class="btn btn-danger" onclick="disconnectWhatsApp()" style="width: 100%; margin-top: 10px;"> إلغاء الإعداد</button>
                                <p style="margin-top: 12px; font-size: 0.8rem; color: #1a1a1a; text-align: center; line-height: 1.5; font-weight: 600;">
                                    سيتم فتح واتساب مباشرة لإرسال الرسائل دون الحاجة لتسجيل الدخول
                                </p>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h4> إعدادات الأسعار</h4>
                            <div class="settings-group">
                                <label>سعر Bronze:</label>
                                <input type="number" id="priceBronze" class="settings-input" value="30000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label>سعر Silver:</label>
                                <input type="number" id="priceSilver" class="settings-input" value="40000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label>سعر Gold:</label>
                                <input type="number" id="priceGold" class="settings-input" value="50000" min="0" step="1000">
                            </div>
                            <div class="settings-group">
                                <label>سعر Platinum:</label>
                                <input type="number" id="pricePlatinum" class="settings-input" value="65000" min="0" step="1000">
                            </div>
                            <button class="btn btn-primary" onclick="savePriceSettings()"> حفظ الأسعار</button>
                        </div>
                        
                        <div class="settings-section">
                            <h4> إدارة البيانات</h4>
                            <button class="btn btn-success" onclick="backupData()"> نسخ احتياطي</button>
                            <button class="btn btn-warning" onclick="restoreData()"> استعادة البيانات</button>
                            <button class="btn btn-danger" onclick="clearAllData()"> مسح جميع البيانات</button>
                        </div>
                        
                        <div class="settings-section">
                            <h4> النسب الافتراضية</h4>
                            <div class="settings-group">
                                <label>النسبة الافتراضية للوكلاء الجدد (%):</label>
                                <input type="number" id="defaultAgentPercentage" class="settings-input" value="16" min="0" max="100" step="0.01" onchange="saveDefaultPercentage()">
                                <p style="margin-top: 5px; font-size: 0.85rem; color: #1a1a1a; font-weight: 600;">النسبة الافتراضية المستخدمة عند إضافة وكيل جديد (0-100%)</p>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h4> الإشعارات</h4>
                            <label class="settings-checkbox">
                                <input type="checkbox" id="enableNotifications" checked>
                                <span style="font-weight: 500; color: #333;">تفعيل الإشعارات</span>
                            </label>
                            <p style="margin-top: 12px; font-size: 0.85rem; color: #1a1a1a; line-height: 1.5; font-weight: 600;">
                                عند تفعيل الإشعارات، سيتم إظهار رسائل تأكيد عند إتمام العمليات
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="activityTab" class="tab-content">
                <div class="section">
                    <h3 class="section-title"> سجل العمليات</h3>
                    <div class="activity-controls" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                        <input type="text" id="activitySearch" placeholder=" بحث في السجل..." class="settings-input" style="flex: 1; min-width: 200px;" onkeyup="filterActivityLog()">
                        <button class="btn btn-primary" onclick="refreshActivityLog()"> تحديث</button>
                        <button class="btn btn-success" onclick="exportActivityLog()"> تصدير</button>
                        <button class="btn btn-danger" onclick="clearActivityLog()"> مسح السجل</button>
                    </div>
                    <div id="activityLogContent" class="activity-log-container"></div>
                </div>
            </div>

            </div> 
        </div>
    </div>

    <div id="messageCustomizationModal" class="modal">
        <div class="modal-content message-customization">
            <div class="modal-header">
                <h3>تخصيص رسالة الوكيل</h3>
                <button class="modal-close" onclick="closeMessageCustomizationModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <strong style="color: #801c32; font-size: 1.1rem;">الوكيل:</strong>
                <span id="customMessageAgentName" style="font-size: 1.1rem; font-weight: 600;" data-agent=""></span>
            </div>
            
            <div style="margin: 20px 0;">
                <label class="preview-label">نص الرسالة:</label>
                <textarea id="customMessageText" class="message-textarea" rows="10"></textarea>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-danger" onclick="closeMessageCustomizationModal()">إلغاء</button>
                <button class="btn btn-success" onclick="sendViaEmail()">إرسال عبر البريد</button>
                <button class="btn btn-primary" onclick="sendCustomizedWhatsAppMessage()">إرسال واتساب</button>
            </div>
        </div>
    </div>

    <div id="agentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="agentModalTitle">إضافة وكيل</h3>
                <button class="modal-close" onclick="closeAgentModal()">&times;</button>
            </div>
            <form id="agentForm">
                <div class="form-group">
                    <label>اسم اللوحة</label>
                    <input type="text" id="agentName" class="settings-input" required>
                </div>
                <div class="form-group">
                    <label>اسم الوكيل :</label>
                    <input type="text" id="agentSubName" class="settings-input" placeholder=" ">
                </div>
                <div class="form-group">
                    <label>رقم الهاتف:</label>
                    <input type="tel" id="agentPhone" class="settings-input">
                </div>
                <div class="form-group">
                    <label>البريد الإلكتروني:</label>
                    <input type="email" id="agentEmail" class="settings-input">
                </div>
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-danger" onclick="closeAgentModal()">إلغاء</button>
                    <button type="submit" class="btn btn-primary">حفظ</button>
                </div>
            </form>
        </div>
    </div>

    <script>

let agentReports = {};
        let agentsList = JSON.parse(localStorage.getItem('agentsList') || '[]');
        let whatsappConnected = false;
        let whatsappPhone = '';
        let currentUser = '';
        let basicData = null;
        let advancedData = null;
        let twoMonthsData = null;
        let twoMonthsDetails = []; 
        let advancedDetails = [];
        let basicDetails = [];
        let percentageData = null;
        let agentPercentages = JSON.parse(localStorage.getItem('agentPercentages') || '{}');

        const arabicMonths = [
            'كانون الثاني', 'شباط', 'آذار', 'نيسان', 'أيار', 'حزيران',
            'تموز', 'آب', 'أيلول', 'تشرين الأول', 'تشرين الثاني', 'كانون الأول'
        ];

        const subscriptionPrices = {
            basic: {
                'Iraqcell_Bronze_Profile_NEW': 30000,
                'Iraqcell_Bronze_Profile': 30000,
                'Iraqcell_Silver_Profile_NEW': 40000,
                'Iraqcell_Silver_Profile': 40000,
                'Iraqcell_Gold_Profile_NEW': 50000,
                'Iraqcell_Gold_Profile': 50000,
                'Iraqcell_Platinum_Profile_NEW': 65000,
                'Iraqcell_Platinum_Profile': 65000
            },
            advanced: {
                promo: {
                    'Iraqcell_Bronze_Profile_NEW': 75000,
                    'Iraqcell_Bronze_Profile': 75000,
                    'Iraqcell_Silver_Profile_NEW': 105000,
                    'Iraqcell_Silver_Profile': 105000,
                    'Iraqcell_Gold_Profile_NEW': 120000,
                    'Iraqcell_Gold_Profile': 120000,
                    'Iraqcell_Platinum_Profile_NEW': 165000,
                    'Iraqcell_Platinum_Profile': 165000
                },
                official: {
                    'Iraqcell_Bronze_Profile_NEW': 90000,
                    'Iraqcell_Bronze_Profile': 90000,
                    'Iraqcell_Silver_Profile_NEW': 120000,
                    'Iraqcell_Silver_Profile': 120000,
                    'Iraqcell_Gold_Profile_NEW': 150000,
                    'Iraqcell_Gold_Profile': 150000,
                    'Iraqcell_Platinum_Profile_NEW': 195000,
                    'Iraqcell_Platinum_Profile': 195000
                }
            },
            twoMonths: {
                promo: {
                    'Iraqcell_Bronze_Profile_NEW': 50000,
                    'Iraqcell_Bronze_Profile': 50000,
                    'Iraqcell_Silver_Profile_NEW': 70000, 
                    'Iraqcell_Silver_Profile': 70000,
                    'Iraqcell_Gold_Profile_NEW': 80000, 
                    'Iraqcell_Gold_Profile': 80000,
                    'Iraqcell_Platinum_Profile_NEW': 110000,
                    'Iraqcell_Platinum_Profile': 110000
                }
            }
        };

        function getSubscriptionCategory(subscriptionName, agentName) {
            if (!subscriptionName) return '';
            
            const subscription = String(subscriptionName).trim();
            let agent = null;
            
            if (agentName) {
                agent = agentsList.find(a => a.name === agentName);
            }
            
            if (agent && agent.subscriptionNames) {
                const subNames = agent.subscriptionNames;
                
                if (subscription === subNames.bronze || subscription.toLowerCase() === subNames.bronze.toLowerCase()) {
                    return 'B';
                }
                if (subscription === subNames.silver || subscription.toLowerCase() === subNames.silver.toLowerCase()) {
                    return 'S';
                }
                if (subscription === subNames.gold || subscription.toLowerCase() === subNames.gold.toLowerCase()) {
                    return 'G';
                }
                if (subscription === subNames.platinum || subscription.toLowerCase() === subNames.platinum.toLowerCase()) {
                    return 'P';
                }
                
                if (subscription.toLowerCase().includes(subNames.bronze.toLowerCase()) || 
                    subNames.bronze.toLowerCase().includes(subscription.toLowerCase())) {
                    return 'B';
                }
                if (subscription.toLowerCase().includes(subNames.silver.toLowerCase()) || 
                    subNames.silver.toLowerCase().includes(subscription.toLowerCase())) {
                    return 'S';
                }
                if (subscription.toLowerCase().includes(subNames.gold.toLowerCase()) || 
                    subNames.gold.toLowerCase().includes(subscription.toLowerCase())) {
                    return 'G';
                }
                if (subscription.toLowerCase().includes(subNames.platinum.toLowerCase()) || 
                    subNames.platinum.toLowerCase().includes(subscription.toLowerCase())) {
                    return 'P';
                }
            }
            
            if (subscription.includes('Platinum') || subscription.includes('بلاتينيوم') || subscription.toLowerCase().includes('platinum')) {
                return 'P';
            } else if (subscription.includes('Gold') || subscription.includes('كولد') || subscription.toLowerCase().includes('gold')) {
                return 'G';
            } else if (subscription.includes('Silver') || subscription.includes('سلفر') || subscription.toLowerCase().includes('silver')) {
                return 'S';
            } else if (subscription.includes('Bronze') || subscription.includes('برونز') || subscription.toLowerCase().includes('bronze')) {
                return 'B';
            }
            
            return '';
        }

        function getSubscriptionFullName(category, agentName, type = 'basic') {
            let agent = null;
            
            if (agentName) {
                agent = agentsList.find(a => a.name === agentName);
            }
            
            if (agent && agent.subscriptionNames) {
                const subNames = agent.subscriptionNames;
                switch(category) {
                    case 'B': return subNames.bronze || 'Iraqcell_Bronze_Profile_NEW';
                    case 'S': return subNames.silver || 'Iraqcell_Silver_Profile_NEW';
                    case 'G': return subNames.gold || 'Iraqcell_Gold_Profile_NEW';
                    case 'P': return subNames.platinum || 'Iraqcell_Platinum_Profile_NEW';
                    default: return '';
                }
            }
            
            switch(category) {
                case 'B': return 'Iraqcell_Bronze_Profile_NEW';
                case 'S': return 'Iraqcell_Silver_Profile_NEW';
                case 'G': return 'Iraqcell_Gold_Profile_NEW';
                case 'P': return 'Iraqcell_Platinum_Profile_NEW';
                default: return '';
            }
        }

        function getSubscriptionPrice(subscriptionName, category, type = 'basic', priceType = 'basic') {
            if (!subscriptionName || !category) return 0;
            
            const subType = String(subscriptionName).trim();
            const defaultNames = {
                'B': 'Iraqcell_Bronze_Profile_NEW',
                'S': 'Iraqcell_Silver_Profile_NEW',
                'G': 'Iraqcell_Gold_Profile_NEW',
                'P': 'Iraqcell_Platinum_Profile_NEW'
            };
            
            if (type === 'basic') {
                if (subscriptionPrices.basic[subType]) {
                    return subscriptionPrices.basic[subType];
                }
            } else if (type === 'advanced') {
                if (priceType === 'promo' && subscriptionPrices.advanced.promo[subType]) {
                    return subscriptionPrices.advanced.promo[subType];
                } else if (priceType === 'official' && subscriptionPrices.advanced.official[subType]) {
                    return subscriptionPrices.advanced.official[subType];
                }
            } else if (type === 'twoMonths') {
                if (subscriptionPrices.twoMonths.promo[subType]) {
                    return subscriptionPrices.twoMonths.promo[subType];
                }
            }
            
            const defaultName = defaultNames[category];
            if (!defaultName) return 0;
            
            if (type === 'basic') {
                return subscriptionPrices.basic[defaultName] || 0;
            } else if (type === 'advanced') {
                if (priceType === 'promo') {
                    return subscriptionPrices.advanced.promo[defaultName] || 0;
                } else if (priceType === 'official') {
                    return subscriptionPrices.advanced.official[defaultName] || 0;
                }
            } else if (type === 'twoMonths') {
                return subscriptionPrices.twoMonths.promo[defaultName] || 0;
            }
            
            return 0;
        }

        function setupPercentageFileUpload() {
            const fileUpload = document.getElementById('percentageFileUpload');
            const fileInput = document.getElementById('percentageFileInput');
            
            if (!fileUpload || !fileInput) return;
            
            fileUpload.addEventListener('click', () => fileInput.click());
            fileUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUpload.style.background = 'rgba(128, 28, 50, 0.1)';
            });
            fileUpload.addEventListener('dragleave', () => {
                fileUpload.style.background = '';
            });
            fileUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUpload.style.background = '';
                if (e.dataTransfer.files.length > 0) {
                    fileInput.files = e.dataTransfer.files;
                    handlePercentageFileUpload(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handlePercentageFileUpload(e.target.files[0]);
                }
            });
        }

        function handlePercentageFileUpload(file) {
            const fileName = file.name;
            const selectedAgent = document.getElementById('selectedAgentForPercentage').value;
            
            if (!selectedAgent) {
                alert('يرجى اختيار وكيل أولاً');
                document.getElementById('percentageFileInput').value = '';
                return;
            }
            
            document.getElementById('percentageFileName').textContent = `تم تحميل الملف: ${fileName}`;
            document.getElementById('percentageFileName').classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                percentageData = {
                    agentName: selectedAgent,
                    data: XLSX.utils.sheet_to_json(firstSheet, { header: 1 }),
                    fileName: fileName
                };
                
                showSuccessMessage(`تم تحميل ملف الوكيل "${selectedAgent}" بنجاح. اضغط على "تحليل بيانات الوكيل" للبدء`);
                logActivity('رفع ملف نسبة الوكلاء', `تم رفع ملف للوكيل ${selectedAgent}: ${fileName}`);
            };
            reader.readAsArrayBuffer(file);
        }

        function onAgentSelectedForPercentage() {
            const selectedAgent = document.getElementById('selectedAgentForPercentage').value;
            if (selectedAgent) {
                document.getElementById('agentFileUploadSection').style.display = 'block';
                document.getElementById('percentageFileInput').value = '';
                document.getElementById('percentageFileName').classList.add('hidden');
                percentageData = null;
                
                const agent = agentsList.find(a => a.name === selectedAgent);
                if (agent && agent.percentage) {
                    document.getElementById('percentageRateSelect').value = agent.percentage;
                    document.getElementById('percentageRateInfo').textContent = 
                        `النسبة المحفوظة للوكيل: ${agent.percentage}%`;
                } else {
                    document.getElementById('percentageRateSelect').value = 16;
                    document.getElementById('percentageRateInfo').textContent = 
                        'سيتم استخدام النسبة الافتراضية: 16%';
                }
            } else {
                document.getElementById('agentFileUploadSection').style.display = 'none';
            }
        }

        function updatePercentageRate() {
            const selectedAgent = document.getElementById('selectedAgentForPercentage').value;
            const newRate = parseFloat(document.getElementById('percentageRateSelect').value) || 16;
            
            if (newRate < 0 || newRate > 100) {
                alert('النسبة المئوية يجب أن تكون بين 0 و 100');
                const agent = agentsList.find(a => a.name === selectedAgent);
                document.getElementById('percentageRateSelect').value = agent ? (agent.percentage || 16) : 16;
                return;
            }
            
            if (selectedAgent) {
                const agent = agentsList.find(a => a.name === selectedAgent);
                if (agent) {
                    agent.percentage = newRate;
                    localStorage.setItem('agentsList', JSON.stringify(agentsList));
                    document.getElementById('percentageRateInfo').textContent = 
                        `تم تحديث النسبة للوكيل: ${newRate}%`;
                    showSuccessMessage(`تم تحديث النسبة للوكيل "${selectedAgent}" إلى ${newRate}%`);
                }
            }
        }

        function updateAgentsListForPercentage() {
            const select = document.getElementById('selectedAgentForPercentage');
            if (!select) return;
            
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- اختر وكيل --</option>';
            agentsList.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.name;
                option.textContent = agent.name;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
            
            select.removeEventListener('change', onAgentSelectedForPercentage);
            select.addEventListener('change', onAgentSelectedForPercentage);
        }

        function analyzeAgentPercentageData() {
            if (!percentageData || !percentageData.data || percentageData.data.length === 0) {
                alert('يرجى رفع ملف Excel أولاً');
                return;
            }

            const selectedAgent = percentageData.agentName;
            if (!selectedAgent) {
                alert('يرجى اختيار وكيل أولاً');
                return;
            }

            const agent = agentsList.find(a => a.name === selectedAgent);
            let percentageRate = parseFloat(document.getElementById('percentageRateSelect').value) || 16;
            
            if (agent && agent.percentage) {
                percentageRate = agent.percentage;
                document.getElementById('percentageRateSelect').value = percentageRate;
                showSuccessMessage(`تم استخدام النسبة المحفوظة للوكيل: ${percentageRate}%`);
            }

            try {
                const data = percentageData.data;
                
                let headerRow = -1;
                for (let i = 0; i < Math.min(10, data.length); i++) {
                    const row = data[i];
                    const rowText = row.join(' ').toLowerCase();
                    if ((rowText.includes('profile') || rowText.includes('نوع') || rowText.includes('type')) && 
                        (rowText.includes('amount') || rowText.includes('مبلغ') || row.length > 5)) {
                        headerRow = i;
                        break;
                    }
                }

                if (headerRow === -1) {
                    headerRow = 0;
                }

                const headers = data[headerRow] || [];
                
                const profileCol = findColumnIndex(headers, ['profile', 'نوع', 'type', 'h']);
                const amountCol = findColumnIndex(headers, ['amount', 'مبلغ', 'قيمة', 'l']);
                
                if (profileCol < 0 || amountCol < 0) {
                    alert('لم يتم العثور على أعمدة Profile Type و Amount في الملف. تأكد من صحة الملف.');
                    return;
                }

                analyzeSubscriptionFileWithSystemPrices(data, headerRow, profileCol, amountCol, selectedAgent, percentageRate);
                
            } catch (error) {
                console.error('Error analyzing percentage data:', error);
                alert('حدث خطأ أثناء تحليل البيانات: ' + error.message);
            }
        }

        function analyzeSubscriptionFileWithSystemPrices(data, headerRow, profileCol, amountCol, agentName, percentageRate) {
            let countP = 0, countG = 0, countS = 0, countB = 0;

            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;
                
                const profileType = (row[profileCol] || '').toString().trim();
                const amount = parseFloat(row[amountCol]) || 0;
                
                if (!profileType) continue;

                const category = getSubscriptionCategory(profileType, agentName);
                
                if (!category) continue;

                switch(category) {
                    case 'P':
                        countP++;
                        break;
                    case 'G':
                        countG++;
                        break;
                    case 'S':
                        countS++;
                        break;
                    case 'B':
                        countB++;
                        break;
                }
            }

            const officialPriceP = subscriptionPrices.basic['Iraqcell_Platinum_Profile_NEW'] || 65000;
            const officialPriceG = subscriptionPrices.basic['Iraqcell_Gold_Profile_NEW'] || 50000;
            const officialPriceS = subscriptionPrices.basic['Iraqcell_Silver_Profile_NEW'] || 40000;
            const officialPriceB = subscriptionPrices.basic['Iraqcell_Bronze_Profile_NEW'] || 30000;
            
            const iqP = countP * officialPriceP;
            const iqG = countG * officialPriceG;
            const iqS = countS * officialPriceS;
            const iqB = countB * officialPriceB;
            
            const iqT = iqP + iqG + iqS + iqB;
            
            const iqPPercent = iqP * (percentageRate / 100);
            const iqGPercent = iqG * (percentageRate / 100);
            const iqSPercent = iqS * (percentageRate / 100);
            const iqBPercent = iqB * (percentageRate / 100);
            
            const agentPercentageAmount = iqPPercent + iqGPercent + iqSPercent + iqBPercent;
            
            // الحصول على معلومات الوكيل من قائمة الوكلاء
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            
            if (!agentPercentages[agentName]) {
                agentPercentages[agentName] = {
                    percentage: percentageRate,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    iqPPercent: iqPPercent,
                    iqGPercent: iqGPercent,
                    iqSPercent: iqSPercent,
                    iqBPercent: iqBPercent,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: countP + countG + countS + countB,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                const existing = agentPercentages[agentName];
                agentPercentages[agentName] = {
                    percentage: percentageRate,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    iqPPercent: iqPPercent,
                    iqGPercent: iqGPercent,
                    iqSPercent: iqSPercent,
                    iqBPercent: iqBPercent,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: existing.deductions || 0,
                    penalties: existing.penalties || 0,
                    netPercentage: agentPercentageAmount - (existing.deductions || 0) - (existing.penalties || 0),
                    totalCount: countP + countG + countS + countB,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone || existing.phone || '',
                    email: agentEmail || existing.email || ''
                };
            }

            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            renderPercentageTable();
            
            showSuccessMessage(`تم تحليل بيانات الوكيل "${agentName}" بنجاح. النسبة: ${percentageRate}% - المجموع: ${formatNumber(iqT)} د.ع`);
            logActivity('تحليل نسبة الوكلاء', `تم تحليل ملف الوكيل ${agentName}: ${countP}P, ${countG}G, ${countS}S, ${countB}B - النسبة: ${percentageRate}%`);
        }

        function analyzeDirectPercentageFile(headers, headerRow) {
            const agentNameCol = findColumnIndex(headers, ['اسم', 'وكيل', 'الوكيل', 'name']);
            const iqTCol = findColumnIndex(headers, ['IQ.T', 'IQT', 'IQ', 'ت']);
            const iqPCol = findColumnIndex(headers, ['IQ.P', 'IQP', 'P']);
            const iqGCol = findColumnIndex(headers, ['IQ.G', 'IQG', 'G']);
            const iqSCol = findColumnIndex(headers, ['IQ.S', 'IQS', 'S']);
            const iqBCol = findColumnIndex(headers, ['IQ.B', 'IQB', 'B']);
            const agentPercentageCol = findColumnIndex(headers, ['نسبة', 'الوكيل', 'نسبة الوكيل']);
            
            let defaultPercentage = 15;
            
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toUpperCase();
                if (header.includes('%16') || header.includes('16%')) {
                    defaultPercentage = 16;
                    break;
                } else if (header.includes('%15') || header.includes('15%')) {
                    defaultPercentage = 15;
                    break;
                }
            }

            for (let i = headerRow + 1; i < percentageData.length; i++) {
                const row = percentageData[i];
                if (!row || row.length === 0) continue;
                
                const agentName = row[agentNameCol];
                if (!agentName || agentName === 'المجموع' || agentName.toString().trim() === '') continue;

                let agentPercentage = defaultPercentage;
                let agentPercentageAmount = 0;
                
                for (let j = 0; j < headers.length; j++) {
                    const header = (headers[j] || '').toString().toUpperCase();
                    if (header.includes('P%16') || header.includes('G%16') || header.includes('S%16') || header.includes('B%16')) {
                        agentPercentage = 16;
                        break;
                    } else if (header.includes('P%15') || header.includes('G%15') || header.includes('S%15') || header.includes('B%15')) {
                        agentPercentage = 15;
                        break;
                    }
                }

                const iqT = parseFloat(row[iqTCol]) || 0;
                const iqP = parseFloat(row[iqPCol]) || 0;
                const iqG = parseFloat(row[iqGCol]) || 0;
                const iqS = parseFloat(row[iqSCol]) || 0;
                const iqB = parseFloat(row[iqBCol]) || 0;

                if (agentPercentageCol >= 0 && row[agentPercentageCol]) {
                    agentPercentageAmount = parseFloat(row[agentPercentageCol]) || 0;
                } else {
                    agentPercentageAmount = calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, agentPercentage);
                }

                saveAgentPercentage(agentName, agentPercentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount);
            }

            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            renderPercentageTable();
            showSuccessMessage('تم تحليل البيانات بنجاح');
            logActivity('تحليل نسبة الوكلاء', 'تم تحليل ملف نسبة الوكلاء بنجاح');
        }

        function analyzeSubscriptionPercentageFile(headers, headerRow) {
            const agentNameCol = findColumnIndex(headers, ['اسم', 'وكيل', 'الوكيل', 'name', 'f', 'c']);
            const profileCol = findColumnIndex(headers, ['profile', 'نوع', 'type', 'h']);
            const amountCol = findColumnIndex(headers, ['amount', 'مبلغ', 'قيمة', 'l']);
            const emailCol = findColumnIndex(headers, ['email', 'بريد', 'e', 'p']);
            
            const percentageInput = prompt('يرجى تحديد النسبة:\n1 - 15%\n2 - 16%', '1');
            const agentPercentage = (percentageInput === '2' || percentageInput === '16') ? 16 : 15;

            const agentData = {};

            for (let i = headerRow + 1; i < percentageData.length; i++) {
                const row = percentageData[i];
                if (!row || row.length === 0) continue;
                
                let agentName = '';
                if (agentNameCol >= 0 && row[agentNameCol]) {
                    agentName = (row[agentNameCol] || '').toString().trim();
                }
                if (!agentName && emailCol >= 0 && row[emailCol]) {
                    const email = (row[emailCol] || '').toString().trim();
                    if (email.includes('@')) {
                        agentName = email.split('@')[0];
                    } else {
                        agentName = email;
                    }
                }
                
                if (!agentName) {
                    for (let j = 0; j < row.length; j++) {
                        const cell = (row[j] || '').toString().trim();
                        if (cell && !/^\d+$/.test(cell) && !cell.includes('-') && !cell.includes('@') && cell.length > 2) {
                            agentName = cell;
                            break;
                        }
                    }
                }
                
                if (!agentName || agentName === '') continue;

                let profileType = '';
                if (profileCol >= 0 && row[profileCol]) {
                    profileType = (row[profileCol] || '').toString().trim();
                }
                
                let amount = 0;
                if (amountCol >= 0 && row[amountCol]) {
                    amount = parseFloat(row[amountCol]) || 0;
                }

                const category = getSubscriptionCategory(profileType, agentName) || 'B';

                if (!agentData[agentName]) {
                    agentData[agentName] = { 
                        P: 0, G: 0, S: 0, B: 0,
                        countP: 0, countG: 0, countS: 0, countB: 0
                    };
                }
                
                agentData[agentName][category] += amount;
                agentData[agentName]['count' + category] += 1;
            }

            for (const agentName in agentData) {
                const data = agentData[agentName];
                const iqP = data.P || 0;
                const iqG = data.G || 0;
                const iqS = data.S || 0;
                const iqB = data.B || 0;
                const iqT = iqP + iqG + iqS + iqB;
                
                const countP = data.countP || 0;
                const countG = data.countG || 0;
                const countS = data.countS || 0;
                const countB = data.countB || 0;
                const totalCount = countP + countG + countS + countB;
                
                const agentPercentageAmount = calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, agentPercentage);
                
                saveAgentPercentageWithCounts(
                    agentName, 
                    agentPercentage, 
                    iqT, iqP, iqG, iqS, iqB, 
                    agentPercentageAmount,
                    totalCount, countP, countG, countS, countB
                );
            }

            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            renderPercentageTable();
            showSuccessMessage(`تم تحليل البيانات بنجاح. تم حساب النسبة باستخدام ${agentPercentage}%`);
            logActivity('تحليل نسبة الوكلاء', `تم تحليل ملف الاشتراكات وحساب النسب باستخدام ${agentPercentage}%`);
        }

        function saveAgentPercentage(agentName, percentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount) {
            // الحصول على معلومات الوكيل من قائمة الوكلاء
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            
            if (!agentPercentages[agentName]) {
                agentPercentages[agentName] = {
                    percentage: percentage,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: 0,
                    countP: 0,
                    countG: 0,
                    countS: 0,
                    countB: 0,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                agentPercentages[agentName].percentage = percentage;
                agentPercentages[agentName].iqT = iqT;
                agentPercentages[agentName].iqP = iqP;
                agentPercentages[agentName].iqG = iqG;
                agentPercentages[agentName].iqS = iqS;
                agentPercentages[agentName].iqB = iqB;
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
                agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                    (agentPercentages[agentName].deductions || 0) - 
                    (agentPercentages[agentName].penalties || 0);
                
                // تحديث معلومات الاتصال إذا كانت متوفرة
                if (agentPhone) {
                    agentPercentages[agentName].phone = agentPhone;
                }
                if (agentEmail) {
                    agentPercentages[agentName].email = agentEmail;
                }
            }
        }

        function saveAgentPercentageWithCounts(agentName, percentage, iqT, iqP, iqG, iqS, iqB, agentPercentageAmount, totalCount, countP, countG, countS, countB) {
            // الحصول على معلومات الوكيل من قائمة الوكلاء
            const agent = agentsList.find(a => a.name === agentName);
            const agentPhone = agent?.phone || '';
            const agentEmail = agent?.email || '';
            
            if (!agentPercentages[agentName]) {
                agentPercentages[agentName] = {
                    percentage: percentage,
                    iqT: iqT,
                    iqP: iqP,
                    iqG: iqG,
                    iqS: iqS,
                    iqB: iqB,
                    agentPercentageAmount: agentPercentageAmount,
                    deductions: 0,
                    penalties: 0,
                    netPercentage: agentPercentageAmount,
                    totalCount: totalCount,
                    countP: countP,
                    countG: countG,
                    countS: countS,
                    countB: countB,
                    phone: agentPhone,
                    email: agentEmail
                };
            } else {
                agentPercentages[agentName].percentage = percentage;
                agentPercentages[agentName].iqT = iqT;
                agentPercentages[agentName].iqP = iqP;
                agentPercentages[agentName].iqG = iqG;
                agentPercentages[agentName].iqS = iqS;
                agentPercentages[agentName].iqB = iqB;
                agentPercentages[agentName].agentPercentageAmount = agentPercentageAmount;
                agentPercentages[agentName].totalCount = totalCount;
                agentPercentages[agentName].countP = countP;
                agentPercentages[agentName].countG = countG;
                agentPercentages[agentName].countS = countS;
                agentPercentages[agentName].countB = countB;
                agentPercentages[agentName].netPercentage = agentPercentageAmount - 
                    (agentPercentages[agentName].deductions || 0) - 
                    (agentPercentages[agentName].penalties || 0);
                
                // تحديث معلومات الاتصال إذا كانت متوفرة
                if (agentPhone) {
                    agentPercentages[agentName].phone = agentPhone;
                }
                if (agentEmail) {
                    agentPercentages[agentName].email = agentEmail;
                }
            }
        }

        function findColumnIndex(headers, keywords) {
            for (let i = 0; i < headers.length; i++) {
                const header = (headers[i] || '').toString().toLowerCase();
                if (keywords.some(keyword => header.includes(keyword.toLowerCase()))) {
                    return i;
                }
            }
            return -1;
        }

        function calculateAgentPercentage(iqT, iqP, iqG, iqS, iqB, percentage) {
            const rate = percentage / 100;
            return (iqP * rate) + (iqG * rate) + (iqS * rate) + (iqB * rate);
        }

        function renderPercentageTable() {
            const tbody = document.getElementById('percentageTableBody');
            if (!tbody) return;

            if (isRenderingTable) return;
            isRenderingTable = true;

            const activeElement = document.activeElement;
            let savedFocus = null;
            if (activeElement && activeElement.tagName === 'INPUT' && 
                activeElement.hasAttribute('data-agent-name') && 
                activeElement.hasAttribute('data-field-type')) {
                savedFocus = {
                    agentName: activeElement.getAttribute('data-agent-name'),
                    fieldType: activeElement.getAttribute('data-field-type'),
                    value: activeElement.value
                };
            }

            tbody.innerHTML = '';
            
            const agents = Object.keys(agentPercentages);
            if (agents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="18" style="text-align: center; padding: 15px; color: #999; font-size: 0.85rem;">لا توجد بيانات للعرض</td></tr>';
                isRenderingTable = false;
                return;
            }

            let totalIQT = 0, totalIQP = 0, totalIQG = 0, totalIQS = 0, totalIQB = 0;
            let totalIQPPercent = 0, totalIQGPercent = 0, totalIQSPercent = 0, totalIQBPercent = 0;
            let totalCountP = 0, totalCountG = 0, totalCountS = 0, totalCountB = 0;
            let totalAgentPercentage = 0, totalNetPercentage = 0;

            agents.forEach(agentName => {
                const data = agentPercentages[agentName];
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                
                const percentage = data.percentage || 15;
                const rate = percentage / 100;
                const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
                
                totalIQT += data.iqT || 0;
                totalIQP += data.iqP || 0;
                totalIQG += data.iqG || 0;
                totalIQS += data.iqS || 0;
                totalIQB += data.iqB || 0;
                totalIQPPercent += iqPPercent;
                totalIQGPercent += iqGPercent;
                totalIQSPercent += iqSPercent;
                totalIQBPercent += iqBPercent;
                totalCountP += data.countP || 0;
                totalCountG += data.countG || 0;
                totalCountS += data.countS || 0;
                totalCountB += data.countB || 0;
                totalAgentPercentage += data.agentPercentageAmount || 0;
                totalNetPercentage += data.netPercentage || 0;
                
                // الحصول على رقم الهاتف من بيانات النسبة أو من قائمة الوكلاء
                const agent = agentsList.find(a => a.name === agentName);
                const agentPhone = data.phone || agent?.phone || '';
                
                row.innerHTML = `
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-weight: 600; font-size: 0.75rem;">${agentName}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; position: relative; z-index: 10;">
                        <input type="text" id="phone_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${agentPhone}" 
                               data-agent-name="${agentName}"
                               data-field-type="phone"
                               placeholder="رقم الهاتف"
                               onchange="updateAgentPhone('${agentName}', this.value)"
                               style="width: 120px; padding: 4px; text-align: center; direction: ltr; font-size: 0.7rem; position: relative; z-index: 10; pointer-events: auto; cursor: text; -webkit-user-select: text; -moz-user-select: text; user-select: text; border: 1px solid #ccc; border-radius: 4px;" 
                               title="إضافة أو تعديل رقم الهاتف">
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; font-size: 0.75rem;">${percentage}%</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqT || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqP || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqG || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqS || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${formatNumber(data.iqB || 0)}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqPPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqGPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqSPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: 600; color: #2C5F8D; font-size: 0.7rem;">${formatNumber(Math.round(iqBPercent))}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countP || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countG || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countS || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-size: 0.7rem;">${data.countB || 0}</td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #801c32; font-size: 0.85rem;">
                        ${formatNumber(data.agentPercentageAmount || 0)}
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; position: relative; z-index: 10;">
                        <input type="number" id="deduction_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${data.deductions || 0}" 
                               data-agent-name="${agentName}"
                               data-field-type="deduction"
                               style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.7rem; position: relative; z-index: 10; pointer-events: auto; cursor: text; -webkit-user-select: text; -moz-user-select: text; user-select: text; border: 1px solid #ccc; border-radius: 4px;" 
                               step="0.01" min="0" placeholder="0">
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; position: relative; z-index: 10;">
                        <input type="number" id="penalty_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}" value="${data.penalties || 0}" 
                               data-agent-name="${agentName}"
                               data-field-type="penalty"
                               style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.7rem; position: relative; z-index: 10; pointer-events: auto; cursor: text; -webkit-user-select: text; -moz-user-select: text; user-select: text; border: 1px solid #ccc; border-radius: 4px;" 
                               step="0.01" min="0" placeholder="0">
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #25D366; font-size: 0.85rem;">
                        ${formatNumber(data.netPercentage || 0)}
                    </td>
                    <td style="padding: 6px 4px; text-align: center; border: 1px solid #ddd;">
                        <button class="btn btn-success" onclick="sendPercentageReport('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem; margin-left: 3px;">إرسال</button>
                        <button class="btn btn-info" onclick="downloadPercentagePDF('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem; margin-left: 3px; background-color: #dc3545; border-color: #dc3545;">PDF</button>
                        <button class="btn btn-danger" onclick="deletePercentage('${agentName}')" style="padding: 4px 8px; font-size: 0.7rem;">حذف</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });

            const totalRow = document.createElement('tr');
            totalRow.style.borderTop = '3px solid #801c32';
            totalRow.style.background = '#f8f9fa';
            totalRow.style.fontWeight = 'bold';
            totalRow.innerHTML = `
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; font-weight: bold; font-size: 0.8rem;">المجموع</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd;"></td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd;"></td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQT)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQP)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQG)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQS)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${formatNumber(totalIQB)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQPPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQGPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQSPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #2C5F8D; font-size: 0.75rem;">${formatNumber(Math.round(totalIQBPercent))}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountP}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountG}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountS}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; font-size: 0.75rem;">${totalCountB}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #801c32; font-size: 0.9rem;">${formatNumber(totalAgentPercentage)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd;"></td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd;"></td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd; direction: ltr; font-weight: bold; color: #25D366; font-size: 0.9rem;">${formatNumber(totalNetPercentage)}</td>
                <td style="padding: 8px 6px; text-align: center; border: 1px solid #ddd;"></td>
            `;
            tbody.appendChild(totalRow);

            const percentageResults = document.getElementById('percentageResults');
            if (percentageResults) {
                percentageResults.classList.remove('hidden');
            }
            
            setupPercentageTableEventListeners();
                        
                        if (savedFocus) {
                setTimeout(() => {
                            const inputId = savedFocus.fieldType === 'deduction' 
                                ? `deduction_${savedFocus.agentName.replace(/[^a-zA-Z0-9]/g, '_')}`
                                : `penalty_${savedFocus.agentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                            const input = document.getElementById(inputId);
                            if (input) {
                                    try {
                                        input.value = savedFocus.value;
                            input.focus();
                                        if (input.setSelectionRange) {
                                            input.setSelectionRange(input.value.length, input.value.length);
                                        }
                                    } catch (err) {
                                        console.warn('Error restoring focus:', err);
                                    }
                            }
                }, 100);
                        }
                        
                isRenderingTable = false;
        }

        async function exportPercentageToExcel() {
            if (!agentPercentages || Object.keys(agentPercentages).length === 0) {
                alert('لا توجد بيانات للتصدير. يرجى تحليل بيانات الوكلاء أولاً.');
                return;
            }

            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('نسبة الوكلاء');
                
                let totalIQT = 0, totalIQP = 0, totalIQG = 0, totalIQS = 0, totalIQB = 0;
                let totalIQPPercent = 0, totalIQGPercent = 0, totalIQSPercent = 0, totalIQBPercent = 0;
                let totalCountP = 0, totalCountG = 0, totalCountS = 0, totalCountB = 0;
                let totalAgentPercentage = 0, totalNetPercentage = 0;
                
                const headerRow1 = worksheet.addRow([
                    'اسم الوكيل',
                    'النسبة (%)',
                    '', '', '', '', '',
                    '', '', '', '',
                    '', '', '', '',
                    'نسبة الوكيل',
                    'استقطاعات',
                    'غرامات',
                    'النسبة الصافية'
                ]);
                
                const headerRow2 = worksheet.addRow([
                    '',
                    '',
                    'IQ.T', 'IQ.P', 'IQ.G', 'IQ.S', 'IQ.B',
                    'IQ.P%', 'IQ.G%', 'IQ.S%', 'IQ.B%',
                    'P', 'G', 'S', 'B',
                    '',
                    '',
                    ''
                ]);
                
                [headerRow1, headerRow2].forEach(row => {
                    row.height = 25;
                    row.eachCell((cell, colNumber) => {
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF801C32' }
                        };
                        cell.font = {
                            bold: true,
                            size: 12,
                            color: { argb: 'FFFFFFFF' }
                        };
                        cell.alignment = {
                            horizontal: 'center',
                            vertical: 'middle',
                            wrapText: true
                        };
                        cell.border = {
                            top: { style: 'medium', color: { argb: 'FF000000' } },
                            bottom: { style: 'medium', color: { argb: 'FF000000' } },
                            left: { style: 'medium', color: { argb: 'FF000000' } },
                            right: { style: 'medium', color: { argb: 'FF000000' } }
                        };
                    });
                });
                
                worksheet.mergeCells('C1:G1');
                worksheet.mergeCells('H1:K1');
                worksheet.mergeCells('L1:O1');
                worksheet.mergeCells('P1:P2');
                worksheet.mergeCells('Q1:Q2');
                worksheet.mergeCells('R1:R2');
                worksheet.mergeCells('S1:S2');
                
                const agents = Object.keys(agentPercentages).sort();
                agents.forEach(agentName => {
                    const data = agentPercentages[agentName];
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    
                    const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                    const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                    const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                    const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
                    
                    const row = worksheet.addRow([
                        agentName,
                        percentage,
                        data.iqT || 0,
                        data.iqP || 0,
                        data.iqG || 0,
                        data.iqS || 0,
                        data.iqB || 0,
                        Math.round(iqPPercent),
                        Math.round(iqGPercent),
                        Math.round(iqSPercent),
                        Math.round(iqBPercent),
                        data.countP || 0,
                        data.countG || 0,
                        data.countS || 0,
                        data.countB || 0,
                        data.agentPercentageAmount || 0,
                        data.deductions || 0,
                        data.penalties || 0,
                        data.netPercentage || 0
                    ]);
                    
                    row.height = 20;
                    const isEvenRow = row.number % 2 === 0;
                    const bgColor = isEvenRow ? 'FFF8F9FA' : 'FFFFFFFF';
                    
                    row.eachCell((cell, colNumber) => {
                        if (colNumber >= 3 && typeof cell.value === 'number') {
                            cell.numFmt = '#,##0';
                        }
                        
                        let fontColor = 'FF000000';
                        let fontSize = 11;
                        let isBold = false;
                        if (colNumber === 16) {
                            fontColor = 'FF801C32';
                            fontSize = 12;
                            isBold = true;
                        }
                        if (colNumber === 19) {
                            fontColor = 'FF25D366';
                            fontSize = 12;
                            isBold = true;
                        }
                        
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: bgColor }
                        };
                        cell.font = {
                            size: fontSize,
                            color: { argb: fontColor },
                            bold: isBold
                        };
                        cell.alignment = {
                            horizontal: 'center',
                            vertical: 'middle'
                        };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                            right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                        };
                    });
                    
                    totalIQT += data.iqT || 0;
                    totalIQP += data.iqP || 0;
                    totalIQG += data.iqG || 0;
                    totalIQS += data.iqS || 0;
                    totalIQB += data.iqB || 0;
                    totalIQPPercent += iqPPercent;
                    totalIQGPercent += iqGPercent;
                    totalIQSPercent += iqSPercent;
                    totalIQBPercent += iqBPercent;
                    totalCountP += data.countP || 0;
                    totalCountG += data.countG || 0;
                    totalCountS += data.countS || 0;
                    totalCountB += data.countB || 0;
                    totalAgentPercentage += data.agentPercentageAmount || 0;
                    totalNetPercentage += data.netPercentage || 0;
                });
                
                const totalRow = worksheet.addRow([
                    'المجموع',
                    '',
                    totalIQT,
                    totalIQP,
                    totalIQG,
                    totalIQS,
                    totalIQB,
                    Math.round(totalIQPPercent),
                    Math.round(totalIQGPercent),
                    Math.round(totalIQSPercent),
                    Math.round(totalIQBPercent),
                    totalCountP,
                    totalCountG,
                    totalCountS,
                    totalCountB,
                    totalAgentPercentage,
                    '',
                    '',
                    totalNetPercentage
                ]);
                
                totalRow.height = 25;
                totalRow.eachCell((cell, colNumber) => {
                    if (colNumber >= 3 && typeof cell.value === 'number') {
                        cell.numFmt = '#,##0';
                    }
                    
                    let fontColor = 'FF000000';
                    let fontSize = 12;
                    if (colNumber === 16) {
                        fontColor = 'FF801C32';
                        fontSize = 13;
                    }
                    if (colNumber === 19) {
                        fontColor = 'FF25D366';
                        fontSize = 13;
                    }
                    
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFF8F9FA' }
                    };
                    cell.font = {
                        bold: true,
                        size: fontSize,
                        color: { argb: fontColor }
                    };
                    cell.alignment = {
                        horizontal: 'center',
                        vertical: 'middle'
                    };
                    cell.border = {
                        top: { style: 'thick', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                        right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                    };
                });
                
                worksheet.columns = [
                    { width: 25 },
                    { width: 10 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 15 },
                    { width: 8 },
                    { width: 8 },
                    { width: 8 },
                    { width: 8 },
                    { width: 18 },
                    { width: 12 },
                    { width: 12 },
                    { width: 18 }
                ];
                
                const now = new Date();
                const dateStr = `${now.getDate()}_${now.getMonth() + 1}_${now.getFullYear()}`;
                const filename = `نسبة_الوكلاء_${dateStr}.xlsx`;
                
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                ""
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                window.URL.revokeObjectURL(url);
                
                showSuccessMessage(`تم تصدير بيانات ${agents.length} وكيل إلى ملف Excel بنجاح!`);
                logActivity('تصدير نسبة الوكلاء', `تم تصدير بيانات ${agents.length} وكيل إلى Excel`);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('حدث خطأ أثناء التصدير: ' + error.message);
            }
        }

        function updateDeduction(agentName, value, skipRender = false) {
            if (!agentPercentages[agentName]) return;
            
            const deduction = parseFloat(value) || 0;
            agentPercentages[agentName].deductions = deduction;
            agentPercentages[agentName].netPercentage = agentPercentages[agentName].agentPercentageAmount - 
                deduction - (agentPercentages[agentName].penalties || 0);
            
            if (skipRender) {
                const inputId = `deduction_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const input = document.getElementById(inputId);
                if (input) {
                    const row = input.closest('tr');
                    if (row) {
                        const cells = row.querySelectorAll('td');
                        const netPercentageCell = cells[cells.length - 2];
                        if (netPercentageCell) {
                            netPercentageCell.textContent = formatNumber(agentPercentages[agentName].netPercentage || 0);
                        }
                    }
                }
            }
            
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            
            if (!skipRender) {
                lastPercentageDataHash = '';
                loadPercentageData();
                logActivity('تحديث استقطاع', `تم تحديث الاستقطاع للوكيل ${agentName}: ${formatNumber(deduction)}`);
            }
        }

        function updatePenalty(agentName, value, skipRender = false) {
            if (!agentPercentages[agentName]) return;
            
            const penalty = parseFloat(value) || 0;
            agentPercentages[agentName].penalties = penalty;
            agentPercentages[agentName].netPercentage = agentPercentages[agentName].agentPercentageAmount - 
                (agentPercentages[agentName].deductions || 0) - penalty;
            
            if (skipRender) {
                const inputId = `penalty_${agentName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const input = document.getElementById(inputId);
                if (input) {
                    const row = input.closest('tr');
                    if (row) {
                        const cells = row.querySelectorAll('td');
                        const netPercentageCell = cells[cells.length - 2];
                        if (netPercentageCell) {
                            netPercentageCell.textContent = formatNumber(agentPercentages[agentName].netPercentage || 0);
                        }
                    }
                }
            }
            
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            
            if (!skipRender) {
                lastPercentageDataHash = '';
                loadPercentageData();
                logActivity('تحديث غرامة', `تم تحديث الغرامة للوكيل ${agentName}: ${formatNumber(penalty)}`);
            }
        }

        function deletePercentage(agentName) {
            if (confirm(`هل أنت متأكد من حذف بيانات نسبة الوكيل "${agentName}"؟`)) {
                delete agentPercentages[agentName];
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
                lastPercentageDataHash = '';
                renderPercentageTable();
                logActivity('حذف نسبة وكيل', `تم حذف بيانات نسبة الوكيل: ${agentName}`);
            }
        }
        
        // تحديث رقم هاتف الوكيل في بيانات النسبة
        function updateAgentPhone(agentName, phone) {
            if (!agentPercentages[agentName]) return;
            
            // حفظ رقم الهاتف في بيانات النسبة
            agentPercentages[agentName].phone = phone || '';
            
            // تحديث رقم الهاتف في قائمة الوكلاء أيضاً إذا كان موجوداً
            const agent = agentsList.find(a => a.name === agentName);
            if (agent && phone) {
                agent.phone = phone;
                localStorage.setItem('agentsList', JSON.stringify(agentsList));
            }
            
            // حفظ بيانات النسبة
            localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            
            logActivity('تحديث رقم هاتف وكيل', `تم تحديث رقم الهاتف للوكيل ${agentName}: ${phone}`);
            showSuccessMessage(`تم تحديث رقم الهاتف للوكيل: ${agentName}`);
        }
        
        // إرسال تقرير نسبة الوكيل
        function sendPercentageReport(agentName) {
            // الحصول على معلومات الوكيل من قائمة الوكلاء أولاً
            let agent = agentsList.find(a => a.name === agentName);
            
            // إذا لم يكن موجوداً في قائمة الوكلاء، نحاول الحصول على معلوماته من بيانات النسبة
            if (!agent) {
                const percentageData = agentPercentages[agentName];
                if (percentageData && (percentageData.phone || percentageData.email)) {
                    agent = {
                        name: agentName,
                        phone: percentageData.phone || '',
                        email: percentageData.email || ''
                    };
                } else {
                    alert('الوكيل غير موجود في القائمة. يرجى إضافة الوكيل في تبويب "إدارة الوكلاء" وإضافة رقم الهاتف.');
                    return;
                }
            }
            
            // تحديث معلومات الاتصال في بيانات النسبة من قائمة الوكلاء
            if (agent && agentPercentages[agentName]) {
                if (agent.phone) {
                    agentPercentages[agentName].phone = agent.phone;
                }
                if (agent.email) {
                    agentPercentages[agentName].email = agent.email;
                }
                localStorage.setItem('agentPercentages', JSON.stringify(agentPercentages));
            }
            
            // استخدام رقم الهاتف من بيانات النسبة أو من قائمة الوكلاء
            const phone = agentPercentages[agentName]?.phone || agent?.phone;
            
            if (!phone) {
                alert('لم يتم تحديد رقم هاتف للوكيل. يرجى إضافة رقم الهاتف في تبويب "إدارة الوكلاء"');
                return;
            }
            
            const data = agentPercentages[agentName];
            if (!data) {
                alert('لا توجد بيانات للوكيل');
                return;
            }
            
            // إنشاء رسالة WhatsApp
            let message = `*${agentName}*\n\n`;
            message += `تحية طيبة وبعد،\n\n`;
            message += `نود إعلامكم بالتقرير الخاص بنسبة الوكيل، وكما يلي:\n\n`;
            message += `━━━━━━━━━━━━━━━━━━━━\n`;
            
            // إضافة تفاصيل الاشتراكات
            const percentage = data.percentage || 15;
            const rate = percentage / 100;
            const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
            const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
            const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
            const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);
            
            // تم حذف جملة النسبة المئوية وتفاصيل الاشتراكات - التفاصيل موجودة في ملف Excel
            // عرض النسبة الصافية فقط في الرسالة
            
            message += `*النسبة الصافية: ${formatNumberEnglish(data.netPercentage || 0)} دينار عراقي*\n`;
            
            if ((data.deductions || 0) > 0) {
                message += `*الاستقطاعات: ${formatNumberEnglish(data.deductions || 0)} دينار عراقي*\n`;
            }
            
            if ((data.penalties || 0) > 0) {
                message += `*الغرامات: ${formatNumberEnglish(data.penalties || 0)} دينار عراقي*\n`;
            }
            
            message += `\n`;
            
            message += `\n━━━━━━━━━━━━━━━━━━━━\n`;
            message += `يرجى التفضل بالاطلاع على الملف المرفق للاطلاع على التفاصيل الكاملة.\n\n`;
            message += `مع فائق الشكر والتقدير،\n`;
            message += `*شركة عراق سيل للإتصالات*`;
            
            // إنشاء ملف Excel
            generatePercentageExcelReport(agentName).then((excelBlob) => {
                const formattedPhone = formatPhoneForWhatsApp(phone);
                
                // تحميل الملف
                downloadFile(excelBlob, `تقرير_نسبة_${agentName}_${formatDateForFilename(new Date())}.xlsx`);
                
                // فتح WhatsApp
                const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                logActivity('إرسال تقرير نسبة وكيل', `تم إرسال تقرير نسبة الوكيل: ${agentName}`);
                showSuccessMessage(`تم إرسال تقرير نسبة الوكيل: ${agentName}`);
            }).catch((error) => {
                console.error('Error generating Excel:', error);
                alert('حدث خطأ أثناء إنشاء ملف Excel. يرجى المحاولة مرة أخرى.');
            });
        }
        
        // إنشاء ملف Excel لتقرير نسبة الوكيل
        function generatePercentageExcelReport(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const data = agentPercentages[agentName];
                    if (!data) {
                        reject(new Error('لا توجد بيانات للوكيل'));
                        return;
                    }
                    
                    const agent = agentsList.find(a => a.name === agentName);
                    
                    // استخدام ExcelJS للتنسيق الاحترافي
                    const ExcelJS = window.ExcelJS;
                    if (!ExcelJS) {
                        reject(new Error('ExcelJS غير متوفر'));
                        return;
                    }
                    
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('تقرير نسبة الوكيل');
                    
                    // تحديد عرض الأعمدة
                    worksheet.columns = [
                        { width: 30, key: 'type' },
                        { width: 20, key: 'count' },
                        { width: 20, key: 'amount' },
                        { width: 20, key: 'percentage' }
                    ];
                    
                    let currentRow = 1;
                    
                    // العنوان الرئيسي
                    const titleRow = worksheet.getRow(currentRow);
                    titleRow.getCell(1).value = 'تقرير نسبة الوكيل';
                    titleRow.getCell(1).font = { bold: true, size: 18, color: { argb: 'FF801C32' } };
                    titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    titleRow.height = 30;
                    currentRow++;
                    
                    // معلومات الوكيل
                    currentRow++;
                    worksheet.getRow(currentRow).getCell(1).value = `اسم الوكيل: ${agentName}`;
                    worksheet.getRow(currentRow).getCell(1).font = { bold: true, size: 12 };
                    currentRow++;
                    
                    if (agent?.email) {
                        worksheet.getRow(currentRow).getCell(1).value = `البريد الإلكتروني: ${agent.email}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 11 };
                        currentRow++;
                    }
                    if (agent?.phone) {
                        worksheet.getRow(currentRow).getCell(1).value = `رقم الهاتف: ${agent.phone}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 11 };
                        currentRow++;
                    }
                    currentRow++;
                    
                    // معلومات النسبة (تم حذف عرض النسبة المئوية بناءً على طلب المستخدم)
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    // تم حذف سطر النسبة المئوية من ملف Excel
                    currentRow++;
                    
                    // جدول الاشتراكات
                    const sectionRow = worksheet.getRow(currentRow);
                    sectionRow.getCell(1).value = 'تفاصيل الاشتراكات';
                    sectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    sectionRow.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFF8F9FA' }
                    };
                    sectionRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
                    sectionRow.getCell(1).border = {
                        top: { style: 'thin', color: { argb: 'FF801C32' } },
                        bottom: { style: 'thin', color: { argb: 'FF801C32' } },
                        left: { style: 'thin', color: { argb: 'FF801C32' } },
                        right: { style: 'thin', color: { argb: 'FF801C32' } }
                    };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    sectionRow.height = 25;
                    currentRow++;
                    
                    // رأس الجدول
                    const headerRow = worksheet.getRow(currentRow);
                    const headers = ['نوع الاشتراك', 'عدد الاشتراكات', 'المبلغ (د.ع)', 'نسبة الوكيل (د.ع)'];
                    headers.forEach((header, idx) => {
                        const cell = headerRow.getCell(idx + 1);
                        cell.value = header;
                        cell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FF801C32' }
                        };
                        cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                            right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                        };
                    });
                    headerRow.height = 25;
                    currentRow++;
                    
                    // بيانات الاشتراكات
                    const categories = [
                        { key: 'platinum', name: 'Platinum', count: data.countP || 0, amount: data.iqP || 0 },
                        { key: 'gold', name: 'Gold', count: data.countG || 0, amount: data.iqG || 0 },
                        { key: 'silver', name: 'Silver', count: data.countS || 0, amount: data.iqS || 0 },
                        { key: 'bronze', name: 'Bronze', count: data.countB || 0, amount: data.iqB || 0 }
                    ];
                    
                    categories.forEach((cat, index) => {
                        const iqPPercent = cat.key === 'platinum' ? (data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate)) :
                                          cat.key === 'gold' ? (data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate)) :
                                          cat.key === 'silver' ? (data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate)) :
                                          (data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate));
                        
                        const dataRow = worksheet.getRow(currentRow);
                        const isEven = index % 2 === 0;
                        const bgColor = isEven ? 'FFFFFFFF' : 'FFF8F9FA';
                        
                        dataRow.getCell(1).value = cat.name;
                        dataRow.getCell(2).value = formatNumberEnglish(cat.count);
                        dataRow.getCell(3).value = formatNumberEnglish(cat.amount);
                        dataRow.getCell(4).value = formatNumberEnglish(Math.round(iqPPercent));
                        
                        // تنسيق الخلايا
                        for (let col = 1; col <= 4; col++) {
                            const cell = dataRow.getCell(col);
                            cell.font = { size: 11 };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: bgColor }
                            };
                            cell.alignment = col === 1 ? 
                                { horizontal: 'right', vertical: 'middle' } : 
                                { horizontal: 'center', vertical: 'middle' };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                            };
                        }
                        
                        dataRow.height = 22;
                        currentRow++;
                    });
                    
                    // صف المجموع
                    const totalDataRow = worksheet.getRow(currentRow);
                    const totalCount = (data.countP || 0) + (data.countG || 0) + (data.countS || 0) + (data.countB || 0);
                    const totalAmount = (data.iqP || 0) + (data.iqG || 0) + (data.iqS || 0) + (data.iqB || 0);
                    const totalPercent = Math.round((data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate)) +
                                                   (data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate)) +
                                                   (data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate)) +
                                                   (data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate)));
                    
                    totalDataRow.getCell(1).value = 'المجموع';
                    totalDataRow.getCell(2).value = formatNumberEnglish(totalCount);
                    totalDataRow.getCell(3).value = formatNumberEnglish(totalAmount);
                    totalDataRow.getCell(4).value = formatNumberEnglish(totalPercent);
                    
                    // تنسيق صف المجموع
                    for (let col = 1; col <= 4; col++) {
                        const cell = totalDataRow.getCell(col);
                        cell.font = { bold: true, size: 12 };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        cell.alignment = col === 1 ? 
                            { horizontal: 'right', vertical: 'middle' } : 
                            { horizontal: 'center', vertical: 'middle' };
                        cell.border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                    }
                    totalDataRow.height = 25;
                    currentRow++;
                    currentRow++;
                    
                    // ملخص النسبة
                    const summaryRow = worksheet.getRow(currentRow);
                    summaryRow.getCell(1).value = 'نسبة الوكيل';
                    summaryRow.getCell(4).value = formatNumberEnglish(data.agentPercentageAmount || 0);
                    summaryRow.getCell(1).font = { bold: true, size: 12 };
                    summaryRow.getCell(4).font = { bold: true, size: 12 };
                    summaryRow.getCell(4).alignment = { horizontal: 'center' };
                    currentRow++;
                    
                    if ((data.deductions || 0) > 0) {
                        const deductionRow = worksheet.getRow(currentRow);
                        deductionRow.getCell(1).value = 'الاستقطاعات';
                        deductionRow.getCell(4).value = formatNumberEnglish(data.deductions || 0);
                        deductionRow.getCell(1).font = { bold: true, size: 12 };
                        deductionRow.getCell(4).font = { bold: true, size: 12 };
                        deductionRow.getCell(4).alignment = { horizontal: 'center' };
                        currentRow++;
                    }
                    
                    if ((data.penalties || 0) > 0) {
                        const penaltyRow = worksheet.getRow(currentRow);
                        penaltyRow.getCell(1).value = 'الغرامات';
                        penaltyRow.getCell(4).value = formatNumberEnglish(data.penalties || 0);
                        penaltyRow.getCell(1).font = { bold: true, size: 12 };
                        penaltyRow.getCell(4).font = { bold: true, size: 12 };
                        penaltyRow.getCell(4).alignment = { horizontal: 'center' };
                        currentRow++;
                    }
                    
                    // النسبة الصافية
                    const netRow = worksheet.getRow(currentRow);
                    netRow.getCell(1).value = 'النسبة الصافية';
                    netRow.getCell(4).value = formatNumberEnglish(data.netPercentage || 0);
                    netRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    netRow.getCell(4).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                    netRow.getCell(4).alignment = { horizontal: 'center' };
                    netRow.getCell(1).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F0F5' }
                    };
                    netRow.getCell(4).fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F0F5' }
                    };
                    netRow.getCell(1).border = {
                        top: { style: 'medium', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                        left: { style: 'medium', color: { argb: 'FF801C32' } },
                        right: { style: 'thin', color: { argb: 'FF801C32' } }
                    };
                    netRow.getCell(4).border = {
                        top: { style: 'medium', color: { argb: 'FF801C32' } },
                        bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                        left: { style: 'thin', color: { argb: 'FF801C32' } },
                        right: { style: 'medium', color: { argb: 'FF801C32' } }
                    };
                    netRow.height = 30;
                    
                    // إنشاء الملف
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    resolve(blob);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // تحميل تقرير نسبة الوكيل بصيغة PDF
        function downloadPercentagePDF(agentName) {
            generatePercentagePDFReport(agentName).then((pdfBlob) => {
                const safeName = agentName.replace(/[^a-zA-Z0-9_]/g, '_');
                const filename = `تقرير_نسبة_${safeName}_${formatDateForFilename(new Date())}.pdf`;
                downloadFile(pdfBlob, filename);
                logActivity('تحميل تقرير نسبة PDF', `تم تحميل تقرير نسبة PDF للوكيل: ${agentName}`);
                showSuccessMessage(`تم تحميل تقرير PDF للوكيل: ${agentName}`);
            }).catch((error) => {
                console.error('Error generating PDF:', error);
                alert('حدث خطأ أثناء إنشاء ملف PDF. يرجى المحاولة مرة أخرى.');
            });
        }

        // إنشاء ملف PDF لتقرير نسبة الوكيل
        function generatePercentagePDFReport(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const data = agentPercentages[agentName];
                    if (!data) {
                        reject(new Error('لا توجد بيانات للوكيل'));
                        return;
                    }

                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        reject(new Error('jsPDF غير متوفر'));
                        return;
                    }

                    const doc = new jsPDF('portrait', 'mm', 'a4');
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    let yPos = 15;

                    // العنوان الرئيسي
                    doc.setFontSize(18);
                    doc.setTextColor(128, 28, 50); // #801C32
                    doc.setFont('helvetica', 'bold');
                    const titleText = 'Agent Percentage Report';
                    const titleWidth = doc.getTextWidth(titleText);
                    doc.text(titleText, (pageWidth - titleWidth) / 2, yPos);
                    yPos += 15;

                    // معلومات الوكيل
                    const agent = agentsList.find(a => a.name === agentName);
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Name: ${agentName}`, 20, yPos);
                    yPos += 8;

                    if (agent?.email) {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(11);
                        doc.text(`Email: ${agent.email}`, 20, yPos);
                        yPos += 7;
                    }

                    if (agent?.phone) {
                        doc.text(`Phone Number: ${agent.phone}`, 20, yPos);
                        yPos += 7;
                    }

                    yPos += 5;

                    // جدول الاشتراكات
                    const percentage = data.percentage || 15;
                    const rate = percentage / 100;
                    const iqPPercent = data.iqPPercent !== undefined ? data.iqPPercent : ((data.iqP || 0) * rate);
                    const iqGPercent = data.iqGPercent !== undefined ? data.iqGPercent : ((data.iqG || 0) * rate);
                    const iqSPercent = data.iqSPercent !== undefined ? data.iqSPercent : ((data.iqS || 0) * rate);
                    const iqBPercent = data.iqBPercent !== undefined ? data.iqBPercent : ((data.iqB || 0) * rate);

                    const tableData = [
                        ['Platinum', formatNumberEnglish(data.countP || 0), formatNumberEnglish(data.iqP || 0), formatNumberEnglish(Math.round(iqPPercent))],
                        ['Gold', formatNumberEnglish(data.countG || 0), formatNumberEnglish(data.iqG || 0), formatNumberEnglish(Math.round(iqGPercent))],
                        ['Silver', formatNumberEnglish(data.countS || 0), formatNumberEnglish(data.iqS || 0), formatNumberEnglish(Math.round(iqSPercent))],
                        ['Bronze', formatNumberEnglish(data.countB || 0), formatNumberEnglish(data.iqB || 0), formatNumberEnglish(Math.round(iqBPercent))],
                    ];

                    const totalCount = (data.countP || 0) + (data.countG || 0) + (data.countS || 0) + (data.countB || 0);
                    const totalAmount = (data.iqP || 0) + (data.iqG || 0) + (data.iqS || 0) + (data.iqB || 0);
                    const totalPercent = Math.round(iqPPercent + iqGPercent + iqSPercent + iqBPercent);

                    tableData.push([
                        'Total',
                        formatNumberEnglish(totalCount),
                        formatNumberEnglish(totalAmount),
                        formatNumberEnglish(totalPercent)
                    ]);

                    doc.autoTable({
                        startY: yPos,
                        head: [['Subscription Type', 'Count', 'Amount (IQD)', 'Agent Percentage (IQD)']],
                        body: tableData,
                        theme: 'striped',
                        headStyles: {
                            fillColor: [128, 28, 50], // #801C32
                            textColor: [255, 255, 255],
                            fontStyle: 'bold',
                            fontSize: 12,
                            halign: 'center'
                        },
                        bodyStyles: {
                            fontSize: 11,
                            halign: 'center'
                        },
                        columnStyles: {
                            0: { halign: 'left' },
                            1: { halign: 'center' },
                            2: { halign: 'center' },
                            3: { halign: 'center' }
                        },
                        didParseCell: function(data) {
                            // تنسيق صف المجموع
                            if (data.row.index === tableData.length - 1) {
                                data.cell.styles.fillColor = [232, 240, 245]; // #E8F0F5
                                data.cell.styles.fontStyle = 'bold';
                                data.cell.styles.fontSize = 12;
                            }
                        },
                        margin: { left: 20, right: 20 }
                    });

                    yPos = doc.lastAutoTable.finalY + 15;

                    // ملخص النسبة
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Agent Percentage: ${formatNumberEnglish(data.agentPercentageAmount || 0)} IQD`, 20, yPos);
                    yPos += 10;

                    if ((data.deductions || 0) > 0) {
                        doc.setFont('helvetica', 'normal');
                        doc.text(`Deductions: ${formatNumberEnglish(data.deductions || 0)} IQD`, 20, yPos);
                        yPos += 10;
                    }

                    if ((data.penalties || 0) > 0) {
                        doc.text(`Penalties: ${formatNumberEnglish(data.penalties || 0)} IQD`, 20, yPos);
                        yPos += 10;
                    }

                    // النسبة الصافية
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(128, 28, 50); // #801C32
                    doc.text(`Net Percentage: ${formatNumberEnglish(data.netPercentage || 0)} IQD`, 20, yPos);

                    // إنشاء blob
                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function resetPercentageData() {
            if (confirm('هل أنت متأكد من مسح جميع بيانات نسبة الوكلاء؟')) {
                percentageData = null;
                agentPercentages = {};
                localStorage.removeItem('agentPercentages');
                lastPercentageDataHash = '';
                document.getElementById('percentageFileName').classList.add('hidden');
                document.getElementById('percentageResults').classList.add('hidden');
                document.getElementById('percentageFileInput').value = '';
                document.getElementById('selectedAgentForPercentage').value = '';
                document.getElementById('agentFileUploadSection').style.display = 'none';
                showSuccessMessage('تم مسح البيانات بنجاح');
                logActivity('مسح نسبة الوكلاء', 'تم مسح جميع بيانات نسبة الوكلاء');
            }
        }

        let lastPercentageDataHash = '';
        let isRenderingTable = false;
        let renderPercentageTableTimeout = null;
        
        function loadPercentageData() {
            if (isRenderingTable) return;
            
            if (renderPercentageTableTimeout) {
                clearTimeout(renderPercentageTableTimeout);
            }
            
            const currentDataHash = JSON.stringify(agentPercentages);
            
            if (currentDataHash !== lastPercentageDataHash) {
                lastPercentageDataHash = currentDataHash;
                
                renderPercentageTableTimeout = setTimeout(() => {
                    if (Object.keys(agentPercentages).length > 0 && !isRenderingTable) {
                        renderPercentageTable();
                    }
                    renderPercentageTableTimeout = null;
                }, 1000);
            }
        }

        function setupPercentageTableEventListeners() {
                const tbody = document.getElementById('percentageTableBody');
            if (!tbody) return;
            
            const oldInputs = tbody.querySelectorAll('input[data-agent-name]');
            oldInputs.forEach(input => {
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
            });
            
            tbody.addEventListener('input', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = input.value;
                    
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, true);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, true);
                    }
                }
            });
            
            tbody.addEventListener('change', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = parseFloat(input.value) || 0;
                    
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, false);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, false);
                    }
                }
            });
            
            tbody.addEventListener('blur', function(e) {
                const input = e.target;
                if (input && input.tagName === 'INPUT' && input.hasAttribute('data-agent-name') && input.hasAttribute('data-field-type')) {
                    const agentName = input.getAttribute('data-agent-name');
                    const fieldType = input.getAttribute('data-field-type');
                    const value = parseFloat(input.value) || 0;
                    
                    if (fieldType === 'deduction') {
                        updateDeduction(agentName, value, false);
                    } else if (fieldType === 'penalty') {
                        updatePenalty(agentName, value, false);
                    }
                }
            }, true);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            
            if (!sidebar || !mainContent || !toggleBtn) return;
            
            const isHidden = sidebar.classList.contains('hidden');
            
            if (isHidden) {
                sidebar.classList.remove('hidden');
                mainContent.classList.remove('sidebar-hidden');
                toggleBtn.textContent = '☰';
                toggleBtn.title = 'إخفاء القائمة الجانبية';
                localStorage.setItem('sidebarHidden', 'false');
            } else {
                sidebar.classList.add('hidden');
                mainContent.classList.add('sidebar-hidden');
                toggleBtn.textContent = '☰';
                toggleBtn.title = 'إظهار القائمة الجانبية';
                localStorage.setItem('sidebarHidden', 'true');
            }
        }

        function loadSidebarState() {
            const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            
            if (sidebar && mainContent && toggleBtn) {
                if (sidebarHidden) {
                    sidebar.classList.add('hidden');
                    mainContent.classList.add('sidebar-hidden');
                    toggleBtn.title = 'إظهار القائمة الجانبية';
                } else {
                    sidebar.classList.remove('hidden');
                    mainContent.classList.remove('sidebar-hidden');
                    toggleBtn.title = 'إخفاء القائمة الجانبية';
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            setupPercentageFileUpload();
            setupPercentageTableEventListeners();
            setupFileUploads();
            const dashboard = document.getElementById('dashboard');
            if (dashboard) {
                dashboard.style.display = 'block';
                loadSidebarState();
            }
            document.getElementById('currentUser').textContent = '';
            loadPercentageData();
            
            const select = document.getElementById('selectedAgentForPercentage');
            if (select) {
                select.addEventListener('change', onAgentSelectedForPercentage);
                updateAgentsListForPercentage();
            }
            
            // استعادة البيانات المحفوظة بعد تحميل الصفحة
            setTimeout(() => {
                restoreSavedData();
            }, 500);
        });
        
        // حفظ البيانات قبل إعادة تحميل الصفحة
        window.addEventListener('beforeunload', function() {
            try {
                if (basicData) saveDataToStorage('basicData', basicData);
                if (advancedData) saveDataToStorage('advancedData', advancedData);
                if (twoMonthsData) saveDataToStorage('twoMonthsData', twoMonthsData);
                if (basicDetails && basicDetails.length > 0) saveDataToStorage('basicDetails', basicDetails);
                if (advancedDetails && advancedDetails.length > 0) saveDataToStorage('advancedDetails', advancedDetails);
                if (twoMonthsDetails && twoMonthsDetails.length > 0) saveDataToStorage('twoMonthsDetails', twoMonthsDetails);
                if (agentReports && Object.keys(agentReports).length > 0) saveDataToStorage('agentReports', agentReports);
            } catch (error) {
                console.error('خطأ في حفظ البيانات قبل إعادة التحميل:', error);
            }
        });

        function setupLoginForm() {
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                if (validCredentials[username] && validCredentials[username] === password) {
                    currentUser = username;
                    document.getElementById('currentUser').textContent = username;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    document.getElementById('loginError').classList.add('hidden');
                    loadSidebarState();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            });
        }

        function logout() {
            currentUser = '';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            resetBasicResults();
            resetAdvancedResults();
            resetTwoMonthsResults();
        }

        function updateCurrentDate() {
            const now = new Date();
            const arabicDate = formatArabicDate(now);
            document.getElementById('currentDateTime').textContent = arabicDate;
        }

        function formatArabicDate(date) {
            const day = date.getDate().toString();
            const month = arabicMonths[date.getMonth()];
            const year = date.getFullYear().toString();
            return `${day} ${month} ${year}`;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (event && event.target.closest('.nav-item')) {
                event.target.closest('.nav-item').classList.add('active');
            } else {
                const navItems = document.querySelectorAll('.nav-item');
                if (tabName === 'basic') navItems[0]?.classList.add('active');
                else if (tabName === 'advanced') navItems[1]?.classList.add('active');
                else if (tabName === 'twoMonths') navItems[2]?.classList.add('active');
            else if (tabName === 'agents') navItems[3]?.classList.add('active');
            else if (tabName === 'agentPercentage') navItems[4]?.classList.add('active');
            else if (tabName === 'summary') navItems[5]?.classList.add('active');
            else if (tabName === 'settings') navItems[6]?.classList.add('active');
            else if (tabName === 'activity') navItems[7]?.classList.add('active');
            }
            
            const tabElement = document.getElementById(tabName + 'Tab');
            if (tabElement) {
                tabElement.classList.add('active');
                
                if (tabName === 'summary') {
                    updateAgentSummary();
                } else if (tabName === 'agents') {
                    renderAgentsList();
                } else if (tabName === 'agentPercentage') {
                    updateAgentsListForPercentage();
                } else if (tabName === 'activity') {
                    setTimeout(() => refreshActivityLog(), 100);
                }
            }
        }

        function setupFileUploads() {
            setupFileUpload('basic');
            setupFileUpload('advanced');
            setupFileUpload('twoMonths');
        }

        function setupFileUpload(type) {
            const uploadDiv = document.getElementById(type + 'FileUpload');
            const fileInput = document.getElementById(type + 'FileInput');
            
            uploadDiv.addEventListener('click', () => fileInput.click());
            
            uploadDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadDiv.classList.add('dragover');
            });
            
            uploadDiv.addEventListener('dragleave', () => {
                uploadDiv.classList.remove('dragover');
            });
            
            uploadDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadDiv.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0], type);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0], type);
                }
            });
        }

        function handleFileSelect(file, type) {
            const fileName = document.getElementById(type + 'FileName');
            fileName.textContent = `تم اختيار الملف: ${file.name}`;
            fileName.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        Papa.parse(e.target.result, {
                            header: false,
                            skipEmptyLines: true,
                            complete: function(results) {
                                const processedData = convertArrayToObjects(results.data);
                                if (type === 'basic') {
                                    basicData = processedData;
                                    saveDataToStorage('basicData', basicData);
                                } else if (type === 'advanced') {
                                    advancedData = processedData;
                                    saveDataToStorage('advancedData', advancedData);
                                } else {
                                    twoMonthsData = processedData;
                                    saveDataToStorage('twoMonthsData', twoMonthsData);
                                }
                                showSuccessMessage(`تم تحميل ملف CSV بنجاح - ${results.data.length} صف`);
                            }
                        });
                    } else if (file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                            header: 1,
                            defval: "",
                            raw: false
                        });
                        
                        const processedData = convertArrayToObjects(jsonData);
                        
                        if (type === 'basic') {
                            basicData = processedData;
                            saveDataToStorage('basicData', basicData);
                        } else if (type === 'advanced') {
                            advancedData = processedData;
                            saveDataToStorage('advancedData', advancedData);
                        } else {
                            twoMonthsData = processedData;
                            saveDataToStorage('twoMonthsData', twoMonthsData);
                        }
                        
                        showSuccessMessage(`تم تحميل ملف Excel بنجاح - ${jsonData.length} صف`);
                    } else {
                        alert('نوع الملف غير مدعوم. يرجى اختيار ملف Excel (.xlsx, .xls) أو CSV');
                    }
                } catch (error) {
                    alert('خطأ في قراءة الملف: ' + error.message);
                    console.error('File reading error:', error);
                }
            };
            
            if (file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        function convertArrayToObjects(arrayData) {
            if (!arrayData || arrayData.length === 0) return [];
            
            const headers = arrayData[0];
            const result = [];
            
            for (let i = 1; i < arrayData.length; i++) {
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    obj[`Column${String.fromCharCode(65 + j)}`] = arrayData[i][j] || '';
                    obj[j] = arrayData[i][j] || '';
                }
                result.push(obj);
            }
            
            return result;
        }

        // وظائف حفظ واستعادة البيانات
        function saveDataToStorage(key, data) {
            try {
                // حفظ البيانات في localStorage مع ضغط إذا كانت كبيرة
                const dataString = JSON.stringify(data);
                if (dataString.length > 5000000) { // 5MB limit
                    console.warn(`Data too large for ${key}, skipping save`);
                    return;
                }
                localStorage.setItem(key, dataString);
            } catch (error) {
                console.error(`Error saving ${key} to storage:`, error);
                // إذا فشل الحفظ بسبب حجم البيانات، احذف المفاتيح القديمة
                try {
                    localStorage.removeItem(key);
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error(`Failed to save ${key}:`, e);
                }
            }
        }

        function loadDataFromStorage(key, defaultValue = null) {
            try {
                const saved = localStorage.getItem(key);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (error) {
                console.error(`Error loading ${key} from storage:`, error);
            }
            return defaultValue;
        }

        // استعادة جميع البيانات المحفوظة
        function restoreSavedData() {
            try {
                // استعادة البيانات الخام
                const savedBasicData = loadDataFromStorage('basicData');
                if (savedBasicData && savedBasicData.length > 0) {
                    basicData = savedBasicData;
                    document.getElementById('basicFileName').textContent = 'تم استعادة البيانات المحفوظة';
                    document.getElementById('basicFileName').classList.remove('hidden');
                }

                const savedAdvancedData = loadDataFromStorage('advancedData');
                if (savedAdvancedData && savedAdvancedData.length > 0) {
                    advancedData = savedAdvancedData;
                    document.getElementById('advancedFileName').textContent = 'تم استعادة البيانات المحفوظة';
                    document.getElementById('advancedFileName').classList.remove('hidden');
                }

                const savedTwoMonthsData = loadDataFromStorage('twoMonthsData');
                if (savedTwoMonthsData && savedTwoMonthsData.length > 0) {
                    twoMonthsData = savedTwoMonthsData;
                    document.getElementById('twoMonthsFileName').textContent = 'تم استعادة البيانات المحفوظة';
                    document.getElementById('twoMonthsFileName').classList.remove('hidden');
                }

                // استعادة التفاصيل
                const savedBasicDetails = loadDataFromStorage('basicDetails', []);
                if (savedBasicDetails.length > 0) {
                    basicDetails = savedBasicDetails;
                }

                const savedAdvancedDetails = loadDataFromStorage('advancedDetails', []);
                if (savedAdvancedDetails.length > 0) {
                    advancedDetails = savedAdvancedDetails;
                }

                const savedTwoMonthsDetails = loadDataFromStorage('twoMonthsDetails', []);
                if (savedTwoMonthsDetails.length > 0) {
                    twoMonthsDetails = savedTwoMonthsDetails;
                }

                // استعادة نتائج التحليل
                const savedBasicResults = loadDataFromStorage('basicResults');
                if (savedBasicResults && savedBasicResults.total && savedBasicResults.total.count > 0) {
                    displayBasicResults(savedBasicResults);
                }

                const savedAdvancedResults = loadDataFromStorage('advancedResults');
                if (savedAdvancedResults && savedAdvancedResults.total && savedAdvancedResults.total.count > 0) {
                    displayAdvancedResults(savedAdvancedResults);
                }

                const savedTwoMonthsResults = loadDataFromStorage('twoMonthsResults');
                if (savedTwoMonthsResults && savedTwoMonthsResults.total && savedTwoMonthsResults.total.count > 0) {
                    displayTwoMonthsResults(savedTwoMonthsResults);
                }

                // استعادة تقارير الوكلاء
                const savedAgentReports = loadDataFromStorage('agentReports', {});
                if (savedAgentReports && Object.keys(savedAgentReports).length > 0) {
                    agentReports = savedAgentReports;
                }

                console.log('تم استعادة جميع البيانات المحفوظة بنجاح');
            } catch (error) {
                console.error('خطأ في استعادة البيانات المحفوظة:', error);
            }
        }

        function showSuccessMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.right = '20px';
            messageDiv.style.zIndex = '9999';
            messageDiv.style.maxWidth = '300px';
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        }

        function analyzeBasicData() {
            if (!basicData) {
                alert('يرجى اختيار ملف البيانات أولاً');
                return;
            }

            basicDetails = [];

            showLoading('basic');
            
            setTimeout(() => {
                try {
                    const results = processBasicData(basicData);
                    
                    if (results.total.count === 0) {
                        alert('لم يتم العثور على بيانات صالحة للتحليل. تأكد من صحة تنسيق الملف.');
                        hideLoading('basic');
                        return;
                    }
                    
                    displayBasicResults(results);
                    hideLoading('basic');
                    showSuccessMessage(`تم تحليل ${results.total.count} اشتراك مجاني بنجاح`);
                } catch (error) {
                    alert('خطأ في تحليل بيانات العرض المجاني: ' + error.message);
                    hideLoading('basic');
                }
            }, 1000);
        }

        function processBasicData(data) {
            const results = {
                bronze: { count: 0, amount: 0 },
                silver: { count: 0, amount: 0 },
                gold: { count: 0, amount: 0 },
                platinum: { count: 0, amount: 0 },
                total: { count: 0, amount: 0 },
                agentName: ''
            };

            if (data.length === 0) return results;

            results.agentName = data[0]['ColumnF'] || data[0][5] || 'غير محدد';

            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const count = row['ColumnP'] || row[15];
                const agent = row['ColumnF'] || row[5] || '';

                if (!createdAt || !username || !subscription || count != 1) continue;

                const subType = String(subscription).trim();
                const agentName = String(agent).trim();
                const category = getSubscriptionCategory(subType, agentName);
                
                if (!category) continue;
                
                const price = getSubscriptionPrice(subType, category, 'basic');

                if (price > 0) {
                    basicDetails.push({
                        username: String(username).trim(),
                        subscription: subType,
                        agent: agentName,
                        date: createdAt,
                        price: price,
                        type: 'مجاني'
                    });

                    switch(category) {
                        case 'B':
                        results.bronze.count++;
                        results.bronze.amount += price;
                            break;
                        case 'S':
                        results.silver.count++;
                        results.silver.amount += price;
                            break;
                        case 'G':
                        results.gold.count++;
                        results.gold.amount += price;
                            break;
                        case 'P':
                        results.platinum.count++;
                        results.platinum.amount += price;
                            break;
                    }
                }
            }

            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.amount = results.bronze.amount + results.silver.amount + results.gold.amount + results.platinum.amount;

            return results;
        }

        function displayBasicResults(results) {
            ensureAgentExists(results.agentName);
            
            if (!agentReports[results.agentName]) {
                agentReports[results.agentName] = {};
            }
            agentReports[results.agentName].basic = results;
            
            // حفظ البيانات في localStorage
            saveDataToStorage('agentReports', agentReports);
            saveDataToStorage('basicDetails', basicDetails);
            saveDataToStorage('basicResults', results);

            const agentInfo = document.getElementById('basicAgentInfo');
            agentInfo.innerHTML = `
                <h3> العرض المجاني</h3>
                <p><strong>اسم الوكيل:</strong> ${results.agentName}</p>
                <p><strong>تاريخ التحليل:</strong> ${formatArabicDate(new Date())}</p>
                <p><strong>نوع التحليل:</strong> حساب العرض المجاني</p>
            `;

            const resultsGrid = document.getElementById('basicResultsGrid');
            resultsGrid.innerHTML = `
                <div class="result-card bronze">
                    <h3> Bronze</h3>
                    <div class="count">${results.bronze.count}</div>
                    <div class="amount">${formatNumber(results.bronze.amount)} د.ع</div>
                </div>
                <div class="result-card silver">
                    <h3> Silver</h3>
                    <div class="count">${results.silver.count}</div>
                    <div class="amount">${formatNumber(results.silver.amount)} د.ع</div>
                </div>
                <div class="result-card gold">
                    <h3> Gold</h3>
                    <div class="count">${results.gold.count}</div>
                    <div class="amount">${formatNumber(results.gold.amount)} د.ع</div>
                </div>
                <div class="result-card platinum">
                    <h3> Platinum</h3>
                    <div class="count">${results.platinum.count}</div>
                    <div class="amount">${formatNumber(results.platinum.amount)} د.ع</div>
                </div>
                <div class="result-card">
                    <h3> المجموع</h3>
                    <div class="count">${results.total.count}</div>
                    <div class="amount">${formatNumber(results.total.amount)} د.ع</div>
                </div>
            `;

            document.getElementById('basicResults').classList.remove('hidden');
            
            updateAgentSummary();
            logActivity('تحليل البيانات - العرض المجاني', `تم تحليل ${results.total.count} اشتراك مجاني للوكيل ${results.agentName}`);
        }

        function analyzeAdvancedData() {
            if (!advancedData) {
                alert('يرجى اختيار ملف البيانات أولاً');
                return;
            }

            advancedDetails = [];

            showLoading('advanced');
            
            setTimeout(() => {
                try {
                    const results = processAdvancedData(advancedData);
                    
                    if (results.total.count === 0) {
                        alert('لم يتم العثور على تفعيلات صالحة للعرض المخفض. تأكد من وجود 3 اشتراكات خلال 5 أيام لنفس المستخدم.');
                        hideLoading('advanced');
                        return;
                    }
                    
                    displayAdvancedResults(results);
                    hideLoading('advanced');
                    showSuccessMessage(`تم تحليل ${results.total.count} تفعيل للعرض المخفض بنجاح`);
                } catch (error) {
                    alert('خطأ في تحليل بيانات العرض المخفض: ' + error.message);
                    hideLoading('advanced');
                }
            }, 1500);
        }

        function processAdvancedData(data) {
            const results = {
                bronze: { count: 0, promoAmount: 0, officialAmount: 0 },
                silver: { count: 0, promoAmount: 0, officialAmount: 0 },
                gold: { count: 0, promoAmount: 0, officialAmount: 0 },
                platinum: { count: 0, promoAmount: 0, officialAmount: 0 },
                total: { count: 0, promoAmount: 0, officialAmount: 0, profit: 0 },
                agentName: ''
            };

            if (data.length === 0) return results;

            results.agentName = data[0]['ColumnF'] || data[0][5] || 'غير محدد';

            const userSubscriptions = {};
            const subscriptionDetails = {};

            data.forEach(row => {
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const agent = row['ColumnF'] || row[5] || '';

                if (!createdAt || !username || !subscription) return;

                let dateObj;
                try {
                    if (createdAt instanceof Date) {
                        dateObj = createdAt;
                    } else {
                        if (typeof createdAt === 'number' && createdAt > 40000) {
                            dateObj = new Date((createdAt - 25569) * 86400 * 1000);
                        } else {
                            dateObj = new Date(createdAt);
                        }
                    }
                    
                    if (isNaN(dateObj.getTime())) {
                        return;
                    }
                } catch (e) {
                    return;
                }

                const key = `${String(username).trim()}|${String(subscription).trim()}`;
                if (!userSubscriptions[key]) {
                    userSubscriptions[key] = [];
                    subscriptionDetails[key] = [];
                }
                userSubscriptions[key].push(dateObj);
                subscriptionDetails[key].push({
                    date: dateObj,
                    dateStr: createdAt,
                    username: String(username).trim(),
                    subscription: String(subscription).trim(),
                    agent: String(agent).trim()
                });
            });

            Object.keys(userSubscriptions).forEach(key => {
                const [username, subscription] = key.split('|');
                const dates = userSubscriptions[key].sort((a, b) => a - b);
                const details = subscriptionDetails[key];
                
                let activations = 0;
                const used = new Array(dates.length).fill(false);
                const activationDetails = [];

                let found = true;
                while (found) {
                    found = false;
                for (let i = 0; i < dates.length - 2; i++) {
                    if (used[i]) continue;
                    
                    for (let j = i + 1; j < dates.length - 1; j++) {
                        if (used[j]) continue;
                        
                        for (let k = j + 1; k < dates.length; k++) {
                            if (used[k]) continue;
                            
                            const daysDiff = (dates[k] - dates[i]) / (1000 * 60 * 60 * 24);
                            if (daysDiff <= 5) {
                                used[i] = used[j] = used[k] = true;
                                activations++;
                                    
                                    activationDetails.push({
                                        username: details[i].username,
                                        subscription: details[i].subscription,
                                        agent: details[i].agent,
                                        date1: details[i].dateStr,
                                        date2: details[j].dateStr,
                                        date3: details[k].dateStr,
                                        daysDiff: Math.round(daysDiff * 100) / 100,
                                        type: 'ثلاث أشهر'
                                    });
                                    
                                    found = true;
                                break;
                            }
                        }
                            if (found) break;
                        }
                        if (found) break;
                    }
                }
                
                advancedDetails.push(...activationDetails);

                if (activations > 0) {
                    const subType = subscription.trim();
                    const agentName = details[0]?.agent || '';
                    const category = getSubscriptionCategory(subType, agentName);
                    
                    if (category) {
                        const promoPrice = getSubscriptionPrice(subType, category, 'advanced', 'promo');
                        const officialPrice = getSubscriptionPrice(subType, category, 'advanced', 'official');

                        switch(category) {
                            case 'B':
                        results.bronze.count += activations;
                        results.bronze.promoAmount += activations * promoPrice;
                        results.bronze.officialAmount += activations * officialPrice;
                                break;
                            case 'S':
                        results.silver.count += activations;
                        results.silver.promoAmount += activations * promoPrice;
                        results.silver.officialAmount += activations * officialPrice;
                                break;
                            case 'G':
                        results.gold.count += activations;
                        results.gold.promoAmount += activations * promoPrice;
                        results.gold.officialAmount += activations * officialPrice;
                                break;
                            case 'P':
                        results.platinum.count += activations;
                        results.platinum.promoAmount += activations * promoPrice;
                        results.platinum.officialAmount += activations * officialPrice;
                                break;
                        }
                    }
                }
            });

            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.promoAmount = results.bronze.promoAmount + results.silver.promoAmount + results.gold.promoAmount + results.platinum.promoAmount;
            results.total.officialAmount = results.bronze.officialAmount + results.silver.officialAmount + results.gold.officialAmount + results.platinum.officialAmount;
            results.total.profit = results.total.officialAmount - results.total.promoAmount;

            return results;
        }

        function displayAdvancedResults(results) {
            ensureAgentExists(results.agentName);
            
            if (!agentReports[results.agentName]) {
                agentReports[results.agentName] = {};
            }
            agentReports[results.agentName].advanced = results;
            
            // حفظ البيانات في localStorage
            saveDataToStorage('agentReports', agentReports);
            saveDataToStorage('advancedDetails', advancedDetails);
            saveDataToStorage('advancedResults', results);

            const agentInfo = document.getElementById('advancedAgentInfo');
            agentInfo.innerHTML = `
                <h3>العرض المخفض لثلاث أشهر</h3>
                <p><strong>اسم الوكيل:</strong> ${results.agentName}</p>
                <p><strong>تاريخ التحليل:</strong> ${formatArabicDate(new Date())}</p>
                <p><strong>نوع التحليل:</strong> حساب العرض المخفض لثلاث أشهر</p>
                <p><strong>إجمالي الراجع للوكيل :</strong> ${formatNumber(results.total.profit)} د.ع</p>
            `;

            const resultsGrid = document.getElementById('advancedResultsGrid');
            resultsGrid.innerHTML = `
                <div class="result-card bronze">
                    <h3> Bronze</h3>
                    <div class="count">${results.bronze.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.bronze.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.bronze.officialAmount)} د.ع</div>
                </div>
                <div class="result-card silver">
                    <h3> Silver</h3>
                    <div class="count">${results.silver.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.silver.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.silver.officialAmount)} د.ع</div>
                </div>
                <div class="result-card gold">
                    <h3> Gold</h3>
                    <div class="count">${results.gold.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.gold.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.gold.officialAmount)} د.ع</div>
                </div>
                <div class="result-card platinum">
                    <h3> Platinum</h3>
                    <div class="count">${results.platinum.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.platinum.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.platinum.officialAmount)} د.ع</div>
                </div>
                <div class="result-card">
                    <h3> المجموع</h3>
                    <div class="count">${results.total.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.total.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.total.officialAmount)} د.ع</div>
                </div>
            `;

            document.getElementById('advancedResults').classList.remove('hidden');
            
            updateAgentSummary();
            logActivity('تحليل البيانات - 3 أشهر', `تم تحليل ${results.total.count} تفعيل للعرض المخفض 3 أشهر للوكيل ${results.agentName}`);
        }

        function analyzeTwoMonthsData() {
            if (!twoMonthsData) {
                alert('يرجى اختيار ملف البيانات أولاً');
                return;
            }

            twoMonthsDetails = [];

            showLoading('twoMonths');
            
            setTimeout(() => {
                try {
                    const results = processTwoMonthsData(twoMonthsData);
                    
                    if (results.total.count === 0) {
                        alert('لم يتم العثور على تفعيلات صالحة للعرض المخفض لشهرين. تأكد من وجود 2 اشتراكات خلال 5 أيام لنفس المستخدم.');
                        hideLoading('twoMonths');
                        return;
                    }
                    
                    displayTwoMonthsResults(results);
                    hideLoading('twoMonths');
                    showSuccessMessage(`تم تحليل ${results.total.count} تفعيل للعرض المخفض لشهرين بنجاح`);
                } catch (error) {
                    alert('خطأ في تحليل بيانات العرض المخفض لشهرين: ' + error.message);
                    hideLoading('twoMonths');
                }
            }, 1500);
        }

        function processTwoMonthsData(data) {
            const results = {
                bronze: { count: 0, promoAmount: 0, officialAmount: 0 },
                silver: { count: 0, promoAmount: 0, officialAmount: 0 },
                gold: { count: 0, promoAmount: 0, officialAmount: 0 },
                platinum: { count: 0, promoAmount: 0, officialAmount: 0 },
                total: { count: 0, promoAmount: 0, officialAmount: 0, profit: 0 },
                agentName: '',
                dateFrom: null,
                dateTo: null
            };

            if (data.length === 0) return results;

            results.agentName = data[0]['ColumnF'] || data[0][5] || 'غير محدد';

            const userSubscriptions = {};
            const subscriptionDetails = {};

            data.forEach(row => {
                const id = row['ColumnA'] || row[0];
                const createdAt = row['ColumnB'] || row[1];
                const username = row['ColumnC'] || row[2];
                const subscription = row['ColumnI'] || row[8];
                const agent = row['ColumnF'] || row[5] || '';

                if (!createdAt || !username || !subscription) return;

                let dateObj;
                try {
                    if (createdAt instanceof Date) {
                        dateObj = createdAt;
                    } else {
                        if (typeof createdAt === 'number' && createdAt > 40000) {
                            dateObj = new Date((createdAt - 25569) * 86400 * 1000);
                        } else {
                            dateObj = new Date(createdAt);
                        }
                    }
                    
                    if (isNaN(dateObj.getTime())) {
                        return;
                    }
                } catch (e) {
                    return;
                }

                const key = `${String(username).trim()}|${String(subscription).trim()}`;
                if (!userSubscriptions[key]) {
                    userSubscriptions[key] = [];
                    subscriptionDetails[key] = [];
                }
                userSubscriptions[key].push(dateObj);
                subscriptionDetails[key].push({
                    date: dateObj,
                    dateStr: createdAt,
                    username: String(username).trim(),
                    subscription: String(subscription).trim(),
                    agent: String(agent).trim()
                });
            });

            Object.keys(userSubscriptions).forEach(key => {
                const [username, subscription] = key.split('|');
                let dates = userSubscriptions[key].sort((a, b) => a - b);
                const details = subscriptionDetails[key].sort((a, b) => a.date - b.date);
                
                const usedForThreeMonths = new Array(dates.length).fill(false);
                
                for (let i = 0; i < dates.length - 2; i++) {
                    if (usedForThreeMonths[i]) continue;
                    
                    for (let j = i + 1; j < dates.length - 1; j++) {
                        if (usedForThreeMonths[j]) continue;
                        
                        for (let k = j + 1; k < dates.length; k++) {
                            if (usedForThreeMonths[k]) continue;
                            
                            const daysDiff = (dates[k] - dates[i]) / (1000 * 60 * 60 * 24);
                            if (daysDiff >= 0 && daysDiff <= 5) {
                                usedForThreeMonths[i] = true;
                                usedForThreeMonths[j] = true;
                                usedForThreeMonths[k] = true;
                                break;
                            }
                        }
                    }
                }
                
                const remainingDates = dates.filter((date, index) => !usedForThreeMonths[index]);
                const remainingDetails = details.filter((detail, index) => !usedForThreeMonths[index]);
                
                let activations = 0;
                const used = new Array(remainingDates.length).fill(false);
                const activationDetails = [];

                for (let i = 0; i < remainingDates.length - 1; i++) {
                    if (used[i]) continue;
                    
                    for (let j = i + 1; j < remainingDates.length; j++) {
                        if (used[j]) continue;
                        
                        const daysDiff = (remainingDates[j] - remainingDates[i]) / (1000 * 60 * 60 * 24);
                        if (daysDiff >= 0 && daysDiff <= 5) {
                            used[i] = true;
                            used[j] = true;
                            activations++;
                            
                            activationDetails.push({
                                username: remainingDetails[i].username,
                                subscription: remainingDetails[i].subscription,
                                agent: remainingDetails[i].agent,
                                date1: remainingDetails[i].dateStr,
                                date2: remainingDetails[j].dateStr,
                                daysDiff: Math.round(daysDiff * 100) / 100,
                                type: 'شهرين'
                            });
                            break;
                        }
                    }
                }
                
                twoMonthsDetails.push(...activationDetails);

                if (activations > 0) {
                    const subType = subscription.trim();
                    const agentName = remainingDetails[0]?.agent || '';
                    const category = getSubscriptionCategory(subType, agentName);
                    
                    if (category) {
                        const promoPrice = getSubscriptionPrice(subType, category, 'twoMonths');
                        const monthlyOfficialPrice = getSubscriptionPrice(subType, category, 'basic');
                    const officialPrice = monthlyOfficialPrice * 2;

                        switch(category) {
                            case 'B':
                        results.bronze.count += activations;
                        results.bronze.promoAmount += activations * promoPrice;
                        results.bronze.officialAmount += activations * officialPrice;
                                break;
                            case 'S':
                        results.silver.count += activations;
                        results.silver.promoAmount += activations * promoPrice;
                        results.silver.officialAmount += activations * officialPrice;
                                break;
                            case 'G':
                        results.gold.count += activations;
                        results.gold.promoAmount += activations * promoPrice;
                        results.gold.officialAmount += activations * officialPrice;
                                break;
                            case 'P':
                        results.platinum.count += activations;
                        results.platinum.promoAmount += activations * promoPrice;
                        results.platinum.officialAmount += activations * officialPrice;
                                break;
                        }
                    }
                }
            });

            results.total.count = results.bronze.count + results.silver.count + results.gold.count + results.platinum.count;
            results.total.promoAmount = results.bronze.promoAmount + results.silver.promoAmount + results.gold.promoAmount + results.platinum.promoAmount;
            results.total.officialAmount = results.bronze.officialAmount + results.silver.officialAmount + results.gold.officialAmount + results.platinum.officialAmount;
            results.total.profit = results.total.officialAmount - results.total.promoAmount;

            return results;
        }

        function displayTwoMonthsResults(results) {
            ensureAgentExists(results.agentName);
            
            if (!agentReports[results.agentName]) {
                agentReports[results.agentName] = {};
            }
            agentReports[results.agentName].twoMonths = results;
            
            // حفظ البيانات في localStorage
            saveDataToStorage('agentReports', agentReports);
            saveDataToStorage('twoMonthsDetails', twoMonthsDetails);
            saveDataToStorage('twoMonthsResults', results);

            const agentInfo = document.getElementById('twoMonthsAgentInfo');
            agentInfo.innerHTML = `
                <h3>العرض المخفض لشهرين</h3>
                <p><strong>اسم الوكيل:</strong> ${results.agentName}</p>
                <p><strong>تاريخ التحليل:</strong> ${formatArabicDate(new Date())}</p>
                <p><strong>نوع التحليل:</strong> حساب العرض المخفض لشهرين</p>
                <p><strong>إجمالي الراجع للوكيل :</strong> ${formatNumber(results.total.profit)} د.ع</p>
            `;

            const resultsGrid = document.getElementById('twoMonthsResultsGrid');
            resultsGrid.innerHTML = `
                <div class="result-card bronze">
                    <h3> Bronze</h3>
                    <div class="count">${results.bronze.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.bronze.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.bronze.officialAmount)} د.ع</div>
                    <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">راجع: ${formatNumber(results.bronze.officialAmount - results.bronze.promoAmount)} د.ع</div>
                </div>
                <div class="result-card silver">
                    <h3> Silver</h3>
                    <div class="count">${results.silver.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.silver.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.silver.officialAmount)} د.ع</div>
                    <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">راجع: ${formatNumber(results.silver.officialAmount - results.silver.promoAmount)} د.ع</div>
                </div>
                <div class="result-card gold">
                    <h3> Gold</h3>
                    <div class="count">${results.gold.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.gold.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.gold.officialAmount)} د.ع</div>
                    <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">راجع: ${formatNumber(results.gold.officialAmount - results.gold.promoAmount)} د.ع</div>
                </div>
                <div class="result-card platinum">
                    <h3> Platinum</h3>
                    <div class="count">${results.platinum.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.platinum.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.platinum.officialAmount)} د.ع</div>
                    <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px;">راجع: ${formatNumber(results.platinum.officialAmount - results.platinum.promoAmount)} د.ع</div>
                </div>
                <div class="result-card">
                    <h3> المجموع</h3>
                    <div class="count">${results.total.count}</div>
                    <div class="amount">عرض: ${formatNumber(results.total.promoAmount)} د.ع</div>
                    <div class="amount">رسمي: ${formatNumber(results.total.officialAmount)} د.ع</div>
                    <div class="amount" style="color: #28a745; font-weight: 700; margin-top: 5px; font-size: 1.2rem;">راجع الكلي: ${formatNumber(results.total.profit)} د.ع</div>
                </div>
            `;

            document.getElementById('twoMonthsResults').classList.remove('hidden');
            
            updateAgentSummary();
            logActivity('تحليل البيانات - شهرين', `تم تحليل ${results.total.count} تفعيل للعرض المخفض شهرين للوكيل ${results.agentName}`);
        }

        function showLoading(type) {
            document.getElementById(type + 'Loading').style.display = 'block';
        }

        function hideLoading(type) {
            document.getElementById(type + 'Loading').style.display = 'none';
        }

        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US').format(Math.floor(num));
        }

        function resetBasicResults() {
            document.getElementById('basicResults').classList.add('hidden');
            document.getElementById('basicFileName').classList.add('hidden');
            document.getElementById('basicFileInput').value = '';
            basicData = null;
            basicDetails = [];
            // حذف البيانات المحفوظة
            localStorage.removeItem('basicData');
            localStorage.removeItem('basicDetails');
            localStorage.removeItem('basicResults');
        }

        function resetAdvancedResults() {
            document.getElementById('advancedResults').classList.add('hidden');
            document.getElementById('advancedFileName').classList.add('hidden');
            document.getElementById('advancedFileInput').value = '';
            advancedData = null;
            advancedDetails = [];
            // حذف البيانات المحفوظة
            localStorage.removeItem('advancedData');
            localStorage.removeItem('advancedDetails');
            localStorage.removeItem('advancedResults');
        }

        function resetTwoMonthsResults() {
            document.getElementById('twoMonthsResults').classList.add('hidden');
            document.getElementById('twoMonthsFileName').classList.add('hidden');
            document.getElementById('twoMonthsFileInput').value = '';
            twoMonthsData = null;
            twoMonthsDetails = [];
            // حذف البيانات المحفوظة
            localStorage.removeItem('twoMonthsData');
            localStorage.removeItem('twoMonthsDetails');
            localStorage.removeItem('twoMonthsResults');
        }

        function saveBasicReport() {
            if (!basicData || document.getElementById('basicResults').classList.contains('hidden')) {
                alert('لا توجد نتائج لحفظها. يرجى تحليل البيانات أولاً.');
                return;
            }
            
            const results = processBasicData(basicData);
            const csvContent = generateBasicReportCSV(results);
            downloadCSV(csvContent, `تقرير_أساسي_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            
            
if (!agentReports[results.agentName]) {
    agentReports[results.agentName] = { basic: null, advanced: null, twoMonths: null };
}
agentReports[results.agentName].basic = results;
updateAgentSummary();
alert('تم حفظ التقرير بنجاح!');

        }

        function saveAdvancedReport() {
            if (!advancedData || document.getElementById('advancedResults').classList.contains('hidden')) {
                alert('لا توجد نتائج لحفظها. يرجى تحليل البيانات أولاً.');
                return;
            }
            
            const results = processAdvancedData(advancedData);
            const csvContent = generateAdvancedReportCSV(results);
            downloadCSV(csvContent, `تقرير_تفعيلات_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            
            
if (!agentReports[results.agentName]) {
    agentReports[results.agentName] = { basic: null, advanced: null, twoMonths: null };
}
agentReports[results.agentName].advanced = results;
updateAgentSummary();
alert('تم حفظ تقرير التفعيلات بنجاح!');

        }

        function saveTwoMonthsReport() {
            if (!twoMonthsData || document.getElementById('twoMonthsResults').classList.contains('hidden')) {
                alert('لا توجد نتائج لحفظها. يرجى تحليل البيانات أولاً.');
                return;
            }
            
            const results = processTwoMonthsData(twoMonthsData);
            const csvContent = generateTwoMonthsReportCSV(results);
            downloadCSV(csvContent, `تقرير_شهرين_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            
            if (!agentReports[results.agentName]) {
                agentReports[results.agentName] = { basic: null, advanced: null, twoMonths: null };
            }
            agentReports[results.agentName].twoMonths = results;
            updateAgentSummary();
            alert('تم حفظ تقرير العرض المخفض لشهرين بنجاح!');
        }

        function generateBasicReportCSV(results) {
            const header = 'نوع الاشتراك,العدد,المبلغ (د.ع)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.amount}`,
                `Silver,${results.silver.count},${results.silver.amount}`,
                `Gold,${results.gold.count},${results.gold.amount}`,
                `Platinum,${results.platinum.count},${results.platinum.amount}`,
                `المجموع,${results.total.count},${results.total.amount}`
            ].join('\n');
            
            return header + rows;
        }

        function generateAdvancedReportCSV(results) {
            const header = 'نوع الاشتراك,عدد التفعيلات,مبلغ العرض (د.ع),المبلغ الرسمي (د.ع),الربح (د.ع)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.promoAmount},${results.bronze.officialAmount},${results.bronze.officialAmount - results.bronze.promoAmount}`,
                `Silver,${results.silver.count},${results.silver.promoAmount},${results.silver.officialAmount},${results.silver.officialAmount - results.silver.promoAmount}`,
                `Gold,${results.gold.count},${results.gold.promoAmount},${results.gold.officialAmount},${results.gold.officialAmount - results.gold.promoAmount}`,
                `Platinum,${results.platinum.count},${results.platinum.promoAmount},${results.platinum.officialAmount},${results.platinum.officialAmount - results.platinum.promoAmount}`,
                `المجموع,${results.total.count},${results.total.promoAmount},${results.total.officialAmount},${results.total.profit}`
            ].join('\n');
            
            return header + rows;
        }

        function generateTwoMonthsReportCSV(results) {
            const header = 'نوع الاشتراك,عدد التفعيلات,مبلغ العرض (د.ع),المبلغ الرسمي (د.ع),الربح (د.ع)\n';
            const rows = [
                `Bronze,${results.bronze.count},${results.bronze.promoAmount},${results.bronze.officialAmount},${results.bronze.officialAmount - results.bronze.promoAmount}`,
                `Silver,${results.silver.count},${results.silver.promoAmount},${results.silver.officialAmount},${results.silver.officialAmount - results.silver.promoAmount}`,
                `Gold,${results.gold.count},${results.gold.promoAmount},${results.gold.officialAmount},${results.gold.officialAmount - results.gold.promoAmount}`,
                `Platinum,${results.platinum.count},${results.platinum.promoAmount},${results.platinum.officialAmount},${results.platinum.officialAmount - results.platinum.promoAmount}`,
                `المجموع,${results.total.count},${results.total.promoAmount},${results.total.officialAmount},${results.total.profit}`
            ].join('\n');
            
            return header + rows;
        }

        function downloadCSV(content, filename) {
            const blob = new Blob(['\ufeff' + content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function formatDateForFilename(date) {
            return date.toISOString().split('T')[0];
        }

        function formatNumberOld(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            
            const numStr = String(Math.floor(num));
            
            const arabicToEnglish = {
                '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
                '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9'
            };
            
            let result = '';
            for (let i = 0; i < numStr.length; i++) {
                const char = numStr[i];
                result += arabicToEnglish[char] || char;
            }
            
            return result.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function getReportInfo(agentName) {
            const reports = agentReports[agentName] || {};
            const agent = agentsList.find(a => a.name === agentName);
            
            const reportType = reports.twoMonths && (reports.twoMonths.total?.count > 0) ? 'twoMonths' : 
                              reports.advanced && (reports.advanced.total?.count > 0) ? 'advanced' : 
                              'basic';
            
            let reportData = {};
            let reportTitle = '';
            
            const today = new Date();
            const month = today.getMonth() + 1;
            const year = today.getFullYear();
            const monthName = arabicMonths[month - 1];
            const dateFrom = `1/${month}/${year}`;
            const dateTo = `${new Date(year, month, 0).getDate()}/${month}/${year}`;
            
            if (reportType === 'twoMonths') {
                reportData = reports.twoMonths || {};
                if (reportData.dateFrom && reportData.dateTo) {
                    dateFrom = reportData.dateFrom;
                    dateTo = reportData.dateTo;
                    const dateFromParts = dateFrom.split('/');
                    const dateToParts = dateTo.split('/');
                    const monthFrom = parseInt(dateFromParts[1]);
                    const yearFrom = parseInt(dateFromParts[2]);
                    const monthNameFrom = arabicMonths[monthFrom - 1];
                    reportTitle = `كشف تفعيلات الوكلاء عن العرض (شهرين) المخفض لشهر ${monthNameFrom} من ${dateFromParts[0]}-${monthFrom}-${yearFrom} الى ${dateToParts[0]}-${dateToParts[1]}-${dateToParts[2]}`;
                } else {
                    reportTitle = `كشف تفعيلات الوكلاء عن العرض (شهرين) المخفض لشهر ${monthName} من 1-${month}-${year} الى ${new Date(year, month, 0).getDate()}-${month}-${year}`;
                }
            } else if (reportType === 'advanced') {
                reportData = reports.advanced || {};
                reportTitle = `كشف تفعيلات الوكلاء عن العرض المخفض لثلاثة أشهر لشهر ${monthName} من 1-${month}-${year} الى ${new Date(year, month, 0).getDate()}-${month}-${year}`;
            } else {
                reportData = reports.basic || {};
                reportTitle = `كشف تفعيلات الوكلاء عن العرض المجاني لشهر ${monthName} من 1-${month}-${year} الى ${new Date(year, month, 0).getDate()}-${month}-${year}`;
            }
            
            return {
                reportType,
                reportData,
                reportTitle,
                agent,
                dateFrom,
                dateTo
            };
        }

        function calculateCategoryPricesAndCounts(reportData, reportType) {
            const categories = ['platinum', 'gold', 'silver', 'bronze'];
            const result = {};
            
            categories.forEach(category => {
                const count = reportData[category]?.count || 0;
                result[`${category}Count`] = count;
                
                if (reportType === 'twoMonths' || reportType === 'advanced') {
                    const officialAmount = reportData[category]?.officialAmount || 0;
                    const promoAmount = reportData[category]?.promoAmount || 0;
                    result[`${category}Price`] = count > 0 ? Math.round((officialAmount - promoAmount) / count) : 0;
                } else {
                    const amount = reportData[category]?.amount || 0;
                    result[`${category}Price`] = count > 0 ? Math.round(amount / count) : 0;
                }
            });
            
            result.totalSubs = result.platinumCount + result.goldCount + result.silverCount + result.bronzeCount;
            result.totalAmount = reportData.total?.profit || reportData.total?.amount || 0;
            
            return result;
        }

        function downloadFile(blob, filename) {
            const downloadUrl = URL.createObjectURL(blob);
            const downloadLink = document.createElement('a');
            downloadLink.href = downloadUrl;
            downloadLink.download = filename;
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            
            setTimeout(() => {
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(downloadUrl);
            }, 1000);
        }

        function getReportFilename(agentName, extension) {
            const safeName = agentName.replace(/[^a-zA-Z0-9_]/g, '_');
            return `تقرير_${safeName}_${formatDateForFilename(new Date())}.${extension}`;
        }

        function getFileBlobPromise(agentName, fileType) {
            switch(fileType) {
                case 'excel':
                    return generateExcelReportBlob(agentName);
                case 'word':
                    return generateWordReportBlob(agentName);
                default:
                    return generatePDFReportBlob(agentName);
            }
        }

        function getFileTypeInfo(fileType, agentName) {
            const typeMap = {
                'excel': { ext: 'xlsx', name: 'Excel' },
                'word': { ext: 'doc', name: 'Word' },
                'pdf': { ext: 'pdf', name: 'PDF' }
            };
            const info = typeMap[fileType] || typeMap['pdf'];
            return {
                extension: info.ext,
                typeName: info.name,
                filename: getReportFilename(agentName, info.ext)
            };
        }

        function formatPhoneForWhatsApp(phone) {
            let cleanPhone = phone.replace(/[^0-9]/g, '');
            if (cleanPhone.startsWith('0')) {
                cleanPhone = '964' + cleanPhone.substring(1);
            } else if (!cleanPhone.startsWith('964') && cleanPhone.length <= 10) {
                cleanPhone = '964' + cleanPhone;
            }
            return cleanPhone;
        }

        function printReport(resultId) {
            if (document.getElementById(resultId).classList.contains('hidden')) {
                alert('لا توجد نتائج للطباعة. يرجى تحليل البيانات أولاً.');
                return;
            }
            window.print();
        }

        function printBasicReport() {
            printReport('basicResults');
        }

        function printAdvancedReport() {
            printReport('advancedResults');
        }

        function printTwoMonthsReport() {
            printReport('twoMonthsResults');
        }

        function exportBasicData() {
            if (!basicData) {
                alert('لا توجد بيانات للتصدير. يرجى تحميل ملف البيانات أولاً.');
                return;
            }
            
            const filteredData = basicData.filter(row => {
                const count = row['ColumnP'] || row[15];
                return count == 1;
            });
            
            const csvContent = convertDataToCSV(filteredData);
            downloadCSV(csvContent, `البيانات_المفلترة_${formatDateForFilename(new Date())}.csv`);
            alert('تم تصدير البيانات الأساسية بنجاح!');
        }

        function exportAdvancedData() {
            if (!advancedData) {
                alert('لا توجد بيانات للتصدير. يرجى تحميل ملف البيانات أولاً.');
                return;
            }
            
            const results = processAdvancedData(advancedData);
            const csvContent = generateAdvancedReportCSV(results);
            downloadCSV(csvContent, `تقرير_وكيل_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            alert('تم تصدير بيانات الوكيل بنجاح!');
        }

        function exportTwoMonthsData() {
            if (!twoMonthsData) {
                alert('لا توجد بيانات للتصدير. يرجى تحميل ملف البيانات أولاً.');
                return;
            }
            
            const results = processTwoMonthsData(twoMonthsData);
            const csvContent = generateTwoMonthsReportCSV(results);
            downloadCSV(csvContent, `تقرير_شهرين_وكيل_${results.agentName}_${formatDateForFilename(new Date())}.csv`);
            alert('تم تصدير بيانات العرض المخفض لشهرين بنجاح!');
        }

        function exportTwoMonthsDetailsToExcel() {
            if (!twoMonthsDetails || twoMonthsDetails.length === 0) {
                alert('لا توجد تفاصيل للتصدير. يرجى تحليل البيانات أولاً.');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                
                const excelData = twoMonthsDetails.map((detail, index) => ({
                    'رقم': index + 1,
                    'اسم المستخدم': detail.username,
                    'نوع الاشتراك': detail.subscription,
                    'اسم الوكيل': detail.agent,
                    'تاريخ الاشتراك الأول': detail.date1,
                    'تاريخ الاشتراك الثاني': detail.date2,
                    'الفرق بالأيام': detail.daysDiff,
                    'نوع التفعيل': detail.type,
                    'السعر المخفض (د.ع)': subscriptionPrices.twoMonths.promo[detail.subscription] || 0,
                    'السعر الرسمي (د.ع)': (subscriptionPrices.basic[detail.subscription] || 0) * 2,
                    'الراجع للوكيل (د.ع)': ((subscriptionPrices.basic[detail.subscription] || 0) * 2) - (subscriptionPrices.twoMonths.promo[detail.subscription] || 0)
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 18 },
                    { wch: 18 },
                    { wch: 18 }
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'تفاصيل التفعيلات');

                const agentName = twoMonthsDetails.length > 0 ? twoMonthsDetails[0].agent : 'غير محدد';
                const filename = `تفاصيل_التفعيلات_شهرين_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showSuccessMessage(`تم تصدير ${twoMonthsDetails.length} تفعيل إلى ملف Excel بنجاح!`);
            } catch (error) {
                alert('حدث خطأ أثناء التصدير: ' + error.message);
                console.error('Export error:', error);
            }
        }

        function exportAdvancedDetailsToExcel() {
            if (!advancedDetails || advancedDetails.length === 0) {
                alert('لا توجد تفاصيل للتصدير. يرجى تحليل البيانات أولاً.');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                
                const excelData = advancedDetails.map((detail, index) => ({
                    'رقم': index + 1,
                    'اسم المستخدم': detail.username,
                    'نوع الاشتراك': detail.subscription,
                    'اسم الوكيل': detail.agent,
                    'تاريخ الاشتراك الأول': detail.date1,
                    'تاريخ الاشتراك الثاني': detail.date2,
                    'تاريخ الاشتراك الثالث': detail.date3,
                    'الفرق بالأيام': detail.daysDiff,
                    'نوع التفعيل': detail.type,
                    'السعر المخفض (د.ع)': subscriptionPrices.advanced.promo[detail.subscription] || 0,
                    'السعر الرسمي (د.ع)': subscriptionPrices.advanced.official[detail.subscription] || 0,
                    'الراجع للوكيل (د.ع)': (subscriptionPrices.advanced.official[detail.subscription] || 0) - (subscriptionPrices.advanced.promo[detail.subscription] || 0)
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 18 },
                    { wch: 18 },
                    { wch: 18 }
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'تفاصيل التفعيلات');

                const agentName = advancedDetails.length > 0 ? advancedDetails[0].agent : 'غير محدد';
                const filename = `تفاصيل_التفعيلات_ثلاث_أشهر_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showSuccessMessage(`تم تصدير ${advancedDetails.length} تفعيل إلى ملف Excel بنجاح!`);
            } catch (error) {
                alert('حدث خطأ أثناء التصدير: ' + error.message);
                console.error('Export error:', error);
            }
        }

        function exportBasicDetailsToExcel() {
            if (!basicDetails || basicDetails.length === 0) {
                alert('لا توجد تفاصيل للتصدير. يرجى تحليل البيانات أولاً.');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                
                const excelData = basicDetails.map((detail, index) => ({
                    'رقم': index + 1,
                    'اسم المستخدم': detail.username,
                    'نوع الاشتراك': detail.subscription,
                    'اسم الوكيل': detail.agent,
                    'تاريخ الاشتراك': detail.date,
                    'نوع العرض': detail.type,
                    'المبلغ (د.ع)': detail.price
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                
                ws['!cols'] = [
                    { wch: 8 },
                    { wch: 25 },
                    { wch: 30 },
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 15 }
                ];

                XLSX.utils.book_append_sheet(wb, ws, 'تفاصيل الاشتراكات');

                const agentName = basicDetails.length > 0 ? basicDetails[0].agent : 'غير محدد';
                const filename = `تفاصيل_العرض_المجاني_${agentName}_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showSuccessMessage(`تم تصدير ${basicDetails.length} اشتراك إلى ملف Excel بنجاح!`);
            } catch (error) {
                alert('حدث خطأ أثناء التصدير: ' + error.message);
                console.error('Export error:', error);
            }
        }

        function convertDataToCSV(data) {
            if (!data || data.length === 0) return '';
      
            const headers = ['ID', 'التاريخ', 'اسم المستخدم', 'نوع الاشتراك', 'الوكيل'];
            let csv = headers.join(',') + '\n';
    
            data.forEach(row => {
                const rowData = [
                    row['ColumnA'] || row[0] || '',
                    row['ColumnB'] || row[1] || '',
                    row['ColumnC'] || row[2] || '',
                    row['ColumnI'] || row[8] || '',
                    row['ColumnF'] || row[5] || ''
                ];
                csv += rowData.map(field => `"${field}"`).join(',') + '\n';
            });
            
            return csv;
        }
    
function updateAgentSummary() {
            if (!agentReports || Object.keys(agentReports).length === 0) {
                document.getElementById('summaryContent').innerHTML = `
                    <p style="text-align: center; color: #999; padding: 40px;">
                        لا توجد بيانات للعرض. يرجى تحليل بيانات الوكلاء أولاً
                    </p>
                `;
                document.getElementById('summaryTotals').classList.add('hidden');
                return;
            }

            let totalBasicAll = 0;
            let totalAdvancedAll = 0;
            let totalTwoMonthsAll = 0;
            let totalAllAgents = 0;

            let summaryHTML = `<div class="results-grid">`;
            
            const sortedAgents = Object.entries(agentReports).sort((a, b) => {
                let totalA = 0;
                let totalB = 0;
                
                if (a[1].basic && a[1].basic.total.amount > 0) totalA += a[1].basic.total.amount;
                if (a[1].advanced && a[1].advanced.total.profit > 0) totalA += a[1].advanced.total.profit;
                if (a[1].twoMonths && a[1].twoMonths.total.profit > 0) totalA += a[1].twoMonths.total.profit;
                
                if (b[1].basic && b[1].basic.total.amount > 0) totalB += b[1].basic.total.amount;
                if (b[1].advanced && b[1].advanced.total.profit > 0) totalB += b[1].advanced.total.profit;
                if (b[1].twoMonths && b[1].twoMonths.total.profit > 0) totalB += b[1].twoMonths.total.profit;
                
                return totalB - totalA;
            });

            sortedAgents.forEach(([agentName, report]) => {
        let totalBasic = report.basic?.total.amount || 0;
        let totalAdvanced = report.advanced?.total.profit || 0;
        let totalTwoMonths = report.twoMonths?.total.profit || 0;
                
                let totalAll = 0;
                let offersCount = 0;
                
                if (report.basic && totalBasic > 0) {
                    totalAll += totalBasic;
                    offersCount++;
                }
                if (report.advanced && totalAdvanced > 0) {
                    totalAll += totalAdvanced;
                    offersCount++;
                }
                if (report.twoMonths && totalTwoMonths > 0) {
                    totalAll += totalTwoMonths;
                    offersCount++;
                }

                totalBasicAll += totalBasic;
                totalAdvancedAll += totalAdvanced;
                totalTwoMonthsAll += totalTwoMonths;
                totalAllAgents += totalAll;
                
                let agentOffersHTML = '';
                if (report.basic && totalBasic > 0) {
                    agentOffersHTML += `<div class="amount"> مجاني: ${formatNumber(totalBasic)} د.ع</div>`;
                }
                if (report.advanced && totalAdvanced > 0) {
                    agentOffersHTML += `<div class="amount"> مخفض 3 أشهر: ${formatNumber(totalAdvanced)} د.ع</div>`;
                }
                if (report.twoMonths && totalTwoMonths > 0) {
                    agentOffersHTML += `<div class="amount"> مخفض شهرين: ${formatNumber(totalTwoMonths)} د.ع</div>`;
                }

        summaryHTML += `
            <div class="result-card">
                <h3> ${agentName}</h3>
                        ${agentOffersHTML}
                        <div class="amount" style="font-weight: 800; font-size: 1rem; color: #667eea; margin-top: 10px; padding-top: 10px; border-top: 2px solid rgba(102, 126, 234, 0.3);">
 الإجمالي: ${formatNumber(totalAll)} د.ع
                        </div>
            </div>`;
    });
            summaryHTML += `</div>`;

            document.getElementById('summaryContent').innerHTML = summaryHTML;

            let totalsHTML = `
                <div class="result-card" style="border-top: 4px solid; border-image: linear-gradient(135deg, #667eea, #764ba2, #f093fb) 1;">
                    <h3> إجمالي العرض المجاني</h3>
                    <div class="count">${formatNumber(totalBasicAll)}</div>
                    <div class="amount">دينار عراقي</div>
                </div>
                <div class="result-card" style="border-top: 4px solid; border-image: linear-gradient(135deg, #667eea, #764ba2, #f093fb) 1;">
                    <h3> إجمالي العرض المخفض 3 أشهر</h3>
                    <div class="count">${formatNumber(totalAdvancedAll)}</div>
                    <div class="amount">دينار عراقي</div>
                </div>
                <div class="result-card" style="border-top: 4px solid; border-image: linear-gradient(135deg, #667eea, #764ba2, #f093fb) 1;">
                    <h3> إجمالي العرض المخفض شهرين</h3>
                    <div class="count">${formatNumber(totalTwoMonthsAll)}</div>
                    <div class="amount">دينار عراقي</div>
                </div>
                <div class="result-card" style="border-top: 4px solid; border-image: linear-gradient(135deg, #667eea, #764ba2, #f093fb) 1;">
                    <h3> الإجمالي الكلي</h3>
                    <div class="count" style="font-size: 2.5rem;">${formatNumber(totalAllAgents)}</div>
                    <div class="amount">دينار عراقي</div>
                </div>
            `;

            document.getElementById('summaryTotalsGrid').innerHTML = totalsHTML;
            document.getElementById('summaryTotals').classList.remove('hidden');
        }

        function refreshSummary() {
            updateAgentSummary();
            showSuccessMessage('تم تحديث الملخص بنجاح!');
        }

        function exportSummaryToExcel() {
            if (!agentReports || Object.keys(agentReports).length === 0) {
                alert('لا توجد بيانات للتصدير. يرجى تحليل بيانات الوكلاء أولاً.');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                const agentData = [];
                
                const sortedAgents = Object.entries(agentReports).sort((a, b) => {
                    let totalA = 0;
                    let totalB = 0;
                    
                    if (a[1].basic && a[1].basic.total.amount > 0) totalA += a[1].basic.total.amount;
                    if (a[1].advanced && a[1].advanced.total.profit > 0) totalA += a[1].advanced.total.profit;
                    if (a[1].twoMonths && a[1].twoMonths.total.profit > 0) totalA += a[1].twoMonths.total.profit;
                    
                    if (b[1].basic && b[1].basic.total.amount > 0) totalB += b[1].basic.total.amount;
                    if (b[1].advanced && b[1].advanced.total.profit > 0) totalB += b[1].advanced.total.profit;
                    if (b[1].twoMonths && b[1].twoMonths.total.profit > 0) totalB += b[1].twoMonths.total.profit;
                    
                    return totalB - totalA;
                });

                let totalBronze = 0, totalSilver = 0, totalGold = 0, totalPlatinum = 0;
                let totalActivations = 0, totalOfferAmount = 0, totalOfficialAmount = 0, totalReturned = 0;

                sortedAgents.forEach(([agentName, report]) => {
                    const now = new Date();
                    const dateTime = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
                    
                    let bronzeCount = 0, silverCount = 0, goldCount = 0, platinumCount = 0;
                    let totalCount = 0, offerAmount = 0, officialAmount = 0, returned = 0;
                    
                    
                    if (report.basic) {
                        bronzeCount += report.basic.bronze?.count || 0;
                        silverCount += report.basic.silver?.count || 0;
                        goldCount += report.basic.gold?.count || 0;
                        platinumCount += report.basic.platinum?.count || 0;
                        totalCount += report.basic.total?.count || 0;
                        offerAmount += report.basic.total?.amount || 0;
                        officialAmount += report.basic.total?.amount || 0;
                        returned += report.basic.total?.amount || 0;
                    }
                    
                    if (report.advanced) {
                        bronzeCount += report.advanced.bronze?.count || 0;
                        silverCount += report.advanced.silver?.count || 0;
                        goldCount += report.advanced.gold?.count || 0;
                        platinumCount += report.advanced.platinum?.count || 0;
                        totalCount += report.advanced.total?.count || 0;
                        offerAmount += report.advanced.total?.promoAmount || 0;
                        officialAmount += report.advanced.total?.officialAmount || 0;
                        returned += report.advanced.total?.profit || 0;
                    }
                    
                    if (report.twoMonths) {
                        bronzeCount += report.twoMonths.bronze?.count || 0;
                        silverCount += report.twoMonths.silver?.count || 0;
                        goldCount += report.twoMonths.gold?.count || 0;
                        platinumCount += report.twoMonths.platinum?.count || 0;
                        totalCount += report.twoMonths.total?.count || 0;
                        offerAmount += report.twoMonths.total?.promoAmount || 0;
                        officialAmount += report.twoMonths.total?.officialAmount || 0;
                        returned += report.twoMonths.total?.profit || 0;
                    }

                    totalBronze += bronzeCount;
                    totalSilver += silverCount;
                    totalGold += goldCount;
                    totalPlatinum += platinumCount;
                    totalActivations += totalCount;
                    totalOfferAmount += offerAmount;
                    totalOfficialAmount += officialAmount;
                    totalReturned += returned;

                    agentData.push({
                        'اسم الوكيل': agentName,
                        'التاريخ والوقت': dateTime,
                        'عدد - برونزي': bronzeCount,
                        'عدد - سلفر': silverCount,
                        'عدد - ذهبي': goldCount,
                        'عدد - بلاتينيوم': platinumCount,
                        'مجموع التفعيلات': totalCount,
                        'مجموع المبالغ (عرض)': offerAmount,
                        'المبلغ المستقطع (الرسمي)': officialAmount,
                        'راجع الوكيل': returned
                    });
                });

                const ws = XLSX.utils.json_to_sheet(agentData);
                
                ws['!cols'] = [
                     { wch: 18 },
                     { wch: 16 },
                     { wch: 11 },
                     { wch: 11 },
                     { wch: 11 },
                     { wch: 13 },
                     { wch: 14 },
                     { wch: 16 },
                     { wch: 18 },
                     { wch: 14 }
                ];
                
                const headerRange = XLSX.utils.decode_range(ws['!ref']);
                headerRange.e.c = headerRange.e.c || 9;
                
                const colNames = ['اسم الوكيل', 'التاريخ والوقت', 'عدد - برونزي', 'عدد - سلفر', 'عدد - ذهبي', 'عدد - بلاتينيوم', 'مجموع التفعيلات', 'مجموع المبالغ (عرض)', 'المبلغ المستقطع (الرسمي)', 'راجع الوكيل'];
                
                for (let col = 0; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!ws[cellAddress]) {
                        ws[cellAddress] = { t: 's', v: colNames[col] || '' };
                    }
                    
                    ws[cellAddress].s = {
                        fill: {
                             fgColor: { rgb: "B8D4F0" }
                        },
                        font: {
                            bold: true,
                             sz: 14,
                            color: { rgb: "000000" }
                        },
                        alignment: {
                             horizontal: "center",
                            vertical: "center",
                            wrapText: true
                        },
                        border: {
                            top: { style: "medium", color: { rgb: "000000" } },
                            bottom: { style: "medium", color: { rgb: "000000" } },
                            left: { style: "medium", color: { rgb: "000000" } },
                            right: { style: "medium", color: { rgb: "000000" } }
                        }
                    };
                }
                
                for (let row = 1; row <= agentData.length; row++) {                    
                    const isEvenRow = row % 2 === 0;
                     const bgColor = isEvenRow ? "F2F2F2" : "FFFFFF";
                    
                    for (let col = 0; col <= headerRange.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        
                        if (!ws[cellAddress]) {
                            continue;
                        }
                         
                        if (ws[cellAddress].t === 'n' && col >= 2) {
                            ws[cellAddress].z = '#,##0';
                        }
                         
                        ws[cellAddress].s = {
                            fill: {
                                fgColor: { rgb: bgColor }
                            },
                            font: {
                                sz: 11,
                                color: { rgb: "000000" }
                            },
                            alignment: {
                                horizontal: "center",
                                vertical: "center"
                            },
                            border: {
                                top: { style: "thin", color: { rgb: "CCCCCC" } },
                                bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                                left: { style: "thin", color: { rgb: "CCCCCC" } },
                                right: { style: "thin", color: { rgb: "CCCCCC" } }
                            }
                        };
                    }
                }
                
                if (!ws['!rows']) {
                    ws['!rows'] = [];
                }
                 ws['!rows'][0] = { hpt: 30 };

                XLSX.utils.book_append_sheet(wb, ws, 'ملخص الوكلاء');

                const filename = `ملخص_الوكلاء_${formatDateForFilename(new Date())}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                showSuccessMessage(`تم تصدير ملخص ${sortedAgents.length} وكيل إلى ملف Excel بنجاح!`);
            } catch (error) {
                alert('حدث خطأ أثناء التصدير: ' + error.message);
                console.error('Export error:', error);
            }
        }

        function printSummaryReport() {
            if (!agentReports || Object.keys(agentReports).length === 0) {
                alert('لا توجد بيانات للطباعة. يرجى تحليل بيانات الوكلاء أولاً.');
                return;
            }

            updateAgentSummary();
            
            window.print();
        }

        function showAuthorInfo() {
            const popup = document.getElementById('authorInfoPopup');
            const overlay = document.getElementById('popupOverlay');
            popup.classList.add('show');
            overlay.classList.add('show');
        }

        function closeAuthorInfo() {
            const popup = document.getElementById('authorInfoPopup');
            const overlay = document.getElementById('popupOverlay');
            popup.classList.remove('show');
            overlay.classList.remove('show');
        }

        function copyToClipboard(text, label) {
            navigator.clipboard.writeText(text).then(() => {
                showSuccessMessage(`تم نسخ ${label} إلى الحافظة`);
            }).catch(() => {
                alert(`تم نسخ ${label} إلى الحافظة`);
            });
        }

        function openLink(url) {
            window.open(url, '_blank');
        }

        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('popupOverlay');
            overlay.addEventListener('click', closeAuthorInfo);
            loadSettings();
            loadActivityLog();
        });

        let activityLog = JSON.parse(localStorage.getItem('activityLog') || '[]');

        function logActivity(action, details) {
            const logEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                user: currentUser || 'غير محدد'
            };
            activityLog.unshift(logEntry);
            if (activityLog.length > 1000) activityLog = activityLog.slice(0, 1000);
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }

        function refreshActivityLog() {
            const container = document.getElementById('activityLogContent');
            if (!container) return;
            
            if (activityLog.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">لا توجد عمليات مسجلة</p>';
                return;
            }

            let html = '';
            activityLog.forEach(log => {
                const date = new Date(log.timestamp);
                const timeStr = date.toLocaleString('ar-IQ', { 
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit' 
                });
                html += `
                    <div class="activity-item">
                        <span class="activity-icon">${getActivityIcon(log.action)}</span>
                        <div class="activity-details">
                            <strong>${log.action}</strong>
                            <div style="color: #666; font-size: 0.9rem; margin-top: 5px;">${log.details}</div>
                            <div class="activity-time">${timeStr} - ${log.user}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function getActivityIcon(action) {
            if (action.includes('تحميل') || action.includes('رفع')) return '[رفع]';
            if (action.includes('تحليل')) return '[تحليل]';
            if (action.includes('تصدير')) return '[تصدير]';
            if (action.includes('حفظ')) return '[حفظ]';
            if (action.includes('طباعة')) return '[طباعة]';
            if (action.includes('إعدادات')) return '[إعدادات]';
            if (action.includes('نسخ')) return '[نسخ]';
            if (action.includes('مسح')) return '[مسح]';
            return '[عملية]';
        }

        function filterActivityLog() {
            const searchTerm = document.getElementById('activitySearch').value.toLowerCase();
            const container = document.getElementById('activityLogContent');
            const items = container.querySelectorAll('.activity-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function exportActivityLog() {
            if (activityLog.length === 0) {
                alert('لا توجد عمليات للتصدير');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const excelData = activityLog.map(log => ({
                'التاريخ والوقت': new Date(log.timestamp).toLocaleString('ar-IQ'),
                'الإجراء': log.action,
                'التفاصيل': log.details,
                'المستخدم': log.user
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, 'سجل العمليات');
            XLSX.writeFile(wb, `سجل_العمليات_${formatDateForFilename(new Date())}.xlsx`);
            logActivity('تصدير سجل العمليات', 'تم تصدير سجل العمليات إلى Excel');
            showSuccessMessage('تم تصدير سجل العمليات بنجاح!');
        }

        function clearActivityLog() {
            if (confirm('هل أنت متأكد من مسح جميع سجل العمليات؟')) {
                activityLog = [];
                localStorage.removeItem('activityLog');
                refreshActivityLog();
                logActivity('مسح سجل العمليات', 'تم مسح جميع سجل العمليات');
                showSuccessMessage('تم مسح سجل العمليات');
            }
        }

        function loadSettings() {
            const saved = JSON.parse(localStorage.getItem('appSettings') || '{}');
            if (saved.bronze) document.getElementById('priceBronze').value = saved.bronze;
            if (saved.silver) document.getElementById('priceSilver').value = saved.silver;
            if (saved.gold) document.getElementById('priceGold').value = saved.gold;
            if (saved.platinum) document.getElementById('pricePlatinum').value = saved.platinum;
            if (saved.notifications !== undefined) document.getElementById('enableNotifications').checked = saved.notifications;
        }

        function savePriceSettings() {
            const bronze = parseFloat(document.getElementById('priceBronze').value);
            const silver = parseFloat(document.getElementById('priceSilver').value);
            const gold = parseFloat(document.getElementById('priceGold').value);
            const platinum = parseFloat(document.getElementById('pricePlatinum').value);
            
            subscriptionPrices.basic['Iraqcell_Bronze_Profile_NEW'] = bronze;
            subscriptionPrices.basic['Iraqcell_Silver_Profile_NEW'] = silver;
            subscriptionPrices.basic['Iraqcell_Gold_Profile_NEW'] = gold;
            subscriptionPrices.basic['Iraqcell_Platinum_Profile_NEW'] = platinum;
            
            const settings = {
                bronze, silver, gold, platinum,
                notifications: document.getElementById('enableNotifications').checked
            };
            localStorage.setItem('appSettings', JSON.stringify(settings));
            logActivity('حفظ الإعدادات', 'تم تحديث إعدادات الأسعار');
            showSuccessMessage('تم حفظ الإعدادات بنجاح!');
        }

        function saveDefaultPercentage() {
            const defaultPercentage = parseFloat(document.getElementById('defaultAgentPercentage').value);
            if (defaultPercentage < 0 || defaultPercentage > 100) {
                alert('النسبة المئوية يجب أن تكون بين 0 و 100');
                const saved = parseFloat(localStorage.getItem('defaultAgentPercentage')) || 16;
                document.getElementById('defaultAgentPercentage').value = saved;
                return;
            }
            localStorage.setItem('defaultAgentPercentage', defaultPercentage.toString());
            logActivity('حفظ الإعدادات', `تم تحديث النسبة الافتراضية للوكلاء إلى ${defaultPercentage}%`);
            showSuccessMessage(`تم حفظ النسبة الافتراضية: ${defaultPercentage}%`);
        }

        function backupData() {
            const backup = {
                timestamp: new Date().toISOString(),
                agentReports: agentReports,
                settings: JSON.parse(localStorage.getItem('appSettings') || '{}'),
                activityLog: activityLog
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_${formatDateForFilename(new Date())}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            logActivity('نسخ احتياطي', 'تم إنشاء نسخة احتياطية من البيانات');
            showSuccessMessage('تم إنشاء النسخة الاحتياطية بنجاح!');
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        if (backup.agentReports) agentReports = backup.agentReports;
                        if (backup.settings) localStorage.setItem('appSettings', JSON.stringify(backup.settings));
                        if (backup.activityLog) {
                            activityLog = backup.activityLog;
                            localStorage.setItem('activityLog', JSON.stringify(activityLog));
                        }
                        
                        loadSettings();
                        updateAgentSummary();
                        refreshActivityLog();
                        logActivity('استعادة البيانات', 'تم استعادة البيانات من النسخة الاحتياطية');
                        showSuccessMessage('تم استعادة البيانات بنجاح!');
                    } catch (error) {
                        alert('خطأ في قراءة الملف: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('هل أنت متأكد من مسح جميع البيانات؟ هذا الإجراء لا يمكن التراجع عنه!')) {
                agentReports = {};
                activityLog = [];
                localStorage.clear();
                logActivity('مسح جميع البيانات', 'تم مسح جميع البيانات من النظام');
                showSuccessMessage('تم مسح جميع البيانات');
                location.reload();
            }
        }

        function loadActivityLog() {
            refreshActivityLog();
}

        function ensureAgentExists(agentName) {
            if (!agentName || agentName === 'غير محدد') {
                return;
            }
            
            const agentExists = agentsList.some(a => a.name === agentName);
            
            if (!agentExists) {
                agentsList.push({ 
                    name: agentName,
                    subName: '',
                    phone: '', 
                    email: '',
                    percentage: 16
                });
                localStorage.setItem('agentsList', JSON.stringify(agentsList));
                logActivity('إضافة وكيل تلقائي', `تم إضافة الوكيل "${agentName}" تلقائياً من ملف التحليل`);
                showSuccessMessage(`تم إضافة الوكيل "${agentName}" تلقائياً إلى قائمة الوكلاء`);
            }
        }
        
        let currentAgentSort = 'name';
        let currentAgentFilter = '';

        function refreshAgentsList() {
            renderAgentsList();
        }

        function filterAgents() {
            currentAgentFilter = document.getElementById('agentSearchInput').value.toLowerCase().trim();
            renderAgentsList();
        }

        function sortAgents() {
            currentAgentSort = document.getElementById('agentSortSelect').value;
            renderAgentsList();
        }

        function renderAgentsList() {
            const agentsListContainer = document.getElementById('agentsList');
            if (!agentsListContainer) return;

            if (agentsList.length === 0) {
                agentsListContainer.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #999;">
                        <p style="font-size: 1.2rem; margin-bottom: 20px;">لا يوجد وكلاء مسجلون</p>
                        <button class="btn btn-primary" onclick="showAddAgentModal()"> إضافة وكيل جديد</button>
                    </div>
                `;
                document.getElementById('agentsCount').textContent = '0';
                return;
            }

            let filteredAgents = agentsList.filter(agent => {
                if (!currentAgentFilter) return true;
                return agent.name.toLowerCase().includes(currentAgentFilter) ||
                       (agent.phone && agent.phone.includes(currentAgentFilter)) ||
                       (agent.email && agent.email.toLowerCase().includes(currentAgentFilter));
            });

            filteredAgents = filteredAgents.map(agent => {
                const reports = agentReports[agent.name] || {};
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                const reportsCount = (totalBasic > 0 ? 1 : 0) + (totalAdvanced > 0 ? 1 : 0) + (totalTwoMonths > 0 ? 1 : 0);
                
                return {
                    ...agent,
                    index: agentsList.indexOf(agent),
                    total,
                    reportsCount
                };
            });

            filteredAgents.sort((a, b) => {
                switch(currentAgentSort) {
                    case 'name':
                        return a.name.localeCompare(b.name, 'ar');
                    case 'name-desc':
                        return b.name.localeCompare(a.name, 'ar');
                    case 'total-desc':
                        return b.total - a.total;
                    case 'total-asc':
                        return a.total - b.total;
                    case 'reports-desc':
                        return b.reportsCount - a.reportsCount;
                    case 'reports-asc':
                        return a.reportsCount - b.reportsCount;
                    default:
                        return 0;
                }
            });

            let html = '';
            filteredAgents.forEach((agent) => {
                const index = agent.index;
                const reports = agentReports[agent.name] || {};
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                
                const hasReports = total > 0;
                const reportsCount = (totalBasic > 0 ? 1 : 0) + (totalAdvanced > 0 ? 1 : 0) + (totalTwoMonths > 0 ? 1 : 0);

                html += `
                    <div class="agent-card-improved">
                        <div class="agent-card-header-improved">
                            <div class="agent-name-section">
                                <h3 class="agent-name-title">${agent.name}</h3>
                                ${agent.subName ? `<p class="agent-name-subtitle">${agent.subName}</p>` : ''}
                                ${hasReports ? `<span class="agent-badge">${formatNumberEnglish(reportsCount)} تقرير</span>` : '<span class="agent-badge-empty">لا توجد تقارير</span>'}
                            </div>
                            <div class="agent-actions-improved">
                                <button class="btn-action btn-action-edit" onclick="showEditAgentModal(${index})" title="تعديل البيانات">
                                    تعديل
                                </button>
                                <button class="btn-action btn-action-send" onclick="sendWhatsAppReport('${agent.name}')" title="إرسال تقرير WhatsApp" ${!hasReports ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                    إرسال
                                </button>
                                <button class="btn-action btn-action-delete" onclick="deleteAgent(${index})" title="حذف الوكيل">
                                    حذف
                                </button>
                            </div>
                        </div>
                        
                        <div class="agent-info-section">
                            <div class="info-item-improved">
                                <span class="info-label">النسبة:</span>
                                <input type="number" id="agentPercentage_${index}" class="info-value-input" value="${agent.percentage || 16}" min="0" max="100" step="0.01" onchange="updateAgentPercentage(${index}, this.value)" style="width: 80px; padding: 4px; text-align: center; direction: ltr; font-size: 0.8rem; border: 1px solid rgba(128, 28, 50, 0.2); border-radius: 6px; position: relative; z-index: 10; pointer-events: auto; cursor: text;">
                                <span style="margin-right: 5px; color: #801c32; font-weight: 700;">%</span>
                            </div>
                            ${agent.phone ? `
                                <div class="info-item-improved">
                                    <span class="info-label">هاتف:</span>
                                    <span class="info-value">${agent.phone}</span>
                                </div>
                            ` : ''}
                            ${agent.email ? `
                                <div class="info-item-improved">
                                    <span class="info-label">بريد:</span>
                                    <span class="info-value">${agent.email}</span>
                                </div>
                            ` : ''}
                            ${!agent.phone && !agent.email ? `
                                <div class="info-item-improved">
                                    <span class="info-label-empty">لا توجد معلومات اتصال</span>
                                </div>
                            ` : ''}
                        </div>

                        <div class="agent-reports-section">
                            <div class="reports-grid">
                                ${totalBasic > 0 ? `
                                    <div class="report-item report-basic">
                                        <div class="report-label">العرض المجاني</div>
                                        <div class="report-value">${formatNumber(totalBasic)} <span class="currency">د.ع</span></div>
                                    </div>
                                ` : ''}
                                ${totalAdvanced > 0 ? `
                                    <div class="report-item report-advanced">
                                        <div class="report-label">مخفض 3 أشهر</div>
                                        <div class="report-value">${formatNumber(totalAdvanced)} <span class="currency">د.ع</span></div>
                                    </div>
                                ` : ''}
                                ${totalTwoMonths > 0 ? `
                                    <div class="report-item report-twomonths">
                                        <div class="report-label">مخفض شهرين</div>
                                        <div class="report-value">${formatNumber(totalTwoMonths)} <span class="currency">د.ع</span></div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${hasReports ? `
                                <div class="agent-total-section">
                                    <div class="total-label">الإجمالي الكلي</div>
                                    <div class="total-value">${formatNumber(total)} <span class="currency">د.ع</span></div>
                                </div>
                            ` : `
                                <div class="no-reports-message">
                                    <p>لم يتم تحليل أي تقارير لهذا الوكيل بعد</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            });
            agentsListContainer.innerHTML = html;
            
            const countElement = document.getElementById('agentsCount');
            if (countElement) {
                countElement.textContent = filteredAgents.length;
            }
        }

        function showAddAgentModal() {
            document.getElementById('agentModalTitle').textContent = 'إضافة وكيل جديد';
            document.getElementById('agentForm').reset();
            document.getElementById('agentBronzeName').value = '';
            document.getElementById('agentSilverName').value = '';
            document.getElementById('agentGoldName').value = '';
            document.getElementById('agentPlatinumName').value = '';
            document.getElementById('agentForm').onsubmit = function(e) {
                e.preventDefault();
                addAgent();
            };
            document.getElementById('agentModal').classList.add('show');
        }

        function showEditAgentModal(index) {
            const agent = agentsList[index];
            document.getElementById('agentModalTitle').textContent = 'تعديل بيانات الوكيل';
            document.getElementById('agentName').value = agent.name;
            document.getElementById('agentSubName').value = agent.subName || '';
            document.getElementById('agentPhone').value = agent.phone || '';
            document.getElementById('agentEmail').value = agent.email || '';
            
            const subNames = agent.subscriptionNames || {};
            document.getElementById('agentBronzeName').value = subNames.bronze && subNames.bronze !== 'Iraqcell_Bronze_Profile_NEW' ? subNames.bronze : '';
            document.getElementById('agentSilverName').value = subNames.silver && subNames.silver !== 'Iraqcell_Silver_Profile_NEW' ? subNames.silver : '';
            document.getElementById('agentGoldName').value = subNames.gold && subNames.gold !== 'Iraqcell_Gold_Profile_NEW' ? subNames.gold : '';
            document.getElementById('agentPlatinumName').value = subNames.platinum && subNames.platinum !== 'Iraqcell_Platinum_Profile_NEW' ? subNames.platinum : '';
            
            document.getElementById('agentForm').onsubmit = function(e) {
                e.preventDefault();
                updateAgent(index);
            };
            document.getElementById('agentModal').classList.add('show');
        }

        function closeAgentModal() {
            document.getElementById('agentModal').classList.remove('show');
        }

        function addAgent() {
            const name = document.getElementById('agentName').value.trim();
            const subName = document.getElementById('agentSubName') ? document.getElementById('agentSubName').value.trim() : '';
            const phone = document.getElementById('agentPhone').value.trim();
            const email = document.getElementById('agentEmail').value.trim();
            
            const bronzeName = document.getElementById('agentBronzeName').value.trim();
            const silverName = document.getElementById('agentSilverName').value.trim();
            const goldName = document.getElementById('agentGoldName').value.trim();
            const platinumName = document.getElementById('agentPlatinumName').value.trim();

            if (!name) {
                alert('يرجى إدخال اسم الوكيل');
                return;
            }

            if (agentsList.some(a => a.name === name)) {
                alert('اسم الوكيل موجود مسبقاً');
                return;
            }

            const agentData = { 
                name, 
                subName: subName || '', 
                phone, 
                email,
                subscriptionNames: {
                    bronze: bronzeName || 'Iraqcell_Bronze_Profile_NEW',
                    silver: silverName || 'Iraqcell_Silver_Profile_NEW',
                    gold: goldName || 'Iraqcell_Gold_Profile_NEW',
                    platinum: platinumName || 'Iraqcell_Platinum_Profile_NEW'
                }
            };
            
            agentsList.push(agentData);
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            refreshAgentsList();
            updateAgentsListForPercentage();
            closeAgentModal();
            showSuccessMessage('تم إضافة الوكيل بنجاح');
            logActivity('إضافة وكيل', `تم إضافة وكيل جديد: ${name}`);
        }

        function updateAgentPercentage(index, newPercentage) {
            const percentage = parseFloat(newPercentage) || 16;
            if (percentage < 0 || percentage > 100) {
                alert('النسبة المئوية يجب أن تكون بين 0 و 100');
                const agent = agentsList[index];
                document.getElementById(`agentPercentage_${index}`).value = agent.percentage || 16;
                return;
            }
            
            const agent = agentsList[index];
            if (!agent) return;
            
            agent.percentage = percentage;
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            refreshAgentsList();
            showSuccessMessage(`تم تحديث النسبة للوكيل "${agent.name}" إلى ${percentage}%`);
            logActivity('تعديل نسبة وكيل', `تم تحديث نسبة الوكيل "${agent.name}" إلى ${percentage}%`);
        }

        function updateAgent(index) {
            const name = document.getElementById('agentName').value.trim();
            const subName = document.getElementById('agentSubName') ? document.getElementById('agentSubName').value.trim() : '';
            const phone = document.getElementById('agentPhone').value.trim();
            const email = document.getElementById('agentEmail').value.trim();
            
            const bronzeName = document.getElementById('agentBronzeName').value.trim();
            const silverName = document.getElementById('agentSilverName').value.trim();
            const goldName = document.getElementById('agentGoldName').value.trim();
            const platinumName = document.getElementById('agentPlatinumName').value.trim();

            if (!name) {
                alert('يرجى إدخال اسم الوكيل');
                return;
            }

            const oldName = agentsList[index].name;
            if (name !== oldName && agentsList.some((a, i) => i !== index && a.name === name)) {
                alert('اسم الوكيل موجود مسبقاً');
                return;
            }

            if (name !== oldName && agentReports[oldName]) {
                agentReports[name] = agentReports[oldName];
                delete agentReports[oldName];
            }

            const agentData = { 
                name, 
                subName: subName || '', 
                phone, 
                email,
                subscriptionNames: {
                    bronze: bronzeName || 'Iraqcell_Bronze_Profile_NEW',
                    silver: silverName || 'Iraqcell_Silver_Profile_NEW',
                    gold: goldName || 'Iraqcell_Gold_Profile_NEW',
                    platinum: platinumName || 'Iraqcell_Platinum_Profile_NEW'
                }
            };
            
            agentsList[index] = agentData;
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            refreshAgentsList();
            updateAgentSummary();
            updateAgentsListForPercentage();
            closeAgentModal();
            showSuccessMessage('تم تحديث بيانات الوكيل بنجاح');
            logActivity('تعديل وكيل', `تم تعديل بيانات الوكيل: ${name}`);
        }

        function deleteAgent(index) {
            const agent = agentsList[index];
            if (!confirm(`هل أنت متأكد من حذف الوكيل "${agent.name}"؟`)) return;

            agentsList.splice(index, 1);
            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            refreshAgentsList();
            updateAgentsListForPercentage();
            showSuccessMessage('تم حذف الوكيل بنجاح');
            logActivity('حذف وكيل', `تم حذف الوكيل: ${agent.name}`);
        }

        function importAgentsFromTable() {
            const agentsFromTable = [
                'حسنين صاحب عبد',
                'حسين عادل حسن',
                'سامر داخل سلمان',
                'ضياء عبد الحسين',
                'حسن حميد',
                'حسين علي عبد الامير',
                'حيدرهاني',
                'زيد صالح',
                'ضرغام باسم',
                'عباس سعد حمزة',
                'علاء صاحب عبد علي',
                'عيسى حسين',
                'غيث علاء زكي',
                'فؤاد عايد',
                'محمد ابراهيم',
                'محمد صاحب جابر',
                'محمد عباس محمد',
                'منتظر ماجد',
                'وليد علوي',
                'حسنين صاحب',
                'عراق سيل'
            ];

            let addedCount = 0;
            let skippedCount = 0;

            agentsFromTable.forEach(agentName => {
                const exists = agentsList.some(a => a.name === agentName);
                if (!exists) {
                    agentsList.push({
                        name: agentName,
                        subName: '',
                        phone: '',
                        email: '',
                        percentage: 16
                    });
                    addedCount++;
                } else {
                    skippedCount++;
                }
            });

            localStorage.setItem('agentsList', JSON.stringify(agentsList));
            refreshAgentsList();
            
            let message = `تم إضافة ${addedCount} وكيل جديد`;
            if (skippedCount > 0) {
                message += `، وتم تخطي ${skippedCount} وكيل موجود مسبقاً`;
            }
            
            showSuccessMessage(message);
            logActivity('استيراد الوكلاء', `تم استيراد ${addedCount} وكيل من الجدول`);
        }

        function connectWhatsApp() {
            const phone = prompt('يرجى إدخال رقم الهاتف المرتبط بـ WhatsApp (مع رمز البلد، مثال: 9647712345678 أو 07701234567):');
            if (!phone || phone.trim() === '') {
                return;
            }

            const cleanPhone = phone.replace(/[^0-9]/g, '');
            if (cleanPhone.length < 10) {
                alert('رقم الهاتف غير صحيح. يرجى إدخال رقم صحيح');
                return;
            }

            const formattedPhone = formatPhoneForWhatsApp(cleanPhone);

            whatsappPhone = formattedPhone;
            whatsappConnected = true;
            
            const statusElement = document.getElementById('whatsappConnectionStatus');
            if (statusElement) {
                statusElement.textContent = 'جاهز للإرسال';
                statusElement.style.color = '#25D366';
            }
            
            const qrContainer = document.getElementById('whatsappQRCode');
            if (qrContainer) {
                qrContainer.innerHTML = '';
                
                const whatsappLink = `https://wa.me/${formattedPhone}`;
                
                try {
                    new QRCode(qrContainer, {
                        text: whatsappLink,
                        width: 200,
                        height: 200,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    qrContainer.innerHTML += `<p style="margin-top: 10px; text-align: center;"><a href="${whatsappLink}" target="_blank" style="color: #25D366; text-decoration: none; font-weight: bold;"> فتح WhatsApp</a></p>`;
                } catch (error) {
                    console.error('Error generating QR code:', error);
                    qrContainer.innerHTML = `<p style="text-align: center;"><a href="${whatsappLink}" target="_blank" style="color: #25D366; text-decoration: none; font-weight: bold; font-size: 1.1rem;">فتح WhatsApp</a></p>`;
                }
            }

            localStorage.setItem('whatsappPhone', formattedPhone);
            localStorage.setItem('whatsappPhoneClean', cleanPhone);
            localStorage.setItem('whatsappConnected', 'true');
            
            showSuccessMessage('تم إعداد WhatsApp بنجاح! يمكنك الآن إرسال الرسائل');
            logActivity('ربط واتساب', `تم إعداد واتساب برقم: ${cleanPhone}`);
        }

        function disconnectWhatsApp() {
            whatsappConnected = false;
            whatsappPhone = '';
            
            const statusElement = document.getElementById('whatsappConnectionStatus');
            if (statusElement) {
                statusElement.textContent = 'غير متصل';
                statusElement.style.color = '#e53e3e';
            }
            
            const qrContainer = document.getElementById('whatsappQRCode');
            if (qrContainer) {
                qrContainer.innerHTML = '';
            }
            
            localStorage.removeItem('whatsappPhone');
            localStorage.removeItem('whatsappPhoneClean');
            localStorage.removeItem('whatsappConnected');
            
            showSuccessMessage('تم قطع الاتصال بـ WhatsApp');
            logActivity('قطع ربط WhatsApp', 'تم قطع الاتصال بـ WhatsApp');
        }

        function sendWhatsAppReport(agentName) {
            const agent = agentsList.find(a => a.name === agentName);
            if (!agent) {
                alert('الوكيل غير موجود في القائمة');
                return;
            }

            if (!agent.phone) {
                alert('لم يتم تحديد رقم هاتف للوكيل');
                return;
            }

            showMessageCustomizationModal(agentName);
        }

        function downloadExcelReport(agentName) {
            const reports = agentReports[agentName] || {};
            const hasReports = (reports.basic?.total.amount || 0) > 0 || 
                              (reports.advanced?.total.profit || 0) > 0 || 
                              (reports.twoMonths?.total.profit || 0) > 0;
            
            if (!hasReports) {
                alert('لا توجد تقارير للوكيل');
                return;
            }

            generateExcelReportBlob(agentName).then((excelBlob) => {
                const filename = getReportFilename(agentName, 'xlsx');
                downloadFile(excelBlob, filename);
                logActivity('تحميل Excel', `تم تحميل ملف Excel للوكيل: ${agentName}`);
                showSuccessMessage(`تم تحميل ملف Excel للوكيل: ${agentName}`);
            }).catch((error) => {
                console.error('Error generating Excel:', error);
                alert('حدث خطأ أثناء إنشاء ملف Excel. يرجى المحاولة مرة أخرى.');
            });
        }

        function showMessageCustomizationModal(agentName) {
            const reports = agentReports[agentName] || {};
            const agent = agentsList.find(a => a.name === agentName);
            const agentSubName = agent?.subName || '';

            document.getElementById('customMessageAgentName').textContent = agentName;
            
            let defaultMessage = `*${agentName}*`;
            if (agentSubName) {
                defaultMessage += `\n${agentSubName}`;
            }
            defaultMessage += `\n\nتحية طيبة وبعد،\n\nنود إعلامكم بالتقرير الخاص بالمبالغ المستحقة، وكما يلي:\n\n`;
            
            // حساب الإجماليات لكل عرض
            const totalBasic = reports.basic?.total.amount || 0;
            const totalAdvanced = reports.advanced?.total.profit || 0;
            const totalTwoMonths = reports.twoMonths?.total.profit || 0;
            const selectedTotal = totalBasic + totalAdvanced + totalTwoMonths;
            
            // حساب عدد العروض المتاحة
            const availableOffers = [];
            if (totalBasic > 0) availableOffers.push({ type: 'basic', amount: totalBasic });
            if (totalAdvanced > 0) availableOffers.push({ type: 'advanced', amount: totalAdvanced });
            if (totalTwoMonths > 0) availableOffers.push({ type: 'twoMonths', amount: totalTwoMonths });
            
            // إذا كان هناك أكثر من عرض، نذكر كل واحد على حدة
            if (availableOffers.length > 1) {
                defaultMessage += `━━━━━━━━━━━━━━━━━━━━\n`;
            
            if (totalBasic > 0) {
                    defaultMessage += `*إجمالي العرض المجاني: ${formatNumberEnglish(totalBasic)} دينار عراقي*\n`;
            }
            if (totalAdvanced > 0) {
                    defaultMessage += `*إجمالي العرض المخفض لثلاثة أشهر: ${formatNumberEnglish(totalAdvanced)} دينار عراقي*\n`;
            }
            if (totalTwoMonths > 0) {
                    defaultMessage += `*إجمالي العرض المخفض لشهرين: ${formatNumberEnglish(totalTwoMonths)} دينار عراقي*\n`;
            }
            
                defaultMessage += `\n━━━━━━━━━━━━━━━━━━━━\n`;
                defaultMessage += `*الإجمالي الكلي: ${formatNumberEnglish(selectedTotal)} دينار عراقي*\n`;
            }
            // إذا كان هناك عرض واحد فقط، نذكره فقط
            else if (availableOffers.length === 1) {
                const offer = availableOffers[0];
                defaultMessage += `━━━━━━━━━━━━━━━━━━━━\n`;
                
                if (offer.type === 'basic') {
                    defaultMessage += `*إجمالي العرض المجاني: ${formatNumberEnglish(offer.amount)} دينار عراقي*\n`;
                } else if (offer.type === 'advanced') {
                    defaultMessage += `*إجمالي العرض المخفض لثلاثة أشهر: ${formatNumberEnglish(offer.amount)} دينار عراقي*\n`;
                } else if (offer.type === 'twoMonths') {
                    defaultMessage += `*إجمالي العرض المخفض لشهرين: ${formatNumberEnglish(offer.amount)} دينار عراقي*\n`;
                }
            }
            // إذا لم يكن هناك أي عروض
            else if (selectedTotal > 0) {
                defaultMessage += `━━━━━━━━━━━━━━━━━━━━\n`;
                defaultMessage += `*الإجمالي الكلي: ${formatNumberEnglish(selectedTotal)} دينار عراقي*\n`;
            }
            
            defaultMessage += `\n━━━━━━━━━━━━━━━━━━━━\n`;
            defaultMessage += `يرجى التفضل بالاطلاع على الملف المرفق للاطلاع على التفاصيل الكاملة.\n\n`;
            defaultMessage += `مع فائق الشكر والتقدير،\n`;
            defaultMessage += `*شركة عراق سيل للإتصالات*`;

            document.getElementById('customMessageText').value = defaultMessage;
            
            document.getElementById('customMessageAgentName').setAttribute('data-agent', agentName);
            
            document.getElementById('messageCustomizationModal').classList.add('show');
        }
        
        // دالة لإنشاء جدول الاشتراكات
        function generateSubscriptionTable(reportData, reportType) {
            let table = '';
            const categories = [
                { key: 'platinum', name: 'Platinum', emoji: '💎', arabicName: 'بلاتينيوم' },
                { key: 'gold', name: 'Gold', emoji: '🥇', arabicName: 'كولد' },
                { key: 'silver', name: 'Silver', emoji: '🥈', arabicName: 'سلفر' },
                { key: 'bronze', name: 'Bronze', emoji: '🥉', arabicName: 'برونز' }
            ];
            
            let hasData = false;
            categories.forEach(cat => {
                const category = reportData[cat.key];
                if (category && category.count > 0) {
                    hasData = true;
                    let amount = 0;
                    let price = 0;
                    
                    if (reportType === 'basic') {
                        amount = category.amount || 0;
                        price = category.count > 0 ? Math.round(amount / category.count) : 0;
                    } else {
                        amount = (category.officialAmount || 0) - (category.promoAmount || 0);
                        price = category.count > 0 ? Math.round(amount / category.count) : 0;
                    }
                    
                    table += `*${cat.arabicName} (${cat.name})*\n`;
                    table += `   عدد الاشتراكات: ${formatNumberEnglish(category.count)}\n`;
                    table += `   السعر الواحد: ${formatNumberEnglish(price)} د.ع\n`;
                    table += `   المجموع: ${formatNumberEnglish(amount)} د.ع\n\n`;
                }
            });
            
            if (hasData) {
                const totalCount = (reportData.platinum?.count || 0) + 
                                 (reportData.gold?.count || 0) + 
                                 (reportData.silver?.count || 0) + 
                                 (reportData.bronze?.count || 0);
                
                let totalAmount = 0;
                if (reportType === 'basic') {
                    totalAmount = reportData.total?.amount || 0;
                } else {
                    totalAmount = reportData.total?.profit || 0;
                }
                
                table += `━━━━━━━━━━━━━━━━━━━━\n`;
                table += `*المجموع*\n`;
                table += `   عدد الاشتراكات: ${formatNumberEnglish(totalCount)}\n`;
                table += `   الإجمالي: ${formatNumberEnglish(totalAmount)} د.ع\n`;
            }
            
            return table;
        }

        function closeMessageCustomizationModal() {
            document.getElementById('messageCustomizationModal').classList.remove('show');
        }


        function insertOfferInfo(type) {
            const textarea = document.getElementById('customMessageText');
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            let insertText = '';
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const reports = agentReports[agentName] || {};

            if (type === 'basic' && reports.basic) {
                insertText = ` العرض المجاني: ${formatNumberEnglish(reports.basic.total.amount || 0)} دينار عراقي`;
            } else if (type === 'advanced' && reports.advanced) {
                insertText = ` مخفض 3 أشهر: ${formatNumberEnglish(reports.advanced.total.profit || 0)} دينار عراقي`;
            } else if (type === 'twomonths' && reports.twoMonths) {
                insertText = ` مخفض شهرين: ${formatNumberEnglish(reports.twoMonths.total.profit || 0)} دينار عراقي`;
            } else if (type === 'total') {
                const totalBasic = reports.basic?.total.amount || 0;
                const totalAdvanced = reports.advanced?.total.profit || 0;
                const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                const total = totalBasic + totalAdvanced + totalTwoMonths;
                insertText = ` الإجمالي الكلي: ${formatNumberEnglish(total)} دينار عراقي`;
            }

            if (insertText) {
                textarea.value = textBefore + insertText + '\n' + textAfter;
                textarea.selectionStart = textarea.selectionEnd = cursorPos + insertText.length + 1;
            }
        }

        function formatNumberEnglish(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US').format(Math.floor(num));
        }

        function addOffersToMessage(message, agentName) {
            const reports = agentReports[agentName] || {};
            const totalBasic = reports.basic?.total.amount || 0;
            const totalAdvanced = reports.advanced?.total.profit || 0;
            const totalTwoMonths = reports.twoMonths?.total.profit || 0;

            let finalMessage = message;
            
            // التحقق من وجود الجداول التفصيلية في الرسالة
            const hasDetailedTable = finalMessage.includes('━━━━━━━━━━━━━━━━━━━━') || 
                                     finalMessage.includes('عدد الاشتراكات:') ||
                                     finalMessage.includes('السعر:') ||
                                     finalMessage.includes('المجموع:');
            
            const hasBasicInMessage = finalMessage.includes('العرض المجاني') || 
                                     finalMessage.includes('اشتراك العرض المجاني') ||
                                     finalMessage.includes('المجاني:') ||
                                     finalMessage.match(/المجاني[:\s]+[\d,]+/);
            
            const hasAdvancedInMessage = finalMessage.includes('مخفض 3 أشهر') || 
                                         finalMessage.includes('مخفض 3') ||
                                         finalMessage.includes('ثلاثة أشهر') ||
                                         finalMessage.includes('ثلاث أشهر') ||
                                         finalMessage.includes('العرض المخفَّض لثلاثة أشهر') ||
                                         finalMessage.includes('العرض المخفض لثلاثة أشهر') ||
                                         finalMessage.match(/مخف[ضف]\s*3/);
            
            const hasTwoMonthsInMessage = finalMessage.includes('مخفض شهرين') || 
                                          finalMessage.includes('مخفض شهرين') ||
                                          finalMessage.includes('شهرين') ||
                                          finalMessage.includes('العرض المخفَّض لشهرين') ||
                                          finalMessage.includes('العرض المخفض لشهرين') ||
                                          finalMessage.match(/مخف[ضف]\s*شهرين/);
            
            const hasTotalInMessage = finalMessage.includes('الإجمالي الكلي') || 
                                     finalMessage.includes('الإجمالي:');
            
            // إذا كانت الرسالة تحتوي على جداول تفصيلية، لا نضيف معلومات إضافية
            if (hasDetailedTable) {
                return finalMessage;
            }
            
            // إضافة معلومات بسيطة إذا لم تكن موجودة
            if (totalBasic > 0 && !hasBasicInMessage) {
                finalMessage += `\n\n*العرض المجاني*\n`;
                finalMessage += generateSubscriptionTable(reports.basic, 'basic');
            }
            
            if (totalAdvanced > 0 && !hasAdvancedInMessage) {
                finalMessage += `\n\n*العرض المخفض لثلاثة أشهر*\n`;
                finalMessage += generateSubscriptionTable(reports.advanced, 'advanced');
            }
            
            if (totalTwoMonths > 0 && !hasTwoMonthsInMessage) {
                finalMessage += `\n\n*العرض المخفض لشهرين*\n`;
                finalMessage += generateSubscriptionTable(reports.twoMonths, 'twoMonths');
            }

                const total = totalBasic + totalAdvanced + totalTwoMonths;
            if (total > 0 && !hasTotalInMessage) {
                finalMessage += `\n━━━━━━━━━━━━━━━━━━━━\n`;
                finalMessage += `*الإجمالي الكلي: ${formatNumberEnglish(total)} دينار عراقي*\n`;
            }

            return finalMessage;
        }

        function sendCustomizedWhatsAppMessage() {
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const agent = agentsList.find(a => a.name === agentName);
            
            if (!agent || !agent.phone) {
                alert('خطأ في بيانات الوكيل');
                return;
            }

            let message = document.getElementById('customMessageText').value.trim();
            
            if (!message) {
                alert('يرجى كتابة رسالة قبل الإرسال');
                return;
            }

            message = addOffersToMessage(message, agentName);

            const fileType = 'excel';
            const fileInfo = getFileTypeInfo(fileType, agentName);
            const fileBlobPromise = getFileBlobPromise(agentName, fileType);

            fileBlobPromise.then((fileBlob) => {
                const phone = formatPhoneForWhatsApp(agent.phone);

                downloadFile(fileBlob, fileInfo.filename);
                
                const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                logActivity('إرسال تقرير WhatsApp', `تم تحميل ملف ${fileInfo.typeName} للوكيل: ${agentName}`);
                closeMessageCustomizationModal();
            }).catch((error) => {
                console.error('Error generating file:', error);
                alert(`حدث خطأ أثناء إنشاء ملف ${fileInfo.typeName}. يرجى المحاولة مرة أخرى.`);
            });
        }

        function sendViaEmail() {
            const agentName = document.getElementById('customMessageAgentName').getAttribute('data-agent');
            const agent = agentsList.find(a => a.name === agentName);
            
            if (!agent || !agent.email) {
                alert('لم يتم تحديد بريد إلكتروني للوكيل');
                return;
            }

            let message = document.getElementById('customMessageText').value.trim();
            
            if (!message) {
                alert('يرجى كتابة رسالة قبل الإرسال');
                return;
            }

            message = addOffersToMessage(message, agentName);

            const fileType = 'excel';
            const fileInfo = getFileTypeInfo(fileType, agentName);
            const fileBlobPromise = getFileBlobPromise(agentName, fileType);

            fileBlobPromise.then(async (fileBlob) => {
                const subject = `تقرير المبالغ المستحقة - ${agentName}`;
                const emailBody = encodeURIComponent(message);
                
                downloadFile(fileBlob, fileInfo.filename);
                    
                const mailtoLink = `mailto:${agent.email}?subject=${encodeURIComponent(subject)}&body=${emailBody}`;
                window.location.href = mailtoLink;
                    
                logActivity('إرسال تقرير عبر البريد', `تم تحضير ملف ${fileInfo.typeName} وفتح البريد الإلكتروني للوكيل: ${agentName}`);
                showSuccessMessage(`تم تحميل ملف ${fileInfo.typeName}. سيتم فتح برنامج البريد الإلكتروني. يرجى إرفاق الملف يدوياً.`);
                closeMessageCustomizationModal();
            }).catch((error) => {
                console.error('Error generating file:', error);
                alert(`حدث خطأ أثناء إنشاء ملف ${fileInfo.typeName}. يرجى المحاولة مرة أخرى.`);
            });
        }

        function generatePDFReport(agentName) {
            return new Promise((resolve) => {
                generatePDFReportBlob(agentName).then((blob) => {
                    const filename = getReportFilename(agentName, 'pdf');
                    downloadFile(blob, filename);
                    setTimeout(resolve, 500);
                });
            });
        }

        function arabicTextToImage(text, fontSize, color, width = 170) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                ctx.font = `${fontSize}px Tajawal`;
                ctx.fillStyle = color;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                
                const metrics = ctx.measureText(text);
                canvas.width = Math.max(width, metrics.width + 20);
                canvas.height = fontSize + 10;
                
                ctx.font = `${fontSize}px Tajawal`;
                ctx.fillStyle = color;
                ctx.textAlign = 'right';
                ctx.textBaseline = 'middle';
                
                ctx.fillText(text, canvas.width - 10, canvas.height / 2);
                
                canvas.toBlob((blob) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        resolve(reader.result);
                    };
                    reader.readAsDataURL(blob);
                }, 'image/png');
            });
        }

        function generatePDFReportBlob(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape');
                
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;

                    let yPos = 15;
                    const startX = 10;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    
                    const titleImage = await arabicTextToImage(reportTitle, 11, '#000000', pageWidth - 20);
                    doc.addImage(titleImage, 'PNG', startX, yPos, pageWidth - 20, 8);
                    yPos += 12;
                    
                    const colWidths = {
                        serial: 12,
                        agentName: 40,
                        platinumPrice: 15,
                        platinumCount: 12,
                        goldPrice: 15,
                        goldCount: 12,
                        silverPrice: 15,
                        silverCount: 12,
                        bronzePrice: 15,
                        bronzeCount: 12,
                        totalSubs: 18,
                        totalAmount: 20,
                        dateFrom: 18,
                        dateTo: 18
                    };
                    
                    const totalTableWidth = Object.values(colWidths).reduce((a, b) => a + b, 0);
                    const tableStartX = (pageWidth - totalTableWidth) / 2;
                    
                    yPos += 2;
                    const header1Height = 8;
                    const header2Height = 7;
                    const header3Height = 6;
                    
                    doc.setFillColor(173, 216, 230);
                    
                    doc.rect(tableStartX, yPos, colWidths.serial, header1Height + header2Height + header3Height, 'F');
                    const serialHeaderImg = await arabicTextToImage('ت', 10, '#000000', colWidths.serial);
                    doc.addImage(serialHeaderImg, 'PNG', tableStartX + 2, yPos + header1Height + header2Height + 2, colWidths.serial - 4, 4);
                    
                    doc.rect(tableStartX + colWidths.serial, yPos, colWidths.agentName, header1Height + header2Height + header3Height, 'F');
                    const agentNameHeaderImg = await arabicTextToImage('اسم الوكيل', 10, '#000000', colWidths.agentName);
                    doc.addImage(agentNameHeaderImg, 'PNG', tableStartX + colWidths.serial + 2, yPos + header1Height + header2Height + 2, colWidths.agentName - 4, 4);
                    
                    const categoryWidth = colWidths.platinumPrice + colWidths.platinumCount + 
                                         colWidths.goldPrice + colWidths.goldCount + 
                                         colWidths.silverPrice + colWidths.silverCount + 
                                         colWidths.bronzePrice + colWidths.bronzeCount;
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName, yPos, categoryWidth, header1Height, 'F');
                    const categoryHeaderImg = await arabicTextToImage('الفئة', 10, '#000000', categoryWidth);
                    doc.addImage(categoryHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth/2 - 15, yPos + 2, 30, 4);
                    
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth, yPos, colWidths.totalSubs, header1Height + header2Height + header3Height, 'F');
                    const totalSubsHeaderImg = await arabicTextToImage('مجموع الاشتراكات', 9, '#000000', colWidths.totalSubs);
                    doc.addImage(totalSubsHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + 2, yPos + header1Height + header2Height + 2, colWidths.totalSubs - 4, 4);
                    
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs, yPos, colWidths.totalAmount, header1Height + header2Height + header3Height, 'F');
                    const totalAmountHeaderImg = await arabicTextToImage('المبلغ الإجمالي', 9, '#000000', colWidths.totalAmount);
                    doc.addImage(totalAmountHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + 2, yPos + header1Height + header2Height + 2, colWidths.totalAmount - 4, 4);
                    
                    const dateWidth = colWidths.dateFrom + colWidths.dateTo;
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos, dateWidth, header1Height, 'F');
                    const dateHeaderImg = await arabicTextToImage('التاريخ', 10, '#000000', dateWidth);
                    doc.addImage(dateHeaderImg, 'PNG', tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount + dateWidth/2 - 12, yPos + 2, 24, 4);
                    
                    let currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    
                    doc.setFillColor(173, 216, 230);
                    doc.rect(currentX, yPos + header1Height, colWidths.platinumPrice + colWidths.platinumCount, header2Height, 'F');
                    const platinumHeaderImg = await arabicTextToImage('بلاتينيوم', 9, '#000000', colWidths.platinumPrice + colWidths.platinumCount);
                    doc.addImage(platinumHeaderImg, 'PNG', currentX + (colWidths.platinumPrice + colWidths.platinumCount)/2 - 15, yPos + header1Height + 1.5, 30, 4);
                    
                    currentX += colWidths.platinumPrice + colWidths.platinumCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.goldPrice + colWidths.goldCount, header2Height, 'F');
                    const goldHeaderImg = await arabicTextToImage('كولد', 9, '#000000', colWidths.goldPrice + colWidths.goldCount);
                    doc.addImage(goldHeaderImg, 'PNG', currentX + (colWidths.goldPrice + colWidths.goldCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    
                    currentX += colWidths.goldPrice + colWidths.goldCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.silverPrice + colWidths.silverCount, header2Height, 'F');
                    const silverHeaderImg = await arabicTextToImage('سلفر', 9, '#000000', colWidths.silverPrice + colWidths.silverCount);
                    doc.addImage(silverHeaderImg, 'PNG', currentX + (colWidths.silverPrice + colWidths.silverCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    
                    currentX += colWidths.silverPrice + colWidths.silverCount;
                    doc.rect(currentX, yPos + header1Height, colWidths.bronzePrice + colWidths.bronzeCount, header2Height, 'F');
                    const bronzeHeaderImg = await arabicTextToImage('برونز', 9, '#000000', colWidths.bronzePrice + colWidths.bronzeCount);
                    doc.addImage(bronzeHeaderImg, 'PNG', currentX + (colWidths.bronzePrice + colWidths.bronzeCount)/2 - 10, yPos + header1Height + 1.5, 20, 4);
                    
                    currentX = tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount;
                    doc.rect(currentX, yPos + header1Height, colWidths.dateFrom, header2Height + header3Height, 'F');
                    const dateFromHeaderImg = await arabicTextToImage('من', 9, '#000000', colWidths.dateFrom);
                    doc.addImage(dateFromHeaderImg, 'PNG', currentX + colWidths.dateFrom/2 - 8, yPos + header1Height + header2Height + 1.5, 16, 4);
                    
                    currentX += colWidths.dateFrom;
                    doc.rect(currentX, yPos + header1Height, colWidths.dateTo, header2Height + header3Height, 'F');
                    const dateToHeaderImg = await arabicTextToImage('الى', 9, '#000000', colWidths.dateTo);
                    doc.addImage(dateToHeaderImg, 'PNG', currentX + colWidths.dateTo/2 - 8, yPos + header1Height + header2Height + 1.5, 16, 4);
                    
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    doc.setFillColor(173, 216, 230);
                    
                    const priceLabelImg = await arabicTextToImage('السعر', 8, '#000000', 15);
                    const countLabelImg = await arabicTextToImage('عدد الاشتراكات', 8, '#000000', 12);
                    
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.platinumPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.platinumPrice - 4, 3.5);
                    currentX += colWidths.platinumPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.platinumCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.platinumCount - 2, 3.5);
                    
                    currentX += colWidths.platinumCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.goldPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.goldPrice - 4, 3.5);
                    currentX += colWidths.goldPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.goldCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.goldCount - 2, 3.5);
                    
                    currentX += colWidths.goldCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.silverPrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.silverPrice - 4, 3.5);
                    currentX += colWidths.silverPrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.silverCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.silverCount - 2, 3.5);
                    
                    currentX += colWidths.silverCount;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.bronzePrice, header3Height, 'F');
                    doc.addImage(priceLabelImg, 'PNG', currentX + 2, yPos + header1Height + header2Height + 1, colWidths.bronzePrice - 4, 3.5);
                    currentX += colWidths.bronzePrice;
                    doc.rect(currentX, yPos + header1Height + header2Height, colWidths.bronzeCount, header3Height, 'F');
                    doc.addImage(countLabelImg, 'PNG', currentX + 1, yPos + header1Height + header2Height + 1, colWidths.bronzeCount - 2, 3.5);
                    
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.1);
                    let headerX = tableStartX;
                    for (let key in colWidths) {
                        doc.rect(headerX, yPos, colWidths[key], header1Height + header2Height + header3Height, 'S');
                        headerX += colWidths[key];
                    }
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName, yPos + header1Height, categoryWidth, header2Height, 'S');
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos + header1Height, dateWidth, header2Height, 'S');
                    doc.rect(tableStartX + colWidths.serial + colWidths.agentName + categoryWidth + colWidths.totalSubs + colWidths.totalAmount, yPos + header1Height + header2Height, dateWidth, header3Height, 'S');
                    
                    yPos += header1Height + header2Height + header3Height;
                    
                    const cellHeight = 10;
                    
                    doc.setFillColor(255, 255, 255);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'S');
                    
                    doc.text('1', tableStartX + colWidths.serial/2, yPos + 7, { align: 'center' });
                    doc.rect(tableStartX, yPos, colWidths.serial, cellHeight, 'S');
                    
                    const agentNameText = agentName + (agent?.email ? ' / ' + agent.email : '');
                    const agentNameImg = await arabicTextToImage(agentNameText, 9, '#000000', colWidths.agentName - 4);
                    doc.addImage(agentNameImg, 'PNG', tableStartX + colWidths.serial + 2, yPos + 2, colWidths.agentName - 4, 6);
                    doc.rect(tableStartX + colWidths.serial, yPos, colWidths.agentName, cellHeight, 'S');
                    
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    
                    const { platinumCount, platinumPrice, goldCount, goldPrice, 
                            silverCount, silverPrice, bronzeCount, bronzePrice, 
                            totalSubs, totalAmount } = calculateCategoryPricesAndCounts(reportData, reportType);
                    
                    doc.text(formatNumber(Math.round(platinumPrice)), currentX + colWidths.platinumPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumPrice, cellHeight, 'S');
                    currentX += colWidths.platinumPrice;
                    doc.text(String(platinumCount), currentX + colWidths.platinumCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumCount, cellHeight, 'S');
                    
                    currentX += colWidths.platinumCount;
                    doc.text(formatNumber(Math.round(goldPrice)), currentX + colWidths.goldPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldPrice, cellHeight, 'S');
                    currentX += colWidths.goldPrice;
                    doc.text(String(goldCount), currentX + colWidths.goldCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldCount, cellHeight, 'S');
                    
                    currentX += colWidths.goldCount;
                    doc.text(formatNumber(Math.round(silverPrice)), currentX + colWidths.silverPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverPrice, cellHeight, 'S');
                    currentX += colWidths.silverPrice;
                    doc.text(String(silverCount), currentX + colWidths.silverCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverCount, cellHeight, 'S');
                    
                    currentX += colWidths.silverCount;
                    doc.text(formatNumber(Math.round(bronzePrice)), currentX + colWidths.bronzePrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzePrice, cellHeight, 'S');
                    currentX += colWidths.bronzePrice;
                    doc.text(String(bronzeCount), currentX + colWidths.bronzeCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzeCount, cellHeight, 'S');
                    
                    currentX += colWidths.bronzeCount;
                    doc.text(String(totalSubs), currentX + colWidths.totalSubs/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalSubs, cellHeight, 'S');
                    
                    currentX += colWidths.totalSubs;
                    doc.text(formatNumber(totalAmount), currentX + colWidths.totalAmount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalAmount, cellHeight, 'S');
                    
                    currentX += colWidths.totalAmount;
                    doc.text(dateFrom, currentX + colWidths.dateFrom/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateFrom, cellHeight, 'S');
                    currentX += colWidths.dateFrom;
                    doc.text(dateTo, currentX + colWidths.dateTo/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateTo, cellHeight, 'S');
                    
                    yPos += cellHeight;
                    
                    doc.setFillColor(200, 200, 200);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'F');
                    doc.setDrawColor(0, 0, 0);
                    doc.rect(tableStartX, yPos, totalTableWidth, cellHeight, 'S');
                    
                    const totalLabelImg = await arabicTextToImage('المجموع', 9, '#000000', colWidths.serial + colWidths.agentName);
                    doc.addImage(totalLabelImg, 'PNG', tableStartX + 2, yPos + 2, colWidths.serial + colWidths.agentName - 4, 6);
                    doc.rect(tableStartX, yPos, colWidths.serial + colWidths.agentName, cellHeight, 'S');
                    
                    currentX = tableStartX + colWidths.serial + colWidths.agentName;
                    
 إجمالي
                    doc.text('', currentX + colWidths.platinumPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumPrice, cellHeight, 'S');
                    currentX += colWidths.platinumPrice;
                    doc.text(String(platinumCount), currentX + colWidths.platinumCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.platinumCount, cellHeight, 'S');
                    
 إجمالي
                    currentX += colWidths.platinumCount;
                    doc.text('', currentX + colWidths.goldPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldPrice, cellHeight, 'S');
                    currentX += colWidths.goldPrice;
                    doc.text(String(goldCount), currentX + colWidths.goldCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.goldCount, cellHeight, 'S');
                    
 إجمالي
                    currentX += colWidths.goldCount;
                    doc.text('', currentX + colWidths.silverPrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverPrice, cellHeight, 'S');
                    currentX += colWidths.silverPrice;
                    doc.text(String(silverCount), currentX + colWidths.silverCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.silverCount, cellHeight, 'S');
                    
 إجمالي
                    currentX += colWidths.silverCount;
                    doc.text('', currentX + colWidths.bronzePrice/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzePrice, cellHeight, 'S');
                    currentX += colWidths.bronzePrice;
                    doc.text(String(bronzeCount), currentX + colWidths.bronzeCount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.bronzeCount, cellHeight, 'S');
                    
                    currentX += colWidths.bronzeCount;
                    doc.text(String(totalSubs), currentX + colWidths.totalSubs/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalSubs, cellHeight, 'S');
                    
                    currentX += colWidths.totalSubs;
                    doc.text(formatNumber(totalAmount), currentX + colWidths.totalAmount/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.totalAmount, cellHeight, 'S');
                    
                    currentX += colWidths.totalAmount;
                    doc.text('', currentX + colWidths.dateFrom/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateFrom, cellHeight, 'S');
                    currentX += colWidths.dateFrom;
                    doc.text('', currentX + colWidths.dateTo/2, yPos + 7, { align: 'center' });
                    doc.rect(currentX, yPos, colWidths.dateTo, cellHeight, 'S');

                    const pdfBlob = doc.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function generateExcelReportBlob(agentName) {
            return new Promise(async (resolve, reject) => {
                try {
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    
                    // جمع جميع التقارير المتاحة
                    const reports = agentReports[agentName] || {};
                    const hasBasic = reports.basic && reports.basic.total && reports.basic.total.count > 0;
                    const hasAdvanced = reports.advanced && reports.advanced.total && reports.advanced.total.count > 0;
                    const hasTwoMonths = reports.twoMonths && reports.twoMonths.total && reports.twoMonths.total.count > 0;
                    
                    // استخدام ExcelJS للتنسيق الاحترافي
                    const ExcelJS = window.ExcelJS;
                    if (!ExcelJS) {
                        // إذا لم يكن ExcelJS متوفراً، استخدم XLSX
                        return generateExcelReportBlobXLSX(agentName).then(resolve).catch(reject);
                    }
                    
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('تقرير الوكيل');
                    
                    // تحديد عرض الأعمدة
                    worksheet.columns = [
                        { width: 35, key: 'type' },
                        { width: 20, key: 'count' },
                        { width: 20, key: 'price' },
                        { width: 20, key: 'total' }
                    ];
                    
                    let currentRow = 1;
                    
                    // العنوان الرئيسي
                    const titleRow = worksheet.getRow(currentRow);
                    titleRow.getCell(1).value = reportTitle || 'تقرير المبالغ المستحقة';
                    titleRow.getCell(1).font = { bold: true, size: 18, color: { argb: 'FF801C32' } };
                    titleRow.getCell(1).alignment = { horizontal: 'center', vertical: 'middle' };
                    worksheet.mergeCells(currentRow, 1, currentRow, 4);
                    titleRow.height = 30;
                    currentRow++;
                    
                    // معلومات الوكيل
                    currentRow++;
                    worksheet.getRow(currentRow).getCell(1).value = `اسم الوكيل: ${agentName}`;
                    worksheet.getRow(currentRow).getCell(1).font = { bold: true, size: 12 };
                    currentRow++;
                    
                    if (agent?.email) {
                        worksheet.getRow(currentRow).getCell(1).value = `البريد الإلكتروني: ${agent.email}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 11 };
                        currentRow++;
                    }
                    if (agent?.phone) {
                        worksheet.getRow(currentRow).getCell(1).value = `رقم الهاتف: ${agent.phone}`;
                        worksheet.getRow(currentRow).getCell(1).font = { size: 11 };
                        currentRow++;
                    }
                    currentRow++;
                    
                    // دالة لإنشاء جدول منسق
                    const createTable = (title, data, startRow) => {
                        let row = startRow;
                        
                        // عنوان القسم
                        const sectionRow = worksheet.getRow(row);
                        sectionRow.getCell(1).value = title;
                        sectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        sectionRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFF8F9FA' }
                        };
                        sectionRow.getCell(1).alignment = { horizontal: 'right', vertical: 'middle' };
                        sectionRow.getCell(1).border = {
                            top: { style: 'thin', color: { argb: 'FF801C32' } },
                            bottom: { style: 'thin', color: { argb: 'FF801C32' } },
                            left: { style: 'thin', color: { argb: 'FF801C32' } },
                            right: { style: 'thin', color: { argb: 'FF801C32' } }
                        };
                        worksheet.mergeCells(row, 1, row, 4);
                        sectionRow.height = 25;
                        row++;
                        
                        // رأس الجدول
                        const headerRow = worksheet.getRow(row);
                        const headers = ['نوع الاشتراك', 'عدد الاشتراكات', 'السعر الواحد (د.ع)', 'المجموع (د.ع)'];
                        headers.forEach((header, idx) => {
                            const cell = headerRow.getCell(idx + 1);
                            cell.value = header;
                            cell.font = { bold: true, size: 12, color: { argb: 'FFFFFFFF' } };
                            cell.fill = {
                                type: 'pattern',
                                pattern: 'solid',
                                fgColor: { argb: 'FF801C32' }
                            };
                            cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                bottom: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                left: { style: 'thin', color: { argb: 'FFFFFFFF' } },
                                right: { style: 'thin', color: { argb: 'FFFFFFFF' } }
                            };
                        });
                        headerRow.height = 25;
                        row++;
                        
                        // بيانات الصفوف
                        data.forEach((item, index) => {
                            const dataRow = worksheet.getRow(row);
                            const isTotalRow = item.type === 'المجموع';
                            const isEven = index % 2 === 0;
                            
                            // لون الخلفية للصفوف المتناوبة
                            const bgColor = isTotalRow ? 'FFE8F0F5' : (isEven ? 'FFFFFFFF' : 'FFF8F9FA');
                            
                            dataRow.getCell(1).value = item.type;
                            dataRow.getCell(2).value = item.count;
                            dataRow.getCell(3).value = item.price || '';
                            dataRow.getCell(4).value = item.total;
                            
                            // تنسيق الخلايا
                            for (let col = 1; col <= 4; col++) {
                                const cell = dataRow.getCell(col);
                                cell.font = isTotalRow ? { bold: true, size: 12 } : { size: 11 };
                                cell.fill = {
                                    type: 'pattern',
                                    pattern: 'solid',
                                    fgColor: { argb: bgColor }
                                };
                                cell.alignment = col === 1 ? 
                                    { horizontal: 'right', vertical: 'middle' } : 
                                    { horizontal: 'center', vertical: 'middle' };
                                cell.border = {
                                    top: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    bottom: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    left: { style: 'thin', color: { argb: 'FFDDDDDD' } },
                                    right: { style: 'thin', color: { argb: 'FFDDDDDD' } }
                                };
                            }
                            
                            dataRow.height = 22;
                            row++;
                        });
                        
                        row++; // سطر فارغ بعد الجدول
                        return row;
                    };
                    
                    // جدول العرض المجاني
                    if (hasBasic) {
                        const basicData = reports.basic;
                        const categories = [
                            { key: 'platinum', name: 'Platinum' },
                            { key: 'gold', name: 'Gold' },
                            { key: 'silver', name: 'Silver' },
                            { key: 'bronze', name: 'Bronze' }
                        ];
                    
                        const tableData = [];
                        categories.forEach(cat => {
                            const category = basicData[cat.key] || { count: 0, amount: 0 };
                            const price = category.count > 0 ? Math.round((category.amount || 0) / category.count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(category.count || 0),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(category.amount || 0)
                            });
                        });
                        
                        tableData.push({
                            type: 'المجموع',
                            count: formatNumberEnglish(basicData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(basicData.total?.amount || 0)
                        });
                        
                        currentRow = createTable('العرض المجاني', tableData, currentRow);
                    }
                    
                    // جدول العرض المخفض لثلاثة أشهر
                    if (hasAdvanced) {
                        const advancedData = reports.advanced;
                        const categories = [
                            { key: 'platinum', name: 'Platinum' },
                            { key: 'gold', name: 'Gold' },
                            { key: 'silver', name: 'Silver' },
                            { key: 'bronze', name: 'Bronze' }
                        ];
                        
                        const tableData = [];
                        categories.forEach(cat => {
                            const category = advancedData[cat.key] || { count: 0, officialAmount: 0, promoAmount: 0 };
                            const amount = (category.officialAmount || 0) - (category.promoAmount || 0);
                            const price = category.count > 0 ? Math.round(amount / category.count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(category.count || 0),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(amount)
                            });
                        });
                        
                        tableData.push({
                            type: 'المجموع',
                            count: formatNumberEnglish(advancedData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(advancedData.total?.profit || 0)
                        });
                        
                        currentRow = createTable('العرض المخفض لثلاثة أشهر', tableData, currentRow);
                    }
                    
                    // جدول العرض المخفض لشهرين
                    if (hasTwoMonths) {
                        const twoMonthsData = reports.twoMonths;
                        const categories = [
                            { key: 'platinum', name: 'Platinum' },
                            { key: 'gold', name: 'Gold' },
                            { key: 'silver', name: 'Silver' },
                            { key: 'bronze', name: 'Bronze' }
                        ];
                        
                        const tableData = [];
                        categories.forEach(cat => {
                            const category = twoMonthsData[cat.key] || { count: 0, officialAmount: 0, promoAmount: 0 };
                            const amount = (category.officialAmount || 0) - (category.promoAmount || 0);
                            const price = category.count > 0 ? Math.round(amount / category.count) : 0;
                            tableData.push({
                                type: cat.name,
                                count: formatNumberEnglish(category.count || 0),
                                price: formatNumberEnglish(price),
                                total: formatNumberEnglish(amount)
                            });
                        });
                        
                        tableData.push({
                            type: 'المجموع',
                            count: formatNumberEnglish(twoMonthsData.total?.count || 0),
                            price: '',
                            total: formatNumberEnglish(twoMonthsData.total?.profit || 0)
                        });
                        
                        currentRow = createTable('العرض المخفض لشهرين', tableData, currentRow);
                    }
                    
                    // الإجمالي الكلي
                    const totalBasic = reports.basic?.total.amount || 0;
                    const totalAdvanced = reports.advanced?.total.profit || 0;
                    const totalTwoMonths = reports.twoMonths?.total.profit || 0;
                    const selectedTotal = totalBasic + totalAdvanced + totalTwoMonths;
                    
                    if (selectedTotal > 0) {
                        currentRow++;
                        const totalSectionRow = worksheet.getRow(currentRow);
                        totalSectionRow.getCell(1).value = 'الإجمالي الكلي';
                        totalSectionRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        totalSectionRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFF8F9FA' }
                        };
                        totalSectionRow.getCell(1).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                        worksheet.mergeCells(currentRow, 1, currentRow, 4);
                        totalSectionRow.height = 25;
                        currentRow++;
                        
                        if (hasBasic) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'العرض المجاني:';
                            row.getCell(4).value = formatNumberEnglish(totalBasic) + ' د.ع';
                            row.getCell(1).font = { bold: true, size: 11 };
                            row.getCell(4).font = { bold: true, size: 11 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        if (hasAdvanced) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'العرض المخفض لثلاثة أشهر:';
                            row.getCell(4).value = formatNumberEnglish(totalAdvanced) + ' د.ع';
                            row.getCell(1).font = { bold: true, size: 11 };
                            row.getCell(4).font = { bold: true, size: 11 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        if (hasTwoMonths) {
                            const row = worksheet.getRow(currentRow);
                            row.getCell(1).value = 'العرض المخفض لشهرين:';
                            row.getCell(4).value = formatNumberEnglish(totalTwoMonths) + ' د.ع';
                            row.getCell(1).font = { bold: true, size: 11 };
                            row.getCell(4).font = { bold: true, size: 11 };
                            row.getCell(4).alignment = { horizontal: 'center' };
                            currentRow++;
                        }
                        
                        const finalTotalRow = worksheet.getRow(currentRow);
                        finalTotalRow.getCell(1).value = 'الإجمالي الكلي:';
                        finalTotalRow.getCell(4).value = formatNumberEnglish(selectedTotal) + ' دينار عراقي';
                        finalTotalRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        finalTotalRow.getCell(4).font = { bold: true, size: 14, color: { argb: 'FF801C32' } };
                        finalTotalRow.getCell(4).alignment = { horizontal: 'center' };
                        finalTotalRow.getCell(1).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        finalTotalRow.getCell(4).fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE8F0F5' }
                        };
                        finalTotalRow.getCell(1).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'medium', color: { argb: 'FF801C32' } },
                            right: { style: 'thin', color: { argb: 'FF801C32' } }
                        };
                        finalTotalRow.getCell(4).border = {
                            top: { style: 'medium', color: { argb: 'FF801C32' } },
                            bottom: { style: 'medium', color: { argb: 'FF801C32' } },
                            left: { style: 'thin', color: { argb: 'FF801C32' } },
                            right: { style: 'medium', color: { argb: 'FF801C32' } }
                        };
                        finalTotalRow.height = 30;
                    }
                    
                    // إنشاء الملف
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    resolve(blob);
                } catch (error) {
                    console.error('Error generating Excel with ExcelJS:', error);
                    // في حالة الخطأ، استخدم XLSX كبديل
                    generateExcelReportBlobXLSX(agentName).then(resolve).catch(reject);
                }
            });
        }
        
        // دالة بديلة باستخدام XLSX (للاحتياط)
        function generateExcelReportBlobXLSX(agentName) {
            return new Promise((resolve, reject) => {
                try {
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    
                    const reports = agentReports[agentName] || {};
                    const hasBasic = reports.basic && reports.basic.total && reports.basic.total.count > 0;
                    const hasAdvanced = reports.advanced && reports.advanced.total && reports.advanced.total.count > 0;
                    const hasTwoMonths = reports.twoMonths && reports.twoMonths.total && reports.twoMonths.total.count > 0;
                    
                    const wsData = [];
                    wsData.push([reportTitle || 'تقرير المبالغ المستحقة']);
                    wsData.push([`اسم الوكيل: ${agentName}`]);
                    
                    if (hasBasic) {
                        wsData.push(['العرض المجاني']);
                        wsData.push(['نوع الاشتراك', 'عدد الاشتراكات', 'السعر الواحد (د.ع)', 'المجموع (د.ع)']);
                        const basicData = reports.basic;
                        ['platinum', 'gold', 'silver', 'bronze'].forEach(key => {
                            const cat = basicData[key];
                            if (cat && cat.count > 0) {
                                const price = Math.round((cat.amount || 0) / cat.count);
                                wsData.push([
                                    key === 'platinum' ? 'بلاتينيوم (Platinum)' : 
                                    key === 'gold' ? 'كولد (Gold)' : 
                                    key === 'silver' ? 'سلفر (Silver)' : 'برونز (Bronze)',
                                    formatNumberEnglish(cat.count),
                                    formatNumberEnglish(price),
                                    formatNumberEnglish(cat.amount || 0)
                                ]);
                            }
                        });
                        wsData.push(['المجموع', formatNumberEnglish(basicData.total?.count || 0), '', formatNumberEnglish(basicData.total?.amount || 0)]);
                    }
                    
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet(wsData);
                    ws['!cols'] = [{ wch: 30 }, { wch: 18 }, { wch: 18 }, { wch: 18 }];
                    XLSX.utils.book_append_sheet(wb, ws, 'تقرير الوكيل');
                    const excelBlob = XLSX.write(wb, { type: 'array', bookType: 'xlsx' });
                    const blob = new Blob([excelBlob], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    resolve(blob);
                } catch (error) {
                    reject(error);
                }
            });
        }

        function generateWordReportBlob(agentName) {
            return new Promise((resolve, reject) => {
                try {
                    const reportInfo = getReportInfo(agentName);
                    const { reportType, reportData, reportTitle, agent, dateFrom, dateTo } = reportInfo;
                    const { platinumCount, platinumPrice, goldCount, goldPrice, 
                            silverCount, silverPrice, bronzeCount, bronzePrice, 
                            totalSubs, totalAmount } = calculateCategoryPricesAndCounts(reportData, reportType);
                    
                    if (typeof docx !== 'undefined') {
                        const { Document, Packer, Paragraph, Table, TableCell, TableRow, TextRun, WidthType, AlignmentType } = docx;
                        
                        const table = new Table({
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({
                                            children: [new Paragraph({ text: 'ت', alignment: AlignmentType.CENTER })],
                                            width: { size: 5, type: WidthType.PERCENTAGE }
                                        }),
                                        new TableCell({
                                            children: [new Paragraph({ text: 'اسم الوكيل', alignment: AlignmentType.CENTER })],
                                            width: { size: 20, type: WidthType.PERCENTAGE }
                                        }),
                                        new TableCell({
                                            children: [new Paragraph({ text: 'الفئة', alignment: AlignmentType.CENTER })],
                                            columnSpan: 8,
                                            width: { size: 45, type: WidthType.PERCENTAGE }
                                        }),
                                        new TableCell({
                                            children: [new Paragraph({ text: 'مجموع الاشتراكات', alignment: AlignmentType.CENTER })],
                                            width: { size: 10, type: WidthType.PERCENTAGE }
                                        }),
                                        new TableCell({
                                            children: [new Paragraph({ text: 'المبلغ الإجمالي', alignment: AlignmentType.CENTER })],
                                            width: { size: 10, type: WidthType.PERCENTAGE }
                                        }),
                                        new TableCell({
                                            children: [new Paragraph({ text: 'التاريخ', alignment: AlignmentType.CENTER })],
                                            columnSpan: 2,
                                            width: { size: 10, type: WidthType.PERCENTAGE }
                                        })
                                    ]
                                }),
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'بلاتينيوم', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'كولد', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'سلفر', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'برونز', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: '' })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'من', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'الى', alignment: AlignmentType.CENTER })] })
                                    ]
                                }),
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph({ text: '1', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: agentName + (agent?.email ? ' / ' + agent.email : '') })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'السعر', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: formatNumber(platinumPrice), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'عدد', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: String(platinumCount), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'السعر', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: formatNumber(goldPrice), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'عدد', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: String(goldCount), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'السعر', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: formatNumber(silverPrice), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'عدد', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: String(silverCount), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'السعر', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: formatNumber(bronzePrice), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: 'عدد', alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: String(bronzeCount), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: String(totalSubs), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: formatNumber(totalAmount), alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: dateFrom, alignment: AlignmentType.CENTER })] }),
                                        new TableCell({ children: [new Paragraph({ text: dateTo, alignment: AlignmentType.CENTER })] })
                                    ]
                                })
                            ],
                            width: { size: 100, type: WidthType.PERCENTAGE }
                        });
                        
                        const doc = new Document({
                            sections: [{
                                children: [
                                    new Paragraph({
                                        text: reportTitle,
                                        heading: 'Heading1',
                                        alignment: AlignmentType.CENTER,
                                        spacing: { after: 400 }
                                    }),
                                    table
                                ]
                            }]
                        });
                        
                        Packer.toBlob(doc).then(blob => {
                            resolve(blob);
                        }).catch(reject);
                    } else {
                        const htmlContent = `
                            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
                            <head>
                                <meta charset="utf-8">
                                <title>تقرير</title>
                                <style>
                                    table { border-collapse: collapse; width: 100%; direction: rtl; }
                                    th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                                    th { background-color: #ADD8E6; font-weight: bold; }
                                </style>
                            </head>
                            <body>
                                <h1 style="text-align: center; direction: rtl;">${reportTitle}</h1>
                                <table>
                                    <tr>
                                        <th>ت</th>
                                        <th>اسم الوكيل</th>
                                        <th colspan="2">بلاتينيوم</th>
                                        <th colspan="2">كولد</th>
                                        <th colspan="2">سلفر</th>
                                        <th colspan="2">برونز</th>
                                        <th>مجموع الاشتراكات</th>
                                        <th>المبلغ الإجمالي</th>
                                        <th colspan="2">التاريخ</th>
                                    </tr>
                                    <tr>
                                        <th></th>
                                        <th></th>
                                        <th>السعر</th>
                                        <th>عدد</th>
                                        <th>السعر</th>
                                        <th>عدد</th>
                                        <th>السعر</th>
                                        <th>عدد</th>
                                        <th>السعر</th>
                                        <th>عدد</th>
                                        <th></th>
                                        <th></th>
                                        <th>من</th>
                                        <th>الى</th>
                                    </tr>
                                    <tr>
                                        <td>1</td>
                                        <td>${agentName}${agent?.email ? ' / ' + agent.email : ''}</td>
                                        <td>${formatNumber(platinumPrice)}</td>
                                        <td>${platinumCount}</td>
                                        <td>${formatNumber(goldPrice)}</td>
                                        <td>${goldCount}</td>
                                        <td>${formatNumber(silverPrice)}</td>
                                        <td>${silverCount}</td>
                                        <td>${formatNumber(bronzePrice)}</td>
                                        <td>${bronzeCount}</td>
                                        <td>${totalSubs}</td>
                                        <td>${formatNumber(totalAmount)}</td>
                                        <td>${dateFrom}</td>
                                        <td>${dateTo}</td>
                                    </tr>
                                    <tr style="background-color: #C8C8C8;">
                                        <td><strong>المجموع</strong></td>
                                        <td></td>
                                        <td></td>
                                        <td>${platinumCount}</td>
                                        <td></td>
                                        <td>${goldCount}</td>
                                        <td></td>
                                        <td>${silverCount}</td>
                                        <td></td>
                                        <td>${bronzeCount}</td>
                                        <td><strong>${totalSubs}</strong></td>
                                        <td><strong>${formatNumber(totalAmount)}</strong></td>
                                        <td></td>
                                        <td></td>
                                    </tr>
                                </table>
                            </body>
                            </html>
                        `;
                        
                        const blob = new Blob(['\ufeff' + htmlContent], { type: 'application/msword' });
                        resolve(blob);
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar) {
                sidebar.classList.toggle('hidden');
                
                if (mainContent) {
                    if (sidebar.classList.contains('hidden')) {
                        mainContent.classList.add('sidebar-hidden');
                    } else {
                        mainContent.classList.remove('sidebar-hidden');
                    }
                }
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const themeIcon = document.getElementById('themeToggleIcon');
            if (themeIcon) {
                themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            const html = document.documentElement;
            html.setAttribute('data-theme', savedTheme);
            
            const themeIcon = document.getElementById('themeToggleIcon');
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadTheme();
            
            const savedDefaultPercentage = parseFloat(localStorage.getItem('defaultAgentPercentage')) || 16;
            const defaultPercentageInput = document.getElementById('defaultAgentPercentage');
            if (defaultPercentageInput) {
                defaultPercentageInput.value = savedDefaultPercentage;
            }
            
            const savedPhone = localStorage.getItem('whatsappPhone');
            const savedConnected = localStorage.getItem('whatsappConnected');
            
            if (savedPhone && savedConnected === 'true') {
                const formattedPhone = formatPhoneForWhatsApp(savedPhone);
                whatsappPhone = formattedPhone;
                whatsappConnected = true;
                
                const statusElement = document.getElementById('whatsappConnectionStatus');
                if (statusElement) {
                    statusElement.textContent = 'جاهز للإرسال';
                    statusElement.style.color = '#25D366';
                }
                
                const qrContainer = document.getElementById('whatsappQRCode');
                if (qrContainer) {
                    const whatsappLink = `https://wa.me/${formattedPhone}`;
                    
                    try {
                        new QRCode(qrContainer, {
                            text: whatsappLink,
                            width: 200,
                            height: 200,
                            colorDark: '#000000',
                            colorLight: '#ffffff',
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        
                        qrContainer.innerHTML += `<p style="margin-top: 10px; text-align: center;"><a href="${whatsappLink}" target="_blank" style="color: #25D366; text-decoration: none; font-weight: bold;"> فتح WhatsApp</a></p>`;
                    } catch (error) {
                        console.error('Error generating QR code:', error);
                        qrContainer.innerHTML = `<p style="text-align: center;"><a href="${whatsappLink}" target="_blank" style="color: #25D366; text-decoration: none; font-weight: bold; font-size: 1.1rem;">فتح WhatsApp</a></p>`;
                    }
                }
            }
        });

</script>

<div id="agentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="agentModalTitle">إضافة وكيل جديد</h3>
            <button class="modal-close" onclick="closeAgentModal()">×</button>
        </div>
        <form id="agentForm">
            <div class="form-group">
                <label>اسم الوكيل *</label>
                <input type="text" id="agentName" class="settings-input" required>
            </div>
            <div class="form-group">
                <label>رقم الهاتف (WhatsApp)</label>
                <input type="text" id="agentPhone" class="settings-input" placeholder="مثال: 07701234567">
            </div>
            <div class="form-group">
                <label>البريد الإلكتروني</label>
                <input type="email" id="agentEmail" class="settings-input" placeholder="example@email.com">
            </div>
            <div class="form-group" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(128, 28, 50, 0.1);">
                <label style="font-weight: 700; color: #801c32; margin-bottom: 15px; display: block;">أسماء الاشتراكات الخاصة بالوكيل:</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-weight: 600; color: #1a1a1a; margin-bottom: 5px; display: block;">اسم اشتراك Bronze:</label>
                        <input type="text" id="agentBronzeName" class="settings-input" placeholder="مثال: Iraqcell_Bronze_Profile">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #1a1a1a; margin-bottom: 5px; display: block;">اسم اشتراك Silver:</label>
                        <input type="text" id="agentSilverName" class="settings-input" placeholder="مثال: Iraqcell_Silver_Profile">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #1a1a1a; margin-bottom: 5px; display: block;">اسم اشتراك Gold:</label>
                        <input type="text" id="agentGoldName" class="settings-input" placeholder="مثال: Iraqcell_Gold_Profile">
                    </div>
                    <div>
                        <label style="font-weight: 600; color: #1a1a1a; margin-bottom: 5px; display: block;">اسم اشتراك Platinum:</label>
                        <input type="text" id="agentPlatinumName" class="settings-input" placeholder="مثال: Iraqcell_Platinum_Profile">
                    </div>
                </div>
                <p style="margin-top: 10px; font-size: 0.85rem; color: #666; font-weight: 600;">
                    إذا لم يتم إدخال أسماء، سيتم استخدام الأسماء الافتراضية (Iraqcell_*_Profile_NEW)
                </p>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;"> حفظ</button>
                <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeAgentModal()"> إلغاء</button>
            </div>
        </form>
    </div>
</div>

<div id="messageCustomizationModal" class="modal">
    <div class="modal-content message-customization">
        <div class="modal-header">
            <h3> تخصيص رسالة واتساب</h3>
            <button class="modal-close" onclick="closeMessageCustomizationModal()">×</button>
        </div>
        <div style="padding: 10px 0;">
            <p style="margin-bottom: 20px; color: #1a1a1a; text-align: right; font-weight: 600;">
                <strong>الوكيل:</strong> <span id="customMessageAgentName" data-agent=""></span>
            </p>

            <div class="form-group">
                <label> نص الرسالة:</label>
                <textarea id="customMessageText" class="message-textarea" placeholder="اكتب رسالتك هنا..."></textarea>
                <p style="margin-top: 5px; font-size: 0.85rem; color: #1a1a1a; font-weight: 600;">
                </p>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn btn-success" style="flex: 1;" onclick="sendCustomizedWhatsAppMessage()"> إرسال عبر WhatsApp</button>
                <button type="button" class="btn btn-danger" style="flex: 1;" onclick="closeMessageCustomizationModal()"> إلغاء</button>
            </div>
        </div>
    </div>
</div>

<div id="popupOverlay" class="popup-overlay" onclick="closeAuthorInfo()"></div>
<div id="authorInfoPopup" class="author-info-popup">
    <button class="popup-close" onclick="closeAuthorInfo()" title="إغلاق">×</button>
    <div class="popup-header">
        <h2>معلومات التواصل</h2>
    </div>
    <div class="popup-content">
        <div class="info-item">
            <button class="info-action" onclick="copyToClipboard('Ameer Helwas', 'الاسم')" title="نسخ الاسم">نسخ</button>
            <span class="info-value">Ameer Helwas</span>
            <span class="info-text">الاسم:</span>
            <span class="info-icon">👨‍💻</span>
        </div>
        <div class="info-item">
            <button class="info-action" onclick="copyToClipboard('ameeralgaraawi@hotmail.com', 'البريد')" title="نسخ البريد الإلكتروني">نسخ</button>
            <span class="info-value">ameeralgaraawi@hotmail.com</span>
            <span class="info-text">البريد الإلكتروني:</span>
            <span class="info-icon">📧</span>
        </div>
        <div class="info-item">
            <button class="info-action" onclick="copyToClipboard('07701024143', 'الهاتف')" title="نسخ رقم الهاتف">نسخ</button>
            <span class="info-value">+9647701024143</span>
            <span class="info-text">الهاتف:</span>
            <span class="info-icon">📱</span>
        </div>
        <div class="info-item">
            <span class="info-value">عراق سيل للإتصالات</span>
            <span class="info-text">الشركة:</span>
            <span class="info-icon">🏢</span>
        </div>
    </div>
</div>

</body>
</html>
