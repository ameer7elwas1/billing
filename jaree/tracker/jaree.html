<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ </title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&family=Tajawal:wght@400;700;900&display=swap');
        :root {
            --primary-gradient: linear-gradient(135deg, #2196f3 0%, #1565c0 100%);
            --admin-gradient: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
            --user-gradient: linear-gradient(135deg, #64b5f6 0%, #1976d2 100%);
            --alert-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --bg-color: #f4faff;
            --card-bg: #ffffff;
            --text-color: #1a1a1a;
            --text-secondary: #1976d2;
            --border-color: #2196f3;
            --shadow: 0 10px 25px -5px rgba(33, 150, 243, 0.08), 0 10px 10px -5px rgba(33, 150, 243, 0.04);
            --hover-shadow: 0 20px 25px -5px rgba(33, 150, 243, 0.13), 0 10px 10px -5px rgba(33, 150, 243, 0.07);
            --accent: #1565c0;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #2196f3;
            --checkin-color: #10b981;
            --checkout-color: #ef4444;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f5f7fa;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --hover-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --accent: #8b5cf6;
            --success: #22c55e;
            --danger: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* ÿ™ÿµÿ∫Ÿäÿ± ÿ≠ÿ¨ŸÖ ÿßŸÑÿ±ŸÖŸàÿ≤ ÿßŸÑÿ™ÿπÿ®Ÿäÿ±Ÿäÿ© ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ - ÿ™ŸàŸÅŸäÿ± ŸÖÿ≥ÿßÿ≠ÿ© ÿ£ŸÉÿ®ÿ± */
        h1, h2, h3 {
            font-size: 1.2em !important;
            line-height: 1.2;
            margin-bottom: 8px !important;
        }

        .stat-card {
            font-size: 0.9em !important;
        }

        .item-card, .location-card {
            font-size: 0.85em;
        }

        .section-title, .section-header {
            font-size: 1em;
            margin-bottom: 12px !important;
        }

        button, .btn, .quick-link {
            font-size: 0.85em;
            padding: 8px 12px !important;
        }

        .log-entry {
            font-size: 0.9em;
            padding: 10px !important;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© */
        * {
            margin-top: 0;
            margin-bottom: 0;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸÅŸä ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™ */
        .stat-card, .item-card, .location-card {
            margin-bottom: 12px !important;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸÅŸä ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ */
        .section {
            padding: 16px 20px !important;
            margin-bottom: 16px !important;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸÅŸä ÿßŸÑÿ≠ÿßŸàŸäÿßÿ™ */
        .dashboard-container {
            padding: 12px 16px !important;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .top-bar {
            padding: 12px 18px !important;
            margin-bottom: 14px !important;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸÅŸä ÿßŸÑŸÜŸÖÿßÿ∞ÿ¨ */
        .form-group {
            margin-bottom: 14px !important;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸÅŸä ÿßŸÑŸÇŸàÿßÿ¶ŸÖ */
        .item-card {
            padding: 14px 16px !important;
            margin-bottom: 10px !important;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸÅŸä ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± */
        .btn {
            padding: 8px 14px !important;
            margin: 4px !important;
        }

        /* ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑŸÖÿ≥ÿßŸÅÿßÿ™ ŸÅŸä ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ */
        .notification {
            padding: 12px 16px !important;
            margin-bottom: 8px !important;
        }

        body {
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            font-size: 0.97rem;
            line-height: 1.7;
            transition: all 0.3s ease;
        }

        /* Enhanced Notification System */
        .notifications {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 2000;
            max-width: 420px;
        }

        .notification {
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow);
            font-size: 0.97em;
            border-left: 5px solid rgba(255,255,255,0.3);
        }

        .notification.success { background: var(--success-gradient); color: #064e3b; font-weight: 600; }
        .notification.warning { background: var(--warning-gradient); color: #92400e; font-weight: 600; }
        .notification.info { background: var(--primary-gradient); color: #ffffff; font-weight: 600; }
        .notification.error { background: var(--alert-gradient); color: #7f1d1d; font-weight: 600; }

        /* Loading Bar */
        .loading-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: var(--primary-gradient);
            z-index: 3000;
            transition: width 0.3s ease;
            box-shadow: 0 2px 8px rgba(67, 206, 162, 0.3);
        }

        .loading-bar.active {
            width: 100%;
        }

        /* Enhanced Tooltips */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-color);
            color: var(--card-bg);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 1000;
            box-shadow: var(--shadow);
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Enhanced Login Card */
        .login-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important; /* Green gradient */
            color: #fff !important;
            border: 3px solid #059669 !important;
            font-weight: bold !important;
            font-size: 1.15em !important;
            box-shadow: 0 8px 32px 0 rgba(33, 150, 243, 0.18) !important;
            padding: 32px 24px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .login-card h1 {
            color: #fff !important;
            font-size: 1.5em !important;
            font-weight: 900 !important;
            text-shadow: 0 2px 8px #1565c033;
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 24px;
            text-align: right;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: var(--accent);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 12px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--card-bg);
            color: var(--text-color);
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.07);
            font-size: 0.97em;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.13);
            background: var(--card-bg);
        }

        .btn {
            background: var(--primary-gradient);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            width: 100%;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.13);
        }

        .btn:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: var(--hover-shadow);
            background: var(--accent);
            color: white;
        }

        .btn-small {
            padding: 8px 18px;
            font-size: 13px;
            width: auto;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-admin {
            background: var(--admin-gradient);
        }

        .btn-user {
            background: var(--user-gradient);
        }

        /* Dashboard Layout */
        .dashboard-container {
            max-width: 1700px;
            margin: 0 auto;
            padding: 16px 12px;
        }

        .top-bar {
            background: var(--card-bg);
            padding: 16px 24px;
            border-radius: 22px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section h1 {
            color: var(--accent);
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-badge {
            padding: 8px 14px;
            border-radius: 18px;
            font-size: 0.97em;
            font-weight: bold;
            color: white;
            background: var(--accent);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.13);
        }

        .user-badge.admin {
            background: var(--admin-gradient);
        }

        .user-badge.user {
            background: var(--user-gradient);
        }

        .theme-toggle {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 50%;
            width: 38px;
            height: 38px;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.13);
        }

        .theme-toggle:hover {
            transform: scale(1.12);
            background: var(--accent);
            color: white;
        }

        /* Enhanced Stats Grid with Center Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: linear-gradient(135deg, #8f94fb 0%, #4e54c8 100%) !important;
            color: #fff !important;
            border: 3px solid #4e54c8 !important;
            font-weight: bold !important;
            font-size: 1em !important;
            box-shadow: 0 8px 32px 0 rgba(76, 81, 241, 0.18) !important;
            padding: 28px 22px;
            border-radius: 22px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .stat-card .stat-number {
            font-size: 1.8em !important;
            font-weight: 900 !important;
            color: #fff !important;
            margin-bottom: 12px;
            display: block;
            letter-spacing: 1px;
        }
        /* Unique colors for each stat card */
        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%) !important; /* Orange */
            color: #fff !important;
            border: 3px solid #ff9800 !important;
        }
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #00bcd4 0%, #2196f3 100%) !important; /* Blue */
            color: #fff !important;
            border: 3px solid #00bcd4 !important;
        }
        .stat-card.checkin-stat, .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important; /* Green */
            color: #fff !important;
            border: 3px solid #10b981 !important;
        }
        .stat-card.checkout-stat, .stat-card:nth-child(4) {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important; /* Red */
            color: #fff !important;
            border: 3px solid #ef4444 !important;
        }
        .stat-card.centers-stat, .stat-card:nth-child(5) {
            background: linear-gradient(135deg, #7f53ac 0%, #647dee 100%) !important; /* Purple/Blue */
            color: #fff !important;
            border: 3px solid #7f53ac !important;
        }
        .stat-label {
            font-size: 0.97em;
            opacity: 0.97;
            color: #fff;
            text-shadow: 0 1px 2px #0008;
        }

        .stat-card:hover {
            transform: translateY(-7px) scale(1.04);
            box-shadow: var(--hover-shadow);
            border-color: var(--accent);
        }

        .stat-card.checkin-stat {
            background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%);
            color: #004d40;
            border: 2px solid #4dd0e1;
            font-weight: bold;
            text-shadow: 0 1px 2px #fff8, 0 0 2px #0002;
        }

        .stat-card.checkout-stat {
            background: linear-gradient(135deg, #fff3e0 0%, #ffb74d 100%);
            color: #bf360c;
            border: 2px solid #ffb74d;
            font-weight: bold;
            text-shadow: 0 1px 2px #fff8, 0 0 2px #0002;
        }

        .stat-card.centers-stat {
            background: linear-gradient(135deg, #e8f5e9 0%, #a5d6a7 100%);
            color: #1b5e20;
            border: 2px solid #66bb6a;
            font-weight: bold;
            text-shadow: 0 1px 2px #fff8, 0 0 2px #0002;
        }

        .stat-card.active-users-stat {
            background: linear-gradient(135deg, #f3e5f5 0%, #ce93d8 100%);
            color: #4a148c;
            border: 2px solid #ba68c8;
            font-weight: bold;
            text-shadow: 0 1px 2px #fff8, 0 0 2px #0002;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 370px 1fr;
            gap: 14px;
            margin-bottom: 24px;
            position: relative;
        }

        .sidebar {
            background: var(--card-bg);
            border-radius: 22px;
            padding: 28px 22px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            min-width: 340px;
            max-width: 370px;
            transition: all 0.3s;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        /* Enhanced Map Container */
        .map-container {
            background: var(--card-bg);
            border-radius: 22px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            margin-bottom: 24px;
            position: relative;
        }

        .map-header {
            padding: 14px 18px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .map-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .map-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .map-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .map-btn.style-toggle {
            background: linear-gradient(135deg, #6c757d, #495057);
        }

        #map {
            height: 550px;
            border-radius: 0 0 20px 20px;
            position: relative;
        }

        /* Fullscreen Map Styles */
        .map-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            border-radius: 0 !important;
        }

        .map-fullscreen .mapboxgl-control-container {
            z-index: 10000 !important;
        }

        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9998;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .fullscreen-controls {
            position: absolute;
            top: 5px;
            left: 20px;
            z-index: 10001;
            display: flex;
            gap: 10px;
        }

        .fullscreen-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .fullscreen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        .fullscreen-btn.exit {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Enhanced Data Sections */
        .data-section {
            background: var(--card-bg);
            border-radius: 22px;
            padding: 28px 22px;
            box-shadow: var(--shadow);
            border: 2px solid var(--border-color);
            margin-bottom: 28px;
            color: var(--text-color);
        }

        .section-title {
            color: var(--accent);
            margin-bottom: 24px;
            font-size: 1.2em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        /* Enhanced search for employee movements */
        .movement-search {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .movement-search input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
        }

        /* Sidebar sections */
        .sidebar-section {
            margin-bottom: 24px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-header {
            background: var(--primary-gradient);
            color: #fff;
            border-bottom: 1px solid var(--border-color);
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 0.97em;
            transition: all 0.3s;
        }

        .section-header:hover {
            background: var(--accent);
        }

        .section-header .toggle-icon {
            font-size: 1.3em;
            transition: transform 0.3s;
        }

        .section-header.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .section-content {
            padding: 24px;
            background: var(--card-bg);
            max-height: 1000px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 24px;
        }

        .section-tip {
            background: var(--info);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 18px;
            font-size: 1em;
        }

        .permission-warning {
            background: var(--warning);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 18px;
            font-size: 1em;
            border-left: 4px solid #ffc107;
        }

        /* Enhanced Location Display for 10k+ employees */
        .location-card {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%) !important;
            color: #1e3a8a !important;
            border: 2px solid #6366f1 !important;
            font-weight: 600 !important;
            font-size: 0.85em !important;
            box-shadow: 0 4px 12px 0 rgba(99, 102, 241, 0.15) !important;
            border-radius: 10px;
            padding: 10px 12px;
            margin-bottom: 8px;
            transition: all 0.3s;
        }
        .location-card strong {
            color: #1e3a8a !important;
            font-size: 0.9em !important;
            font-weight: 700 !important;
        }
        .location-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px 0 rgba(99, 102, 241, 0.25) !important;
        }

        .employee-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.75em;
            font-weight: bold;
            margin-right: 6px;
        }

        .employee-status.active {
            background: var(--success);
            color: white;
        }

        .employee-status.inactive {
            background: var(--danger);
            color: white;
        }

        .employee-status.moving {
            background: var(--warning);
            color: white;
            animation: pulse 2s infinite;
        }

        /* Pagination for large datasets */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pagination button:hover {
            background: var(--accent);
            color: white;
        }

        .pagination button.active {
            background: var(--accent);
            color: white;
        }

        /* Virtual scrolling container for performance */
        .virtual-list {
            height: 500px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 10px;
        }

        /* Enhanced Logs with better color coding */
        .logs-container {
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            padding: 18px;
            background: var(--card-bg);
        }

        .log-entry {
            padding: 14px 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            font-size: 0.95em;
            border-right: 5px solid;
            position: relative;
            transition: all 0.3s;
        }

        .log-entry:hover {
            transform: translateX(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .log-entry.checkin, .log-entry.auto_checkin, .log-entry.in, .log-entry.center_entry {
            background: linear-gradient(90deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
            color: var(--checkin-color);
            border-right-color: var(--checkin-color);
        }

        .log-entry.checkout, .log-entry.auto_checkout, .log-entry.out {
            background: linear-gradient(90deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%);
            color: var(--checkout-color);
            border-right-color: var(--checkout-color);
        }

        .log-entry.user_login, .log-entry.account_login {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            color: #3b82f6;
            border-right-color: #3b82f6;
        }

        .log-entry.center_nearby, .log-entry.movement {
            background: linear-gradient(90deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
            color: var(--warning);
            border-right-color: var(--warning);
        }

        .log-entry.location_update {
            background: linear-gradient(90deg, rgba(108, 117, 125, 0.1) 0%, rgba(108, 117, 125, 0.05) 100%);
            color: var(--text-secondary);
            border-right-color: var(--text-secondary);
        }

        .log-meta {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }

        /* Search Section */
        .search-section {
            display: grid;
            grid-template-columns: 1fr 1fr auto auto;
            gap: 12px;
            margin-bottom: 24px;
        }

        .search-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.97em;
        }

        .locate-btn {
            background: var(--success);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 18px;
            cursor: pointer;
            font-size: 0.97em;
            font-weight: bold;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .locate-btn:hover {
            background: #219150;
            transform: translateY(-1px);
        }

        /* Enhanced Item Cards for performance */
        .item-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%) !important;
            color: #0d223a !important;
            border: 3px solid #10b981 !important;
            font-weight: bold !important;
            font-size: 1.1em !important;
            box-shadow: 0 8px 32px 0 rgba(16, 185, 129, 0.18) !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            margin-bottom: 10px;
            border-radius: 12px;
            transition: all 0.25s;
        }
        .item-card:hover {
            transform: translateX(-4px) scale(1.01);
            box-shadow: var(--hover-shadow);
            border-left-color: var(--accent);
        }

        .item-info {
            flex: 1;
        }

        .item-info strong {
            color: #0d223a !important;
            font-size: 1em !important;
            font-weight: 900 !important;
        }

        .item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Center statistics on map markers */
        .marker-popup {
            font-family: 'Cairo', Arial, sans-serif;
            direction: rtl;
            text-align: right;
        }

        .center-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .stat-item {
            text-align: center;
            padding: 5px;
        }

        .stat-item.checkin-stat {
            color: var(--checkin-color);
        }

        .stat-item.checkout-stat {
            color: #3b82f6;
        }

        /* Connection Status */
        .connection-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--success);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            box-shadow: var(--shadow);
            z-index: 1000;
        }

        .connection-indicator.offline {
            background: var(--warning);
            color: #000;
        }

        .connection-indicator.error {
            background: var(--danger);
        }

        /* Auto refresh indicator */
        .refresh-indicator {
            position: fixed;
            bottom: 70px;
            left: 20px;
            background: var(--info);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .refresh-indicator.visible {
            opacity: 1;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 20px auto;
            padding: 24px;
            border-radius: 18px;
            width: 90%;
            max-width: 850px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* ÿ™ŸÜÿ≥ŸäŸÇ ÿÆÿßÿµ ŸÑŸÑŸÜŸàÿßŸÅÿ∞ - ÿ¨ÿπŸÑ ÿßŸÑÿ≠ŸÇŸàŸÑ ŸÅŸä ÿµŸÅŸäŸÜ */
        .modal-content {
            display: flex;
            flex-direction: column;
        }

        /* ÿ™ÿÆÿ∑Ÿäÿ∑ grid ŸÑŸÑÿ≠ŸÇŸàŸÑ ŸÅŸä ÿßŸÑŸÜŸàÿßŸÅÿ∞ */
        .modal-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 10px;
        }

        .modal-form-grid .form-group {
            margin-bottom: 0;
        }

        /* ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑÿµÿ∫Ÿäÿ±ÿ©ÿå ŸÜÿπŸàÿØ ŸÑÿπŸÖŸàÿØ Ÿàÿßÿ≠ÿØ */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 20px;
            }
            .modal-form-grid {
                grid-template-columns: 1fr;
            }
        }

        .close {
            color: var(--text-secondary);
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--accent);
        }

        /* Loading state */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading::before {
            content: "";
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        /* Animations */
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .search-section {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .map-controls {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .top-bar {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-section {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .notifications {
                left: 10px;
                right: 10px;
                max-width: none;
            }

            .map-controls {
                flex-direction: column;
                gap: 5px;
            }

            .item-card {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }

            .section-title {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            .login-card, .stat-card, .item-card, .location-card {
                font-size: 1em !important;
            }
            .stat-card .stat-number, .item-card strong, .location-card strong {
                font-size: 1.1em !important;
            }
        }

        /* Quick Links Sidebar */
        .quick-links {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .quick-links h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .quick-link {
            display: block;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: var(--primary-gradient);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .quick-link:hover {
            transform: translateX(-3px);
            box-shadow: var(--hover-shadow);
        }

        /* Enhanced Security - Hidden Phone Numbers */
        .phone-masked {
            cursor: pointer;
            user-select: none;
        }

        .phone-masked.revealed {
            user-select: text;
        }

        /* Enhanced Date Formatting */
        .date-formatted {
            font-family: 'Tajawal', sans-serif;
            direction: ltr;
            text-align: center;
        }

        /* Advanced Search Section */
        .advanced-search {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .advanced-search h3 {
            color: var(--accent);
            margin-bottom: 15px;
        }

        .search-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 0.9em;
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .export-btn.pdf {
            background: #dc3545;
            color: white;
        }

        .export-btn.excel {
            background: #28a745;
            color: white;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* ===== ÿ™ÿ≠ÿ≥ŸäŸÜ ÿπÿ±ÿ∂ ŸÖÿ±ÿ®ÿπÿßÿ™ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ŸÅŸä ÿßŸÑŸÖŸàÿØÿßŸÑ ===== */
        #userPermissionsForm .form-group {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            margin-bottom: 18px;
            background: #f7fafd;
            border-radius: 8px;
            padding: 8px 12px;
        }
        #userPermissionsForm label {
            flex: 1;
            text-align: right;
            font-size: 1.05em;
            color: var(--accent);
            margin: 0;
        }
        #userPermissionsForm input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--accent);
        }

        /* ===== ÿ™ÿ≠ÿ≥ŸäŸÜ ŸÖÿ∏Ÿáÿ± select ŸÖÿ™ÿπÿØÿØ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ŸÑŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ© ===== */
        select[multiple].center-select {
            height: 70px;
            font-size: 0.88em;
            border-radius: 8px;
            padding: 7px;
            background: var(--card-bg);
            color: var(--text-color);
            border: 1.5px solid var(--border-color);
            min-width: 120px;
            max-width: 100%;
            outline: none;
            line-height: 1.3;
            transition: border-color 0.2s;
        }
        select[multiple].center-select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(67, 206, 162, 0.13);
        }
        select[multiple].center-select option {
            padding: 4px 8px;
            font-size: 0.95em;
        }
        select[multiple].center-select option:checked {
            background: var(--primary-gradient);
            color: #fff;
        }

        /* ÿ™ÿÆÿµŸäÿµ ÿ£ŸÑŸàÿßŸÜ Select2 ŸÑŸÑŸÇŸàÿßÿ¶ŸÖ ÿßŸÑÿØÿßŸÉŸÜÿ© */
        .section-header.section-header-center {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .section-header.section-header-employee {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .section-header.section-header-location {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .section-header.section-header-connection {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .section-header.section-header-user {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }
        .section-header.section-header-userslist {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        .section-header.section-header-backup {
            background: var(--primary-gradient);
            color: white;
        }

        .backup-status {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .status-value {
            color: var(--text-color);
            font-weight: bold;
        }

        .backup-controls {
            margin-bottom: 15px;
        }

        .backup-settings {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #dee2e6;
        }

        .backup-settings h4 {
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 1em;
        }

        .backup-settings .form-group {
            margin-bottom: 10px;
        }

        .backup-settings label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: var(--text-color);
        }

        .backup-settings input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .backup-settings input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .backup-list-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .backup-list-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .backup-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .backup-item.latest {
            border-color: #28a745;
            background: #f8fff8;
        }

        .backup-info h4 {
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .backup-info p {
            margin: 0;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .backup-actions {
            display: flex;
            gap: 5px;
        }

        .backup-actions .btn {
            padding: 5px 10px;
            font-size: 0.8em;
        }
        .select2-container--default .select2-selection--multiple {
            background: var(--card-bg, #23272e);
            color: #fff;
            border-radius: 8px;
            border: 1.5px solid var(--border-color, #444);
            min-height: 38px;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: #3a3f47;
            color: #fff;
            border: 1px solid #555;
        }
        .select2-container--default .select2-results__option {
            color: #fff;
            background: #23272e;
        }
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: #4facfe;
            color: #fff;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: #ffb3b3;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            color: #fff;
        }
        .select2-container--default .select2-search--inline .select2-search__field {
            color: #fff;
        }

        [data-theme="dark"] .data-section,
        [data-theme="dark"] .sidebar-section,
        [data-theme="dark"] .map-container,
        [data-theme="dark"] .location-card {
            background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%) !important;
            color: #c7d2fe !important;
            border-color: #818cf8 !important;
        }
        [data-theme="dark"] .location-card strong {
            color: #c7d2fe !important;
        }
        [data-theme="dark"] .location-card,
        [data-theme="dark"] .logs-container,
        [data-theme="dark"] .stat-card,
        [data-theme="dark"] .login-card,
        [data-theme="dark"] .top-bar,
        [data-theme="dark"] .sidebar {
            border: 3px solid #2196f3 !important;
            box-shadow: 0 4px 24px 0 rgba(33, 150, 243, 0.18);
        }
    </style>
    <script>
    (function() {
        const modal = document.getElementById('editUserPermissionsModal');
        const header = modal?.querySelector('.modal-header');
        let isDragging = false, startX, startY, startLeft, startTop;

        if (header && modal) {
            header.style.cursor = 'move';
            header.onmousedown = function(e) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                const rect = modal.querySelector('.modal-content').getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                document.body.style.userSelect = 'none';
            };
            document.onmousemove = function(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                const modalContent = modal.querySelector('.modal-content');
                modalContent.style.position = 'fixed';
                modalContent.style.left = (startLeft + dx) + 'px';
                modalContent.style.top = (startTop + dy) + 'px';
                modalContent.style.margin = '0';
            };
            document.onmouseup = function() {
                isDragging = false;
                document.body.style.userSelect = '';
            };
        }
    })();
    </script>
</head>
<body data-theme="light">
    <!-- Loading Bar -->
    <div class="loading-bar" id="loadingBar"></div>

    <!-- Notifications Container -->
    <div class="notifications" id="notifications"></div>

    <!-- Connection Status Indicator -->
    <div class="connection-indicator" id="connectionIndicator">
        üü¢ ŸÖÿ™ÿµŸÑ
    </div>

    <!-- Auto Refresh Indicator -->
    <div class="refresh-indicator" id="refreshIndicator">
        üîÑ ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...
    </div>

    <!-- Login Screen -->
    <div class="login-container" id="loginScreen" style="display: flex; min-height: 100vh; align-items: center; justify-content: center;">
        <div class="login-card">
            <h1>üîê ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h1>
            <p style="margin-bottom: 30px; color: var(--text-secondary);"></p>
            
            <div class="form-group">
                <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                <input type="text" id="loginUsername" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ">
            </div>
            
            <div class="form-group">
                <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                <input type="password" id="loginPassword" placeholder="ÿ£ÿØÿÆŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±">
            </div>
            
            <button class="btn" onclick="login()">ÿØÿÆŸàŸÑ</button>
            
            <div style="margin-top: 20px; padding: 15px; background: var(--info); color: white; border-radius: 10px; font-size: 0.9em;">
                <strong></strong><br>
                <br>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard-container" id="dashboard" style="display: none;">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="logo-section">
                <h1>üéõÔ∏è ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ  </h1>
                <p style="color: var(--text-secondary);"><span style="color: var(--success);">‚óè</span></p>
            </div>
            
            <div class="user-section">
                <div class="user-badge" id="userRoleBadge">ŸÖÿ≥ÿ™ÿÆÿØŸÖ</div>
                <span id="welcomeMessage">ŸÖÿ±ÿ≠ÿ®ÿßŸã</span>
                <button class="theme-toggle" onclick="toggleTheme()" title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ≥ŸÖÿ©">üåô</button>
                <button class="btn btn-danger btn-small" onclick="logout()">ÿÆÿ±Ÿàÿ¨</button>
            </div>
        </div>

        <!-- Enhanced Statistics Dashboard with Center Statistics -->
        <div class="stats-grid">
            <div class="stat-card" onclick="focusOnEmployees()" title="ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ">
                <span class="stat-number" id="totalEmployees">0</span>
                <div class="stat-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</div>
            </div>
            <div class="stat-card" onclick="focusOnActiveEmployees()" title="ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ">
                <span class="stat-number" id="activeEmployees">0</span>
                <div class="stat-label">ÿßŸÑÿ£ŸÅÿ±ÿßÿØ ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ</div>
            </div>
            <div class="stat-card checkin-stat" onclick="focusOnCheckedIn()" title="ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿ¨ŸÑŸäŸÜ ÿ≠ÿ∂Ÿàÿ±ŸáŸÖ">
                <span class="stat-number" id="checkedInEmployees">0</span>
                <div class="stat-label"> ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ</div>
            </div>
            <div class="stat-card checkout-stat" onclick="focusOnCheckedOut()" title="ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≥ÿ¨ŸÑŸäŸÜ ÿÆÿ±Ÿàÿ¨ŸáŸÖ ŸÖŸÜ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤">
                <span class="stat-number" id="checkedOutEmployees">0</span>
                <div class="stat-label">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ </div>
            </div>
            <div class="stat-card centers-stat" onclick="focusOnCenters()" title="ÿßŸÜŸÇÿ± ŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤">
                <span class="stat-number" id="centersCount">0</span>
                <div class="stat-label">ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤</div>
            </div>
        </div>

        <!-- Enhanced Search Section -->
        <div class="search-section">
            <button class="locate-btn tooltip" onclick="locateMe()" data-tooltip="ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©">üìç ŸÖŸàŸÇÿπŸä</button>
            <button class="locate-btn tooltip" onclick="refreshAll()" data-tooltip="ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>
        </div>

        <!-- Main Layout with Sidebar -->
        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Quick Links -->
                <div class="quick-links">
                    <h3>üîó ÿ±Ÿàÿßÿ®ÿ∑ ÿ≥ÿ±Ÿäÿπÿ©</h3>
                    <a href="#employeesList" class="quick-link" onclick="scrollToSection('employeesList')">üë• ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</a>
                    <a href="#centersList" class="quick-link" onclick="scrollToSection('centersList')">üè¢ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤</a>
                    <a href="#employeeLocations" class="quick-link" onclick="scrollToSection('employeeLocations')">üìç ÿßŸÑŸÖŸàÿßŸÇÿπ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©</a>
                    <a href="#activityLogs" class="quick-link" onclick="scrollToSection('activityLogs')">üìã ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©</a>
                </div>

                <div class="sidebar-section" id="addCenterSection">
                    <div class="section-header section-header-center" onclick="toggleSection('centerSection')">
                        <span>üè¢ ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ±ŸÉÿ≤ ÿ¨ÿØŸäÿØ</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content collapsed" id="centerSection">
                        <div class="section-tip">
                            üí° ÿßŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ
                        </div>
                        
                        <div class="form-group">
                            <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤</label>
                            <input type="text" id="centerName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤">
                        </div>
                        <div class="form-group">
                            <label>ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™</label>
                            <input type="text" id="centerCoordinates" placeholder="ŸÖÿ´ÿßŸÑ: 32.53843, 44.184436">
                        </div>
                        <div class="form-group">
                            <label>ŸÜÿ∑ÿßŸÇ ÿßŸÑŸÖÿ±ŸÉÿ≤ (ŸÖÿ™ÿ±)</label>
                            <input type="number" id="centerRadius" value="100" placeholder="100">
                        </div>
                        <button class="btn" onclick="addCenter()">ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ±ŸÉÿ≤</button>
                    </div>
                </div>

                <!-- Add Employee Section -->
                <div class="sidebar-section" id="addEmployeeSection">
                    <div class="section-header section-header-employee" onclick="toggleSection('employeeSection')">
                        <span>üë§ ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ ÿ¨ÿØŸäÿØ</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content collapsed" id="employeeSection">
                        <div class="permission-warning" id="employeePermissionWarning" style="display: none;">
                            ‚ö†Ô∏è ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÅÿ±ÿßÿØ ŸÅŸä ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ© ŸÑŸÉ ŸÅŸÇÿ∑
                        </div>
                        
                        <div class="form-group">
                            <label>ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ±ÿØ</label>
                            <input type="text" id="employeeName" placeholder="ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ±ÿØ">
                        </div>
                        <div class="form-group">
                            <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                            <input type="text" id="employeePhone" placeholder="ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ">
                        </div>
                        <div class="form-group">
                            <label>ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±</label>
                            <input type="password" id="employeePassword" placeholder="ŸÉŸÑŸÖÿ© ŸÖÿ±Ÿàÿ± ŸÇŸàŸäÿ©">
                        </div>
                        <div class="form-group">
                            <label> ÿßŸÑŸÖŸÜÿµÿ®</label>
                            <input type="text" id="employeePosition" placeholder=": ÿßÿÆÿ™Ÿäÿßÿ±Ÿä ...">
                        </div>
                        <div class="form-group">
                            <label>ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑŸÖÿÆÿµÿµ</label>
                            <select id="employeeCenter">
                                <option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±ŸÉÿ≤</option>
                            </select>
                        </div>
                        <button class="btn" onclick="addEmployee()">ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ±ÿØ</button>
                    </div>
                </div>

                        <!-- Backup System Section - Only for Admin -->
                        <div class="sidebar-section" id="backupSystemSection" style="display: none;">
                            <div class="section-header section-header-backup" onclick="toggleSection('backupSystemContent')">
                                <span>üíæ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä (ŸÖÿØŸäÿ± ŸÅŸÇÿ∑)</span>
                                <span class="toggle-icon">‚ñº</span>
                            </div>
                            <div class="section-content collapsed" id="backupSystemContent">
                                <div class="backup-status" id="backupStatus">
                                    <div class="status-item">
                                        <span class="status-label">ÿßŸÑÿ≠ÿßŸÑÿ©:</span>
                                        <span class="status-value" id="backupStatusValue">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">ÿ¢ÿÆÿ± ŸÜÿ≥ÿÆÿ©:</span>
                                        <span class="status-value" id="lastBackupTime">--</span>
                                    </div>
                                    <div class="status-item">
                                        <span class="status-label">ÿπÿØÿØ ÿßŸÑŸÜÿ≥ÿÆ:</span>
                                        <span class="status-value" id="totalBackups">0</span>
                                    </div>
                                </div>

                                <div class="backup-controls">
                                    <button class="btn btn-success" onclick="createManualBackup()" style="width: 100%; margin-bottom: 10px;">
                                        üîÑ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                                    </button>

                                    <button class="btn btn-warning" onclick="showBackupList()" style="width: 100%; margin-bottom: 10px;">
                                        üìã ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©
                                    </button>

                                    <button class="btn btn-info" onclick="toggleAutoBackup()" style="width: 100%; margin-bottom: 10px;">
                                        ‚öôÔ∏è ÿ™ŸÅÿπŸäŸÑ/ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
                                    </button>

                                    <button class="btn btn-danger" onclick="cleanOldBackups()" style="width: 100%;">
                                        üßπ ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑŸÇÿØŸäŸÖÿ©
                                    </button>

                                    <button class="btn btn-warning" onclick="showClearLogsOptions()" style="width: 100%; margin-top: 10px;">
                                        üóëÔ∏è ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
                                    </button>
                                </div>

                                <div class="backup-settings">
                                    <h4>‚öôÔ∏è ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</h4>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="autoSaveOnChange" checked>
                                            ÿ≠ŸÅÿ∏ ÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label>
                                            <input type="checkbox" id="includeLogs" checked>
                                            ÿ™ÿ∂ŸÖŸäŸÜ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label>ŸÅÿ™ÿ±ÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä (ÿ´ŸàÿßŸÜŸä):</label>
                                        <input type="number" id="backupInterval" value="30" min="1" step="1">
                                        <small style="color: #6c757d; font-size: 0.85em; display: block; margin-top: 5px;">
                                            ŸäŸÖŸÉŸÜŸÉ ÿ•ÿØÿÆÿßŸÑ ÿ£Ÿä ŸÇŸäŸÖÿ© (ÿ´ŸàÿßŸÜŸäÿå ÿØŸÇÿßÿ¶ŸÇÿå ÿ≥ÿßÿπÿßÿ™ÿå ÿ£ŸäÿßŸÖ)
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                <!-- Location Settings Section -->
                <div class="sidebar-section" id="locationSettingsSection">
                    <div class="section-header section-header-location" onclick="toggleSection('locationSettingsContent')">
                        <span>‚öôÔ∏è ÿ•ÿπÿØÿßÿØÿßÿ™ ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content collapsed" id="locationSettingsContent">
                        <div class="form-group">
                            <label for="minAccuracy">ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿØŸÇÿ© (ŸÖÿ™ÿ±)</label>
                            <input type="number" id="minAccuracy" />
                        </div>
                        <div class="form-group">
                            <label for="maxAccuracy">ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ ŸÑŸÑÿØŸÇÿ© (ŸÖÿ™ÿ±)</label>
                            <input type="number" id="maxAccuracy" />
                        </div>
                        <div class="form-group">
                            <label for="locationTimeout">ŸÖŸáŸÑÿ© ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ (ÿ´ŸàÿßŸÜŸä)</label>
                            <input type="number" id="locationTimeout" />
                        </div>
                        <div class="form-group">
                            <label for="retryAttempts">ÿπÿØÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™</label>
                            <input type="number" id="retryAttempts" />
                        </div>
                        <div class="form-group">
                            <label for="accuracyBuffer">ŸáÿßŸÖÿ¥ ÿßŸÑÿØŸÇÿ© (ŸÖÿ™ÿ±)</label>
                            <input type="number" id="accuracyBuffer" />
                        </div>
                        <button class="btn" onclick="updateLocationSettings()">ÿ≠ŸÅÿ∏ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™</button>
                    </div>
                </div>
            </div>
            <div class="content-area">
                <div class="map-container">
                    <div class="map-header">
                        <h2 style="color: var(--text-color); margin: 0;">üó∫Ô∏è ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿßŸÑÿ™ŸÅÿßÿπŸÑŸäÿ©</h2>
                        <input type="text" id="mapSearchInput" class="search-input" placeholder="üîç ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ±ŸÉÿ≤ ÿ£Ÿà ŸÅÿ±ÿØ..." oninput="searchMapMarkers()" style="max-width:300px;margin-right:10px;">
                        <div class="map-controls">
                            <button class="map-btn tooltip" onclick="refreshMap()" data-tooltip="ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸàÿßŸÑÿπŸÑÿßŸÖÿßÿ™">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>
                            <button class="map-btn tooltip" onclick="fitAllMarkers()" data-tooltip="ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ŸÅŸä ŸÜÿ∑ÿßŸÇ ÿßŸÑÿ±ÿ§Ÿäÿ©">üè¢ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤</button>
                            <button class="map-btn tooltip" onclick="showAllEmployeesOnMap()" data-tooltip="ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©">üë• ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</button>
                            <button class="map-btn style-toggle tooltip" onclick="toggleMapStyle()" data-tooltip="ÿ™ÿ∫ŸäŸäÿ± ŸÜŸÖÿ∑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© (ÿ¥Ÿàÿßÿ±ÿπ/ÿ£ŸÇŸÖÿßÿ± ÿµŸÜÿßÿπŸäÿ©/ŸÅÿßÿ™ÿ≠/ŸÖÿ∏ŸÑŸÖ)">üó∫Ô∏è ÿßŸÑŸÜŸÖÿ∑</button>
                            <button class="map-btn tooltip" onclick="toggleMapFullscreen()" data-tooltip="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑŸÖŸÑÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©">‚õ∂ ŸÖŸÑÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©</button>
                        </div>
                    </div>
                    <div id="map"></div>
                </div>

                <div class="data-section">
                    <div class="section-title">
                        <span>üìç ÿßŸÑŸÖŸàÿßŸÇÿπ ŸàÿßŸÑÿ≠ÿ±ŸÉÿßÿ™ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©</span>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-small" onclick="refreshEmployeeLocations()">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>
                        </div>
                    </div>
                    
                    <div class="movement-search">
                        <input type="text" id="searchMovements" placeholder="üîç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™ ÿ®ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ±ÿØ..." oninput="filterMovements()">
                        <button class="btn btn-small" onclick="clearMovementSearch()">ŸÖÿ≥ÿ≠</button>
                    </div>
                    
                    <div class="virtual-list" id="employeeLocations">
                        <div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿßŸÇÿπ...</div>
                    </div>
                    
                    <div class="pagination" id="locationsPagination" style="display: none;">
                        <button onclick="previousPage('locations')">‚Üê ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>
                        <span id="locationsPageInfo">ÿµŸÅÿ≠ÿ© 1 ŸÖŸÜ 1</span>
                        <button onclick="nextPage('locations')">ÿßŸÑÿ™ÿßŸÑŸä ‚Üí</button>
                    </div>
                </div>

                <div class="data-section">
                    <h2 class="section-title">üìä ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 15px;">ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</h3>
                            <input type="text" class="search-input" id="searchCenters" placeholder="üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖÿ±ŸÉÿ≤..." oninput="filterCenters()" style="margin-bottom: 12px;">
                            <div class="virtual-list" id="centersList"></div>
                        </div>
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 15px;">ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</h3>
                            <input type="text" class="search-input" id="searchEmployees" placeholder="üîç ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ŸÅÿ±ÿØ..." oninput="filterEmployees()" style="margin-bottom: 12px;">
                            <div class="virtual-list" id="employeesList"></div>
                            <div class="pagination" id="employeesPagination" style="display: none;">
                                <button onclick="previousPage('employees')">‚Üê ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>
                                <span id="employeesPageInfo">ÿµŸÅÿ≠ÿ© 1 ŸÖŸÜ 1</span>
                                <button onclick="nextPage('employees')">ÿßŸÑÿ™ÿßŸÑŸä ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data-section">
                    <div class="section-title">
                        <span>üìã ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ© ŸàÿßŸÑÿ≠ÿ±ŸÉÿßÿ™ </span>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <select id="logFilter" onchange="filterLogs()" style="padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border-color); background: var(--card-bg); color: var(--text-color);">
                                <option value="all">ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©</option>
                                <option value="checkin">ÿØÿÆŸàŸÑ ŸÅŸÇÿ∑</option>
                                <option value="checkout">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ® ŸÅŸÇÿ∑</option>
                                <option value="movement">ÿ≠ÿ±ŸÉÿßÿ™ ŸÅŸÇÿ∑</option>
                                <option value="center_entry">ÿØÿÆŸÑ ŸÖÿ±ŸÉÿ≤</option>
                            </select>
                            <button class="btn btn-small" onclick="refreshLogs()">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>
                        </div>
                    </div>
                    <div class="movement-search" style="margin-bottom: 20px;">
                        <input type="text" id="searchLogs" placeholder="üîç ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ..." oninput="filterLogs()">
                        <button class="btn btn-small" onclick="clearLogSearch()">ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´</button>
                        <button class="btn btn-small" onclick="exportFilteredLogs()" title="ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸÖŸÅŸÑÿ™ÿ±ÿ©">üìä ÿ™ÿµÿØŸäÿ±</button>
                    </div>
                    
                    <div class="logs-container" id="activityLogs">
                        <div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™...</div>
                    </div>
                    
                    <div class="pagination" id="logsPagination" style="display: none;">
                        <button onclick="previousPage('logs')">‚Üê ÿßŸÑÿ≥ÿßÿ®ŸÇ</button>
                        <span id="logsPageInfo">ÿµŸÅÿ≠ÿ© 1 ŸÖŸÜ 1</span>
                        <button onclick="nextPage('logs')">ÿßŸÑÿ™ÿßŸÑŸä ‚Üí</button>
                    </div>
                </div>
                <div class="data-section">
                  <div class="section-title">
                    <span>üìù ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
                    <button class="btn btn-small" onclick="loadMainLogs()">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>
                  </div>
                  <div class="logs-container" id="mainLogsContainer">
                    <div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ...</div>
                  </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editEmployeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--text-color);">ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ±ÿØ</h2>
                <span class="close" onclick="closeModal('editEmployeeModal')">&times;</span>
            </div>
            <div class="modal-form-grid">
                <div class="form-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÅÿ±ÿØ</label>
                    <input type="text" id="editEmployeeName">
                </div>
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                    <input type="text" id="editEmployeePhone">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖŸÜÿµÿ®</label>
                    <input type="text" id="editEmployeePosition">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑŸÖÿ±ŸÉÿ≤</label>
                    <select id="editEmployeeCenter"></select>
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ≠ÿßŸÑÿ©</label>
                    <select id="editEmployeeStatus">
                        <option value="active">ŸÜÿ¥ÿ∑</option>
                        <option value="inactive">ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="updateEmployee()" style="margin-top: 10px;">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™</button>
        </div>
    </div>

    <div id="editCenterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--text-color);">ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ŸÉÿ≤</h2>
                <span class="close" onclick="closeModal('editCenterModal')">&times;</span>
            </div>
            <div class="modal-form-grid">
                <div class="form-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ±ŸÉÿ≤</label>
                    <input type="text" id="editCenterName">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™</label>
                    <input type="text" id="editCenterCoordinates" placeholder="ŸÖÿ´ÿßŸÑ: 32.53843, 44.184436">
                </div>
                <div class="form-group">
                    <label>ŸÜÿ∑ÿßŸÇ ÿßŸÑŸÖÿ±ŸÉÿ≤ (ŸÖÿ™ÿ±)</label>
                    <input type="number" id="editCenterRadius">
                </div>
            </div>
            <button class="btn" onclick="updateCenter()" style="margin-top: 10px;">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™</button>
        </div>
    </div>

    <div id="editUserPermissionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--text-color);">ÿ™ÿπÿØŸäŸÑ ÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h2>
                <span class="close" onclick="closeModal('editUserPermissionsModal')">&times;</span>
            </div>
            <form id="userPermissionsForm">
                <div class="form-group">
                    <label><input type="checkbox" id="permAddCenters"> ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ±ÿßŸÉÿ≤</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="permEditCenters"> ÿ™ÿπÿØŸäŸÑ ŸÖÿ±ÿßŸÉÿ≤</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="permDeleteCenters"> ÿ≠ÿ∞ŸÅ ŸÖÿ±ÿßŸÉÿ≤</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="permAddEmployees"> ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÅÿ±ÿßÿØ</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="permEditEmployees"> ÿ™ÿπÿØŸäŸÑ ÿ£ŸÅÿ±ÿßÿØ</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="permDeleteEmployees"> ÿ≠ÿ∞ŸÅ ÿ£ŸÅÿ±ÿßÿØ</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="permExport"> ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</label>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="permTrack"> ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</label>
                </div>
                <button type="button" class="btn" onclick="saveUserPermissions()">ÿ≠ŸÅÿ∏ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</button>
            </form>
        </div>
    </div>

    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--text-color);">ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</h2>
                <span class="close" onclick="closeModal('editUserModal')">&times;</span>
            </div>
            <div class="modal-form-grid">
                <div class="form-group">
                    <label>ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                    <input type="text" id="editUserUsername">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑ</label>
                    <input type="text" id="editUserFullName">
                </div>
                <div class="form-group">
                    <label>ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä</label>
                    <input type="email" id="editUserEmail">
                </div>
                <div class="form-group">
                    <label>ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                    <input type="text" id="editUserPhone">
                </div>
                <div class="form-group">
                    <label>ŸÜŸàÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</label>
                    <select id="editUserRole">
                        <option value="user">ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿπÿßÿØŸä</option>
                        <option value="admin">ŸÖÿØŸäÿ±</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-top: 10px;">
                <label>ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ©</label>
                <select id="editUserCenters" multiple style="width:100%" data-placeholder="ÿßÿÆÿ™ÿ± ŸÖÿ±ŸÉÿ≤ ÿ£Ÿà ÿ£ŸÉÿ´ÿ±..."></select>
            </div>
            <button class="btn" onclick="updateUser()" style="margin-top: 10px;">ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™</button>
        </div>
    </div>

    <script>
        const appState = {
            supabase: null,
            map: null,
            currentMapStyle: 'streets-v12',
            myLocationMarker: null,
            
            currentUser: null,
            userPermissions: null,
            sessionData: {
                isLoggedIn: false,
                user: null,
                loginTime: null,
                lastActivity: Date.now()
            },
            
            allowedCenters: [],
            allowedEmployees: [],
            allCenters: [],
            allEmployees: [],
            allLogs: [],
            centerStats: {},
            
            currentEditingEmployee: null,
            currentEditingCenter: null,
            
            pagination: {
                employees: { currentPage: 1, pageSize: 50, totalPages: 1 },
                locations: { currentPage: 1, pageSize: 20, totalPages: 1 },
                logs: { currentPage: 1, pageSize: 50, totalPages: 1 }
            },
            
            autoRefreshInterval: null,
            sessionTimeout: null,
            
            searchFilters: {
                fromDate: null,
                toDate: null,
                center: null,
                status: null
            },

            // Enhanced Auto Backup System
            autoBackup: {
                enabled: true,
                interval: 30000, // 30 seconds
                maxBackups: 20,
                lastBackupTime: null,
                backupInterval: null,
                isBackingUp: false,
                backups: [],
                settings: {
                    autoSaveOnChange: true,
                    saveDelay: 2000, // 2 seconds delay after changes
                    includeLogs: true,
                    compressionEnabled: true,
                    encryptionEnabled: false
                }
            },

            locationSettings: {
                minAccuracy: 50, 
                maxAccuracy: 200, 
                locationTimeout: 15000, 
                locationMaxAge: 30000, 
                retryAttempts: 3, 
                accuracyBuffer: 25, 
                locationHistory: [],
                lastLocationCheck: null,
                locationQuality: 'unknown' 
            },


            offlineMode: {
                isOnline: navigator.onLine,
                pendingActions: [],
                cachedData: {},
                lastSync: null,
                syncInterval: null,
       
                movementTracking: {
                    isTracking: false,
                    trackingHistory: [],
                    currentRoute: null,
                    lastKnownLocation: null,
                    routeStartTime: null,
                    estimatedArrival: null,
                    movementPatterns: [],
                    offlineCheckpoints: []
                }
            }
        };

   
        
  
        function calculateAverageLocation(locations) {
            if (!locations || locations.length === 0) return null;
            
            const validLocations = locations.filter(loc => 
                loc.accuracy && loc.accuracy <= appState.locationSettings.maxAccuracy
            );
            
            if (validLocations.length === 0) return null;
            
            validLocations.sort((a, b) => a.accuracy - b.accuracy);
            
            const bestLocations = validLocations.slice(0, Math.min(3, validLocations.length));
            
            let totalWeight = 0;
            let weightedLat = 0;
            let weightedLng = 0;
            let avgAccuracy = 0;
            
            bestLocations.forEach(loc => {
                const weight = 1 / (loc.accuracy || 1);
                totalWeight += weight;
                weightedLat += loc.latitude * weight;
                weightedLng += loc.longitude * weight;
                avgAccuracy += loc.accuracy;
            });
            
            return {
                latitude: weightedLat / totalWeight,
                longitude: weightedLng / totalWeight,
                accuracy: avgAccuracy / bestLocations.length,
                quality: getLocationQuality(avgAccuracy / bestLocations.length),
                sampleCount: bestLocations.length
            };
        }
        
        function getLocationQuality(accuracy) {
            if (accuracy <= 10) return 'excellent';
            if (accuracy <= 25) return 'good';
            if (accuracy <= 50) return 'fair';
            if (accuracy <= 100) return 'poor';
            return 'unreliable';
        }
        
        function enhanceLocationAccuracy(position) {
            const { latitude, longitude, accuracy } = position.coords;
            
            const currentLocation = {
                latitude,
                longitude,
                accuracy,
                timestamp: Date.now(),
                quality: getLocationQuality(accuracy)
            };
            
            appState.locationSettings.locationHistory.push(currentLocation);
            
            if (appState.locationSettings.locationHistory.length > 10) {
                appState.locationSettings.locationHistory.shift();
            }
            
            const enhancedLocation = calculateAverageLocation(appState.locationSettings.locationHistory);
            
            if (enhancedLocation) {
                return {
                    ...enhancedLocation,
                    originalAccuracy: accuracy,
                    enhanced: true
                };
            }
            
            return {
                latitude,
                longitude,
                accuracy,
                quality: getLocationQuality(accuracy),
                enhanced: false
            };
        }
        
        function isLocationStable(locations, threshold = 50) {
            if (locations.length < 2) return true;
            
            const recentLocations = locations.slice(-3);
            const distances = [];
            
            for (let i = 1; i < recentLocations.length; i++) {
                const distance = calculateDistance(
                    recentLocations[i-1].latitude,
                    recentLocations[i-1].longitude,
                    recentLocations[i].latitude,
                    recentLocations[i].longitude
                );
                distances.push(distance);
            }
            
            const avgDistance = distances.reduce((sum, dist) => sum + dist, 0) / distances.length;
            return avgDistance <= threshold;
        }
        
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function getEnhancedLocation(options = {}) {
            return new Promise((resolve, reject) => {
                const settings = {
                    enableHighAccuracy: true,
                    timeout: appState.locationSettings.locationTimeout,
                    maximumAge: appState.locationSettings.locationMaxAge,
                    ...options
                };
                
                let attempts = 0;
                const maxAttempts = appState.locationSettings.retryAttempts;
                
                function attemptGetLocation() {
                    attempts++;
                    
                    if (!navigator.geolocation) {
                        reject(new Error('ÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠'));
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const enhancedLocation = enhanceLocationAccuracy(position);
                            
                            if (enhancedLocation.quality === 'unreliable' && attempts < maxAttempts) {
                                console.log(`ŸÖÿ≠ÿßŸàŸÑÿ© ${attempts}: ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ ÿ∂ÿπŸäŸÅÿ© (${enhancedLocation.accuracy}m)ÿå ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©...`);
                                setTimeout(attemptGetLocation, 2000);
                                return;
                            }
                            
                         
                            const isStable = isLocationStable(appState.locationSettings.locationHistory);
                            
                            if (!isStable && attempts < maxAttempts) {
                                console.log(`ŸÖÿ≠ÿßŸàŸÑÿ© ${attempts}: ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ≥ÿ™ŸÇÿ±ÿå ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©...`);
                                setTimeout(attemptGetLocation, 3000);
                                return;
                            }
                            
                            appState.locationSettings.lastLocationCheck = Date.now();
                            appState.locationSettings.locationQuality = enhancedLocation.quality;
                            
                            resolve({
                                ...enhancedLocation,
                                attempts,
                                stable: isStable,
                                timestamp: Date.now()
                            });
                        },
                        (error) => {
                            console.error(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ (ŸÖÿ≠ÿßŸàŸÑÿ© ${attempts}):`, error);
                            
                            if (attempts < maxAttempts) {
                                setTimeout(attemptGetLocation, 2000);
                            } else {
                                reject(error);
                            }
                        },
                        settings
                    );
                }
                
                attemptGetLocation();
            });
        }

       
        function showLoading() {
            const loadingBar = document.getElementById('loadingBar');
            if (loadingBar) {
                loadingBar.classList.add('active');
            }
        }

        function hideLoading() {
            const loadingBar = document.getElementById('loadingBar');
            if (loadingBar) {
                loadingBar.classList.remove('active');
            }
        }

        function showError(message, duration = 5000) {
            showNotification(message, 'error', duration);
        }

        function showSuccess(message, duration = 3000) {
            showNotification(message, 'success', duration);
        }

        function showInfo(message, duration = 4000) {
            showNotification(message, 'info', duration);
        }

        function formatDateEnhanced(date) {
            if (!date) return 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            
            try {
                const d = new Date(date);
                const options = {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZone: 'Asia/Baghdad',
                    hour12: true
                };
                
                let formatted = d.toLocaleDateString('ar-EG', options);
                formatted = formatted.replace(/AM/g, 'ÿµ').replace(/PM/g, 'ŸÖ');
                return formatted;
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠';
            }
        }


        function maskPhoneNumber(phone) {
            if (!phone) return '';
            if (phone.length <= 4) return phone;
            return '*'.repeat(phone.length - 4) + phone.slice(-4);
        }

        function togglePhoneVisibility(element) {
            const phone = element.getAttribute('data-phone');
            if (element.classList.contains('revealed')) {
                element.textContent = maskPhoneNumber(phone);
                element.classList.remove('revealed');
            } else {
                element.textContent = phone;
                element.classList.add('revealed');
            }
        }

        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                showInfo(`ÿ™ŸÖ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ${getSectionName(sectionId)}`, 2000);
            }
        }

        function getSectionName(sectionId) {
            const names = {
                'employeesList': 'ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÅÿ±ÿßÿØ',
                'centersList': 'ÿßŸÑŸÖÿ±ÿßŸÉÿ≤',
                'employeeLocations': 'ÿßŸÑŸÖŸàÿßŸÇÿπ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ±ÿ©',
                'activityLogs': 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©'
            };
            return names[sectionId] || sectionId;
        }

        function updateLastActivity() {
            appState.sessionData.lastActivity = Date.now();
        }

        function startSessionTimeout() {
            const timeoutMinutes = 30;
            const timeoutMs = timeoutMinutes * 60 * 1000;
            
            appState.sessionTimeout = setInterval(() => {
                const now = Date.now();
                const lastActivity = appState.sessionData.lastActivity;
                
                if (now - lastActivity > timeoutMs) {
                    showInfo('ÿßŸÜÿ™Ÿáÿ™ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ¨ŸÑÿ≥ÿ©. ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã.', 5000);
                    setTimeout(() => logout(), 5000);
                }
            }, 60000); 
        }

      
        function applyAdvancedSearch() {}
        function clearAdvancedSearch() {}

    
        function exportToPDF() {
            showInfo('ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿØÿßÿØ ŸÖŸÑŸÅ PDF...', 3000);
            const employees = appState.currentUser.role === 'admin' ? appState.allEmployees : appState.allowedEmployees;
            if (!employees.length) {
                showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ™ÿµÿØŸäÿ±Ÿáÿß');
                return;
            }
            try {
                const doc = new window.jspdf.jsPDF({ orientation: 'landscape' });
                doc.setFont('Arial', 'bold');
                doc.text('ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÅÿ±ÿßÿØ', 15, 15);
                const headers = [['ÿßŸÑÿßÿ≥ŸÖ', 'ÿßŸÑŸáÿßÿ™ŸÅ', 'ÿßŸÑŸÖŸÜÿµÿ®', 'ÿßŸÑŸÖÿ±ŸÉÿ≤', 'ÿßŸÑÿ≠ÿßŸÑÿ©']];
                const data = employees.map(emp => [
                    emp.name || emp.employee_name || '',
                    emp.phone || '',
                    emp.position || emp.job_position || '',
                    emp.centers?.name || emp.center_name || '',
                    emp.status === 'active' ? 'ŸÜÿ¥ÿ∑' : 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑'
                ]);
                doc.autoTable({ 
                    head: headers, 
                    body: data, 
                    startY: 25, 
                    styles: { font: 'Arial' },
                    headStyles: { fillColor: [67, 206, 162] }
                });
                doc.save('employees.pdf');
                showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ PDF ÿ®ŸÜÿ¨ÿßÿ≠!', 3000);
            } catch (error) {
                console.error('PDF export error:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± PDF: ' + error.message);
            }
        }

        function exportToExcel() {
            showInfo('ÿ¨ÿßÿ±Ÿä ÿ•ÿπÿØÿßÿØ ŸÖŸÑŸÅ Excel...', 3000);
            const employees = appState.currentUser.role === 'admin' ? appState.allEmployees : appState.allowedEmployees;
            if (!employees.length) {
                showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ™ÿµÿØŸäÿ±Ÿáÿß');
                return;
            }
            const ws_data = [
                ['ÿßŸÑÿßÿ≥ŸÖ', 'ÿßŸÑŸáÿßÿ™ŸÅ', 'ÿßŸÑŸÖŸÜÿµÿ®', 'ÿßŸÑŸÖÿ±ŸÉÿ≤', 'ÿßŸÑÿ≠ÿßŸÑÿ©'],
                ...employees.map(emp => [
                    emp.name || emp.employee_name,
                    emp.phone,
                    emp.position || emp.job_position || '',
                    emp.centers?.name || emp.center_name || '',
                    emp.status === 'active' ? 'ŸÜÿ¥ÿ∑' : 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑'
                ])
            ];
            const ws = window.XLSX.utils.aoa_to_sheet(ws_data);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, 'ÿßŸÑŸÖŸàÿ∏ŸÅŸàŸÜ');
            window.XLSX.writeFile(wb, 'employees.xlsx');
            showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ•ŸÑŸâ Excel ÿ®ŸÜÿ¨ÿßÿ≠!', 3000);
        }

        const supabaseUrl = 'https://qcbcjyhqgxwuqutzkxrh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjYmNqeWhxZ3h3dXF1dHpreHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDE3NjQsImV4cCI6MjA2Njc3Nzc2NH0.y-hQVa6nzBpCMpXL7XbcWPMGafATvnMez3lAmFvb2zY';

        mapboxgl.accessToken = 'pk.eyJ1IjoiYW1lZXI3ZWx3YXMiLCJhIjoiY21iODAxaTFyMGFsajJqc2J2dGtvY2pmdSJ9.MNY-7y2onlfAnM0PUhNt8g';

        const mapStyles = [
            'mapbox://styles/mapbox/streets-v12',
            'mapbox://styles/mapbox/satellite-v9',
            'mapbox://styles/mapbox/light-v11',
            'mapbox://styles/mapbox/dark-v11'
        ];
        let currentStyleIndex = 0;

        function getCurrentTimestamp() {
            return new Date().toISOString();
        }

        function formatLocalDateTime(timestamp) {
            if (!timestamp) return 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            
            try {
                const date = new Date(timestamp);
                const options = {
                    year: 'numeric',
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZone: 'Asia/Baghdad',
                    hour12: true
                };
                
                let formatted = date.toLocaleString('ar-IQ', options);
                formatted = formatted.replace(/AM/g, 'ÿµ').replace(/PM/g, 'ŸÖ');
                return formatted;
            } catch (error) {
                console.error('Error formatting date:', error);
                return 'ÿ™ÿßÿ±ŸäÿÆ ÿ∫Ÿäÿ± ÿµÿßŸÑÿ≠';
            }
        }

        function getTimeDifference(timestamp) {
            if (!timestamp) return 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            
            try {
                const now = new Date();
                const time = new Date(timestamp);
                const diffInSeconds = Math.floor((now - time) / 1000);
                
                if (diffInSeconds < 30) return 'ÿßŸÑÿ¢ŸÜ';
                if (diffInSeconds < 60) return 'ŸÖŸÜÿ∞ ŸÑÿ≠ÿ∏ÿßÿ™';
                if (diffInSeconds < 3600) return `ŸÖŸÜÿ∞ ${Math.floor(diffInSeconds / 60)} ÿØŸÇŸäŸÇÿ©`;
                if (diffInSeconds < 86400) return `ŸÖŸÜÿ∞ ${Math.floor(diffInSeconds / 3600)} ÿ≥ÿßÿπÿ©`;
                return `ŸÖŸÜÿ∞ ${Math.floor(diffInSeconds / 86400)} ŸäŸàŸÖ`;
            } catch (error) {
                console.error('Error calculating time difference:', error);
                return 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            }
        }

        function getTodayDateStart() {
        
            const now = new Date();
   
            const iraqOffset = 3 * 60; 
            const localOffset = now.getTimezoneOffset(); 
         
            now.setHours(0, 0, 0, 0);
            const diffMinutes = iraqOffset + localOffset;
            now.setMinutes(now.getMinutes() - diffMinutes);
            return now.toISOString();
        }


        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Enhanced application v3 starting...');
            
            initializeSections();
            
            initializeOfflineSupport();
            loadPendingActions();
            
            const savedSession = localStorage.getItem('sessionData');
            if (savedSession) {
                try {
                    const parsed = JSON.parse(savedSession);
                    if (parsed.isLoggedIn && parsed.user) {
                        appState.sessionData = parsed;
                        appState.currentUser = parsed.user;
                        appState.userPermissions = parsed.user.permissions;
                        showDashboard();
                    }
                } catch(e) {}
            }

            try {
                await initializeSupabase();
                updateConnectionStatus();
                
                // Initialize Auto Backup System (only for admin)
                initializeAutoBackup();
                if (appState.currentUser && appState.currentUser.role === 'admin') {
                    initializeBackupSettings();
                    updateBackupStatus();
                }
                
                console.log('System loaded successfully');
            } catch (error) {
                console.error('System loading error:', error);
                updateConnectionStatus('ÿÆÿ∑ÿ£ ÿßÿ™ÿµÿßŸÑ', 'error');
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ: ' + error.message);
            }
        });

        function initializeSections() {
            const centerSection = document.getElementById('centerSection');
            const employeeSection = document.getElementById('employeeSection');
            const userSection = document.getElementById('userSection');
            
            if (centerSection) {
                centerSection.classList.add('collapsed');
                centerSection.parentElement.querySelector('.section-header').classList.add('collapsed');
            }
            
            if (employeeSection) {
                employeeSection.classList.add('collapsed');
                employeeSection.parentElement.querySelector('.section-header').classList.add('collapsed');
            }

            if (userSection) {
                userSection.classList.add('collapsed');
                userSection.parentElement.querySelector('.section-header').classList.add('collapsed');
            }
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.parentElement.querySelector('.section-header');
            
            section.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
        }

        function initializeSupabase() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function checkSupabase() {
                    attempts++;
                    if (window.supabase) {
                        appState.supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                        console.log('Supabase initialized successfully');
                        resolve(appState.supabase);
                    } else if (attempts < maxAttempts) {
                        setTimeout(checkSupabase, 200);
                    } else {
                        reject(new Error('ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'));
                    }
                }
                checkSupabase();
            });
        }

        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.getElementById('notifications').appendChild(notification);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.remove();
                }, duration);
            }

            return notification;
        }

        function updateConnectionStatus(message, type = 'normal') {
            const indicator = document.getElementById('connectionIndicator');
            if (indicator) {
                const icons = {
                    normal: 'üü¢',
                    offline: 'üü°',
                    error: 'üî¥',
                    syncing: 'üîÑ'
                };
                
                indicator.textContent = `${icons[type]} ${message}`;
                indicator.className = `connection-indicator ${type}`;
            }
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.add('visible');
            setTimeout(() => {
                indicator.classList.remove('visible');
            }, 2000);
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!username || !password) {
                showError('Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸàŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±');
                return;
            }

            showLoading();
            
            try {
                const { data, error } = await appState.supabase.rpc('authenticate_user', {
                    user_username: username,
                    user_password: password
                });

                if (error) throw error;

                const result = data;
                if (result.success) {
                    appState.sessionData = {
                        isLoggedIn: true,
                        user: result.user,
                        loginTime: getCurrentTimestamp(),
                        lastActivity: Date.now()
                    };
                    
                    appState.currentUser = result.user;
                    appState.userPermissions = result.user.permissions;
                    localStorage.setItem('sessionData', JSON.stringify(appState.sessionData));
                    
                    // ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ¨ŸÑ ŸÅŸä ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ© ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®
                    try {
                        const loginLogData = {
                            action: 'user_login',
                            occurred_at: new Date().toISOString(),
                            notes: `ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${result.user.username || result.user.name || username}`
                        };
                        await insertLogWithOfflineSupport(loginLogData);
                    } catch (logError) {
                        console.error('Error logging user login:', logError);
                    }
                    
                    showSuccess('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠! üéâ');
                    
                    startSessionTimeout();
                    
                    setTimeout(() => {
                        showDashboard();
                    }, 1000);
                } else {
                    showError('‚ùå ' + result.error);
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ');
            } finally {
                hideLoading();
            }
        }

        function logout() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
                if (appState.autoRefreshInterval) {
                    clearInterval(appState.autoRefreshInterval);
                    appState.autoRefreshInterval = null;
                }

                if (appState.sessionTimeout) {
                    clearInterval(appState.sessionTimeout);
                    appState.sessionTimeout = null;
                }

                appState.sessionData = { 
                    isLoggedIn: false, 
                    user: null, 
                    loginTime: null,
                    lastActivity: null
                };
                appState.currentUser = null;
                appState.userPermissions = null;
                appState.allowedCenters = [];
                appState.allowedEmployees = [];
                localStorage.removeItem('sessionData');
                
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('dashboard').style.display = 'none';
                
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                
                showInfo('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }

        async function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            
            updateUIForUser();
            
            loadLocationSettings();
            
            loadTrackingData();
            
            updateOfflineStatusDisplay();
            
            populateSearchCenterDropdown();
            
            populateTrackingEmployeeSelect();
            
            setTimeout(() => {
                initializeMap();
                setTimeout(() => {
                    if (appState.map) {
                        appState.map.resize();
                        console.log('Map resized successfully');
                    }
                }, 1000);
                
                setTimeout(() => {
                    loadAllData();
                    setupRealTimeUpdates();
                    startAutoRefresh();
                }, 1500);
            }, 500);
            loadMainLogs();
            const mainLogsSection = document.getElementById('mainLogsContainer');
            if (mainLogsSection && appState.currentUser.role !== 'admin') {
                mainLogsSection.parentElement.style.display = 'none';
            }
            const statsGrid = document.querySelector('.stats-grid');
            if (statsGrid && appState.currentUser.role !== 'admin') {
                statsGrid.querySelectorAll('.stat-card').forEach(card => card.style.display = 'none');

                const myCenterId = appState.currentUser.center_id || (appState.allowedCenters && appState.allowedCenters[0]?.id);
                const centersCountCard = document.getElementById('centersCount')?.closest('.stat-card');
                if (centersCountCard) centersCountCard.style.display = '';

                const checkinCard = document.querySelector('.stat-card.checkin-stat');
                if (checkinCard) checkinCard.style.display = '';
                const checkoutCard = document.querySelector('.stat-card.checkout-stat');
                if (checkoutCard) checkoutCard.style.display = '';
                const totalEmployeesCard = document.getElementById('totalEmployees')?.closest('.stat-card');
                if (totalEmployeesCard) totalEmployeesCard.style.display = 'none';
                const activeEmployeesCard = document.getElementById('activeEmployees')?.closest('.stat-card');
                if (activeEmployeesCard) activeEmployeesCard.style.display = 'none';
            } else if (statsGrid && appState.currentUser.role === 'admin') {
                statsGrid.querySelectorAll('.stat-card').forEach(card => card.style.display = '');
            }
        }

        function populateSearchCenterDropdown() {
            const searchCenterSelect = document.getElementById('searchCenter');
            if (!searchCenterSelect) return;
            
            searchCenterSelect.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤</option>';
            
            const centersToShow = appState.currentUser.role === 'admin' ? 
                appState.allCenters : appState.allowedCenters;
            
            centersToShow.forEach(center => {
                const option = document.createElement('option');
                option.value = center.id || center.center_id;
                option.textContent = center.name || center.center_name;
                searchCenterSelect.appendChild(option);
            });
        }

        function updateUIForUser() {
            const welcomeMsg = document.getElementById('welcomeMessage');
            const userRoleBadge = document.getElementById('userRoleBadge');
            
            welcomeMsg.textContent = `ŸÖÿ±ÿ≠ÿ®ÿßŸãÿå ${appState.currentUser.full_name}`;
            
            if (appState.currentUser.role === 'admin') {
                userRoleBadge.textContent = 'üë®‚Äçüíº ŸÖÿØŸäÿ±';
                userRoleBadge.className = 'user-badge admin';
            } else {
                userRoleBadge.textContent = 'üë§ ŸÖÿ≥ÿ™ÿÆÿØŸÖ';
                userRoleBadge.className = 'user-badge user';
            }
            
            updateSectionsVisibility();
        }

        function updateSectionsVisibility() {
            const addCenterSection = document.getElementById('addCenterSection');
            const addEmployeeSection = document.getElementById('addEmployeeSection');
            const addUserSection = document.getElementById('addUserSection');
            const employeePermissionWarning = document.getElementById('employeePermissionWarning');
            const usersListSection = document.getElementById('usersListSection');
            
            if (appState.userPermissions && !appState.userPermissions.can_add_centers && addCenterSection) {
                addCenterSection.style.display = 'none';
            }
            
            if (appState.userPermissions && !appState.userPermissions.can_add_employees && addEmployeeSection) {
                addEmployeeSection.style.display = 'none';
            } else if (appState.currentUser.role !== 'admin' && employeePermissionWarning) {
                employeePermissionWarning.style.display = 'block';
            }

            if (appState.currentUser.role === 'admin') {
                if (addUserSection) addUserSection.style.display = 'block';
                if (usersListSection) {
                    usersListSection.style.display = 'block';
                    loadUsersList();
                }
            } else {
                if (addUserSection) addUserSection.style.display = 'none';
                if (usersListSection) usersListSection.style.display = 'none';
            }
        }

        function startAutoRefresh() {
            if (appState.autoRefreshInterval) {
                clearInterval(appState.autoRefreshInterval);
            }
            appState.autoRefreshInterval = setInterval(async () => {
                if (appState.sessionData.isLoggedIn) {
                    try {
                        showRefreshIndicator();
                        if (!appState.allCenters || appState.allCenters.length === 0) {
                            await updateStats();
                            await refreshEmployeeLocations();
                        }
                        updateTimeDifferences();
                    } catch (error) {
                        console.error('Auto refresh error:', error);
                    }
                }
            }, 180000);
        }

        function updateTimeDifferences() {
            document.querySelectorAll('.time-ago').forEach(element => {
                const timestamp = element.getAttribute('data-timestamp');
                if (timestamp) {
                    element.textContent = getTimeDifference(timestamp);
                }
            });
        }

        let rtlPluginSet = false;
        function initializeMap() {
            if (typeof appState.currentStyleIndex !== 'number' || isNaN(appState.currentStyleIndex) || appState.currentStyleIndex < 0 || appState.currentStyleIndex >= mapStyles.length) {
                appState.currentStyleIndex = 0;
            }
            try {
                const mapContainer = document.getElementById('map');
                if (!mapContainer) {
                    console.error('Map container not found');
                    showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿπŸÜÿµÿ± ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©');
                    return;
                }
                if (typeof mapboxgl === 'undefined') {
                    console.error('Mapbox GL JS not loaded');
                    showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÉÿ™ÿ®ÿ© ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
                    return;
                }
                const style = mapStyles[appState.currentStyleIndex];
                if (!style) {
                    showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜŸÖÿ∑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ£Ÿà ÿßŸÑÿ™ŸàÿßÿµŸÑ ŸÖÿπ ÿßŸÑÿØÿπŸÖ.');
                    console.error('Map style is undefined! currentStyleIndex:', appState.currentStyleIndex, mapStyles);
                    return;
                }
                console.log('Initializing map with style:', style);
                if (!rtlPluginSet && mapboxgl.setRTLTextPlugin) {
                    mapboxgl.setRTLTextPlugin(
                        'https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js',
                        null,
                        true
                    );
                    rtlPluginSet = true;
                }
                appState.map = new mapboxgl.Map({
                    container: 'map',
                    style: style,
                    center: [44.3661, 32.6155],
                    zoom: 12,
                    locale: 'ar'
                });
                appState.map.addControl(new mapboxgl.NavigationControl(), 'top-left');
                if (appState.userPermissions && appState.userPermissions.can_add_centers) {
                    appState.map.on('click', function(e) {
                        const coordinates = e.lngLat;
                        document.getElementById('centerCoordinates').value = `${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}`;
                        showSuccess(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ: ${coordinates.lat.toFixed(4)}, ${coordinates.lng.toFixed(4)}`);
                    });
                }
                appState.map.on('load', function() {
                    console.log('Enhanced map loaded successfully');
                    updateMapMarkers();
                });
                appState.map.on('error', function(e) {
                    console.error('Map error:', e);
                    showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©: ' + (e && e.error && e.error.message ? e.error.message : 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ'));
                });
            } catch (error) {
                console.error('Error initializing map:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©: ' + error.message);
            }
        }

        function toggleMapStyle() {
            if (!appState.map) return;

            if (typeof appState.currentStyleIndex !== 'number' || isNaN(appState.currentStyleIndex) || appState.currentStyleIndex < 0 || appState.currentStyleIndex >= mapStyles.length) {
                appState.currentStyleIndex = 0;
            }
            appState.currentStyleIndex = (appState.currentStyleIndex + 1) % mapStyles.length;
            appState.map.setStyle(mapStyles[appState.currentStyleIndex]);
            const styleNames = ['ÿßŸÑÿ¥Ÿàÿßÿ±ÿπ', 'ÿßŸÑÿ£ŸÇŸÖÿßÿ± ÿßŸÑÿµŸÜÿßÿπŸäÿ©', 'ŸÅÿßÿ™ÿ≠', 'ŸÖÿ∏ŸÑŸÖ'];
            showInfo(`ÿ™ŸÖ ÿ™ÿ∫ŸäŸäÿ± ŸÜŸÖÿ∑ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ•ŸÑŸâ: ${styleNames[appState.currentStyleIndex]}`, 2000);
            appState.map.once('styledata', () => {
                setTimeout(() => {
                    updateMapMarkers();
                    updateMapWithEmployees();
                }, 1000);
            });
        }

        async function showAllEmployeesOnMap() {
            if (!appState.map) {
                showError('ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ© ÿ®ÿπÿØ');
                return;
            }

            try {
                let employeeIds = [];
                
                if (appState.currentUser.role === 'admin') {
                    const { data: allEmps } = await appState.supabase.from('employees').select('id');
                    employeeIds = allEmps ? allEmps.map(emp => emp.id) : [];
                } else {
                    employeeIds = appState.allowedEmployees.map(emp => emp.employee_id || emp.id);
                }

                if (employeeIds.length === 0) {
                    showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÅÿ±ÿßÿØ ŸÑÿπÿ±ÿ∂ŸáŸÖ');
                    return;
                }

                const { data: latestLogs, error } = await appState.supabase
                    .from('logs')
                    .select(`*, employees (id, name, status, phone, center_id), centers (name)`)
                    .in('employee_id', employeeIds)
                    .not('latitude', 'is', null)
                    .not('longitude', 'is', null)
                    .order('occurred_at', { ascending: false });

                if (error) throw error;

                const employeeLocations = {};
                latestLogs.forEach(log => {
                    if (log.employees && !employeeLocations[log.employees.id]) {
                        employeeLocations[log.employees.id] = {
                            employee: log.employees,
                            center: log.centers || null,
                            location: {
                                latitude: log.latitude,
                                longitude: log.longitude,
                                action: log.action,
                                time: log.occurred_at || log.created_at
                            }
                        };
                    }
                });

                // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤ ŸÖŸàÿ¨ŸàÿØÿßŸã ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑÿå ŸÜÿ¨ŸÑÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ŸÉÿ≤ ŸÖŸÜ ÿ¨ÿØŸàŸÑ employees
                const employeesWithoutCenter = Object.values(employeeLocations).filter(emp => !emp.center && emp.employee.center_id);
                if (employeesWithoutCenter.length > 0) {
                    const empIds = employeesWithoutCenter.map(emp => emp.employee.id);
                    const { data: employeesWithCenters } = await appState.supabase
                        .from('employees')
                        .select('id, center_id, centers (name)')
                        .in('id', empIds);
                    
                    if (employeesWithCenters) {
                        employeesWithCenters.forEach(emp => {
                            if (employeeLocations[emp.id] && emp.centers) {
                                employeeLocations[emp.id].center = emp.centers;
                            }
                        });
                    }
                }

                updateMapWithEmployees(employeeLocations);
                
                if (Object.keys(employeeLocations).length > 0) {
                    const bounds = new mapboxgl.LngLatBounds();
                    Object.values(employeeLocations).forEach(empData => {
                        bounds.extend([empData.location.longitude, empData.location.latitude]);
                    });
                    appState.map.fitBounds(bounds, { padding: 50 });
                }

                showSuccess(`ÿ™ŸÖ ÿπÿ±ÿ∂ ${Object.keys(employeeLocations).length} ŸÅÿ±ÿØ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©`);
            } catch (error) {
                console.error('Error showing employees on map:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
            }
        }

        async function locateMe() {
            if (!appState.map) {
                showError('ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ© ÿ®ÿπÿØ. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇŸÑŸäŸÑÿßŸã...');
                return;
            }

            try {
                showInfo('ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ ÿ®ÿØŸÇÿ© ÿπÿßŸÑŸäÿ©...');
                
                const enhancedLocation = await getEnhancedLocation();
                        
                        if (appState.myLocationMarker) {
                            appState.myLocationMarker.remove();
                        }
                        
                        appState.map.flyTo({
                    center: [enhancedLocation.longitude, enhancedLocation.latitude],
                            zoom: 16,
                            duration: 2000
                        });

                const qualityColors = {
                    'excellent': '#28a745',
                    'good': '#17a2b8',
                    'fair': '#ffc107',
                    'poor': '#fd7e14',
                    'unreliable': '#dc3545'
                };
                
                const qualityTexts = {
                    'excellent': 'ŸÖŸÖÿ™ÿßÿ≤ÿ©',
                    'good': 'ÿ¨ŸäÿØÿ©',
                    'fair': 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©',
                    'poor': 'ÿ∂ÿπŸäŸÅÿ©',
                    'unreliable': 'ÿ∫Ÿäÿ± ŸÖŸàÿ´ŸàŸÇÿ©'
                };

                        appState.myLocationMarker = new mapboxgl.Marker({ 
                    color: qualityColors[enhancedLocation.quality] || '#ff6b6b',
                            scale: 1.2
                        })
                    .setLngLat([enhancedLocation.longitude, enhancedLocation.latitude])
                            .setPopup(new mapboxgl.Popup({ 
                                className: 'arabic-popup',
                                offset: 25
                            }).setHTML(`
                                <div class="marker-popup">
                                    <strong>üìç ŸÖŸàŸÇÿπŸÉ ÿßŸÑÿ≠ÿßŸÑŸä</strong><br>
                            <small>ÿØŸÇÿ©: ${Math.round(enhancedLocation.accuracy)}ŸÖ</small><br>
                            <small>ÿßŸÑÿ¨ŸàÿØÿ©: ${qualityTexts[enhancedLocation.quality]}</small><br>
                            <small>ŸÖÿ≠ÿ≥ŸÜ: ${enhancedLocation.enhanced ? 'ŸÜÿπŸÖ' : 'ŸÑÿß'}</small><br>
                            <small>ŸÖÿ≥ÿ™ŸÇÿ±: ${enhancedLocation.stable ? 'ŸÜÿπŸÖ' : 'ŸÑÿß'}</small><br>
                            <small>ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™: ${enhancedLocation.attempts}</small>
                                </div>
                            `))
                            .addTo(appState.map);

                const qualityMessage = enhancedLocation.quality === 'excellent' || enhancedLocation.quality === 'good' 
                    ? 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ ÿ®ÿØŸÇÿ© ÿπÿßŸÑŸäÿ©! üìç' 
                    : `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸàŸÇÿπŸÉ (ÿØŸÇÿ© ${qualityTexts[enhancedLocation.quality]}) üìç`;
                
                showSuccess(qualityMessage);
                
                if (enhancedLocation.quality === 'poor' || enhancedLocation.quality === 'unreliable') {
                    showInfo('ÿ™ÿ≠ÿ∞Ÿäÿ±: ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ ÿ∂ÿπŸäŸÅÿ©. ŸÇÿØ ÿ™ÿ§ÿ´ÿ± ÿπŸÑŸâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä.', 8000);
                }
                
            } catch (error) {
                console.error('Enhanced geolocation error:', error);
                        let errorMessage = 'ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ. ';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += 'Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ŸÑŸÑŸÖŸàŸÇÿπ.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += 'ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠ ÿ≠ÿßŸÑŸäÿßŸã.';
                                break;
                            case error.TIMEOUT:
                                errorMessage += 'ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±.';
                                break;
                            default:
                                errorMessage += 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ.';
                                break;
                        }
                        
                        showError(errorMessage);
            }
        }

        function refreshMap() {
            if (appState.map) {
                updateMapMarkers();
                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©', 2000);
            }
        }

        function toggleMapFullscreen() {
            const mapContainer = document.getElementById('map');
            const mapParent = mapContainer.parentElement;
            
            if (!mapContainer.classList.contains('map-fullscreen')) {
                mapContainer.classList.add('map-fullscreen');
                mapParent.style.position = 'relative';
                
                const controls = document.createElement('div');
                controls.className = 'fullscreen-controls';
                controls.innerHTML = `
                    <button class="fullscreen-btn exit" onclick="toggleMapFullscreen()" title="ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ŸÖŸÑÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©">‚úï ÿÆÿ±Ÿàÿ¨</button>
                    <button class="fullscreen-btn" onclick="refreshMap()" title="ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©">üîÑ ÿ™ÿ≠ÿØŸäÿ´</button>
                    <button class="fullscreen-btn" onclick="fitAllMarkers()" title="ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤">üè¢ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤</button>
                    <button class="fullscreen-btn" onclick="showAllEmployeesOnMap()" title="ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ">üë• ÿßŸÑÿ£ŸÅÿ±ÿßÿØ</button>
                    <button class="fullscreen-btn" onclick="toggleMapStyle()" title="ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑŸÜŸÖÿ∑">üó∫Ô∏è ÿßŸÑŸÜŸÖÿ∑</button>
                `;
                mapParent.appendChild(controls);
                
                if (appState.map) {
                    setTimeout(() => {
                        appState.map.resize();
                    }, 100);
                }
                
                showSuccess('ÿ™ŸÖ ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ŸÑŸÖŸÑÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©', 2000);
            } else {
                mapContainer.classList.remove('map-fullscreen');
                
                const controls = mapParent.querySelector('.fullscreen-controls');
                if (controls) {
                    controls.remove();
                }
                
                if (appState.map) {
                    setTimeout(() => {
                        appState.map.resize();
                    }, 100);
                }
                
                showInfo('ÿ™ŸÖ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ Ÿàÿ∂ÿπ ŸÖŸÑÿ° ÿßŸÑÿ¥ÿßÿ¥ÿ©', 2000);
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const mapContainer = document.getElementById('map');
                if (mapContainer && mapContainer.classList.contains('map-fullscreen')) {
                    toggleMapFullscreen();
                }
            }
        });

        function fitAllMarkers() {
            if (appState.map && appState.allowedCenters.length > 0) {
                const bounds = new mapboxgl.LngLatBounds();
                appState.allowedCenters.forEach(center => {
                    bounds.extend([center.longitude, center.latitude]);
                });
                appState.map.fitBounds(bounds, { padding: 50 });
                showInfo(`ÿ™ŸÖ ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ (${appState.allowedCenters.length})`, 2000);
            } else {
                showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ±ÿßŸÉÿ≤ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
            }
        }

        async function loadAllData() {
            try {
                showLoading();
                updateConnectionStatus('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...', 'syncing');
                
                if (appState.currentUser.role === 'admin') {
                    await Promise.all([
                        loadCenters(),
                        loadEmployees(),
                        loadLogs(),
                        loadCenterStats(),
                        updateStats(),
                        refreshEmployeeLocations()
                    ]);
                    
                    appState.allowedCenters = [...appState.allCenters];
                    appState.allowedEmployees = [...appState.allEmployees];
                } else {
                    await Promise.all([
                        loadCenters(),
                        loadEmployees(),
                        loadLogs(),
                        loadCenterStats(),
                        updateStats(),
                        refreshEmployeeLocations()
                    ]);
                    appState.allowedCenters = [...appState.allCenters];
                    appState.allowedEmployees = [...appState.allEmployees];
                }
                
                if (appState.map && appState.map.isStyleLoaded()) {
                    updateMapMarkers();
                }
                
                updateConnectionStatus('ŸÖÿ™ÿµŸÑ', 'normal');
                
                // Update backup status after loading data (only for admin)
                if (appState.currentUser && appState.currentUser.role === 'admin') {
                    updateBackupStatus();
                    
                    // Start periodic backup status update
                    setInterval(updateBackupStatus, 30000); // Update every 30 seconds
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateConnectionStatus('ÿÆÿ∑ÿ£ ÿ™ÿ≠ŸÖŸäŸÑ', 'error');
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            } finally {
                hideLoading();
            }
        }

        // ===== ENHANCED AUTO BACKUP SYSTEM =====
        
        // Initialize Auto Backup System
        function initializeAutoBackup() {
            console.log('üîÑ Initializing Auto Backup System...');
            
            // Show backup system only for admin users
            if (appState.currentUser && appState.currentUser.role === 'admin') {
                document.getElementById('backupSystemSection').style.display = 'block';
                
                // Load auto backup settings from localStorage
                loadAutoBackupSettings();
                
                // Load existing backups from localStorage
                loadBackupsFromStorage();
                
                // Start auto backup interval
                if (appState.autoBackup.enabled) {
                    startAutoBackup();
                }
                
                // Set up change detection
                setupChangeDetection();
                
                console.log('‚úÖ Auto Backup System initialized successfully for admin');
            } else {
                // Hide backup system for regular users
                document.getElementById('backupSystemSection').style.display = 'none';
                console.log('üîí Backup system hidden for regular user');
            }
        }
        
        // Load backups from localStorage
        function loadBackupsFromStorage() {
            try {
                const storedBackups = localStorage.getItem('systemBackups');
                if (storedBackups) {
                    appState.autoBackup.backups = JSON.parse(storedBackups);
                    console.log(`üì¶ Loaded ${appState.autoBackup.backups.length} backups from storage`);
                }
            } catch (error) {
                console.error('Error loading backups from storage:', error);
                appState.autoBackup.backups = [];
            }
        }
        
        // Load auto backup settings from localStorage
        function loadAutoBackupSettings() {
            try {
                const storedSettings = localStorage.getItem('autoBackupSettings');
                if (storedSettings) {
                    const settings = JSON.parse(storedSettings);
                    if (settings.interval) {
                        appState.autoBackup.interval = settings.interval;
                    }
                    if (settings.enabled !== undefined) {
                        appState.autoBackup.enabled = settings.enabled;
                    }
                    if (settings.settings) {
                        appState.autoBackup.settings = { ...appState.autoBackup.settings, ...settings.settings };
                    }
                    if (settings.maxBackups) {
                        appState.autoBackup.maxBackups = settings.maxBackups;
                    }
                    console.log('‚öôÔ∏è Loaded auto backup settings from storage');
                }
            } catch (error) {
                console.error('Error loading auto backup settings from storage:', error);
            }
        }
        
        // Save auto backup settings to localStorage
        function saveAutoBackupSettings() {
            try {
                const settings = {
                    interval: appState.autoBackup.interval,
                    enabled: appState.autoBackup.enabled,
                    settings: appState.autoBackup.settings,
                    maxBackups: appState.autoBackup.maxBackups
                };
                localStorage.setItem('autoBackupSettings', JSON.stringify(settings));
                console.log('üíæ Auto backup settings saved to storage');
            } catch (error) {
                console.error('Error saving auto backup settings to storage:', error);
            }
        }
        
        // Save backups to localStorage
        function saveBackupsToStorage() {
            try {
                localStorage.setItem('systemBackups', JSON.stringify(appState.autoBackup.backups));
                console.log('üíæ Backups saved to storage');
            } catch (error) {
                console.error('Error saving backups to storage:', error);
            }
        }
        
        // Start auto backup interval
        function startAutoBackup() {
            if (appState.autoBackup.backupInterval) {
                clearInterval(appState.autoBackup.backupInterval);
            }
            
            appState.autoBackup.backupInterval = setInterval(() => {
                if (!appState.autoBackup.isBackingUp) {
                    createAutoBackup();
                }
            }, appState.autoBackup.interval);
            
            console.log(`üîÑ Auto backup started - interval: ${appState.autoBackup.interval / 1000} seconds`);
        }
        
        // Stop auto backup
        function stopAutoBackup() {
            if (appState.autoBackup.backupInterval) {
                clearInterval(appState.autoBackup.backupInterval);
                appState.autoBackup.backupInterval = null;
                console.log('‚èπÔ∏è Auto backup stopped');
            }
        }
        
        // Setup change detection for auto save
        function setupChangeDetection() {
            if (!appState.autoBackup.settings.autoSaveOnChange) return;
            
            let changeTimeout;
            
            // Monitor data changes
            const originalLoadAllData = loadAllData;
            loadAllData = async function() {
                await originalLoadAllData.apply(this, arguments);
                
                // Clear existing timeout
                if (changeTimeout) {
                    clearTimeout(changeTimeout);
                }
                
                // Set new timeout for auto backup
                changeTimeout = setTimeout(() => {
                    if (!appState.autoBackup.isBackingUp) {
                        createAutoBackup('auto_change');
                    }
                }, appState.autoBackup.settings.saveDelay);
            };
        }
        
        // Create automatic backup
        async function createAutoBackup(type = 'auto') {
            if (appState.autoBackup.isBackingUp) {
                console.log('‚è≥ Backup already in progress, skipping...');
                return;
            }
            
            try {
                appState.autoBackup.isBackingUp = true;
                
                const backupData = await collectSystemData();
                const backupId = `backup_${Date.now()}`;
                const backup = {
                    id: backupId,
                    timestamp: new Date().toISOString(),
                    type: type,
                    data: backupData,
                    size: JSON.stringify(backupData).length,
                    description: `ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ${type === 'auto' ? 'ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©' : 'ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ÿ®ÿπÿØ ÿ™ÿ∫ŸäŸäÿ±'}`
                };
                
                // Add to backups array
                appState.autoBackup.backups.push(backup);
                
                // Limit number of backups
                if (appState.autoBackup.backups.length > appState.autoBackup.maxBackups) {
                    appState.autoBackup.backups.shift(); // Remove oldest
                }
                
                // Save to storage
                saveBackupsToStorage();
                
                appState.autoBackup.lastBackupTime = Date.now();
                
                // Show notification
                showBackupNotification(`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ™ŸÑŸÇÿßÿ¶Ÿäÿ© ‚úÖ`, 'success');
                
                console.log(`‚úÖ Auto backup created: ${backupId}`);
                
            } catch (error) {
                console.error('Error creating auto backup:', error);
                showBackupNotification(`ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ‚ùå`, 'error');
            } finally {
                appState.autoBackup.isBackingUp = false;
            }
        }
        
        // Create manual backup
        async function createManualBackup() {
            try {
                showLoading();
                
                const backupData = await collectSystemData();
                const backupId = `backup_manual_${Date.now()}`;
                const backup = {
                    id: backupId,
                    timestamp: new Date().toISOString(),
                    type: 'manual',
                    data: backupData,
                    size: JSON.stringify(backupData).length,
                    description: 'ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸäÿØŸàŸäÿ©'
                };
                
                // Add to backups array
                appState.autoBackup.backups.push(backup);
                
                // Limit number of backups
                if (appState.autoBackup.backups.length > appState.autoBackup.maxBackups) {
                    appState.autoBackup.backups.shift(); // Remove oldest
                }
                
                // Save to storage
                saveBackupsToStorage();
                
                showSuccess(`ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ`);
                console.log(`‚úÖ Manual backup created: ${backupId}`);
                
            } catch (error) {
                console.error('Error creating manual backup:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
            } finally {
                hideLoading();
            }
        }
        
        // Collect all system data for backup
        async function collectSystemData() {
            // Load main logs for backup
            let mainLogs = [];
            try {
                const { data: logs, error } = await appState.supabase
                    .from('main_logs')
                    .select('action,entity_type,entity_name,latitude,longitude,user_id,occurred_at,old_name,new_name')
                    .order('occurred_at', { ascending: false })
                    .limit(1000); // Last 1000 main logs
                
                if (!error && logs) {
                    mainLogs = logs;
                }
            } catch (error) {
                console.error('Error loading main logs for backup:', error);
            }
            
            // Load movement logs (logs) for backup - ensure we get fresh data
            let movementLogs = [];
            if (appState.autoBackup.settings.includeLogs) {
                try {
                    let query = appState.supabase
                        .from('logs')
                        .select('id,employee_id,center_id,action,latitude,longitude,accuracy,device_info,notes,occurred_at,created_at')
                        .order('occurred_at', { ascending: false })
                        .limit(1000); // Last 1000 movement logs
                    
                    // Apply same permissions as loadLogs
                    if (appState.currentUser.role !== 'admin' && appState.allowedEmployees.length > 0) {
                        const employeeIds = appState.allowedEmployees.map(emp => emp.employee_id || emp.id);
                        query = query.in('employee_id', employeeIds);
                    }
                    
                    const { data: logs, error } = await query;
                    if (!error && logs) {
                        movementLogs = logs;
                    }
                } catch (error) {
                    console.error('Error loading movement logs for backup:', error);
                    // Fallback to appState.allLogs if database query fails
                    movementLogs = appState.allLogs.slice(-1000);
                }
            }
            
            const data = {
                timestamp: new Date().toISOString(),
                version: '1.0.0',
                user: appState.currentUser,
                userPermissions: appState.userPermissions,
                sessionData: appState.sessionData,
                
                // Core Data Collections
                centers: appState.allCenters,
                employees: appState.allEmployees,
                logs: movementLogs, // Movement logs (ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™)
                mainLogs: appState.autoBackup.settings.includeLogs ? mainLogs : [], // Main operations logs
                
                // Additional Data Collections
                allowedCenters: appState.allowedCenters,
                allowedEmployees: appState.allowedEmployees,
                centerStats: appState.centerStats,
                
                // Current State
                currentEditingEmployee: appState.currentEditingEmployee,
                currentEditingCenter: appState.currentEditingCenter,
                
                // Pagination State
                pagination: appState.pagination,
                
                // Search Filters
                searchFilters: appState.searchFilters,
                
                // Settings
                settings: {
                    autoBackup: appState.autoBackup.settings,
                    locationSettings: appState.locationSettings,
                    searchFilters: appState.searchFilters
                },
                
                // Statistics
                stats: {
                    totalCenters: appState.allCenters.length,
                    totalEmployees: appState.allEmployees.length,
                    totalLogs: movementLogs.length, // Movement logs count
                    totalMainLogs: mainLogs.length, // Main operations logs count
                    totalMovementLogs: movementLogs.length, // Explicit movement logs count
                    totalAllowedCenters: appState.allowedCenters.length,
                    totalAllowedEmployees: appState.allowedEmployees.length,
                    lastBackupTime: appState.autoBackup.lastBackupTime,
                    backupVersion: '1.0.0'
                }
            };
            
            return data;
        }
        
        // Restore from backup
        async function restoreFromBackup(backupId) {
            try {
                const backup = appState.autoBackup.backups.find(b => b.id === backupId);
                if (!backup) {
                    showError('ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                    return;
                }
                
                if (!confirm(`ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©ÿü\nÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≠ÿßŸÑŸäÿ©!`)) {
                    return;
                }
                
                showLoading();
                
                const backupData = backup.data;
                
                // Restore centers
                if (backupData.centers && backupData.centers.length > 0) {
                    await restoreCenters(backupData.centers);
                }
                
                // Restore employees
                if (backupData.employees && backupData.employees.length > 0) {
                    await restoreEmployees(backupData.employees);
                }
                
                // Restore logs (if enabled)
                if (backupData.logs && backupData.logs.length > 0 && appState.autoBackup.settings.includeLogs) {
                    await restoreLogs(backupData.logs);
                }
                
                // Restore main logs (if enabled)
                if (backupData.mainLogs && backupData.mainLogs.length > 0 && appState.autoBackup.settings.includeLogs) {
                    await restoreMainLogs(backupData.mainLogs);
                }
                
                // Restore additional data collections
                if (backupData.allowedCenters) {
                    appState.allowedCenters = backupData.allowedCenters;
                }
                
                if (backupData.allowedEmployees) {
                    appState.allowedEmployees = backupData.allowedEmployees;
                }
                
                if (backupData.centerStats) {
                    appState.centerStats = backupData.centerStats;
                }
                
                // Restore pagination state
                if (backupData.pagination) {
                    appState.pagination = backupData.pagination;
                }
                
                // Restore search filters
                if (backupData.searchFilters) {
                    appState.searchFilters = backupData.searchFilters;
                }
                
                // Reload all data
                await loadAllData();
                
                showSuccess(`ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ\nÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ${backupData.stats?.totalCenters || 0} ŸÖÿ±ŸÉÿ≤ Ÿà ${backupData.stats?.totalEmployees || 0} ŸÖŸàÿ∏ŸÅ\nŸàÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™: ${backupData.stats?.totalMovementLogs || backupData.stats?.totalLogs || 0} ÿ≥ÿ¨ŸÑ\nŸàÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©: ${backupData.stats?.totalMainLogs || 0} ÿ≥ÿ¨ŸÑ`);
                console.log(`‚úÖ Restored from backup: ${backupId}`);
                
            } catch (error) {
                console.error('Error restoring backup:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
            } finally {
                hideLoading();
            }
        }
        
        // Restore centers
        async function restoreCenters(centers) {
            for (const center of centers) {
                try {
                    const { error } = await appState.supabase
                        .from('centers')
                        .upsert({
                            id: center.id,
                            name: center.name,
                            longitude: center.longitude,
                            latitude: center.latitude,
                            radius: center.radius,
                            created_at: center.created_at,
                            updated_at: new Date().toISOString()
                        });
                    
                    if (error) throw error;
                } catch (error) {
                    console.error(`Error restoring center ${center.name}:`, error);
                }
            }
        }
        
        // Restore employees
        async function restoreEmployees(employees) {
            for (const employee of employees) {
                try {
                    const { error } = await appState.supabase
                        .from('employees')
                        .upsert({
                            id: employee.id,
                            name: employee.name,
                            phone: employee.phone,
                            position: employee.position,
                            center_id: employee.center_id,
                            status: employee.status,
                            is_active: employee.is_active,
                            notes: employee.notes,
                            created_at: employee.created_at,
                            updated_at: new Date().toISOString()
                        });
                    
                    if (error) throw error;
                } catch (error) {
                    console.error(`Error restoring employee ${employee.name}:`, error);
                }
            }
        }
        
        // Restore logs
        async function restoreLogs(logs) {
            for (const log of logs) {
                try {
                    const { error } = await appState.supabase
                        .from('logs')
                        .upsert({
                            id: log.id,
                            employee_id: log.employee_id,
                            center_id: log.center_id,
                            action: log.action,
                            latitude: log.latitude,
                            longitude: log.longitude,
                            accuracy: log.accuracy,
                            device_info: log.device_info,
                            notes: log.notes,
                            occurred_at: log.occurred_at,
                            created_at: log.created_at
                        });
                    
                    if (error) throw error;
                } catch (error) {
                    console.error(`Error restoring log:`, error);
                }
            }
        }
        
        // Restore main logs
        async function restoreMainLogs(mainLogs) {
            for (const log of mainLogs) {
                try {
                    const { error } = await appState.supabase
                        .from('main_logs')
                        .upsert({
                            action: log.action,
                            entity_type: log.entity_type,
                            entity_name: log.entity_name,
                            latitude: log.latitude,
                            longitude: log.longitude,
                            user_id: log.user_id,
                            occurred_at: log.occurred_at,
                            old_name: log.old_name,
                            new_name: log.new_name
                        });
                    
                    if (error) throw error;
                } catch (error) {
                    console.error(`Error restoring main log:`, error);
                }
            }
        }
        
        // Show backup notification
        function showBackupNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>${message}</span>
                    <small style="opacity: 0.8;">${new Date().toLocaleTimeString('ar-SA')}</small>
                </div>
            `;
            
            const container = document.querySelector('.notifications') || createNotificationContainer();
            container.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Create notification container if it doesn't exist
        function createNotificationContainer() {
            const container = document.createElement('div');
            container.className = 'notifications';
            document.body.appendChild(container);
            return container;
        }
        
        // Get backup list for UI
        function getBackupList() {
            return appState.autoBackup.backups
                .slice()
                .reverse() // Show newest first
                .map(backup => ({
                    id: backup.id,
                    timestamp: backup.timestamp,
                    type: backup.type,
                    size: backup.size,
                    description: backup.description,
                    stats: backup.data.stats
                }));
        }
        
        // Delete backup
        function deleteBackup(backupId) {
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©ÿü')) {
                return;
            }
            
            const index = appState.autoBackup.backups.findIndex(b => b.id === backupId);
            if (index !== -1) {
                appState.autoBackup.backups.splice(index, 1);
                saveBackupsToStorage();
                showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠');
            }
        }
        
        // Download backup
        function downloadBackup(backupId) {
            const backup = appState.autoBackup.backups.find(b => b.id === backupId);
            if (!backup) {
                showError('ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }
            
            const dataStr = JSON.stringify(backup.data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup_${backupId}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
        }
        
        // Clean old backups
        function cleanOldBackups() {
            const initialCount = appState.autoBackup.backups.length;
            
            // Keep only the latest 10 backups
            if (appState.autoBackup.backups.length > 10) {
                appState.autoBackup.backups = appState.autoBackup.backups
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                    .slice(0, 10);
                
                saveBackupsToStorage();
                
                const deletedCount = initialCount - appState.autoBackup.backups.length;
                showSuccess(`ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${deletedCount} ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿØŸäŸÖÿ©`);
            } else {
                showInfo('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿØŸäŸÖÿ© ŸÑŸÑÿ≠ÿ∞ŸÅ');
            }
        }
        
        // Toggle auto backup
        function toggleAutoBackup() {
            appState.autoBackup.enabled = !appState.autoBackup.enabled;
            saveAutoBackupSettings(); // Save settings to localStorage
            
            if (appState.autoBackup.enabled) {
                startAutoBackup();
                showSuccess('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ‚úÖ');
            } else {
                stopAutoBackup();
                showInfo('ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ‚èπÔ∏è');
            }
        }
        
        // Test backup content before restore
        function testBackupContent(backupId) {
            const backup = appState.autoBackup.backups.find(b => b.id === backupId);
            if (!backup) {
                showError('ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }
            
            const backupData = backup.data;
            const stats = backupData.stats || {};
            
            let content = `
                <h3>üîç ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©: ${backup.description}</h3>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <strong>üìä ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÜÿ≥ÿÆÿ©:</strong><br>
                    ‚Ä¢ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤: ${stats.totalCenters || 0}<br>
                    ‚Ä¢ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ: ${stats.totalEmployees || 0}<br>
                    ‚Ä¢ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™: ${stats.totalMovementLogs || stats.totalLogs || 0}<br>
                    ‚Ä¢ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©: ${stats.totalMainLogs || 0}<br>
                    ‚Ä¢ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ©: ${stats.totalAllowedCenters || 0}<br>
                    ‚Ä¢ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ŸäŸÜ: ${stats.totalAllowedEmployees || 0}<br>
                    ‚Ä¢ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÜÿ≥ÿÆÿ©: ${new Date(backupData.timestamp).toLocaleString('ar-SA')}<br>
                    ‚Ä¢ ŸÜŸàÿπ ÿßŸÑŸÜÿ≥ÿÆÿ©: ${backup.type === 'manual' ? 'ŸäÿØŸàŸä' : 'ÿ™ŸÑŸÇÿßÿ¶Ÿä'}<br>
                    ‚Ä¢ ÿ•ÿµÿØÿßÿ± ÿßŸÑŸÜÿ≥ÿÆÿ©: ${stats.backupVersion || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}
                </div>
            `;
            
            if (backupData.centers && backupData.centers.length > 0) {
                content += '<div style="margin: 10px 0;"><strong>üè¢ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤:</strong><ul>';
                backupData.centers.slice(0, 5).forEach(center => {
                    content += `<li>${center.name} (${center.latitude}, ${center.longitude}) - ŸÜÿµŸÅ ÿßŸÑŸÇÿ∑ÿ±: ${center.radius}m</li>`;
                });
                if (backupData.centers.length > 5) {
                    content += `<li>... Ÿà ${backupData.centers.length - 5} ŸÖÿ±ŸÉÿ≤ ÿ¢ÿÆÿ±</li>`;
                }
                content += '</ul></div>';
            }
            
            if (backupData.employees && backupData.employees.length > 0) {
                content += '<div style="margin: 10px 0;"><strong>üë§ ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ:</strong><ul>';
                backupData.employees.slice(0, 5).forEach(employee => {
                    content += `<li>${employee.name} (${employee.phone}) - ${employee.position || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</li>`;
                });
                if (backupData.employees.length > 5) {
                    content += `<li>... Ÿà ${backupData.employees.length - 5} ŸÖŸàÿ∏ŸÅ ÿ¢ÿÆÿ±</li>`;
                }
                content += '</ul></div>';
            }
            
            if (backupData.logs && backupData.logs.length > 0) {
                content += '<div style="margin: 10px 0;"><strong>üìã ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™:</strong><ul>';
                backupData.logs.slice(0, 5).forEach(log => {
                    const actionText = log.action === 'auto_checkin' ? 'ÿØÿÆŸàŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä' : 
                                     log.action === 'auto_checkout' ? 'ÿÆÿ±Ÿàÿ¨ ÿ™ŸÑŸÇÿßÿ¶Ÿä' : 
                                     log.action === 'center_entry' ? 'ÿØÿÆŸàŸÑ ŸÖÿ±ŸÉÿ≤' : 
                                     log.action === 'movement' ? 'ÿ≠ÿ±ŸÉÿ©' : 
                                     log.action === 'location_update' ? 'ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàŸÇÿπ' : log.action;
                    const employeeName = log.employees?.name || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                    const centerName = log.centers?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                    content += `<li>${actionText}: ${employeeName} ŸÅŸä ${centerName}</li>`;
                });
                if (backupData.logs.length > 5) {
                    content += `<li>... Ÿà ${backupData.logs.length - 5} ÿ≠ÿ±ŸÉÿ© ÿ£ÿÆÿ±Ÿâ</li>`;
                }
                content += '</ul></div>';
            }
            
            if (backupData.mainLogs && backupData.mainLogs.length > 0) {
                content += '<div style="margin: 10px 0;"><strong>üìù ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©:</strong><ul>';
                backupData.mainLogs.slice(0, 5).forEach(log => {
                    const actionText = log.action === 'create' ? 'ÿ•ÿ∂ÿßŸÅÿ©' : 
                                     log.action === 'update' ? 'ÿ™ÿπÿØŸäŸÑ' : 
                                     log.action === 'delete' ? 'ÿ≠ÿ∞ŸÅ' : log.action;
                    content += `<li>${actionText} ${log.entity_type}: ${log.entity_name}</li>`;
                });
                if (backupData.mainLogs.length > 5) {
                    content += `<li>... Ÿà ${backupData.mainLogs.length - 5} ÿπŸÖŸÑŸäÿ© ÿ£ÿÆÿ±Ÿâ</li>`;
                }
                content += '</ul></div>';
            }
            
            // Show modal with content
            const modal = document.createElement('div');
            modal.className = 'backup-list-modal';
            modal.innerHTML = `
                <div class="backup-list-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üîç ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</h2>
                        <button class="btn" onclick="this.closest('.backup-list-modal').remove()" style="background: #dc3545; color: white;">‚úï ÿ•ÿ∫ŸÑÿßŸÇ</button>
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${content}
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-warning" onclick="restoreFromBackup('${backupId}'); this.closest('.backup-list-modal').remove();" style="margin: 5px;">
                            üîÑ ÿßÿ≥ÿ™ÿπÿßÿØÿ© Ÿáÿ∞Ÿá ÿßŸÑŸÜÿ≥ÿÆÿ©
                        </button>
                        <button class="btn btn-info" onclick="downloadBackup('${backupId}'); this.closest('.backup-list-modal').remove();" style="margin: 5px;">
                            ‚¨áÔ∏è ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÜÿ≥ÿÆÿ©
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Clear main logs (ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©)
        async function clearMainLogs() {
            try {
                // First, create a backup before clearing
                if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ÿü\nŸáÿ∞ÿß ÿ≥Ÿäÿ∂ŸÖŸÜ ÿπÿØŸÖ ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸáŸÖÿ©.')) {
                    await createManualBackup();
                }
                
                // Confirm the action
                if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©ÿü\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!')) {
                    return;
                }
                
                showLoading();
                
                // Get count of logs before deletion
                const { count, error: countError } = await appState.supabase
                    .from('main_logs')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    throw countError;
                }
                
                // Delete all main logs
                const { error } = await appState.supabase
                    .from('main_logs')
                    .delete()
                    .neq('id', 0); // Delete all records
                
                if (error) throw error;
                
                // Reload main logs to update the display
                await loadMainLogs();
                
                showSuccess(`ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ\nÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${count || 0} ÿ≥ÿ¨ŸÑ`);
                console.log(`‚úÖ Cleared ${count || 0} main logs`);
                
            } catch (error) {
                console.error('Error clearing main logs:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©');
            } finally {
                hideLoading();
            }
        }
        
        // Clear regular logs (ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ© ÿßŸÑÿπÿßÿØŸäÿ©)
        async function clearRegularLogs() {
            try {
                // First, create a backup before clearing
                if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©ÿü\nŸáÿ∞ÿß ÿ≥Ÿäÿ∂ŸÖŸÜ ÿπÿØŸÖ ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸáŸÖÿ©.')) {
                    await createManualBackup();
                }
                
                // Confirm the action
                if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©ÿü\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!')) {
                    return;
                }
                
                showLoading();
                
                // Get count of logs before deletion
                const { count, error: countError } = await appState.supabase
                    .from('logs')
                    .select('*', { count: 'exact', head: true });
                
                if (countError) {
                    throw countError;
                }
                
                // Delete all logs
                const { error } = await appState.supabase
                    .from('logs')
                    .delete()
                    .neq('id', 0); // Delete all records
                
                if (error) throw error;
                
                // Reload logs to update the display
                await loadLogs();
                
                showSuccess(`ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ© ÿ®ŸÜÿ¨ÿßÿ≠! üéâ\nÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${count || 0} ÿ≥ÿ¨ŸÑ`);
                console.log(`‚úÖ Cleared ${count || 0} regular logs`);
                
            } catch (error) {
                console.error('Error clearing regular logs:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©');
            } finally {
                hideLoading();
            }
        }
        
        // Clear all logs (ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™)
        async function clearAllLogs() {
            try {
                // First, create a backup before clearing
                if (confirm('ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿ™ÿµŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ÿü\nŸáÿ∞ÿß ÿ≥Ÿäÿ∂ŸÖŸÜ ÿπÿØŸÖ ŸÅŸÇÿØÿßŸÜ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸáŸÖÿ©.')) {
                    await createManualBackup();
                }
                
                // Confirm the action
                if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿµŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ÿü\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© Ÿàÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©!\nŸáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá!')) {
                    return;
                }
                
                showLoading();
                
                // Get counts before deletion
                const { count: mainLogsCount, error: mainCountError } = await appState.supabase
                    .from('main_logs')
                    .select('*', { count: 'exact', head: true });
                
                const { count: regularLogsCount, error: regularCountError } = await appState.supabase
                    .from('logs')
                    .select('*', { count: 'exact', head: true });
                
                if (mainCountError || regularCountError) {
                    throw mainCountError || regularCountError;
                }
                
                // Delete all main logs
                const { error: mainError } = await appState.supabase
                    .from('main_logs')
                    .delete()
                    .neq('id', 0);
                
                // Delete all regular logs
                const { error: regularError } = await appState.supabase
                    .from('logs')
                    .delete()
                    .neq('id', 0);
                
                if (mainError || regularError) {
                    throw mainError || regularError;
                }
                
                // Reload both logs to update the display
                await Promise.all([loadMainLogs(), loadLogs()]);
                
                const totalDeleted = (mainLogsCount || 0) + (regularLogsCount || 0);
                showSuccess(`ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠! üéâ\nÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${totalDeleted} ÿ≥ÿ¨ŸÑ ÿ•ÿ¨ŸÖÿßŸÑŸä\n- ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©: ${mainLogsCount || 0}\n- ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©: ${regularLogsCount || 0}`);
                console.log(`‚úÖ Cleared all logs: ${totalDeleted} total`);
                
            } catch (error) {
                console.error('Error clearing all logs:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™');
            } finally {
                hideLoading();
            }
        }
        
        // Show clear logs options
        function showClearLogsOptions() {
            const modal = document.createElement('div');
            modal.className = 'backup-list-modal';
            modal.innerHTML = `
                <div class="backup-list-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üóëÔ∏è ÿ™ÿµŸÅŸäÿ± ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™</h2>
                        <button class="btn" onclick="this.closest('.backup-list-modal').remove()" style="background: #dc3545; color: white;">‚úï ÿ•ÿ∫ŸÑÿßŸÇ</button>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 20px;">
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">
                            ÿßÿÆÿ™ÿ± ŸÜŸàÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ™Ÿä ÿ™ÿ±ŸäÿØ ÿ™ÿµŸÅŸäÿ±Ÿáÿß:
                        </p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                        <button class="btn btn-warning" onclick="clearMainLogs(); this.closest('.backup-list-modal').remove();" style="padding: 15px;">
                            üìù ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©<br>
                            <small style="opacity: 0.8;">ÿ≥ÿ¨ŸÑ ÿ•ÿ∂ÿßŸÅÿ© Ÿàÿ™ÿπÿØŸäŸÑ Ÿàÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ŸàÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ</small>
                        </button>
                        
                        <button class="btn btn-warning" onclick="clearRegularLogs(); this.closest('.backup-list-modal').remove();" style="padding: 15px;">
                            üìã ÿ™ÿµŸÅŸäÿ± ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©<br>
                            <small style="opacity: 0.8;">ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ∂Ÿàÿ± ŸàÿßŸÑÿßŸÜÿµÿ±ÿßŸÅ ŸàÿßŸÑÿ≠ÿ±ŸÉÿßÿ™</small>
                        </button>
                        
                        <button class="btn btn-danger" onclick="clearAllLogs(); this.closest('.backup-list-modal').remove();" style="padding: 15px;">
                            üóëÔ∏è ÿ™ÿµŸÅŸäÿ± ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™<br>
                            <small style="opacity: 0.8;">ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© + ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©</small>
                        </button>
                    </div>
                    
                    <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <strong>‚ö†Ô∏è ÿ™ÿ≠ÿ∞Ÿäÿ±:</strong><br>
                        ‚Ä¢ ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿµŸÅŸäÿ±<br>
                        ‚Ä¢ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ° ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜŸá<br>
                        ‚Ä¢ ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÜŸàÿπ ÿßŸÑÿµÿ≠Ÿäÿ≠ ŸÖŸÜ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Get backup status
        function getBackupStatus() {
            return {
                enabled: appState.autoBackup.enabled,
                lastBackup: appState.autoBackup.lastBackupTime,
                totalBackups: appState.autoBackup.backups.length,
                isBackingUp: appState.autoBackup.isBackingUp,
                nextBackup: appState.autoBackup.lastBackupTime ? 
                    appState.autoBackup.lastBackupTime + appState.autoBackup.interval : null
            };
        }

        // Show backup list modal
        function showBackupList() {
            const backups = getBackupList();
            
            const modal = document.createElement('div');
            modal.className = 'backup-list-modal';
            modal.innerHTML = `
                <div class="backup-list-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>üìã ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</h2>
                        <button class="btn" onclick="this.closest('.backup-list-modal').remove()" style="background: #dc3545; color: white;">‚úï ÿ•ÿ∫ŸÑÿßŸÇ</button>
                    </div>
                    
                    <div id="backupListContainer">
                        ${backups.length === 0 ? 
                            '<p style="text-align: center; color: var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ≥ÿÆ ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©</p>' :
                            backups.map((backup, index) => {
                                const backupDate = new Date(backup.timestamp);
                                const dateStr = backupDate.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:mm
                                return `
                                <div class="backup-item ${index === 0 ? 'latest' : ''}">
                                    <div class="backup-info">
                                        <h4>${backup.description} ${index === 0 ? '<span style="color: #28a745; font-size: 0.8em;">(ÿßŸÑÿ£ÿ≠ÿØÿ´)</span>' : ''}</h4>
                                        <p>
                                            üìÖ <input type="datetime-local" id="backup-time-${backup.id}" value="${dateStr}" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;" onchange="updateBackupTime('${backup.id}', this.value)" /> | 
                                            üì¶ ${formatFileSize(backup.size)} | 
                                            üîÑ ${backup.type === 'manual' ? 'ŸäÿØŸàŸä' : 'ÿ™ŸÑŸÇÿßÿ¶Ÿä'}
                                        </p>
                                        <p style="font-size: 0.8em; color: #6c757d;">
                                            ÿßŸÑŸÖÿ±ÿßŸÉÿ≤: ${backup.stats?.totalCenters || 0} | 
                                            ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ: ${backup.stats?.totalEmployees || 0} | 
                                            ÿ≥ÿ¨ŸÑ ÿßŸÑÿ≠ÿ±ŸÉÿßÿ™: ${backup.stats?.totalMovementLogs || backup.stats?.totalLogs || 0} |
                                            ÿ≥ÿ¨ŸÑ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©: ${backup.stats?.totalMainLogs || 0}
                                            ${backup.stats?.totalAllowedCenters ? ` | ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ÿ©: ${backup.stats.totalAllowedCenters}` : ''}
                                            ${backup.stats?.totalAllowedEmployees ? ` | ÿßŸÑŸÖŸàÿ∏ŸÅŸäŸÜ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ŸäŸÜ: ${backup.stats.totalAllowedEmployees}` : ''}
                                        </p>
                                    </div>
                                    <div class="backup-actions">
                                        <button class="btn btn-info" onclick="testBackupContent('${backup.id}')" title="ÿßÿÆÿ™ÿ®ÿßÿ±">
                                            üîç
                                        </button>
                                        <button class="btn btn-info" onclick="downloadBackup('${backup.id}')" title="ÿ™ÿ≠ŸÖŸäŸÑ">
                                            ‚¨áÔ∏è
                                        </button>
                                        <button class="btn btn-warning" onclick="restoreFromBackup('${backup.id}'); this.closest('.backup-list-modal').remove();" title="ÿßÿ≥ÿ™ÿπÿßÿØÿ©">
                                            üîÑ
                                        </button>
                                        <button class="btn btn-danger" onclick="deleteBackup('${backup.id}'); this.closest('.backup-list-modal').remove();" title="ÿ≠ÿ∞ŸÅ">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `;
                            }).join('')
                        }
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="createManualBackup(); this.closest('.backup-list-modal').remove();">
                            üîÑ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿ¨ÿØŸäÿØÿ©
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Update backup timestamp
        function updateBackupTime(backupId, newDateTime) {
            const backup = appState.autoBackup.backups.find(b => b.id === backupId);
            if (!backup) {
                showError('ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                return;
            }
            
            try {
                // Convert datetime-local value to ISO string
                const newTimestamp = new Date(newDateTime).toISOString();
                
                // Update backup timestamp
                backup.timestamp = newTimestamp;
                
                // Also update timestamp in backup data if it exists
                if (backup.data && backup.data.timestamp) {
                    backup.data.timestamp = newTimestamp;
                }
                
                // Save to storage
                saveBackupsToStorage();
                
                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ© ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ');
                
                // Refresh the backup list display
                const modal = document.querySelector('.backup-list-modal');
                if (modal) {
                    modal.remove();
                    showBackupList();
                }
            } catch (error) {
                console.error('Error updating backup time:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©');
            }
        }
        
        // Update backup status in UI
        function updateBackupStatus() {
            const status = getBackupStatus();
            
            // Update status values
            const statusValue = document.getElementById('backupStatusValue');
            const lastBackupTime = document.getElementById('lastBackupTime');
            const totalBackups = document.getElementById('totalBackups');
            
            if (statusValue) {
                statusValue.textContent = status.enabled ? 'ŸÖŸÅÿπŸÑ ‚úÖ' : 'ŸÖÿπÿ∑ŸÑ ‚ùå';
                statusValue.style.color = status.enabled ? '#28a745' : '#dc3545';
            }
            
            if (lastBackupTime) {
                if (status.lastBackup) {
                    const timeAgo = getTimeDifference(new Date(status.lastBackup).toISOString());
                    lastBackupTime.textContent = timeAgo;
                } else {
                    lastBackupTime.textContent = 'ŸÑŸÖ Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÜÿ≥ÿÆÿ© ÿ®ÿπÿØ';
                }
            }
            
            if (totalBackups) {
                totalBackups.textContent = status.totalBackups;
            }
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Get time difference
        function getTimeDifference(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = now - time;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (days > 0) return `ŸÖŸÜÿ∞ ${days} ŸäŸàŸÖ`;
            if (hours > 0) return `ŸÖŸÜÿ∞ ${hours} ÿ≥ÿßÿπÿ©`;
            if (minutes > 0) return `ŸÖŸÜÿ∞ ${minutes} ÿØŸÇŸäŸÇÿ©`;
            return 'ÿßŸÑÿ¢ŸÜ';
        }
        
        // Initialize backup settings from UI
        function initializeBackupSettings() {
            const autoSaveCheckbox = document.getElementById('autoSaveOnChange');
            const includeLogsCheckbox = document.getElementById('includeLogs');
            const backupIntervalInput = document.getElementById('backupInterval');
            
            if (autoSaveCheckbox) {
                autoSaveCheckbox.checked = appState.autoBackup.settings.autoSaveOnChange;
                autoSaveCheckbox.addEventListener('change', function() {
                    appState.autoBackup.settings.autoSaveOnChange = this.checked;
                    saveAutoBackupSettings(); // Save settings to localStorage
                });
            }
            
            if (includeLogsCheckbox) {
                includeLogsCheckbox.checked = appState.autoBackup.settings.includeLogs;
                includeLogsCheckbox.addEventListener('change', function() {
                    appState.autoBackup.settings.includeLogs = this.checked;
                    saveAutoBackupSettings(); // Save settings to localStorage
                });
            }
            
            if (backupIntervalInput) {
                backupIntervalInput.value = appState.autoBackup.interval / 1000;
                backupIntervalInput.removeAttribute('readonly');
                backupIntervalInput.removeAttribute('disabled');
                backupIntervalInput.removeAttribute('max'); // Remove max constraint
                backupIntervalInput.setAttribute('min', '1'); // Set minimum to 1 second
                backupIntervalInput.addEventListener('change', function() {
                    const inputValue = parseFloat(this.value);
                    if (isNaN(inputValue) || inputValue < 1) {
                        showError('ŸÅÿ™ÿ±ÿ© ÿßŸÑŸÜÿ≥ÿÆ Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ ŸÇŸäŸÖÿ© ÿµÿ≠Ÿäÿ≠ÿ© ÿ£ŸÉÿ®ÿ± ŸÖŸÜ 0');
                        this.value = appState.autoBackup.interval / 1000; // Reset to current value
                        return;
                    }
                    
                    const newInterval = Math.round(inputValue * 1000); // Convert to milliseconds
                    appState.autoBackup.interval = newInterval;
                    saveAutoBackupSettings(); // Save settings to localStorage
                    
                    if (appState.autoBackup.enabled) {
                        startAutoBackup();
                    }
                    
                    // Show friendly message with the interval
                    let intervalText = '';
                    if (inputValue < 60) {
                        intervalText = `${inputValue} ÿ´ÿßŸÜŸäÿ©`;
                    } else if (inputValue < 3600) {
                        intervalText = `${(inputValue / 60).toFixed(1)} ÿØŸÇŸäŸÇÿ©`;
                    } else if (inputValue < 86400) {
                        intervalText = `${(inputValue / 3600).toFixed(1)} ÿ≥ÿßÿπÿ©`;
                    } else {
                        intervalText = `${(inputValue / 86400).toFixed(1)} ŸäŸàŸÖ`;
                    }
                    
                    showSuccess(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÅÿ™ÿ±ÿ© ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿ•ŸÑŸâ ${intervalText} ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ`);
                });
            }
        }
 
        async function loadCenterStats() {
            try {
                let query = appState.supabase
                    .from('logs')
                    .select('center_id, action, employee_id');

                if (appState.currentUser.role !== 'admin' && appState.allowedEmployees.length > 0) {
                    const employeeIds = appState.allowedEmployees.map(emp => emp.employee_id || emp.id);
                    query = query.in('employee_id', employeeIds);
                }

                const { data: logs, error } = await query;
                if (error) throw error;

                appState.centerStats = {};
                const checkinMap = {};
                const checkoutMap = {};
                logs.forEach(log => {
                    if (!appState.centerStats[log.center_id]) {
                        appState.centerStats[log.center_id] = { checkins: 0, checkouts: 0 };
                    }
       
                    if (log.action.includes('checkin') || log.action === 'in' || log.action === 'center_entry') {
                        if (!checkinMap[log.center_id]) checkinMap[log.center_id] = new Set();
                        checkinMap[log.center_id].add(log.employee_id);
                    }
            
                    if (log.action.includes('checkout') || log.action === 'out') {
                        if (!checkoutMap[log.center_id]) checkoutMap[log.center_id] = new Set();
                        checkoutMap[log.center_id].add(log.employee_id);
                    }
                });
                Object.keys(appState.centerStats).forEach(centerId => {
                    appState.centerStats[centerId].checkins = checkinMap[centerId] ? checkinMap[centerId].size : 0;
                    appState.centerStats[centerId].checkouts = checkoutMap[centerId] ? checkoutMap[centerId].size : 0;
                });
                console.log('Center stats loaded:', appState.centerStats);
            } catch (error) {
                console.error('Error loading center stats:', error);
                appState.centerStats = {};
            }
        }

        async function loadAllowedCenters() {
            try {
                const { data: centers, error } = await appState.supabase.rpc('get_user_allowed_centers', {
                    input_user_id: appState.currentUser.id
                });

                if (error) throw error;

                appState.allowedCenters = centers || [];
                displayCenters(appState.allowedCenters);
                if (appState.map && appState.map.isStyleLoaded()) {
                    updateMapMarkers();
                }
                populateNewUserCenters();
            } catch (error) {
                console.error('Error loading allowed centers:', error);
            }
        }

        async function loadAllowedEmployees() {
            try {
                const { data: employees, error } = await appState.supabase.rpc('get_user_allowed_employees', {
                    input_user_id: appState.currentUser.id
                });

                if (error) throw error;

                appState.allowedEmployees = employees || [];
                displayEmployees(appState.allowedEmployees);
            } catch (error) {
                console.error('Error loading allowed employees:', error);
            }
        }

        async function loadCenters() {
            try {
                const { data: centers, error } = await appState.supabase
                    .from('centers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                appState.allCenters = centers || [];
                displayCenters(appState.allCenters);
                if (appState.map && appState.map.isStyleLoaded()) {
                    updateMapMarkers();
                }
                populateNewUserCenters();
            } catch (error) {
                console.error('Error loading centers:', error);
            }
        }

        async function loadEmployees() {
            try {
                const { data: employees, error } = await appState.supabase
                    .from('employees')
                    .select(`*, centers (name)`)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                appState.allEmployees = employees || [];
                displayEmployees(appState.allEmployees);
            } catch (error) {
                console.error('Error loading employees:', error);
            }
        }
        function displayCenters(centers) {
            const centersList = document.getElementById('centersList');
            const centerSelect = document.getElementById('employeeCenter');
            
            centersList.innerHTML = '';
            centerSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±ŸÉÿ≤</option>';

            if (centers && centers.length > 0) {
                centers.forEach(center => {
                    const centerDiv = document.createElement('div');
                    centerDiv.className = 'item-card';
                    
                    let actionsHtml = '';
                    if (appState.currentUser && appState.currentUser.role === 'admin' && appState.userPermissions && appState.userPermissions.can_edit_centers) {
                        actionsHtml += `<button class="btn btn-success btn-small tooltip" onclick="editCenter(${center.id || center.center_id})" data-tooltip="ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ŸÉÿ≤">ÿ™ÿπÿØŸäŸÑ</button>`;
                        actionsHtml += `<button class="btn btn-danger btn-small tooltip" onclick="deleteCenter(${center.id || center.center_id}, '${center.name || center.center_name}')" data-tooltip="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ±ŸÉÿ≤">ÿ≠ÿ∞ŸÅ</button>`;
                    }
                    const centerName = center.name || center.center_name;
                    const centerLat = center.latitude;
                    const centerLng = center.longitude;
                    const centerRadius = center.radius;
                    const centerId = center.id || center.center_id;
                    
                    const stats = appState.centerStats[centerId] || { checkins: 0, checkouts: 0 };
                
                    centerDiv.innerHTML = `
                        <div class="item-info">
                            <strong>${centerName}</strong><br>
                            <small>ŸÜÿ∑ÿßŸÇ: ${centerRadius} ŸÖÿ™ÿ± ‚Ä¢ ÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™: ${centerLat.toFixed(4)}, ${centerLng.toFixed(4)}</small><br>
                                            <small>ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑŸäŸàŸÖ: <span style="color: var(--checkin-color);">${stats.checkins}</span> ‚Ä¢
                ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑŸäŸàŸÖ: <span style="color: #3b82f6;">${stats.checkouts}</span></small>
                        </div>
                        <div class="item-actions">
                            ${actionsHtml}
                        </div>
                    `;
                    centersList.appendChild(centerDiv);

                    const option = document.createElement('option');
                    option.value = center.id || center.center_id;
                    option.textContent = centerName;
                    centerSelect.appendChild(option);
                });
            } else {
                centersList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ±ÿßŸÉÿ≤ ŸÖÿ™ÿßÿ≠ÿ©</p>';
            }
        }

        function displayEmployees(employees) {
            const employeesList = document.getElementById('employeesList');
            const pagination = appState.pagination.employees;
            
            pagination.totalPages = Math.ceil(employees.length / pagination.pageSize);
            const startIndex = (pagination.currentPage - 1) * pagination.pageSize;
            const endIndex = startIndex + pagination.pageSize;
            const paginatedEmployees = employees.slice(startIndex, endIndex);
            
            employeesList.innerHTML = '';

            if (paginatedEmployees && paginatedEmployees.length > 0) {
                paginatedEmployees.forEach(employee => {
                    const empName = employee.name || employee.employee_name;
                    const employeeDiv = document.createElement('div');
                    employeeDiv.className = `item-card employee-card ${employee.status}`;
                    let actionsHtml = `<span class="employee-status ${employee.status}">${employee.status === 'active' ? 'üü¢ ŸÜÿ¥ÿ∑' : 'üî¥ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑'}</span>`;
                    if (appState.currentUser && appState.currentUser.role === 'admin' && appState.userPermissions && appState.userPermissions.can_edit_employees) {
                        actionsHtml += `<button class="btn btn-success btn-small tooltip" onclick="editEmployee(${employee.id || employee.employee_id})" data-tooltip="ÿ™ÿπÿØŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ±ÿØ">ÿ™ÿπÿØŸäŸÑ</button>`;
                        actionsHtml += `<button class="btn btn-danger btn-small tooltip" onclick="deleteEmployee(${employee.id || employee.employee_id}, '${empName}')" data-tooltip="ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿ±ÿØ">ÿ≠ÿ∞ŸÅ</button>`;
                    }
                    if (typeof employee.latitude === 'number' && typeof employee.longitude === 'number' && !isNaN(employee.latitude) && !isNaN(employee.longitude)) {
                        actionsHtml += `<button class="btn btn-info btn-small tooltip" onclick="focusOnEmployeeFromList(${employee.latitude}, ${employee.longitude}, '${employee.name || employee.employee_name}')" data-tooltip="ÿ™ÿ™ÿ®ÿπ ŸÖŸàŸÇÿπ ÿßŸÑŸÅÿ±ÿØ">ÿ™ÿ™ÿ®ÿπ</button>`;
                    }
                
                    let loginText = employee.last_login_formatted || employee.last_login;
                    if (loginText) {
                        const date = new Date(loginText);
                        loginText = date.toLocaleString('ar-IQ', { hour: '2-digit', minute: '2-digit', year: 'numeric', month: '2-digit', day: '2-digit', hour12: true, timeZone: 'Asia/Baghdad' });
                    }
                    let loginStatus = '';
                    if (!employee.last_login && !employee.last_login_formatted) {
                        loginStatus = '<span style="color: var(--warning); font-size: 0.9em;">ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</span>';
                    } else {
                        loginStatus = `<span style=\"color: var(--success); font-size: 0.9em;\">ÿ¢ÿÆÿ± ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤: ${loginText || ''}</span>`;
                    }

                    function formatActivityDate(dateStr) {
                        if (!dateStr) return '';
                        const date = new Date(dateStr);
                        return date.toLocaleString('ar-IQ', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Baghdad' });
                    }

                    let lastActivity = employee.last_activity_formatted || employee.last_login_formatted || employee.last_login;
                    let lastActivityType = '';
                    if (employee.last_activity_formatted) {
                        lastActivityType = employee.last_activity_action ? getActionText(employee.last_activity_action) : 'ŸÜÿ¥ÿßÿ∑';
                    } else if (employee.last_login_formatted) {
                        lastActivityType = 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ';
                    }

                    let isActive = employee.status === 'active';
                    let statusText = isActive ? 'üü¢ ŸÜÿ¥ÿ∑' : 'üî¥ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑';
                    let statusColor = isActive ? 'var(--success)' : 'var(--danger)';

                    let activityHtml = '';
                    if (lastActivity) {
                        activityHtml = `<span style="color: ${statusColor}; font-size: 0.95em;">ÿ¢ÿÆÿ± ŸÜÿ¥ÿßÿ∑: ${lastActivityType} - ${formatActivityDate(lastActivity)}</span>`;
                    } else {
                        activityHtml = '<span style="color: var(--warning); font-size: 0.95em;">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÜÿ¥ÿßÿ∑ ŸÖÿ≥ÿ¨ŸÑ ÿ®ÿπÿØ</span>';
                    }

                    employeeDiv.innerHTML = `
                        <div class="item-info">
                            <strong>${empName}</strong><br>
                            ${activityHtml}<br>
                            <small>${employee.position || 'ŸÖŸàÿ∏ŸÅ'} ‚Ä¢ üì± <span class="phone-masked" data-phone="${employee.phone}" onclick="togglePhoneVisibility(this)">${maskPhoneNumber(employee.phone)}</span></small><br>
                            <small>ÿßŸÑŸÖÿ±ŸÉÿ≤: ${employee.centers?.name || employee.center_name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</small>
                        </div>
                        <div class="item-actions">
                            ${actionsHtml}
                        </div>
                    `;
                    employeesList.appendChild(employeeDiv);
                });
                const paginationDiv = document.getElementById('employeesPagination');
                if (pagination.totalPages > 1) {
                    paginationDiv.style.display = 'flex';
                    document.getElementById('employeesPageInfo').textContent = 
                        `ÿµŸÅÿ≠ÿ© ${pagination.currentPage} ŸÖŸÜ ${pagination.totalPages} (${employees.length} ŸÅÿ±ÿØ)`;
                } else {
                    paginationDiv.style.display = 'none';
                }
            } else {
                employeesList.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÅÿ±ÿßÿØ ŸÖÿ™ÿßÿ≠ŸäŸÜ</p>';
            }
        }
        async function refreshEmployeeLocations() {
            try {
                let employeeIds = [];
                
                if (appState.currentUser.role === 'admin') {
                    const { data: allEmps } = await appState.supabase.from('employees').select('id');
                    employeeIds = allEmps ? allEmps.map(emp => emp.id) : [];
                } else {
                    employeeIds = appState.allowedEmployees.map(emp => emp.employee_id || emp.id);
                }

                if (employeeIds.length === 0) {
                    document.getElementById('employeeLocations').innerHTML = 
                        '<p style="color: var(--text-secondary); text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸàÿßŸÇÿπ ŸÖÿ™ÿßÿ≠ÿ©</p>';
                    return;
                }

                const { data: latestLogs, error } = await appState.supabase
                    .from('logs')
                    .select(`*, employees (id, name, status, phone), centers (name)`)
                    .in('employee_id', employeeIds)
                    .not('latitude', 'is', null)
                    .not('longitude', 'is', null)
                    .order('occurred_at', { ascending: false });

                if (error) throw error;
                const employeeLocations = {};
                latestLogs.forEach(log => {
                    if (log.employees && !employeeLocations[log.employees.id]) {
                        employeeLocations[log.employees.id] = {
                            employee: log.employees,
                            center: log.centers,
                            location: {
                                latitude: log.latitude,
                                longitude: log.longitude,
                                action: log.action,
                                time: log.occurred_at || log.created_at
                            }
                        };
                    }
                });

                displayEmployeeLocations(employeeLocations);
                updateMapWithEmployees(employeeLocations);
            } catch (error) {
                console.error('Error loading employee locations:', error);
                document.getElementById('employeeLocations').innerHTML = 
                    '<p style="color: var(--text-secondary); text-align: center;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸàÿßŸÇÿπ</p>';
            }
        }

        function displayEmployeeLocations(employeeLocations) {
            const container = document.getElementById('employeeLocations');
            const locations = Object.values(employeeLocations);
            const searchTerm = document.getElementById('searchMovements')?.value.toLowerCase() || '';
            const filteredLocations = locations.filter(empData => 
                empData.employee.name.toLowerCase().includes(searchTerm)
            );
            
            const pagination = appState.pagination.locations;
            pagination.totalPages = Math.ceil(filteredLocations.length / pagination.pageSize);
            const startIndex = (pagination.currentPage - 1) * pagination.pageSize;
            const endIndex = startIndex + pagination.pageSize;
            const paginatedLocations = filteredLocations.slice(startIndex, endIndex);
            
            container.innerHTML = '';

            if (paginatedLocations.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸàÿßŸÇÿπ ÿ≠ÿØŸäÿ´ÿ©</p>';
                return;
            }

            paginatedLocations.forEach(empData => {
                const locationDiv = document.createElement('div');
                locationDiv.className = 'location-card';
                
                const timeDiff = getTimeDifference(empData.location.time);
                const actionText = getActionText(empData.location.action);
                const statusText = empData.employee.status === 'active' ? 'ŸÜÿ¥ÿ∑' : 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑';
                const maskedPhone = maskPhoneNumber(empData.employee.phone);

                locationDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: bold; margin-bottom: 3px; font-size: 0.9em;">
                                ${empData.employee.name}
                                <span class="employee-status ${empData.employee.status}" style="font-size: 0.75em; padding: 2px 6px;">
                                    ${empData.employee.status === 'active' ? 'üü¢' : 'üî¥'} ${statusText}
                                </span>
                            </div>
                            <div style="font-size: 0.8em; margin-bottom: 2px; color: #4b5563;">
                                üì± <span class="phone-masked" data-phone="${empData.employee.phone}" onclick="togglePhoneVisibility(this)">${maskedPhone}</span> ‚Ä¢ üìç ${actionText}
                            </div>
                            <div style="font-size: 0.75em; color: #6b7280;">
                                üìç ${empData.center?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'} ‚Ä¢ üïê <span class="time-ago" data-timestamp="${empData.location.time}">${timeDiff}</span>
                            </div>
                        </div>
                        <button class="btn btn-small tooltip" onclick="focusOnEmployee(${empData.location.latitude}, ${empData.location.longitude}, '${empData.employee.name}')" data-tooltip="ÿπÿ±ÿ∂ ŸÖŸàŸÇÿπ ÿßŸÑŸÅÿ±ÿØ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©" style="font-size: 0.8em; padding: 6px 10px; flex-shrink: 0;">
                            üìç ÿπÿ±ÿ∂
                        </button>
                    </div>
                `;
                container.appendChild(locationDiv);
            });

            const paginationDiv = document.getElementById('locationsPagination');
            if (pagination.totalPages > 1) {
                paginationDiv.style.display = 'flex';
                document.getElementById('locationsPageInfo').textContent = 
                    `ÿµŸÅÿ≠ÿ© ${pagination.currentPage} ŸÖŸÜ ${pagination.totalPages} (${filteredLocations.length} ŸÖŸàŸÇÿπ)`;
            } else {
                paginationDiv.style.display = 'none';
            }
        }

        function focusOnEmployee(lat, lng, name) {
            if (!appState.map) {
                showError('ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ© ÿ∫Ÿäÿ± ŸÖÿ≠ŸÖŸÑÿ© ÿ®ÿπÿØ');
                return;
            }

            appState.map.flyTo({
                center: [lng, lat],
                zoom: 16,
                duration: 2000
            });
            
            showInfo(`ÿ™ŸÖ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ŸÖŸàŸÇÿπ ${name}`);
        }

        async function loadLogs() {
            try {
                let query = appState.supabase
                    .from('logs')
                    .select(`*, employees (name, phone), centers (name)`)
                    .order('occurred_at', { ascending: false })
                    .limit(200);

                if (appState.currentUser.role !== 'admin' && appState.allowedEmployees.length > 0) {
                    const employeeIds = appState.allowedEmployees.map(emp => emp.employee_id || emp.id);
                    query = query.in('employee_id', employeeIds);
                }

                const { data: logs, error } = await query;
                if (error) throw error;

                appState.allLogs = logs || [];
                displayLogs(appState.allLogs);
                
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        function filterUniqueLogs(logs) {

            logs.sort((a, b) => new Date(a.occurred_at || a.created_at) - new Date(b.occurred_at || b.created_at));
            const uniqueLogs = [];
            const lastActionByEmployee = {};
            logs.forEach(log => {
                const empId = log.employee_id;
                const action = log.action;
                if (lastActionByEmployee[empId] === action) {
                    return;
                }
                uniqueLogs.push(log);
                lastActionByEmployee[empId] = action;
            });
            return uniqueLogs;
        }

        function displayLogs(logs) {

            logs = filterUniqueLogs(logs);
            const logsContainer = document.getElementById('activityLogs');
            
            const pagination = appState.pagination.logs;
            pagination.totalPages = Math.ceil(logs.length / pagination.pageSize);
            const startIndex = (pagination.currentPage - 1) * pagination.pageSize;
            const endIndex = startIndex + pagination.pageSize;
            const paginatedLogs = logs.slice(startIndex, endIndex);
            
            logsContainer.innerHTML = '';

            if (paginatedLogs && paginatedLogs.length > 0) {

                paginatedLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.className = `log-entry ${log.action}`;
                    
                    const logTime = log.occurred_at || log.created_at;
                    const timeAgo = getTimeDifference(logTime);
                    const fullTime = formatDateEnhanced(logTime);
                    
                    const actionText = getActionText(log.action);
                    const actionIcon = getActionIcon(log.action);
                    
                    // ÿ™ÿ≠ÿØŸäÿØ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ≠ÿ≥ÿ® ŸÜŸàÿπ ÿßŸÑÿ≥ÿ¨ŸÑ
                    let displayName = 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                    if (log.action === 'user_login' || log.action === 'account_login') {
                        // ŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑÿå ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿßÿ≥ŸÖ ŸÖŸÜ notes
                        if (log.notes && log.notes.includes('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ')) {
                            displayName = log.notes.replace('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ', '');
                        } else {
                            displayName = log.employees?.name || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ';
                        }
                    } else {
                        displayName = log.employees?.name || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                    }
                    
                    let actionDisplay = actionText;
                    if (log.action === 'user_login' || log.action === 'account_login') {
                        // ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®
                        actionDisplay = `<span style="color: #3b82f6; font-weight: bold;">üîê ÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ ÿ®ÿ≠ÿ≥ÿßÿ®Ÿá ÿßŸÑÿ≥ÿßÿπÿ© ${new Date(logTime).toLocaleTimeString('ar-IQ', {timeZone: 'Asia/Baghdad', hour12: true})}</span>`;
                    } else if (log.action.includes('checkin') || log.action === 'in' || log.action === 'center_entry') {
                        // ÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ŸÖÿ±ŸÉÿ≤
                        actionDisplay = `<span style="color: var(--checkin-color); font-weight: bold;">‚úÖ ÿØÿÆŸÑ ${log.centers?.name ? 'ÿ•ŸÑŸâ ' + log.centers.name : 'ÿ•ŸÑŸâ ÿßŸÑŸÖÿ±ŸÉÿ≤'} ÿßŸÑÿ≥ÿßÿπÿ© ${new Date(logTime).toLocaleTimeString('ar-IQ', {timeZone: 'Asia/Baghdad', hour12: true})}</span>`;
                    } else if (log.action.includes('checkout') || log.action === 'out') {
                        // ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ŸÖÿ±ŸÉÿ≤
                        const centerName = log.centers?.name ? ` ŸÖŸÜ ${log.centers.name}` : ' ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤';
                        actionDisplay = `<span style="color: #dc2626; font-weight: bold;">üö™ ÿÆÿ±ÿ¨${centerName} ÿßŸÑÿ≥ÿßÿπÿ© ${new Date(logTime).toLocaleTimeString('ar-IQ', {timeZone: 'Asia/Baghdad', hour12: true})}</span>`;
                    }
                    
                    // ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑŸÖÿπÿ±Ÿàÿ∂ÿ© ŸÑŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑŸäÿØŸàŸäÿ©
                    let displayNotes = '';
                    if (log.notes && !log.notes.includes('ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ')) {
                        if (log.action === 'manual_checkin') {
                            // ÿ™ÿ∫ŸäŸäÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑŸäÿØŸàŸä
                            displayNotes = '<span>üìù ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÅÿ±ÿØ ŸÅŸä Ÿáÿßÿ™ŸÅŸá</span>';
                        } else if (log.action === 'manual_checkout') {
                            // ÿ™ÿ∫ŸäŸäÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿßŸÑŸäÿØŸàŸä
                            displayNotes = '<span>üìù ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨ ÿßŸÑŸÅÿ±ÿØ ŸÖŸÜ Ÿáÿßÿ™ŸÅŸá</span>';
                        } else {
                            // ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ© ŸÑŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ£ÿÆÿ±Ÿâ
                            displayNotes = `<span>üìù ${log.notes}</span>`;
                        }
                    }
                    
                    logDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${actionIcon} ${displayName}</strong>
                                <span style="margin: 0 10px;">‚Ä¢</span>
                                <span>${actionDisplay}</span>
                            </div>
                            <div style="font-size: 0.8em; color: var(--text-secondary);">
                                <span class="time-ago" data-timestamp="${logTime}">${timeAgo}</span>
                            </div>
                        </div>
                        <div class="log-meta">
                            <span class="date-formatted">üìÖ ${fullTime}</span>
                            ${displayNotes}
                        </div>
                    `;
                    logsContainer.appendChild(logDiv);
                });


                const paginationDiv = document.getElementById('logsPagination');
                if (pagination.totalPages > 1) {
                    paginationDiv.style.display = 'flex';
                    document.getElementById('logsPageInfo').textContent = 
                        `ÿµŸÅÿ≠ÿ© ${pagination.currentPage} ŸÖŸÜ ${pagination.totalPages} (${logs.length} ÿ≥ÿ¨ŸÑ)`;
                } else {
                    paginationDiv.style.display = 'none';
                }
            } else {
                logsContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ŸÜÿ¥ÿßÿ∑ ÿ®ÿπÿØ</p>';
            }
        }

        async function updateStats() {
            try {
                let employeesCount, activeCount, centersCount, checkedInCount, checkedOutCount;

                if (appState.currentUser.role === 'admin') {
                    const [empRes, activeRes, centerRes] = await Promise.all([
                        appState.supabase.from('employees').select('*', { count: 'exact', head: true }),
                        appState.supabase.from('employees').select('*', { count: 'exact', head: true }).eq('status', 'active'),
                        appState.supabase.from('centers').select('*', { count: 'exact', head: true })
                    ]);
                    employeesCount = empRes.count || 0;
                    activeCount = activeRes.count || 0;
                    centersCount = centerRes.count || 0;
                } else {
                    employeesCount = appState.allowedEmployees.length;
                    activeCount = appState.allowedEmployees.filter(emp => emp.status === 'active').length;
                    centersCount = appState.allowedCenters.length;
                }

                let checkinQuery = appState.supabase
                    .from('logs')
                    .select('employee_id')
                    .gte('occurred_at', getTodayDateStart())
                    .in('action', ['in', 'checkin', 'auto_checkin', 'center_entry']);

                let checkoutQuery = appState.supabase
                    .from('logs')
                    .select('employee_id')
                    .gte('occurred_at', getTodayDateStart())
                    .in('action', ['out', 'checkout', 'auto_checkout']);

                if (appState.currentUser.role !== 'admin' && appState.allowedEmployees.length > 0) {
                    const employeeIds = appState.allowedEmployees.map(emp => emp.employee_id || emp.id);
                    checkinQuery = checkinQuery.in('employee_id', employeeIds);
                    checkoutQuery = checkoutQuery.in('employee_id', employeeIds);
                }

                const [checkinRes, checkoutRes] = await Promise.all([checkinQuery, checkoutQuery]);
                const checkinIds = Array.isArray(checkinRes.data) ? [...new Set(checkinRes.data.map(l => l.employee_id))] : [];
                const checkoutIds = Array.isArray(checkoutRes.data) ? [...new Set(checkoutRes.data.map(l => l.employee_id))] : [];
                checkedInCount = checkinIds.length;
                checkedOutCount = checkoutIds.length; 

                if(document.getElementById('totalEmployees'))
                    document.getElementById('totalEmployees').textContent = employeesCount;
                if(document.getElementById('activeEmployees'))
                    document.getElementById('activeEmployees').textContent = activeCount;
                if(document.getElementById('checkedInEmployees'))
                    document.getElementById('checkedInEmployees').textContent = checkedInCount;
                if(document.getElementById('checkedOutEmployees'))
                    document.getElementById('checkedOutEmployees').textContent = checkedOutCount;
                if(document.getElementById('totalCenters'))
                    document.getElementById('totalCenters').textContent = centersCount;
                if(document.getElementById('centersCount'))
                    document.getElementById('centersCount').textContent = centersCount;
                if(document.getElementById('activeUsers'))
                    document.getElementById('activeUsers').textContent = activeCount;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        async function updateMapMarkers() {
            if (!appState.map || !appState.map.isStyleLoaded()) {
                console.log('Map not ready yet...');
                return;
            }

            try {

                ['centers-layer', 'center-labels'].forEach(layerId => {
                    if (appState.map.getLayer(layerId)) appState.map.removeLayer(layerId);
                });
                if (appState.map.getSource('centers')) appState.map.removeSource('centers');

                const centersToShow = appState.currentUser.role === 'admin' ? appState.allCenters : appState.allowedCenters;

                if (centersToShow && centersToShow.length > 0) {
                    const geojsonData = {
                        type: 'FeatureCollection',
                        features: centersToShow.map(center => {
                            const centerId = center.id || center.center_id;
                            const stats = appState.centerStats[centerId] || { checkins: 0, checkouts: 0 };
                            return {
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [center.longitude, center.latitude]
                                },
                                properties: {
                                    id: centerId,
                                    name: center.name || center.center_name,
                                    radius: center.radius,
                                    checkins: stats.checkins,
                                    checkouts: stats.checkouts
                                }
                            };
                        })
                    };

                    appState.map.addSource('centers', {
                        type: 'geojson',
                        data: geojsonData
                    });

                    appState.map.addLayer({
                        id: 'centers-layer',
                        type: 'circle',
                        source: 'centers',
                        paint: {
                            'circle-radius': 20,
                            'circle-color': appState.currentUser.role === 'admin' ? '#667eea' : '#4facfe',
                            'circle-stroke-width': 4,
                            'circle-stroke-color': '#ffffff',
                            'circle-opacity': 0.8
                        }
                    });

                    appState.map.addLayer({
                        id: 'center-labels',
                        type: 'symbol',
                        source: 'centers',
                        layout: {
                            'text-field': ['get', 'name'],
                            'text-font': ['DIN Pro Bold', 'Arial Unicode MS Bold'],
                            'text-offset': [0, 3],
                            'text-anchor': 'top',
                            'text-size': 14,
                            'text-allow-overlap': true,
                            'text-ignore-placement': false
                        },
                        paint: {
                            'text-color': '#2c3e50',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2
                        }
                    });

                    appState.map.on('click', 'centers-layer', (e) => {
                        const coordinates = e.features[0].geometry.coordinates.slice();
                        const { name, radius, checkins, checkouts } = e.features[0].properties;

                        new mapboxgl.Popup({ 
                            closeOnClick: true,
                            className: 'arabic-popup'
                        })
                            .setLngLat(coordinates)
                            .setHTML(`
                                <div class="marker-popup">
                                    <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">üè¢ ${name}</h3>
                                    <p style="margin: 0 0 10px 0; color: #7f8c8d; font-size: 14px;"><strong>ŸÜÿ∑ÿßŸÇ ÿßŸÑÿπŸÖŸÑ:</strong> ${radius} ŸÖÿ™ÿ±</p>
                                    <div class="center-stats">
                                        <div class="stat-item checkin-stat">
                                            <div style="font-weight: bold; font-size: 18px;">${checkins}</div>
                                            <div style="font-size: 12px;">ÿØÿÆŸàŸÑ ÿßŸÑŸäŸàŸÖ</div>
                                        </div>
                                        <div class="stat-item checkout-stat">
                                            <div style="font-weight: bold; font-size: 18px; color: #3b82f6;">${checkouts}</div>
                                            <div style="font-size: 12px; color: #3b82f6;">ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿßŸÑŸäŸàŸÖ</div>
                                        </div>
                                    </div>
                                </div>
                            `)
                            .addTo(appState.map);
                    });

                    if (centersToShow.length > 1) {
                        const bounds = new mapboxgl.LngLatBounds();
                        centersToShow.forEach(center => {
                            bounds.extend([center.longitude, center.latitude]);
                        });
                        appState.map.fitBounds(bounds, { padding: 50 });
                    }
                }
            } catch (error) {
                console.error('Error updating map markers:', error);
            }
        }

        function updateMapWithEmployees(employeeLocations) {
            if (!appState.map || !appState.map.isStyleLoaded()) return;

            ['employees-layer', 'employee-labels'].forEach(layerId => {
                if (appState.map.getLayer(layerId)) appState.map.removeLayer(layerId);
            });
            if (appState.map.getSource('employees')) appState.map.removeSource('employees');

            if (!employeeLocations || Object.keys(employeeLocations).length === 0) return;

            const employeesGeoJSON = {
                type: 'FeatureCollection',
                features: Object.values(employeeLocations).map(empData => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [empData.location.longitude, empData.location.latitude]
                    },
                    properties: {
                        name: empData.employee.name,
                        phone: empData.employee.phone,
                        status: empData.employee.status,
                        action: empData.location.action,
                        time: empData.location.time,
                        center: empData.center?.name || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
                    }
                }))
            };

            appState.map.addSource('employees', {
                type: 'geojson',
                data: employeesGeoJSON
            });

            appState.map.addLayer({
                id: 'employees-layer',
                type: 'circle',
                source: 'employees',
                paint: {
                    'circle-radius': 12,
                    'circle-color': [
                        'case',
                        ['==', ['get', 'status'], 'active'],
                        '#28a745',
                        '#dc3545'
                    ],
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#ffffff'
                }
            });

            appState.map.addLayer({
                id: 'employee-labels',
                type: 'symbol',
                source: 'employees',
                layout: {
                    'text-field': ['get', 'name'],
                    'text-font': ['DIN Pro Medium', 'Arial Unicode MS Regular'],
                    'text-offset': [0, 2],
                    'text-anchor': 'top',
                    'text-size': 12,
                    'text-allow-overlap': true,
                    'text-ignore-placement': false
                },
                paint: {
                    'text-color': '#2c3e50',
                    'text-halo-color': '#ffffff',
                    'text-halo-width': 1
                }
            });

            appState.map.on('click', 'employees-layer', (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const properties = e.features[0].properties;
                const timeDiff = getTimeDifference(properties.time);
                
                const maskedPhone = maskPhoneNumber(properties.phone);

                new mapboxgl.Popup({ 
                    closeOnClick: true,
                    className: 'arabic-popup'
                })
                    .setLngLat(coordinates)
                    .setHTML(`
                        <div class="marker-popup">
                            <h3 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 16px;">${properties.name}</h3>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>üì± ÿßŸÑŸáÿßÿ™ŸÅ:</strong> <span class="phone-masked" data-phone="${properties.phone}" onclick="togglePhoneVisibility(this)">${maskedPhone}</span></p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>ÿßŸÑÿ≠ÿßŸÑÿ©:</strong> ${properties.status === 'active' ? 'üü¢ ŸÜÿ¥ÿ∑' : 'üî¥ ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑'}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>ÿ¢ÿÆÿ± ŸÜÿ¥ÿßÿ∑:</strong> ${getActionText(properties.action)}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>ÿßŸÑÿ™ŸàŸÇŸäÿ™:</strong> ${timeDiff}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;"><strong>ÿßŸÑŸÖÿ±ŸÉÿ≤:</strong> ${properties.center}</p>
                        </div>
                    `)
                    .addTo(appState.map);
            });

            appState.map.on('mouseenter', 'employees-layer', () => {
                appState.map.getCanvas().style.cursor = 'pointer';
            });

            appState.map.on('mouseleave', 'employees-layer', () => {
                appState.map.getCanvas().style.cursor = '';
            });
        }

        function nextPage(type) {
            const pagination = appState.pagination[type];
            if (pagination.currentPage < pagination.totalPages) {
                pagination.currentPage++;
                
                switch(type) {
                    case 'employees':
                        displayEmployees(appState.currentUser.role === 'admin' ? appState.allEmployees : appState.allowedEmployees);
                        break;
                    case 'locations':
                        refreshEmployeeLocations();
                        break;
                    case 'logs':
                        displayLogs(appState.allLogs);
                        break;
                }
            }
        }

        function previousPage(type) {
            const pagination = appState.pagination[type];
            if (pagination.currentPage > 1) {
                pagination.currentPage--;
                
                switch(type) {
                    case 'employees':
                        displayEmployees(appState.currentUser.role === 'admin' ? appState.allEmployees : appState.allowedEmployees);
                        break;
                    case 'locations':
                        refreshEmployeeLocations();
                        break;
                    case 'logs':
                        displayLogs(appState.allLogs);
                        break;
                }
            }
        }

        function filterEmployees() {
            const searchTerm = document.getElementById('searchEmployees').value.toLowerCase();
            const employees = appState.currentUser.role === 'admin' ? appState.allEmployees : appState.allowedEmployees;
            
            let filteredEmployees = employees.filter(emp => 
                (emp.name || emp.employee_name).toLowerCase().includes(searchTerm) ||
                emp.phone.includes(searchTerm) ||
                (emp.position || emp.job_position || '').toLowerCase().includes(searchTerm)
            );
            
            if (appState.searchFilters.center) {
                filteredEmployees = filteredEmployees.filter(emp => 
                    (emp.center_id || emp.centers?.id) == appState.searchFilters.center
                );
            }
            
            if (appState.searchFilters.status) {
                filteredEmployees = filteredEmployees.filter(emp => 
                    emp.status === appState.searchFilters.status
                );
            }
            
            appState.pagination.employees.currentPage = 1;
            displayEmployees(filteredEmployees);
        }

        function filterCenters() {
            const searchTerm = document.getElementById('searchCenters').value.toLowerCase();
            const centerCards = document.querySelectorAll('#centersList .item-card');
            
            centerCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function filterMovements() {
            appState.pagination.locations.currentPage = 1;
            refreshEmployeeLocations();
        }

        function clearMovementSearch() {
            document.getElementById('searchMovements').value = '';
            appState.pagination.locations.currentPage = 1;
            refreshEmployeeLocations();
        }

        function clearLogSearch() {
            document.getElementById('searchLogs').value = '';
            document.getElementById('logFilter').value = 'all';
            appState.pagination.logs.currentPage = 1;
            displayLogs(appState.allLogs);
            showInfo('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™', 2000);
        }

        function filterLogs(type = 'all') {
            let filteredLogs = appState.allLogs;
            
            const searchTerm = document.getElementById('searchLogs')?.value.toLowerCase() || '';
            
            if (type !== 'all') {
                if (type === 'checkin') {
                    filteredLogs = appState.allLogs.filter(log => 
                        log.action.includes('checkin') || log.action === 'in' || log.action === 'center_entry'
                    );
                } else if (type === 'checkout') {
                    filteredLogs = appState.allLogs.filter(log => 
                        log.action.includes('checkout') || log.action === 'out'
                    );
                } else if (type === 'movement') {
                    filteredLogs = appState.allLogs.filter(log => 
                        log.action.includes('movement') || log.action.includes('nearby')
                    );
                } else if (type === 'center_entry') {
                    filteredLogs = appState.allLogs.filter(log => log.action === 'center_entry');
                } else {
                    filteredLogs = appState.allLogs.filter(log => log.action === type);
                }
            }
            
            if (searchTerm) {
                filteredLogs = filteredLogs.filter(log => {
                    const employeeName = (log.employees?.name || '').toLowerCase();
                    const employeePhone = (log.employees?.phone || '').toLowerCase();
                    
                    return employeeName.includes(searchTerm) || employeePhone.includes(searchTerm);
                });
            }
            
            if (appState.searchFilters.fromDate) {
                filteredLogs = filteredLogs.filter(log => {
                    const logDate = new Date(log.occurred_at || log.created_at);
                    const fromDate = new Date(appState.searchFilters.fromDate);
                    return logDate >= fromDate;
                });
            }
            
            if (appState.searchFilters.toDate) {
                filteredLogs = filteredLogs.filter(log => {
                    const logDate = new Date(log.occurred_at || log.created_at);
                    const toDate = new Date(appState.searchFilters.toDate);
                    toDate.setHours(23, 59, 59); 
                    return logDate <= toDate;
                });
            }
            
            appState.pagination.logs.currentPage = 1;
            displayLogs(filteredLogs);
            
            const searchMessage = searchTerm ? 
                `ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${filteredLogs.length} ÿ≥ÿ¨ŸÑ ŸÑŸÄ "${searchTerm}"` : 
                `ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ© ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™: ${filteredLogs.length} ÿ≥ÿ¨ŸÑ`;
            showInfo(searchMessage, 3000);
        }
        function calculateEffectiveDistance(employeeLat, employeeLng, centerLat, centerLng, accuracy) {
            const baseDistance = calculateDistance(employeeLat, employeeLng, centerLat, centerLng);
            

            const accuracyBuffer = Math.max(accuracy * 0.5, appState.locationSettings.accuracyBuffer);
            
            return {
                baseDistance,
                effectiveDistance: baseDistance + accuracyBuffer,
                accuracyBuffer,
                accuracy: accuracy
            };
        }
        function isEmployeeInCenterRange(employeeLat, employeeLng, centerLat, centerLng, centerRadius, accuracy) {
            const distanceInfo = calculateEffectiveDistance(employeeLat, employeeLng, centerLat, centerLng, accuracy);
            
            const isInRange = distanceInfo.effectiveDistance <= centerRadius;
            
            return {
                isInRange,
                baseDistance: distanceInfo.baseDistance,
                effectiveDistance: distanceInfo.effectiveDistance,
                accuracyBuffer: distanceInfo.accuracyBuffer,
                accuracy: accuracy,
                centerRadius: centerRadius,
                margin: centerRadius - distanceInfo.effectiveDistance
            };
        }
        
        function displayDistanceInfo(distanceInfo, employeeName, centerName) {
            const qualityTexts = {
                'excellent': 'ŸÖŸÖÿ™ÿßÿ≤ÿ©',
                'good': 'ÿ¨ŸäÿØÿ©',
                'fair': 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©',
                'poor': 'ÿ∂ÿπŸäŸÅÿ©',
                'unreliable': 'ÿ∫Ÿäÿ± ŸÖŸàÿ´ŸàŸÇÿ©'
            };
            
            const quality = getLocationQuality(distanceInfo.accuracy);
            let message = `ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑŸÅÿπŸÑŸäÿ©: ${Math.round(distanceInfo.baseDistance)}ŸÖ\n`;
            message += `ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ÿßŸÑŸÅÿπÿßŸÑÿ©: ${Math.round(distanceInfo.effectiveDistance)}ŸÖ\n`;
            message += `ŸÜÿ∑ÿßŸÇ ÿßŸÑŸÖÿ±ŸÉÿ≤: ${distanceInfo.centerRadius}ŸÖ\n`;
            message += `ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ: ${qualityTexts[quality]} (${Math.round(distanceInfo.accuracy)}ŸÖ)\n`;
            message += `ŸáÿßŸÖÿ¥ ÿßŸÑÿ£ŸÖÿßŸÜ: ${Math.round(distanceInfo.accuracyBuffer)}ŸÖ\n`;
            
            if (distanceInfo.isInRange) {
                message += `‚úÖ ${employeeName} ŸÅŸä ŸÜÿ∑ÿßŸÇ ${centerName}`;
            } else {
                message += `‚ùå ${employeeName} ÿÆÿßÿ±ÿ¨ ŸÜÿ∑ÿßŸÇ ${centerName}`;
            }
            return message;
        }

        function focusOnEmployees() {
            document.querySelector('#employeesList')?.scrollIntoView({ behavior: 'smooth' });
            showInfo('ÿπÿ±ÿ∂ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÅÿ±ÿßÿØ', 2000);
        }

        function focusOnActiveEmployees() {
            document.querySelector('#employeeLocations')?.scrollIntoView({ behavior: 'smooth' });
            showInfo('ÿπÿ±ÿ∂ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ', 2000);
        }

        function focusOnCheckedIn() {
            document.querySelector('#activityLogs')?.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('logFilter').value = 'checkin';
            filterLogs('checkin');
            showSuccess('ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤', 2000);
        }

        function focusOnCheckedOut() {
            document.querySelector('#activityLogs')?.scrollIntoView({ behavior: 'smooth' });
            document.getElementById('logFilter').value = 'checkout';
            filterLogs('checkout');
            showInfo('ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤', 2000);
        }

        function focusOnCenters() {
            document.querySelector('#centersList')?.scrollIntoView({ behavior: 'smooth' });
            showInfo('ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤', 2000);
        }

        function focusOnLogs() {
            document.querySelector('#activityLogs')?.scrollIntoView({ behavior: 'smooth' });
            showInfo('ÿπÿ±ÿ∂ ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©', 2000);
        }
        async function addCenter() {
            if (!appState.userPermissions || !appState.userPermissions.can_add_centers) {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ±ÿßŸÉÿ≤');
                return;
            }
            const name = document.getElementById('centerName').value.trim();
            const coords = document.getElementById('centerCoordinates').value.trim();
            const radius = parseInt(document.getElementById('centerRadius').value);
            let lat = '', lng = '';
            if (coords) {
                [lat, lng] = coords.split(',').map(x => parseFloat(x.trim()));
            }
            if (!name || !lng || !lat || !radius) {
                showError('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ŸàÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸàŸÇÿπ ÿπŸÑŸâ ÿßŸÑÿÆÿ±Ÿäÿ∑ÿ©');
                return;
            }
            try {
                const { data, error } = await appState.supabase
                    .from('centers')
                    .insert([{ name, longitude: lng, latitude: lat, radius }])
                    .select();
                if (error) throw error;
                if (appState.currentUser.role !== 'admin' && data[0]) {
                    await appState.supabase
                        .from('user_center_permissions')
                        .insert([{ user_id: appState.currentUser.id, center_id: data[0].id, can_view: true, can_manage: true }]);
                }
                document.getElementById('centerName').value = '';
                document.getElementById('centerCoordinates').value = '';
                document.getElementById('centerRadius').value = '100';
                await loadAllData();
                showSuccess('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ');
                await logMainAction('add', 'center', name);
                if (appState.currentUser.role === 'admin' && data && data[0]) {
                    const { data: users } = await appState.supabase
                        .from('users')
                        .select('id')
                        .eq('role', 'user')
                        .eq('is_active', true);
                    if (users && users.length) {
                        const centerId = data[0].id;
                        const permissions = users.map(u => ({
                            user_id: u.id,
                            center_id: centerId,
                            can_view: true,
                            can_manage: false
                        }));
                        await appState.supabase.from('user_center_permissions').insert(permissions);
                    }
                }
            } catch (error) {
                console.error('Error adding center:', error);
                showError('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ±ŸÉÿ≤');
            }
        }

        async function addEmployee() {
            if (!appState.userPermissions || !appState.userPermissions.can_add_employees) {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ£ŸÅÿ±ÿßÿØ');
                return;
            }

            const name = document.getElementById('employeeName').value.trim();
            const phone = document.getElementById('employeePhone').value.trim();
            const password = document.getElementById('employeePassword').value.trim();
            const position = document.getElementById('employeePosition').value.trim();
            const centerId = document.getElementById('employeeCenter').value;

            if (!name || !phone || !password || !centerId) {
                showError('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                return;
            }

            if (password.length < 6) {
                showError('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ');
                return;
            }
            if (appState.currentUser.role !== 'admin') {
                const hasPermission = appState.allowedCenters.some(center => 
                    (center.center_id || center.id) == centerId && center.can_manage !== false
                );

                if (!hasPermission) {
                    showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÅÿ±ÿßÿØ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ±ŸÉÿ≤');
                    return;
                }
            }

            try {
                const params = {
                    employee_name: name,
                    employee_phone: phone,
                    employee_password: password,
                    employee_position: position || 'ŸÅÿ±ÿØ',
                    employee_center_id: parseInt(centerId)
                };
                const { data, error } = await appState.supabase.rpc('add_employee_simple', params);

                if (error) throw error;

                const result = data;
                if (result.success) {
                    document.getElementById('employeeName').value = '';
                    document.getElementById('employeePhone').value = '';
                    document.getElementById('employeePassword').value = '';
                    document.getElementById('employeePosition').value = '';
                    document.getElementById('employeeCenter').value = '';

                    await loadAllData();
                    showSuccess(`‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠!`);
                    await logMainAction('add', 'employee', name);
                } else {
                    showError('‚ùå ' + result.error);
                }
            } catch (error) {
                console.error('Error adding employee:', error);
                showError('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÅÿ±ÿØ: ' + error.message);
            }
        }

        async function addUser() {
            if (!appState.currentUser || appState.currentUser.role !== 'admin') {
                showNotification('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ', 'warning');
                return;
            }
            const username = document.getElementById('newUsername').value.trim();
            const fullName = document.getElementById('newUserFullName').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const phone = document.getElementById('newUserPhone').value.trim();
            const role = document.getElementById('newUserRole').value;
            const selectedCenters = window.$ && $('#newUserCenters').select2 ? $('#newUserCenters').val().map(Number) :
                Array.from(document.getElementById('newUserCenters').selectedOptions).map(opt => parseInt(opt.value));

            if (!username || !fullName || !password) {
                showNotification('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ© (ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿå ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÉÿßŸÖŸÑÿå ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±)', 'warning');
                return;
            }
            if (password.length < 6) {
                showNotification('ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ', 'warning');
                return;
            }
            if ((appState.allUsers || []).some(u => u.username === username)) {
                showNotification('ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ®ŸÇÿßŸã', 'error');
                return;
            }
            showLoading();
            try {
                const { data, error } = await appState.supabase.rpc('add_user', {
                    user_username: username,
                    user_password: password,
                    user_full_name: fullName,
                    user_email: email || null,
                    user_phone: phone || null,
                    user_role: role,
                    center_ids: selectedCenters.length ? selectedCenters : null
                });
                if (error) throw error;
                const result = data;
                if (result.success) {
                    document.getElementById('newUsername').value = '';
                    document.getElementById('newUserFullName').value = '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserPhone').value = '';
                    document.getElementById('newUserRole').value = 'user';
                    if (window.$ && $('#newUserCenters').select2) {
                        $('#newUserCenters').val(null).trigger('change');
                    }
                    showNotification(`‚úÖ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ "${fullName}" ÿ®ŸÜÿ¨ÿßÿ≠!`, 'success');
                    await loadUsersList();
                    setTimeout(() => {
                        const container = document.getElementById('usersListContainer');
                        if (container) {
                            const cards = Array.from(container.getElementsByClassName('item-card'));
                            const newCard = cards.find(card => card.innerHTML.includes(username));
                            if (newCard) {
                                newCard.style.background = '#d1ffd6';
                                setTimeout(() => { newCard.style.background = ''; }, 2000);
                            }
                        }
                    }, 500);
                } else {
                    showNotification('‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + (error.message || error), 'error');
            } finally {
                hideLoading();
            }
        }
        function editEmployee(employeeId) {
            if (!appState.userPermissions || !appState.userPermissions.can_edit_employees) {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ');
                return;
            }

            const employee = (appState.currentUser.role === 'admin' ? appState.allEmployees : appState.allowedEmployees)
                .find(emp => (emp.id || emp.employee_id) === employeeId);
            
            if (!employee) {
                showError('ÿßŸÑŸÖŸàÿ∏ŸÅ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ÿ£Ÿà ÿ™ŸÖ ÿ≠ÿ∞ŸÅŸá!');
                return;
            }

            appState.currentEditingEmployee = employee;

            const nameInput = document.getElementById('editEmployeeName');
            const phoneInput = document.getElementById('editEmployeePhone');
            const positionInput = document.getElementById('editEmployeePosition');
            const statusInput = document.getElementById('editEmployeeStatus');
            const centerSelect = document.getElementById('editEmployeeCenter');

            if (nameInput) nameInput.value = employee.name || employee.employee_name;
            if (phoneInput) phoneInput.value = employee.phone;
            if (positionInput) positionInput.value = employee.position || '';
            if (statusInput) statusInput.value = employee.status;
            if (centerSelect) {
                centerSelect.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ÿßŸÑŸÖÿ±ŸÉÿ≤</option>';
                const centersToShow = appState.currentUser.role === 'admin' ? appState.allCenters : appState.allowedCenters;
                centersToShow.forEach(center => {
                    const option = document.createElement('option');
                    option.value = center.id || center.center_id;
                    option.textContent = center.name || center.center_name;
                    if ((center.id || center.center_id) === employee.center_id) {
                        option.selected = true;
                    }
                    centerSelect.appendChild(option);
                });
            }

            showModal('editEmployeeModal');
        }

        function editCenter(centerId) {
            if (!appState.userPermissions || !appState.userPermissions.can_edit_centers) {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤');
                return;
            }

            const center = (appState.currentUser.role === 'admin' ? appState.allCenters : appState.allowedCenters)
                .find(c => (c.id || c.center_id) === centerId);
            
            if (!center) return;

            appState.currentEditingCenter = center;
            appState.editingOldCenterName = center.name || center.center_name || '';
            document.getElementById('editCenterName').value = center.name || center.center_name;
            document.getElementById('editCenterCoordinates').value = `${center.latitude}, ${center.longitude}`;
            document.getElementById('editCenterRadius').value = center.radius;

            showModal('editCenterModal');
        }

        async function updateEmployee() {
            if (!appState.currentEditingEmployee) return;
            const name = document.getElementById('editEmployeeName').value.trim();
            const phone = document.getElementById('editEmployeePhone').value.trim();
            const position = document.getElementById('editEmployeePosition').value.trim();
            const status = document.getElementById('editEmployeeStatus').value;
            const centerId = document.getElementById('editEmployeeCenter').value;
            try {
                const oldName = appState.currentEditingEmployee.name || appState.currentEditingEmployee.employee_name;
                const { error } = await appState.supabase
                    .from('employees')
                    .update({
                        name: name,
                        phone: phone,
                        position: position,
                        status: status,
                        center_id: centerId || null
                    })
                    .eq('id', appState.currentEditingEmployee.id || appState.currentEditingEmployee.employee_id);

                if (error) throw error;

                await logMainAction('update', 'employee', name, { old_name: oldName, new_name: name });

                closeModal('editEmployeeModal');
                await loadAllData();
                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ±ÿØ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ');
                appState.editingOldName = null;
            } catch (error) {
                console.error('Error updating employee:', error);
                showError('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        }

        async function updateCenter() {
            if (!appState.currentEditingCenter || !appState.userPermissions || !appState.userPermissions.can_edit_centers) return;
            const name = document.getElementById('editCenterName').value.trim();
            const coords = document.getElementById('editCenterCoordinates').value.trim();
            const radius = parseInt(document.getElementById('editCenterRadius').value);
            let lat = '', lng = '';
            if (coords) {
                [lat, lng] = coords.split(',').map(x => parseFloat(x.trim()));
            }
            if (!name || !lng || !lat || !radius) {
                showError('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ');
                return;
            }
            try {
                const oldName = appState.currentEditingCenter.name || appState.currentEditingCenter.center_name;
                const { error } = await appState.supabase
                    .from('centers')
                    .update({
                        name: name,
                        longitude: lng,
                        latitude: lat,
                        radius: radius
                    })
                    .eq('id', appState.currentEditingCenter.id || appState.currentEditingCenter.center_id);

                if (error) throw error;

                await logMainAction('update', 'center', name, { old_name: oldName, new_name: name });

                closeModal('editCenterModal');
                await loadAllData();
                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ');
                appState.editingOldCenterName = null;
            } catch (error) {
                console.error('Error updating center:', error);
                showError('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        }
        async function deleteCenter(centerId) {
            if (!appState.userPermissions || !appState.userPermissions.can_delete_centers) {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ±ÿßŸÉÿ≤');
                return;
            }

            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ±ŸÉÿ≤ÿü ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ŸäŸÜ ÿ®Ÿá.')) {
                try {
                    let centerName = '';
                    const { data: centerData, error: centerError } = await appState.supabase
                        .from('centers')
                        .select('name')
                        .eq('id', centerId)
                        .single();
                    if (!centerError && centerData && centerData.name) {
                        centerName = centerData.name;
                    } else {
                        centerName = centerId;
                    }

                    const { error } = await appState.supabase
                        .from('centers')
                        .delete()
                        .eq('id', centerId);

                    if (error) throw error;
                    await loadAllData();
                    showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ');
                    await logMainAction('delete', 'center', centerName);
                } catch (error) {
                    console.error('Error deleting center:', error);
                    showError('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ±ŸÉÿ≤');
                }
            }
        }

        async function deleteEmployee(employeeId) {
            if (!appState.userPermissions || !appState.userPermissions.can_delete_employees) {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑÿ£ŸÅÿ±ÿßÿØ');
                return;
            }

            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≠ÿ∞ŸÅÿü')) {
                try {
                    let employeeName = '';
                    const { data: empData, error: empError } = await appState.supabase
                        .from('employees')
                        .select('name')
                        .eq('id', employeeId)
                        .single();
                    if (!empError && empData && empData.name) {
                        employeeName = empData.name;
                    } else {
                        employeeName = employeeId;
                    }

                    const { error } = await appState.supabase
                        .from('employees')
                        .delete()
                        .eq('id', employeeId);

                    if (error) throw error;
                    await loadAllData();
                    showSuccess('ÿ™ŸÖ ÿßŸÑÿ≠ÿ∞ŸÅ ÿ®ŸÜÿ¨ÿßÿ≠ ‚úÖ');
                    await logMainAction('delete', 'employee', employeeName);
                } catch (error) {
                    console.error('Error deleting employee:', error);
                    showError('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿ∞ŸÅ');
                }
            }
        }

        async function refreshAll() {
            try {
                updateConnectionStatus('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´...', 'syncing');
                showRefreshIndicator();
                await loadAllData();
                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠ üîÑ');
            } catch (error) {
                console.error('Error refreshing data:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        }

        function refreshLogs() {
            loadLogs();
            showInfo('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™', 2000);
        }

        function getActionText(action) {
            const actions = {
                'auto_checkin': 'ÿØÿÆŸàŸÑ ÿ™ŸÑŸÇÿßÿ¶Ÿä',
                'auto_checkout': 'ÿÆÿ±Ÿàÿ¨ ÿ™ŸÑŸÇÿßÿ¶Ÿä',
                'center_entry': 'ÿØÿÆŸÑ ŸÖÿ±ŸÉÿ≤',
                'center_nearby': 'ÿßŸÇÿ™ÿ±ÿ® ŸÖŸÜ ŸÖÿ±ŸÉÿ≤',
                'movement': 'ÿ≠ÿ±ŸÉÿ©',
                'location_update': 'ÿ™ÿ≠ÿØŸäÿ´ ŸÖŸàŸÇÿπ',
                'checkin': 'ÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ŸÖÿ±ŸÉÿ≤',
                'checkout': 'ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤',
                'in': 'ÿØÿÆŸàŸÑ ÿ•ŸÑŸâ ŸÖÿ±ŸÉÿ≤',
                'out': 'ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤',
                'user_login': 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®',
                'account_login': 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑÿ≠ÿ≥ÿßÿ®'
            };
            return actions[action] || action;
        }

        function getActionIcon(action) {
            const icons = {
                'auto_checkin': 'üü¢',
                'auto_checkout': 'üîê',
                'center_entry': 'üè¢',
                'center_nearby': 'üìç',
                'movement': 'üö∂',
                'location_update': 'üìç',
                'checkin': '‚úÖ',
                'checkout': 'üö™',
                'in': '‚úÖ',
                'out': 'üö™',
                'user_login': 'üîê',
                'account_login': 'üîê'
            };
            return icons[action] || 'üìã';
        }
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            if (body.getAttribute('data-theme') === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeToggle.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            if (savedTheme === 'dark') {
                body.setAttribute('data-theme', 'dark');
                if (themeToggle) themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                body.setAttribute('data-theme', 'light');
                if (themeToggle) themeToggle.textContent = 'üåô';
            }
        });
        function setupRealTimeUpdates() {
            appState.supabase
                .channel('enhanced_logs_channel_v2')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'logs' }, (payload) => {
                    console.log('New log activity detected:', payload);
                    loadLogs();
                    updateStats();
                    loadCenterStats();
                    refreshEmployeeLocations();
                    if (payload.eventType === 'INSERT' && payload.new) {
                        const actionText = getActionText(payload.new.action);
                        if (payload.new.action === 'auto_checkin' && payload.new.employee_id) {
                            let empName = '';
                            let centerName = '';
                            if (appState.allEmployees) {
                                const emp = appState.allEmployees.find(e => e.id === payload.new.employee_id);
                                if (emp) empName = emp.name || emp.employee_name;
                            }
                            if (appState.allCenters) {
                                const center = appState.allCenters.find(c => c.id === payload.new.center_id);
                                if (center) centerName = center.name || center.center_name;
                            }
                            showSuccess(`‚úÖ ÿØÿÆŸàŸÑ ÿ¨ÿØŸäÿØ: ${empName ? empName : 'ŸÅÿ±ÿØ'} ÿØÿÆŸÑ ${centerName ? centerName : 'ŸÖÿ±ŸÉÿ≤'}`);
                        } else if (payload.new.action === 'auto_checkout' && payload.new.employee_id) {
                            let empName = '';
                            let centerName = '';
                            if (appState.allEmployees) {
                                const emp = appState.allEmployees.find(e => e.id === payload.new.employee_id);
                                if (emp) empName = emp.name || emp.employee_name;
                            }
                            if (appState.allCenters) {
                                const center = appState.allCenters.find(c => c.id === payload.new.center_id);
                                if (center) centerName = center.name || center.center_name;
                            }
                            showSuccess(`üîê ÿÆÿ±Ÿàÿ¨ ÿ™ŸÑŸÇÿßÿ¶Ÿä: ${empName ? empName : 'ŸÅÿ±ÿØ'}${centerName ? ' ŸÖŸÜ ' + centerName : ''}`, 5000);
                        } else {
                            showInfo(`ŸÜÿ¥ÿßÿ∑ ÿ¨ÿØŸäÿØ: ${actionText}`, 5000);
                        }
                    }
                })
                .subscribe();
            appState.supabase
                .channel('enhanced_employees_channel_v2')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'employees' }, () => {
                    loadAllData();
                })
                .subscribe();
            appState.supabase
                .channel('enhanced_centers_channel_v2')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'centers' }, () => {
                    loadAllData();
                })
                .subscribe();
        }
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshAll();
                        break;
                }
            }
        });
        document.addEventListener('DOMContentLoaded', function() {
            const usernameInput = document.getElementById('loginUsername');
            const passwordInput = document.getElementById('loginPassword');
            
            usernameInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') passwordInput?.focus();
            });
            
            passwordInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                document.addEventListener(event, updateLastActivity, true);
            });
        });
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };
        function updateLocationSettings() {
            const minAccuracy = parseInt(document.getElementById('minAccuracy').value);
            const maxAccuracy = parseInt(document.getElementById('maxAccuracy').value);
            const locationTimeout = parseInt(document.getElementById('locationTimeout').value);
            const retryAttempts = parseInt(document.getElementById('retryAttempts').value);
            const accuracyBuffer = parseInt(document.getElementById('accuracyBuffer').value);
            if (minAccuracy >= maxAccuracy) {
                showError('ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ÿØŸÜŸâ ŸÑŸÑÿØŸÇÿ© Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÇŸÑ ŸÖŸÜ ÿßŸÑÿ≠ÿØ ÿßŸÑÿ£ŸÇÿµŸâ');
                return;
            }
            
            appState.locationSettings.minAccuracy = minAccuracy;
            appState.locationSettings.maxAccuracy = maxAccuracy;
            appState.locationSettings.locationTimeout = locationTimeout * 1000;
            appState.locationSettings.retryAttempts = retryAttempts;
            appState.locationSettings.accuracyBuffer = accuracyBuffer;
            localStorage.setItem('locationSettings', JSON.stringify(appState.locationSettings));
            
            showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ ÿ®ŸÜÿ¨ÿßÿ≠');
        }
        
        function loadLocationSettings() {
            const savedSettings = localStorage.getItem('locationSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    appState.locationSettings = { ...appState.locationSettings, ...settings };
                    document.getElementById('minAccuracy').value = appState.locationSettings.minAccuracy;
                    document.getElementById('maxAccuracy').value = appState.locationSettings.maxAccuracy;
                    document.getElementById('locationTimeout').value = appState.locationSettings.locationTimeout / 1000;
                    document.getElementById('retryAttempts').value = appState.locationSettings.retryAttempts;
                    document.getElementById('accuracyBuffer').value = appState.locationSettings.accuracyBuffer;
                } catch (error) {
                    console.error('Error loading location settings:', error);
                }
            }
        }
        
        async function testLocationAccuracy() {
            try {
                showInfo('ÿ¨ÿßÿ±Ÿä ÿßÿÆÿ™ÿ®ÿßÿ± ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ...');
                
                const enhancedLocation = await getEnhancedLocation();
                
                const qualityTexts = {
                    'excellent': 'ŸÖŸÖÿ™ÿßÿ≤ÿ©',
                    'good': 'ÿ¨ŸäÿØÿ©',
                    'fair': 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©',
                    'poor': 'ÿ∂ÿπŸäŸÅÿ©',
                    'unreliable': 'ÿ∫Ÿäÿ± ŸÖŸàÿ´ŸàŸÇÿ©'
                };
                
                const quality = qualityTexts[enhancedLocation.quality];
                
                let message = `üß™ ŸÜÿ™ÿßÿ¶ÿ¨ ÿßÿÆÿ™ÿ®ÿßÿ± ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ:\n\n`;
                message += `üìç ÿßŸÑÿØŸÇÿ©: ${Math.round(enhancedLocation.accuracy)} ŸÖÿ™ÿ±\n`;
                message += `‚≠ê ÿßŸÑÿ¨ŸàÿØÿ©: ${quality}\n`;
                message += `üîÑ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™: ${enhancedLocation.attempts}\n`;
                message += `üìä ŸÖÿ≥ÿ™ŸÇÿ±: ${enhancedLocation.stable ? 'ŸÜÿπŸÖ' : 'ŸÑÿß'}\n`;
                message += `‚ú® ŸÖÿ≠ÿ≥ŸÜ: ${enhancedLocation.enhanced ? 'ŸÜÿπŸÖ' : 'ŸÑÿß'}\n`;
                
                if (enhancedLocation.sampleCount) {
                    message += `üìà ÿπÿØÿØ ÿßŸÑÿπŸäŸÜÿßÿ™: ${enhancedLocation.sampleCount}\n`;
                }
                
                if (enhancedLocation.quality === 'excellent' || enhancedLocation.quality === 'good') {
                    message += `\n‚úÖ ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ ŸÖŸÖÿ™ÿßÿ≤ÿ©! ŸäŸÖŸÉŸÜ ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ ÿπŸÑŸäŸáÿß ŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä.`;
                    showSuccess(message, 10000);
                } else if (enhancedLocation.quality === 'fair') {
                    message += `\n‚ö†Ô∏è ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©. ŸÇÿØ ÿ™ÿ≠ÿØÿ´ ÿ®ÿπÿ∂ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ° ŸÅŸä ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä.`;
                    showInfo(message, 10000);
                } else {
                    message += `\n‚ùå ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ ÿ∂ÿπŸäŸÅÿ©. ŸäŸàÿµŸâ ÿ®ÿ™ÿ≠ÿ≥ŸäŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ GPS ÿ£Ÿà ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿ•ŸÑŸâ ŸÖŸÉÿßŸÜ ŸÖŸÅÿ™Ÿàÿ≠.`;
                    showError(message, 10000);
                }
                
            } catch (error) {
                console.error('Location accuracy test error:', error);
                showError('ŸÅÿ¥ŸÑ ŸÅŸä ÿßÿÆÿ™ÿ®ÿßÿ± ÿØŸÇÿ© ÿßŸÑŸÖŸàŸÇÿπ: ' + error.message);
            }
        }
        async function checkEmployeeLocationWithAccuracy(employeeId, centerId) {
            try {
                const { data: employee } = await appState.supabase
                    .from('employees')
                    .select('*')
                    .eq('id', employeeId)
                    .single();
                
                const { data: center } = await appState.supabase
                    .from('centers')
                    .select('*')
                    .eq('id', centerId)
                    .single();
                
                if (!employee || !center) {
                    throw new Error('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÅÿ±ÿØ ÿ£Ÿà ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©');
                }
                const enhancedLocation = await getEnhancedLocation();
                const distanceInfo = isEmployeeInCenterRange(
                    enhancedLocation.latitude,
                    enhancedLocation.longitude,
                    center.latitude,
                    center.longitude,
                    center.radius,
                    enhancedLocation.accuracy
                );
                const detailedInfo = displayDistanceInfo(distanceInfo, employee.name, center.name);
                const logData = {
                    employee_id: employeeId,
                    center_id: centerId,
                    action: distanceInfo.isInRange ? 'location_check_in_range' : 'location_check_out_of_range',
                    latitude: enhancedLocation.latitude,
                    longitude: enhancedLocation.longitude,
                    accuracy: enhancedLocation.accuracy,
                    occurred_at: new Date().toISOString(),
                    notes: `ŸÅÿ≠ÿµ ŸÖŸàŸÇÿπ ŸÖÿ≠ÿ≥ŸÜ - ÿØŸÇÿ©: ${Math.round(enhancedLocation.accuracy)}ŸÖÿå ÿ¨ŸàÿØÿ©: ${enhancedLocation.quality}`
                };
                
                await appState.supabase.from('logs').insert([logData]);
                if (distanceInfo.isInRange) {
                    showSuccess(detailedInfo, 8000);
                } else {
                    showError(detailedInfo, 8000);
                }
                
                return distanceInfo;
                
            } catch (error) {
                console.error('Error checking employee location:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ŸÅÿ≠ÿµ ŸÖŸàŸÇÿπ ÿßŸÑŸÅÿ±ÿØ: ' + error.message);
                return null;
            }
        }
        function initializeOfflineSupport() {
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            updateConnectionStatus();
            startOfflineSync();
        }
        function handleOnline() {
            appState.offlineMode.isOnline = true;
            updateConnectionStatus('ŸÖÿ™ÿµŸÑ', 'normal');
            showSuccess('ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™! üîó');
            syncPendingActions();
        }
        function handleOffline() {
            appState.offlineMode.isOnline = false;
            updateConnectionStatus('ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ', 'offline');
            showInfo('ÿ£ŸÜÿ™ ŸÅŸä Ÿàÿ∂ÿπ ÿπÿØŸÖ ÿßŸÑÿßÿ™ÿµÿßŸÑ. ÿ≥Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ≠ŸÑŸäÿßŸã. üì±');
        }
        function updateConnectionStatus(message = null, type = null) {
            const indicator = document.getElementById('connectionIndicator');
            if (indicator) {
                if (message && type) {
                    const icons = {
                        normal: 'üü¢',
                        offline: 'üü°',
                        error: 'üî¥',
                        syncing: 'üîÑ'
                    };
                    
                    indicator.textContent = `${icons[type]} ${message}`;
                    indicator.className = `connection-indicator ${type}`;
                } else {
                    if (navigator.onLine) {
                        indicator.textContent = 'üü¢ ŸÖÿ™ÿµŸÑ';
                        indicator.className = 'connection-indicator normal';
                    } else {
                        indicator.textContent = 'üü° ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
                        indicator.className = 'connection-indicator offline';
                    }
                }
            }
        }
        function addPendingAction(action) {
            const pendingAction = {
                ...action,
                id: Date.now() + Math.random(),
                timestamp: new Date().toISOString(),
                retryCount: 0
            };
            
            appState.offlineMode.pendingActions.push(pendingAction);
            localStorage.setItem('pendingActions', JSON.stringify(appState.offlineMode.pendingActions));
            
            console.log('Added pending action:', pendingAction);
        }
        async function syncPendingActions() {
            if (!appState.offlineMode.isOnline || appState.offlineMode.pendingActions.length === 0) {
                return;
            }
            
            showInfo('ÿ¨ÿßÿ±Ÿä ŸÖÿ≤ÿßŸÖŸÜÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©... üîÑ');
            
            const actionsToSync = [...appState.offlineMode.pendingActions];
            let successCount = 0;
            let errorCount = 0;
            
            for (const action of actionsToSync) {
                try {
                    switch (action.type) {
                        case 'log_insert':
                            await appState.supabase.from('logs').insert([action.data]);
                            break;
                        case 'employee_update':
                            await appState.supabase.from('employees').update(action.data).eq('id', action.employeeId);
                            break;
                        case 'center_update':
                            await appState.supabase.from('centers').update(action.data).eq('id', action.centerId);
                            break;
                        default:
                            console.warn('Unknown action type:', action.type);
                    }
                    appState.offlineMode.pendingActions = appState.offlineMode.pendingActions.filter(a => a.id !== action.id);
                    successCount++;
                    
                } catch (error) {
                    console.error('Error syncing action:', error);
                    action.retryCount++;
                    if (action.retryCount >= 3) {
                        appState.offlineMode.pendingActions = appState.offlineMode.pendingActions.filter(a => a.id !== action.id);
                        errorCount++;
                    }
                }
            }
            localStorage.setItem('pendingActions', JSON.stringify(appState.offlineMode.pendingActions));
            if (successCount > 0) {
                showSuccess(`ÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ© ${successCount} ÿ•ÿ¨ÿ±ÿßÿ° ÿ®ŸÜÿ¨ÿßÿ≠! ‚úÖ`);
            }
            if (errorCount > 0) {
                showError(`ŸÅÿ¥ŸÑ ŸÅŸä ŸÖÿ≤ÿßŸÖŸÜÿ© ${errorCount} ÿ•ÿ¨ÿ±ÿßÿ° ‚ùå`);
            }
            
            appState.offlineMode.lastSync = new Date().toISOString();
        }
        function startOfflineSync() {
            if (appState.offlineMode.syncInterval) {
                clearInterval(appState.offlineMode.syncInterval);
            }
            
            appState.offlineMode.syncInterval = setInterval(() => {
                if (appState.offlineMode.isOnline && appState.offlineMode.pendingActions.length > 0) {
                    syncPendingActions();
                }
            }, 30000); 
        }
        function loadPendingActions() {
            try {
                const saved = localStorage.getItem('pendingActions');
                if (saved) {
                    appState.offlineMode.pendingActions = JSON.parse(saved);
                    console.log('Loaded pending actions:', appState.offlineMode.pendingActions.length);
                }
            } catch (error) {
                console.error('Error loading pending actions:', error);
            }
        }
        async function insertLogWithOfflineSupport(logData) {
            try {
                if (appState.offlineMode.isOnline) {
                    await appState.supabase.from('logs').insert([logData]);
                } else {
                    addPendingAction({
                        type: 'log_insert',
                        data: logData
                    });
                    showInfo('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ¨ŸÑ ŸÖÿ≠ŸÑŸäÿßŸã. ÿ≥Ÿäÿ™ŸÖ ÿ±ŸÅÿπŸá ÿπŸÜÿØ ÿπŸàÿØÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ. üì±');
                }
            } catch (error) {
                console.error('Error inserting log:', error);
                addPendingAction({
                    type: 'log_insert',
                    data: logData
                });
                showInfo('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ≥ÿ¨ŸÑ ŸÖÿ≠ŸÑŸäÿßŸã ÿ®ÿ≥ÿ®ÿ® ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ. üì±');
            }
        }
        function checkConnectionStatus() {
            const isOnline = navigator.onLine;
            const statusText = document.getElementById('connectionStatusText');
            const pendingCount = document.getElementById('pendingActionsCount');
            const lastSync = document.getElementById('lastSyncTime');
            
            if (statusText) {
                statusText.textContent = isOnline ? 'üü¢ ŸÖÿ™ÿµŸÑ' : 'üü° ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ';
                statusText.style.color = isOnline ? 'var(--success)' : 'var(--warning)';
            }
            
            if (pendingCount) {
                pendingCount.textContent = appState.offlineMode.pendingActions.length;
                pendingCount.style.color = appState.offlineMode.pendingActions.length > 0 ? 'var(--warning)' : 'var(--success)';
            }
            
            if (lastSync) {
                if (appState.offlineMode.lastSync) {
                    const syncTime = new Date(appState.offlineMode.lastSync);
                    lastSync.textContent = syncTime.toLocaleString('ar-IQ');
                } else {
                    lastSync.textContent = 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
                }
            }
            
            showInfo(`ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ: ${isOnline ? 'ŸÖÿ™ÿµŸÑ' : 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'} | ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©: ${appState.offlineMode.pendingActions.length}`);
        }
        
        function showPendingActions() {
            if (appState.offlineMode.pendingActions.length === 0) {
                showInfo('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ŸÖÿπŸÑŸÇÿ©');
                return;
            }
            
            let message = `üìã ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ© (${appState.offlineMode.pendingActions.length}):\n\n`;
            
            appState.offlineMode.pendingActions.forEach((action, index) => {
                const time = new Date(action.timestamp).toLocaleString('ar-IQ');
                message += `${index + 1}. ${getActionTypeText(action.type)} - ${time}\n`;
                if (action.retryCount > 0) {
                    message += `   ŸÖÿ≠ÿßŸàŸÑÿßÿ™: ${action.retryCount}\n`;
                }
                message += '\n';
            });
            
            showInfo(message, 10000);
        }
        
        function getActionTypeText(type) {
            const types = {
                'log_insert': 'ÿ•ÿ∂ÿßŸÅÿ© ÿ≥ÿ¨ŸÑ',
                'employee_update': 'ÿ™ÿ≠ÿØŸäÿ´ ŸÅÿ±ÿØ',
                'center_update': 'ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ±ŸÉÿ≤'
            };
            return types[type] || type;
        }
        function updateOfflineStatusDisplay() {
            checkConnectionStatus();
        }
        function startMovementTracking(employeeId, employeeName) {
            if (!navigator.geolocation) {
                showError('ÿÆÿØŸÖÿßÿ™ ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠');
                return;
            }

            appState.offlineMode.movementTracking.isTracking = true;
            appState.offlineMode.movementTracking.routeStartTime = new Date().toISOString();
            appState.offlineMode.movementTracking.currentRoute = {
                employeeId: employeeId,
                employeeName: employeeName,
                startTime: new Date().toISOString(),
                checkpoints: [],
                status: 'in_progress'
            };
            const watchId = navigator.geolocation.watchPosition(
                (position) => handleMovementUpdate(position, employeeId),
                (error) => handleMovementError(error),
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                }
            );

            appState.offlineMode.movementTracking.watchId = watchId;
            
            showSuccess(`ÿ®ÿØÿ£ ÿ™ÿ™ÿ®ÿπ ÿ≠ÿ±ŸÉÿ© ${employeeName} üìç`);
            saveTrackingState();
            
            return watchId;
        }

        function handleMovementUpdate(position, employeeId) {
            const { latitude, longitude, accuracy, timestamp } = position.coords;
            
            const locationData = {
                latitude,
                longitude,
                accuracy,
                timestamp: new Date(timestamp).toISOString(),
                employeeId: employeeId,
                isOnline: navigator.onLine
            };
            appState.offlineMode.movementTracking.trackingHistory.push(locationData);
            appState.offlineMode.movementTracking.lastKnownLocation = locationData;
            checkNearbyCenters(locationData);
            analyzeMovementPattern(locationData);
            saveTrackingData();
            updateTrackingDisplay();
        }

        function checkNearbyCenters(locationData) {
            const centers = appState.currentUser.role === 'admin' ? 
                appState.allCenters : appState.allowedCenters;
            
            centers.forEach(center => {
                const distance = calculateDistance(
                    locationData.latitude,
                    locationData.longitude,
                    center.latitude,
                    center.longitude
                );
                
                if (distance <= 200) {
                    addOfflineCheckpoint({
                        type: 'near_center',
                        centerId: center.id || center.center_id,
                        centerName: center.name || center.center_name,
                        distance: distance,
                        timestamp: locationData.timestamp,
                        employeeId: locationData.employeeId
                    });
                }
            });
        }

        function analyzeMovementPattern(locationData) {
            const history = appState.offlineMode.movementTracking.trackingHistory;
            
            if (history.length < 3) return;
            
            const recentLocations = history.slice(-3);
            
            const speeds = [];
            for (let i = 1; i < recentLocations.length; i++) {
                const timeDiff = (new Date(recentLocations[i].timestamp) - new Date(recentLocations[i-1].timestamp)) / 1000; // seconds
                const distance = calculateDistance(
                    recentLocations[i-1].latitude,
                    recentLocations[i-1].longitude,
                    recentLocations[i].latitude,
                    recentLocations[i].longitude
                );
                
                if (timeDiff > 0) {
                    speeds.push(distance / timeDiff); 
                }
            }
            
            const avgSpeed = speeds.reduce((sum, speed) => sum + speed, 0) / speeds.length;
            
            let movementType = 'stationary';
            if (avgSpeed > 2) movementType = 'walking';
            if (avgSpeed > 5) movementType = 'running';
            if (avgSpeed > 10) movementType = 'vehicle';
            
            appState.offlineMode.movementTracking.movementPatterns.push({
                timestamp: locationData.timestamp,
                speed: avgSpeed,
                type: movementType,
                accuracy: locationData.accuracy
            });
        }

        function addOfflineCheckpoint(checkpoint) {
            appState.offlineMode.movementTracking.offlineCheckpoints.push(checkpoint);
            
            const savedCheckpoints = JSON.parse(localStorage.getItem('offlineCheckpoints') || '[]');
            savedCheckpoints.push(checkpoint);
            localStorage.setItem('offlineCheckpoints', JSON.stringify(savedCheckpoints));
            
            showCheckpointNotification(checkpoint);
        }

        function showCheckpointNotification(checkpoint) {
            let message = '';
            let type = 'info';
            
            switch (checkpoint.type) {
                case 'near_center':
                    message = `üìç ${checkpoint.employeeName || 'ŸÅÿ±ÿØ'} ÿßŸÇÿ™ÿ±ÿ® ŸÖŸÜ ${checkpoint.centerName} (${Math.round(checkpoint.distance)}ŸÖ)`;
                    type = 'success';
                    break;
                case 'entered_center':
                    message = `üè¢ ${checkpoint.employeeName || 'ŸÅÿ±ÿØ'} ÿØÿÆŸÑ ${checkpoint.centerName}`;
                    type = 'success';
                    break;
                case 'left_center':
                    message = `üö™ ${checkpoint.employeeName || 'ŸÅÿ±ÿØ'} ÿ∫ÿßÿØÿ± ${checkpoint.centerName}`;
                    type = 'warning';
                    break;
                case 'returning_home':
                    message = `üè† ${checkpoint.employeeName || 'ŸÅÿ±ÿØ'} ÿπÿßÿ¶ÿØ ŸÑŸÑÿ®Ÿäÿ™`;
                    type = 'info';
                    break;
                case 'arrived_home':
                    message = `üè† ${checkpoint.employeeName || 'ŸÅÿ±ÿØ'} ŸàÿµŸÑ ŸÑŸÑÿ®Ÿäÿ™`;
                    type = 'success';
                    break;
            }
            
            showNotification(message, type, 5000);
        }

        function stopMovementTracking() {
            if (!appState.offlineMode.movementTracking.isTracking) {
                showInfo('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ÿ™ÿ®ÿπ ŸÜÿ¥ÿ∑');
                return;
            }

            if (appState.offlineMode.movementTracking.watchId) {
                navigator.geolocation.clearWatch(appState.offlineMode.movementTracking.watchId);
            }

            if (appState.offlineMode.movementTracking.currentRoute) {
                appState.offlineMode.movementTracking.currentRoute.endTime = new Date().toISOString();
                appState.offlineMode.movementTracking.currentRoute.status = 'completed';
            }

            appState.offlineMode.movementTracking.isTracking = false;
            
            showSuccess('ÿ™ŸÖ ÿ•ŸäŸÇÿßŸÅ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ≠ÿ±ŸÉÿ©');
            
            saveTrackingState();
            
            generateMovementReport();
        }

        function generateMovementReport() {
            const tracking = appState.offlineMode.movementTracking;
            const route = tracking.currentRoute;
            
            if (!route) return;
            
            const startTime = new Date(route.startTime);
            const endTime = new Date(route.endTime);
            const duration = (endTime - startTime) / 1000 / 60; 
            
            const totalDistance = calculateTotalDistance(tracking.trackingHistory);
            const avgSpeed = totalDistance / (duration * 60); 
            
            const report = {
                employeeId: route.employeeId,
                employeeName: route.employeeName,
                startTime: route.startTime,
                endTime: route.endTime,
                duration: duration,
                totalDistance: totalDistance,
                avgSpeed: avgSpeed,
                checkpoints: tracking.offlineCheckpoints,
                movementPatterns: tracking.movementPatterns,
                trackingHistory: tracking.trackingHistory
            };
            
            const savedReports = JSON.parse(localStorage.getItem('movementReports') || '[]');
            savedReports.push(report);
            localStorage.setItem('movementReports', JSON.stringify(savedReports));
            
            showMovementReportSummary(report);
            
            return report;
        }

        function calculateTotalDistance(history) {
            let totalDistance = 0;
            
            for (let i = 1; i < history.length; i++) {
                const distance = calculateDistance(
                    history[i-1].latitude,
                    history[i-1].longitude,
                    history[i].latitude,
                    history[i].longitude
                );
                totalDistance += distance;
            }
            
            return totalDistance;
        }

        function showMovementReportSummary(report) {
            const duration = Math.round(report.duration);
            const distance = Math.round(report.totalDistance);
            const speed = Math.round(report.avgSpeed * 3.6); 
            
            let message = `üìä ÿ™ŸÇÿ±Ÿäÿ± ÿ≠ÿ±ŸÉÿ© ${report.employeeName}:\n\n`;
            message += `‚è±Ô∏è ÿßŸÑŸÖÿØÿ©: ${duration} ÿØŸÇŸäŸÇÿ©\n`;
            message += `üìè ÿßŸÑŸÖÿ≥ÿßŸÅÿ©: ${distance} ŸÖÿ™ÿ±\n`;
            message += `üö∂ ÿßŸÑÿ≥ÿ±ÿπÿ© ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ÿ©: ${speed} ŸÉŸÖ/ÿ≥ÿßÿπÿ©\n`;
            message += `üìç ŸÜŸÇÿßÿ∑ ÿßŸÑÿ™ŸàŸÇŸÅ: ${report.checkpoints.length}\n`;
            message += `üîÑ ÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑÿ≠ÿ±ŸÉÿ©: ${report.movementPatterns.length}\n`;
            
            showInfo(message, 10000);
        }
        function saveTrackingState() {
            localStorage.setItem('movementTrackingState', JSON.stringify({
                isTracking: appState.offlineMode.movementTracking.isTracking,
                currentRoute: appState.offlineMode.movementTracking.currentRoute,
                lastKnownLocation: appState.offlineMode.movementTracking.lastKnownLocation
            }));
        }
        function saveTrackingData() {
            localStorage.setItem('movementTrackingData', JSON.stringify({
                trackingHistory: appState.offlineMode.movementTracking.trackingHistory,
                movementPatterns: appState.offlineMode.movementTracking.movementPatterns,
                offlineCheckpoints: appState.offlineMode.movementTracking.offlineCheckpoints
            }));
        }
        function loadTrackingData() {
            try {
                const savedState = localStorage.getItem('movementTrackingState');
                const savedData = localStorage.getItem('movementTrackingData');
                
                if (savedState) {
                    const state = JSON.parse(savedState);
                    appState.offlineMode.movementTracking.isTracking = state.isTracking;
                    appState.offlineMode.movementTracking.currentRoute = state.currentRoute;
                    appState.offlineMode.movementTracking.lastKnownLocation = state.lastKnownLocation;
                }
                
                if (savedData) {
                    const data = JSON.parse(savedData);
                    appState.offlineMode.movementTracking.trackingHistory = data.trackingHistory || [];
                    appState.offlineMode.movementTracking.movementPatterns = data.movementPatterns || [];
                    appState.offlineMode.movementTracking.offlineCheckpoints = data.offlineCheckpoints || [];
                }
            } catch (error) {
                console.error('Error loading tracking data:', error);
            }
        }
        function updateTrackingDisplay() {
            const tracking = appState.offlineMode.movementTracking;
            
            if (!tracking.isTracking) return;
            const trackingStatusElement = document.getElementById('trackingStatus');
            if (trackingStatusElement) {
                const route = tracking.currentRoute;
                const duration = route ? Math.round((new Date() - new Date(route.startTime)) / 1000 / 60) : 0;
                
                trackingStatusElement.innerHTML = `
                    <div style="background: var(--success); color: white; padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <strong>üìç ÿ™ÿ™ÿ®ÿπ ŸÜÿ¥ÿ∑: ${route?.employeeName || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'}</strong><br>
                        <small>ÿßŸÑŸÖÿØÿ©: ${duration} ÿØŸÇŸäŸÇÿ© | ÿßŸÑŸÜŸÇÿßÿ∑: ${tracking.offlineCheckpoints.length}</small>
                    </div>
                `;
            }
        }
        function handleMovementError(error) {
            console.error('Movement tracking error:', error);
            
            let errorMessage = 'ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖŸàŸÇÿπ: ';
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'ÿßŸÜÿ™Ÿáÿ™ ŸÖŸáŸÑÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±';
                    break;
                default:
                    errorMessage += 'ÿÆÿ∑ÿ£ ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
            }
            
            showError(errorMessage);
        }
        function startTrackingForSelected() {
            const select = document.getElementById('trackingEmployeeSelect');
            const employeeId = select.value;
            const employeeName = select.options[select.selectedIndex].text;
            
            if (!employeeId) {
                showError('Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÅÿ±ÿØ ŸÑŸÑÿ™ÿ™ÿ®ÿπ');
                return;
            }
            
            if (appState.offlineMode.movementTracking.isTracking) {
                showError('ŸäŸàÿ¨ÿØ ÿ™ÿ™ÿ®ÿπ ŸÜÿ¥ÿ∑ ÿ®ÿßŸÑŸÅÿπŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿ•ŸäŸÇÿßŸÅŸá ÿ£ŸàŸÑÿßŸã');
                return;
            }
            startMovementTracking(employeeId, employeeName);
            document.getElementById('startTrackingBtn').style.display = 'none';
            document.getElementById('stopTrackingBtn').style.display = 'inline-block';
            document.getElementById('trackingInfo').style.display = 'block';
            startTrackingUpdates();
        }
        function startTrackingUpdates() {
            if (appState.offlineMode.movementTracking.updateInterval) {
                clearInterval(appState.offlineMode.movementTracking.updateInterval);
            }
            
            appState.offlineMode.movementTracking.updateInterval = setInterval(() => {
                updateTrackingUI();
            }, 5000); 
        }
        function updateTrackingUI() {
            const tracking = appState.offlineMode.movementTracking;
            
            if (!tracking.isTracking || !tracking.currentRoute) return;
            const startTime = new Date(tracking.currentRoute.startTime);
            const duration = Math.round((new Date() - startTime) / 1000 / 60);
            document.getElementById('trackingDuration').textContent = `${duration} ÿØŸÇŸäŸÇÿ©`;
            const totalDistance = calculateTotalDistance(tracking.trackingHistory);
            document.getElementById('trackingDistance').textContent = `${Math.round(totalDistance)} ŸÖÿ™ÿ±`;
            document.getElementById('trackingCheckpoints').textContent = tracking.offlineCheckpoints.length;
            if (tracking.lastKnownLocation) {
                const lat = tracking.lastKnownLocation.latitude.toFixed(4);
                const lng = tracking.lastKnownLocation.longitude.toFixed(4);
                document.getElementById('lastKnownLocation').textContent = `${lat}, ${lng}`;
            }
            updateTrackingDisplay();
        }
        function populateTrackingEmployeeSelect() {
            const select = document.getElementById('trackingEmployeeSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">ÿßÿÆÿ™ÿ± ŸÅÿ±ÿØ...</option>';
            
            const employees = appState.currentUser.role === 'admin' ? 
                appState.allEmployees : appState.allowedEmployees;
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id || employee.employee_id;
                option.textContent = employee.name || employee.employee_name;
                select.appendChild(option);
            });
        }
        function showTrackingHistory() {
            const tracking = appState.offlineMode.movementTracking;
            
            if (tracking.trackingHistory.length === 0) {
                showInfo('ŸÑÿß ŸäŸàÿ¨ÿØ ÿ≥ÿ¨ŸÑ ÿ™ÿ™ÿ®ÿπ');
                return;
            }
            
            let message = `üìä ÿ≥ÿ¨ŸÑ ÿßŸÑÿ™ÿ™ÿ®ÿπ (${tracking.trackingHistory.length} ŸÜŸÇÿ∑ÿ©):\n\n`;   
            const recentLocations = tracking.trackingHistory.slice(-10);
            recentLocations.forEach((location, index) => {
                const time = new Date(location.timestamp).toLocaleTimeString('ar-IQ');
                const lat = location.latitude.toFixed(4);
                const lng = location.longitude.toFixed(4);
                const accuracy = Math.round(location.accuracy);
                
                message += `${index + 1}. ${time} - ${lat}, ${lng} (ÿØŸÇÿ©: ${accuracy}ŸÖ)\n`;
            });
            
            showInfo(message, 10000);
        }  
        function exportTrackingData() {
            const tracking = appState.offlineMode.movementTracking;
            
            if (tracking.trackingHistory.length === 0) {
                showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }
            
            try {
                const data = {
                    trackingHistory: tracking.trackingHistory,
                    movementPatterns: tracking.movementPatterns,
                    offlineCheckpoints: tracking.offlineCheckpoints,
                    currentRoute: tracking.currentRoute,
                    exportTime: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tracking_data_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ™ÿ®ÿπ ÿ®ŸÜÿ¨ÿßÿ≠');
            } catch (error) {
                console.error('Error exporting tracking data:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
            }
        }
        function clearTrackingData() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ŸÖÿ≥ÿ≠ ÿ¨ŸÖŸäÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ™ÿ®ÿπÿü')) {
                appState.offlineMode.movementTracking.trackingHistory = [];
                appState.offlineMode.movementTracking.movementPatterns = [];
                appState.offlineMode.movementTracking.offlineCheckpoints = [];
                appState.offlineMode.movementTracking.currentRoute = null;
                
                localStorage.removeItem('movementTrackingData');
                localStorage.removeItem('movementTrackingState');
                localStorage.removeItem('offlineCheckpoints');
                localStorage.removeItem('movementReports');      
                document.getElementById('trackingInfo').style.display = 'none';
                document.getElementById('startTrackingBtn').style.display = 'inline-block';
                document.getElementById('stopTrackingBtn').style.display = 'none';
                document.getElementById('trackingStatus').innerHTML = '';
                
                showSuccess('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ™ÿ®ÿπ');
            }
        }
        
        function showMovementReports() {
            try {
                const savedReports = JSON.parse(localStorage.getItem('movementReports') || '[]');
                
                if (savedReports.length === 0) {
                    showInfo('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ŸÇÿßÿ±Ÿäÿ± ÿ≠ÿ±ŸÉÿ©');
                    return;
                }
                
                let message = `üìã ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑÿ≠ÿ±ŸÉÿ© (${savedReports.length} ÿ™ŸÇÿ±Ÿäÿ±):\n\n`;
                
                savedReports.slice(-5).forEach((report, index) => {
                    const date = new Date(report.startTime).toLocaleDateString('ar-IQ');
                    const duration = Math.round(report.duration);
                    const distance = Math.round(report.totalDistance);
                    
                    message += `${index + 1}. ${report.employeeName} - ${date}\n`;
                    message += `   ÿßŸÑŸÖÿØÿ©: ${duration} ÿØŸÇŸäŸÇÿ© | ÿßŸÑŸÖÿ≥ÿßŸÅÿ©: ${distance} ŸÖÿ™ÿ±\n`;
                    message += `   ÿßŸÑŸÜŸÇÿßÿ∑: ${report.checkpoints.length}\n\n`;
                });
                
                showInfo(message, 15000);
            } catch (error) {
                console.error('Error showing movement reports:', error);
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±');
            }
        }

        function startTrackingForEmployee(employeeId, employeeName) {
            if (appState.offlineMode.movementTracking.isTracking) {
                if (confirm('ŸäŸàÿ¨ÿØ ÿ™ÿ™ÿ®ÿπ ŸÜÿ¥ÿ∑ ÿ®ÿßŸÑŸÅÿπŸÑ. ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸäŸÇÿßŸÅŸá Ÿàÿ®ÿØÿ° ÿ™ÿ™ÿ®ÿπ ÿ¨ÿØŸäÿØÿü')) {
                    stopMovementTracking();
                    setTimeout(() => {
                        startMovementTracking(employeeId, employeeName);
                        showSuccess(`ÿ®ÿØÿ£ ÿ™ÿ™ÿ®ÿπ ÿ≠ÿ±ŸÉÿ© ${employeeName} üìç`);
                    }, 1000);
                }
            } else {
                startMovementTracking(employeeId, employeeName);
                showSuccess(`ÿ®ÿØÿ£ ÿ™ÿ™ÿ®ÿπ ÿ≠ÿ±ŸÉÿ© ${employeeName} üìç`);
                
                const trackingSection = document.getElementById('movementTrackingSection');
                if (trackingSection) {
                    trackingSection.classList.remove('collapsed');
                    trackingSection.parentElement.querySelector('.section-header').classList.remove('collapsed');
                }
            }
        }

        window.login = login;
        window.logout = logout;
        window.toggleTheme = toggleTheme;
        window.filterLogs = filterLogs;
        window.focusOnEmployees = focusOnEmployees;
        window.focusOnActiveEmployees = focusOnActiveEmployees;
        window.focusOnCheckedIn = focusOnCheckedIn;
        window.focusOnCheckedOut = focusOnCheckedOut;
        window.focusOnCenters = focusOnCenters;
        window.focusOnLogs = focusOnLogs;
        window.refreshMap = refreshMap;
        window.fitAllMarkers = fitAllMarkers;
        window.showAllEmployeesOnMap = showAllEmployeesOnMap;
        window.toggleMapStyle = toggleMapStyle;
        window.toggleSection = toggleSection;
        window.addCenter = addCenter;
        window.addEmployee = addEmployee;
        window.addUser = addUser;
        window.refreshLogs = refreshLogs;
        window.refreshAll = refreshAll;
        window.locateMe = locateMe;
        window.filterEmployees = filterEmployees;
        window.filterCenters = filterCenters;
        window.filterMovements = filterMovements;
        window.clearMovementSearch = clearMovementSearch;
        window.refreshEmployeeLocations = refreshEmployeeLocations;
        window.editEmployee = editEmployee;
        window.editCenter = editCenter;
        window.updateEmployee = updateEmployee;
        window.updateCenter = updateCenter;
        window.deleteEmployee = deleteEmployee;
        window.deleteCenter = deleteCenter;
        window.showModal = showModal;
        window.closeModal = closeModal;
        window.focusOnEmployee = focusOnEmployee;
        window.nextPage = nextPage;
        window.previousPage = previousPage;
        
        window.scrollToSection = scrollToSection;
        window.applyAdvancedSearch = applyAdvancedSearch;
        window.clearAdvancedSearch = clearAdvancedSearch;
        window.exportToPDF = exportToPDF;
        window.exportToExcel = exportToExcel;
        window.togglePhoneVisibility = togglePhoneVisibility;
        
        window.updateLocationSettings = updateLocationSettings;
        window.loadLocationSettings = loadLocationSettings;
        window.testLocationAccuracy = testLocationAccuracy;
        window.checkEmployeeLocationWithAccuracy = checkEmployeeLocationWithAccuracy;
        window.getEnhancedLocation = getEnhancedLocation;
        window.calculateDistance = calculateDistance;
        window.isEmployeeInCenterRange = isEmployeeInCenterRange;
        
        window.checkConnectionStatus = checkConnectionStatus;
        window.syncPendingActions = syncPendingActions;
        window.showPendingActions = showPendingActions;
        window.startTrackingForSelected = startTrackingForSelected;
        window.stopMovementTracking = stopMovementTracking;
        window.showTrackingHistory = showTrackingHistory;
        window.exportTrackingData = exportTrackingData;
        window.clearTrackingData = clearTrackingData;
        window.showMovementReports = showMovementReports;
        window.startTrackingForEmployee = startTrackingForEmployee;

     
        async function loadUsersList() {
            if (!appState.currentUser || appState.currentUser.role !== 'admin') return;
            const container = document.getElementById('usersListContainer');
            container.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ...</div>';
            try {
                let users = [];
                if (appState.supabase) {
                    const { data, error } = await appState.supabase.from('users').select('*').order('created_at', { ascending: false });
                    if (error) throw error;
                    users = data || [];
                } else {
                    users = [
                        { id: 1, username: 'admin', full_name: 'ŸÖÿØŸäÿ±', role: 'admin', permissions: { can_add_centers: true, can_add_employees: true, can_edit_centers: true, can_edit_employees: true, can_delete_centers: true, can_delete_employees: true, can_export: true, can_track: true } },
                        { id: 2, username: 'user1', full_name: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ Ÿ°', role: 'user', permissions: { can_add_centers: false, can_add_employees: true, can_edit_centers: false, can_edit_employees: true, can_delete_centers: false, can_delete_employees: false, can_export: false, can_track: true } }
                    ];
                }
                displayUsersList(users);
            } catch (error) {
                container.innerHTML = '<div style="color: var(--danger);">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ</div>';
            }
        }

        function displayUsersList(users) {
            const container = document.getElementById('usersListContainer');
            if (!users.length) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≥ÿ™ÿÆÿØŸÖŸàŸÜ</div>';
                return;
            }
            container.innerHTML = '';
            users.forEach(user => {
                const div = document.createElement('div');
                div.className = 'item-card';
                let actionsHtml = '';
                if (appState.currentUser && appState.currentUser.role === 'admin') {
                    actionsHtml += `<button class="btn btn-small" onclick="openEditUserPermissions(${user.id})">üîë ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™</button>`;
                    actionsHtml += `<button class="btn btn-success btn-small" onclick="editUser(${user.id})">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</button>`;
                    actionsHtml += `<button class="btn btn-danger btn-small" onclick="deleteUser(${user.id})">üóëÔ∏è ÿ≠ÿ∞ŸÅ</button>`;
                }
                let loginStatus = '';
                if (!user.last_login) {
                    loginStatus = '<span style="color: var(--warning); font-size: 0.9em;">ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤ ÿ≠ÿ™Ÿâ ÿßŸÑÿ¢ŸÜ</span>';
                } else {
                    loginStatus = `<span style="color: var(--success); font-size: 0.9em;">ÿ¢ÿÆÿ± ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖÿ±ŸÉÿ≤: ${user.last_login}</span>`;
                }
                div.innerHTML = `
                    <div class="item-info">
                        <strong>${user.full_name}</strong> <span style="color: var(--accent); font-size: 0.9em;">@${user.username}</span><br>
                        <small>ÿßŸÑŸÜŸàÿπ: ${user.role === 'admin' ? 'ŸÖÿØŸäÿ±' : 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ'}</small><br>
                        ${loginStatus}
                    </div>
                    <div class="item-actions">
                        ${actionsHtml}
                    </div>
                `;
                container.appendChild(div);
            });
            appState.allUsers = users;
        }

        function openEditUserPermissions(userId) {
            const user = (appState.allUsers || []).find(u => u.id === userId);
            if (!user) return;
            appState.editingUserPermissions = user;
            document.getElementById('permAddCenters').checked = !!user.permissions?.can_add_centers;
            document.getElementById('permEditCenters').checked = !!user.permissions?.can_edit_centers;
            document.getElementById('permDeleteCenters').checked = !!user.permissions?.can_delete_centers;
            document.getElementById('permAddEmployees').checked = !!user.permissions?.can_add_employees;
            document.getElementById('permEditEmployees').checked = !!user.permissions?.can_edit_employees;
            document.getElementById('permDeleteEmployees').checked = !!user.permissions?.can_delete_employees;
            document.getElementById('permExport').checked = !!user.permissions?.can_export;
            document.getElementById('permTrack').checked = !!user.permissions?.can_track;
            showModal('editUserPermissionsModal');
        }
        async function saveUserPermissions() {
            const user = appState.editingUserPermissions;
            if (!user) return;
            if (!appState.currentUser || appState.currentUser.role !== 'admin') {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™');
                return;
            }
            const newPerms = {
                can_add_centers: document.getElementById('permAddCenters').checked,
                can_edit_centers: document.getElementById('permEditCenters').checked,
                can_delete_centers: document.getElementById('permDeleteCenters').checked,
                can_add_employees: document.getElementById('permAddEmployees').checked,
                can_edit_employees: document.getElementById('permEditEmployees').checked,
                can_delete_employees: document.getElementById('permDeleteEmployees').checked,
                can_export: document.getElementById('permExport').checked,
                can_track: document.getElementById('permTrack').checked
            };
            try {
                if (appState.supabase) {
                    const { error } = await appState.supabase.rpc('update_user_permissions', {
                        user_id: user.id,
                        can_add_centers: newPerms.can_add_centers,
                        can_edit_centers: newPerms.can_edit_centers,
                        can_delete_centers: newPerms.can_delete_centers,
                        can_add_employees: newPerms.can_add_employees,
                        can_edit_employees: newPerms.can_edit_employees,
                        can_delete_employees: newPerms.can_delete_employees,
                        can_export: newPerms.can_export,
                        can_track: newPerms.can_track
                    });
                    if (error) throw error;
                }
                user.permissions = newPerms;
                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™ ÿ®ŸÜÿ¨ÿßÿ≠');
                closeModal('editUserPermissionsModal');
                loadUsersList();
            } catch (error) {
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÑÿßÿ≠Ÿäÿßÿ™');
            }
        }

        async function deleteUser(userId) {
            if (!appState.currentUser || appState.currentUser.role !== 'admin') {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
        }
        async function editUser(userId, newData) {
            if (!appState.currentUser || appState.currentUser.role !== 'admin') {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
        }
        function editUser(userId) {
            if (!appState.currentUser || appState.currentUser.role !== 'admin') {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            const user = (appState.allUsers || []).find(u => u.id === userId);
            if (!user) return;
            appState.editingUser = user;
            document.getElementById('editUserUsername').value = user.username;
            document.getElementById('editUserFullName').value = user.full_name;
            document.getElementById('editUserEmail').value = user.email || '';
            document.getElementById('editUserPhone').value = user.phone || '';
            document.getElementById('editUserRole').value = user.role;
            const select = document.getElementById('editUserCenters');
            select.innerHTML = '';
            const centers = appState.currentUser.role === 'admin' ? appState.allCenters : appState.allowedCenters;
            centers.forEach(center => {
                const option = document.createElement('option');
                option.value = center.id || center.center_id;
                option.textContent = center.name || center.center_name;
                select.appendChild(option);
            });
            if (window.$ && $('#editUserCenters').select2) {
                $(select).select2({
                    placeholder: $(select).data('placeholder') || 'ÿßÿÆÿ™ÿ± ŸÖÿ±ŸÉÿ≤ ÿ£Ÿà ÿ£ŸÉÿ´ÿ±...',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#editUserModal')
                });
                if (user.center_ids && user.center_ids.length) {
                    $(select).val(user.center_ids.map(String)).trigger('change');
                }
            }
            showModal('editUserModal');
        }
        async function updateUser() {
            if (!appState.editingUser) return;
            const username = document.getElementById('editUserUsername').value.trim();
            const fullName = document.getElementById('editUserFullName').value.trim();
            const email = document.getElementById('editUserEmail').value.trim();
            const phone = document.getElementById('editUserPhone').value.trim();
            const role = document.getElementById('editUserRole').value;
            const selectedCenters = Array.from(document.getElementById('editUserCenters').selectedOptions).map(opt => parseInt(opt.value));
            try {
                let oldName = '';
                const { data: oldData, error: oldError } = await appState.supabase
                    .from('users')
                    .select('full_name')
                    .eq('id', appState.editingUser.id)
                    .single();
                if (!oldError && oldData && oldData.full_name) {
                    oldName = oldData.full_name;
                } else {
                    oldName = fullName;
                }
                const { data, error } = await appState.supabase.rpc('update_user', {
                    user_id: appState.editingUser.id,
                    user_username: username,
                    user_full_name: fullName,
                    user_email: email,
                    user_phone: phone,
                    user_role: role,
                    center_ids: selectedCenters.length ? selectedCenters : null,
                    admin_user_id: appState.currentUser?.id || null,
                    old_name: oldName
                });
                if (error) throw error;
                await appState.supabase.rpc('update_user_centers', {
                    user_id: appState.editingUser.id,
                    center_ids: selectedCenters.length ? selectedCenters : []
                });
                closeModal('editUserModal');
                showSuccess('ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
                loadUsersList();
                await logMainAction('update', 'user', fullName, { old_name: oldName });
            } catch (error) {
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + error.message);
            }
        }
        async function deleteUser(userId) {
            if (!appState.currentUser || appState.currentUser.role !== 'admin') {
                showError('ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ŸÑÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ');
                return;
            }
            if (!confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿü')) return;
            try {
                const { error } = await appState.supabase
                    .from('users')
                    .delete()
                    .eq('id', userId);
                if (error) throw error;
                showSuccess('ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ®ŸÜÿ¨ÿßÿ≠');
                loadUsersList();
            } catch (error) {
                showError('ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ' + error.message);
            }
        }
        window.editUser = editUser;
        window.updateUser = updateUser;
        window.deleteUser = deleteUser;
        function populateNewUserCenters() {
            const select = document.getElementById('newUserCenters');
            if (!select) return;
            select.innerHTML = '';
            const centers = appState.currentUser.role === 'admin' ? appState.allCenters : appState.allowedCenters;
            console.log('ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿ•ÿ∂ÿßŸÅÿ©:', centers);
            if (!centers || !centers.length) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ±ÿßŸÉÿ≤ ŸÖÿ™ÿßÿ≠ÿ©';
                select.appendChild(option);
            } else {
                centers.forEach(center => {
                    const option = document.createElement('option');
                    option.value = center.id || center.center_id;
                    option.textContent = center.name || center.center_name;
                    select.appendChild(option);
                });
            }
            if (window.$ && $(select).hasClass('select2-hidden-accessible')) {
                $(select).select2('destroy');
            }
            if (window.$ && $(select).select2) {
                $(select).select2({
                    placeholder: $(select).data('placeholder') || 'ÿßÿÆÿ™ÿ± ŸÖÿ±ŸÉÿ≤ ÿ£Ÿà ÿ£ŸÉÿ´ÿ±...',
                    allowClear: true,
                    width: '100%',
                    dropdownParent: $('#addUserSection')
                });
            }
        }
        async function loadAllowedCenters() {
            try {
                const { data: centers, error } = await appState.supabase.rpc('get_user_allowed_centers', {
                    input_user_id: appState.currentUser.id
                });
                if (error) throw error;
                appState.allowedCenters = centers || [];
                displayCenters(appState.allowedCenters);
                if (appState.map && appState.map.isStyleLoaded()) {
                    updateMapMarkers();
                }
                populateNewUserCenters();
            } catch (error) {
                console.error('Error loading allowed centers:', error);
            }
        }
        async function loadCenters() {
            try {
                const { data: centers, error } = await appState.supabase
                    .from('centers')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                appState.allCenters = centers || [];
                displayCenters(appState.allCenters);
                if (appState.map && appState.map.isStyleLoaded()) {
                    updateMapMarkers();
                }
                populateNewUserCenters(); 
            } catch (error) {
                console.error('Error loading centers:', error);
            }
        }
        function exportFilteredLogs() {
            let logs = appState.allLogs || [];
            if (!logs.length) {
                showError('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ≥ÿ¨ŸÑÿßÿ™ ŸÑŸÑÿ™ÿµÿØŸäÿ±');
                return;
            }
            logs = logs.slice().sort((a, b) => {
                const nameA = (a.employees?.name || '').localeCompare(b.employees?.name || '');
                if (nameA !== 0) return nameA;
                return new Date(a.occurred_at || a.created_at) - new Date(b.occurred_at || b.created_at);
            });

            const logsByName = {};
            logs.forEach(log => {
                const name = log.employees?.name || 'ÿ∫Ÿäÿ± ŸÖÿπÿ±ŸàŸÅ';
                if (!logsByName[name]) logsByName[name] = [];
                logsByName[name].push(log);
            });
            const rows = [];
            Object.entries(logsByName).forEach(([name, personLogs]) => {
                let lastEntry = null;
                personLogs.forEach(log => {
                    const action = (log.action.includes('checkin') || log.action === 'in' || log.action === 'center_entry') ? 'ÿØÿÆŸàŸÑ' : (log.action.includes('checkout') || log.action === 'out') ? 'ÿÆÿ±Ÿàÿ¨' : log.action;
                    const center = log.centers?.name || log.center_name || '';
                    const phone = log.employees?.phone || '';
                    const time = log.occurred_at || log.created_at;
                    if (action === 'ÿØÿÆŸàŸÑ') {

                        if (lastEntry) {
                            rows.push([name, phone, lastEntry.center, lastEntry.time, '']);
                        }
                        lastEntry = { time: time, center: center };
                    } else if (action === 'ÿÆÿ±Ÿàÿ¨' && lastEntry) {

                        rows.push([name, phone, lastEntry.center, lastEntry.time, time]);
                        lastEntry = null;
                    }
                });
                if (lastEntry) {
                    rows.push([name, personLogs[0].employees?.phone || '', lastEntry.center, lastEntry.time, '']);
                }
            });
            const ws_data = [
                ['ÿßŸÑÿßÿ≥ŸÖ', 'ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ', 'ÿßŸÑŸÖÿ±ŸÉÿ≤', 'ŸàŸÇÿ™ ÿßŸÑÿØÿÆŸàŸÑ', 'ŸàŸÇÿ™ ÿßŸÑÿÆÿ±Ÿàÿ¨'],
                ...rows.map(row => [
                    row[0],
                    row[1],
                    row[2],
                    row[3] ? new Date(row[3]).toLocaleString('ar-IQ', {timeZone: 'Asia/Baghdad'}) : '',
                    row[4] ? new Date(row[4]).toLocaleString('ar-IQ', {timeZone: 'Asia/Baghdad'}) : ''
                ])
            ];
            const ws = window.XLSX.utils.aoa_to_sheet(ws_data);
            const wb = window.XLSX.utils.book_new();
            window.XLSX.utils.book_append_sheet(wb, ws, 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿ£ŸÜÿ¥ÿ∑ÿ©');
            window.XLSX.writeFile(wb, 'activity_logs.xlsx');
            showSuccess('ÿ™ŸÖ ÿ™ÿµÿØŸäÿ± ÿßŸÑÿ≥ÿ¨ŸÑÿßÿ™ ÿ•ŸÑŸâ Excel ÿ®ŸÜÿ¨ÿßÿ≠!', 3000);
        }

        function focusOnEmployeeFromList(lat, lng, name) {
            focusOnEmployee(lat, lng, name);
        }


        async function logMainAction(actionType, entityType, entityName, extra = {}) {
            try {
                let coords = { latitude: null, longitude: null };
                if (navigator.geolocation) {
                    await new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                coords.latitude = pos.coords.latitude;
                                coords.longitude = pos.coords.longitude;
                                resolve();
                            },
                            () => resolve(),
                            { enableHighAccuracy: true, timeout: 5000 }
                        );
                    });
                }
                let userId = appState.currentUser?.id || null;
                if (userId && !/^[0-9a-fA-F-]{36}$/.test(userId)) {
                  userId = null;
                }
                const logData = {
                  action: actionType,
                  entity_type: entityType, 
                  entity_name: entityName,
                  latitude: coords.latitude,
                  longitude: coords.longitude,
                  user_id: userId,
                  ...extra,
                  occurred_at: new Date().toISOString()
                };
                await appState.supabase.from('main_logs').insert([logData]);
            } catch (e) { 
                console.error('logMainAction error', e); 
            }
        }

     
        async function loadMainLogs() {
          const container = document.getElementById('mainLogsContainer');
          container.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ...</div>';
          try {

            const { data: logs, error } = await appState.supabase
              .from('main_logs')
              .select('action,entity_type,entity_name,latitude,longitude,user_id,occurred_at,old_name,new_name')
              .order('occurred_at', { ascending: false })
              .limit(200);
            if (error) throw error;
            if (!logs || logs.length === 0) {
              container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπŸÖŸÑŸäÿßÿ™ ÿ®ÿπÿØ</p>';
              return;
            }
        
            const userIds = [...new Set(logs.map(log => log.user_id).filter(Boolean))];
            let usersMap = {};
            if (userIds.length > 0) {
              const { data: users, error: userError } = await appState.supabase
                .from('users')
                .select('id,full_name,username')
                .in('id', userIds);
              if (!userError && users) {
                users.forEach(u => {
                  usersMap[u.id] = u.full_name || u.username || u.id;
                });
              }
            }
            container.innerHTML = '';
            logs.forEach(log => {
              const time = log.occurred_at || log.created_at;
              const hasCoords = typeof log.latitude === 'number' && typeof log.longitude === 'number' && !isNaN(log.latitude) && !isNaN(log.longitude);
              const coords = hasCoords
                ? `<div style='background:#e3f2fd;color:#0d47a1;padding:6px 12px;margin:8px 0 0 0;border-radius:8px;font-size:1.15em;font-weight:bold;display:inline-block;direction:ltr;'>ÿßŸÑŸÖŸàŸÇÿπ: [${log.latitude.toFixed(5)}, ${log.longitude.toFixed(5)}]</div>`
                : `<div style='background:#fff3cd;color:#856404;padding:6px 12px;margin:8px 0 0 0;border-radius:8px;font-size:1em;font-weight:bold;display:inline-block;'>‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ</div>`;
              const userName = log.user_id ? (usersMap[log.user_id] || log.user_id) : '';
              const user = userName ? `üë§ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: ${userName}` : '';

              let actionText = '';
              if (log.action === 'update') {
                let oldNameDisplay = (log.old_name !== undefined && log.old_name !== null && log.old_name !== '') ? log.old_name : null;
                let newNameDisplay = (log.new_name !== undefined && log.new_name !== null && log.new_name !== '') ? log.new_name : log.entity_name;
                if (oldNameDisplay && newNameDisplay) {
                  actionText = `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ${log.entity_type === 'employee' ? 'ÿßŸÑŸÅÿ±ÿØ' : log.entity_type === 'center' ? 'ÿßŸÑŸÖÿ±ŸÉÿ≤' : log.entity_type === 'user' ? 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ' : log.entity_type} ŸÖŸÜ <b style='color:#d32f2f;'>${oldNameDisplay}</b> ÿ•ŸÑŸâ <b style='color:#388e3c;'>${newNameDisplay}</b>`;
                } else if (newNameDisplay) {
                  actionText = `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ${log.entity_type === 'employee' ? 'ÿßŸÑŸÅÿ±ÿØ' : log.entity_type === 'center' ? 'ÿßŸÑŸÖÿ±ŸÉÿ≤' : log.entity_type === 'user' ? 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ' : log.entity_type} ÿ•ŸÑŸâ <b style='color:#388e3c;'>${newNameDisplay}</b>`;
                } else {
                  actionText = `ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ${log.entity_type}`;
                }
              } else if (log.action === 'delete') {
                actionText = `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ${log.entity_type === 'employee' ? 'ŸÅÿ±ÿØ' : log.entity_type === 'center' ? 'ŸÖÿ±ŸÉÿ≤' : log.entity_type === 'user' ? 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ' : log.entity_type} ÿ®ÿßÿ≥ŸÖ ${log.entity_name}`;
              } else if (log.action === 'add') {
                actionText = `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ${log.entity_type === 'employee' ? 'ŸÅÿ±ÿØ' : log.entity_type === 'center' ? 'ŸÖÿ±ŸÉÿ≤' : log.entity_type === 'user' ? 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ' : log.entity_type} ÿ®ÿßÿ≥ŸÖ ${log.entity_name}`;
              } else {
                actionText = `${log.action} ${log.entity_type}: ${log.entity_name}`;
              }

              const row = document.createElement('div');
              row.className = 'log-entry';
              row.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <strong>${actionText}</strong>
                  </div>
                  <div style="font-size:0.8em;color:var(--text-secondary);">
                    ${new Date(time).toLocaleString('ar-IQ', {timeZone:'Asia/Baghdad'})}
                  </div>
                </div>
                ${coords}
                <div class="log-meta">${user}</div>
              `;
              container.appendChild(row);
            });
          } catch (e) {
            container.innerHTML = '<p style="color:red;text-align:center;">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ¨ŸÑ</p>';
          }
        }

        function tryLoadMainLogs(attempts = 0) {
            if (appState.supabase && appState.sessionData?.isLoggedIn) {
                loadMainLogs();
            } else if (attempts < 5) {
                setTimeout(() => tryLoadMainLogs(attempts + 1), 1000);
            }
        }
        tryLoadMainLogs();

        function searchMapMarkers() {
            const query = document.getElementById('mapSearchInput').value.trim().toLowerCase();
            if (!query || !appState.map) return;

            if (appState.allAreas && Array.isArray(appState.allAreas)) {
                const foundArea = appState.allAreas.find(area =>
                    (area.name || '').toLowerCase().includes(query)
                );
                if (foundArea && foundArea.longitude && foundArea.latitude) {
                    appState.map.flyTo({
                        center: [foundArea.longitude, foundArea.latitude],
                        zoom: 14,
                        duration: 1500
                    });
                    showInfo(`ÿ™ŸÖ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©: ${foundArea.name}`);
                    return;
                }
            }

            const centers = appState.currentUser.role === 'admin' ? appState.allCenters : appState.allowedCenters;
            const foundCenter = centers.find(center =>
                ((center.name || center.center_name || '').toLowerCase().includes(query))
                || (center.id && center.id.toString() === query)
            );
            if (foundCenter && foundCenter.longitude && foundCenter.latitude) {
                appState.map.flyTo({
                    center: [foundCenter.longitude, foundCenter.latitude],
                    zoom: 16,
                    duration: 1500
                });
                showInfo(`ÿ™ŸÖ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑŸÖÿ±ŸÉÿ≤: ${foundCenter.name || foundCenter.center_name}`);
                return;
            }

            const employees = appState.currentUser.role === 'admin' ? appState.allEmployees : appState.allowedEmployees;
            const foundEmployee = employees.find(emp =>
                ((emp.name || emp.employee_name || '').toLowerCase().includes(query))
                || (emp.phone && emp.phone.includes(query))
            );
            if (foundEmployee && foundEmployee.longitude && foundEmployee.latitude) {
                appState.map.flyTo({
                    center: [foundEmployee.longitude, foundEmployee.latitude],
                    zoom: 16,
                    duration: 1500
                });
                showInfo(`ÿ™ŸÖ ÿßŸÑÿ™ÿ±ŸÉŸäÿ≤ ÿπŸÑŸâ ÿßŸÑŸÖŸàÿ∏ŸÅ: ${foundEmployee.name || foundEmployee.employee_name}`);
                return;
            }

            showError('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™Ÿäÿ¨ÿ© ŸÖÿ∑ÿßÿ®ŸÇÿ© ŸÅŸä ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ ÿ£Ÿà ÿßŸÑŸÖÿ±ÿßŸÉÿ≤ ÿ£Ÿà ÿßŸÑÿ£ŸÅÿ±ÿßÿØ');
        }

        function isValidIraqPhone(phone) {
            phone = phone.replace(/[-\s]/g, '');
            return /^(077|078|076|075|079)\d{8}$/.test(phone);
        }

        let activityLogsInterval = null;

        function showActivityLogsSection() {
     
            if (activityLogsInterval) clearInterval(activityLogsInterval);
            activityLogsInterval = setInterval(() => {
                if (document.getElementById('activityLogs') && document.getElementById('activityLogs').offsetParent !== null) {
                    loadLogs();
                }
            }, 1000);
        }

        function hideActivityLogsSection() {

            if (activityLogsInterval) {
                clearInterval(activityLogsInterval);
                activityLogsInterval = null;
            }
        }

   
    </script>
</body>
</html>