<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø¬Ø§Ø±ÙŠ</title>
  
  <!-- Cordova -->
  <script type="text/javascript" src="cordova.js"></script>
  
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  
  <style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
      -webkit-user-select: none;
      user-select: none;
    }

    .container {
      width: 100%;
      max-width: 350px;
      padding: 40px 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      text-align: center;
      margin: 20px;
    }

    .logo {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: #667eea;
      font-weight: bold;
    }

    input {
      width: 100%;
      padding: 15px 20px;
      margin: 10px 0;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      text-align: center;
      transition: all 0.3s ease;
      box-sizing: border-box;
      background: white;
      -webkit-appearance: none;
      appearance: none;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      -webkit-appearance: none;
      appearance: none;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .success-message {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      font-size: 20px;
      font-weight: bold;
      animation: fadeIn 0.5s ease-in;
    }

    .hidden {
      display: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ */
    .status-info {
      color: #222;
      font-weight: bold;
      margin: 18px 0 0 0;
      background: #e6f7ff;
      padding: 16px 20px;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 1.1em;
      text-align: right;
      direction: rtl;
      letter-spacing: 0.5px;
      max-width: 380px;
      width: 100%;
      display: block;
    }
    
    .map-container {
      width: 100%;
      max-width: 420px;
      height: 320px;
      margin: 18px 0 0 0;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .tracking-btn {
      margin: 12px 0;
      padding: 10px 24px;
      border-radius: 8px;
      background: #0077b6;
      color: #fff;
      border: none;
      font-size: 1em;
      cursor: pointer;
      width: 100%;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
    @media (max-width: 480px) {
      .container {
        margin: 10px;
        padding: 30px 15px;
      }
      
      .logo {
        font-size: 2em;
        margin-bottom: 20px;
      }
      
      input {
        padding: 12px 15px;
        font-size: 14px;
      }
      
      button {
        padding: 12px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="loginContainer">
    <div class="logo">ğŸ”</div>
    <input type="tel" id="phoneInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" maxlength="15" />
    <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button id="loginBtn" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>

  <div class="container hidden" id="successContainer">
    <div class="success-message">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­<br>ÙŠØ±Ø¬Ù‰ Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙØªÙˆØ­Ø§Ù‹</div>
    <button id="logoutBtn" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); margin-top: 20px;">
      ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    </button>
  </div>

  <script>
    // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© - Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† user.html
    const supabaseUrl = 'https://qcbcjyhqgxwuqutzkxrh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjYmNqeWhxZ3h3dXF1dHpreHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDE3NjQsImV4cCI6MjA2Njc3Nzc2NH0.y-hQVa6nzBpCMpXL7XbcWPMGafATvnMez3lAmFvb2zY';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const SESSION_KEY = 'employee_session';
    
    let currentEmployee = null;
    let locationWatchId = null;
    let trackingStarted = false;
    let employeeMapInstance = null;
    let employeeMarker = null;
    let employeeRoute = null;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Mapbox - Ù†ÙØ³ Ø§Ù„Ù…ÙØªØ§Ø­ Ù…Ù† user.html
    const mapboxToken = 'pk.eyJ1IjoiYW1lZXI3ZWx3YXMiLCJhIjoiY21iODAxaTFyMGFsajJqc2J2dGtvY2pmdSJ9.MNY-7y2onlfAnM0PUhNt8g';

    // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html
    function saveSession(employee) {
      const data = {
        employee,
        timestamp: Date.now()
      };
      const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
      localStorage.setItem(SESSION_KEY, encoded);
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html
    function loadSession() {
      const item = localStorage.getItem(SESSION_KEY);
      if (!item) return null;
      try {
        const decoded = decodeURIComponent(escape(atob(item)));
        const parsed = JSON.parse(decoded);
        const now = Date.now();
        const diff = now - parsed.timestamp;
        if (diff <= 48 * 60 * 60 * 1000) { // 48 Ø³Ø§Ø¹Ø©
          return parsed.employee;
        } else {
          localStorage.removeItem(SESSION_KEY);
          return null;
        }
      } catch {
        return null;
      }
    }

    // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    async function login() {
      const phone = document.getElementById('phoneInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();
      const loginBtn = document.getElementById('loginBtn');

      if (!phone || !password) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚... <span class="loading"></span>';

      try {
        const { data, error } = await supabase.rpc('authenticate_employee', {
          employee_phone: phone,
          employee_password: password
        });

        if (error || !data.success) {
          alert('Ø®Ø·Ø£ ÙÙŠ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
          loginBtn.disabled = false;
          loginBtn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        } else {
          const employee = data.employee;
          currentEmployee = employee;
          saveSession(employee);
          
          // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
          document.getElementById('loginContainer').classList.add('hidden');
          document.getElementById('successContainer').classList.remove('hidden');
          
          // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù Ø¥Ù„Ù‰ Ù†Ø´Ø·
          await supabase.from('employees').update({ status: 'active' }).eq('id', employee.id);

          // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ… - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html
          await checkAndLogManualCheckin(employee);
          
          // Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹
          trackingStarted = true;
          await runBackgroundOperations(employee);
        }
      } catch (err) {
        console.error('Login error:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        loginBtn.disabled = false;
        loginBtn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      }
    }

    // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠ - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html
    async function checkAndLogManualCheckin(employee) {
      try {
        const today = new Date();
        today.setHours(0,0,0,0);
        
        const { data: todayManualLogs } = await supabase
          .from('logs')
          .select('*')
          .eq('employee_id', employee.id)
          .eq('center_id', employee.center_id)
          .in('action', ['manual_checkin', 'checkin', 'in'])
          .gte('occurred_at', today.toISOString());

        if (!todayManualLogs || todayManualLogs.length === 0) {
          const { data: centers } = await supabase.from('centers').select('*');
          const myCenter = centers.find(c => c.id === employee.center_id);
          
          if (myCenter) {
            navigator.geolocation.getCurrentPosition(async (position) => {
              const distance = getDistance(
                position.coords.latitude,
                position.coords.longitude,
                myCenter.latitude,
                myCenter.longitude
              );
              
              if (distance <= myCenter.radius) {
                const logData = {
                  employee_id: employee.id,
                  center_id: myCenter.id,
                  action: 'manual_checkin',
                  latitude: position.coords.latitude,
                  longitude: position.coords.longitude,
                  accuracy: position.coords.accuracy,
                  occurred_at: new Date().toISOString(),
                  notes: 'Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯'
                };
                
                try {
                  await supabase.from('logs').insert([logData]);
                  console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠ:', logData);
                } catch (err) {
                  saveEventLocally(logData);
                  console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠ:', err);
                }
              }
            }, (error) => {
              console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹:', error);
            }, {
              enableHighAccuracy: true,
              timeout: 10000,
              maximumAge: 60000
            });
          }
        }
      } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ:', error);
      }
    }

    // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    async function logout() {
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.disabled = true;
      logoutBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬... <span class="loading"></span>';

      try {
        if (currentEmployee) {
          // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ
          const { data: centers } = await supabase.from('centers').select('*');
          const myCenter = centers.find(c => c.id === currentEmployee.center_id);
          
          if (myCenter) {
            navigator.geolocation.getCurrentPosition(async (position) => {
              const logData = {
                employee_id: currentEmployee.id,
                center_id: myCenter.id,
                action: 'manual_checkout',
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                occurred_at: new Date().toISOString(),
                notes: 'Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯'
              };
              
              try {
                await supabase.from('logs').insert([logData]);
                console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ:', logData);
              } catch (err) {
                saveEventLocally(logData);
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ:', err);
              }
              
              await supabase.from('employees').update({ status: 'inactive' }).eq('id', currentEmployee.id);
            }, (error) => {
              console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù„Ù„Ø®Ø±ÙˆØ¬:', error);
              supabase.from('employees').update({ status: 'inactive' }).eq('id', currentEmployee.id);
            });
          } else {
            await supabase.from('employees').update({ status: 'inactive' }).eq('id', currentEmployee.id);
          }
        }

        // Ø¥ÙŠÙ‚Ø§Ù ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        if (locationWatchId) {
          navigator.geolocation.clearWatch(locationWatchId);
          locationWatchId = null;
        }

        // Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø©
        localStorage.removeItem(SESSION_KEY);
        currentEmployee = null;
        trackingStarted = false;

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('successContainer').classList.add('hidden');
        document.getElementById('loginContainer').classList.remove('hidden');
        document.getElementById('phoneInput').value = '';
        document.getElementById('passwordInput').value = '';
        
        // Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØªØ¨Ø¹
        hideTrackingElements();
        
      } catch (err) {
        console.error('Logout error:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
      }

      logoutBtn.disabled = false;
      logoutBtn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬';
    }

    // Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ø­Ù„ÙŠØ§Ù‹ - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html
    function saveEventLocally(logData) {
      let events = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
      events.push(logData);
      localStorage.setItem('offlineLogs', JSON.stringify(events));
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¹Ù†Ø¯ Ø¹ÙˆØ¯Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html
    async function sendOfflineEvents() {
      let events = JSON.parse(localStorage.getItem('offlineLogs') || '[]');
      if (!events.length) return;
      
      for (const logData of events) {
        try {
          await supabase.from('logs').insert([logData]);
        } catch (err) {
          break;
        }
      }
      localStorage.removeItem('offlineLogs');
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØªØ¨Ø¹ - Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    function createTrackingElements() {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø­Ø§Ù„Ø© Ø§Ù„ØªØªØ¨Ø¹
      if (!document.getElementById('trackingStatus')) {
        const statusDiv = document.createElement('div');
        statusDiv.id = 'trackingStatus';
        statusDiv.className = 'status-info';
        statusDiv.innerHTML = '<span id="trackingWelcome">Ù…Ø±Ø­Ø¨Ø§Ù‹ ğŸ‘‹</span><br><span id="trackingDetails">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</span>';
        
        const loginCard = document.querySelector('#loginContainer, .container');
        if (loginCard && loginCard.parentNode) {
          loginCard.parentNode.insertBefore(statusDiv, loginCard.nextSibling);
        } else {
          document.body.appendChild(statusDiv);
        }
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      if (!document.getElementById('employeeMap')) {
        const mapDiv = document.createElement('div');
        mapDiv.id = 'employeeMap';
        mapDiv.className = 'map-container';
        
        const statusDiv = document.getElementById('trackingStatus');
        if (statusDiv && statusDiv.parentNode) {
          statusDiv.parentNode.insertBefore(mapDiv, statusDiv.nextSibling);
        } else {
          document.body.appendChild(mapDiv);
        }
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹
      if (!document.getElementById('startTrackingBtn')) {
        const btn = document.createElement('button');
        btn.id = 'startTrackingBtn';
        btn.className = 'tracking-btn';
        btn.innerHTML = 'ğŸ“ Ø¨Ø¯Ø¡ Ø§Ù„ØªØªØ¨Ø¹';
        btn.onclick = function() {
          if (currentEmployee && !trackingStarted) {
            trackingStarted = true;
            runBackgroundOperations(currentEmployee);
            btn.style.display = 'none';
          }
        };
        
        const statusDiv = document.getElementById('trackingStatus');
        if (statusDiv && statusDiv.parentNode) {
          statusDiv.parentNode.insertBefore(btn, statusDiv.nextSibling);
        } else {
          document.body.appendChild(btn);
        }
      }
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØªØ¨Ø¹
    function hideTrackingElements() {
      const elements = ['trackingStatus', 'employeeMap', 'startTrackingBtn'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.style.display = 'none';
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØªØ¨Ø¹
    function showTrackingElements() {
      const elements = ['trackingStatus', 'employeeMap', 'startTrackingBtn'];
      elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.style.display = 'block';
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆØ¸Ù - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    async function showEmployeeMap(center, employeePosition) {
      function waitForMapbox(cb, tries = 0) {
        if (window.mapboxgl && mapboxgl.Map && document.getElementById('employeeMap')) return cb();
        if (tries > 50) return;
        setTimeout(() => waitForMapbox(cb, tries + 1), 200);
      }
      
      if (!center || !center.latitude || !center.longitude) return;
      
      waitForMapbox(() => {
        const mapDiv = document.getElementById('employeeMap');
        if (!mapDiv) return;
        
        mapboxgl.accessToken = mapboxToken;
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        if (!employeeMapInstance) {
          employeeMapInstance = new mapboxgl.Map({
            container: 'employeeMap',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [center.longitude, center.latitude],
            zoom: 15
          });
          
          // Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ù…Ø±ÙƒØ²
          const centerMarker = new mapboxgl.Marker({color: '#0077b6'})
            .setLngLat([center.longitude, center.latitude])
            .setPopup(new mapboxgl.Popup().setHTML(`
              <div style="direction:rtl;text-align:right;font-family:'Noto Naskh Arabic','Amiri','Tahoma',Arial,sans-serif;font-size:1.1em;">
                <b>Ù…Ø±ÙƒØ²Ùƒ:</b> ${center.name || ''}
              </div>
            `));
          centerMarker.addTo(employeeMapInstance);
          
          // Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ø¦Ø±Ø© Ù†Ø·Ø§Ù‚ Ø§Ù„Ù…Ø±ÙƒØ²
          employeeMapInstance.on('load', () => {
            if (!employeeMapInstance.getSource('center-circle')) {
              employeeMapInstance.addSource('center-circle', {
                type: 'geojson',
                data: {
                  type: 'Feature',
                  geometry: { type: 'Point', coordinates: [center.longitude, center.latitude] }
                }
              });
            }
            
            if (!employeeMapInstance.getLayer('center-circle-layer')) {
              employeeMapInstance.addLayer({
                id: 'center-circle-layer',
                type: 'circle',
                source: 'center-circle',
                paint: {
                  'circle-radius': {
                    stops: [
                      [0, 0],
                      [20, center.radius / 0.075]
                    ],
                    base: 2
                  },
                  'circle-color': '#90e0ef',
                  'circle-opacity': 0.2,
                  'circle-stroke-width': 2,
                  'circle-stroke-color': '#0077b6'
                }
              });
            }
          });
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ù…ÙˆØ¸Ù
        if (employeePosition && employeePosition.latitude && employeePosition.longitude) {
          if (employeeMarker) {
            employeeMarker.setLngLat([employeePosition.longitude, employeePosition.latitude]);
          } else {
            employeeMarker = new mapboxgl.Marker({color: '#43a047'})
              .setLngLat([employeePosition.longitude, employeePosition.latitude])
              .setPopup(new mapboxgl.Popup().setHTML(`
                <div style="direction:rtl;text-align:right;font-family:'Noto Naskh Arabic','Amiri','Tahoma',Arial,sans-serif;font-size:1.1em;">
                  Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ
                </div>
              `));
            employeeMarker.addTo(employeeMapInstance);
          }
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·
          if (employeeMapInstance.getSource('route')) {
            employeeMapInstance.getSource('route').setData({
              type: 'Feature',
              geometry: {
                type: 'LineString',
                coordinates: [
                  [employeePosition.longitude, employeePosition.latitude],
                  [center.longitude, center.latitude]
                ]
              }
            });
          } else {
            employeeMapInstance.on('load', () => {
              if (!employeeMapInstance.getSource('route')) {
                employeeMapInstance.addSource('route', {
                  type: 'geojson',
                  data: {
                    type: 'Feature',
                    geometry: {
                      type: 'LineString',
                      coordinates: [
                        [employeePosition.longitude, employeePosition.latitude],
                        [center.longitude, center.latitude]
                      ]
                    }
                  }
                });
              }
              
              if (!employeeMapInstance.getLayer('route-layer')) {
                employeeMapInstance.addLayer({
                  id: 'route-layer',
                  type: 'line',
                  source: 'route',
                  paint: {
                    'line-color': '#43a047',
                    'line-width': 4,
                    'line-dasharray': [8, 8]
                  }
                });
              }
            });
          }
          
          // ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ´Ù…Ù„ Ø§Ù„Ù…Ø±ÙƒØ² ÙˆØ§Ù„Ù…ÙˆØ¸Ù
          if (!window._fitBoundsDone) {
            const bounds = new mapboxgl.LngLatBounds();
            bounds.extend([employeePosition.longitude, employeePosition.latitude]);
            bounds.extend([center.longitude, center.latitude]);
            employeeMapInstance.fitBounds(bounds, {padding: 40});
            window._fitBoundsDone = true;
          }
        }
      });
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙˆØ¸Ù
    async function updateEmployeeMap(center, position) {
      if (!center || !position) return;
      showEmployeeMap(center, position);
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    async function runBackgroundOperations(employee) {
      if (!trackingStarted) return;
      
      try {
        const { data: centers } = await supabase.from('centers').select('*');
        if (!centers || !Array.isArray(centers)) return;
        
        const myCenter = centers.find(c => c && c.id === employee.center_id);
        const statusDiv = document.getElementById('trackingStatus');
        const welcomeSpan = document.getElementById('trackingWelcome');
        const detailsSpan = document.getElementById('trackingDetails');
        
        if (welcomeSpan) {
          welcomeSpan.innerHTML = `Ù…Ø±Ø­Ø¨Ø§Ù‹ <b style='color:#0077b6;'>${employee.name || employee.employee_name || ''}</b> ğŸ‘‹`;
        }
        
        if (!myCenter) {
          if (detailsSpan) {
            detailsSpan.innerHTML = '<span style="color:#d32f2f;">âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ²Ùƒ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.</span>';
          }
          return;
        }
        
        if (detailsSpan) {
          detailsSpan.innerHTML = `
            <span style='color:#555;'>Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø®ØµØµ Ù„Ùƒ: <b style='color:#0077b6;'>${myCenter.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</b></span><br>
            <span id='distanceToCenter' style='font-size:1.1em; color:#222;'>ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©...</span>
          `;
        }
        
        // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬
        let wasInCenter = null;
        try {
          const { data: lastLog } = await supabase
            .from('logs')
            .select('*')
            .eq('employee_id', employee.id)
            .eq('center_id', myCenter.id)
            .in('action', ['auto_checkin', 'auto_checkout', 'manual_checkin', 'manual_checkout'])
            .order('occurred_at', { ascending: false })
            .limit(1)
            .single();
          
          if (lastLog) {
            wasInCenter = lastLog.action.includes('checkin');
          }
        } catch (e) {
          wasInCenter = null;
        }
        
        // Ø¨Ø¯Ø¡ ØªØªØ¨Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        locationWatchId = navigator.geolocation.watchPosition(
          async (position) => {
            if (!position || !position.coords) return;
            
            // ØªØ­Ø°ÙŠØ± Ù…Ù† Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¶Ø¹ÙŠÙØ©
            if (position.coords.accuracy > 100) {
              if (detailsSpan) {
                detailsSpan.innerHTML += `<br><span style="color:#d32f2f;">âš ï¸ Ø¯Ù‚Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¶Ø¹ÙŠÙØ© (${Math.round(position.coords.accuracy)}Ù…)</span>`;
              }
            }
            
            const distance = getDistance(
              position.coords.latitude,
              position.coords.longitude,
              myCenter.latitude,
              myCenter.longitude
            );
            
            const inCenter = distance <= myCenter.radius;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§ÙØ© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            const distanceSpan = document.getElementById('distanceToCenter');
            if (distanceSpan) {
              distanceSpan.innerHTML = `Ø§Ù„Ù…Ø±ÙƒØ² ÙŠØ¨Ø¹Ø¯ Ø¹Ù†Ùƒ <b style='color:${inCenter ? '#43a047' : '#d32f2f'};'>${distance.toFixed(1)} Ù…ØªØ±</b> ${inCenter ? 'âœ…' : ''}`;
            }
            
            // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„/Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ
            if (inCenter !== wasInCenter) {
              const logData = {
                employee_id: employee.id,
                center_id: myCenter.id,
                action: inCenter ? 'auto_checkin' : 'auto_checkout',
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                occurred_at: new Date().toISOString(),
                notes: inCenter ? 'Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²' : 'Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ²'
              };
              
              if (navigator.onLine) {
                try {
                  await supabase.from('logs').insert([logData]);
                  console.log('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©:', logData);
                } catch (err) {
                  saveEventLocally(logData);
                  console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø±ÙƒØ©:', err);
                }
              } else {
                saveEventLocally(logData);
                console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ© Ù…Ø­Ù„ÙŠØ§Ù‹ (Ø£ÙˆÙÙ„Ø§ÙŠÙ†):', logData);
              }
              
              await supabase.from('employees').update({ 
                status: inCenter ? 'active' : 'inactive' 
              }).eq('id', employee.id);
              
              wasInCenter = inCenter;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            await updateEmployeeMap(myCenter, position.coords);
          },
          (err) => {
            if (detailsSpan) {
              detailsSpan.innerHTML = `<span style="color:#d32f2f;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${err.message}</span>`;
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ timeout
            if (err.code === 3) { // timeout
              setTimeout(() => {
                if (trackingStarted) {
                  if (locationWatchId) {
                    navigator.geolocation.clearWatch(locationWatchId);
                  }
                  locationWatchId = navigator.geolocation.watchPosition(
                    arguments.callee,
                    arguments.callee,
                    {
                      enableHighAccuracy: true,
                      maximumAge: 5000,
                      timeout: 60000
                    }
                  );
                }
              }, 2000);
            }
          },
          {
            enableHighAccuracy: true,
            maximumAge: 5000,
            timeout: 60000
          }
        );
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„
        navigator.geolocation.getCurrentPosition((position) => {
          if (position && position.coords) {
            updateEmployeeMap(myCenter, position.coords);
          }
        });
        
      } catch (err) {
        const detailsSpan = document.getElementById('trackingDetails');
        if (detailsSpan) {
          detailsSpan.innerHTML = '<span style="color:#d32f2f;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²</span>';
        }
      }
    }

    // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„Ù…ØªØ±
      const toRad = (val) => val * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Ø£Ø­Ø¯Ø§Ø« Cordova - Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    document.addEventListener('deviceready', function() {
      console.log('Cordova is ready');
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø©
      if (window.StatusBar) {
        StatusBar.styleDefault();
        StatusBar.backgroundColorByHexString('#667eea');
      }
      
      // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
      if (window.Splashscreen) {
        setTimeout(() => {
          Splashscreen.hide();
        }, 2000);
      }
      
      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ø¨ÙƒØ©
      if (window.Connection) {
        function checkConnection() {
          const networkState = navigator.connection.type;
          if (networkState === Connection.NONE) {
            console.log('No internet connection');
          } else {
            console.log('Internet connection available');
            sendOfflineEvents();
          }
        }
        
        document.addEventListener('online', checkConnection);
        document.addEventListener('offline', checkConnection);
        checkConnection();
      }
    });

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØµÙØ­Ø© - Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† user.html Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    window.addEventListener('DOMContentLoaded', () => {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØªØ¨Ø¹
      createTrackingElements();
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
      const employee = loadSession();
      if (employee) {
        currentEmployee = employee;
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('successContainer').classList.remove('hidden');
        showTrackingElements();
        trackingStarted = true;
        runBackgroundOperations(employee);
      } else {
        hideTrackingElements();
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
      document.getElementById('passwordInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          login();
        }
      });
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø´Ø¨ÙƒØ©
      window.addEventListener('online', sendOfflineEvents);
    });

    // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ - Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    document.addEventListener('backbutton', function(e) {
      e.preventDefault();
      if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ')) {
        navigator.app.exitApp();
      }
    });

    // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ù‡ÙˆÙ… - Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯
    document.addEventListener('pause', function() {
      console.log('App paused');
    });

    document.addEventListener('resume', function() {
      console.log('App resumed');
      if (currentEmployee && trackingStarted) {
        runBackgroundOperations(currentEmployee);
      }
    });
  </script>
</body>
</html>
