DROP TABLE IF EXISTS categories;

CREATE TABLE categories (
  id bigint primary key generated always as identity,
  name TEXT NOT NULL,
  name_ar TEXT NOT NULL,
  icon TEXT DEFAULT 'tv',
  color TEXT DEFAULT '#2196F3',
  sort_order INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
) WITH (OIDS=FALSE);

-- تأكد من إنشاء سياسات RLS قبل القراءة أو الكتابة إلى هذا الجدول

-- تفعيل امتداد UUID
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- =========================
-- جدول المستخدمين USERS
-- =========================
CREATE TABLE IF NOT EXISTS public.users (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    phone VARCHAR(20),
    membership_type VARCHAR(20) DEFAULT 'free',
    allowed_channels TEXT[],
    is_premium BOOLEAN DEFAULT false,
    is_active BOOLEAN DEFAULT true,
    is_admin BOOLEAN DEFAULT false,
    profile_image TEXT,
    last_login_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- حذف مستخدمين تجريبيين
DELETE FROM public.users WHERE username IN ('user1', 'premium1', 'ameer');

-- إدخال بيانات المستخدمين
INSERT INTO public.users (username, email, password_hash, membership_type, is_active) 
VALUES ('user1', 'user1@example.com', 'cGFzc3dvcmQ=', 'free', true);

INSERT INTO public.users (username, email, password_hash, membership_type, is_active) 
VALUES ('premium1', 'premium@example.com', 'cGFzc3dvcmQ=', 'premium', true);

INSERT INTO public.users (username, email, password_hash, membership_type, is_admin, is_active, is_premium) 
VALUES ('ameer', 'ameer@tvna.app', 'QW1lZXJfN2Vsd2FzMjAyNQ==', 'vip', true, true, true);

-- =========================
-- جدول القنوات CHANNELS
-- =========================
CREATE TABLE IF NOT EXISTS public.channels (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    name_ar VARCHAR(100),
    description TEXT,
    description_ar TEXT,
    url TEXT NOT NULL,
    image_url TEXT,
    category VARCHAR(100),
    quality VARCHAR(20) DEFAULT 'HD',
    membership_type VARCHAR(20) DEFAULT 'free',
    color VARCHAR(7) DEFAULT '#4ecdc4',
    is_active BOOLEAN DEFAULT true,
    viewers_count INTEGER DEFAULT 0,
    order_index INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =========================
-- جدول التصنيفات CATEGORIES
-- =========================
CREATE TABLE IF NOT EXISTS public.categories (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    name_ar VARCHAR(100) NOT NULL,
    description TEXT,
    description_ar TEXT,
    color VARCHAR(7) DEFAULT '#4ecdc4',
    order_index INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    channel_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- إعادة تعبئة التصنيفات
DELETE FROM public.categories;
INSERT INTO public.categories (name, name_ar, order_index, is_active) VALUES
('Sports', 'رياضية', 1, true),
('News', 'إخبارية', 2, true),
('Entertainment', 'ترفيهية', 3, true),
('Movies', 'أفلام ومسلسلات', 4, true),
('Kids', 'أطفال', 6, true),
('General', 'عام', 10, true);

-- =========================
-- جدول الإعلانات ADVERTISEMENTS
-- =========================
CREATE TABLE IF NOT EXISTS public.advertisements (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    title_ar VARCHAR(255),
    description TEXT,
    description_ar TEXT,
    image_url TEXT,
    link TEXT,
    click_count INTEGER DEFAULT 0,
    position_type VARCHAR(50) DEFAULT 'banner',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =========================
-- جدول الإشعارات NOTIFICATIONS (مُحدّث)
-- =========================
-- حذف الجدول القديم إذا كان موجوداً
DROP TABLE IF EXISTS public.notifications;

-- إنشاء الجدول من الصفر
CREATE TABLE public.notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    title_ar VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    message_ar TEXT NOT NULL,
    type VARCHAR(50) DEFAULT 'info',
    target_users TEXT[] DEFAULT '{}',
    is_active BOOLEAN DEFAULT true,
    send_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =========================
-- جدول المفضلة FAVORITES
-- =========================
CREATE TABLE IF NOT EXISTS public.favorites (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.users(id) ON DELETE CASCADE,
    channel_id UUID REFERENCES public.channels(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE (user_id, channel_id)
);

-- =========================
-- جدول سجل المشاهدة WATCH_HISTORY
-- =========================
CREATE TABLE IF NOT EXISTS public.watch_history (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.users(id) ON DELETE CASCADE,
    channel_id UUID REFERENCES public.channels(id) ON DELETE CASCADE,
    watched_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    duration_seconds INTEGER DEFAULT 0,
    device_info TEXT
);

-- =========================
-- جدول مراقبة القنوات CHANNEL_MONITORING
-- =========================
CREATE TABLE IF NOT EXISTS public.channel_monitoring (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    channel_id UUID REFERENCES public.channels(id) ON DELETE CASCADE,
    status VARCHAR(20) DEFAULT 'unknown',
    response_time INTEGER DEFAULT 0,
    error_count INTEGER DEFAULT 0,
    last_check TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    is_working BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =========================
-- جدول إعدادات التطبيق APP_SETTINGS
-- =========================
CREATE TABLE IF NOT EXISTS public.app_settings (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    setting_key VARCHAR(100) UNIQUE NOT NULL,
    setting_value TEXT,
    setting_type VARCHAR(20) DEFAULT 'string',
    description TEXT,
    description_ar TEXT,
    is_public BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- تحديث الإعدادات
DELETE FROM public.app_settings WHERE setting_key IN ('app_name', 'app_version');
INSERT INTO public.app_settings (setting_key, setting_value, setting_type, description, description_ar, is_public) VALUES
('app_name', 'TvNa', 'string', 'Application Name', 'اسم التطبيق', true),
('app_version', '1.0.0', 'string', 'Application Version', 'إصدار التطبيق', true);

-- =========================
-- تعطيل RLS
-- =========================
ALTER TABLE public.channels DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.categories DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.users DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.advertisements DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.notifications DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.favorites DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.watch_history DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.channel_monitoring DISABLE ROW LEVEL SECURITY;
ALTER TABLE public.app_settings DISABLE ROW LEVEL SECURITY;

-- =========================
-- إنشاء الفهارس
-- =========================
CREATE INDEX IF NOT EXISTS idx_channels_category ON public.channels(category);
CREATE INDEX IF NOT EXISTS idx_channels_membership ON public.channels(membership_type);
CREATE INDEX IF NOT EXISTS idx_users_membership ON public.users(membership_type);

-- حذف الجداول إذا كانت موجودة مسبقاً (اختياري)
drop table if exists reports cascade;
drop table if exists users cascade;

-- إنشاء جدول المستخدمين
create table users (
  id serial primary key,
  username text unique not null,
  password text not null
);

-- إضافة مستخدم افتراضي
insert into users (username, password) values ('admin', '123456');

-- إنشاء جدول التقارير
create table reports (
  id serial primary key,
  agent_name text not null,
  report_type text not null, -- 'basic' أو 'advanced'
  report_data jsonb not null,
  created_at timestamp with time zone default now(),
  created_by text
);
