<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مجموعة رسول الرحمة</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Configuration & Utilities -->
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #048267 0%, #14b8a6 100%);
            min-height: 100vh;
            font-family: 'Cairo', 'Segoe UI', sans-serif;
            padding: 0;
            position: relative;
            overflow-x: hidden;
            line-height: 1.5;
        }

        
        body::before {
            content: '';
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background: radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            border-left: 4px solid #0f766e;
            box-shadow: 3px 0 20px rgba(0, 0, 0, 0.08);
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 2px solid #e5e7eb;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            text-align: center;
        }

        .sidebar-header h2 {
            font-size: 1.3rem;
            font-weight: 900;
            margin: 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header p {
            font-size: 0.85rem;
            margin-top: 5px;
            opacity: 0.95;
        }

        .sidebar-nav {
            flex: 1;
            padding: 15px 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            cursor: pointer;
            color: #2d3748;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            background: #f8f9fa;
            border: 2px solid transparent;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            right: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #0f766e 0%, #14b8a6 100%);
            transform: translateX(100%);
            border-radius: 0 12px 12px 0;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            border-color: #14b8a6;
            color: #0f766e;
            transform: translateX(-5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.15) 0%, rgba(20, 184, 166, 0.1) 100%);
            border-color: #0f766e;
            color: #0f766e;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.2);
        }

        .nav-item.active::before {
            transform: translateX(0);
        }

        .nav-icon {
            font-size: 1.2rem;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(20, 184, 166, 0.05) 100%);
            border-radius: 8px;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
        }

        .nav-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .sidebar-footer {
            padding: 15px 20px;
            border-top: 2px solid #e5e7eb;
            background: #f8f9fa;
        }

        .user-info-sidebar {
            color: #0f766e;
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .date-info-sidebar {
            color: #2d3748;
            font-size: 0.75rem;
            text-align: center;
            font-weight: 600;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .main-container {
            margin-right: 280px;
            background: white;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .header-section {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            top: -50%;
            right: -50%;
        }

        .header-section h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: relative;
            letter-spacing: 0.5px;
        }
        
        .header-section h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: 700;
            opacity: 0.98;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
            z-index: 1;
            letter-spacing: 0.4px;
        }

        .header-section p {
            font-size: 1rem;
            opacity: 0.98;
            position: relative;
            z-index: 1;
            font-weight: 500;
            letter-spacing: 0.3px;
        }


        .content-section {
            padding: 30px 25px;
        }

        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.12);
            margin-bottom: 20px;
            overflow: hidden;
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9ff 100%);
            border-top: 3px solid transparent;
            position: relative;
        }

        .card-custom::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #0f766e, #14b8a6);
        }

        .card-header-custom {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 0.3px;
        }

        .form-label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #d1d5db;
            padding: 10px 14px;
            font-size: 0.9rem;
            font-weight: 500;
            background-color: #ffffff;
        }

        .form-select {
            border-radius: 10px;
            border: 2px solid #d1d5db;
            padding: 10px 14px;
            padding-left: 40px;
            padding-right: 14px;
            font-size: 0.9rem;
            font-weight: 500;
            background-color: #ffffff;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            background-size: 16px 12px;
        }

        .form-control:focus, .form-select:focus {
            border-color: #0f766e;
            box-shadow: 0 0 0 0.3rem rgba(15, 118, 110, 0.2);
            background-color: #ffffff;
        }

        .form-control:hover, .form-select:hover {
            border-color: #9ca3af;
        }

        .card-body {
            padding: 20px;
        }

        .card-body .row {
            margin-bottom: 8px;
        }

        .text-muted {
            font-size: 0.75rem;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .col-md-3.mb-3 {
            margin-bottom: 0.8rem !important;
        }

        .col-md-2.mb-3 {
            margin-bottom: 0.8rem !important;
        }

        
        #addStudentForm .form-control,
        #addStudentForm .form-select {
            border: 3px solid #cbd5e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        #addStudentForm .form-control:focus,
        #addStudentForm .form-select:focus {
            border-color: #0f766e;
            box-shadow: 0 0 0 0.3rem rgba(15, 118, 110, 0.25), 0 4px 20px rgba(15, 118, 110, 0.15);
        }

        #editStudentForm .form-control,
        #editStudentForm .form-select {
            border: 3px solid #cbd5e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        #editStudentForm .form-control:focus,
        #editStudentForm .form-select:focus {
            border-color: #f59e0b;
            box-shadow: 0 0 0 0.3rem rgba(245, 158, 11, 0.25), 0 4px 20px rgba(245, 158, 11, 0.15);
        }

        .btn-custom {
            border-radius: 10px;
            padding: 10px 25px;
            font-weight: 700;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
            font-size: 0.95rem;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.25);
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            border: none;
            color: white;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary-custom:hover {
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .btn-success-custom {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            border: none;
            color: white;
            box-shadow: 0 5px 20px rgba(86, 171, 47, 0.3);
        }

        .btn-success-custom:hover {
            box-shadow: 0 10px 30px rgba(86, 171, 47, 0.5);
        }

        .btn-info-custom {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: none;
            color: white;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-info-custom:hover {
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.5);
        }

        .btn-danger-custom {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            border: none;
            color: white;
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-danger-custom:hover {
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.5);
        }

        .table-responsive {
            border-radius: 15px;
            overflow: hidden;
        }

        .table {
            margin-bottom: 0;
        }

        .table {
            font-size: 0.8rem;
        }

        .table thead {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
        }

        .table thead th {
            padding: 10px 8px;
            font-size: 0.8rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .table tbody tr {
            border-bottom: 1px solid #e2e8f0;
        }

        .table tbody td {
            padding: 5px 8px;
            font-size: 0.75rem;
            vertical-align: middle;
            line-height: 1.3;
        }

        .table tbody tr:hover {
            background: linear-gradient(to right, #f8f9ff 0%, #ffffff 100%);
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid #0f766e;
        }

        .table tbody td strong {
            font-weight: 700;
            color: #2d3748;
        }

        .table td.no-print {
            white-space: nowrap;
        }

        .table td.no-print .btn {
            padding: 5px 10px;
            font-size: 0.7rem;
            margin: 0 2px;
            border-radius: 6px;
            font-weight: 600;
        }

        .table td.no-print .btn i {
            font-size: 0.75rem;
            margin: 0;
        }

        
        .nav-tabs {
            border-bottom: 3px solid #0f766e;
        }

        .nav-tabs .nav-link {
            color: #0f766e;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 20px;
            font-weight: 600;
        }
        
        
        .nav-tabs .nav-link[data-school="rawda"] {
            color: #8B4513;
        }
        .nav-tabs .nav-link[data-school="rawda"].active {
            border-bottom-color: #8B4513;
            color: #8B4513;
        }
        
        .nav-tabs .nav-link[data-school="rasoul"] {
            color: #0f766e;
        }
        .nav-tabs .nav-link[data-school="rasoul"].active {
            border-bottom-color: #0f766e;
            color: #0f766e;
        }
        
        .nav-tabs .nav-link[data-school="noor"] {
            color: #f59e0b;
        }
        .nav-tabs .nav-link[data-school="noor"].active {
            border-bottom-color: #f59e0b;
            color: #f59e0b;
        }
        
        .nav-tabs .nav-link[data-school="nabi"] {
            color: #3498db;
        }
        .nav-tabs .nav-link[data-school="nabi"].active {
            border-bottom-color: #3498db;
            color: #3498db;
        }
        
        .nav-tabs .nav-link[data-school="thanawiya"] {
            color: #e74c3c;
        }
        .nav-tabs .nav-link[data-school="thanawiya"].active {
            border-bottom-color: #e74c3c;
            color: #e74c3c;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            border-bottom-color: #14b8a6;
            color: #14b8a6;
        }
        
        .nav-tabs .nav-link[data-school="rawda"]:hover:not(.active) {
            border-bottom-color: #8B4513;
            color: #8B4513;
        }
        
        .nav-tabs .nav-link[data-school="noor"]:hover:not(.active) {
            border-bottom-color: #f59e0b;
            color: #f59e0b;
        }
        
        .nav-tabs .nav-link[data-school="nabi"]:hover:not(.active) {
            border-bottom-color: #3498db;
            color: #3498db;
        }
        
        .nav-tabs .nav-link[data-school="thanawiya"]:hover:not(.active) {
            border-bottom-color: #e74c3c;
            color: #e74c3c;
        }

        .nav-tabs .nav-link.active {
            color: #0f766e;
            background-color: transparent;
            border-bottom: 3px solid #0f766e;
            font-weight: 700;
        }

        .filter-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .main-tab-content {
            display: none;
        }

        .main-tab-content.active {
            display: block;
        }

        
        .stats-card-advanced {
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stats-card-advanced::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            transition: transform 0.5s ease;
        }

        .stats-card-advanced:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .stats-card-advanced:hover::before {
            transform: rotate(45deg);
        }

        .stats-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stats-value {
            font-size: 2.2rem;
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .stats-label {
            font-size: 0.9rem;
            opacity: 0.95;
            font-weight: 600;
        }

        .badge-custom {
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.75rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            letter-spacing: 0;
        }

        .badge-custom:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
        }

        .stats-box {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 15px 18px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .stats-box::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        }

        .stats-box:hover {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }

        .stats-box h3 {
            font-size: 1rem;
            margin-bottom: 8px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .stats-box p {
            font-size: 1.5rem;
            font-weight: 900;
            margin: 0;
            position: relative;
            z-index: 1;
            text-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        }

        .installment-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 700;
            margin: 2px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
            letter-spacing: 0;
            line-height: 1.3;
        }
        
        .installment-badge small {
            display: block;
            font-size: 0.55rem;
            font-weight: 600;
            margin-top: 2px;
            opacity: 0.95;
        }

        .installment-badge:hover {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .installment-paid {
            background: #10b981;
            color: white;
        }

        .installment-unpaid {
            background: #ef4444;
            color: white;
        }

        .installment-partial {
            background: #f59e0b;
            color: white;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }

            .main-container {
                box-shadow: none;
            }

            .no-print {
                display: none !important;
            }

            .print-section {
                page-break-after: always;
            }
        }

        .payment-modal .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .payment-modal .modal-header {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            border-radius: 0;
            padding: 25px;
            border-bottom: 3px solid rgba(255, 255, 255, 0.3);
        }

        .installments-section {
            margin-top: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 15px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .installment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .installment-item:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .installment-item.paid {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .installment-item.partial {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .installment-item.unpaid {
            border-color: #ef4444;
            background: #fef2f2;
        }

        
        .notification-bell {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .notification-bell:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        
        .chat-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .chat-button:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .chat-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        
        .notification-panel {
            position: fixed;
            top: 90px;
            left: 20px;
            width: 350px;
            max-height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9998;
            display: none;
            overflow: hidden;
            border: 2px solid #0f766e;
        }
        .notification-panel.show {
            display: block;
        }
        .notification-header {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notification-list {
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
        }
        .notification-item {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-right: 4px solid;
            cursor: pointer;
        }
        .notification-item.unread {
            background: #f0fdf4;
            border-right-color: #10b981;
        }
        .notification-item.read {
            background: #f9fafb;
            border-right-color: #cbd5e0;
        }

        
        .chat-panel {
            position: fixed;
            bottom: 90px;
            left: 20px;
            width: 400px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9998;
            display: none;
            flex-direction: column;
            border: 2px solid #0f766e;
        }
        .chat-panel.show {
            display: flex;
        }
        .chat-header {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 13px 13px 0 0;
        }
        .chat-status {
            font-size: 11px;
            opacity: 0.9;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f9fafb;
        }
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        .chat-message.sent {
            align-items: flex-end;
        }
        .chat-message.received {
            align-items: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            margin-bottom: 5px;
        }
        .message-bubble.sent {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            color: white;
        }
        .message-bubble.received {
            background: #e5e7eb;
            color: #1f2937;
        }
        .message-sender {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 3px;
        }
        .message-time {
            font-size: 10px;
            color: #9ca3af;
        }
        .chat-input-container {
            padding: 15px;
            border-top: 2px solid #e5e7eb;
            display: flex;
            gap: 10px;
            align-items: center;
            background: white;
            border-radius: 0 0 13px 13px;
        }
        .chat-input-container select {
            width: 150px;
        }
        .chat-input-container input {
            flex: 1;
        }
        
        /* إظهار modal تسجيل الدخول تلقائياً */
        #loginModal.show {
            display: block !important;
        }
        
        #loginModal {
            z-index: 1055;
        }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            min-width: 300px;
            max-width: 400px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideInRight 0.3s ease-out;
            border-right: 4px solid;
        }
        
        .toast.success {
            border-right-color: #10b981;
        }
        
        .toast.error {
            border-right-color: #ef4444;
        }
        
        .toast.warning {
            border-right-color: #f59e0b;
        }
        
        .toast.info {
            border-right-color: #3498db;
        }
        
        .toast-icon {
            font-size: 1.5rem;
        }
        
        .toast.success .toast-icon {
            color: #10b981;
        }
        
        .toast.error .toast-icon {
            color: #ef4444;
        }
        
        .toast.warning .toast-icon {
            color: #f59e0b;
        }
        
        .toast.info .toast-icon {
            color: #3498db;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 3px;
            color: #1f2937;
        }
        
        .toast-message {
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-close:hover {
            color: #374151;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: #0f766e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Advanced Search */
        .advanced-search {
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
            display: none;
        }
        
        .advanced-search.show {
            display: block;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .quick-action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #0f766e;
            background: white;
            color: #0f766e;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85rem;
        }
        
        .quick-action-btn:hover {
            background: #0f766e;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
        }
        
        /* Keyboard Shortcuts Hint */
        .keyboard-shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 9999;
            max-width: 300px;
        }
        
        .keyboard-shortcuts.show {
            display: block;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .shortcut-item:last-child {
            border-bottom: none;
        }
        
        .shortcut-key {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            color: #374151;
        }
        
        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: none;
            z-index: 9999;
            animation: fadeInOut 2s;
        }
        
        .auto-save-indicator.show {
            display: block;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; }
            10%, 90% { opacity: 1; }
        }
        
        /* Improved table with hover effects */
        .table tbody tr {
            transition: all 0.2s ease;
        }
        
        .table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Smooth transitions */
        * {
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }
        
        /* Print improvements */
        @media print {
            .stats-box {
                page-break-inside: avoid;
            }
            
            .table tbody tr {
                page-break-inside: avoid;
            }
        }
        
    </style>
</head>
<body>
    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>
    
    <!-- Auto-save Indicator -->
    <div class="auto-save-indicator" id="autoSaveIndicator">
        <i class="bi bi-check-circle"></i> تم الحفظ تلقائياً
    </div>
    
    <!-- Keyboard Shortcuts -->
    <div class="keyboard-shortcuts" id="keyboardShortcuts">
        <h6 style="margin-bottom: 10px; font-weight: 700; color: #0f766e;">
            <i class="bi bi-keyboard"></i> اختصارات لوحة المفاتيح
        </h6>
        <div class="shortcut-item">
            <span>إضافة طالب جديد</span>
            <span class="shortcut-key">Ctrl + N</span>
        </div>
        <div class="shortcut-item">
            <span>البحث</span>
            <span class="shortcut-key">Ctrl + F</span>
        </div>
        <div class="shortcut-item">
            <span>طباعة</span>
            <span class="shortcut-key">Ctrl + P</span>
        </div>
        <div class="shortcut-item">
            <span>تصدير Excel</span>
            <span class="shortcut-key">Ctrl + E</span>
        </div>
        <div class="shortcut-item">
            <span>إزالة الفلاتر</span>
            <span class="shortcut-key">Ctrl + R</span>
        </div>
        <div class="shortcut-item">
            <span>إظهار/إخفاء الاختصارات</span>
            <span class="shortcut-key">?</span>
        </div>
    </div>
    
    <button id="notificationBtn" class="notification-bell" style="display: none;">
        <i class="bi bi-bell"></i>
        <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
    </button>

    
    <button id="chatBtn" class="chat-button" style="display: none;">
        <i class="bi bi-chat-dots"></i>
        <span id="chatBadge" class="chat-badge" style="display: none;">0</span>
    </button>

    
    <div id="notificationPanel" class="notification-panel">
        <div class="notification-header">
            <h6>الإشعارات</h6>
            <button class="close-notifications" onclick="closeNotifications()"><i class="bi bi-x"></i></button>
        </div>
        <div id="notificationList" class="notification-list"></div>
    </div>

    
    <div id="chatPanel" class="chat-panel">
        <div class="chat-header">
            <div>
                <h6>المحادثات</h6>
                <small id="chatStatus" class="chat-status">متصل</small>
            </div>
            <button class="close-chat" onclick="closeChat()"><i class="bi bi-x"></i></button>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-container">
            <select id="chatReceiver" class="form-select form-select-sm"></select>
            <input type="text" id="chatInput" class="form-control" placeholder="اكتب رسالتك...">
            <button onclick="sendMessage()" class="btn btn-primary btn-sm">
                <i class="bi bi-send"></i>
            </button>
        </div>
    </div>

    
    <div class="modal-backdrop fade show" id="loginModalBackdrop" style="display: none;"></div>
    
    <div class="modal fade show" id="loginModal" tabindex="-1" data-bs-backdrop="static" style="display: none;" aria-modal="true" role="dialog">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header" style="background: linear-gradient(135deg, #6b7d3d 0%, #8b945c 100%); border-radius: 15px 15px 0 0; color: white; border: none; padding: 15px 20px;">
                    <h5 class="modal-title" style="width: 100%; text-align: center; font-size: 1.2rem; margin: 0;">
                        <i class="bi bi-person-circle"></i> تسجيل الدخول
                    </h5>
                </div>
                <div class="modal-body" style="padding: 20px;">
                    <div class="mb-3">
                        <label class="form-label">اسم المستخدم</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="أدخل اسم المستخدم">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">كلمة المرور</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="أدخل كلمة المرور">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">اختر المدرسة</label>
                        <select id="loginSchool" class="form-select">
                            <option value="">-- اختر المدرسة --</option>
                            <option value="admin">رئيس مجلس الإدارة ( جميع المدارس )</option>
                            <option value="rawda">روضة رسول الرحمة</option>
                            <option value="rasoul">مدرسة رسول الرحمة</option>
                            <option value="noor">مدرسة نور الرحمة</option>
                            <option value="nabi">مدرسة نبي الرحمة</option>
                            <option value="thanawiya">ثانوية رسول الرحمة</option>
                        </select>
                    </div>
                    <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                    <button onclick="authenticateUser()" class="btn btn-primary-custom btn-custom w-100">
                        <i class="bi bi-box-arrow-in-right"></i> دخول
                    </button>
                    
                    <div class="mt-3 p-2" style="background: #f8f9fa; border-radius: 8px; font-size: 0.8rem;">
                        <small class="text-muted" style="display: block; font-size: 0.75rem;">
                            <i class="bi bi-info-circle"></i> للدخول، يرجى استخدام بيانات الدخول المخصصة لك من إدارة النظام
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <div class="sidebar" id="sidebar" style="display: none;">
        <div class="sidebar-header">
            <h2><i class="bi bi-mortarboard"></i> مجموعة رسول الرحمة</h2>
            <p id="sidebarSchoolName">إدارة الأقساط المدرسية</p>
        </div>
        <div class="sidebar-nav">
            <div class="nav-item active" onclick="switchMainTab('students')">
                <span class="nav-icon"><i class="bi bi-people"></i></span>
                <span class="nav-text">قائمة الطلاب</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('attendance')">
                <span class="nav-icon"><i class="bi bi-calendar-check"></i></span>
                <span class="nav-text">الحضور والغياب</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('grades')">
                <span class="nav-icon"><i class="bi bi-journal-text"></i></span>
                <span class="nav-text">النتائج الدراسية</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('teachers')">
                <span class="nav-icon"><i class="bi bi-person-badge"></i></span>
                <span class="nav-text">إدارة الأساتذة</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('subjects')">
                <span class="nav-icon"><i class="bi bi-book"></i></span>
                <span class="nav-text">المواد الدراسية</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('lessons')">
                <span class="nav-icon"><i class="bi bi-calendar-week"></i></span>
                <span class="nav-text">جدول الدروس</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('schools')" id="schoolsTabNav" style="display: none;">
                <span class="nav-icon"><i class="bi bi-building"></i></span>
                <span class="nav-text">جميع المدارس</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('reports')">
                <span class="nav-icon"><i class="bi bi-graph-up"></i></span>
                <span class="nav-text">التقارير والإحصائيات</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('users')" id="usersTabNav" style="display: none;">
                <span class="nav-icon"><i class="bi bi-shield-lock"></i></span>
                <span class="nav-text">إدارة المستخدمين</span>
            </div>
            <div class="nav-item" onclick="switchMainTab('settings')">
                <span class="nav-icon"><i class="bi bi-gear"></i></span>
                <span class="nav-text">الإعدادات</span>
            </div>
        </div>
        <div class="sidebar-footer">
            <div class="user-info-sidebar" id="sidebarUserInfo">مرحباً</div>
            <div class="date-info-sidebar" id="sidebarDateTime"></div>
        </div>
    </div>

    <div class="main-container" id="mainContent" style="display: none;">
        <div class="header-section" style="position: relative;">
            <button onclick="logout()" class="btn btn-light no-print" style="position: absolute; left: 20px; top: 20px; border: none; border-radius: 10px; padding: 10px 20px; font-weight: bold;">
                <i class="bi bi-box-arrow-right"></i> تسجيل خروج
            </button>
            <h1><i class="bi bi-mortarboard"></i> مجموعة رسول الرحمة التعليمية</h1>
            <h3 id="schoolName">مدرسة رسول الرحمة</h3>
            <p>إدارة الأقساط المدرسية</p>
        </div>

        <div class="content-section">
            
            <div id="studentsTab" class="main-tab-content active">
            
            <div id="schoolTabsContainer" class="mb-4" style="display: none;">
                <ul class="nav nav-tabs" id="schoolTabs" role="tablist" style="border-bottom: 3px solid #0f766e;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-schools-tab" data-bs-toggle="tab" data-bs-target="#all-schools" type="button" role="tab" onclick="filterBySchool('all')">
                            <i class="bi bi-building"></i> جميع المدارس
                        </button>
                    </li>
                </ul>
            </div>

            
            <div class="card-custom no-print mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-funnel"></i> فلتر حسب الصف:</label>
                            <select class="form-select" id="gradeFilter" onchange="filterByGrade()">
                                <option value="all">جميع الصفوف</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label"><i class="bi bi-funnel-fill"></i> فلتر حسب الحالة:</label>
                            <select class="form-select" id="statusFilter" onchange="filterByStatus()">
                                <option value="all">جميع الحالات</option>
                                <option value="paid">مسدد</option>
                                <option value="partial">جزئي</option>
                                <option value="unpaid">غير مسدد</option>
                            </select>
                        </div>
                        <div class="col-md-6 text-end">
                            <button onclick="clearFilters()" class="btn btn-secondary btn-sm">
                                <i class="bi bi-x-circle"></i> إزالة الفلاتر
                            </button>
                            <span id="filterInfo" class="badge bg-info ms-2" style="display: none;"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="stats-box">
                        <h3><i class="bi bi-people"></i> عدد الطلاب</h3>
                        <p id="totalStudents">0</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-box" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);">
                        <h3><i class="bi bi-cash-stack"></i> إجمالي المطلوب</h3>
                        <p id="totalFees">0 د.ع</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-box" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        <h3><i class="bi bi-check-circle"></i> إجمالي المدفوع</h3>
                        <p id="totalPaid">0 د.ع</p>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="stats-box" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);">
                        <h3><i class="bi bi-clock"></i> المتبقي</h3>
                        <p id="totalRemaining">0 د.ع</p>
                    </div>
                </div>
            </div>

            
            <div class="card-custom no-print">
                <div class="card-header-custom">
                    <i class="bi bi-plus-circle"></i> إضافة طالب جديد
                </div>
                <div class="card-body">
                    <form id="addStudentForm">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">اسم الطالب <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="studentName" required>
                                <small class="text-muted">الاسم الكامل للطالب</small>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">اسم ولي الأمر <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="guardianName" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">اسم الأم <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="motherName" required>
                                <small class="text-muted">للتحقق من الاخوة</small>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">الصف <span class="text-danger">*</span></label>
                                <select class="form-select" id="grade" required>
                                    <option value="">-- اختر الصف --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row" id="adminSchoolRow" style="display: none;">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">المدرسة <span class="text-danger">*</span></label>
                                <select class="form-select" id="adminSchoolSelect">
                                    <option value="rawda">روضة رسول الرحمة</option>
                                    <option value="rasoul">مدرسة رسول الرحمة</option>
                                    <option value="noor">مدرسة نور الرحمة</option>
                                    <option value="nabi">مدرسة نبي الرحمة</option>
                                    <option value="thanawiya">ثانوية رسول الرحمة</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label class="form-label">المبلغ السنوي</label>
                                <input type="number" class="form-control" id="annualFee" value="1200000" min="0" required>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">إخوة (خصم 5%)</label>
                                <select class="form-select" id="hasSibling" onchange="checkSiblingDiscount()">
                                    <option value="no">لا</option>
                                    <option value="yes">نعم</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">رقم الهاتف <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="phone" required>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">تاريخ التسجيل</label>
                                <input type="date" class="form-control" id="registrationDate" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ملاحظات</label>
                                <input type="text" class="form-control" id="notes">
                            </div>
                        </div>
                        <div id="siblingAlert" class="alert alert-warning mt-3" style="display: none;">
                            <i class="bi bi-exclamation-triangle"></i> <strong>تنبيه:</strong> تم العثور على إخوة من عدة مدارس:<br><br>
                            <div id="siblingNames" style="margin-right: 30px;"></div>
                        </div>
                        <button type="submit" class="btn btn-primary-custom btn-custom">
                            <i class="bi bi-plus-circle"></i> إضافة طالب
                        </button>
                    </form>
                </div>
            </div>

            
            <div class="card-custom no-print">
                <div class="card-header-custom">
                    <i class="bi bi-search"></i> البحث
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-10">
                            <input type="text" class="form-control" id="searchInput" placeholder="ابحث باسم الطالب، ولي الأمر، رقم الوصل، أو رقم الهاتف..." onkeyup="filterStudents()">
                        </div>
                        <div class="col-md-2">
                            <button onclick="toggleAdvancedSearch()" class="btn btn-outline-primary w-100">
                                <i class="bi bi-funnel"></i> بحث متقدم
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Search -->
                    <div class="advanced-search" id="advancedSearch">
                        <h6 class="mb-3"><i class="bi bi-funnel-fill"></i> البحث المتقدم</h6>
                    <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">اسم الطالب</label>
                                <input type="text" class="form-control" id="advancedSearchName" onkeyup="applyAdvancedSearch()">
                        </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">ولي الأمر</label>
                                <input type="text" class="form-control" id="advancedSearchGuardian" onkeyup="applyAdvancedSearch()">
                    </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="text" class="form-control" id="advancedSearchPhone" onkeyup="applyAdvancedSearch()">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">رقم الوصل</label>
                                <input type="text" class="form-control" id="advancedSearchReceipt" onkeyup="applyAdvancedSearch()">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 text-end">
                                <button onclick="clearAdvancedSearch()" class="btn btn-secondary btn-sm">
                                    <i class="bi bi-x-circle"></i> مسح البحث
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions no-print">
                <button class="quick-action-btn" onclick="scrollToAddForm()">
                    <i class="bi bi-plus-circle"></i> إضافة طالب
                </button>
                <button class="quick-action-btn" onclick="showUnpaidStudents()">
                    <i class="bi bi-exclamation-triangle"></i> غير مسددين
                </button>
                <button class="quick-action-btn" onclick="showPartialStudents()">
                    <i class="bi bi-clock-history"></i> جزئي الدفع
                </button>
                <button class="quick-action-btn" onclick="showPaidStudents()">
                    <i class="bi bi-check-circle"></i> مسددين
                </button>
                <button class="quick-action-btn" onclick="exportToExcel()">
                    <i class="bi bi-file-excel"></i> تصدير Excel
                </button>
                <button class="quick-action-btn" onclick="printList()">
                    <i class="bi bi-printer"></i> طباعة
                </button>
                <button class="quick-action-btn" onclick="backupData()">
                    <i class="bi bi-cloud-upload"></i> نسخ احتياطي
                </button>
            </div>

            
            <div class="card-custom">
                <div class="card-header-custom">
                    <i class="bi bi-list-ul"></i> قائمة الطلاب
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>م</th>
                                    <th>رقم الوصل</th>
                                    <th>اسم الطالب</th>
                                    <th id="schoolNameHeader" style="display: none;">المدرسة</th>
                                    <th>ولي الأمر</th>
                                    <th>الصف</th>
                                    <th>المبلغ السنوي</th>
                                    <th>الدُفعات</th>
                                    <th>المتبقي</th>
                                    <th>الخصم</th>
                                    <th>الحالة</th>
                                    <th class="no-print">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTable">
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            
            <div class="text-center no-print mt-4">
                <button onclick="printList()" class="btn btn-info-custom btn-custom me-2">
                    <i class="bi bi-printer"></i> طباعة القائمة
                </button>
                <button onclick="exportData()" class="btn btn-success-custom btn-custom me-2">
                    <i class="bi bi-download"></i> تصدير البيانات
                </button>
                <button onclick="sendBulkWhatsAppReminders()" class="btn btn-custom me-2" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;" title="إرسال تذكيرات واتساب لجميع الطلاب المتأخرين">
                    📱 إرسال تذكيرات جماعية
                </button>
            </div>
            </div>
            
            <!-- تبويب الحضور والغياب -->
            <div id="attendanceTab" class="main-tab-content" style="display: none;">
                <div class="card-custom mb-3">
                    <div class="card-header-custom">
                        <i class="bi bi-calendar-check"></i> إدارة الحضور والغياب
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">اختر التاريخ:</label>
                                <input type="date" class="form-control" id="attendanceDate" value="">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">اختر الصف:</label>
                                <select class="form-select" id="attendanceGrade">
                                    <option value="all">جميع الصفوف</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">حالة الحضور:</label>
                                <select class="form-select" id="attendanceStatus">
                                    <option value="all">الكل</option>
                                    <option value="present">حاضر</option>
                                    <option value="absent">غائب</option>
                                    <option value="late">متأخر</option>
                                    <option value="excused">معذور</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button onclick="loadAttendanceData()" class="btn btn-primary-custom w-100">
                                    <i class="bi bi-search"></i> بحث
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>اسم الطالب</th>
                                        <th>الصف</th>
                                        <th>الحالة</th>
                                        <th>وقت الحضور</th>
                                        <th>ملاحظات</th>
                                        <th class="no-print">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">اختر التاريخ والصف لعرض بيانات الحضور</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-center no-print mt-3">
                            <button onclick="markAllPresent()" class="btn btn-success-custom me-2">
                                <i class="bi bi-check-circle"></i> تسجيل الجميع حاضر
                            </button>
                            <button onclick="exportAttendanceReport()" class="btn btn-info-custom me-2">
                                <i class="bi bi-download"></i> تصدير تقرير الحضور
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- تبويب النتائج الدراسية -->
            <div id="gradesTab" class="main-tab-content" style="display: none;">
                <div class="card-custom mb-3">
                    <div class="card-header-custom">
                        <i class="bi bi-journal-text"></i> إدارة النتائج الدراسية
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label">اختر الصف:</label>
                                <select class="form-select" id="gradesGradeFilter">
                                    <option value="all">جميع الصفوف</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">الفصل الدراسي:</label>
                                <select class="form-select" id="gradesSemester">
                                    <option value="first">الفصل الأول</option>
                                    <option value="second">الفصل الثاني</option>
                                    <option value="final">النهائي</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">المادة الدراسية:</label>
                                <select class="form-select" id="gradesSubject">
                                    <option value="all">جميع المواد</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button onclick="loadGradesData()" class="btn btn-primary-custom w-100">
                                    <i class="bi bi-search"></i> بحث
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>اسم الطالب</th>
                                        <th>الصف</th>
                                        <th>المادة</th>
                                        <th>الدرجة</th>
                                        <th>المعدل</th>
                                        <th>التقدير</th>
                                        <th class="no-print">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="gradesTable">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">اختر الصف والمادة لعرض النتائج</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-center no-print mt-3">
                            <button onclick="addGrade()" class="btn btn-success-custom me-2">
                                <i class="bi bi-plus-circle"></i> إضافة درجة
                            </button>
                            <button onclick="exportGradesReport()" class="btn btn-info-custom me-2">
                                <i class="bi bi-download"></i> تصدير النتائج
                            </button>
                            <button onclick="printGradesReport()" class="btn btn-primary-custom">
                                <i class="bi bi-printer"></i> طباعة النتائج
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- تبويب إدارة الأساتذة -->
            <div id="teachersTab" class="main-tab-content" style="display: none;">
                <div class="card-custom mb-3">
                    <div class="card-header-custom">
                        <i class="bi bi-person-badge"></i> إدارة الأساتذة
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="teacherSearch" placeholder="ابحث عن أستاذ...">
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="teacherSubjectFilter">
                                    <option value="all">جميع المواد</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button onclick="addTeacher()" class="btn btn-success-custom w-100">
                                    <i class="bi bi-plus-circle"></i> إضافة أستاذ جديد
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>اسم الأستاذ</th>
                                        <th>المادة</th>
                                        <th>الصفوف</th>
                                        <th>رقم الهاتف</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>الحالة</th>
                                        <th class="no-print">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="teachersTable">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">لا يوجد أساتذة مسجلين</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- تبويب المواد الدراسية -->
            <div id="subjectsTab" class="main-tab-content" style="display: none;">
                <div class="card-custom mb-3">
                    <div class="card-header-custom">
                        <i class="bi bi-book"></i> إدارة المواد الدراسية
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="subjectSearch" placeholder="ابحث عن مادة...">
                            </div>
                            <div class="col-md-6">
                                <button onclick="addSubject()" class="btn btn-success-custom w-100">
                                    <i class="bi bi-plus-circle"></i> إضافة مادة جديدة
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>اسم المادة</th>
                                        <th>الصف</th>
                                        <th>عدد الحصص</th>
                                        <th>الأستاذ</th>
                                        <th>الحالة</th>
                                        <th class="no-print">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="subjectsTable">
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">لا توجد مواد مسجلة</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- تبويب جدول الدروس -->
            <div id="lessonsTab" class="main-tab-content" style="display: none;">
                <div class="card-custom mb-3">
                    <div class="card-header-custom">
                        <i class="bi bi-calendar-week"></i> جدول الدروس الأسبوعي
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-funnel"></i> فلتر حسب الصف:</label>
                                <select class="form-select" id="lessonGradeFilter" onchange="filterLessonsByGrade()">
                                    <option value="all">جميع الصفوف</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-person-badge"></i> فلتر حسب الأستاذ:</label>
                                <select class="form-select" id="lessonTeacherFilter" onchange="filterLessonsByTeacher()">
                                    <option value="all">جميع الأساتذة</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label"><i class="bi bi-book"></i> فلتر حسب المادة:</label>
                                <select class="form-select" id="lessonSubjectFilter" onchange="filterLessonsBySubject()">
                                    <option value="all">جميع المواد</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button onclick="openAddLessonModal()" class="btn btn-success-custom w-100">
                                    <i class="bi bi-plus-circle"></i> إضافة درس جديد
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>اليوم</th>
                                        <th>الحصة</th>
                                        <th>الصف</th>
                                        <th>المادة</th>
                                        <th>الأستاذ</th>
                                        <th>القاعة</th>
                                        <th>الحالة</th>
                                        <th class="no-print">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="lessonsTable">
                                    <tr>
                                        <td colspan="9" class="text-center text-muted">لا توجد دروس مسجلة</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card-custom">
                                    <div class="card-header-custom">
                                        <i class="bi bi-calendar3"></i> عرض الجدول الأسبوعي
                                    </div>
                                    <div class="card-body">
                                        <div id="weeklyScheduleContainer"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- تبويب التقارير والإحصائيات -->
            <div id="reportsTab" class="main-tab-content" style="display: none;">
                <div class="card-custom mb-3">
                    <div class="card-header-custom">
                        <i class="bi bi-graph-up"></i> التقارير والإحصائيات المتقدمة
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="stats-icon"><i class="bi bi-calendar-check"></i></div>
                                    <div class="stats-value" id="attendanceRate">0%</div>
                                    <div class="stats-label">نسبة الحضور</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <div class="stats-icon"><i class="bi bi-trophy"></i></div>
                                    <div class="stats-value" id="averageGrade">0</div>
                                    <div class="stats-label">المعدل العام</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <div class="stats-icon"><i class="bi bi-person-badge"></i></div>
                                    <div class="stats-value" id="totalTeachers">0</div>
                                    <div class="stats-label">عدد الأساتذة</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <div class="stats-icon"><i class="bi bi-book"></i></div>
                                    <div class="stats-value" id="totalSubjects">0</div>
                                    <div class="stats-label">عدد المواد</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card-custom">
                                    <div class="card-header-custom">
                                        <i class="bi bi-bar-chart"></i> إحصائيات الحضور
                                    </div>
                                    <div class="card-body">
                                        <canvas id="attendanceChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card-custom">
                                    <div class="card-header-custom">
                                        <i class="bi bi-pie-chart"></i> توزيع الدرجات
                                    </div>
                                    <div class="card-body">
                                        <canvas id="gradesDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="schoolsTab" class="main-tab-content" style="display: none;">
                
                <div class="card-custom mb-3">
                    <div class="card-header-custom" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);">
                        <i class="bi bi-speedometer2"></i> لوحة التحكم الرئيسية
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <div class="stats-icon"><i class="bi bi-building"></i></div>
                                    <div class="stats-value" id="totalSchoolsCount">0</div>
                                    <div class="stats-label">عدد المدارس</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                    <div class="stats-icon"><i class="bi bi-people"></i></div>
                                    <div class="stats-value" id="totalStudentsCount">0</div>
                                    <div class="stats-label">إجمالي الطلاب</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                    <div class="stats-icon"><i class="bi bi-cash-stack"></i></div>
                                    <div class="stats-value" id="totalFeesAmount">0</div>
                                    <div class="stats-label">إجمالي المطلوب</div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="stats-card-advanced" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                                    <div class="stats-icon"><i class="bi bi-percent"></i></div>
                                    <div class="stats-value" id="overallPaymentRate">0%</div>
                                    <div class="stats-label">متوسط نسبة الدفع</div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card-custom">
                                    <div class="card-header-custom">
                                        <i class="bi bi-pie-chart"></i> توزيع الطلاب حسب المدارس
                                    </div>
                                    <div class="card-body">
                                        <canvas id="studentsDistributionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card-custom">
                                    <div class="card-header-custom">
                                        <i class="bi bi-bar-chart"></i> نسبة الدفع لكل مدرسة
                                    </div>
                                    <div class="card-body">
                                        <canvas id="paymentRateChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <div class="card-custom">
                    <div class="card-header-custom" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);">
                        <i class="bi bi-building"></i> جميع المدارس - نظرة شاملة
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary" onclick="sortSchoolsBy('students')">
                                        <i class="bi bi-sort-numeric-down"></i> ترتيب حسب عدد الطلاب
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="sortSchoolsBy('payment')">
                                        <i class="bi bi-sort-alpha-down"></i> ترتيب حسب نسبة الدفع
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="sortSchoolsBy('fees')">
                                        <i class="bi bi-sort-amount-down"></i> ترتيب حسب المبلغ المطلوب
                                    </button>
                                    <button type="button" class="btn btn-outline-success" onclick="exportSchoolsReport()">
                                        <i class="bi bi-file-earmark-excel"></i> تصدير تقرير
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="schoolsStatsContainer" class="row mb-4"></div>
                        <div id="schoolsListContainer"></div>
                    </div>
                </div>
            </div>
            

            
            <div id="usersTab" class="main-tab-content" style="display: none;">
                <div class="card-custom">
                    <div class="card-header-custom">
                        <i class="bi bi-shield-lock"></i> إدارة المستخدمين
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button onclick="openAddUserModal()" class="btn btn-primary-custom btn-custom">
                                    <i class="bi bi-person-plus"></i> إضافة مستخدم جديد
                                </button>
                                <button onclick="loadUsers()" class="btn btn-secondary btn-custom">
                                    <i class="bi bi-arrow-clockwise"></i> تحديث القائمة
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>م</th>
                                        <th>اسم المستخدم</th>
                                        <th>كلمة المرور</th>
                                        <th>المدرسة</th>
                                        <th>نوع المستخدم</th>
                                        <th>الحالة</th>
                                        <th>تاريخ الإنشاء</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            

            
            <div id="settingsTab" class="main-tab-content" style="display: none;">
                <div class="card-custom">
                    <div class="card-header-custom">
                        <i class="bi bi-gear"></i> الإعدادات
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3"><i class="bi bi-cash-coin"></i> إعدادات الأقساط حسب المرحلة</h5>
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-heart"></i> المبلغ السنوي للروضة</label>
                                    <input type="number" class="form-control" id="kindergartenFee" value="1000000" step="10000">
                                    <small class="text-muted">المبلغ الافتراضي: 1,000,000 دينار عراقي</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-book"></i> المبلغ السنوي للمرحلة الابتدائية</label>
                                    <input type="number" class="form-control" id="elementaryFee" value="1100000" step="10000">
                                    <small class="text-muted">المبلغ الافتراضي: 1,100,000 دينار عراقي</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-mortarboard"></i> المبلغ السنوي للمرحلة المتوسطة</label>
                                    <input type="number" class="form-control" id="middleFee" value="1300000" step="10000">
                                    <small class="text-muted">المبلغ الافتراضي: 1,300,000 دينار عراقي</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label"><i class="bi bi-calendar-check"></i> عدد الدفعات</label>
                                    <input type="number" class="form-control" id="installmentCount" value="4" min="1" max="12">
                                    <small class="text-muted">عدد الدفعات المقررة خلال السنة الدراسية</small>
                                </div>
                                <button onclick="saveFeeSettings()" class="btn btn-primary-custom btn-custom w-100">
                                    <i class="bi bi-save"></i> حفظ الإعدادات
                </button>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3"><i class="bi bi-graph-up"></i> التقارير والإحصائيات</h5>
                                <button onclick="generateMonthlyReport()" class="btn btn-info-custom btn-custom w-100 mb-2">
                                    <i class="bi bi-file-earmark-text"></i> تقرير شهري
                </button>
                                <button onclick="generateYearlyReport()" class="btn btn-info-custom btn-custom w-100 mb-2">
                                    <i class="bi bi-calendar-year"></i> تقرير سنوي
                                </button>
                                <button onclick="exportToExcel()" class="btn btn-success-custom btn-custom w-100 mb-2">
                                    <i class="bi bi-file-excel"></i> تصدير إلى Excel
                                </button>
                                <button onclick="exportToPDF()" class="btn btn-danger-custom btn-custom w-100">
                                    <i class="bi bi-file-pdf"></i> تصدير إلى PDF
                </button>
            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3"><i class="bi bi-bell"></i> إشعارات واتساب</h5>
                                <div class="mb-3">
                                    <label class="form-label">
                                        <input type="checkbox" id="autoWhatsApp" class="form-check-input me-2">
                                        إرسال إشعارات واتساب تلقائياً بعد الدفع
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">
                                        <input type="checkbox" id="reminderWhatsApp" class="form-check-input me-2">
                                        إرسال تذكيرات تلقائية للطلاب المتأخرين
                                    </label>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">عدد أيام التأخير قبل الإرسال</label>
                                    <input type="number" class="form-control" id="reminderDays" value="7" min="1">
                                </div>
                                <button onclick="saveWhatsAppSettings()" class="btn btn-primary-custom btn-custom">
                                    <i class="bi bi-save"></i> حفظ الإعدادات
                                </button>
                            </div>
                            <div class="col-md-6 mb-4">
                                <h5 class="mb-3"><i class="bi bi-database"></i> إدارة النظام</h5>
                                <button onclick="backupData()" class="btn btn-warning btn-custom w-100 mb-2">
                                    <i class="bi bi-cloud-upload"></i> نسخ احتياطي
                                </button>
                                <button onclick="restoreData()" class="btn btn-info-custom btn-custom w-100 mb-2">
                                    <i class="bi bi-cloud-download"></i> استعادة البيانات
                                </button>
                                <button onclick="clearCache()" class="btn btn-secondary btn-custom w-100">
                                    <i class="bi bi-trash"></i> مسح الذاكرة المؤقتة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    
    <div class="modal fade payment-modal" id="paymentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cash-coin"></i> تسجيل دفعة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm">
                        <input type="hidden" id="studentIdForPayment">
                        <input type="hidden" id="installmentIndex">
                        
                        <div class="mb-3">
                            <label class="form-label">اسم الطالب</label>
                            <input type="text" class="form-control" id="modalStudentName" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">اختر الدفعة</label>
                            <select class="form-select" id="selectedInstallment" onchange="updatePaymentDetails()">
                                <option value="-1">اختر الدفعة...</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">المبلغ المراد دفعه</label>
                            <input type="number" class="form-control" id="paymentAmount" min="0" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                            <label class="form-label">التاريخ</label>
                            <input type="date" class="form-control" id="paymentDate" required>
                        </div>
                            <div class="col-md-6 mb-3">
                            <label class="form-label">طريقة الدفع</label>
                            <select class="form-select" id="paymentMethod" required>
                                <option value="نقد">نقد</option>
                                <option value="تحويل بنكي">تحويل بنكي</option>
                                <option value="شيك">شيك</option>
                            </select>
                        </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ملاحظات</label>
                            <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                        </div>
                        
                        
                        <div class="installments-section">
                            <h6 class="mb-3"><strong>حالة الدفعات:</strong></h6>
                            <div id="installmentsList"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" onclick="printCurrentPayment()">
                        <i class="bi bi-printer"></i> طباعة الوصل
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom btn-custom" onclick="processPayment()">
                        <i class="bi bi-check-circle"></i> تأكيد الدفع
                    </button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> تفاصيل الطالب</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="studentDetailsContent">
                    
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="editStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> تعديل بيانات الطالب</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editStudentForm">
                        <input type="hidden" id="editStudentId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اسم الطالب</label>
                                <input type="text" class="form-control" id="editStudentName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اسم ولي الأمر</label>
                                <input type="text" class="form-control" id="editGuardianName" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اسم الأم</label>
                                <input type="text" class="form-control" id="editMotherName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الصف</label>
                                <select class="form-select" id="editGrade" required>
                                    <option value="الاول ابتدائي">الاول ابتدائي</option>
                                    <option value="الثاني ابتدائي">الثاني ابتدائي</option>
                                    <option value="الثالث ابتدائي">الثالث ابتدائي</option>
                                    <option value="الرابع ابتدائي">الرابع ابتدائي</option>
                                    <option value="الخامس ابتدائي">الخامس ابتدائي</option>
                                    <option value="السادس ابتدائي">السادس ابتدائي</option>
                                    <option value="الاول متوسط">الاول متوسط</option>
                                    <option value="الثاني متوسط">الثاني متوسط</option>
                                    <option value="الثالث متوسط">الثالث متوسط</option>
                                    <option value="الرابع متوسط">الرابع متوسط</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">المبلغ السنوي</label>
                                <input type="number" class="form-control" id="editAnnualFee" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">إخوة (خصم 5%)</label>
                                <select class="form-select" id="editHasSibling">
                                    <option value="no">لا</option>
                                    <option value="yes">نعم</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="text" class="form-control" id="editPhone" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ملاحظات</label>
                                <input type="text" class="form-control" id="editNotes">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-warning" onclick="saveEditedStudent()">
                        <i class="bi bi-check"></i> حفظ التعديلات
                    </button>
                </div>
            </div>
        </div>
    </div>

    
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> إضافة مستخدم جديد</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">اسم المستخدم <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">كلمة المرور <span class="text-danger">*</span></label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">المدرسة <span class="text-danger">*</span></label>
                            <select class="form-select" id="userSchool" required>
                                <option value="">-- اختر المدرسة --</option>
                                <option value="rawda">روضة رسول الرحمة</option>
                                <option value="rasoul">مدرسة رسول الرحمة</option>
                                <option value="noor">مدرسة نور الرحمة</option>
                                <option value="nabi">مدرسة نبي الرحمة</option>
                                <option value="thanawiya">ثانوية رسول الرحمة</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">نوع المستخدم</label>
                            <select class="form-select" id="userType">
                                <option value="user">مستخدم عادي</option>
                                <option value="school_admin">مدير مدرسة</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveNewUser()">
                        <i class="bi bi-check"></i> حفظ المستخدم
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal إضافة/تعديل أستاذ -->
    <div class="modal fade" id="teacherModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-person-badge"></i> <span id="teacherModalTitle">إضافة أستاذ جديد</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="teacherForm">
                        <input type="hidden" id="teacherId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اسم الأستاذ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="teacherName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">المادة <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="teacherSubject" required placeholder="مثال: الرياضيات">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الصفوف</label>
                                <input type="text" class="form-control" id="teacherGrades" placeholder="مثال: الأول ابتدائي، الثاني ابتدائي">
                                <small class="text-muted">يمكن إدخال عدة صفوف مفصولة بفواصل</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">رقم الهاتف</label>
                                <input type="text" class="form-control" id="teacherPhone" placeholder="07XX XXX XXXX">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">البريد الإلكتروني</label>
                                <input type="email" class="form-control" id="teacherEmail" placeholder="example@email.com">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحالة</label>
                                <select class="form-select" id="teacherIsActive">
                                    <option value="true">نشط</option>
                                    <option value="false">غير نشط</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveTeacher()">
                        <i class="bi bi-check"></i> حفظ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal إضافة/تعديل مادة -->
    <div class="modal fade" id="subjectModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-book"></i> <span id="subjectModalTitle">إضافة مادة جديدة</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="subjectForm">
                        <input type="hidden" id="subjectId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اسم المادة <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="subjectName" required placeholder="مثال: الرياضيات">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الصف</label>
                                <select class="form-select" id="subjectGrade">
                                    <option value="">جميع الصفوف</option>
                                    <option value="الاول ابتدائي">الاول ابتدائي</option>
                                    <option value="الثاني ابتدائي">الثاني ابتدائي</option>
                                    <option value="الثالث ابتدائي">الثالث ابتدائي</option>
                                    <option value="الرابع ابتدائي">الرابع ابتدائي</option>
                                    <option value="الخامس ابتدائي">الخامس ابتدائي</option>
                                    <option value="السادس ابتدائي">السادس ابتدائي</option>
                                    <option value="الاول متوسط">الاول متوسط</option>
                                    <option value="الثاني متوسط">الثاني متوسط</option>
                                    <option value="الثالث متوسط">الثالث متوسط</option>
                                    <option value="الرابع متوسط">الرابع متوسط</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">عدد الحصص الأسبوعية</label>
                                <input type="number" class="form-control" id="subjectPeriods" min="0" value="0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الأستاذ</label>
                                <select class="form-select" id="subjectTeacher">
                                    <option value="">-- اختر الأستاذ --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحالة</label>
                                <select class="form-select" id="subjectIsActive">
                                    <option value="true">نشط</option>
                                    <option value="false">غير نشط</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveSubject()">
                        <i class="bi bi-check"></i> حفظ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal إضافة/تعديل درس -->
    <div class="modal fade" id="lessonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-calendar-week"></i> <span id="lessonModalTitle">إضافة درس جديد</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="lessonForm">
                        <input type="hidden" id="lessonId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اليوم <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonDay" required>
                                    <option value="">-- اختر اليوم --</option>
                                    <option value="السبت">السبت</option>
                                    <option value="الأحد">الأحد</option>
                                    <option value="الإثنين">الإثنين</option>
                                    <option value="الثلاثاء">الثلاثاء</option>
                                    <option value="الأربعاء">الأربعاء</option>
                                    <option value="الخميس">الخميس</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحصة <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonPeriod" required>
                                    <option value="">-- اختر الحصة --</option>
                                    <option value="1">الحصة الأولى</option>
                                    <option value="2">الحصة الثانية</option>
                                    <option value="3">الحصة الثالثة</option>
                                    <option value="4">الحصة الرابعة</option>
                                    <option value="5">الحصة الخامسة</option>
                                    <option value="6">الحصة السادسة</option>
                                    <option value="7">الحصة السابعة</option>
                                    <option value="8">الحصة الثامنة</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الصف <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonGrade" required>
                                    <option value="">-- اختر الصف --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">المادة <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonSubject" required>
                                    <option value="">-- اختر المادة --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الأستاذ <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonTeacher" required>
                                    <option value="">-- اختر الأستاذ --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">القاعة</label>
                                <input type="text" class="form-control" id="lessonRoom" placeholder="مثال: 101">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحالة</label>
                                <select class="form-select" id="lessonIsActive">
                                    <option value="true">نشط</option>
                                    <option value="false">غير نشط</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveLesson()">
                        <i class="bi bi-check"></i> حفظ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal إضافة/تعديل درس -->
    <div class="modal fade" id="lessonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                    <h5 class="modal-title"><i class="bi bi-calendar-week"></i> <span id="lessonModalTitle">إضافة درس جديد</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="lessonForm">
                        <input type="hidden" id="lessonId">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">اليوم <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonDay" required>
                                    <option value="">-- اختر اليوم --</option>
                                    <option value="السبت">السبت</option>
                                    <option value="الأحد">الأحد</option>
                                    <option value="الإثنين">الإثنين</option>
                                    <option value="الثلاثاء">الثلاثاء</option>
                                    <option value="الأربعاء">الأربعاء</option>
                                    <option value="الخميس">الخميس</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحصة <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonPeriod" required>
                                    <option value="">-- اختر الحصة --</option>
                                    <option value="1">الحصة الأولى</option>
                                    <option value="2">الحصة الثانية</option>
                                    <option value="3">الحصة الثالثة</option>
                                    <option value="4">الحصة الرابعة</option>
                                    <option value="5">الحصة الخامسة</option>
                                    <option value="6">الحصة السادسة</option>
                                    <option value="7">الحصة السابعة</option>
                                    <option value="8">الحصة الثامنة</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الصف <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonGrade" required>
                                    <option value="">-- اختر الصف --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">المادة <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonSubject" required>
                                    <option value="">-- اختر المادة --</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الأستاذ <span class="text-danger">*</span></label>
                                <select class="form-select" id="lessonTeacher" required>
                                    <option value="">-- اختر الأستاذ --</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">القاعة</label>
                                <input type="text" class="form-control" id="lessonRoom" placeholder="مثال: 101">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحالة</label>
                                <select class="form-select" id="lessonIsActive">
                                    <option value="true">نشط</option>
                                    <option value="false">غير نشط</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveLesson()">
                        <i class="bi bi-check"></i> حفظ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        // تعريف الدالة في النطاق العام مباشرة
        let authenticateUser;
        
        
        const ANNUAL_FEE = CONFIG.DEFAULT_FEES.ELEMENTARY; 
        const QUARTERLY_INSTALLMENT = CONFIG.QUARTERLY_INSTALLMENT; 
        const INSTALLMENT_COUNT = CONFIG.INSTALLMENT_COUNT;
        
        // ============================================
        // Supabase Configuration
        // ============================================
        const SUPABASE_URL = CONFIG.SUPABASE.URL;
        const SUPABASE_ANON_KEY = CONFIG.SUPABASE.ANON_KEY;
        
        let supabaseClient = null;
        let databaseAvailable = true;
        let isOnline = navigator.onLine;
        let lastDatabaseCheck = Date.now();
        const DATABASE_CHECK_INTERVAL = 30000; // فحص قاعدة البيانات كل 30 ثانية
        let databaseCheckInterval = null;
        let syncInProgress = false;
        
        // تهيئة Supabase بعد تحميل المكتبة
        function initSupabase() {
            // إذا كان Client موجوداً بالفعل، لا تقم بإنشاء واحد جديد
            if (supabaseClient) {
                console.log('✅ Supabase Client موجود بالفعل');
                return true;
            }
            
            // التحقق من وجود CONFIG
            if (!CONFIG || !CONFIG.SUPABASE || !CONFIG.SUPABASE.URL || !CONFIG.SUPABASE.ANON_KEY) {
                console.error('❌ إعدادات Supabase غير موجودة في CONFIG');
                databaseAvailable = false;
                updateOfflineIndicator();
                return false;
            }
            
            if (typeof supabase !== 'undefined') {
                try {
                    supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('✅ تم الاتصال بقاعدة البيانات بنجاح');
                    databaseAvailable = true;
                    // بدء فحص صحة قاعدة البيانات
                    startDatabaseHealthCheck();
                    // محاولة مزامنة العمليات المحفوظة
                    syncOfflineQueue();
                    updateOfflineIndicator();
                    return true;
                } catch (error) {
                    console.error('❌ خطأ في تهيئة Supabase:', error);
                    databaseAvailable = false;
                    updateOfflineIndicator();
                    return false;
                }
            } else {
                console.warn('⚠️ مكتبة Supabase غير محملة بعد، سيتم المحاولة مرة أخرى...');
                databaseAvailable = false;
                updateOfflineIndicator();
                
                // إعادة المحاولة بعد ثانية واحدة
                setTimeout(() => {
                    if (typeof supabase !== 'undefined' && !supabaseClient) {
                        initSupabase();
                    } else if (!supabaseClient) {
                        console.warn('⚠️ فشل تحميل مكتبة Supabase. سيتم استخدام التخزين المحلي فقط.');
                        showToast('تحذير: استخدام التخزين المحلي فقط', 'warning', 'تحذير');
                    }
                }, 1000);
                
                return false;
            }
        }
        
        // ============================================
        // نظام قائمة انتظار العمليات عند انقطاع قاعدة البيانات
        // ============================================
        const OFFLINE_QUEUE_KEY = 'offline_db_queue';
        const OFFLINE_QUEUE_MAX_SIZE = 1000; // حد أقصى للعمليات المحفوظة
        
        // حفظ عملية في قائمة الانتظار
        function addToOfflineQueue(operation) {
            try {
                const queue = getOfflineQueue();
                
                // إضافة معرف فريد للعملية
                const queueItem = {
                    id: `op_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    operation: operation.type, // 'insert', 'update', 'delete'
                    table: operation.table,
                    data: operation.data,
                    filters: operation.filters || {},
                    timestamp: new Date().toISOString(),
                    retryCount: 0,
                    status: 'pending'
                };
                
                queue.push(queueItem);
                
                // الحد من حجم القائمة
                if (queue.length > OFFLINE_QUEUE_MAX_SIZE) {
                    queue.shift(); // إزالة أقدم عملية
                }
                
                localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
                updateOfflineIndicator();
                
                console.log('📦 تم حفظ العملية في قائمة الانتظار:', queueItem.id);
                return queueItem.id;
            } catch (error) {
                console.error('❌ خطأ في حفظ العملية في قائمة الانتظار:', error);
                return null;
            }
        }
        
        // الحصول على قائمة الانتظار
        function getOfflineQueue() {
            try {
                const queueData = localStorage.getItem(OFFLINE_QUEUE_KEY);
                return queueData ? JSON.parse(queueData) : [];
            } catch (error) {
                console.error('❌ خطأ في قراءة قائمة الانتظار:', error);
                return [];
            }
        }
        
        // حذف عملية من قائمة الانتظار
        function removeFromOfflineQueue(operationId) {
            try {
                const queue = getOfflineQueue();
                const filtered = queue.filter(item => item.id !== operationId);
                localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(filtered));
                updateOfflineIndicator();
            } catch (error) {
                console.error('❌ خطأ في حذف العملية من قائمة الانتظار:', error);
            }
        }
        
        // مزامنة قائمة الانتظار مع قاعدة البيانات
        async function syncOfflineQueue() {
            if (syncInProgress || !databaseAvailable || !supabaseClient) {
                return;
            }
            
            const queue = getOfflineQueue();
            if (queue.length === 0) {
                return;
            }
            
            syncInProgress = true;
            let syncedCount = 0;
            let failedCount = 0;
            
            console.log(`🔄 بدء مزامنة ${queue.length} عملية من قائمة الانتظار...`);
            
            // فرز العمليات حسب الأولوية (الإدراج أولاً، ثم التحديث، ثم الحذف)
            const sortedQueue = [...queue].sort((a, b) => {
                const priority = { 'insert': 1, 'update': 2, 'delete': 3 };
                return (priority[a.operation] || 99) - (priority[b.operation] || 99);
            });
            
            for (const item of sortedQueue) {
                try {
                    // التحقق من صحة البيانات قبل المزامنة
                    if (item.table === 'students' && item.data) {
                        // التحقق من وجود school_id
                        if (!item.data.school_id && !item.data.schoolId) {
                            console.warn(`⚠️ تخطي العملية ${item.id}: لا يوجد school_id`);
                            removeFromOfflineQueue(item.id);
                            continue;
                        }
                        
                        // التحقق من صحة school_id
                        const schoolId = item.data.school_id || item.data.schoolId;
                        if (schoolId && schoolId !== 'admin' && !schools[schoolId]) {
                            console.warn(`⚠️ تخطي العملية ${item.id}: school_id غير صحيح: ${schoolId}`);
                            removeFromOfflineQueue(item.id);
                            continue;
                        }
                    }
                    
                    let result = null;
                    
                    switch (item.operation) {
                        case 'insert':
                            result = await supabaseClient
                                .from(item.table)
                                .insert(item.data)
                                .select()
                                .single();
                            break;
                            
                        case 'update':
                            let updateQuery = supabaseClient
                                .from(item.table)
                                .update(item.data);
                            
                            // تطبيق الفلاتر
                            Object.keys(item.filters).forEach(key => {
                                updateQuery = updateQuery.eq(key, item.filters[key]);
                            });
                            
                            result = await updateQuery.select().single();
                            break;
                            
                        case 'delete':
                            let deleteQuery = supabaseClient
                                .from(item.table)
                                .delete();
                            
                            // تطبيق الفلاتر
                            Object.keys(item.filters).forEach(key => {
                                deleteQuery = deleteQuery.eq(key, item.filters[key]);
                            });
                            
                            result = await deleteQuery;
                            break;
                    }
                    
                    if (result && result.error) {
                        throw result.error;
                    }
                    
                    // حذف العملية من القائمة بعد النجاح
                    removeFromOfflineQueue(item.id);
                    syncedCount++;
                    
                    console.log(`✅ تمت مزامنة العملية: ${item.id}`);
                    
                    // إضافة تأخير صغير بين العمليات لتجنب الضغط على قاعدة البيانات
                    if (syncedCount % 10 === 0) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                } catch (error) {
                    item.retryCount = (item.retryCount || 0) + 1;
                    
                    // إذا كان الخطأ متعلقاً بالصلاحيات أو البيانات غير صحيحة، تخطي العملية
                    if (error.code === 'PGRST301' || error.code === '23505' || error.code === '23503') {
                        console.warn(`⚠️ تخطي العملية ${item.id} بسبب خطأ في البيانات:`, error.message);
                        removeFromOfflineQueue(item.id);
                        continue;
                    }
                    
                    // إذا فشلت العملية أكثر من 10 مرات، تخطيها
                    if (item.retryCount > 10) {
                        console.warn(`⚠️ تخطي العملية بعد ${item.retryCount} محاولة فاشلة:`, item.id, error.message);
                        removeFromOfflineQueue(item.id);
                        failedCount++;
                    } else {
                        // تحديث عدد المحاولات
                        const queue = getOfflineQueue();
                        const index = queue.findIndex(q => q.id === item.id);
                        if (index >= 0) {
                            queue[index] = item;
                            localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(queue));
                        }
                        failedCount++;
                    }
                    
                    // إذا كان الخطأ بسبب قاعدة البيانات غير متاحة، توقف
                    if (error.message && (
                        error.message.includes('Failed to fetch') ||
                        error.message.includes('timeout') ||
                        error.message.includes('503') ||
                        error.message.includes('502') ||
                        error.message.includes('504') ||
                        error.message.includes('500') ||
                        error.message.includes('network') ||
                        error.message.includes('ECONNREFUSED')
                    )) {
                        databaseAvailable = false;
                        console.warn('⚠️ قاعدة البيانات غير متاحة، إيقاف المزامنة');
                        break;
                    }
                }
            }
            
            syncInProgress = false;
            
            if (syncedCount > 0) {
                showToast(
                    `تمت مزامنة ${syncedCount} عملية بنجاح`,
                    'success',
                    'مزامنة تلقائية'
                );
            }
            
            if (failedCount > 0 && syncedCount === 0) {
                showToast(
                    `فشلت مزامنة ${failedCount} عملية. سيتم إعادة المحاولة لاحقاً`,
                    'warning',
                    'مزامنة تلقائية'
                );
            }
            
            updateOfflineIndicator();
            console.log(`✅ اكتملت المزامنة: ${syncedCount} نجحت، ${failedCount} فشلت`);
        }
        
        // فحص صحة قاعدة البيانات
        async function checkDatabaseHealth() {
            if (!isOnline) {
                databaseAvailable = false;
                updateOfflineIndicator();
                return false;
            }
            
            // التحقق من وجود إعدادات Supabase
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                console.error('❌ إعدادات Supabase غير موجودة');
                databaseAvailable = false;
                updateOfflineIndicator();
                return false;
            }
            
            if (!supabaseClient) {
                // محاولة إعادة التهيئة فقط إذا لم يكن هناك client موجود
                if (typeof supabase !== 'undefined') {
                    console.log('🔄 إعادة محاولة الاتصال بقاعدة البيانات...');
                    // استدعاء initSupabase التي تتحقق من وجود client قبل إنشاء واحد جديد
                    initSupabase();
                }
                databaseAvailable = false;
                updateOfflineIndicator();
                return false;
            }
            
            try {
                // محاولة طلب بسيط للتحقق من حالة قاعدة البيانات
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/students?limit=1`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok || response.status === 200 || response.status === 406) {
                    const wasOffline = !databaseAvailable;
                    databaseAvailable = true;
                    lastDatabaseCheck = Date.now();
                    
                    // إذا كانت قاعدة البيانات متوقفة سابقاً، ابدأ المزامنة
                    if (wasOffline) {
                        console.log('✅ قاعدة البيانات متاحة مرة أخرى، بدء المزامنة...');
                        showToast('تم استعادة الاتصال بقاعدة البيانات', 'success', 'اتصال');
                        syncOfflineQueue();
                        // إعادة إعداد Realtime subscription للرسائل
                        if (currentSchoolId) {
                            setupMessagesRealtimeSubscription();
                        }
                    }
                    
                    updateOfflineIndicator();
                    return true;
                } else {
                    // أخطاء قاعدة البيانات (503, 500, 502, إلخ)
                    if (response.status >= 500 || response.status === 503 || response.status === 502 || response.status === 504) {
                        console.warn(`⚠️ خطأ في قاعدة البيانات: ${response.status}`);
                        databaseAvailable = false;
                        updateOfflineIndicator();
                        return false;
                    }
                    // بعض الأخطاء الأخرى قد تكون مقبولة (مثل 404 إذا لم توجد بيانات)
                    databaseAvailable = true;
                    updateOfflineIndicator();
                    return true;
                }
            } catch (error) {
                // أي خطأ يعني أن قاعدة البيانات غير متاحة
                console.warn('⚠️ خطأ في الاتصال بقاعدة البيانات:', error.message);
                databaseAvailable = false;
                updateOfflineIndicator();
                
                // لا تقم بإعادة تهيئة Supabase هنا لتجنب إنشاء عدة نسخ
                // إذا كان Client غير موجود، سيتم إعادة تهيئته تلقائياً عند الحاجة
                if (!supabaseClient && typeof supabase !== 'undefined') {
                    // فقط إذا لم يكن هناك client موجود، حاول إعادة التهيئة
                    setTimeout(() => {
                        if (!supabaseClient && typeof supabase !== 'undefined') {
                        initSupabase();
                        }
                    }, 5000); // انتظر 5 ثوانٍ قبل إعادة المحاولة
                }
                
                return false;
            }
        }
        
        // بدء الفحص الدوري لقاعدة البيانات
        function startDatabaseHealthCheck() {
            if (databaseCheckInterval) {
                clearInterval(databaseCheckInterval);
            }
            
            // فحص فوري
            checkDatabaseHealth();
            
            // فحص دوري
            databaseCheckInterval = setInterval(() => {
                checkDatabaseHealth();
            }, DATABASE_CHECK_INTERVAL);
        }
        
        // إيقاف الفحص الدوري
        function stopDatabaseHealthCheck() {
            if (databaseCheckInterval) {
                clearInterval(databaseCheckInterval);
                databaseCheckInterval = null;
            }
        }
        
        // تحديث مؤشر حالة الاتصال
        function updateOfflineIndicator() {
            const queue = getOfflineQueue();
            const queueCount = queue.length;
            
            // البحث عن عنصر المؤشر أو إنشاؤه
            let indicator = document.getElementById('db-status-indicator');
            
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'db-status-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 20px;
                    z-index: 10000;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 14px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    transition: all 0.3s ease;
                `;
                document.body.appendChild(indicator);
            }
            
            if (!databaseAvailable || queueCount > 0) {
                indicator.style.display = 'flex';
                indicator.style.background = queueCount > 0 ? '#f59e0b' : '#ef4444';
                indicator.style.color = 'white';
                
                const icon = databaseAvailable && queueCount > 0 ? '⏳' : '⚠️';
                const text = databaseAvailable && queueCount > 0 
                    ? `جاري المزامنة: ${queueCount} عملية في الانتظار`
                    : `قاعدة البيانات غير متاحة: ${queueCount} عملية محفوظة`;
                
                indicator.innerHTML = `
                    <span style="font-size: 18px;">${icon}</span>
                    <span>${text}</span>
                `;
            } else {
                indicator.style.display = 'none';
            }
        }
        
        // مراقبة حالة الاتصال بالإنترنت
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('🌐 الاتصال بالإنترنت متاح');
            checkDatabaseHealth();
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            databaseAvailable = false;
            console.log('📴 الاتصال بالإنترنت غير متاح');
            updateOfflineIndicator();
        });
        
        // نظام التخزين المؤقت لتحسين الأداء
        const dataCache = {
            students: { data: null, timestamp: 0, ttl: CONFIG.CACHE_TTL.STUDENTS },
            installments: { data: null, timestamp: 0, ttl: CONFIG.CACHE_TTL.INSTALLMENTS },
            schools: { data: null, timestamp: 0, ttl: CONFIG.CACHE_TTL.SCHOOLS },
            notifications: { data: null, timestamp: 0, ttl: CONFIG.CACHE_TTL.NOTIFICATIONS },
            messages: { data: null, timestamp: 0, ttl: CONFIG.CACHE_TTL.MESSAGES },
            users: { data: null, timestamp: 0, ttl: CONFIG.CACHE_TTL.USERS }
        };
        
        // ============================================
        // نظام Toast Notifications
        // ============================================
        function showToast(message, type = 'info', title = '') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: 'bi-check-circle-fill',
                error: 'bi-x-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };
            
            const titles = {
                success: 'نجح',
                error: 'خطأ',
                warning: 'تحذير',
                info: 'معلومة'
            };
            
            toast.innerHTML = `
                <i class="bi ${icons[type]} toast-icon"></i>
                <div class="toast-content">
                    <div class="toast-title">${title || titles[type]}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="bi bi-x"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // إزالة تلقائية بعد 5 ثوان
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }
        
        // استبدال alert بـ showToast
        const originalAlert = window.alert;
        window.alert = function(message) {
            showToast(message, 'info', 'تنبيه');
        };
        
        // دالة تأكيد بديلة لـ confirm
        function showConfirmDialog(message, title = 'تأكيد', confirmText = 'نعم', cancelText = 'إلغاء') {
            return new Promise((resolve) => {
                const modalId = 'confirmModal_' + Date.now();
                const modalHTML = `
                    <div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                                    <h5 class="modal-title"><i class="bi bi-question-circle"></i> ${title}</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${Utils.sanitizeHTML(message)}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${cancelText}</button>
                                    <button type="button" class="btn btn-primary-custom btn-custom" onclick="window.__confirmResult = true; bootstrap.Modal.getInstance(document.getElementById('${modalId}')).hide();">${confirmText}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                const modalElement = document.getElementById(modalId);
                const modal = new bootstrap.Modal(modalElement);
                
                modalElement.addEventListener('hidden.bs.modal', function() {
                    const result = window.__confirmResult || false;
                    delete window.__confirmResult;
                    modalElement.remove();
                    resolve(result);
                });
                
                modal.show();
            });
        }
        
        // استبدال confirm بـ showConfirmDialog
        const originalConfirm = window.confirm;
        window.confirm = async function(message) {
            return await showConfirmDialog(message, 'تأكيد', 'نعم', 'إلغاء');
        };
        
        // ============================================
        // نظام Loading
        // ============================================
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.add('show');
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('show');
        }
        
        // ============================================
        // Auto-save Indicator
        // ============================================
        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }
        
        // ============================================
        // Keyboard Shortcuts
        // ============================================
        document.addEventListener('keydown', function(e) {
            // Ctrl + N: إضافة طالب جديد
            if (e.ctrlKey && e.key === 'n' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('studentName')?.focus();
                document.getElementById('addStudentForm')?.scrollIntoView({ behavior: 'smooth' });
            }
            
            // Ctrl + F: البحث
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput')?.focus();
            }
            
            // Ctrl + P: الطباعة
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                printList();
            }
            
            // Ctrl + E: تصدير Excel
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportToExcel();
            }
            
            // Ctrl + R: إزالة الفلاتر
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                clearFilters();
            }
            
            // ?: إظهار/إخفاء الاختصارات
            if (e.key === '?' && !e.ctrlKey && !e.altKey) {
                const shortcuts = document.getElementById('keyboardShortcuts');
                if (shortcuts) {
                    shortcuts.classList.toggle('show');
                }
            }
            
            // ESC: إغلاق الاختصارات
            if (e.key === 'Escape') {
                const shortcuts = document.getElementById('keyboardShortcuts');
                if (shortcuts) {
                    shortcuts.classList.remove('show');
                }
            }
        });
        
        function getCachedData(key) {
            const cache = dataCache[key];
            if (cache && Date.now() - cache.timestamp < cache.ttl) {
                return cache.data;
            }
            return null;
        }
        
        function setCachedData(key, data) {
            if (dataCache[key]) {
                dataCache[key].data = data;
                dataCache[key].timestamp = Date.now();
            }
        }
        
        function clearCache(key = null) {
            if (key && dataCache[key]) {
                dataCache[key].data = null;
                dataCache[key].timestamp = 0;
            } else {
                Object.keys(dataCache).forEach(k => {
                    dataCache[k].data = null;
                    dataCache[k].timestamp = 0;
                });
            }
        }
        
        // استخدام Utils للـ debounce و throttle
        const debounce = Utils.debounce;
        const throttle = Utils.throttle; 
        
        function calculateSiblingDiscount(siblingCount) {
            return Utils.calculateSiblingDiscount(siblingCount);
        }

        
        // استخدام SCHOOLS من config.js
        const schools = SCHOOLS;

        // ⚠️ في الإنتاج، يجب استخدام Supabase Auth بدلاً من كلمات المرور المكشوفة
        // هذا فقط للتوافق مع النظام القديم
        const adminUser = { username: 'admin', password: 'master123' }; // سيتم استبداله بـ Supabase Auth

        
        let students = [];
        let allStudents = []; 
        let receiptCounter = 1;
        let currentSchool = null;
        let currentSchoolId = null;
        let currentSchoolName = null;
        let isAdmin = false;
        let currentFilter = {
            school: 'all',
            grade: 'all',
            status: 'all'
        };

        
        authenticateUser = async function() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const schoolId = document.getElementById('loginSchool').value;
            const errorDiv = document.getElementById('loginError');

            
            if (schoolId === 'admin') {
                if (username === adminUser.username && password === adminUser.password) {
                    isAdmin = true;
                    currentSchool = null;
                    document.getElementById('schoolName').textContent = 'رئيس مجلس الإدارة';
                    
                    
                    localStorage.setItem('currentLogin', JSON.stringify({
                        username: username,
                        password: password,
                        schoolId: 'admin'
                    }));
                    
                    
                    // إخفاء modal تسجيل الدخول
                    const loginModalElement = document.getElementById('loginModal');
                    const loginModalBackdrop = document.getElementById('loginModalBackdrop');
                    const loginModal = loginModalElement ? bootstrap.Modal.getInstance(loginModalElement) : null;
                    if (loginModal) {
                        loginModal.hide();
                    } else if (loginModalElement) {
                        // إذا لم يكن هناك instance، نخفي مباشرة
                        loginModalElement.style.display = 'none';
                        loginModalElement.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        if (loginModalBackdrop) {
                            loginModalBackdrop.style.display = 'none';
                        }
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) backdrop.remove();
                    }
                    
                    // إظهار الواجهة الرئيسية
                    const mainContent = document.getElementById('mainContent');
                    const sidebar = document.getElementById('sidebar');
                    if (mainContent) mainContent.style.display = 'block';
                    if (sidebar) sidebar.style.display = 'flex';
                    
                    // إظهار تبويبات المدير
                    const adminSchoolRow = document.getElementById('adminSchoolRow');
                    if (adminSchoolRow) adminSchoolRow.style.display = 'block';
                    
                    const schoolNameHeader = document.getElementById('schoolNameHeader');
                    if (schoolNameHeader) schoolNameHeader.style.display = 'table-cell';
                    
                    const schoolsTabNav = document.getElementById('schoolsTabNav');
                    if (schoolsTabNav) schoolsTabNav.style.display = 'block';
                    
                    const usersTabNav = document.getElementById('usersTabNav');
                    if (usersTabNav) usersTabNav.style.display = 'block';
                    
                    const userManagementBtn = document.getElementById('userManagementBtn');
                    if (userManagementBtn) userManagementBtn.style.display = 'inline-block';
                    
                    const userManagementSection = document.getElementById('userManagementSection');
                    if (userManagementSection) userManagementSection.style.display = 'block';
                    
                    // إظهار تبويبات المدارس
                    const schoolTabsContainer = document.getElementById('schoolTabsContainer');
                    if (schoolTabsContainer) schoolTabsContainer.style.display = 'block';
                    
                    // تحديث معلومات الـ sidebar
                    updateSidebarInfo();
                    startDateTimeUpdate();
                    
                    // تعيين التواريخ
                    const registrationDate = document.getElementById('registrationDate');
                    if (registrationDate) registrationDate.valueAsDate = new Date();
                    
                    const paymentDate = document.getElementById('paymentDate');
                    if (paymentDate) paymentDate.valueAsDate = new Date();
                    
                    // تحديث الصفوف
                    updateGradesForCurrentSchool();
                    
                    // تحميل البيانات
                    loadData().then(() => {
                        setupSchoolTabs(); 
                        updateGradeFilter(); 
            renderTable();
                        updateStats();
                        loadUsers(); 
                        loadSchoolsStats(); 
                    });
                    
                    return;
                } else {
                    errorDiv.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة للمدير';
                    errorDiv.style.display = 'block';
                    return;
                }
            }

            
            if (!schoolId || schoolId === 'admin') {
                errorDiv.textContent = 'الرجاء اختيار المدرسة';
                errorDiv.style.display = 'block';
                return;
            }

            if (!username || !password) {
                errorDiv.textContent = 'الرجاء إدخال اسم المستخدم وكلمة المرور';
                errorDiv.style.display = 'block';
                return;
            }

            // التحقق من بيانات المستخدمين المحلية
            const schoolUsers = {
                'rawda': { username: 'rawda', password: 'rawda123' },
                'rasoul': { username: 'rasoul', password: 'rasoul123' },
                'noor': { username: 'noor', password: 'noor123' },
                'nabi': { username: 'nabi', password: 'nabi123' },
                'thanawiya': { username: 'thanawiya123', password: 'thanawiya123' }
            };
            
            const schoolUser = schoolUsers[schoolId];
            let userFound = false;
            
            if (schoolUser && username === schoolUser.username && password === schoolUser.password) {
                userFound = true;
            }
            
            if (!userFound) {
                errorDiv.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة';
                errorDiv.style.display = 'block';
                return;
            }

            
            currentSchool = schools[schoolId];
            currentSchoolId = schoolId;
            currentSchoolName = currentSchool.name;
            isAdmin = false;
            
            
            localStorage.setItem('currentLogin', JSON.stringify({
                username: username,
                password: password,
                schoolId: schoolId
            }));
            
            
            const schoolNameElement = document.getElementById('schoolName');
            if (schoolNameElement) {
                schoolNameElement.textContent = currentSchool.name;
            }
            
            
            // إخفاء modal تسجيل الدخول
            const loginModalElement = document.getElementById('loginModal');
            const loginModalBackdrop = document.getElementById('loginModalBackdrop');
            const loginModal = loginModalElement ? bootstrap.Modal.getInstance(loginModalElement) : null;
            if (loginModal) {
                loginModal.hide();
            } else if (loginModalElement) {
                // إذا لم يكن هناك instance، نخفي مباشرة
                loginModalElement.style.display = 'none';
                loginModalElement.classList.remove('show');
                document.body.classList.remove('modal-open');
                if (loginModalBackdrop) {
                    loginModalBackdrop.style.display = 'none';
                }
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            }
            
            // إظهار الواجهة الرئيسية
            const mainContentEl = document.getElementById('mainContent');
            const sidebarEl = document.getElementById('sidebar');
            if (mainContentEl) mainContentEl.style.display = 'block';
            if (sidebarEl) sidebarEl.style.display = 'flex';
            
            // إخفاء تبويبات المدير (للمستخدمين العاديين)
            const schoolsTabNavEl = document.getElementById('schoolsTabNav');
            if (schoolsTabNavEl) schoolsTabNavEl.style.display = 'none';
            
            const usersTabNavEl = document.getElementById('usersTabNav');
            if (usersTabNavEl) usersTabNavEl.style.display = 'none';
            
            // إخفاء عناصر المدير
            const adminSchoolRowEl = document.getElementById('adminSchoolRow');
            if (adminSchoolRowEl) adminSchoolRowEl.style.display = 'none';
            
            const schoolNameHeaderEl = document.getElementById('schoolNameHeader');
            if (schoolNameHeaderEl) schoolNameHeaderEl.style.display = 'none';
            
            const schoolTabsContainerEl = document.getElementById('schoolTabsContainer');
            if (schoolTabsContainerEl) schoolTabsContainerEl.style.display = 'none';
            
            // تحديث معلومات الـ sidebar
            updateSidebarInfo();
            startDateTimeUpdate();
            
            // تحديث الصفوف
            updateGradesForCurrentSchool();
            
            // تعيين التواريخ
            const registrationDateEl = document.getElementById('registrationDate');
            if (registrationDateEl) registrationDateEl.valueAsDate = new Date();
            
            const paymentDateEl = document.getElementById('paymentDate');
            if (paymentDateEl) paymentDateEl.valueAsDate = new Date();
            
            // تحميل البيانات
            loadData().then(() => {
                updateGradeFilter(); 
                renderTable();
                updateStats();
                initChatSystem(); 
            });
        }


        
        // التأكد من أن الدالة متاحة في النطاق العام
        window.authenticateUser = authenticateUser;
        
        // تعريف إضافي للتأكد من الوصول
        if (typeof authenticateUser !== 'undefined') {
            window.authenticateUser = authenticateUser;
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            // تهيئة Supabase بعد التأكد من تحميل جميع المكتبات
            setTimeout(() => {
                // التحقق من وجود CONFIG أولاً
                if (typeof CONFIG === 'undefined') {
                    console.error('❌ ملف config.js غير محمل');
                    showToast('خطأ: ملف الإعدادات غير محمل. تأكد من وجود ملف config.js', 'error', 'خطأ');
                    databaseAvailable = false;
                    updateOfflineIndicator();
                    return;
                }
                
                // التحقق من وجود إعدادات Supabase
                if (!CONFIG.SUPABASE || !CONFIG.SUPABASE.URL || !CONFIG.SUPABASE.ANON_KEY) {
                    console.error('❌ إعدادات Supabase غير موجودة في CONFIG');
                    showToast('خطأ: إعدادات قاعدة البيانات غير موجودة في ملف config.js', 'error', 'خطأ');
                    databaseAvailable = false;
                    updateOfflineIndicator();
                    return;
                }
                
                // محاولة تهيئة Supabase
                if (initSupabase()) {
                    showToast('تم الاتصال بقاعدة البيانات بنجاح', 'success', 'نجح');
                } else {
                    // إعادة المحاولة بعد 2 ثانية
                    setTimeout(() => {
                        if (initSupabase()) {
                            showToast('تم الاتصال بقاعدة البيانات بنجاح', 'success', 'نجح');
                        } else {
                            showToast('تحذير: استخدام التخزين المحلي فقط. تأكد من اتصال الإنترنت وإعدادات Supabase', 'warning', 'تحذير');
                        }
                        updateOfflineIndicator();
                    }, 2000);
                }
                // تحديث مؤشر حالة قاعدة البيانات
                updateOfflineIndicator();
            }, 1000);
            
            // التأكد من إخفاء الواجهة الرئيسية في البداية
            const mainContentEl = document.getElementById('mainContent');
            const sidebarEl = document.getElementById('sidebar');
            if (mainContentEl) mainContentEl.style.display = 'none';
            if (sidebarEl) sidebarEl.style.display = 'none';
            
            // إخفاء modal تسجيل الدخول في البداية
            const loginModalEl = document.getElementById('loginModal');
            const loginModalBackdropEl = document.getElementById('loginModalBackdrop');
            if (loginModalEl) {
                loginModalEl.style.display = 'none';
                loginModalEl.classList.remove('show');
            }
            if (loginModalBackdropEl) {
                loginModalBackdropEl.style.display = 'none';
            }
            document.body.classList.remove('modal-open');
            
            const savedLogin = localStorage.getItem('currentLogin');
            if (savedLogin) {
                try {
                    const loginData = JSON.parse(savedLogin);
                    const { username, password, schoolId } = loginData;
                    
                    // التحقق من صحة بيانات تسجيل الدخول
                    let isValidLogin = false;
                    
                    if (schoolId === 'admin') {
                        isValidLogin = (username === adminUser.username && password === adminUser.password);
                    } else {
                        const schoolUsers = {
                            'rawda': { username: 'rawda', password: 'rawda123' },
                            'rasoul': { username: 'rasoul', password: 'rasoul123' },
                            'noor': { username: 'noor', password: 'noor123' },
                            'nabi': { username: 'nabi', password: 'nabi123' },
                            'thanawiya': { username: 'thanawiya123', password: 'thanawiya123' }
                        };
                        const schoolUser = schoolUsers[schoolId];
                        isValidLogin = (schoolUser && username === schoolUser.username && password === schoolUser.password);
                    }
                    
                    if (!isValidLogin) {
                        // بيانات تسجيل الدخول غير صحيحة، إظهار modal
                        localStorage.removeItem('currentLogin');
                        showLoginModal();
                        return;
                    }
                    
                    // تسجيل الدخول صحيح، إخفاء modal وإظهار الواجهة
                    if (loginModalEl) {
                        loginModalEl.style.display = 'none';
                        loginModalEl.classList.remove('show');
                    }
                    if (loginModalBackdropEl) {
                        loginModalBackdropEl.style.display = 'none';
                    }
                    document.body.classList.remove('modal-open');
                    
                    if (schoolId === 'admin') {
                        currentSchool = null;
                        isAdmin = true;
                        const schoolNameEl = document.getElementById('schoolName');
                        if (schoolNameEl) schoolNameEl.textContent = 'رئيس مجلس الإدارة';
                        
                        if (mainContentEl) mainContentEl.style.display = 'block';
                        if (sidebarEl) sidebarEl.style.display = 'flex';
                        
                        // إظهار تبويبات المدير
                        const adminSchoolRowEl = document.getElementById('adminSchoolRow');
                        if (adminSchoolRowEl) adminSchoolRowEl.style.display = 'block';
                        
                        const schoolNameHeaderEl = document.getElementById('schoolNameHeader');
                        if (schoolNameHeaderEl) schoolNameHeaderEl.style.display = 'table-cell';
                        
                    const schoolsTabNav = document.getElementById('schoolsTabNav');
                    if (schoolsTabNav) schoolsTabNav.style.display = 'block';
                    
                    const usersTabNav = document.getElementById('usersTabNav');
                    if (usersTabNav) usersTabNav.style.display = 'block';
                    
                        // إظهار تبويبات المدارس
                        const schoolTabsContainer = document.getElementById('schoolTabsContainer');
                        if (schoolTabsContainer) schoolTabsContainer.style.display = 'block';
                    
                    updateSidebarInfo();
                    startDateTimeUpdate();
                        
                        loadData().then(() => {
                        setupSchoolTabs(); 
                        updateGradeFilter(); 
                            renderTable();
                            updateStats();
                            loadUsers(); 
                        loadSchoolsStats(); 
                        });
                    } else {
                        const school = schools[schoolId];
                        if (school) {
                            currentSchool = school;
                            currentSchoolId = school.id;
                                currentSchoolName = school.name;
                                isAdmin = false;
                                
                                const schoolNameEl = document.getElementById('schoolName');
                                if (schoolNameEl) schoolNameEl.textContent = school.name;
                                
                                if (mainContentEl) mainContentEl.style.display = 'block';
                            if (sidebarEl) sidebarEl.style.display = 'flex';
                                
                            // إخفاء تبويبات المدير (للمستخدمين العاديين)
                                const schoolsTabNavEl = document.getElementById('schoolsTabNav');
                                if (schoolsTabNavEl) schoolsTabNavEl.style.display = 'none';
                                
                                const usersTabNavEl = document.getElementById('usersTabNav');
                                if (usersTabNavEl) usersTabNavEl.style.display = 'none';
                                
                            // إخفاء عناصر المدير
                            const adminSchoolRowEl = document.getElementById('adminSchoolRow');
                            if (adminSchoolRowEl) adminSchoolRowEl.style.display = 'none';
                            
                            const schoolNameHeaderEl = document.getElementById('schoolNameHeader');
                            if (schoolNameHeaderEl) schoolNameHeaderEl.style.display = 'none';
                            
                            const schoolTabsContainerEl = document.getElementById('schoolTabsContainer');
                            if (schoolTabsContainerEl) schoolTabsContainerEl.style.display = 'none';
                                
                                updateSidebarInfo();
                                startDateTimeUpdate();
                                
                            // تحديث الصفوف
                            updateGradesForCurrentSchool();
                            
                            // تعيين التواريخ
                            const registrationDateEl = document.getElementById('registrationDate');
                            if (registrationDateEl) registrationDateEl.valueAsDate = new Date();
                            
                            const paymentDateEl = document.getElementById('paymentDate');
                            if (paymentDateEl) paymentDateEl.valueAsDate = new Date();
                                
                                loadData().then(() => {
                                    updateGradeFilter(); 
                                    renderTable();
                                    updateStats();
                                    initChatSystem(); 
                                });
                        } else {
                            showLoginModal();
                        }
                    }
                } catch (e) {
                    // خطأ في قراءة بيانات تسجيل الدخول
                    localStorage.removeItem('currentLogin');
                    showLoginModal();
                }
            } else {
                // لا يوجد تسجيل دخول، إظهار modal فقط
                showLoginModal();
            }
            
            
            document.getElementById('loginModal').addEventListener('hidden.bs.modal', function() {
                if (!currentSchool && !isAdmin) {
                    location.reload();
                }
            });
            
            // تنظيف الاشتراكات عند إغلاق الصفحة
            window.addEventListener('beforeunload', function() {
                if (messagesSubscription && supabaseClient) {
                    supabaseClient.removeChannel(messagesSubscription);
                    messagesSubscription = null;
                }
            });
            
            
            document.getElementById('motherName').addEventListener('input', function() {
                checkSiblingDiscount();
            });
            
            
            document.getElementById('guardianName').addEventListener('input', function() {
                checkSiblingDiscount();
            });
            
            
            document.getElementById('adminSchoolSelect').addEventListener('change', function() {
                updateGradesForSchool(this.value);
            });
            
            // تحديث المبلغ السنوي تلقائياً عند اختيار الصف
            document.getElementById('grade').addEventListener('change', function() {
                const selectedGrade = this.value;
                if (selectedGrade) {
                    const annualFee = getAnnualFeeByGrade(selectedGrade);
                    const annualFeeInput = document.getElementById('annualFee');
                    if (annualFeeInput) {
                        annualFeeInput.value = annualFee;
                    }
                }
            });
        });
        
        
        function updateGradesForSchool(schoolId) {
            const gradeSelect = document.getElementById('grade');
            gradeSelect.innerHTML = '';
            
            const grades = {
                'rawda': ['روضة'],
                'rasoul': ['الاول ابتدائي', 'الثاني ابتدائي', 'الثالث ابتدائي', 'الرابع ابتدائي', 'الخامس ابتدائي', 'السادس ابتدائي'],
                'noor': ['الاول ابتدائي', 'الثاني ابتدائي', 'الثالث ابتدائي', 'الرابع ابتدائي', 'الخامس ابتدائي', 'السادس ابتدائي'],
                'nabi': ['الاول ابتدائي', 'الثاني ابتدائي', 'الثالث ابتدائي', 'الرابع ابتدائي', 'الخامس ابتدائي', 'السادس ابتدائي'],
                'thanawiya': ['الاول متوسط', 'الثاني متوسط', 'الثالث متوسط']
            };
            
            const schoolGrades = grades[schoolId] || grades['rasoul'];
            
            schoolGrades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });
        }
        
        
        function updateGradesForCurrentSchool() {
            if (isAdmin) {
                
                const adminSelect = document.getElementById('adminSchoolSelect');
                if (adminSelect && adminSelect.value) {
                    updateGradesForSchool(adminSelect.value);
                } else if (adminSelect) {
                    
                    updateGradesForSchool('rasoul');
                }
            } else if (currentSchool) {
                updateGradesForSchool(currentSchool.id);
            }
        }

        
        document.getElementById('addStudentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const annualFee = parseFloat(document.getElementById('annualFee').value);
                const hasSibling = document.getElementById('hasSibling').value === 'yes';
                
                
                let selectedSchoolId = null;
                if (isAdmin) {
                    selectedSchoolId = document.getElementById('adminSchoolSelect').value;
                } else if (currentSchool) {
                    selectedSchoolId = currentSchool.id;
                }
                
                if (!selectedSchoolId) {
                    showToast('الرجاء اختيار المدرسة', 'warning', 'تنبيه');
                    return;
                }
                
                // إنشاء طالب جديد
                // تنظيف والتحقق من المدخلات
                const studentName = Utils.sanitizeText(document.getElementById('studentName').value.trim());
                const guardianName = Utils.sanitizeText(document.getElementById('guardianName').value.trim());
                const motherName = Utils.sanitizeText(document.getElementById('motherName').value.trim());
                const grade = document.getElementById('grade').value;
                const phone = document.getElementById('phone').value.trim();
                const registrationDate = document.getElementById('registrationDate').value;
                const notes = Utils.sanitizeText(document.getElementById('notes').value.trim(), CONFIG.VALIDATION.NOTES_MAX_LENGTH);
                
                // التحقق من صحة المدخلات
                if (!Utils.validateName(studentName)) {
                    showToast('اسم الطالب غير صحيح (يجب أن يكون بين 2-200 حرف)', 'warning', 'تنبيه');
                    return;
                }
                
                if (!Utils.validateName(guardianName)) {
                    showToast('اسم ولي الأمر غير صحيح (يجب أن يكون بين 2-200 حرف)', 'warning', 'تنبيه');
                    return;
                }
                
                if (!Utils.validateName(motherName)) {
                    showToast('اسم الأم غير صحيح (يجب أن يكون بين 2-200 حرف)', 'warning', 'تنبيه');
                    return;
                }
                
                if (!grade) {
                    showToast('الرجاء اختيار الصف', 'warning', 'تنبيه');
                    return;
                }
                
                if (!Utils.validatePhone(phone)) {
                    showToast('رقم الهاتف غير صحيح', 'warning', 'تنبيه');
                    return;
                }
                
                if (!Utils.validateDate(registrationDate)) {
                    showToast('تاريخ التسجيل غير صحيح', 'warning', 'تنبيه');
                    return;
                }
                
                if (!Utils.validateAmount(annualFee)) {
                    showToast('المبلغ السنوي غير صحيح', 'warning', 'تنبيه');
                    return;
                }
                
                // حساب الخصم للإخوة
                let finalFee = annualFee;
                let discountAmount = 0;
                if (hasSibling) {
                    // البحث عن الإخوة في جميع المدارس
                    let allSiblingsForCalculation = [...allStudents];
                    
                    // تحميل جميع الطلاب من قاعدة البيانات إذا لزم الأمر
                    if (supabaseClient && databaseAvailable) {
                        try {
                            const { data: allStudentsFromDB, error } = await supabaseClient
                                .from('students')
                                .select('*')
                                .order('created_at', { ascending: false });
                            
                            if (!error && allStudentsFromDB && allStudentsFromDB.length > 0) {
                                // دمج البيانات من قاعدة البيانات مع البيانات المحلية
                                const dbStudentsMap = new Map();
                                allStudentsFromDB.forEach(s => {
                                    const key = s.id || s.name + (s.guardian_name || s.guardian);
                                    dbStudentsMap.set(key, s);
                                });
                                
                                allSiblingsForCalculation = allStudentsFromDB.map(s => {
                                    const localStudent = allStudents.find(ls => 
                                        (ls.id && ls.id === s.id) || 
                                        (ls.name === s.name && (ls.guardian || ls.guardian_name) === (s.guardian_name || s.guardian))
                                    );
                                    return localStudent || s;
                                });
                            }
                        } catch (dbError) {
                            console.warn('خطأ في تحميل جميع الطلاب لحساب الخصم:', dbError);
                            // الاستمرار مع البيانات المحلية
                        }
                    }
                    
                    // البحث عن الإخوة في جميع البيانات (من جميع المدارس)
                    const siblings = allSiblingsForCalculation.filter(s => 
                        s.id !== undefined && 
                        (s.motherName || s.mother_name) === motherName && 
                        (s.guardian || s.guardian_name || s.guardianName) === guardianName &&
                        (s.motherName || s.mother_name) !== '' &&
                        motherName !== ''
                    );
                    const totalSiblings = siblings.length + 1;
                    const discountRate = calculateSiblingDiscount(totalSiblings);
                    discountAmount = annualFee * discountRate;
                    finalFee = annualFee - discountAmount;
                    
                    // تحديث خصم الإخوة الموجودين في جميع المدارس
                    if (siblings.length > 0 && supabaseClient && databaseAvailable) {
                        const updatePromises = siblings.map(async (sibling) => {
                            const siblingAnnualFee = sibling.annual_fee || sibling.annualFee || 1200000;
                            const siblingDiscount = siblingAnnualFee * discountRate;
                            const siblingFinalFee = siblingAnnualFee - siblingDiscount;
                            
                            // تحديث في البيانات المحلية
                            const localSibling = allStudents.find(s => s.id === sibling.id);
                            if (localSibling) {
                                localSibling.has_sibling = true;
                                localSibling.hasSibling = true;
                                localSibling.discount = siblingDiscount;
                                localSibling.discount_amount = siblingDiscount;
                                localSibling.final_fee = siblingFinalFee;
                                localSibling.finalFee = siblingFinalFee;
                            }
                            
                            // حفظ في Supabase
                            if (sibling.id && !sibling.id.toString().startsWith('temp_')) {
                                try {
                                    await saveStudentToDB({
                                        ...sibling,
                                        has_sibling: true,
                                        hasSibling: true,
                                        discount: siblingDiscount,
                                        discount_amount: siblingDiscount,
                                        final_fee: siblingFinalFee,
                                        finalFee: siblingFinalFee
                                    });
                                } catch (error) {
                                    console.error(`خطأ في تحديث خصم الإخ ${sibling.name}:`, error);
                                }
                            }
                        });
                        
                        // انتظار اكتمال جميع عمليات التحديث
                        await Promise.allSettled(updatePromises);
                    }
                }
                
                // إنشاء رقم الوصل
                const receiptNum = String(receiptCounter++).padStart(6, '0');
                
                // إنشاء الدفعات
                const installmentAmount = finalFee / INSTALLMENT_COUNT;
                const installments = Array(INSTALLMENT_COUNT).fill(null).map(() => ({
                    amount: 0,
                    amount_paid: 0,
                    status: 'unpaid',
                    payment_date: null,
                    payment_method: null
                }));
                
                // إنشاء كائن الطالب
                const newStudent = {
                    id: Date.now(),
                    name: studentName,
                    guardian: guardianName,
                    guardian_name: guardianName,
                    motherName: motherName,
                    mother_name: motherName,
                    grade: grade,
                    phone: Utils.cleanPhone(phone),
                    annualFee: annualFee,
                    annual_fee: annualFee,
                    finalFee: finalFee,
                    final_fee: finalFee,
                    discount: discountAmount,
                    hasSibling: hasSibling,
                    has_sibling: hasSibling,
                    receiptNumber: receiptNum,
                    receipt_number: receiptNum,
                    registrationDate: registrationDate,
                    registration_date: registrationDate,
                    notes: notes,
                    installments: installments,
                    schoolId: selectedSchoolId,
                    school_id: selectedSchoolId,
                    schoolName: schools[selectedSchoolId]?.name || 'غير محدد'
                };
                
                // حفظ في قاعدة البيانات
                showLoading();
                const savedStudent = await saveStudentToDB(newStudent);
                
                // تحديث البيانات المحلية
                if (savedStudent) {
                    // تحويل البيانات من قاعدة البيانات إلى التنسيق المحلي
                    const localStudent = {
                        ...savedStudent,
                        guardianName: savedStudent.guardian_name || savedStudent.guardianName,
                        motherName: savedStudent.mother_name || savedStudent.motherName,
                        annualFee: savedStudent.annual_fee || savedStudent.annualFee,
                        receiptNumber: savedStudent.receipt_number || savedStudent.receiptNumber,
                        registrationDate: savedStudent.registration_date || savedStudent.registrationDate,
                        schoolId: savedStudent.school_id || savedStudent.schoolId,
                        installments: typeof savedStudent.installments === 'string' 
                            ? JSON.parse(savedStudent.installments) 
                            : savedStudent.installments
                    };
                    
                    const studentIndex = students.findIndex(s => s.id === localStudent.id);
                    if (studentIndex >= 0) {
                        students[studentIndex] = localStudent;
                    } else {
                        students.push(localStudent);
                    }
                    
                    const allIndex = allStudents.findIndex(s => s.id === localStudent.id);
                    if (allIndex >= 0) {
                        allStudents[allIndex] = localStudent;
                    } else {
                        allStudents.push(localStudent);
                    }
                }
                
                // مسح التخزين المؤقت بعد الإضافة
                clearCache('students');
                clearCache('installments');
                hideLoading();
                
                // تحديث الواجهة
                updateGradeFilter();
            renderTable();
            updateStats();
            
                // إعادة تعيين النموذج
            document.getElementById('addStudentForm').reset();
                document.getElementById('annualFee').value = ANNUAL_FEE;
            document.getElementById('registrationDate').valueAsDate = new Date();
                document.getElementById('siblingAlert').style.display = 'none';
            
                showToast('تم إضافة الطالب بنجاح', 'success', 'نجح');
                showAutoSaveIndicator();
            } catch (error) {
                showToast('حدث خطأ في إضافة الطالب: ' + (error.message || 'خطأ غير معروف'), 'error', 'خطأ');
            }
        });

        
        function getField(student, camelName, snakeName) {
            return student[camelName] || student[snakeName];
        }
        
        function getStudentField(student, field) {
            const snakeField = field.replace(/([A-Z])/g, '_$1').toLowerCase();
            return getField(student, field, snakeField);
        }
        
        
        function calculateInstallmentAmount(student) {
            const finalFee = getStudentField(student, 'finalFee') || getStudentField(student, 'annualFee') || 1200000;
            return finalFee / INSTALLMENT_COUNT;
        }

        
        async function checkSiblingDiscount() {
            
            const motherName = document.getElementById('motherName').value.trim();
            const guardianName = document.getElementById('guardianName').value.trim();
            const alertDiv = document.getElementById('siblingAlert');
            const siblingNamesSpan = document.getElementById('siblingNames');
            
            if (!motherName || !guardianName) {
                alertDiv.style.display = 'none';
                return;
            }
            
            try {
                // تحميل جميع الطلاب من جميع المدارس عند البحث عن الإخوة
                let allStudentsForSiblingSearch = [...allStudents];
                
                // إذا لم يكن المستخدم مديراً أو لم يتم تحميل جميع الطلاب، قم بتحميلهم من قاعدة البيانات
                if (!isAdmin || allStudents.length === 0 || allStudents.length < 100) {
                    try {
                        if (supabaseClient && databaseAvailable) {
                            const { data: allStudentsFromDB, error } = await supabaseClient
                                .from('students')
                                .select('*')
                                .order('created_at', { ascending: false });
                            
                            if (!error && allStudentsFromDB && allStudentsFromDB.length > 0) {
                                // دمج البيانات من قاعدة البيانات مع البيانات المحلية
                                const dbStudentsMap = new Map();
                                allStudentsFromDB.forEach(s => {
                                    const key = s.id || s.name + (s.guardian_name || s.guardian);
                                    dbStudentsMap.set(key, s);
                                });
                                
                                // تحديث allStudents بالبيانات الكاملة
                                allStudentsForSiblingSearch = allStudentsFromDB.map(s => {
                                    const localStudent = allStudents.find(ls => 
                                        (ls.id && ls.id === s.id) || 
                                        (ls.name === s.name && (ls.guardian || ls.guardian_name) === (s.guardian_name || s.guardian))
                                    );
                                    return localStudent || s;
                                });
                            }
                        }
                    } catch (dbError) {
                        console.warn('خطأ في تحميل جميع الطلاب للبحث عن الإخوة:', dbError);
                        // الاستمرار مع البيانات المحلية
                    }
                }
                
                // البحث عن الإخوة في جميع البيانات (من جميع المدارس)
                const siblingsData = allStudentsForSiblingSearch.filter(s => 
                    s.id !== undefined && 
                    (s.motherName || s.mother_name) === motherName && 
                    (s.guardian || s.guardian_name || s.guardianName) === guardianName &&
                    (s.motherName || s.mother_name) !== '' &&
                    motherName !== ''
                );
                
                if (siblingsData && siblingsData.length > 0) {
                    // تم العثور على إخوة 
                    
                    
                    const siblingsList = siblingsData.map(s => {
                        const schoolId = s.schoolId || s.school_id;
                        const schoolName = schoolId && schools[schoolId] ? schools[schoolId].name : (s.schoolName || s.school_name || 'غير محدد');
                        const grade = s.grade || 'غير محدد';
                        const guardianName = s.guardian || s.guardian_name || s.guardianName || 'غير محدد';
                        return `<div style="margin-bottom: 10px; padding: 8px; background: #fff3cd; border-right: 4px solid #f59e0b; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="font-weight: bold; color: #856404; margin-bottom: 5px; font-size: 1.1em;">
                                        👤 ${s.name}
                                    </div>
                                    <div style="font-size: 0.9em; color: #666; line-height: 1.6;">
                                        <span>🏫 المدرسة: <strong>${schoolName}</strong></span><br>
                                        <span>📚 الصف: <strong>${grade}</strong></span><br>
                                        <span>👨‍👩‍👧 ولي الأمر: ${guardianName}</span>
                                    </div>
                                </div>`;
                    }).join('');
                    
                    siblingNamesSpan.innerHTML = siblingsList;
                    alertDiv.style.display = 'block';
                    
                    
                    const confirmationMessage = `تم العثور على ${siblingsData.length} أخ/أخت موجودين مسبقاً في النظام:\n\n` +
                        siblingsData.map(s => {
                            const schoolId = s.schoolId || s.school_id;
                            const schoolName = schoolId && schools[schoolId] ? schools[schoolId].name : (s.schoolName || s.school_name || 'غير محدد');
                            const grade = s.grade || 'غير محدد';
                            const guardianName = s.guardian || s.guardian_name || s.guardianName || 'غير محدد';
                            return `📌 الاسم: ${s.name}\n   🏫 المدرسة: ${schoolName}\n   📚 الصف: ${grade}\n   👨‍👩‍👧 ولي الأمر: ${guardianName}`;
                        }).join('\n\n') +
                        `\n\nسيتم تفعيل خصم ${siblingsData.length + 1 >= 3 ? '10%' : '5%'} لجميع الإخوة (${siblingsData.length + 1} أخ/أخت)!\nهل تريد المتابعة؟`;
                    
                    
                    if (document.getElementById('hasSibling').value === 'no') {
                        const confirmed = await showConfirmDialog(confirmationMessage, 'تنبيه', 'نعم، تفعيل الخصم', 'إلغاء');
                        if (confirmed) {
                            document.getElementById('hasSibling').value = 'yes';
                            
                            
                            
                            const totalSiblingsCount = siblingsData.length + 1;
                            const discountRate = calculateSiblingDiscount(totalSiblingsCount);
                            
                            // تحديث الإخوة في البيانات المحلية وحفظها في Supabase
                            const updatePromises = [];
                            
                            siblingsData.forEach((sibling) => {
                                const siblingAnnualFee = sibling.annual_fee || sibling.annualFee || 1200000;
                                const discount = siblingAnnualFee * discountRate;
                                const finalFee = siblingAnnualFee - discount;
                                
                                const localSibling = students.find(s => s.id === sibling.id);
                                if (localSibling) {
                                    localSibling.has_sibling = true;
                                    localSibling.hasSibling = true;
                                    localSibling.discount = discount;
                                    localSibling.discount_amount = discount;
                                    localSibling.final_fee = finalFee;
                                    localSibling.finalFee = finalFee;
                                }
                                
                                // تحديث في allStudents أيضاً
                                const allSibling = allStudents.find(s => s.id === sibling.id);
                                if (allSibling) {
                                    allSibling.has_sibling = true;
                                    allSibling.hasSibling = true;
                                    allSibling.discount = discount;
                                    allSibling.discount_amount = discount;
                                    allSibling.final_fee = finalFee;
                                    allSibling.finalFee = finalFee;
                                }
                                
                                // حفظ التحديثات في Supabase
                                if (supabaseClient && databaseAvailable && sibling.id && !sibling.id.toString().startsWith('temp_')) {
                                    const updatePromise = saveStudentToDB({
                                        ...sibling,
                                        has_sibling: true,
                                        hasSibling: true,
                                        discount: discount,
                                        discount_amount: discount,
                                        final_fee: finalFee,
                                        finalFee: finalFee
                                    }).catch(error => {
                                        console.error(`خطأ في تحديث الإخ ${sibling.name}:`, error);
                                        // إضافة إلى قائمة الانتظار إذا فشلت العملية
                                        if (!databaseAvailable) {
                                            addToOfflineQueue({
                                                type: 'update',
                                                table: 'students',
                                                data: {
                                                    has_sibling: true,
                                                    discount_amount: discount,
                                                    final_fee: finalFee
                                                },
                                                filters: { id: sibling.id }
                                            });
                                        }
                                    });
                                    updatePromises.push(updatePromise);
                                }
                            });
                            
                            // انتظار اكتمال جميع عمليات الحفظ
                            if (updatePromises.length > 0) {
                                try {
                                    await Promise.allSettled(updatePromises);
                                } catch (error) {
                                    console.error('خطأ في حفظ تحديثات الإخوة:', error);
                                }
                            }
                            
                            // حفظ التحديثات في localStorage
                            if (isAdmin) {
                                // للمدير: حفظ كل مدرسة في مفتاح منفصل
                                const updatedSchools = new Set();
                                siblingsData.forEach(s => {
                                    const schoolId = s.schoolId || s.school_id;
                                    if (schoolId) updatedSchools.add(schoolId);
                                });
                                updatedSchools.forEach(schoolId => {
                                    const schoolStudents = allStudents.filter(s => (s.schoolId || s.school_id) === schoolId);
                                    localStorage.setItem(`students_${schoolId}`, JSON.stringify(schoolStudents));
                                });
                                localStorage.setItem('allStudents', JSON.stringify(allStudents));
                            } else {
                                // للمستخدم العادي: حفظ طلاب مدرسته فقط
                                const storageKey = `students_${currentSchoolId || currentSchool?.id || 'default'}`;
                                const studentsToSave = allStudents.filter(s => 
                                    (s.schoolId || s.school_id) === (currentSchoolId || currentSchool?.id)
                                );
                                localStorage.setItem(storageKey, JSON.stringify(studentsToSave));
                            }
                            
                            // تحديث البيانات المحلية من قاعدة البيانات إذا كانت متاحة
                            if (isAdmin && supabaseClient && databaseAvailable) {
                                try {
                                    await loadData(true); // إعادة تحميل البيانات
                                } catch (error) {
                                    console.warn('خطأ في إعادة تحميل البيانات:', error);
                                }
                            }
                            
                            renderTable();
                            updateStats();
                            
                            const totalSiblings = siblingsData.length + 1;
                            const discountPercent = totalSiblings >= 3 ? '10%' : '5%';
                            showToast(`تم تفعيل خصم ${discountPercent} لجميع الإخوة (${totalSiblings} أخ/أخت)`, 'success', 'تم التفعيل');
                        }
                    }
            } else {
                    alertDiv.style.display = 'none';
            }
            } catch (error) {
                // إخفاء الأخطاء في الإنتاج
                alertDiv.style.display = 'none';
            }
        }

        
        function getFinancialStatus(student) {
            if (!student.installments || !Array.isArray(student.installments)) {
                return { status: 'غير مسدد', class: 'danger' };
            }
            
            const totalPaid = student.installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
            const finalFee = getStudentField(student, 'finalFee');
            const annualFee = getStudentField(student, 'annualFee');
            const remaining = (finalFee || annualFee || 1200000) - totalPaid;
            
            if (remaining <= 0) {
                return { status: 'مسدد', class: 'success' };
            } else if (totalPaid > 0) {
                return { status: 'جزئي', class: 'warning' };
            } else {
                return { status: 'غير مسدد', class: 'danger' };
            }
        }

        
        function applyFilters() {
            let filtered = [...allStudents];
            
            
            if (currentFilter.school !== 'all') {
                filtered = filtered.filter(s => {
                    const schoolId = s.schoolId || s.school_id || '';
                    return schoolId === currentFilter.school;
                });
            }
            
            
            if (currentFilter.grade !== 'all') {
                filtered = filtered.filter(s => s.grade === currentFilter.grade);
            }
            
            
            if (currentFilter.status !== 'all') {
                const statusMap = {
                    'paid': 'مسدد',
                    'partial': 'جزئي',
                    'unpaid': 'غير مسدد'
                };
                const targetStatus = statusMap[currentFilter.status];
                filtered = filtered.filter(s => {
                    const statusInfo = getFinancialStatus(s);
                    return statusInfo.status === targetStatus;
                });
            }
            
            students = filtered;
            renderTable();
            updateStats();
            updateFilterInfo();
        }
        
        
        function filterBySchool(schoolId) {
            currentFilter.school = schoolId;
            
            
            if (isAdmin) {
                const tabsList = document.getElementById('schoolTabs');
                if (tabsList) {
                    tabsList.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('active');
                    });
                    
                    const activeTab = schoolId === 'all' 
                        ? document.getElementById('all-schools-tab')
                        : document.getElementById(`${schoolId}-tab`);
                    
                    if (activeTab) {
                        activeTab.classList.add('active');
                    }
                }
            }
            
            applyFilters();
        }
        
        
        function filterByGrade() {
            const grade = document.getElementById('gradeFilter').value;
            currentFilter.grade = grade;
            applyFilters();
        }
        
        
        function filterByStatus() {
            const status = document.getElementById('statusFilter').value;
            currentFilter.status = status;
            applyFilters();
        }
        
        
        function clearFilters() {
            currentFilter = {
                school: 'all',
                grade: 'all',
                status: 'all'
            };
            
            document.getElementById('gradeFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            
            
            if (isAdmin) {
                document.getElementById('all-schools-tab').click();
            }
            
            applyFilters();
        }
        
        
        function updateFilterInfo() {
            const info = document.getElementById('filterInfo');
            const activeFilters = [];
            
            if (currentFilter.school !== 'all') {
                const school = schools[currentFilter.school];
                if (school) activeFilters.push(`المدرسة: ${school.name}`);
            }
            if (currentFilter.grade !== 'all') {
                activeFilters.push(`الصف: ${currentFilter.grade}`);
            }
            if (currentFilter.status !== 'all') {
                const statusNames = {
                    'paid': 'مسدد',
                    'partial': 'جزئي',
                    'unpaid': 'غير مسدد'
                };
                activeFilters.push(`الحالة: ${statusNames[currentFilter.status]}`);
            }
            
            if (activeFilters.length > 0) {
                info.textContent = `فعال: ${activeFilters.join(' | ')} | عدد النتائج: ${students.length}`;
                info.style.display = 'inline-block';
            } else {
                info.style.display = 'none';
            }
        }
        
        
        function setupSchoolTabs() {
            if (!isAdmin) return;
            
            const tabsContainer = document.getElementById('schoolTabsContainer');
            const tabsList = document.getElementById('schoolTabs');
            
            
            tabsContainer.style.display = 'block';
            
            
            const existingTabs = tabsList.querySelectorAll('.nav-item');
            if (existingTabs.length > 1) {
                
                return;
            }
            
            
            Object.keys(schools).forEach(schoolId => {
                const school = schools[schoolId];
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.setAttribute('role', 'presentation');
                
                const button = document.createElement('button');
                button.className = 'nav-link';
                button.id = `${schoolId}-tab`;
                button.setAttribute('data-bs-toggle', 'tab');
                button.setAttribute('data-bs-target', `#${schoolId}`);
                button.setAttribute('data-school', schoolId);
                button.setAttribute('type', 'button');
                button.setAttribute('role', 'tab');
                button.onclick = () => filterBySchool(schoolId);
                button.innerHTML = `<i class="bi bi-building"></i> ${school.name}`;
                
                li.appendChild(button);
                tabsList.appendChild(li);
            });
        }
        
        
        function updateGradeFilter() {
            const gradeFilter = document.getElementById('gradeFilter');
            const currentValue = gradeFilter.value;
            
            
            const allGrades = new Set();
            allStudents.forEach(student => {
                if (student.grade) {
                    allGrades.add(student.grade);
                }
            });
            
            
            if (!isAdmin && currentSchool) {
                const grades = {
                    'rawda': ['روضة'],
                    'rasoul': ['الاول ابتدائي', 'الثاني ابتدائي', 'الثالث ابتدائي', 'الرابع ابتدائي', 'الخامس ابتدائي', 'السادس ابتدائي'],
                    'noor': ['الاول ابتدائي', 'الثاني ابتدائي', 'الثالث ابتدائي', 'الرابع ابتدائي', 'الخامس ابتدائي', 'السادس ابتدائي'],
                    'nabi': ['الاول ابتدائي', 'الثاني ابتدائي', 'الثالث ابتدائي', 'الرابع ابتدائي', 'الخامس ابتدائي', 'السادس ابتدائي'],
                    'thanawiya': ['الاول متوسط', 'الثاني متوسط', 'الثالث متوسط']
                };
                
                const schoolGrades = grades[currentSchool.id] || [];
                schoolGrades.forEach(grade => allGrades.add(grade));
            }
            
            
            const sortedGrades = Array.from(allGrades).sort((a, b) => {
                const order = ['روضة', 'الاول ابتدائي', 'الثاني ابتدائي', 'الثالث ابتدائي', 'الرابع ابتدائي', 'الخامس ابتدائي', 'السادس ابتدائي', 'الاول متوسط', 'الثاني متوسط', 'الثالث متوسط'];
                const indexA = order.indexOf(a);
                const indexB = order.indexOf(b);
                return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
            });
            
            
            gradeFilter.innerHTML = '<option value="all">جميع الصفوف</option>';
            sortedGrades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeFilter.appendChild(option);
            });
            
            
            if (currentValue && Array.from(gradeFilter.options).some(opt => opt.value === currentValue)) {
                gradeFilter.value = currentValue;
            }
        }

        
        function renderTable() {
            const tbody = document.getElementById('studentsTable');
            tbody.innerHTML = '';

            
            const sortedStudents = [...students].sort((a, b) => {
                
                const statusA = getFinancialStatus(a);
                const statusB = getFinancialStatus(b);
                const statusOrder = { 'غير مسدد': 1, 'جزئي': 2, 'مسدد': 3 };
                const statusDiff = (statusOrder[statusA.status] || 99) - (statusOrder[statusB.status] || 99);
                if (statusDiff !== 0) return statusDiff;
                
                
                const gradeOrder = ['الصف الأول', 'الصف الثاني', 'الصف الثالث', 'الصف الرابع', 'الصف الخامس', 'الصف السادس', 
                                   'الصف السابع', 'الصف الثامن', 'الصف التاسع', 'الصف العاشر', 'الصف الحادي عشر', 'الصف الثاني عشر'];
                const gradeA = gradeOrder.indexOf(a.grade || '');
                const gradeB = gradeOrder.indexOf(b.grade || '');
                if (gradeA !== -1 && gradeB !== -1) {
                    if (gradeA !== gradeB) return gradeA - gradeB;
                } else if (a.grade && b.grade) {
                    const gradeDiff = (a.grade || '').localeCompare(b.grade || '', 'ar');
                    if (gradeDiff !== 0) return gradeDiff;
                }
                
                
                return (a.name || '').localeCompare(b.name || '', 'ar');
            });

            sortedStudents.forEach((student, index) => {
                
                if (!student.installments || !Array.isArray(student.installments)) {
                    if (!student.installments) {
                        student.installments = [
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' },
                            { amount: 0, status: 'unpaid' }
                        ];
                    }
                }
                
                const totalPaid = student.installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                const finalFee = getStudentField(student, 'finalFee');
                const annualFee = getStudentField(student, 'annualFee');
                const remaining = (finalFee || annualFee || 1200000) - totalPaid;
                const statusInfo = getFinancialStatus(student);
                const installmentAmount = calculateInstallmentAmount(student);
                
                const receiptNumber = getStudentField(student, 'receiptNumber');
                const annualFeeValue = Number(annualFee || finalFee || 1200000);
                const discountValue = Number(getStudentField(student, 'discount') || 0);
                
                const discountPercent = annualFeeValue > 0 ? ((discountValue / annualFeeValue) * 100).toFixed(0) : 0;
                const discountDisplay = discountValue > 0 ? `${discountValue.toLocaleString('en-US')} د.ع (${discountPercent}%)` : '0 د.ع';

                
                const installmentsHtml = student.installments.map((inst, i) => {
                    const paidAmount = inst.amount_paid || inst.amount || 0;
                    const requiredAmount = installmentAmount;
                    let status = 'unpaid';
                    let badgeClass = 'installment-unpaid';
                    
                    if (paidAmount >= requiredAmount) {
                        status = 'paid';
                        badgeClass = 'installment-paid';
                    } else if (paidAmount > 0) {
                        status = 'partial';
                        badgeClass = 'installment-partial';
                    }
                    
                    const paymentDate = inst.payment_date || inst.paymentDate || '';
                    let dateStr = '';
                    if (paymentDate) {
                        if (paymentDate.includes('-')) {
                            const dateParts = paymentDate.split('-');
                            dateStr = `${dateParts[2]}/${dateParts[1]}`;
                        } else {
                            dateStr = paymentDate;
                        }
                    }
                    
                    return `<span class="installment-badge ${badgeClass}" title="${dateStr ? 'تم الدفع في: ' + dateStr : 'غير مدفوعة'}">الدفعة ${i + 1}${dateStr ? '<br><small>' + dateStr + '</small>' : ''}</span>`;
                }).join('');

                const row = document.createElement('tr');
                const schoolNameCell = isAdmin && student.schoolName ? `<td><strong>${student.schoolName}</strong></td>` : '';
                
                
                let rowClass = '';
                if (statusInfo.status === 'غير مسدد') {
                    rowClass = 'table-warning';
                } else if (statusInfo.status === 'جزئي') {
                    rowClass = 'table-info';
                } else {
                    rowClass = 'table-success';
                }
                
                row.className = rowClass;
                row.innerHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td><strong>${receiptNumber || '---'}</strong></td>
                    <td><strong style="cursor: pointer; color: #0f766e;" onclick="showStudentDetails('${student.id}')" title="انقر لعرض التفاصيل">${student.name}</strong></td>
                    ${schoolNameCell}
                    <td>${student.guardian}</td>
                    <td>${student.grade}</td>
                    <td>${annualFeeValue.toLocaleString('en-US')} د.ع</td>
                    <td>${installmentsHtml}</td>
                    <td><strong>${remaining.toLocaleString('en-US')} د.ع</strong></td>
                    <td>${discountDisplay}</td>
                    <td><span class="badge bg-${statusInfo.class} badge-custom">${statusInfo.status}</span></td>
                    <td class="no-print">
                        <button onclick="openPaymentModal('${student.id}')" class="btn btn-success-custom btn-sm">
                            <i class="bi bi-cash-coin"></i> دفعة
                        </button>
                        <button onclick="sendWhatsAppMessage('${student.id}', 'payment')" class="btn btn-sm" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none;" title="إرسال إشعار دفع عبر واتساب">
                            📱 إشعار دفع
                        </button>
                        <button onclick="sendWhatsAppMessage('${student.id}', 'reminder')" class="btn btn-sm" style="background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: white; border: none;" title="إرسال تذكير بالدفع عبر واتساب">
                            <i class="bi bi-bell"></i> تذكير
                        </button>
                        <button onclick="editStudent('${student.id}')" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> تعديل
                        </button>
                        <button onclick="printReceipt('${student.id}')" class="btn btn-info-custom btn-sm">
                            <i class="bi bi-printer"></i> وصل
                        </button>
                        <button onclick="deleteStudent('${student.id}')" class="btn btn-danger-custom btn-sm">
                            <i class="bi bi-trash"></i> حذف
                        </button>
                    </td>
                `;
                row.setAttribute('data-search', `${student.name} ${student.guardian} ${receiptNumber || ''}`);
                tbody.appendChild(row);
            });
        }

        
        function filterStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#studentsTable tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const searchText = row.getAttribute('data-search') || '';
                if (searchText.toLowerCase().includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // إظهار عدد النتائج
            if (searchTerm) {
                const searchInfo = document.getElementById('searchInfo');
                if (!searchInfo) {
                    const info = document.createElement('div');
                    info.id = 'searchInfo';
                    info.className = 'alert alert-info mt-2';
                    info.style.display = 'inline-block';
                    document.getElementById('searchInput').parentElement.appendChild(info);
                }
                const info = document.getElementById('searchInfo');
                if (info) {
                    info.textContent = `تم العثور على ${visibleCount} نتيجة`;
                    info.style.display = visibleCount > 0 ? 'block' : 'none';
                }
            } else {
                const info = document.getElementById('searchInfo');
                if (info) info.style.display = 'none';
            }
        }
        
        // ============================================
        // البحث المتقدم
        // ============================================
        function toggleAdvancedSearch() {
            const advancedSearch = document.getElementById('advancedSearch');
            if (advancedSearch) {
                advancedSearch.classList.toggle('show');
            }
        }
        
        function applyAdvancedSearch() {
            const name = document.getElementById('advancedSearchName')?.value.toLowerCase() || '';
            const guardian = document.getElementById('advancedSearchGuardian')?.value.toLowerCase() || '';
            const phone = document.getElementById('advancedSearchPhone')?.value.toLowerCase() || '';
            const receipt = document.getElementById('advancedSearchReceipt')?.value.toLowerCase() || '';
            
            const rows = document.querySelectorAll('#studentsTable tr');
            let visibleCount = 0;
            
            rows.forEach(row => {
                const searchText = row.getAttribute('data-search') || '';
                const lowerText = searchText.toLowerCase();
                
                let matches = true;
                if (name && !lowerText.includes(name)) matches = false;
                if (guardian && !lowerText.includes(guardian)) matches = false;
                if (phone && !lowerText.includes(phone)) matches = false;
                if (receipt && !lowerText.includes(receipt)) matches = false;
                
                if (matches) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // إظهار عدد النتائج
            if (name || guardian || phone || receipt) {
                showToast(`تم العثور على ${visibleCount} نتيجة`, 'info', 'نتائج البحث');
            }
        }
        
        function clearAdvancedSearch() {
            document.getElementById('advancedSearchName').value = '';
            document.getElementById('advancedSearchGuardian').value = '';
            document.getElementById('advancedSearchPhone').value = '';
            document.getElementById('advancedSearchReceipt').value = '';
            document.getElementById('searchInput').value = '';
            filterStudents();
        }
        
        // ============================================
        // Quick Actions
        // ============================================
        function scrollToAddForm() {
            document.getElementById('addStudentForm')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            setTimeout(() => {
                document.getElementById('studentName')?.focus();
            }, 500);
        }
        
        function showUnpaidStudents() {
            document.getElementById('statusFilter').value = 'unpaid';
            filterByStatus();
            showToast('تم عرض الطلاب غير المسددين', 'info');
        }
        
        function showPartialStudents() {
            document.getElementById('statusFilter').value = 'partial';
            filterByStatus();
            showToast('تم عرض الطلاب ذوي الدفع الجزئي', 'info');
        }
        
        function showPaidStudents() {
            document.getElementById('statusFilter').value = 'paid';
            filterByStatus();
            showToast('تم عرض الطلاب المسددين', 'success');
        }

        
        function updateStats() {
            document.getElementById('totalStudents').textContent = students.length;
            
            let totalFees = 0;
            let totalPaid = 0;
            
            students.forEach(student => {
                const finalFee = getStudentField(student, 'finalFee');
                const annualFee = getStudentField(student, 'annualFee');
                const fee = finalFee || annualFee || 1200000;
                totalFees += fee;
                
                
                if (student.installments && Array.isArray(student.installments)) {
                    totalPaid += student.installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                } else if (student.paid) {
                totalPaid += student.paid;
                }
            });
            
            document.getElementById('totalFees').textContent = totalFees.toLocaleString('en-US') + ' د.ع';
            document.getElementById('totalPaid').textContent = totalPaid.toLocaleString('en-US') + ' د.ع';
            document.getElementById('totalRemaining').textContent = (totalFees - totalPaid).toLocaleString('en-US') + ' د.ع';
        }

        
        function openPaymentModal(studentId) {
            // فتح نافذة الدفع
            const student = students.find(s => s.id === studentId);
            if (!student) {
                showToast('الطالب غير موجود', 'error', 'خطأ');
                return;
            }
            
            
            if (!student.installments || !Array.isArray(student.installments)) {
                showToast('البيانات غير صحيحة. الرجاء تحديث البيانات.', 'error', 'خطأ');
                return;
            }
            
            document.getElementById('studentIdForPayment').value = studentId;
            document.getElementById('modalStudentName').value = student.name;
            document.getElementById('paymentDate').valueAsDate = new Date();
            
            
            const selectInstallment = document.getElementById('selectedInstallment');
            selectInstallment.innerHTML = '<option value="-1">اختر الدفعة...</option>';
            
            const installmentAmount = calculateInstallmentAmount(student);
            
            
            student.installments.forEach((inst, i) => {
                const paidAmount = inst.amount_paid || inst.amount || 0;
                const remainingForInstallment = installmentAmount - paidAmount;
                const option = document.createElement('option');
                option.value = i;
                
                if (remainingForInstallment > 0) {
                    option.textContent = `الدفعة ${i + 1} - المتبقي: ${remainingForInstallment.toLocaleString('en-US')} د.ع`;
                } else {
                    option.textContent = `الدفعة ${i + 1} - مكتملة (يمكن إضافة مبلغ إضافي)`;
                }
                
                selectInstallment.appendChild(option);
            });
            
            
            updateInstallmentsList(student);
            
            
            document.getElementById('paymentAmount').max = '';
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }

        function updatePaymentDetails() {
            const studentId = parseInt(document.getElementById('studentIdForPayment').value);
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            
            if (!student.installments || !Array.isArray(student.installments)) {
                showToast('البيانات غير صحيحة.', 'error', 'خطأ');
                return;
            }
            
            const selectedIndex = parseInt(document.getElementById('selectedInstallment').value);
            if (selectedIndex === -1) {
                document.getElementById('paymentAmount').value = '';
                document.getElementById('paymentAmount').max = '';
                return;
            }
            
            // تحديث المبلغ الأقصى المسموح
            const installmentAmount = calculateInstallmentAmount(student);
            const installment = student.installments[selectedIndex];
            const currentPaid = installment.amount_paid || installment.amount || 0;
            const remaining = installmentAmount - currentPaid;
            document.getElementById('paymentAmount').max = '';
            document.getElementById('paymentAmount').placeholder = `المتبقي: ${remaining.toLocaleString('en-US')} د.ع`;
        }

        function updateInstallmentsList(student) {
            const listDiv = document.getElementById('installmentsList');
            
            
            if (!student.installments || !Array.isArray(student.installments)) {
                listDiv.innerHTML = '<p class="text-danger">لا توجد بيانات متاحة</p>';
                return;
            }
            
            const installmentAmount = calculateInstallmentAmount(student);
            
            let html = '';
            student.installments.forEach((inst, i) => {
                const paid = inst.amount_paid || inst.amount || 0;
                const remaining = installmentAmount - paid;
                let statusClass = 'unpaid';
                
                if (paid >= installmentAmount) {
                    statusClass = 'paid';
                } else if (paid > 0) {
                    statusClass = 'partial';
                }
                
                const paymentDate = inst.payment_date || inst.paymentDate || '';
                let dateStr = '';
                if (paymentDate) {
                    if (paymentDate.includes('-')) {
                        const dateParts = paymentDate.split('-');
                        dateStr = `${dateParts[2]} / ${dateParts[1]} / ${dateParts[0]}`;
                    } else {
                        dateStr = paymentDate;
                    }
                }
                
                html += `
                    <div class="installment-item ${statusClass}">
                        <div>
                            <strong>الدفعة ${i + 1}:</strong> ${paid.toLocaleString('en-US')} / ${installmentAmount.toLocaleString('en-US')} د.ع
                            ${remaining > 0 ? `(متبقي: ${remaining.toLocaleString('en-US')} د.ع)` : '<span class="text-success">✓ مكتملة</span>'}
                            ${dateStr ? `<br><small class="text-muted">📅 ${dateStr}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            listDiv.innerHTML = html;
        }

        
        function printCurrentPayment() {
            const studentId = document.getElementById('studentIdForPayment').value;
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const selectedIndex = parseInt(document.getElementById('selectedInstallment').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentNotes = document.getElementById('paymentNotes').value;
            
            if (isNaN(selectedIndex) || selectedIndex < 0) {
                showToast('يرجى اختيار الدفعة', 'warning', 'تنبيه');
                return;
            }
            
            const installments = student.installments || [];
            const installment = installments[selectedIndex];
            
            if (!installment) {
                showToast('الدفعة غير موجودة', 'error', 'خطأ');
                return;
            }
            
            
            const paymentAmount = parseFloat(installment.amount_paid || installment.amountPaid || 0);
            
            const installmentNames = ['الاول', 'الثاني', 'الثالث', 'الرابع'];
            const installmentName = installmentNames[selectedIndex] || 'الاول';
            const receiptNumber = getStudentField(student, 'receiptNumber');
            
            
            const installmentPaymentDate = installment.payment_date || installment.paymentDate || paymentDate;
            
            let formattedDate = paymentDate;
            if (paymentDate.includes('-')) {
                const dateParts = paymentDate.split('-');
                formattedDate = `${dateParts[2]} / ${dateParts[1]} / ${dateParts[0]}`;
            }
            
            let installmentDateStr = '';
            if (installmentPaymentDate) {
                if (installmentPaymentDate.includes('-')) {
                    const dateParts = installmentPaymentDate.split('-');
                    installmentDateStr = `${dateParts[2]} / ${dateParts[1]} / ${dateParts[0]}`;
                } else {
                    installmentDateStr = installmentPaymentDate;
                }
            }
            
            const receiptHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>وصل قبض - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Arial', 'Segoe UI', sans-serif; padding: 15px; direction: rtl; background: #e5e7eb; }
                        .receipt { background: white; max-width: 750px; margin: 0 auto; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
                        
                        .header-gradient { 
                            background: linear-gradient(180deg, #0f766e 0%, #f0fdf4 100%); 
                            padding: 30px 15px; 
                            text-align: center; 
                            position: relative;
                            overflow: hidden;
                        }
                        .header-gradient::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-image: 
                                repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 8px, transparent 8px, transparent 16px);
                            opacity: 0.3;
                        }
                        .logo-container { margin-bottom: 15px; position: relative; z-index: 1; }
                        .logo { 
                            width: 80px; 
                            height: 80px; 
                            margin: 0 auto; 
                            position: relative; 
                            display: block; 
                            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
                        }
                        .logo-svg {
                            width: 100%;
                            height: 100%;
                        }
                        .institution-name { 
                            background: white; 
                            border: 3px solid #0f766e; 
                            padding: 12px 40px; 
                            display: inline-block; 
                            border-radius: 25px; 
                            font-weight: bold; 
                            color: #1e40af; 
                            font-size: 18px; 
                            margin-top: 10px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            position: relative;
                            z-index: 1;
                        }
                        
                        .receipt-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-bottom: 2px solid #0f766e; }
                        .receipt-number { font-size: 18px; font-weight: bold; color: #1f2937; }
                        .receipt-title { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 6px 15px; border-radius: 15px; font-weight: bold; font-size: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
                        .receipt-date { font-size: 13px; font-weight: bold; color: #374151; }
                        
                        .content { padding: 15px 20px; }
                        .info-row { margin: 10px 0; display: grid; grid-template-columns: 160px 1fr; gap: 15px; align-items: center; padding: 6px 0; border-bottom: 1px solid #e5e7eb; }
                        .info-row:last-of-type { border-bottom: none; }
                        .info-row label { font-weight: bold; font-size: 14px; color: #374151; }
                        .info-value { font-size: 15px; font-weight: 600; color: #1f2937; padding: 6px 12px; background: #f9fafb; border-radius: 6px; border: 2px solid #e5e7eb; }
                        
                        .notes-section { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); padding: 12px; margin: 15px 0; border-radius: 10px; border-right: 4px solid #f59e0b; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.1); }
                        .notes-section ul { list-style: none; padding-right: 0; }
                        .notes-section li { margin: 6px 0; font-size: 12px; color: #78350f; font-weight: 500; padding-right: 20px; position: relative; }
                        .notes-section li::before { content: '✓'; position: absolute; right: 0; top: 0; color: #f59e0b; font-weight: bold; font-size: 15px; }
                        
                        .signature-section { display: flex; justify-content: space-around; margin: 20px 0 15px 0; padding-top: 15px; border-top: 2px solid #e5e7eb; }
                        .signature-box { text-align: center; min-width: 180px; }
                        .signature-box label { font-weight: bold; display: block; margin-bottom: 10px; font-size: 14px; color: #374151; }
                        .signature-line { border-bottom: 2px solid #1f2937; height: 40px; width: 180px; margin: 0 auto; position: relative; border-radius: 4px; }
                        
                        .separator { height: 2px; background: linear-gradient(90deg, transparent, #0f766e, transparent); margin: 12px 0; }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .receipt { border: none; box-shadow: none; max-width: 100%; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        <div class="header-gradient">
                            <div class="institution-name">مجموعة رسول الرحمة التعليمية</div>
                        </div>
                        
                        <div class="receipt-header">
                            <div class="receipt-number">${receiptNumber}</div>
                            <div class="receipt-title">وصل قبض</div>
                            <div class="receipt-date">التاريخ: ${formattedDate}</div>
                        </div>
                        
                        <div class="content">
                            <div class="info-row">
                                <label>استلمت من السيد ولي أمر الطالب:</label>
                                <span class="info-value">${student.guardian}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>في الصف:</label>
                                <span class="info-value">${student.grade}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>مبلغاً قدره:</label>
                                <span class="info-value">${paymentAmount.toLocaleString('en-US')} دينار عراقي</span>
                            </div>
                            
                            <div class="info-row">
                                <label>وهو القسط:</label>
                                <span class="info-value">${installmentName}</span>
                            </div>
                            
                            ${installmentDateStr ? `
                            <div class="info-row">
                                <label>تاريخ تسديد القسط:</label>
                                <span class="info-value">${installmentDateStr}</span>
                            </div>
                            ` : ''}
                            
                            <div class="info-row">
                                <label>الملاحظات:</label>
                                <span class="info-value">${paymentNotes || '---'}</span>
                            </div>
                            
                            <div class="separator"></div>
                            
                            <div class="notes-section">
                                <ul>
                                    <li>يسقط حق المطالبة بالمبلغ بعد توقيع الوصل.</li>
                                    <li>يرجى الاحتفاظ بهذا الوصل حتى نهاية العام الدراسي.</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="signature-section">
                            <div class="signature-box">
                                <label>اسم المستلم:</label>
                                <div class="signature-line"></div>
                            </div>
                            <div class="signature-box">
                                <label>التوقيع:</label>
                                <div class="signature-line"></div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(receiptHTML);
            printWindow.document.close();
            
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        
        async function processPayment() {
            try {
                const studentId = document.getElementById('studentIdForPayment').value;
                const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
                const paymentDate = document.getElementById('paymentDate').value;
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paymentNotes = Utils.sanitizeText(document.getElementById('paymentNotes').value.trim(), CONFIG.VALIDATION.NOTES_MAX_LENGTH);
                const selectedIndex = parseInt(document.getElementById('selectedInstallment').value);
                
                // التحقق من صحة المدخلات
                if (!Utils.validateAmount(paymentAmount) || paymentAmount <= 0) {
                    showToast('الرجاء إدخال مبلغ صحيح (أكبر من 0)', 'warning', 'تنبيه');
                    return;
                }
                
                if (!Utils.validateDate(paymentDate)) {
                    showToast('تاريخ الدفع غير صحيح', 'warning', 'تنبيه');
                    return;
                }
                
                if (!paymentMethod) {
                    showToast('الرجاء اختيار طريقة الدفع', 'warning', 'تنبيه');
                    return;
                }
                
                if (selectedIndex === -1 || isNaN(selectedIndex)) {
                    showToast('الرجاء اختيار دفعة صحيحة', 'warning', 'تنبيه');
                    return;
                }
                
                const student = students.find(s => s.id === studentId || s.id === parseInt(studentId));
                if (!student) {
                    showToast('الطالب غير موجود', 'error', 'خطأ');
                    return;
                }
                
                
                if (!student.installments || !Array.isArray(student.installments)) {
                    showToast('البيانات غير صحيحة.', 'error', 'خطأ');
                return;
            }
            
                if (selectedIndex === -1 || selectedIndex >= student.installments.length) {
                    showToast('الرجاء اختيار دفعة صحيحة', 'warning', 'تنبيه');
                    return;
                }
                
                const installment = student.installments[selectedIndex];
                
                const installmentAmount = calculateInstallmentAmount(student);
                const currentAmount = installment.amount_paid || installment.amount || 0;
                const newAmount = currentAmount + paymentAmount;
                
                const newStatus = newAmount >= installmentAmount ? 'paid' : 'partial';
                
                // تحديث بيانات الدفعة
                installment.amount = newAmount;
                installment.amount_paid = newAmount;
                installment.status = newStatus;
                installment.payment_date = paymentDate;
                installment.paymentDate = paymentDate;
                installment.payment_method = paymentMethod;
                installment.paymentMethod = paymentMethod;
                
                // حفظ في localStorage
                if (isAdmin) {
                    // للمدير: حفظ كل مدرسة في مفتاح منفصل
                    const studentSchoolId = student.schoolId || student.school_id;
                    if (studentSchoolId) {
                        const schoolStudents = allStudents.filter(s => (s.schoolId || s.school_id) === studentSchoolId);
                        localStorage.setItem(`students_${studentSchoolId}`, JSON.stringify(schoolStudents));
                    }
                    // أيضاً حفظ في allStudents
                    localStorage.setItem('allStudents', JSON.stringify(allStudents));
                } else {
                    // للمستخدم العادي: حفظ طلاب مدرسته فقط
                    const storageKey = `students_${currentSchoolId || currentSchool?.id || 'default'}`;
                    const studentsToSave = allStudents.filter(s => 
                        (s.schoolId || s.school_id) === (currentSchoolId || currentSchool?.id)
                    );
                    localStorage.setItem(storageKey, JSON.stringify(studentsToSave));
                }
                
                // مسح التخزين المؤقت بعد التحديث
                clearCache('students');
                clearCache('installments');
                
                
                student.lastPayment = {
                    amount: paymentAmount,
                    installmentIndex: selectedIndex,
                    paymentDate: paymentDate,
                    paymentMethod: paymentMethod,
                    notes: paymentNotes
                };
                
            renderTable();
            updateStats();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
            modal.hide();
            
            document.getElementById('paymentForm').reset();
            
                showToast(`تم تسجيل الدفعة بنجاح! المبلغ: ${paymentAmount.toLocaleString('en-US')} د.ع`, 'success', 'نجح');
                showAutoSaveIndicator();
                
                
                setTimeout(() => {
                    sendWhatsAppMessage(studentId, 'payment', {
                        amount: paymentAmount,
                        installmentNumber: selectedIndex + 1,
                        paymentDate: paymentDate
                    });
                }, 500);
            } catch (error) {
                showToast('حدث خطأ في تسجيل الدفعة: ' + (error.message || 'خطأ غير معروف'), 'error', 'خطأ');
            }
        }

        
        function printReceipt(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const installments = student.installments || [];
            const installmentNames = ['الاول', 'الثاني', 'الثالث', 'الرابع'];
            const receiptNumber = getStudentField(student, 'receiptNumber');
            
            
            const today = new Date();
            const formattedDate = `${today.getDate()} / ${today.getMonth() + 1} / ${today.getFullYear()}`;
            
            
            const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
            const annualFee = student.annualFee || student.annual_fee || 1200000;
            const discount = student.discount || 0;
            const finalFee = student.finalFee || student.final_fee || annualFee;
            const installmentAmount = finalFee / 4;
            
            const receiptHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>وصل قبض - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'Arial', 'Segoe UI', sans-serif; padding: 10px; direction: rtl; background: #e5e7eb; }
                        .receipt { background: white; max-width: 100%; margin: 0 auto; padding: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
                        
                        
                        .header-gradient { 
                            background: linear-gradient(180deg, #0f766e 0%, #f0fdf4 100%); 
                            padding: 15px 10px; 
                            text-align: center; 
                            position: relative;
                            overflow: hidden;
                        }
                        .header-gradient::before {
                            content: '';
                            position: absolute;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background-image: 
                                repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 8px, transparent 8px, transparent 16px);
                            opacity: 0.3;
                        }
                        .logo-container { margin-bottom: 5px; position: relative; z-index: 1; }
                        .logo { 
                            width: 50px; 
                            height: 50px; 
                            margin: 0 auto; 
                            position: relative; 
                            display: block; 
                            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.2));
                        }
                        .logo-svg {
                            width: 100%;
                            height: 100%;
                        }
                        .institution-name { 
                            background: white; 
                            border: 2px solid #0f766e; 
                            padding: 6px 20px; 
                            display: inline-block; 
                            border-radius: 15px; 
                            font-weight: bold; 
                            color: #1e40af; 
                            font-size: 13px; 
                            margin-top: 5px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            position: relative;
                            z-index: 1;
                        }
                        
                        
                        .receipt-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-bottom: 2px solid #0f766e; }
                        .receipt-number { font-size: 14px; font-weight: bold; color: #1f2937; }
                        .receipt-title { background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
                        .receipt-date { font-size: 11px; font-weight: bold; color: #374151; }
                        
                        
                        .content { padding: 8px 10px; }
                        .info-row { margin: 5px 0; display: grid; grid-template-columns: 120px 1fr; gap: 10px; align-items: center; padding: 3px 0; border-bottom: 1px solid #e5e7eb; }
                        .info-row:last-of-type { border-bottom: none; }
                        .info-row label { font-weight: bold; font-size: 12px; color: #374151; }
                        .info-value { font-size: 13px; font-weight: 600; color: #1f2937; padding: 4px 8px; background: #f9fafb; border-radius: 5px; border: 1px solid #e5e7eb; }
                        
                        
                        .installment-dates { margin: 15px 0; padding: 12px; background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%); border-radius: 10px; border: 2px solid #10b981; }
                        .installment-dates-title { font-weight: bold; font-size: 14px; margin-bottom: 8px; color: #065f46; }
                        .date-boxes { display: flex; gap: 10px; }
                        .date-box { width: 70px; height: 50px; background: white; border: 2px solid #10b981; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; color: #065f46; box-shadow: 0 3px 6px rgba(16, 185, 129, 0.2); }
                        
                        
                        .notes-section { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); padding: 12px; margin: 15px 0; border-radius: 10px; border-right: 4px solid #f59e0b; box-shadow: 0 3px 8px rgba(245, 158, 11, 0.1); }
                        .notes-section ul { list-style: none; padding-right: 0; }
                        .notes-section li { margin: 6px 0; font-size: 12px; color: #78350f; font-weight: 500; padding-right: 20px; position: relative; }
                        .notes-section li::before { content: '✓'; position: absolute; right: 0; top: 0; color: #f59e0b; font-weight: bold; font-size: 15px; }
                        
                        
                        .signature-section { display: flex; justify-content: space-around; margin: 20px 0 15px 0; padding-top: 15px; border-top: 2px solid #e5e7eb; }
                        .signature-box { text-align: center; min-width: 180px; }
                        .signature-box label { font-weight: bold; display: block; margin-bottom: 10px; font-size: 14px; color: #374151; }
                        .signature-line { border-bottom: 2px solid #1f2937; height: 40px; width: 180px; margin: 0 auto; position: relative; border-radius: 4px; }
                        
                        
                        .separator { height: 2px; background: linear-gradient(90deg, transparent, #0f766e, transparent); margin: 12px 0; }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .receipt { border: none; box-shadow: none; max-width: 100%; }
                        }
                    </style>
                </head>
                <body>
                    <div class="receipt">
                        
                        <div class="header-gradient">
                            <div class="logo-container">
                                <div class="logo"></div>
                        </div>
                            <div class="institution-name">مجموعة رسول الرحمة التعليمية</div>
                        </div>
                        
                        
                        <div class="receipt-header">
                            <div class="receipt-number">${receiptNumber}</div>
                            <div class="receipt-title">وصل قبض</div>
                            <div class="receipt-date">التاريخ: ${formattedDate}</div>
                        </div>
                        
                        
                        <div class="content">
                            <div class="info-row">
                                <label>اسم الطالب:</label>
                                <span class="info-value">${student.name}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>ولي الأمر:</label>
                                <span class="info-value">${student.guardian}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>الصف:</label>
                                <span class="info-value">${student.grade}</span>
                            </div>
                            
                            <div class="info-row">
                                <label>المبلغ السنوي:</label>
                                <span class="info-value">${annualFee.toLocaleString('en-US')} د.ع</span>
                            </div>
                            
                            <div class="info-row">
                                <label>الخصم:</label>
                                <span class="info-value">${discount.toLocaleString('en-US')} د.ع</span>
                            </div>
                            
                            <div class="info-row">
                                <label>إجمالي المطلوب:</label>
                                <span class="info-value">${finalFee.toLocaleString('en-US')} د.ع</span>
                            </div>
                            
                            <div class="separator"></div>
                            
                            
                            <div class="installments-table" style="margin: 8px 0;">
                                <h6 style="font-weight: bold; margin-bottom: 5px; font-size: 11px;">تفاصيل الدفعات:</h6>
                                <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
                                    <thead>
                                        <tr style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                                            <th style="padding: 5px 3px; border: 1px solid #ddd; font-size: 9px;">الدفعة</th>
                                            <th style="padding: 5px 3px; border: 1px solid #ddd; font-size: 9px;">المطلوب</th>
                                            <th style="padding: 5px 3px; border: 1px solid #ddd; font-size: 9px;">المدفوع</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${installments.map((inst, i) => {
                                            const paid = inst.amount_paid || inst.amount || 0;
                                            const required = installmentAmount;
                                            return `
                                                <tr>
                                                    <td style="padding: 4px 2px; border: 1px solid #ddd; font-size: 8px;">${installmentNames[i]}</td>
                                                    <td style="padding: 4px 2px; border: 1px solid #ddd; font-size: 8px;">${required.toLocaleString('en-US')} د.ع</td>
                                                    <td style="padding: 4px 2px; border: 1px solid #ddd; font-size: 8px;">${paid.toLocaleString('en-US')} د.ع</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                    <tfoot>
                                        <tr style="background: #f3f4f6; font-weight: bold;">
                                            <td style="padding: 5px 3px; border: 1px solid #333; font-size: 9px;">الإجمالي</td>
                                            <td style="padding: 5px 3px; border: 1px solid #333; font-size: 9px;">${finalFee.toLocaleString('en-US')} د.ع</td>
                                            <td style="padding: 5px 3px; border: 1px solid #333; font-size: 9px;">${totalPaid.toLocaleString('en-US')} د.ع</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <div class="separator" style="margin: 5px 0;"></div>
                            
                            <div class="info-row" style="background: #fff3cd; padding: 5px 8px; border-radius: 5px; border: 2px solid #f59e0b; margin: 5px 0;">
                                <label style="font-size: 12px; color: #856404;">المجموع المتبقي:</label>
                                <span class="info-value" style="font-size: 13px; color: #856404;">${(finalFee - totalPaid).toLocaleString('en-US')} د.ع</span>
                            </div>
                            
                            <div class="separator"></div>
                            
                            
                            <div class="notes-section" style="padding: 6px; margin: 5px 0; font-size: 9px;">
                                <ul style="margin: 0; padding-right: 0;">
                                    <li style="margin: 3px 0; padding-right: 15px; font-size: 9px;">يسقط حق المطالبة بالمبلغ بعد توقيع الوصل.</li>
                                    <li style="margin: 3px 0; padding-right: 15px; font-size: 9px;">يرجى الاحتفاظ بهذا الوصل حتى نهاية العام الدراسي.</li>
                                </ul>
                            </div>
                        </div>
                        
                        
                        <div class="signature-section" style="display: flex; justify-content: space-around; margin: 8px 0 5px 0; padding-top: 5px; border-top: 2px solid #e5e7eb;">
                            <div class="signature-box" style="text-align: center; min-width: 140px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 5px; font-size: 11px; color: #374151;">اسم المستلم:</label>
                                <div class="signature-line" style="border-bottom: 2px solid #1f2937; height: 25px; width: 140px; margin: 0 auto; position: relative; border-radius: 4px;"></div>
                            </div>
                            <div class="signature-box" style="text-align: center; min-width: 140px;">
                                <label style="font-weight: bold; display: block; margin-bottom: 5px; font-size: 11px; color: #374151;">التوقيع:</label>
                                <div class="signature-line" style="border-bottom: 2px solid #1f2937; height: 25px; width: 140px; margin: 0 auto; position: relative; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(receiptHTML);
            printWindow.document.close();
            printWindow.print();
        }

        
        async function deleteStudent(studentId) {
            const confirmed = await showConfirmDialog('هل أنت متأكد من حذف هذا الطالب؟', 'تأكيد الحذف', 'نعم، احذف', 'إلغاء');
            if (!confirmed) return;
            
            try {
                showLoading();
                
                // حذف من قاعدة البيانات
                await deleteStudentFromDB(studentId);
                
                // حذف الطالب من القوائم المحلية
                students = students.filter(s => s.id !== studentId && s.id !== parseInt(studentId));
                allStudents = allStudents.filter(s => s.id !== studentId && s.id !== parseInt(studentId));
                
                // تحديث التخزين المؤقت
                clearCache('students');
                clearCache('installments');
                
                // تحديث الواجهة
                hideLoading();
                renderTable();
                updateStats();
                
                showToast('تم حذف الطالب بنجاح', 'success', 'نجح');
                showAutoSaveIndicator();
            } catch (error) {
                hideLoading();
                showToast('حدث خطأ في حذف الطالب: ' + (error.message || 'خطأ غير معروف'), 'error', 'خطأ');
            }
        }

        
        async function saveData() {
            // مسح التخزين المؤقت عند الحفظ
            clearCache('students');
            clearCache('installments');
            
            try {
                localStorage.setItem('students', JSON.stringify(allStudents));
                localStorage.setItem('lastSave', new Date().toISOString());
            } catch (error) {
                console.error('خطأ في حفظ البيانات:', error);
            }
        }
        
        // Auto-save كل 30 ثانية
        setInterval(() => {
            if (allStudents && allStudents.length > 0) {
                saveData();
            }
        }, 30000);

        
        function migrateOldData(studentsData) {
            let counter = 1;
            return studentsData.map((student, index) => {
                
                if (!student.receiptNumber) {
                    student.receiptNumber = String(counter++).padStart(6, '0');
                }
                
                
                if (!student.installments && student.paid !== undefined) {
                    const annualFee = student.annualFee || student.monthlyFee * 12 || 1200000;
                    const hasSibling = student.hasSibling || false;
                    
                    
                    let finalFee = annualFee;
                    let discountAmount = 0;
                    
                    if (hasSibling) {
                        discountAmount = annualFee * SIBLING_DISCOUNT_RATE;
                        finalFee = annualFee - discountAmount;
                    }
                    
                    
                    const installmentAmount = finalFee / INSTALLMENT_COUNT;
                    const paidAmount = student.paid || 0;
                    const installments = [];
                    
                    let remainingPaid = paidAmount;
                    
                    for (let i = 0; i < INSTALLMENT_COUNT; i++) {
                        if (remainingPaid >= installmentAmount) {
                            installments.push({ amount: installmentAmount, status: 'paid' });
                            remainingPaid -= installmentAmount;
                        } else if (remainingPaid > 0) {
                            installments.push({ amount: remainingPaid, status: 'partial' });
                            remainingPaid = 0;
                        } else {
                            installments.push({ amount: 0, status: 'unpaid' });
                        }
                    }
                    
                    return {
                        ...student,
                        annualFee: annualFee,
                        finalFee: finalFee,
                        hasSibling: hasSibling,
                        discount: discountAmount,
                        installments: installments
                    };
                }
                
                
                if (!student.installments) {
                    const installmentAmount = calculateInstallmentAmount(student);
                    student.installments = [
                        { amount: 0, status: 'unpaid' },
                        { amount: 0, status: 'unpaid' },
                        { amount: 0, status: 'unpaid' },
                        { amount: 0, status: 'unpaid' }
                    ];
                }
                
                return student;
            });
        }

        
        // ============================================
        // دوال Supabase - الطلاب
        // ============================================
        async function loadStudentsFromDB(schoolId = null) {
            if (!supabaseClient) {
                // Fallback إلى localStorage إذا لم يكن Supabase متاحاً
                return loadStudentsFromLocalStorage(schoolId);
            }
            
            try {
                // دائماً تحميل جميع الطلاب ثم الفلترة محلياً
                // هذا يتجنب مشاكل نوع البيانات (UUID vs TEXT)
                const { data: allData, error: allError } = await supabaseClient
                    .from('students')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (allError) {
                    console.error('خطأ في تحميل الطلاب:', allError);
                    throw allError;
                }
                
                // فلترة محلياً حسب school_id
                if (schoolId && schoolId !== 'admin' && allData) {
                    const filtered = allData.filter(s => {
                        // التعامل مع UUID و TEXT
                        const sSchoolId = s.school_id ? String(s.school_id) : null;
                        const targetSchoolId = String(schoolId);
                        return sSchoolId === targetSchoolId;
                    });
                    return filtered || [];
                }
                
                return allData || [];
            } catch (error) {
                console.error('خطأ في تحميل الطلاب:', error);
                
                // إذا كان الخطأ متعلق بقاعدة البيانات، جرب localStorage
                if (error.code === '22P02' || error.message?.includes('uuid') || error.message?.includes('Failed to fetch')) {
                    console.warn('خطأ في قاعدة البيانات، جاري تحميل من localStorage...');
                    return loadStudentsFromLocalStorage(schoolId);
                }
                
                showToast('خطأ في تحميل البيانات من قاعدة البيانات', 'error', 'خطأ');
                return loadStudentsFromLocalStorage(schoolId);
            }
        }
        
        async function saveStudentToDB(student) {
            // حفظ في localStorage دائماً كنسخة احتياطية
            const savedStudent = saveStudentToLocalStorage(student);
            
            if (!supabaseClient || !databaseAvailable) {
                // إضافة إلى قائمة الانتظار إذا كانت قاعدة البيانات غير متاحة
                if (!databaseAvailable) {
                    // بيانات للقائمة المحلية (الأعمدة الأساسية فقط)
                    const studentData = {
                        name: student.name,
                        grade: student.grade,
                        phone: student.phone || null,
                        school_id: student.schoolId || student.school_id,
                        annual_fee: student.annualFee || student.annual_fee || 0,
                        receipt_number: student.receiptNumber || student.receipt_number || null,
                        registration_date: student.registrationDate || student.registration_date || new Date().toISOString().split('T')[0],
                        notes: student.notes || null,
                        installments: JSON.stringify(student.installments || [])
                    };
                    
                    // إضافة الأعمدة الاختيارية فقط إذا كانت موجودة
                    if (student.guardianName || student.guardian_name) {
                        studentData.guardian_name = student.guardianName || student.guardian_name;
                    }
                    if (student.motherName || student.mother_name) {
                        studentData.mother_name = student.motherName || student.mother_name;
                    }
                    if (student.finalFee !== undefined || student.final_fee !== undefined) {
                        studentData.final_fee = student.finalFee || student.final_fee;
                    }
                    if (student.hasSibling !== undefined || student.has_sibling !== undefined) {
                        studentData.has_sibling = student.hasSibling || student.has_sibling || false;
                    }
                    
                    if (student.id && !student.id.toString().startsWith('temp_')) {
                        addToOfflineQueue({
                            type: 'update',
                            table: 'students',
                            data: studentData,
                            filters: { id: student.id }
                        });
                    } else {
                        addToOfflineQueue({
                            type: 'insert',
                            table: 'students',
                            data: studentData
                        });
                    }
                    
                    showToast('تم حفظ الطالب محلياً، سيتم المزامنة تلقائياً عند عودة قاعدة البيانات', 'info', 'حفظ محلي');
                }
                return savedStudent;
            }
            
            try {
                // دالة مساعدة لإزالة الأعمدة التي تسبب مشاكل في schema cache
                const removeProblematicColumns = (data, error) => {
                    if (!error || error.code !== 'PGRST204') return data;
                    
                    const problematicColumns = [
                        'guardian_name', 'mother_name', 'discount_amount', 
                        'discount_percentage', 'final_fee', 'has_sibling',
                        'status', 'is_active', 'created_by', 'updated_by'
                    ];
                    
                    const cleanedData = { ...data };
                    problematicColumns.forEach(col => {
                        if (error.message?.includes(col)) {
                            delete cleanedData[col];
                        }
                    });
                    
                    return cleanedData;
                };
                
                // بناء بيانات الطالب الأساسية (الأعمدة المضمونة)
                // ملاحظة: installments قد لا يكون موجوداً في قاعدة البيانات، سيتم حفظه في عمود منفصل أو JSON
                const baseStudentData = {
                    name: student.name,
                    grade: student.grade,
                    phone: student.phone || null,
                    school_id: student.schoolId || student.school_id,
                    annual_fee: student.annualFee || student.annual_fee || 0,
                    receipt_number: student.receiptNumber || student.receipt_number || null,
                    registration_date: student.registrationDate || student.registration_date || new Date().toISOString().split('T')[0],
                    notes: student.notes || null
                };
                
                // إضافة installments فقط إذا كان موجوداً في قاعدة البيانات
                // سيتم تجربته أولاً، وإذا فشل سيتم حفظه في notes أو عمود منفصل
                
                // إضافة الأعمدة الاختيارية (قد لا تكون موجودة في schema cache)
                const optionalFields = {
                    guardian_name: student.guardianName || student.guardian_name,
                    mother_name: student.motherName || student.mother_name,
                    final_fee: student.finalFee || student.final_fee || (student.annualFee || student.annual_fee || 0),
                    has_sibling: student.hasSibling || student.has_sibling || false,
                    discount_amount: student.discountAmount || student.discount_amount,
                    created_at: student.created_at || new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // دمج البيانات
                let studentData = { ...baseStudentData };
                Object.keys(optionalFields).forEach(key => {
                    if (optionalFields[key] !== undefined && optionalFields[key] !== null) {
                        studentData[key] = optionalFields[key];
                    }
                });
                
                // installments محفوظ بالفعل في notes، لا نحتاج لإضافته كعمود منفصل
                
                if (student.id && !student.id.toString().startsWith('temp_')) {
                    // تحديث طالب موجود
                    let { data, error } = await supabaseClient
                        .from('students')
                        .update(studentData)
                        .eq('id', student.id)
                        .select()
                        .single();
                    
                    // إذا كان الخطأ متعلق بأعمدة غير موجودة، جرب بدونها
                    if (error && error.code === 'PGRST204') {
                        const cleanedData = removeProblematicColumns(studentData, error);
                        const retryResult = await supabaseClient
                            .from('students')
                            .update(cleanedData)
                            .eq('id', student.id)
                            .select()
                            .single();
                        if (retryResult.error) throw retryResult.error;
                        // استخراج installments من notes بعد الحفظ
                        if (retryResult.data && retryResult.data.notes) {
                            const installments = extractInstallmentsFromNotes(retryResult.data.notes);
                            if (installments) {
                                retryResult.data.installments = installments;
                            }
                        }
                        return retryResult.data;
                    }
                    
                    if (error) throw error;
                    // استخراج installments من notes بعد الحفظ
                    if (data && data.notes) {
                        const installments = extractInstallmentsFromNotes(data.notes);
                        if (installments) {
                            data.installments = installments;
                        }
                    }
                    return data;
                } else {
                    // إضافة طالب جديد
                    let { data, error } = await supabaseClient
                        .from('students')
                        .insert(studentData)
                        .select()
                        .single();
                    
                    // إذا كان الخطأ متعلق بأعمدة غير موجودة، جرب بدونها
                    if (error && error.code === 'PGRST204') {
                        const cleanedData = removeProblematicColumns(studentData, error);
                        const retryResult = await supabaseClient
                            .from('students')
                            .insert(cleanedData)
                            .select()
                            .single();
                        if (retryResult.error) throw retryResult.error;
                        // استخراج installments من notes بعد الحفظ
                        if (retryResult.data && retryResult.data.notes) {
                            const installments = extractInstallmentsFromNotes(retryResult.data.notes);
                            if (installments) {
                                retryResult.data.installments = installments;
                            }
                        }
                        return retryResult.data;
                    }
                    
                    if (error) throw error;
                    // استخراج installments من notes بعد الحفظ
                    if (data && data.notes) {
                        const installments = extractInstallmentsFromNotes(data.notes);
                        if (installments) {
                            data.installments = installments;
                        }
                    }
                    return data;
                }
            } catch (error) {
                console.error('خطأ في حفظ الطالب:', error);
                
                // عرض تفاصيل الخطأ في Console للمساعدة في التشخيص
                if (error.message) {
                    console.error('رسالة الخطأ:', error.message);
                }
                if (error.code) {
                    console.error('رمز الخطأ:', error.code);
                }
                if (error.details) {
                    console.error('تفاصيل الخطأ:', error.details);
                }
                if (error.hint) {
                    console.error('تلميح:', error.hint);
                }
                
                // التحقق من نوع الخطأ
                const isDatabaseError = error.message && (
                    error.message.includes('Failed to fetch') ||
                    error.message.includes('timeout') ||
                    error.message.includes('503') ||
                    error.message.includes('502') ||
                    error.message.includes('504') ||
                    error.message.includes('500') ||
                    error.message.includes('network')
                );
                
                // إذا كان الخطأ متعلقاً بأعمدة غير موجودة في قاعدة البيانات
                if (error.code === 'PGRST204' || error.message?.includes('column') || error.message?.includes('does not exist')) {
                    console.warn('⚠️ بعض الأعمدة غير موجودة في قاعدة البيانات، سيتم حفظ البيانات الأساسية فقط');
                    // محاولة الحفظ بدون الأعمدة الاختيارية
                    try {
                        const basicData = {
                            name: student.name,
                            grade: student.grade,
                            phone: student.phone || null,
                            school_id: student.schoolId || student.school_id,
                            annual_fee: student.annualFee || student.annual_fee || 0,
                            receipt_number: student.receiptNumber || student.receipt_number || null,
                            registration_date: student.registrationDate || student.registration_date || new Date().toISOString().split('T')[0],
                            notes: student.notes || null
                        };
                        
                        // حفظ installments في notes إذا لم يكن موجوداً كعمود منفصل
                        if (student.installments && Array.isArray(student.installments) && student.installments.length > 0) {
                            const installmentsJson = JSON.stringify(student.installments);
                            basicData.notes = (basicData.notes || '') + (basicData.notes ? '\n\n' : '') + `[INSTALLMENTS]${installmentsJson}[/INSTALLMENTS]`;
                        }
                        
                        if (student.id && !student.id.toString().startsWith('temp_')) {
                            const { data, error: updateError } = await supabaseClient
                                .from('students')
                                .update(basicData)
                                .eq('id', student.id)
                                .select()
                                .single();
                            if (updateError) throw updateError;
                            return data;
                        } else {
                            const { data, error: insertError } = await supabaseClient
                                .from('students')
                                .insert(basicData)
                                .select()
                                .single();
                            if (insertError) throw insertError;
                            return data;
                        }
                    } catch (retryError) {
                        console.error('خطأ في إعادة المحاولة:', retryError);
                        // الاستمرار في المعالجة العادية
                    }
                }
                
                if (isDatabaseError) {
                    databaseAvailable = false;
                    
                    // إضافة إلى قائمة الانتظار (الأعمدة الأساسية فقط)
                    const studentData = {
                        name: student.name,
                        grade: student.grade,
                        phone: student.phone || null,
                        school_id: student.schoolId || student.school_id,
                        annual_fee: student.annualFee || student.annual_fee || 0,
                        receipt_number: student.receiptNumber || student.receipt_number || null,
                        registration_date: student.registrationDate || student.registration_date || new Date().toISOString().split('T')[0],
                        notes: student.notes || null,
                        installments: JSON.stringify(student.installments || [])
                    };
                    
                    // إضافة الأعمدة الاختيارية فقط إذا كانت موجودة
                    if (student.guardianName || student.guardian_name) {
                        studentData.guardian_name = student.guardianName || student.guardian_name;
                    }
                    if (student.motherName || student.mother_name) {
                        studentData.mother_name = student.motherName || student.mother_name;
                    }
                    if (student.finalFee !== undefined || student.final_fee !== undefined) {
                        studentData.final_fee = student.finalFee || student.final_fee;
                    }
                    if (student.hasSibling !== undefined || student.has_sibling !== undefined) {
                        studentData.has_sibling = student.hasSibling || student.has_sibling || false;
                    }
                    
                    if (student.id && !student.id.toString().startsWith('temp_')) {
                        addToOfflineQueue({
                            type: 'update',
                            table: 'students',
                            data: studentData,
                            filters: { id: student.id }
                        });
                    } else {
                        addToOfflineQueue({
                            type: 'insert',
                            table: 'students',
                            data: studentData
                        });
                    }
                    
                    showToast('تم حفظ الطالب محلياً، سيتم المزامنة تلقائياً عند عودة قاعدة البيانات', 'warning', 'حفظ محلي');
                } else {
                    showToast('خطأ في حفظ الطالب في قاعدة البيانات', 'error', 'خطأ');
                }
                
                return savedStudent;
            }
        }
        
        async function deleteStudentFromDB(studentId) {
            // حذف من localStorage دائماً
            const deleted = deleteStudentFromLocalStorage(studentId);
            
            if (!supabaseClient) {
                return deleted;
            }
            
            if (!databaseAvailable) {
                // إضافة إلى قائمة الانتظار إذا كانت قاعدة البيانات غير متاحة
                addToOfflineQueue({
                    type: 'delete',
                    table: 'students',
                    data: {},
                    filters: { id: studentId }
                });
                showToast('تم حذف الطالب محلياً، سيتم المزامنة تلقائياً عند عودة قاعدة البيانات', 'info', 'حذف محلي');
                return deleted;
            }
            
            try {
                const { error } = await supabaseClient
                    .from('students')
                    .delete()
                    .eq('id', studentId);
                
                if (error) throw error;
                return true;
            } catch (error) {
                console.error('خطأ في حذف الطالب:', error);
                
                // التحقق من نوع الخطأ
                const isDatabaseError = error.message && (
                    error.message.includes('Failed to fetch') ||
                    error.message.includes('timeout') ||
                    error.message.includes('503') ||
                    error.message.includes('502') ||
                    error.message.includes('504') ||
                    error.message.includes('500') ||
                    error.message.includes('network')
                );
                
                if (isDatabaseError) {
                    databaseAvailable = false;
                    
                    // إضافة إلى قائمة الانتظار
                    addToOfflineQueue({
                        type: 'delete',
                        table: 'students',
                        data: {},
                        filters: { id: studentId }
                    });
                    
                    showToast('تم حذف الطالب محلياً، سيتم المزامنة تلقائياً عند عودة قاعدة البيانات', 'warning', 'حذف محلي');
                } else {
                    showToast('خطأ في حذف الطالب من قاعدة البيانات', 'error', 'خطأ');
                }
                
                return deleted;
            }
        }
        
        // ============================================
        // Fallback إلى localStorage
        // ============================================
        function loadStudentsFromLocalStorage(schoolId = null) {
            if (isAdmin) {
                allStudents = [];
                Object.keys(schools).forEach(sid => {
                    const schoolData = localStorage.getItem(`students_${sid}`);
                    if (schoolData) {
                        try {
                            const parsed = JSON.parse(schoolData);
                            if (Array.isArray(parsed)) {
                                allStudents = allStudents.concat(parsed);
                            }
                        } catch (e) {
                            console.error(`خطأ في قراءة بيانات ${sid}:`, e);
                        }
                    }
                });
                return allStudents;
            } else if (schoolId) {
                const schoolData = localStorage.getItem(`students_${schoolId}`);
                if (schoolData) {
                    try {
                        return JSON.parse(schoolData);
                    } catch (e) {
                        console.error('خطأ في قراءة البيانات:', e);
                    }
                }
            }
            return [];
        }
        
        function saveStudentToLocalStorage(student) {
            const schoolId = student.schoolId || student.school_id;
            if (!schoolId) return student;
            
            let schoolStudents = loadStudentsFromLocalStorage(schoolId);
            const existingIndex = schoolStudents.findIndex(s => s.id === student.id);
            
            if (existingIndex >= 0) {
                schoolStudents[existingIndex] = student;
            } else {
                schoolStudents.push(student);
            }
            
            localStorage.setItem(`students_${schoolId}`, JSON.stringify(schoolStudents));
            
            if (isAdmin) {
                allStudents = [];
                Object.keys(schools).forEach(sid => {
                    const data = localStorage.getItem(`students_${sid}`);
                    if (data) {
                        try {
                            allStudents = allStudents.concat(JSON.parse(data));
                        } catch (e) {}
                    }
                });
                localStorage.setItem('allStudents', JSON.stringify(allStudents));
            }
            
            return student;
        }
        
        function deleteStudentFromLocalStorage(studentId) {
            Object.keys(schools).forEach(schoolId => {
                let schoolStudents = loadStudentsFromLocalStorage(schoolId);
                schoolStudents = schoolStudents.filter(s => s.id !== studentId);
                localStorage.setItem(`students_${schoolId}`, JSON.stringify(schoolStudents));
            });
            
            if (isAdmin) {
                allStudents = allStudents.filter(s => s.id !== studentId);
                localStorage.setItem('allStudents', JSON.stringify(allStudents));
            }
            
            return true;
        }
        
        
        // دالة للتحقق من تكامل البيانات بين المدارس
        function validateDataIntegrity(studentsList) {
            const issues = [];
            
            if (!studentsList || !Array.isArray(studentsList)) {
                return issues;
            }
            
            studentsList.forEach((student, index) => {
                try {
                    // التحقق من وجود school_id
                    if (!student.school_id && !student.schoolId) {
                        issues.push({
                            type: 'missing_school_id',
                            student: student.name || 'غير معروف',
                            index: index,
                            message: `الطالب ${student.name || 'غير معروف'} لا يحتوي على معرف المدرسة`
                        });
                    }
                    
                    // التحقق من صحة school_id
                    if (student.school_id || student.schoolId) {
                        const schoolId = student.school_id || student.schoolId;
                        if (schoolId && schoolId !== 'admin' && typeof schools !== 'undefined' && !schools[schoolId]) {
                            issues.push({
                                type: 'invalid_school_id',
                                student: student.name || 'غير معروف',
                                schoolId: schoolId,
                                message: `الطالب ${student.name || 'غير معروف'} يحتوي على معرف مدرسة غير صحيح: ${schoolId}`
                            });
                        }
                    }
                    
                    // التحقق من صحة الحسابات المالية
                    if (student.installments && Array.isArray(student.installments)) {
                        try {
                            const totalPaid = student.installments.reduce((sum, inst) => {
                                const paid = parseFloat(inst.amount_paid || inst.amount || 0);
                                return sum + (isNaN(paid) ? 0 : paid);
                            }, 0);
                            const finalFee = parseFloat(getStudentField(student, 'finalFee') || 0);
                            const annualFee = parseFloat(getStudentField(student, 'annualFee') || 0);
                            const expectedFinalFee = finalFee || annualFee || 1200000;
                            
                            if (!isNaN(totalPaid) && !isNaN(expectedFinalFee) && totalPaid > expectedFinalFee * 1.1) { // السماح بخطأ 10%
                                issues.push({
                                    type: 'calculation_error',
                                    student: student.name || 'غير معروف',
                                    totalPaid: totalPaid,
                                    expectedFee: expectedFinalFee,
                                    message: `الطالب ${student.name || 'غير معروف'} لديه مبلغ مدفوع (${totalPaid.toLocaleString('en-US')}) أكبر من المبلغ المطلوب (${expectedFinalFee.toLocaleString('en-US')})`
                                });
                            }
                        } catch (calcError) {
                            console.warn('خطأ في حساب البيانات المالية للطالب:', student.name, calcError);
                        }
                    }
                } catch (studentError) {
                    console.warn(`خطأ في التحقق من طالب في الفهرس ${index}:`, studentError);
                }
            });
            
            return issues;
        }
        
        async function loadData(forceRefresh = false) {
            if (!currentSchool && !isAdmin) return;
            
            try {
                if (!forceRefresh) {
                    const cachedStudents = getCachedData('students');
                    if (cachedStudents && Array.isArray(cachedStudents) && cachedStudents.length > 0) {
                        students = cachedStudents;
                        allStudents = [...students];
                        updateStats();
                        renderTable();
                        return;
                    }
                }
                
                showLoading();
                const schoolId = isAdmin ? null : (currentSchoolId || currentSchool?.id);
                const loadedStudents = await loadStudentsFromDB(schoolId);
                
                if (isAdmin) {
                    allStudents = loadedStudents;
                    students = allStudents;
                } else {
                    students = loadedStudents;
                allStudents = [...students];
                }
                
                setCachedData('students', students);
                
                students = migrateOldData(students);
                allStudents = migrateOldData(allStudents);
                
                // التحقق من تكامل البيانات
                if (isAdmin && allStudents.length > 0) {
                    try {
                        const integrityIssues = validateDataIntegrity(allStudents);
                        if (integrityIssues.length > 0) {
                            console.warn('تم اكتشاف مشاكل في تكامل البيانات:', integrityIssues);
                            // عرض تفاصيل المشاكل في Console
                            integrityIssues.forEach((issue, index) => {
                                console.warn(`مشكلة ${index + 1}:`, issue);
                            });
                            // يمكن إظهار تنبيه للمدير إذا لزم الأمر
                            if (integrityIssues.length > 10) {
                                showToast(`تم اكتشاف ${integrityIssues.length} مشكلة في تكامل البيانات. راجع Console للتفاصيل`, 'warning', 'تنبيه');
                            }
                        }
                    } catch (validationError) {
                        console.error('خطأ في التحقق من تكامل البيانات:', validationError);
                    }
                }
                
                if (students.length > 0) {
                    const maxReceiptNumber = Math.max(...students.map(s => {
                        const num = parseInt(s.receipt_number || s.receiptNumber) || 0;
                        return isNaN(num) ? 0 : num;
                    }));
                    receiptCounter = maxReceiptNumber + 1;
                }
                
                if (isAdmin) {
                    setupSchoolTabs();
                }
                
                hideLoading();
                updateStats();
                renderTable();
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                hideLoading();
                showToast('حدث خطأ في تحميل البيانات', 'error', 'خطأ');
            }
        }

        
        function showLoginModal() {
            try {
                // إخفاء الواجهة الرئيسية والـ sidebar
                const mainContentEl = document.getElementById('mainContent');
                const sidebarEl = document.getElementById('sidebar');
                if (mainContentEl) mainContentEl.style.display = 'none';
                if (sidebarEl) sidebarEl.style.display = 'none';
                
                const loginModalElement = document.getElementById('loginModal');
                const backdropElement = document.getElementById('loginModalBackdrop');
                if (loginModalElement) {
                    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                        const loginModal = new bootstrap.Modal(loginModalElement, { backdrop: 'static', keyboard: false });
                        loginModal.show();
                    } else {
                        // Fallback إذا لم يكن Bootstrap جاهزاً
                        if (backdropElement) {
                            backdropElement.style.display = 'block';
                        }
                        loginModalElement.style.display = 'block';
                        loginModalElement.classList.add('show');
                        document.body.classList.add('modal-open');
                    }
                }
            } catch (e) {
                // إخفاء الأخطاء في الإنتاج
            }
        }

        
        async function logout() {
            const confirmed = await showConfirmDialog('هل أنت متأكد من تسجيل الخروج؟', 'تأكيد الخروج', 'نعم، سجل خروج', 'إلغاء');
            if (confirmed) {
                
                localStorage.removeItem('currentLogin');
                currentSchool = null;
                isAdmin = false;
                students = [];
                document.getElementById('mainContent').style.display = 'none';
                location.reload();
            }
        }

        
        function exportData() {
            const dataStr = JSON.stringify(students, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `students_data_${new Date().getTime()}.json`;
            link.click();
        }

        
        function showStudentDetails(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const installments = student.installments || [];
            const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
            const annualFee = student.annualFee || student.annual_fee || 1200000;
            const discount = student.discount || 0;
            const finalFee = student.finalFee || student.final_fee || annualFee;
            const remaining = finalFee - totalPaid;
            const installmentAmount = calculateInstallmentAmount(student);
            
            
            const motherName = student.motherName || student.mother_name || '';
            const guardian = student.guardian || '';
            const siblings = students.filter(s => 
                s.id !== studentId && 
                (s.motherName || s.mother_name) === motherName && 
                motherName !== '' &&
                s.guardian === guardian
            );
            
            let siblingsHTML = '';
            if (siblings.length > 0) {
                siblingsHTML = `
                    <hr>
                    <h5 class="mb-3"><i class="bi bi-people"></i> الإخوة (${siblings.length})</h5>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>المدرسة</th>
                                    <th>الصف</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${siblings.map(s => {
                                    const schoolName = s.schoolName || '---';
                                    return `
                                        <tr>
                                            <td>${s.name || '---'}</td>
                                            <td>${schoolName}</td>
                                            <td>${s.grade || '---'}</td>
                                            <td><span class="badge ${s.hasSibling || s.has_sibling ? 'bg-success' : 'bg-danger'}">${s.hasSibling || s.has_sibling ? 'يستفيد من خصم' : 'لا يستفيد'}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
            
            let detailsHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <p><strong>اسم الطالب:</strong> ${student.name || student.student_name || '---'}</p>
                        <p><strong>اسم الأم:</strong> ${student.motherName || student.mother_name || '---'}</p>
                        <p><strong>اسم ولي الأمر:</strong> ${student.guardian || '---'}</p>
                        <p><strong>الصف:</strong> ${student.grade || '---'}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <p><strong>رقم الوصل:</strong> ${student.receiptNumber || student.receipt_number || '---'}</p>
                        <p><strong>رقم الهاتف:</strong> ${student.phone || '---'}</p>
                        <p><strong>تاريخ التسجيل:</strong> ${student.registrationDate || student.registration_date || '---'}</p>
                        <p><strong>إخوة (خصم 5%):</strong> ${student.hasSibling || student.has_sibling ? 'نعم' : 'لا'}</p>
                    </div>
                </div>
                <hr>
                <h5 class="mb-3">المعلومات المالية:</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>المبلغ السنوي:</strong> ${annualFee.toLocaleString('en-US')} د.ع</p>
                        <p><strong>الخصم:</strong> ${discount.toLocaleString('en-US')} د.ع</p>
                        <p><strong>المبلغ بعد الخصم:</strong> ${finalFee.toLocaleString('en-US')} د.ع</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>المبلغ المدفوع:</strong> ${totalPaid.toLocaleString('en-US')} د.ع</p>
                        <p><strong>المبلغ المتبقي:</strong> ${remaining.toLocaleString('en-US')} د.ع</p>
                    </div>
                </div>
                <hr>
                <h5 class="mb-3">تفاصيل الدفعات:</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>الدفعة</th>
                                <th>المبلغ المطلوب</th>
                                <th>المبلغ المدفوع</th>
                                <th>المتبقي</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${installments.map((inst, i) => {
                                const paid = inst.amount_paid || inst.amount || 0;
                                const required = installmentAmount;
                                const remainingInst = required - paid;
                                let statusBadge = '';
                                
                                if (paid >= required) {
                                    statusBadge = '<span class="badge bg-success">مكتملة</span>';
                                } else if (paid > 0) {
                                    statusBadge = '<span class="badge bg-warning">جزئية</span>';
                                } else {
                                    statusBadge = '<span class="badge bg-danger">غير مسددة</span>';
                                }
                                
                                return `
                                    <tr>
                                        <td>${i + 1}</td>
                                        <td>${required.toLocaleString('en-US')} د.ع</td>
                                        <td>${paid.toLocaleString('en-US')} د.ع</td>
                                        <td>${remainingInst.toLocaleString('en-US')} د.ع</td>
                                        <td>${statusBadge}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ${siblingsHTML}
                ${student.notes ? `<hr><p><strong>ملاحظات:</strong> ${student.notes}</p>` : ''}
            `;
            
            document.getElementById('studentDetailsContent').innerHTML = detailsHTML;
            const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
            modal.show();
        }

        
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentId').value = studentId;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editMotherName').value = student.motherName || student.mother_name || '';
            document.getElementById('editGuardianName').value = student.guardian;
            document.getElementById('editGrade').value = student.grade;
            document.getElementById('editAnnualFee').value = student.annualFee || student.annual_fee || 1200000;
            document.getElementById('editHasSibling').value = (student.hasSibling || student.has_sibling) ? 'yes' : 'no';
            document.getElementById('editPhone').value = student.phone || '';
            document.getElementById('editNotes').value = student.notes || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
            modal.show();
        }

        
        async function saveEditedStudent() {
            try {
                const studentId = document.getElementById('editStudentId').value;
                const student = students.find(s => s.id === studentId || s.id === parseInt(studentId));
                if (!student) {
                    showToast('الطالب غير موجود', 'error', 'خطأ');
                    return;
                }
                
                const annualFeeInput = document.getElementById('editAnnualFee').value;
                const annualFee = parseFloat(annualFeeInput) || ANNUAL_FEE;
                const hasSibling = document.getElementById('editHasSibling').value === 'yes';
                
                if (isNaN(annualFee) || annualFee <= 0) {
                    showToast('يرجى إدخال المبلغ السنوي صحيحاً', 'warning', 'تنبيه');
                    return;
                }
                
                
                let finalFee = annualFee;
                let discountAmount = 0;
                
                if (hasSibling) {
                        
                        const motherName = document.getElementById('editMotherName').value.trim();
                        const guardian = document.getElementById('editGuardianName').value.trim();
                        let siblingsCount = 1; 
                        
                        if (motherName && guardian) {
                            const siblings = allStudents.filter(s => 
                                s.id !== studentId && 
                                (s.motherName || s.mother_name) === motherName && 
                                s.guardian === guardian
                            );
                            siblingsCount = siblings.length + 1;
                        }
                        
                        const discountRate = calculateSiblingDiscount(siblingsCount);
                        discountAmount = annualFee * discountRate;
                    finalFee = annualFee - discountAmount;
                }
                
                
                const updateData = {
                    name: document.getElementById('editStudentName').value || 'غير محدد',
                    mother_name: document.getElementById('editMotherName').value || '',
                    guardian: document.getElementById('editGuardianName').value || '',
                    grade: document.getElementById('editGrade').value || '',
                    annual_fee: annualFee,
                    final_fee: finalFee,
                    has_sibling: hasSibling,
                    discount: discountAmount
                };
                
                
                const phoneValue = document.getElementById('editPhone').value;
                const notesValue = document.getElementById('editNotes').value;
                
                if (phoneValue) updateData.phone = phoneValue;
                if (notesValue) updateData.notes = notesValue;
                
                // تحديث بيانات الطالب
                student.name = document.getElementById('editStudentName').value;
                student.motherName = document.getElementById('editMotherName').value;
                student.mother_name = document.getElementById('editMotherName').value;
                student.guardian = document.getElementById('editGuardianName').value;
                student.guardianName = document.getElementById('editGuardianName').value;
                student.grade = document.getElementById('editGrade').value;
                student.annualFee = annualFee;
                student.annual_fee = annualFee;
                student.finalFee = finalFee;
                student.final_fee = finalFee;
                student.hasSibling = hasSibling;
                student.has_sibling = hasSibling;
                student.discount = discountAmount;
                student.discountAmount = discountAmount;
                student.phone = document.getElementById('editPhone').value;
                student.notes = document.getElementById('editNotes').value;
                
                // حفظ في قاعدة البيانات
                showLoading();
                const savedStudent = await saveStudentToDB(student);
                
                if (savedStudent) {
                    // تحديث البيانات المحلية
                    const localStudent = {
                        ...savedStudent,
                        guardianName: savedStudent.guardian_name || savedStudent.guardianName,
                        motherName: savedStudent.mother_name || savedStudent.motherName,
                        annualFee: savedStudent.annual_fee || savedStudent.annualFee,
                        receiptNumber: savedStudent.receipt_number || savedStudent.receiptNumber,
                        registrationDate: savedStudent.registration_date || savedStudent.registrationDate,
                        schoolId: savedStudent.school_id || savedStudent.schoolId,
                        installments: typeof savedStudent.installments === 'string' 
                            ? JSON.parse(savedStudent.installments) 
                            : savedStudent.installments
                    };
                    
                    const studentIndex = students.findIndex(s => s.id === localStudent.id);
                    if (studentIndex >= 0) {
                        students[studentIndex] = localStudent;
                    }
                    
                    const allIndex = allStudents.findIndex(s => s.id === localStudent.id);
                    if (allIndex >= 0) {
                        allStudents[allIndex] = localStudent;
                    }
                }
                
                // مسح التخزين المؤقت بعد التحديث
                clearCache('students');
                hideLoading();
                
                // تحديث الواجهة
                updateGradeFilter();
            renderTable();
            updateStats();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                modal.hide();
                
                showToast('تم حفظ التعديلات بنجاح', 'success', 'نجح');
                showAutoSaveIndicator();
            } catch (error) {
                showToast('حدث خطأ في حفظ التعديلات: ' + (error.message || 'خطأ غير معروف'), 'error', 'خطأ');
            }
        }

        
        function printList() {
            const printWindow = window.open('', '_blank');
            
            let tableHTML = `
                <!DOCTYPE html>
                <html lang="ar" dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <title>قائمة الطلاب - ${students.length} طالب</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        @page { 
                            size: A4; 
                            margin: 0.5cm; 
                        }
                        @media print {
                            body { margin: 0; padding: 0; }
                        }
                        body { font-family: Arial, sans-serif; direction: rtl; background: white; }
                        .report-container { width: 100%; padding: 10px; font-size: 9px; }
                        .header { text-align: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #0f766e; }
                        .header h1 { color: #0f766e; font-size: 18px; margin-bottom: 5px; }
                        .header p { color: #666; font-size: 12px; }
                        .stats { display: flex; justify-content: space-around; margin: 10px 0; padding: 10px; background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; border-radius: 5px; }
                        .stat-item { text-align: center; font-size: 9px; }
                        .stat-item strong { display: block; font-size: 16px; margin-top: 3px; }
                        table { width: 100%; border-collapse: collapse; margin: 5px 0; font-size: 7px; }
                        th, td { padding: 4px; text-align: right; border: 1px solid #ddd; }
                        th { background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white; font-weight: bold; font-size: 8px; }
                        tr:nth-child(even) { background: #f9f9f9; }
                        .badge { padding: 3px 6px; border-radius: 3px; font-size: 8px; font-weight: bold; }
                        .badge-success { background: #10b981; color: white; }
                        .badge-warning { background: #f59e0b; color: white; }
                        .badge-danger { background: #ef4444; color: white; }
                        .print-date { text-align: left; color: #666; margin-top: 10px; font-size: 8px; }
                        .school-col { display: none; }
                    </style>
                </head>
                <body>
                    <div class="report-container">
                        <div class="header">
                            <h1>مدرسة رسول الرحمة</h1>
                            <p>قائمة الطلاب </p>
                        </div>
                        
                        <div class="stats">
                            <div class="stat-item">
                                <div>عدد الطلاب</div>
                                <strong>${students.length}</strong>
                            </div>
                            <div class="stat-item">
                                <div>إجمالي المطلوب</div>
                                <strong id="statsTotal">0 د.ع</strong>
                            </div>
                            <div class="stat-item">
                                <div>إجمالي المدفوع</div>
                                <strong id="statsPaid">0 د.ع</strong>
                            </div>
                            <div class="stat-item">
                                <div>المتبقي</div>
                                <strong id="statsRemaining">0 د.ع</strong>
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th>م</th>
                                    <th>رقم الوصل</th>
                                    <th>اسم الطالب</th>
                                    ${isAdmin ? '<th>المدرسة</th>' : ''}
                                    <th>اسم الأم</th>
                                    <th>ولي الأمر</th>
                                    <th>الصف</th>
                                    <th>المبلغ السنوي</th>
                                    <th>الدُفعة 1</th>
                                    <th>الدُفعة 2</th>
                                    <th>الدُفعة 3</th>
                                    <th>الدُفعة 4</th>
                                    <th>إجمالي المدفوع</th>
                                    <th>المتبقي</th>
                                    <th>الخصم</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            let totalFees = 0, totalPaid = 0;
            
            students.forEach((student, index) => {
                const installments = student.installments || [];
                const studentTotalPaid = installments.reduce((sum, inst) => sum + (inst.amount || 0), 0);
                const finalFee = student.finalFee || student.annualFee || student.final_fee || student.annual_fee || 1200000;
                const studentRemaining = finalFee - studentTotalPaid;
                const statusInfo = getFinancialStatus(student);
                
                totalFees += finalFee;
                totalPaid += studentTotalPaid;
                
                let statusBadge = '';
                if (studentRemaining <= 0) {
                    statusBadge = '<span class="badge badge-success">مسدد</span>';
                } else if (studentTotalPaid > 0) {
                    statusBadge = '<span class="badge badge-warning">جزئي</span>';
                } else {
                    statusBadge = '<span class="badge badge-danger">غير مسدد</span>';
                }
                
                const installmentAmount = calculateInstallmentAmount(student);
                
                
                const installmentColumns = installments.map(inst => {
                    const paid = inst.amount || 0;
                    if (paid >= installmentAmount) {
                        return '<td style="background: #d4edda; color: #155724;">' + paid.toLocaleString('en-US') + '</td>';
                    } else if (paid > 0) {
                        return '<td style="background: #fff3cd; color: #856404;">' + paid.toLocaleString('en-US') + '</td>';
                    } else {
                        return '<td>0</td>';
                    }
                }).join('');
                
                const schoolNameCell = isAdmin && student.schoolName ? `<td>${student.schoolName}</td>` : '';
                const annualFee = student.annualFee || student.annual_fee || 1200000;
                const discount = student.discount || 0;
                tableHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${student.receiptNumber || student.receipt_number || '---'}</td>
                        <td>${student.name || student.student_name || '---'}</td>
                        ${schoolNameCell}
                        <td>${student.motherName || student.mother_name || '---'}</td>
                        <td>${student.guardian || student.guardian_name || '---'}</td>
                        <td>${student.grade || '---'}</td>
                        <td>${annualFee.toLocaleString('en-US')} د.ع</td>
                        ${installmentColumns}
                        <td><strong>${studentTotalPaid.toLocaleString('en-US')}</strong></td>
                        <td><strong>${studentRemaining.toLocaleString('en-US')}</strong></td>
                        <td>${discount.toLocaleString('en-US')}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            
            const remaining = totalFees - totalPaid;
            const totalFeesStr = totalFees.toLocaleString('en-US');
            const totalPaidStr = totalPaid.toLocaleString('en-US');
            const remainingStr = remaining.toLocaleString('en-US');
            
            tableHTML += `
                            </tbody>
                        </table>
                        
                        <div class="print-date">
                            تاريخ الطباعة: ${new Date().toLocaleString('ar-IQ')}
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(tableHTML);
            printWindow.document.close();
            
            
            const statsTotal = printWindow.document.getElementById('statsTotal');
            const statsPaid = printWindow.document.getElementById('statsPaid');
            const statsRemaining = printWindow.document.getElementById('statsRemaining');
            
            if (statsTotal) statsTotal.textContent = totalFeesStr + ' د.ع';
            if (statsPaid) statsPaid.textContent = totalPaidStr + ' د.ع';
            if (statsRemaining) statsRemaining.textContent = remainingStr + ' د.ع';
            
            printWindow.print();
        }

        
        let notificationsInterval;
        let chatInterval;
        let unreadNotifications = 0;
        let unreadMessages = 0;
        let messagesSubscription = null; // Realtime subscription للرسائل

        
        async function initChatSystem() {
            if (!currentSchoolId) return;
            
            
            document.getElementById('notificationBtn').style.display = 'block';
            document.getElementById('chatBtn').style.display = 'block';
            
            
            document.getElementById('notificationBtn').addEventListener('click', toggleNotifications);
            document.getElementById('chatBtn').addEventListener('click', toggleChat);
            
            
            await loadNotifications();
            await loadMessages();
            
            
            // إعداد Realtime subscription للرسائل
            setupMessagesRealtimeSubscription();
            
            
            // استخدام throttle لتقليل عدد الاستعلامات (كحل احتياطي)
            const throttledLoadNotifications = throttle(loadNotifications, 5000); // كل 5 ثوان
            const throttledLoadMessages = throttle(loadMessages, 2000); // كل 2 ثانية (كحل احتياطي)
            
            notificationsInterval = setInterval(throttledLoadNotifications, 5000);
            chatInterval = setInterval(throttledLoadMessages, 2000);
        }
        
        // إعداد Realtime subscription للرسائل
        function setupMessagesRealtimeSubscription() {
            if (!supabaseClient || !currentSchoolId) return;
            
            // إلغاء الاشتراك السابق إن وجد
            if (messagesSubscription) {
                supabaseClient.removeChannel(messagesSubscription);
                messagesSubscription = null;
            }
            
            const schoolIdStr = String(currentSchoolId);
            
            // إنشاء subscription للرسائل - نستمع لجميع الرسائل ثم نفلتر محلياً
            messagesSubscription = supabaseClient
                .channel(`messages-channel-${schoolIdStr}-${Date.now()}`)
                .on(
                    'postgres_changes',
                    {
                        event: '*', // INSERT, UPDATE, DELETE
                        schema: 'public',
                        table: 'messages'
                    },
                    (payload) => {
                        const newRecord = payload.new || payload.old;
                        if (!newRecord) return;
                        
                        const msgReceiverId = newRecord.receiver_id ? String(newRecord.receiver_id) : null;
                        const msgSenderId = newRecord.sender_id ? String(newRecord.sender_id) : null;
                        
                        // التحقق من أن الرسالة متعلقة بالمدرسة الحالية
                        const isRelevant = msgReceiverId === schoolIdStr || 
                                         msgSenderId === schoolIdStr || 
                                         msgReceiverId === null;
                        
                        if (isRelevant) {
                            console.log('📨 رسالة جديدة:', payload.eventType, newRecord);
                            // تحديث فوري للرسائل
                            loadMessages(true);
                        }
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('✅ تم الاشتراك في تحديثات الرسائل الفورية');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.warn('⚠️ خطأ في الاشتراك بتحديثات الرسائل، سيتم استخدام التحديث الدوري');
                    } else if (status === 'TIMED_OUT') {
                        console.warn('⚠️ انتهت مهلة الاشتراك، إعادة المحاولة...');
                        setTimeout(() => setupMessagesRealtimeSubscription(), 2000);
                    }
                });
        }

        
        function toggleNotifications() {
            const panel = document.getElementById('notificationPanel');
            if (panel.classList.contains('show')) {
                closeNotifications();
            } else {
                panel.classList.add('show');
                document.getElementById('chatPanel').classList.remove('show');
            }
        }

        function closeNotifications() {
            document.getElementById('notificationPanel').classList.remove('show');
        }

        
        function toggleChat() {
            const panel = document.getElementById('chatPanel');
            if (panel.classList.contains('show')) {
                closeChat();
            } else {
                panel.classList.add('show');
                document.getElementById('notificationPanel').classList.remove('show');
                loadChatReceivers();
            }
        }

        function closeChat() {
            document.getElementById('chatPanel').classList.remove('show');
        }

        
        async function loadNotifications(forceRefresh = false) {
            if (!supabaseClient || !currentSchoolId) {
                unreadNotifications = 0;
                updateNotificationBadge();
                displayNotifications([]);
                return;
            }
            
            try {
                // تحميل الإشعارات للمدرسة الحالية
                // محاولة استخدام school_id كنص أولاً
                let query = supabaseClient
                    .from('notifications')
                    .select('*')
                    .eq('is_read', false)
                    .order('created_at', { ascending: false })
                    .limit(100);
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('خطأ في تحميل الإشعارات:', error);
                    displayNotifications([]);
                    return;
                }
                
                // فلترة محلياً حسب school_id
                const schoolIdStr = String(currentSchoolId);
                const filteredData = (data || []).filter(notif => 
                    String(notif.school_id) === schoolIdStr
                );
                
                // حساب الإشعارات غير المقروءة
                unreadNotifications = filteredData?.length || 0;
                
                updateNotificationBadge();
                displayNotifications(filteredData);
            } catch (error) {
                console.error('خطأ في تحميل الإشعارات:', error);
                displayNotifications([]);
            }
        }

        
        function displayNotifications(notifications) {
            const list = document.getElementById('notificationList');
            list.innerHTML = '';
            
            if (!notifications || notifications.length === 0) {
                list.innerHTML = '<p class="text-center text-muted p-3">لا توجد إشعارات</p>';
                return;
            }
            
            notifications.forEach(notif => {
                const div = document.createElement('div');
                div.className = `notification-item ${notif.is_read ? 'read' : 'unread'}`;
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong style="color: #1f2937;">${notif.title}</strong>
                            <p style="margin: 5px 0; color: #6b7280; font-size: 13px;">${notif.message}</p>
                            <small style="color: #9ca3af; font-size: 11px;">${formatDate(notif.created_at)}</small>
                        </div>
                        ${!notif.is_read ? '<span class="badge bg-danger" style="width: 8px; height: 8px; border-radius: 50%;"></span>' : ''}
                    </div>
                `;
                div.addEventListener('click', () => markNotificationAsRead(notif.id));
                list.appendChild(div);
            });
        }

        
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (unreadNotifications > 0) {
                badge.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        
        async function markNotificationAsRead(id) {
            if (!supabaseClient || !databaseAvailable || !id) {
                return;
            }
            
            try {
                // تحديث is_read فقط (read_at قد لا يكون موجوداً في بعض الحالات)
                const updateData = { 
                    is_read: true
                };
                
                const { error } = await supabaseClient
                    .from('notifications')
                    .update(updateData)
                    .eq('id', id)
                    .eq('school_id', String(currentSchoolId));
                
                if (error) {
                    // إذا كان الخطأ متعلق بـ read_at، تجاهله
                    if (!error.message?.includes('read_at') && error.code !== 'PGRST204') {
                        throw error;
                    }
                }
                
                // تحديث العداد
                unreadNotifications = Math.max(0, unreadNotifications - 1);
                updateNotificationBadge();
                
                // إعادة تحميل الإشعارات
                await loadNotifications(true);
            } catch (error) {
                console.error('خطأ في تحديث حالة الإشعار:', error);
            }
        }

        
        async function loadMessages(forceRefresh = false) {
            if (!supabaseClient || !currentSchoolId) {
                unreadMessages = 0;
                updateChatBadge();
                displayMessages([]);
                return;
            }
            
            try {
                // تحميل جميع الرسائل ثم الفلترة محلياً
                // (لأن sender_id و receiver_id قد يكونان UUID أو TEXT)
                let query = supabaseClient
                    .from('messages')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(200);
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('خطأ في تحميل الرسائل:', error);
                    displayMessages([]);
                    return;
                }
                
                // فلترة محلياً حسب المدرسة الحالية
                const schoolIdStr = String(currentSchoolId);
                let filteredData = (data || []).filter(msg => {
                    // التحقق من الرسائل المرسلة إلى المدرسة الحالية أو المرسلة منها
                    // أو الرسائل المرسلة لجميع المدارس (receiver_id = null)
                    const msgReceiverId = msg.receiver_id ? String(msg.receiver_id) : null;
                    const msgSenderId = msg.sender_id ? String(msg.sender_id) : null;
                    
                    return msgReceiverId === schoolIdStr || 
                           msgSenderId === schoolIdStr || 
                           msgReceiverId === null;
                });
                
                // فلترة الرسائل المحذوفة محلياً إذا كان العمود موجوداً
                if (filteredData.length > 0 && filteredData[0].hasOwnProperty('is_deleted')) {
                    filteredData = filteredData.filter(msg => !msg.is_deleted);
                }
                
                // حساب الرسائل غير المقروءة
                unreadMessages = filteredData?.filter(msg => {
                    const msgReceiverId = msg.receiver_id ? String(msg.receiver_id) : null;
                    return msgReceiverId === schoolIdStr && !msg.is_read;
                }).length || 0;
                
                updateChatBadge();
                displayMessages(filteredData);
            } catch (error) {
                console.error('خطأ في تحميل الرسائل:', error);
                displayMessages([]);
            }
        }

        
        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-3">لا توجد رسائل</p>';
                return;
            }
            
            // ترتيب الرسائل من الأقدم إلى الأحدث
            messages.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            
            messages.forEach(msg => {
                // تحديد ما إذا كانت الرسالة مرسلة من المدرسة الحالية
                const isSent = String(msg.sender_id) === String(currentSchoolId);
                const div = document.createElement('div');
                div.className = `chat-message ${isSent ? 'sent' : 'received'}`;
                
                const time = formatTime(msg.created_at);
                const messageText = msg.message || msg.message_text || '';
                div.innerHTML = `
                    ${!isSent ? `<div class="message-sender">${msg.sender_name || 'مستخدم'}</div>` : ''}
                    <div class="message-bubble ${isSent ? 'sent' : 'received'}">
                        ${Utils.sanitizeHTML(messageText)}
                    </div>
                    <div class="message-time">${time}</div>
                `;
                container.appendChild(div);
                
                // تحديد الرسالة كمقروءة إذا كانت مستلمة
                if (!isSent && !msg.is_read) {
                    markMessageAsRead(msg.id);
                }
            });
            
            // التمرير إلى الأسفل
            container.scrollTop = container.scrollHeight;
        }

        
        function updateChatBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 9 ? '9+' : unreadMessages;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        
        async function loadChatReceivers() {
            const select = document.getElementById('chatReceiver');
            if (!select) return;
            
            // إضافة خيار "جميع المدارس"
            select.innerHTML = '<option value="all">جميع المدارس</option>';
            
            // إضافة جميع المدارس الفردية (باستثناء المدرسة الحالية)
            if (schools && typeof schools === 'object') {
                Object.keys(schools).forEach(schoolId => {
                    // استبعاد المدرسة الحالية من القائمة
                    if (schoolId === currentSchoolId) return;
                    
                    const school = schools[schoolId];
                    if (school && school.name) {
                        const option = document.createElement('option');
                        option.value = schoolId;
                        option.textContent = school.name;
                        select.appendChild(option);
                    }
                });
            } else {
                console.warn('schools object is not properly defined');
            }
        }

        
        async function sendMessage() {
            const message = document.getElementById('chatInput').value.trim();
            const receiver = document.getElementById('chatReceiver')?.value;
            
            if (!message) {
                showToast('الرجاء إدخال رسالة', 'warning', 'تنبيه');
                return;
            }
            
            if (!receiver) {
                showToast('الرجاء اختيار المستقبل', 'warning', 'تنبيه');
                return;
            }
            
            if (!currentSchoolId) {
                showToast('خطأ: لم يتم تحديد المدرسة', 'error', 'خطأ');
                return;
            }
            
            const currentSchool = schools[currentSchoolId];
            const senderName = currentSchool?.name || 'مستخدم';
            
            // إضافة الرسالة للواجهة فوراً
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message sent';
            const time = new Date().toLocaleTimeString('ar-IQ', { hour: '2-digit', minute: '2-digit' });
            messageDiv.innerHTML = `
                <div class="message-bubble sent">${message}</div>
                <div class="message-time">${time}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            document.getElementById('chatInput').value = '';
            
            // حفظ الرسالة في قاعدة البيانات
            if (supabaseClient && databaseAvailable) {
                try {
                    const messageData = {
                        sender_id: String(currentSchoolId),
                        sender_name: senderName,
                        receiver_id: receiver === 'all' ? null : String(receiver),
                        receiver_name: receiver === 'all' ? 'جميع المدارس' : (schools[receiver]?.name || 'مستخدم'),
                        message: message,
                        is_read: false
                    };
                    
                    const { data, error } = await supabaseClient
                        .from('messages')
                        .insert(messageData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // لا حاجة لتحديث يدوي - Realtime subscription سيتولى ذلك تلقائياً
                    // لكن يمكن تحديث فوري للواجهة إذا كانت الرسالة مرئية
                    setTimeout(() => loadMessages(true), 500); // تحديث بعد نصف ثانية للتأكد
                } catch (error) {
                    console.error('خطأ في حفظ الرسالة:', error);
                    
                    // إذا كان الخطأ متعلق بقاعدة البيانات، أضف للقائمة
                    const isDatabaseError = error.message && (
                        error.message.includes('Failed to fetch') ||
                        error.message.includes('timeout') ||
                        error.message.includes('503') ||
                        error.message.includes('502') ||
                        error.message.includes('504') ||
                        error.message.includes('500') ||
                        error.message.includes('network')
                    );
                    
                    if (isDatabaseError) {
                        databaseAvailable = false;
                        const currentSchool = schools[currentSchoolId];
                        addToOfflineQueue({
                            type: 'insert',
                            table: 'messages',
                            data: {
                                sender_id: String(currentSchoolId),
                                sender_name: currentSchool?.name || 'مستخدم',
                                receiver_id: receiver === 'all' ? null : String(receiver),
                                receiver_name: receiver === 'all' ? 'جميع المدارس' : (schools[receiver]?.name || 'مستخدم'),
                                message: message,
                                is_read: false
                            }
                        });
                        showToast('تم حفظ الرسالة محلياً، سيتم إرسالها تلقائياً عند عودة قاعدة البيانات', 'warning', 'حفظ محلي');
                    } else {
                        showToast('خطأ في إرسال الرسالة', 'error', 'خطأ');
                    }
                }
            } else if (!databaseAvailable) {
                // حفظ في قائمة الانتظار
                const currentSchool = schools[currentSchoolId];
                addToOfflineQueue({
                    type: 'insert',
                    table: 'messages',
                    data: {
                        sender_id: String(currentSchoolId),
                        sender_name: currentSchool?.name || 'مستخدم',
                        receiver_id: receiver === 'all' ? null : String(receiver),
                        receiver_name: receiver === 'all' ? 'جميع المدارس' : (schools[receiver]?.name || 'مستخدم'),
                        message: message,
                        is_read: false
                    }
                });
                showToast('تم حفظ الرسالة محلياً، سيتم إرسالها تلقائياً عند عودة قاعدة البيانات', 'info', 'حفظ محلي');
            }
        }

        
        async function sendBroadcastMessage(message) {
            if (!supabaseClient || !currentSchoolId || !message) {
                return;
            }
            
            try {
                const currentSchool = schools[currentSchoolId];
                const senderName = currentSchool?.name || 'مستخدم';
                
                // إرسال رسالة لجميع المدارس
                const messageData = {
                    sender_id: String(currentSchoolId),
                    sender_name: senderName,
                    receiver_id: null, // null يعني جميع المدارس
                    receiver_name: 'جميع المدارس',
                    message: message,
                    is_read: false
                };
                
                const { data, error } = await supabaseClient
                    .from('messages')
                    .insert(messageData)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // تحديث قائمة الرسائل
                await loadMessages(true);
                
                showToast('تم إرسال الرسالة لجميع المدارس', 'success', 'نجح');
            } catch (error) {
                console.error('خطأ في إرسال الرسالة الجماعية:', error);
                showToast('خطأ في إرسال الرسالة', 'error', 'خطأ');
            }
        }

        
        async function markMessageAsRead(messageId) {
            if (!supabaseClient || !databaseAvailable || !messageId) {
                return;
            }
            
            try {
                // تحديث is_read فقط (read_at قد لا يكون موجوداً في بعض الحالات)
                const updateData = { 
                    is_read: true
                };
                
                // محاولة إضافة read_at فقط إذا كان العمود موجوداً
                // (سنتحقق من ذلك من خلال معالجة الخطأ)
                const { error } = await supabaseClient
                    .from('messages')
                    .update(updateData)
                    .eq('id', messageId)
                    .eq('receiver_id', String(currentSchoolId));
                
                if (error) {
                    // إذا كان الخطأ متعلق بـ read_at، جرب بدونها
                    if (error.message?.includes('read_at') || error.code === 'PGRST204') {
                        const { error: retryError } = await supabaseClient
                            .from('messages')
                            .update({ is_read: true })
                            .eq('id', messageId)
                            .eq('receiver_id', String(currentSchoolId));
                        
                        if (retryError) throw retryError;
                    } else {
                        throw error;
                    }
                }
                
                // تحديث العداد
                unreadMessages = Math.max(0, unreadMessages - 1);
                updateChatBadge();
            } catch (error) {
                // تجاهل الخطأ بصمت إذا كان متعلقاً بـ read_at
                if (!error.message?.includes('read_at') && error.code !== 'PGRST204') {
                    console.error('خطأ في تحديث حالة الرسالة:', error);
                }
            }
        }

        
        async function createNotification(schoolId, title, message, type = 'info') {
            if (!supabaseClient || !schoolId) {
                return;
            }
            
            try {
                const notificationData = {
                    school_id: String(schoolId),
                    title: title,
                    message: message,
                    type: type,
                    is_read: false
                };
                
                const { data, error } = await supabaseClient
                    .from('notifications')
                    .insert(notificationData)
                    .select()
                    .single();
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('خطأ في إنشاء الإشعار:', error);
                
                // إذا كان الخطأ متعلق بقاعدة البيانات، أضف للقائمة
                const isDatabaseError = error.message && (
                    error.message.includes('Failed to fetch') ||
                    error.message.includes('timeout') ||
                    error.message.includes('503') ||
                    error.message.includes('502') ||
                    error.message.includes('504') ||
                    error.message.includes('500') ||
                    error.message.includes('network')
                );
                
                if (isDatabaseError) {
                    databaseAvailable = false;
                    addToOfflineQueue({
                        type: 'insert',
                        table: 'notifications',
                        data: {
                            school_id: String(schoolId),
                            title: title,
                            message: message,
                            type: type,
                            is_read: false
                        }
                    });
                }
                
                return null;
            }
        }

        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
        }

        
        function formatTime(dateString) {
            const date = new Date(dateString);
            return `${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
        }

        
        document.addEventListener('keypress', function(e) {
            if (e.target.id === 'chatInput' && e.key === 'Enter') {
                sendMessage();
            }
        });

        
        

        
        function openAddUserModal() {
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addUserModal'));
            modal.show();
        }

        
        async function saveNewUser() {
            try {
                const username = document.getElementById('newUsername').value.trim();
                const password = document.getElementById('newPassword').value.trim();
                const schoolCode = document.getElementById('userSchool').value;
                const userType = document.getElementById('userType').value;

                if (!username || !password || !schoolCode) {
                    showToast('يرجى إكمال جميع الحقول المطلوبة', 'warning', 'تنبيه');
                    return;
                }

                // تحميل المستخدمين الحاليين
                const savedUsers = localStorage.getItem('users');
                let users = [];
                
                if (savedUsers) {
                    try {
                        users = JSON.parse(savedUsers);
                        if (!Array.isArray(users)) {
                            users = [];
                        }
                    } catch (e) {
                        users = [];
                    }
                }
                
                // التحقق من عدم وجود مستخدم بنفس الاسم
                if (users.some(u => u.username === username)) {
                    showToast('اسم المستخدم موجود مسبقاً', 'warning', 'تنبيه');
                    return;
                }
                
                // إضافة مستخدم جديد
                const newUser = {
                    id: Date.now(),
                    username: username,
                    password: password,
                    school: schoolCode,
                    type: userType,
                    is_active: true,
                    created_at: new Date().toISOString()
                };
                
                users.push(newUser);
                localStorage.setItem('users', JSON.stringify(users));
                
                // إعادة تحميل القائمة
                loadUsers();
                
                // إغلاق النافذة
                const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                modal.hide();
                
                // إعادة تعيين النموذج
                document.getElementById('addUserForm').reset();
                
                showToast('تم إضافة المستخدم بنجاح', 'success', 'نجح');
            } catch (error) {
                console.error('خطأ:', error);
                showToast('حدث خطأ في إضافة المستخدم', 'error', 'خطأ');
            }
        }

        
        async function loadUsers() {
            if (!isAdmin) return;
            
            // تحميل المستخدمين من localStorage
            const savedUsers = localStorage.getItem('users');
            let users = [];
            
            if (savedUsers) {
                try {
                    users = JSON.parse(savedUsers);
                    if (!Array.isArray(users)) {
                        users = [];
                    }
                } catch (e) {
                    users = [];
                }
            }
            
            const tbody = document.getElementById('usersTable');
            if (tbody) {
                if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">لا يوجد مستخدمين</td></tr>';
                } else {
                    tbody.innerHTML = users.map((user, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${user.username || '---'}</td>
                            <td>${'*'.repeat(user.password?.length || 0)}</td>
                            <td>${schools[user.school]?.name || user.school || '---'}</td>
                            <td>${getUserTypeLabel(user.type || 'user')}</td>
                            <td><span class="badge ${user.is_active !== false ? 'bg-success' : 'bg-danger'}">${user.is_active !== false ? 'نشط' : 'معطل'}</span></td>
                            <td>${user.created_at ? new Date(user.created_at).toLocaleDateString('ar-IQ') : '---'}</td>
                            <td>
                                <button onclick="toggleUserStatus('${user.id || index}', ${user.is_active !== false})" class="btn btn-sm btn-warning">
                                    <i class="bi bi-toggle-${user.is_active !== false ? 'off' : 'on'}"></i>
                                </button>
                                <button onclick="deleteUser('${user.id || index}')" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }

        
        async function toggleUserStatus(userId, currentStatus) {
            const confirmed = await showConfirmDialog(
                `هل أنت متأكد من ${currentStatus ? 'تعطيل' : 'تفعيل'} هذا المستخدم؟`, 
                'تأكيد', 
                'نعم', 
                'إلغاء'
            );
            if (!confirmed) return;
            
            const savedUsers = localStorage.getItem('users');
            if (!savedUsers) return;
            
            try {
                let users = JSON.parse(savedUsers);
                const userIndex = users.findIndex(u => (u.id && u.id.toString() === userId.toString()) || users.indexOf(u).toString() === userId.toString());
                
                if (userIndex !== -1) {
                    users[userIndex].is_active = !currentStatus;
                    localStorage.setItem('users', JSON.stringify(users));
                    loadUsers();
                }
            } catch (e) {
                console.error('خطأ:', e);
            }
        }

        
        async function deleteUser(userId) {
            const confirmed = await showConfirmDialog('هل أنت متأكد من حذف هذا المستخدم؟', 'تأكيد الحذف', 'نعم، احذف', 'إلغاء');
            if (!confirmed) return;
            
            const savedUsers = localStorage.getItem('users');
            if (!savedUsers) return;
            
            try {
                let users = JSON.parse(savedUsers);
                users = users.filter((u, index) => {
                    if (u.id && u.id.toString() === userId.toString()) return false;
                    if (index.toString() === userId.toString()) return false;
                    return true;
                });
                
                localStorage.setItem('users', JSON.stringify(users));
                loadUsers();
                showToast('تم حذف المستخدم بنجاح', 'success', 'نجح');
            } catch (e) {
                console.error('خطأ:', e);
                showToast('حدث خطأ في حذف المستخدم', 'error', 'خطأ');
            }
        }

        function getUserTypeLabel(type) {
            const types = {
                'user': 'مستخدم عادي',
                'school_admin': 'مدير مدرسة',
                'admin': 'مدير نظام'
            };
            return types[type] || type;
        }

        
        
        
        function switchMainTab(tabName) {
            
            document.querySelectorAll('.main-tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });
            
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.style.display = 'block';
                targetTab.classList.add('active');
            }
            
            
            const navItems = document.querySelectorAll('.nav-item');
            const tabIndexMap = {
                'students': 0,
                'attendance': 1,
                'grades': 2,
                'teachers': 3,
                'subjects': 4,
                'lessons': 5,
                'schools': 6,
                'reports': 7,
                'users': 8,
                'settings': 9
            };
            
            if (tabIndexMap[tabName] !== undefined) {
                navItems[tabIndexMap[tabName]]?.classList.add('active');
            }
            
            
            if (tabName === 'schools') {
                loadSchoolsStats();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'attendance') {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('attendanceDate').value = today;
                updateAttendanceGradeFilter();
            } else if (tabName === 'grades') {
                updateGradesGradeFilter();
                loadGradesData();
            } else if (tabName === 'teachers') {
                loadTeachersData();
            } else if (tabName === 'subjects') {
                loadSubjectsData();
            } else if (tabName === 'lessons') {
                loadLessonsData();
            } else if (tabName === 'reports') {
                loadReportsData();
            }
        }
        
        // دوال مساعدة للفلاتر
        function updateAttendanceGradeFilter() {
            const gradeFilter = document.getElementById('attendanceGrade');
            if (!gradeFilter) return;
            
            gradeFilter.innerHTML = '<option value="all">جميع الصفوف</option>';
            const allGrades = new Set(students.map(s => s.grade).filter(Boolean));
            Array.from(allGrades).sort().forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeFilter.appendChild(option);
            });
        }
        
        function updateGradesGradeFilter() {
            const gradeFilter = document.getElementById('gradesGradeFilter');
            if (!gradeFilter) return;
            
            gradeFilter.innerHTML = '<option value="all">جميع الصفوف</option>';
            const allGrades = new Set(students.map(s => s.grade).filter(Boolean));
            Array.from(allGrades).sort().forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeFilter.appendChild(option);
            });
        }
        
        async function loadReportsData() {
            // تحديث الإحصائيات
            if (attendanceData.length > 0) {
                const presentCount = attendanceData.filter(a => a.status === 'present').length;
                const attendanceRate = ((presentCount / attendanceData.length) * 100).toFixed(1);
                document.getElementById('attendanceRate').textContent = attendanceRate + '%';
            }
            
            document.getElementById('totalTeachers').textContent = teachersData.length;
            document.getElementById('totalSubjects').textContent = subjectsData.length;
            
            if (gradesData.length > 0) {
                const avgGrade = (gradesData.reduce((sum, g) => sum + (parseFloat(g.score) || 0), 0) / gradesData.length).toFixed(1);
                document.getElementById('averageGrade').textContent = avgGrade;
            }
        }
        
        
        function updateSidebarInfo() {
            const userInfo = document.getElementById('sidebarUserInfo');
            const schoolName = document.getElementById('sidebarSchoolName');
            
            if (isAdmin) {
                userInfo.textContent = 'رئيس مجلس الإدارة';
                schoolName.textContent = 'جميع المدارس';
            } else if (currentSchoolName) {
                userInfo.textContent = currentSchoolName;
                schoolName.textContent = currentSchoolName;
            }
        }
        
        
        function startDateTimeUpdate() {
            function updateDateTime() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('ar-IQ', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const timeStr = now.toLocaleTimeString('ar-IQ', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateTimeEl = document.getElementById('sidebarDateTime');
                if (dateTimeEl) {
                    dateTimeEl.textContent = `${dateStr} - ${timeStr}`;
                }
            }
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }
        
        
        
        let schoolsDataGlobal = [];
        let chartsInstances = {};
        
        async function loadSchoolsStats() {
            if (!isAdmin) return;
            // تم حذف قاعدة البيانات
            const statsContainer = document.getElementById('schoolsStatsContainer');
            const listContainer = document.getElementById('schoolsListContainer');
            if (statsContainer) statsContainer.innerHTML = '<div class="text-center text-muted p-3">لا توجد بيانات</div>';
            if (listContainer) listContainer.innerHTML = '<div class="text-center text-muted p-3">لا توجد بيانات</div>';
        }
        
        
        function updateDashboardStats(totalStudents, totalFees, totalPaid, schoolsData) {
            const totalSchoolsEl = document.getElementById('totalSchoolsCount');
            const totalStudentsEl = document.getElementById('totalStudentsCount');
            const totalFeesEl = document.getElementById('totalFeesAmount');
            const overallRateEl = document.getElementById('overallPaymentRate');
            
            if (totalSchoolsEl) {
                
                const totalSchoolsCount = schools ? Object.keys(schools).length : (schoolsData ? schoolsData.length : 0);
                totalSchoolsEl.textContent = totalSchoolsCount;
            }
            if (totalStudentsEl) {
                totalStudentsEl.textContent = totalStudents ? totalStudents.toLocaleString('en-US') : '0';
            }
            if (totalFeesEl) {
                totalFeesEl.textContent = totalFees ? (totalFees / 1000000).toFixed(1) + 'M' : '0M';
            }
            if (overallRateEl) {
                const overallRate = totalFees > 0 ? (totalPaid / totalFees) * 100 : 0;
                overallRateEl.textContent = overallRate.toFixed(1) + '%';
            }
        }
        
        
        function createCharts(schoolsData) {
            if (!schoolsData || schoolsData.length === 0) {
                console.warn('لا توجد بيانات للمدارس لعرض الرسوم البيانية');
                return;
            }
            
            
            if (chartsInstances.studentsChart) {
                chartsInstances.studentsChart.destroy();
            }
            if (chartsInstances.paymentChart) {
                chartsInstances.paymentChart.destroy();
            }
            
            
            const studentsCtx = document.getElementById('studentsDistributionChart');
            if (studentsCtx && typeof Chart !== 'undefined') {
                chartsInstances.studentsChart = new Chart(studentsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: schoolsData.map(s => s.name),
                        datasets: [{
                            label: 'عدد الطلاب',
                            data: schoolsData.map(s => s.students),
                            backgroundColor: [
                                'rgba(15, 118, 110, 0.8)',
                                'rgba(139, 69, 19, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(52, 152, 219, 0.8)',
                                'rgba(231, 76, 60, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                rtl: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return context.label + ': ' + context.parsed + ' طالب (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            
            const paymentCtx = document.getElementById('paymentRateChart');
            if (paymentCtx && typeof Chart !== 'undefined') {
                chartsInstances.paymentChart = new Chart(paymentCtx, {
                    type: 'bar',
                    data: {
                        labels: schoolsData.map(s => s.name),
                        datasets: [{
                            label: 'نسبة الدفع (%)',
                            data: schoolsData.map(s => parseFloat(s.paymentRate.toFixed(1))),
                            backgroundColor: schoolsData.map(s => {
                                if (s.paymentRate >= 80) return 'rgba(67, 233, 123, 0.8)';
                                if (s.paymentRate >= 50) return 'rgba(255, 193, 7, 0.8)';
                                return 'rgba(231, 76, 60, 0.8)';
                            }),
                            borderColor: schoolsData.map(s => {
                                if (s.paymentRate >= 80) return 'rgba(67, 233, 123, 1)';
                                if (s.paymentRate >= 50) return 'rgba(255, 193, 7, 1)';
                                return 'rgba(231, 76, 60, 1)';
                            }),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'نسبة الدفع: ' + context.parsed.y + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        
        let currentSortBy = 'students';
        function sortSchoolsBy(sortType) {
            currentSortBy = sortType;
            const schoolsData = [...schoolsDataGlobal];
            
            schoolsData.sort((a, b) => {
                if (sortType === 'students') {
                    return b.students - a.students;
                } else if (sortType === 'payment') {
                    return b.paymentRate - a.paymentRate;
                } else if (sortType === 'fees') {
                    return b.fees - a.fees;
                }
                return 0;
            });
            
            
            renderSchoolsList(schoolsData);
        }
        
        
        function renderSchoolsList(schoolsData) {
            const listContainer = document.getElementById('schoolsListContainer');
            let html = '';
            
            schoolsData.forEach((schoolData, index) => {
                const schoolColor = {
                    'rawda': '#8B4513',
                    'rasoul': '#0f766e',
                    'noor': '#f59e0b',
                    'nabi': '#3498db',
                    'thanawiya': '#e74c3c'
                }[schoolData.id] || '#0f766e';
                
                const paymentPercent = schoolData.paymentRate.toFixed(1);
                const progressColor = schoolData.paymentRate >= 80 ? 'success' : schoolData.paymentRate >= 50 ? 'warning' : 'danger';
                
                
                const rank = index + 1;
                const rankIcon = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : '';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card-custom" style="border-top: 4px solid ${schoolColor}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div class="card-header-custom" style="background: linear-gradient(135deg, ${schoolColor} 0%, ${schoolColor}dd 100%);">
                                <i class="bi bi-building"></i> ${schoolData.name} ${rankIcon}
                            </div>
                            <div class="card-body">
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <h6 class="text-muted mb-1"><i class="bi bi-people"></i> الطلاب</h6>
                                        <h4 class="mb-0" style="color: ${schoolColor}; font-weight: 700;">${schoolData.students}</h4>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="text-muted mb-1"><i class="bi bi-cash-stack"></i> المطلوب</h6>
                                        <h6 class="mb-0" style="color: ${schoolColor}; font-weight: 600;">${schoolData.fees.toLocaleString('en-US')} د.ع</h6>
                                    </div>
                                    <div class="col-4">
                                        <h6 class="text-muted mb-1"><i class="bi bi-check-circle"></i> المدفوع</h6>
                                        <h6 class="mb-0" style="color: ${schoolColor}; font-weight: 600;">${schoolData.paid.toLocaleString('en-US')} د.ع</h6>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">نسبة الدفع</small>
                                        <small class="text-muted"><strong>${paymentPercent}%</strong></small>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-${progressColor}" role="progressbar" style="width: ${paymentPercent}%"></div>
                                    </div>
                                </div>
                                <div class="row text-center mb-2">
                                    <div class="col-4">
                                        <small class="text-muted d-block">مسدد</small>
                                        <strong style="color: #28a745;">${schoolData.paidCount || 0}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">جزئي</small>
                                        <strong style="color: #ffc107;">${schoolData.partial || 0}</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block">غير مسدد</small>
                                        <strong style="color: #dc3545;">${schoolData.unpaid || 0}</strong>
                                    </div>
                                </div>
                                <div class="text-center mb-2">
                                    <small class="text-muted"><i class="bi bi-clock"></i> المتبقي: <strong>${schoolData.remaining.toLocaleString('en-US')} د.ع</strong></small>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <button onclick="filterBySchool('${schoolData.id}'); switchMainTab('students');" class="btn btn-sm btn-primary-custom w-100 mb-2">
                                        <i class="bi bi-eye"></i> عرض طلاب ${schoolData.name}
                                    </button>
                                    <button onclick="showSchoolDetails('${schoolData.id}')" class="btn btn-sm btn-info-custom w-100">
                                        <i class="bi bi-info-circle"></i> تفاصيل المدرسة
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listContainer.innerHTML = html;
        }
        
        
        function showSchoolDetails(schoolId) {
            const school = schoolsDataGlobal.find(s => s.id === schoolId);
            if (!school) return;
            
            const details = `
                <div class="modal fade" id="schoolDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header" style="background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%); color: white;">
                                <h5 class="modal-title"><i class="bi bi-building"></i> تفاصيل ${school.name}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <h6><i class="bi bi-people"></i> إحصائيات الطلاب</h6>
                                        <ul class="list-group">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>إجمالي الطلاب:</span>
                                                <strong>${school.students}</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>مسدد بالكامل:</span>
                                                <strong class="text-success">${school.paidCount || 0}</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>دفع جزئي:</span>
                                                <strong class="text-warning">${school.partial || 0}</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>غير مسدد:</span>
                                                <strong class="text-danger">${school.unpaid || 0}</strong>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <h6><i class="bi bi-cash-stack"></i> الإحصائيات المالية</h6>
                                        <ul class="list-group">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>المبلغ المطلوب:</span>
                                                <strong>${school.fees.toLocaleString('en-US')} د.ع</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>المبلغ المدفوع:</span>
                                                <strong class="text-success">${school.paid.toLocaleString('en-US')} د.ع</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>المبلغ المتبقي:</span>
                                                <strong class="text-danger">${school.remaining.toLocaleString('en-US')} د.ع</strong>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>نسبة الدفع:</span>
                                                <strong>${school.paymentRate.toFixed(1)}%</strong>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                                <button type="button" class="btn btn-primary" onclick="filterBySchool('${schoolId}'); switchMainTab('students'); bootstrap.Modal.getInstance(document.getElementById('schoolDetailsModal')).hide();">
                                    <i class="bi bi-eye"></i> عرض الطلاب
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            
            const existingModal = document.getElementById('schoolDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            
            document.body.insertAdjacentHTML('beforeend', details);
            const modal = new bootstrap.Modal(document.getElementById('schoolDetailsModal'));
            modal.show();
        }
        
        
        function exportSchoolsReport() {
            if (schoolsDataGlobal.length === 0) {
                alert('لا توجد بيانات للتصدير');
                return;
            }
            
            let csv = 'اسم المدرسة,عدد الطلاب,المبلغ المطلوب,المبلغ المدفوع,المتبقي,نسبة الدفع,مسدد,جزئي,غير مسدد\n';
            
            schoolsDataGlobal.forEach(school => {
                csv += `${school.name},${school.students},${school.fees},${school.paid},${school.remaining},${school.paymentRate.toFixed(1)}%,${school.paidCount || 0},${school.partial || 0},${school.unpaid || 0}\n`;
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `تقرير_المدارس_${new Date().getTime()}.csv`;
            link.click();
            
            alert('تم تصدير التقرير بنجاح');
        }
        
        
        
        function saveFeeSettings() {
            const kindergartenFee = document.getElementById('kindergartenFee').value;
            const elementaryFee = document.getElementById('elementaryFee').value;
            const middleFee = document.getElementById('middleFee').value;
            const installmentCount = document.getElementById('installmentCount').value;
            
            localStorage.setItem('kindergartenFee', kindergartenFee);
            localStorage.setItem('elementaryFee', elementaryFee);
            localStorage.setItem('middleFee', middleFee);
            localStorage.setItem('installmentCount', installmentCount);
            
            showToast(
                `تم حفظ الإعدادات:\nالروضة: ${parseInt(kindergartenFee).toLocaleString('en-US')} د.ع\nالابتدائية: ${parseInt(elementaryFee).toLocaleString('en-US')} د.ع\nالمتوسطة: ${parseInt(middleFee).toLocaleString('en-US')} د.ع`,
                'success',
                'تم الحفظ'
            );
            showAutoSaveIndicator();
        }
        
        
        function getAnnualFeeByGrade(grade) {
            const kindergartenFee = parseInt(localStorage.getItem('kindergartenFee')) || 1000000;
            const elementaryFee = parseInt(localStorage.getItem('elementaryFee')) || 1100000;
            const middleFee = parseInt(localStorage.getItem('middleFee')) || 1300000;
            
            // التحقق من الروضة
            if (grade && (grade.includes('روضة') || grade.toLowerCase().includes('rawda'))) {
                return kindergartenFee;
            }
            
            // التحقق من الصفوف الأخرى
            const gradeNum = parseInt(grade?.replace(/[^0-9]/g, '')) || 0;
            
            if (gradeNum >= 1 && gradeNum <= 6) {
                return elementaryFee; 
            } else if (gradeNum >= 7 && gradeNum <= 9) {
                return middleFee; 
            } else if (gradeNum >= 10 && gradeNum <= 12) {
                return middleFee; 
            }
            
            // القيمة الافتراضية
            return elementaryFee;
        }
        
        function saveWhatsAppSettings() {
            const autoWhatsApp = document.getElementById('autoWhatsApp').checked;
            const reminderWhatsApp = document.getElementById('reminderWhatsApp').checked;
            const reminderDays = document.getElementById('reminderDays').value;
            
            localStorage.setItem('autoWhatsApp', autoWhatsApp);
            localStorage.setItem('reminderWhatsApp', reminderWhatsApp);
            localStorage.setItem('reminderDays', reminderDays);
            
            showToast('تم حفظ إعدادات واتساب بنجاح', 'success', 'تم الحفظ');
            showAutoSaveIndicator();
        }
        
        
        
        
        async function generateMonthlyReport() {
            const monthInput = prompt('أدخل الشهر (1-12):');
            if (!monthInput) return;
            
            const month = parseInt(monthInput);
            if (month < 1 || month > 12) {
                alert('الرجاء إدخال رقم صحيح بين 1 و 12');
                return;
            }
            
            const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                              'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
            const monthName = monthNames[month - 1];
            const currentYear = new Date().getFullYear();
            
            try {
                
                let monthlyData = [];
                let totalPaid = 0;
                let totalStudents = 0;
                
                for (const student of students) {
                    const installments = student.installments || [];
                    for (const inst of installments) {
                        if (inst.payment_date) {
                            const paymentDate = new Date(inst.payment_date);
                            if (paymentDate.getMonth() + 1 === month && paymentDate.getFullYear() === currentYear) {
                                const paidAmount = inst.amount_paid || inst.amount || 0;
                                if (paidAmount > 0) {
                                    monthlyData.push({
                                        'اسم الطالب': student.name,
                                        'ولي الأمر': student.guardian,
                                        'المدرسة': student.schoolName || currentSchoolName || 'غير محدد',
                                        'الصف': student.grade,
                                        'المبلغ المدفوع': paidAmount,
                                        'تاريخ الدفع': inst.payment_date,
                                        'طريقة الدفع': inst.payment_method || 'نقد'
                                    });
                                    totalPaid += paidAmount;
                                    totalStudents++;
                                }
                            }
                        }
                    }
                }
                
                if (monthlyData.length === 0) {
                    alert(`لا توجد دفعات مسجلة لشهر ${monthName} ${currentYear}`);
                    return;
                }
                
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(monthlyData);
                XLSX.utils.book_append_sheet(wb, ws, `تقرير ${monthName}`);
                
                
                const summaryData = [
                    ['ملخص التقرير الشهري'],
                    ['الشهر', monthName],
                    ['السنة', currentYear],
                    ['عدد الدفعات', monthlyData.length],
                    ['عدد الطلاب', totalStudents],
                    ['إجمالي المدفوع', totalPaid]
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'ملخص');
                
                XLSX.writeFile(wb, `تقرير_شهري_${monthName}_${currentYear}.xlsx`);
                alert(`تم إنشاء التقرير الشهري بنجاح!\n\nعدد الدفعات: ${monthlyData.length}\nإجمالي المدفوع: ${totalPaid.toLocaleString('en-US')} د.ع`);
            } catch (error) {
                console.error('خطأ في إنشاء التقرير الشهري:', error);
                alert('حدث خطأ أثناء إنشاء التقرير');
            }
        }
        
        
        async function generateYearlyReport() {
            const yearInput = prompt('أدخل السنة (مثال: 2024):', new Date().getFullYear());
            if (!yearInput) return;
            
            const year = parseInt(yearInput);
            if (isNaN(year) || year < 2000 || year > 2100) {
                alert('الرجاء إدخال سنة صحيحة');
                return;
            }
            
            try {
                
                let yearlyData = [];
                let totalPaid = 0;
                let totalStudents = new Set();
                let monthlyTotals = {};
                
                for (const student of students) {
                    const installments = student.installments || [];
                    for (const inst of installments) {
                        if (inst.payment_date) {
                            const paymentDate = new Date(inst.payment_date);
                            if (paymentDate.getFullYear() === year) {
                                const paidAmount = inst.amount_paid || inst.amount || 0;
                                if (paidAmount > 0) {
                                    const month = paymentDate.getMonth() + 1;
                                    if (!monthlyTotals[month]) {
                                        monthlyTotals[month] = 0;
                                    }
                                    monthlyTotals[month] += paidAmount;
                                    
                                    yearlyData.push({
                                        'اسم الطالب': student.name,
                                        'ولي الأمر': student.guardian,
                                        'المدرسة': student.schoolName || currentSchoolName || 'غير محدد',
                                        'الصف': student.grade,
                                        'المبلغ المدفوع': paidAmount,
                                        'تاريخ الدفع': inst.payment_date,
                                        'الشهر': paymentDate.getMonth() + 1,
                                        'طريقة الدفع': inst.payment_method || 'نقد'
                                    });
                                    totalPaid += paidAmount;
                                    totalStudents.add(student.id);
                                }
                            }
                        }
                    }
                }
                
                if (yearlyData.length === 0) {
                    alert(`لا توجد دفعات مسجلة لسنة ${year}`);
                    return;
                }
                
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(yearlyData);
                XLSX.utils.book_append_sheet(wb, ws, `دفعات ${year}`);
                
                
                const monthNames = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                                  'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                const monthlySummary = [['الشهر', 'المبلغ المدفوع']];
                for (let m = 1; m <= 12; m++) {
                    monthlySummary.push([monthNames[m - 1], monthlyTotals[m] || 0]);
                }
                const monthlyWs = XLSX.utils.aoa_to_sheet(monthlySummary);
                XLSX.utils.book_append_sheet(wb, monthlyWs, 'ملخص شهري');
                
                
                const summaryData = [
                    ['ملخص التقرير السنوي'],
                    ['السنة', year],
                    ['عدد الدفعات', yearlyData.length],
                    ['عدد الطلاب', totalStudents.size],
                    ['إجمالي المدفوع', totalPaid],
                    ['متوسط الدفعة', Math.round(totalPaid / yearlyData.length)]
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'ملخص عام');
                
                XLSX.writeFile(wb, `تقرير_سنوي_${year}.xlsx`);
                alert(`تم إنشاء التقرير السنوي بنجاح!\n\nعدد الدفعات: ${yearlyData.length}\nعدد الطلاب: ${totalStudents.size}\nإجمالي المدفوع: ${totalPaid.toLocaleString('en-US')} د.ع`);
            } catch (error) {
                console.error('خطأ في إنشاء التقرير السنوي:', error);
                alert('حدث خطأ أثناء إنشاء التقرير');
            }
        }
        
        
        function exportToExcel() {
            try {
                if (!students || students.length === 0) {
                    alert('لا توجد بيانات للتصدير');
                    return;
                }
                
                
                const excelData = students.map((student, index) => {
                    const installments = student.installments || [];
                    const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                    const annualFee = student.annualFee || student.annual_fee || 1200000;
                    const finalFee = student.finalFee || student.final_fee || annualFee;
                    const remaining = finalFee - totalPaid;
                    const statusInfo = getFinancialStatus(student);
                    
                    return {
                        'م': index + 1,
                        'رقم الإيصال': student.receiptNumber || '---',
                        'اسم الطالب': student.name,
                        'ولي الأمر': student.guardian,
                        'المدرسة': student.schoolName || currentSchoolName || 'غير محدد',
                        'الصف': student.grade,
                        'المبلغ السنوي': annualFee,
                        'الخصم': student.discount || 0,
                        'المبلغ النهائي': finalFee,
                        'المدفوع': totalPaid,
                        'المتبقي': remaining,
                        'الحالة المالية': statusInfo.status,
                        'تاريخ التسجيل': student.registrationDate || student.registration_date || ''
                    };
                });
                
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, 'قائمة الطلاب');
                
                
                const totalFees = students.reduce((sum, s) => sum + (s.finalFee || s.annualFee || 1200000), 0);
                const totalPaid = students.reduce((sum, s) => {
                    const insts = s.installments || [];
                    return sum + insts.reduce((s, i) => s + (i.amount_paid || i.amount || 0), 0);
                }, 0);
                
                const summaryData = [
                    ['ملخص البيانات'],
                    ['عدد الطلاب', students.length],
                    ['إجمالي المطلوب', totalFees],
                    ['إجمالي المدفوع', totalPaid],
                    ['المتبقي', totalFees - totalPaid]
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'ملخص');
                
                XLSX.writeFile(wb, `قائمة_الطلاب_${new Date().getTime()}.xlsx`);
                alert('تم تصدير البيانات إلى Excel بنجاح!');
            } catch (error) {
                console.error('خطأ في التصدير إلى Excel:', error);
                alert('حدث خطأ أثناء التصدير. تأكد من تحميل مكتبة XLSX.');
            }
        }
        
        
        function exportToPDF() {
            try {
                if (typeof window.jsPDF === 'undefined') {
                    alert('مكتبة jsPDF غير محملة. سيتم استخدام الطباعة العادية.');
                    printList();
                    return;
                }
                
                const { jsPDF } = window.jsPDF;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                
                doc.setFontSize(18);
                doc.setTextColor(15, 118, 110);
                doc.text('قائمة الطلاب - مجموعة رسول الرحمة', 105, 15, { align: 'center' });
                
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const now = new Date();
                doc.text(`تاريخ التصدير: ${now.toLocaleDateString('ar-IQ')}`, 105, 22, { align: 'center' });
                
                
                const tableData = students.map((student, index) => {
                    const installments = student.installments || [];
                    const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                    const annualFee = student.annualFee || student.annual_fee || 1200000;
                    const finalFee = student.finalFee || student.final_fee || annualFee;
                    const remaining = finalFee - totalPaid;
                    const statusInfo = getFinancialStatus(student);
                    
                    return [
                        index + 1,
                        student.receiptNumber || '---',
                        student.name,
                        student.guardian,
                        student.grade,
                        annualFee.toLocaleString('en-US'),
                        totalPaid.toLocaleString('en-US'),
                        remaining.toLocaleString('en-US'),
                        statusInfo.status
                    ];
                });
                
                
                doc.autoTable({
                    head: [['م', 'رقم الإيصال', 'الاسم', 'ولي الأمر', 'الصف', 'المبلغ السنوي', 'المدفوع', 'المتبقي', 'الحالة']],
                    body: tableData,
                    startY: 30,
                    styles: { fontSize: 8, font: 'Arial' },
                    headStyles: { fillColor: [15, 118, 110], textColor: 255 },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    margin: { top: 30, right: 10, left: 10 }
                });
                
                
                const totalFees = students.reduce((sum, s) => sum + (s.finalFee || s.annualFee || 1200000), 0);
                const totalPaid = students.reduce((sum, s) => {
                    const insts = s.installments || [];
                    return sum + insts.reduce((s, i) => s + (i.amount_paid || i.amount || 0), 0);
                }, 0);
                
                doc.addPage();
                doc.setFontSize(16);
                doc.setTextColor(15, 118, 110);
                doc.text('ملخص البيانات', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`عدد الطلاب: ${students.length}`, 20, 40);
                doc.text(`إجمالي المطلوب: ${totalFees.toLocaleString('en-US')} د.ع`, 20, 50);
                doc.text(`إجمالي المدفوع: ${totalPaid.toLocaleString('en-US')} د.ع`, 20, 60);
                doc.text(`المتبقي: ${(totalFees - totalPaid).toLocaleString('en-US')} د.ع`, 20, 70);
                
                
                doc.save(`قائمة_الطلاب_${new Date().getTime()}.pdf`);
                alert('تم تصدير البيانات إلى PDF بنجاح!');
            } catch (error) {
                console.error('خطأ في التصدير إلى PDF:', error);
                alert('حدث خطأ أثناء التصدير. سيتم استخدام الطباعة العادية.');
                printList();
            }
        }
        
        function backupData() {
            try {
                showLoading();
            const data = {
                students: allStudents,
                    settings: {
                        kindergartenFee: localStorage.getItem('kindergartenFee'),
                        elementaryFee: localStorage.getItem('elementaryFee'),
                        middleFee: localStorage.getItem('middleFee'),
                        installmentCount: localStorage.getItem('installmentCount')
                    },
                    timestamp: new Date().toISOString(),
                    version: '1.0'
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
                link.download = `backup_رسول_الرحمة_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
                setTimeout(() => {
                    hideLoading();
                    showToast('تم إنشاء نسخة احتياطية بنجاح', 'success', 'نسخة احتياطية');
                }, 500);
            } catch (error) {
                hideLoading();
                showToast('حدث خطأ في إنشاء النسخة الاحتياطية', 'error', 'خطأ');
            }
        }
        
        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            alert('سيتم إضافة ميزة الاستعادة قريباً');
                        } catch (error) {
                            alert('خطأ في قراءة الملف');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        async function clearCache() {
            const confirmed = await showConfirmDialog('هل أنت متأكد من مسح الذاكرة المؤقتة؟', 'تأكيد', 'نعم، امسح', 'إلغاء');
            if (confirmed) {
                localStorage.clear();
                alert('تم مسح الذاكرة المؤقتة');
                location.reload();
            }
        }
        
        
        window.addEventListener('DOMContentLoaded', function() {
            const kindergartenFee = localStorage.getItem('kindergartenFee');
            const elementaryFee = localStorage.getItem('elementaryFee');
            const middleFee = localStorage.getItem('middleFee');
            const installmentCount = localStorage.getItem('installmentCount');
            const autoWhatsApp = localStorage.getItem('autoWhatsApp') === 'true';
            const reminderWhatsApp = localStorage.getItem('reminderWhatsApp') === 'true';
            const reminderDays = localStorage.getItem('reminderDays');
            
            if (kindergartenFee) document.getElementById('kindergartenFee').value = kindergartenFee;
            if (elementaryFee) document.getElementById('elementaryFee').value = elementaryFee;
            if (middleFee) document.getElementById('middleFee').value = middleFee;
            if (installmentCount) document.getElementById('installmentCount').value = installmentCount;
            if (autoWhatsApp !== null) document.getElementById('autoWhatsApp').checked = autoWhatsApp;
            if (reminderWhatsApp !== null) document.getElementById('reminderWhatsApp').checked = reminderWhatsApp;
            if (reminderDays) document.getElementById('reminderDays').value = reminderDays;
        });

        
        
        
        function sendWhatsAppMessage(studentId, messageType, paymentData = null) {
            const student = students.find(s => s.id === studentId || s.id === parseInt(studentId));
            if (!student) {
                showToast('الطالب غير موجود', 'error', 'خطأ');
                return;
            }
            
            const phone = student.phone || '';
            if (!phone || !Utils.validatePhone(phone)) {
                showToast('رقم الهاتف غير متوفر أو غير صحيح للطالب', 'warning', 'تنبيه');
                return;
            }
            
            
            // تنظيف رقم الهاتف
            const cleanPhone = Utils.cleanPhone(phone);
            
            // بناء الرسالة
            let message = '';
            const schoolName = currentSchoolName || 'مجموعة رسول الرحمة التعليمية';
            
            if (messageType === 'payment' && paymentData) {
                
                const installmentNames = ['الأول', 'الثاني', 'الثالث', 'الرابع'];
                const installmentName = installmentNames[paymentData.installmentNumber - 1] || 'الأول';
                
                const totalPaid = student.installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                const finalFee = getStudentField(student, 'finalFee') || getStudentField(student, 'annualFee') || 1200000;
                const remaining = finalFee - totalPaid;
                
                message = `*${schoolName}*\n\n` +
                    `*إشعار استلام دفعة*\n\n` +
                    `السيد/السيدة ولي أمر الطالب: *${student.guardian}*\n` +
                    `اسم الطالب: *${student.name}*\n` +
                    `الصف: *${student.grade}*\n` +
                    `رقم الوصل: *${getStudentField(student, 'receiptNumber') || '---'}*\n\n` +
                    `تم استلام مبلغ: *${paymentData.amount.toLocaleString('en-US')} دينار عراقي*\n` +
                    `وهو القسط: *${installmentName}*\n` +
                    `تاريخ الدفع: *${formatDateArabic(paymentData.paymentDate)}*\n\n` +
                    `*ملخص الحساب:*\n` +
                    `إجمالي المطلوب: ${finalFee.toLocaleString('en-US')} د.ع\n` +
                    `إجمالي المدفوع: ${totalPaid.toLocaleString('en-US')} د.ع\n` +
                    `المتبقي: ${remaining.toLocaleString('en-US')} د.ع\n\n` +
                    `شكراً لكم على متابعة تسديد الأقساط.\n` +
                    `*${schoolName}*`;
                    
            } else if (messageType === 'reminder') {
                
                const installments = student.installments || [];
                const installmentAmount = calculateInstallmentAmount(student);
                const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                const finalFee = getStudentField(student, 'finalFee') || getStudentField(student, 'annualFee') || 1200000;
                const remaining = finalFee - totalPaid;
                
                
                const unpaidInstallments = [];
                installments.forEach((inst, index) => {
                    const paid = inst.amount_paid || inst.amount || 0;
                    if (paid < installmentAmount) {
                        const installmentNames = ['الأول', 'الثاني', 'الثالث', 'الرابع'];
                        unpaidInstallments.push({
                            number: index + 1,
                            name: installmentNames[index],
                            paid: paid,
                            required: installmentAmount,
                            remaining: installmentAmount - paid
                        });
                    }
                });
                
                message = `*${schoolName}*\n\n` +
                    `*تذكير بدفع الأقساط المدرسية*\n\n` +
                    `السيد/السيدة ولي أمر الطالب: *${student.guardian}*\n` +
                    `اسم الطالب: *${student.name}*\n` +
                    `الصف: *${student.grade}*\n` +
                    `رقم الوصل: *${getStudentField(student, 'receiptNumber') || '---'}*\n\n`;
                
                if (unpaidInstallments.length > 0) {
                    message += `*الدفعات المستحقة:*\n`;
                    unpaidInstallments.forEach(inst => {
                        message += `- القسط ${inst.name}: ${inst.remaining.toLocaleString('en-US')} د.ع (المطلوب: ${inst.required.toLocaleString('en-US')} د.ع)\n`;
                    });
                    message += `\n`;
                }
                
                message += `*ملخص الحساب:*\n` +
                    `إجمالي المطلوب: ${finalFee.toLocaleString('en-US')} د.ع\n` +
                    `إجمالي المدفوع: ${totalPaid.toLocaleString('en-US')} د.ع\n` +
                    `*المتبقي: ${remaining.toLocaleString('en-US')} د.ع*\n\n` +
                    `نرجو منكم التكرم بتسديد المبلغ المتبقي في أقرب وقت ممكن.\n\n` +
                    `شكراً لكم\n` +
                    `*${schoolName}*`;
                    
            } else {
                
                message = `*${schoolName}*\n\n` +
                    `السيد/السيدة ولي أمر الطالب: *${student.guardian}*\n` +
                    `اسم الطالب: *${student.name}*\n` +
                    `الصف: *${student.grade}*\n\n` +
                    `نرجو منكم التواصل معنا بخصوص الأقساط المدرسية.\n\n` +
                    `*${schoolName}*`;
            }
            
            // بناء رابط واتساب
            const whatsappUrl = Utils.buildWhatsAppURL(cleanPhone, message);
            
            // فتح واتساب
            window.open(whatsappUrl, '_blank');
        }
        
        
        async function sendBulkWhatsAppReminders() {
            const unpaidStudents = students.filter(student => {
                const installments = student.installments || [];
                const totalPaid = installments.reduce((sum, inst) => sum + (inst.amount_paid || inst.amount || 0), 0);
                const finalFee = getStudentField(student, 'finalFee') || getStudentField(student, 'annualFee') || 1200000;
                const remaining = finalFee - totalPaid;
                return remaining > 0 && student.phone;
            });
            
            if (unpaidStudents.length === 0) {
                showToast('لا يوجد طلاب متأخرين لديهم أرقام هواتف', 'info', 'معلومة');
                return;
            }
            
            const confirmMessage = `سيتم إرسال تذكيرات واتساب إلى ${unpaidStudents.length} ولي أمر.\n\nهل تريد المتابعة؟`;
            
            const confirmed = await showConfirmDialog(confirmMessage, 'تأكيد', 'نعم، أرسل', 'إلغاء');
            if (!confirmed) {
                return;
            }
            
            
            let index = 0;
            const sendNext = () => {
                if (index < unpaidStudents.length) {
                    const student = unpaidStudents[index];
                    sendWhatsAppMessage(student.id, 'reminder');
                    index++;
                    if (index < unpaidStudents.length) {
                        setTimeout(sendNext, 2000); 
                    } else {
                        showToast(`تم فتح ${unpaidStudents.length} رسالة واتساب. يرجى إرسالها واحدة تلو الأخرى.`, 'success', 'نجح');
                    }
                }
            };
            
            sendNext();
        }
        
        
        // استخدام Utils.formatDateArabic بدلاً من هذه الدالة
        const formatDateArabic = Utils.formatDateArabic;
        
        // دالة قديمة (للتوافق مع الكود القديم)
        function formatDateArabicOld(dateString) {
            if (!dateString) return '';
            
            try {
                let date;
                
                if (dateString instanceof Date) {
                    date = dateString;
                } else if (typeof dateString === 'string') {
                    if (dateString.includes('/')) {
                        const parts = dateString.split('/');
                        if (parts.length === 3) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1;
                            const year = parseInt(parts[2]);
                            date = new Date(year, month, day);
                        } else {
                            date = new Date(dateString);
                        }
                    } else if (dateString.includes('-')) {
                        const parts = dateString.split('-');
                        if (parts.length === 3) {
                            const year = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1;
                            const day = parseInt(parts[2]);
                            date = new Date(year, month, day);
                        } else {
                            date = new Date(dateString);
                        }
                    } else {
                        date = new Date(dateString);
                    }
                } else {
                    date = new Date(dateString);
                }
                
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                
                const day = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear();
                
                const monthNames = [
                    'يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو',
                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'
                ];
                
                if (month < 1 || month > 12) {
                    return dateString;
                }
                
                return `${day} ${monthNames[month - 1]} ${year}`;
            } catch (error) {
                console.error('خطأ في تنسيق التاريخ:', error, dateString);
                return dateString;
            }
        }

        // ============================================
        // دوال الحضور والغياب
        // ============================================
        let attendanceData = [];
        let teachersData = [];
        let subjectsData = [];
        let lessonsData = [];
        
        // دالة لتحديث قائمة الأساتذة في القوائم المنسدلة
        function updateTeacherSelect() {
            // تحديث قائمة الأساتذة في نموذج المواد
            const subjectTeacherSelect = document.getElementById('subjectTeacher');
            if (subjectTeacherSelect) {
                updateTeacherSelectForSubject();
            }
        }
        
        // دوال مساعدة لـ localStorage مع معالجة الأخطاء
        function safeLocalStorageSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (error) {
                console.error(`خطأ في حفظ ${key} في localStorage:`, error);
                showToast('تحذير: فشل حفظ البيانات محلياً. قد تكون المساحة ممتلئة.', 'warning', 'تحذير');
                return false;
            }
        }
        
        function safeLocalStorageGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (error) {
                console.error(`خطأ في قراءة ${key} من localStorage:`, error);
                return null;
            }
        }
        
        function safeLocalStorageRemoveItem(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (error) {
                console.error(`خطأ في حذف ${key} من localStorage:`, error);
                return false;
            }
        }
        let gradesData = [];
        
        async function loadAttendanceData() {
            const date = document.getElementById('attendanceDate').value;
            const grade = document.getElementById('attendanceGrade').value;
            const status = document.getElementById('attendanceStatus').value;
            
            if (!date) {
                showToast('الرجاء اختيار التاريخ', 'warning', 'تنبيه');
                return;
            }
            
            try {
                showLoading();
                
                // تحميل بيانات الحضور من قاعدة البيانات أو localStorage
                let attendance = [];
                if (supabaseClient && databaseAvailable) {
                    let query = supabaseClient.from('attendance').select('*').eq('date', date);
                    if (grade !== 'all') {
                        query = query.eq('grade', grade);
                    }
                    const { data, error } = await query;
                    if (!error && data) {
                        attendance = data;
                    }
                } else {
                    // تحميل من localStorage
                    const stored = localStorage.getItem(`attendance_${date}_${grade}`);
                    if (stored) {
                        attendance = JSON.parse(stored);
                    }
                }
                
                // إذا لم توجد بيانات، إنشاء سجل افتراضي للطلاب
                if (attendance.length === 0) {
                    const filteredStudents = grade === 'all' ? students : students.filter(s => s.grade === grade);
                    attendance = filteredStudents.map(student => ({
                        id: Date.now() + Math.random(),
                        student_id: student.id,
                        student_name: student.name,
                        grade: student.grade,
                        date: date,
                        status: 'present',
                        time: new Date().toLocaleTimeString('ar-IQ'),
                        notes: ''
                    }));
                }
                
                // فلترة حسب الحالة
                if (status !== 'all') {
                    attendance = attendance.filter(a => a.status === status);
                }
                
                attendanceData = attendance;
                renderAttendanceTable();
                hideLoading();
            } catch (error) {
                console.error('خطأ في تحميل بيانات الحضور:', error);
                showToast('حدث خطأ في تحميل بيانات الحضور', 'error', 'خطأ');
                hideLoading();
            }
        }
        
        function renderAttendanceTable() {
            const tbody = document.getElementById('attendanceTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (attendanceData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">لا توجد بيانات</td></tr>';
                return;
            }
            
            attendanceData.forEach((record, index) => {
                const statusColors = {
                    'present': 'success',
                    'absent': 'danger',
                    'late': 'warning',
                    'excused': 'info'
                };
                
                const statusText = {
                    'present': 'حاضر',
                    'absent': 'غائب',
                    'late': 'متأخر',
                    'excused': 'معذور'
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${record.student_name}</strong></td>
                    <td>${record.grade}</td>
                    <td><span class="badge bg-${statusColors[record.status] || 'secondary'}">${statusText[record.status] || record.status}</span></td>
                    <td>${record.time || '---'}</td>
                    <td>${record.notes || '---'}</td>
                    <td class="no-print">
                        <button onclick="editAttendance('${record.id}')" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> تعديل
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function markAllPresent() {
            if (attendanceData.length === 0) {
                showToast('لا توجد بيانات حضور', 'warning', 'تنبيه');
                return;
            }
            
            attendanceData.forEach(record => {
                record.status = 'present';
                record.time = new Date().toLocaleTimeString('ar-IQ');
            });
            
            renderAttendanceTable();
            saveAttendanceData();
            showToast('تم تسجيل الجميع حاضر', 'success', 'نجح');
        }
        
        async function saveAttendanceData() {
            try {
                if (supabaseClient && databaseAvailable) {
                    // حفظ في Supabase
                    const { error } = await supabaseClient.from('attendance').upsert(attendanceData);
                    if (error) throw error;
                } else {
                    // حفظ في localStorage
                    const date = document.getElementById('attendanceDate').value;
                    const grade = document.getElementById('attendanceGrade').value;
                    localStorage.setItem(`attendance_${date}_${grade}`, JSON.stringify(attendanceData));
                }
            } catch (error) {
                console.error('خطأ في حفظ بيانات الحضور:', error);
            }
        }
        
        function editAttendance(id) {
            const record = attendanceData.find(r => r.id == id);
            if (!record) return;
            
            const newStatus = prompt('اختر الحالة:\n1. حاضر\n2. غائب\n3. متأخر\n4. معذور', record.status);
            if (newStatus && ['present', 'absent', 'late', 'excused'].includes(newStatus)) {
                record.status = newStatus;
                record.time = new Date().toLocaleTimeString('ar-IQ');
                renderAttendanceTable();
                saveAttendanceData();
                showToast('تم تحديث الحضور', 'success', 'نجح');
            }
        }
        
        async function exportAttendanceReport() {
            if (attendanceData.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'warning', 'تنبيه');
                return;
            }
            
            // تصدير إلى Excel
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(attendanceData);
            XLSX.utils.book_append_sheet(wb, ws, 'الحضور والغياب');
            XLSX.writeFile(wb, `تقرير_الحضور_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('تم تصدير التقرير بنجاح', 'success', 'نجح');
        }
        
        // ============================================
        // دوال النتائج الدراسية
        // ============================================
        async function loadGradesData() {
            const grade = document.getElementById('gradesGradeFilter').value;
            const semester = document.getElementById('gradesSemester').value;
            const subject = document.getElementById('gradesSubject').value;
            
            try {
                showLoading();
                
                // تحميل النتائج من قاعدة البيانات
                let grades = [];
                if (supabaseClient && databaseAvailable) {
                    let query = supabaseClient.from('grades').select('*');
                    if (grade !== 'all') query = query.eq('grade', grade);
                    if (semester) query = query.eq('semester', semester);
                    if (subject !== 'all') query = query.eq('subject', subject);
                    
                    const { data, error } = await query;
                    if (!error && data) {
                        grades = data;
                    }
                } else {
                    const stored = localStorage.getItem('grades');
                    if (stored) {
                        grades = JSON.parse(stored);
                    }
                }
                
                gradesData = grades;
                renderGradesTable();
                hideLoading();
            } catch (error) {
                console.error('خطأ في تحميل النتائج:', error);
                showToast('حدث خطأ في تحميل النتائج', 'error', 'خطأ');
                hideLoading();
            }
        }
        
        function renderGradesTable() {
            const tbody = document.getElementById('gradesTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (gradesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">لا توجد نتائج</td></tr>';
                return;
            }
            
            gradesData.forEach((grade, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${grade.student_name}</strong></td>
                    <td>${grade.grade}</td>
                    <td>${grade.subject}</td>
                    <td>${grade.score}</td>
                    <td>${grade.average || '---'}</td>
                    <td><span class="badge bg-${getGradeBadgeColor(grade.score)}">${getGradeText(grade.score)}</span></td>
                    <td class="no-print">
                        <button onclick="editGradeRecord('${grade.id}')" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> تعديل
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getGradeBadgeColor(score) {
            const numScore = parseFloat(score) || 0;
            if (numScore >= 90) return 'success';
            if (numScore >= 75) return 'info';
            if (numScore >= 60) return 'warning';
            return 'danger';
        }
        
        function getGradeText(score) {
            const numScore = parseFloat(score) || 0;
            if (numScore >= 90) return 'ممتاز';
            if (numScore >= 75) return 'جيد جداً';
            if (numScore >= 60) return 'جيد';
            return 'مقبول';
        }
        
        function addGrade() {
            showToast('سيتم إضافة نافذة إدخال الدرجات قريباً', 'info', 'قريباً');
        }
        
        function editGradeRecord(id) {
            const grade = gradesData.find(g => g.id == id);
            if (!grade) return;
            
            const newScore = prompt('أدخل الدرجة الجديدة:', grade.score);
            if (newScore && !isNaN(newScore)) {
                grade.score = parseFloat(newScore);
                renderGradesTable();
                showToast('تم تحديث الدرجة', 'success', 'نجح');
            }
        }
        
        async function exportGradesReport() {
            if (gradesData.length === 0) {
                showToast('لا توجد نتائج للتصدير', 'warning', 'تنبيه');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(gradesData);
            XLSX.utils.book_append_sheet(wb, ws, 'النتائج');
            XLSX.writeFile(wb, `النتائج_${new Date().toISOString().split('T')[0]}.xlsx`);
            showToast('تم تصدير النتائج بنجاح', 'success', 'نجح');
        }
        
        function printGradesReport() {
            window.print();
        }
        
        // ============================================
        // دوال إدارة الأساتذة
        // ============================================
        async function loadTeachersData() {
            try {
                showLoading();
                
                let teachers = [];
                if (supabaseClient && databaseAvailable) {
                    const { data, error } = await supabaseClient.from('teachers').select('*');
                    if (!error && data) {
                        teachers = data;
                    }
                } else {
                    const stored = safeLocalStorageGetItem('teachers');
                    if (stored) {
                        try {
                        teachers = JSON.parse(stored);
                        } catch (error) {
                            console.error('خطأ في تحليل بيانات الأساتذة:', error);
                            teachers = [];
                        }
                    }
                }
                
                teachersData = teachers;
                renderTeachersTable();
                hideLoading();
            } catch (error) {
                console.error('خطأ في تحميل الأساتذة:', error);
                showToast('حدث خطأ في تحميل الأساتذة', 'error', 'خطأ');
                hideLoading();
            }
        }
        
        function renderTeachersTable() {
            const tbody = document.getElementById('teachersTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (teachersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">لا يوجد أساتذة</td></tr>';
                return;
            }
            
            teachersData.forEach((teacher, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${teacher.name}</strong></td>
                    <td>${teacher.subject || '---'}</td>
                    <td>${teacher.grades ? (Array.isArray(teacher.grades) ? teacher.grades.join(', ') : teacher.grades) : '---'}</td>
                    <td>${teacher.phone || '---'}</td>
                    <td>${teacher.email || '---'}</td>
                    <td><span class="badge bg-${teacher.is_active !== false ? 'success' : 'secondary'}">${teacher.is_active !== false ? 'نشط' : 'غير نشط'}</span></td>
                    <td class="no-print">
                        <button onclick="editTeacher('${teacher.id}')" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> تعديل
                        </button>
                        <button onclick="deleteTeacher('${teacher.id}')" class="btn btn-danger-custom btn-sm">
                            <i class="bi bi-trash"></i> حذف
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function addTeacher() {
            document.getElementById('teacherModalTitle').textContent = 'إضافة أستاذ جديد';
            document.getElementById('teacherForm').reset();
            document.getElementById('teacherId').value = '';
            document.getElementById('teacherIsActive').value = 'true';
            const modal = new bootstrap.Modal(document.getElementById('teacherModal'));
            modal.show();
        }
        
        function editTeacher(id) {
            const teacher = teachersData.find(t => t.id == id);
            if (!teacher) {
                showToast('الأستاذ غير موجود', 'error', 'خطأ');
                return;
            }
            
            document.getElementById('teacherModalTitle').textContent = 'تعديل بيانات الأستاذ';
            document.getElementById('teacherId').value = teacher.id;
            document.getElementById('teacherName').value = teacher.name || '';
            document.getElementById('teacherSubject').value = teacher.subject || '';
            document.getElementById('teacherGrades').value = teacher.grades ? (Array.isArray(teacher.grades) ? teacher.grades.join(', ') : teacher.grades) : '';
            document.getElementById('teacherPhone').value = teacher.phone || '';
            document.getElementById('teacherEmail').value = teacher.email || '';
            document.getElementById('teacherIsActive').value = teacher.is_active !== false ? 'true' : 'false';
            
            const modal = new bootstrap.Modal(document.getElementById('teacherModal'));
            modal.show();
        }
        
        async function saveTeacher() {
            try {
                const teacherId = document.getElementById('teacherId').value;
                const teacherData = {
                    name: document.getElementById('teacherName').value.trim(),
                    subject: document.getElementById('teacherSubject').value.trim(),
                    grades: document.getElementById('teacherGrades').value.split(',').map(g => g.trim()).filter(g => g),
                    phone: document.getElementById('teacherPhone').value.trim() || null,
                    email: document.getElementById('teacherEmail').value.trim() || null,
                    is_active: document.getElementById('teacherIsActive').value === 'true'
                };
                
                if (!teacherData.name || !teacherData.subject) {
                    showToast('الرجاء إدخال اسم الأستاذ والمادة', 'warning', 'تنبيه');
                    return;
                }
                
                showLoading();
                
                if (teacherId) {
                    // تحديث أستاذ موجود
                    const index = teachersData.findIndex(t => t.id == teacherId);
                    if (index !== -1) {
                        teachersData[index] = { ...teachersData[index], ...teacherData };
                        
                        // حفظ في قاعدة البيانات
                        if (supabaseClient && databaseAvailable) {
                            try {
                                const { error } = await supabaseClient
                                    .from('teachers')
                                    .update(teacherData)
                                    .eq('id', teacherId);
                                
                                if (error) throw error;
                            } catch (error) {
                                console.error('خطأ في تحديث الأستاذ:', error);
                                // حفظ في قائمة الانتظار
                                addToOfflineQueue({
                                    type: 'update',
                                    table: 'teachers',
                                    id: teacherId,
                                    data: teacherData
                                });
                            }
                        } else {
                            // حفظ محلي
                            safeLocalStorageSetItem('teachers', JSON.stringify(teachersData));
                        }
                        
                        showToast('تم تحديث بيانات الأستاذ بنجاح', 'success', 'نجح');
                    }
                } else {
                    // إضافة أستاذ جديد
                    const newTeacher = {
                        id: Date.now().toString(),
                        ...teacherData,
                        created_at: new Date().toISOString()
                    };
                    
                    teachersData.push(newTeacher);
                    
                    // حفظ في قاعدة البيانات
                    if (supabaseClient && databaseAvailable) {
                        try {
                            const { data, error } = await supabaseClient
                                .from('teachers')
                                .insert([newTeacher])
                                .select();
                            
                            if (error) throw error;
                            if (data && data[0]) {
                                newTeacher.id = data[0].id;
                            }
                        } catch (error) {
                            console.error('خطأ في إضافة الأستاذ:', error);
                            // حفظ في قائمة الانتظار
                            addToOfflineQueue({
                                type: 'insert',
                                table: 'teachers',
                                data: newTeacher
                            });
                        }
                    } else {
                        // حفظ محلي
                        safeLocalStorageSetItem('teachers', JSON.stringify(teachersData));
                    }
                    
                    showToast('تم إضافة الأستاذ بنجاح', 'success', 'نجح');
                }
                
                hideLoading();
                renderTeachersTable();
                updateTeacherSelect();
                bootstrap.Modal.getInstance(document.getElementById('teacherModal')).hide();
            } catch (error) {
                hideLoading();
                showToast('حدث خطأ في حفظ بيانات الأستاذ: ' + (error.message || 'خطأ غير معروف'), 'error', 'خطأ');
            }
        }
        
        async function deleteTeacher(id) {
            const confirmed = await showConfirmDialog('هل أنت متأكد من حذف هذا الأستاذ؟', 'تأكيد الحذف', 'نعم، احذف', 'إلغاء');
            if (confirmed) {
                try {
                    showLoading();
                    
                    // حذف من قاعدة البيانات
                    if (supabaseClient && databaseAvailable) {
                        try {
                            const { error } = await supabaseClient
                                .from('teachers')
                                .delete()
                                .eq('id', id);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.error('خطأ في حذف الأستاذ:', error);
                            // حفظ في قائمة الانتظار
                            addToOfflineQueue({
                                type: 'delete',
                                table: 'teachers',
                                id: id
                            });
                        }
                    }
                    
                    // حذف من البيانات المحلية
                teachersData = teachersData.filter(t => t.id != id);
                    
                    // حفظ محلي
                    safeLocalStorageSetItem('teachers', JSON.stringify(teachersData));
                    
                    hideLoading();
                renderTeachersTable();
                    updateTeacherSelect();
                showToast('تم حذف الأستاذ', 'success', 'نجح');
                } catch (error) {
                    hideLoading();
                    showToast('حدث خطأ في حذف الأستاذ', 'error', 'خطأ');
                }
            }
        }
        
        // ============================================
        // دوال المواد الدراسية
        // ============================================
        async function loadSubjectsData() {
            try {
                showLoading();
                
                let subjects = [];
                if (supabaseClient && databaseAvailable) {
                    const { data, error } = await supabaseClient.from('subjects').select('*');
                    if (!error && data) {
                        subjects = data;
                    }
                } else {
                    const stored = safeLocalStorageGetItem('subjects');
                    if (stored) {
                        try {
                        subjects = JSON.parse(stored);
                        } catch (error) {
                            console.error('خطأ في تحليل بيانات المواد:', error);
                            subjects = [];
                        }
                    }
                }
                
                subjectsData = subjects;
                renderSubjectsTable();
                hideLoading();
            } catch (error) {
                console.error('خطأ في تحميل المواد:', error);
                showToast('حدث خطأ في تحميل المواد', 'error', 'خطأ');
                hideLoading();
            }
        }
        
        function renderSubjectsTable() {
            const tbody = document.getElementById('subjectsTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (subjectsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">لا توجد مواد</td></tr>';
                return;
            }
            
            subjectsData.forEach((subject, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${subject.name}</strong></td>
                    <td>${subject.grade || '---'}</td>
                    <td>${subject.periods || 0}</td>
                    <td>${subject.teacher_name || '---'}</td>
                    <td><span class="badge bg-${subject.is_active !== false ? 'success' : 'secondary'}">${subject.is_active !== false ? 'نشط' : 'غير نشط'}</span></td>
                    <td class="no-print">
                        <button onclick="editSubject('${subject.id}')" class="btn btn-warning btn-sm">
                            <i class="bi bi-pencil"></i> تعديل
                        </button>
                        <button onclick="deleteSubject('${subject.id}')" class="btn btn-danger-custom btn-sm">
                            <i class="bi bi-trash"></i> حذف
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function addSubject() {
            document.getElementById('subjectModalTitle').textContent = 'إضافة مادة جديدة';
            document.getElementById('subjectForm').reset();
            document.getElementById('subjectId').value = '';
            document.getElementById('subjectIsActive').value = 'true';
            updateTeacherSelectForSubject();
            const modal = new bootstrap.Modal(document.getElementById('subjectModal'));
            modal.show();
        }
        
        function editSubject(id) {
            const subject = subjectsData.find(s => s.id == id);
            if (!subject) {
                showToast('المادة غير موجودة', 'error', 'خطأ');
                return;
            }
            
            document.getElementById('subjectModalTitle').textContent = 'تعديل بيانات المادة';
            document.getElementById('subjectId').value = subject.id;
            document.getElementById('subjectName').value = subject.name || '';
            document.getElementById('subjectGrade').value = subject.grade || '';
            document.getElementById('subjectPeriods').value = subject.periods || 0;
            document.getElementById('subjectIsActive').value = subject.is_active !== false ? 'true' : 'false';
            updateTeacherSelectForSubject(subject.teacher_name || subject.teacher_id);
            
            const modal = new bootstrap.Modal(document.getElementById('subjectModal'));
            modal.show();
        }
        
        function updateTeacherSelectForSubject(selectedTeacher = '') {
            const select = document.getElementById('subjectTeacher');
            select.innerHTML = '<option value="">-- اختر الأستاذ --</option>';
            
            teachersData.forEach(teacher => {
                if (teacher.is_active !== false) {
                    const option = document.createElement('option');
                    option.value = teacher.name;
                    option.textContent = teacher.name;
                    if (selectedTeacher === teacher.name) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
            });
        }
        
        async function saveSubject() {
            try {
                const subjectId = document.getElementById('subjectId').value;
                const subjectData = {
                    name: document.getElementById('subjectName').value.trim(),
                    grade: document.getElementById('subjectGrade').value || null,
                    periods: parseInt(document.getElementById('subjectPeriods').value) || 0,
                    teacher_name: document.getElementById('subjectTeacher').value || null,
                    is_active: document.getElementById('subjectIsActive').value === 'true'
                };
                
                if (!subjectData.name) {
                    showToast('الرجاء إدخال اسم المادة', 'warning', 'تنبيه');
                    return;
                }
                
                showLoading();
                
                if (subjectId) {
                    // تحديث مادة موجودة
                    const index = subjectsData.findIndex(s => s.id == subjectId);
                    if (index !== -1) {
                        subjectsData[index] = { ...subjectsData[index], ...subjectData };
                        
                        // حفظ في قاعدة البيانات
                        if (supabaseClient && databaseAvailable) {
                            try {
                                const { error } = await supabaseClient
                                    .from('subjects')
                                    .update(subjectData)
                                    .eq('id', subjectId);
                                
                                if (error) throw error;
                            } catch (error) {
                                console.error('خطأ في تحديث المادة:', error);
                                // حفظ في قائمة الانتظار
                                addToOfflineQueue({
                                    type: 'update',
                                    table: 'subjects',
                                    id: subjectId,
                                    data: subjectData
                                });
                            }
                        } else {
                            // حفظ محلي
                            safeLocalStorageSetItem('subjects', JSON.stringify(subjectsData));
                        }
                        
                        showToast('تم تحديث بيانات المادة بنجاح', 'success', 'نجح');
                    }
                } else {
                    // إضافة مادة جديدة
                    const newSubject = {
                        id: Date.now().toString(),
                        ...subjectData,
                        created_at: new Date().toISOString()
                    };
                    
                    subjectsData.push(newSubject);
                    
                    // حفظ في قاعدة البيانات
                    if (supabaseClient && databaseAvailable) {
                        try {
                            const { data, error } = await supabaseClient
                                .from('subjects')
                                .insert([newSubject])
                                .select();
                            
                            if (error) throw error;
                            if (data && data[0]) {
                                newSubject.id = data[0].id;
                            }
                        } catch (error) {
                            console.error('خطأ في إضافة المادة:', error);
                            // حفظ في قائمة الانتظار
                            addToOfflineQueue({
                                type: 'insert',
                                table: 'subjects',
                                data: newSubject
                            });
                        }
                    } else {
                        // حفظ محلي
                        safeLocalStorageSetItem('subjects', JSON.stringify(subjectsData));
                    }
                    
                    showToast('تم إضافة المادة بنجاح', 'success', 'نجح');
                }
                
                hideLoading();
                renderSubjectsTable();
                bootstrap.Modal.getInstance(document.getElementById('subjectModal')).hide();
            } catch (error) {
                hideLoading();
                showToast('حدث خطأ في حفظ بيانات المادة: ' + (error.message || 'خطأ غير معروف'), 'error', 'خطأ');
            }
        }
        
        async function deleteSubject(id) {
            const confirmed = await showConfirmDialog('هل أنت متأكد من حذف هذه المادة؟', 'تأكيد الحذف', 'نعم، احذف', 'إلغاء');
            if (confirmed) {
                try {
                    showLoading();
                    
                    // حذف من قاعدة البيانات
                    if (supabaseClient && databaseAvailable) {
                        try {
                            const { error } = await supabaseClient
                                .from('subjects')
                                .delete()
                                .eq('id', id);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.error('خطأ في حذف المادة:', error);
                            // حفظ في قائمة الانتظار
                            addToOfflineQueue({
                                type: 'delete',
                                table: 'subjects',
                                id: id
                            });
                        }
                    }
                    
                    // حذف من البيانات المحلية
                subjectsData = subjectsData.filter(s => s.id != id);
                    
                    // حفظ محلي
                    safeLocalStorageSetItem('subjects', JSON.stringify(subjectsData));
                    
                    hideLoading();
                renderSubjectsTable();
                showToast('تم حذف المادة', 'success', 'نجح');
                } catch (error) {
                    hideLoading();
                    showToast('حدث خطأ في حذف المادة', 'error', 'خطأ');
                }
            }
        }

        // ============================================
        // دوال إدارة الدروس
        // ============================================
        
        async function loadLessonsData() {
            try {
                showLoading();
                
                // تحميل من قاعدة البيانات
                if (supabaseClient && databaseAvailable) {
                    try {
                        let query = supabaseClient
                            .from('lessons')
                            .select('*')
                            .order('day', { ascending: true })
                            .order('period', { ascending: true });
                        
                        if (currentSchoolId && currentSchoolId !== 'admin') {
                            query = query.eq('school_id', currentSchoolId);
                        }
                        
                        const { data, error } = await query;
                        
                        if (error) throw error;
                        
                        if (data) {
                            lessonsData = data;
                            safeLocalStorageSetItem('lessons', JSON.stringify(lessonsData));
                        }
                    } catch (error) {
                        console.error('خطأ في تحميل الدروس من قاعدة البيانات:', error);
                        // تحميل من localStorage كبديل
                        const localData = safeLocalStorageGetItem('lessons');
                        if (localData) {
                            lessonsData = JSON.parse(localData);
                        }
                    }
                } else {
                    // تحميل من localStorage
                    const localData = safeLocalStorageGetItem('lessons');
                    if (localData) {
                        lessonsData = JSON.parse(localData);
                    }
                }
                
                renderLessonsTable();
                updateLessonsFilters();
                renderWeeklySchedule();
                hideLoading();
            } catch (error) {
                console.error('خطأ في تحميل بيانات الدروس:', error);
                hideLoading();
                showToast('حدث خطأ في تحميل بيانات الدروس', 'error', 'خطأ');
            }
        }
        
        function renderLessonsTable() {
            const tbody = document.getElementById('lessonsTable');
            if (!tbody) return;
            
            if (!lessonsData || lessonsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">لا توجد دروس مسجلة</td></tr>';
                return;
            }
            
            // فلترة حسب المدرسة الحالية
            let filteredLessons = lessonsData;
            if (currentSchoolId && currentSchoolId !== 'admin') {
                filteredLessons = lessonsData.filter(l => String(l.school_id) === String(currentSchoolId));
            }
            
            // تطبيق الفلاتر
            const gradeFilter = document.getElementById('lessonGradeFilter')?.value;
            const teacherFilter = document.getElementById('lessonTeacherFilter')?.value;
            const subjectFilter = document.getElementById('lessonSubjectFilter')?.value;
            
            if (gradeFilter && gradeFilter !== 'all') {
                filteredLessons = filteredLessons.filter(l => l.grade === gradeFilter);
            }
            if (teacherFilter && teacherFilter !== 'all') {
                filteredLessons = filteredLessons.filter(l => l.teacher_name === teacherFilter);
            }
            if (subjectFilter && subjectFilter !== 'all') {
                filteredLessons = filteredLessons.filter(l => l.subject_name === subjectFilter);
            }
            
            tbody.innerHTML = filteredLessons.map((lesson, index) => {
                const statusBadge = lesson.is_active !== false 
                    ? '<span class="badge bg-success">نشط</span>' 
                    : '<span class="badge bg-secondary">غير نشط</span>';
                
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${lesson.day || '---'}</td>
                        <td>الحصة ${lesson.period || '---'}</td>
                        <td>${lesson.grade || '---'}</td>
                        <td>${lesson.subject_name || '---'}</td>
                        <td>${lesson.teacher_name || '---'}</td>
                        <td>${lesson.room || '---'}</td>
                        <td>${statusBadge}</td>
                        <td class="no-print">
                            <button onclick="editLesson('${lesson.id}')" class="btn btn-sm btn-info-custom" title="تعديل">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button onclick="deleteLesson('${lesson.id}')" class="btn btn-sm btn-danger-custom" title="حذف">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateLessonsFilters() {
            // تحديث فلتر الصفوف
            const gradeFilter = document.getElementById('lessonGradeFilter');
            if (gradeFilter) {
                const allGrades = new Set(lessonsData.map(l => l.grade).filter(Boolean));
                gradeFilter.innerHTML = '<option value="all">جميع الصفوف</option>';
                Array.from(allGrades).sort().forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = grade;
                    gradeFilter.appendChild(option);
                });
            }
            
            // تحديث فلتر الأساتذة
            const teacherFilter = document.getElementById('lessonTeacherFilter');
            if (teacherFilter) {
                const allTeachers = new Set(lessonsData.map(l => l.teacher_name).filter(Boolean));
                teacherFilter.innerHTML = '<option value="all">جميع الأساتذة</option>';
                Array.from(allTeachers).sort().forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher;
                    option.textContent = teacher;
                    teacherFilter.appendChild(option);
                });
            }
            
            // تحديث فلتر المواد
            const subjectFilter = document.getElementById('lessonSubjectFilter');
            if (subjectFilter) {
                const allSubjects = new Set(lessonsData.map(l => l.subject_name).filter(Boolean));
                subjectFilter.innerHTML = '<option value="all">جميع المواد</option>';
                Array.from(allSubjects).sort().forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectFilter.appendChild(option);
                });
            }
        }
        
        function filterLessonsByGrade() {
            renderLessonsTable();
            renderWeeklySchedule();
        }
        
        function filterLessonsByTeacher() {
            renderLessonsTable();
            renderWeeklySchedule();
        }
        
        function filterLessonsBySubject() {
            renderLessonsTable();
            renderWeeklySchedule();
        }
        
        function openAddLessonModal() {
            document.getElementById('lessonId').value = '';
            document.getElementById('lessonModalTitle').textContent = 'إضافة درس جديد';
            document.getElementById('lessonForm').reset();
            
            // تحديث قوائم الاختيار
            updateLessonGradeSelect();
            updateLessonSubjectSelect();
            updateLessonTeacherSelect();
            
            const modal = new bootstrap.Modal(document.getElementById('lessonModal'));
            modal.show();
        }
        
        function updateLessonGradeSelect(selectedGrade = '') {
            const select = document.getElementById('lessonGrade');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- اختر الصف --</option>';
            const allGrades = new Set(students.map(s => s.grade).filter(Boolean));
            Array.from(allGrades).sort().forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                if (selectedGrade === grade) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        function updateLessonSubjectSelect(selectedSubject = '') {
            const select = document.getElementById('lessonSubject');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- اختر المادة --</option>';
            subjectsData.forEach(subject => {
                if (subject.is_active !== false) {
                    const option = document.createElement('option');
                    option.value = subject.name;
                    option.textContent = subject.name;
                    if (selectedSubject === subject.name) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
            });
        }
        
        function updateLessonTeacherSelect(selectedTeacher = '') {
            const select = document.getElementById('lessonTeacher');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- اختر الأستاذ --</option>';
            teachersData.forEach(teacher => {
                if (teacher.is_active !== false) {
                    const option = document.createElement('option');
                    option.value = teacher.name;
                    option.textContent = teacher.name;
                    if (selectedTeacher === teacher.name) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
            });
        }
        
        async function saveLesson() {
            try {
                const lessonId = document.getElementById('lessonId').value;
                const lessonData = {
                    day: document.getElementById('lessonDay').value.trim(),
                    period: parseInt(document.getElementById('lessonPeriod').value),
                    grade: document.getElementById('lessonGrade').value.trim(),
                    subject_name: document.getElementById('lessonSubject').value.trim(),
                    teacher_name: document.getElementById('lessonTeacher').value.trim(),
                    room: document.getElementById('lessonRoom').value.trim() || null,
                    is_active: document.getElementById('lessonIsActive').value === 'true',
                    school_id: currentSchoolId || null
                };
                
                if (!lessonData.day || !lessonData.period || !lessonData.grade || !lessonData.subject_name || !lessonData.teacher_name) {
                    showToast('الرجاء إدخال جميع الحقول المطلوبة', 'warning', 'تنبيه');
                    return;
                }
                
                showLoading();
                
                if (lessonId) {
                    // تحديث درس موجود
                    const index = lessonsData.findIndex(l => l.id == lessonId);
                    if (index !== -1) {
                        lessonsData[index] = { ...lessonsData[index], ...lessonData };
                        
                        // حفظ في قاعدة البيانات
                        if (supabaseClient && databaseAvailable) {
                            try {
                                const { error } = await supabaseClient
                                    .from('lessons')
                                    .update(lessonData)
                                    .eq('id', lessonId);
                                
                                if (error) throw error;
                            } catch (error) {
                                console.error('خطأ في تحديث الدرس:', error);
                                addToOfflineQueue({
                                    type: 'update',
                                    table: 'lessons',
                                    id: lessonId,
                                    data: lessonData
                                });
                            }
                        } else {
                            safeLocalStorageSetItem('lessons', JSON.stringify(lessonsData));
                        }
                        
                        showToast('تم تحديث بيانات الدرس بنجاح', 'success', 'نجح');
                    }
                } else {
                    // إضافة درس جديد
                    const newLesson = {
                        id: Date.now().toString(),
                        ...lessonData,
                        created_at: new Date().toISOString()
                    };
                    
                    lessonsData.push(newLesson);
                    
                    // حفظ في قاعدة البيانات
                    if (supabaseClient && databaseAvailable) {
                        try {
                            const { data, error } = await supabaseClient
                                .from('lessons')
                                .insert([newLesson])
                                .select();
                            
                            if (error) throw error;
                            if (data && data[0]) {
                                newLesson.id = data[0].id;
                            }
                        } catch (error) {
                            console.error('خطأ في إضافة الدرس:', error);
                            addToOfflineQueue({
                                type: 'insert',
                                table: 'lessons',
                                data: newLesson
                            });
                        }
                    } else {
                        safeLocalStorageSetItem('lessons', JSON.stringify(lessonsData));
                    }
                    
                    showToast('تم إضافة الدرس بنجاح', 'success', 'نجح');
                }
                
                hideLoading();
                renderLessonsTable();
                updateLessonsFilters();
                renderWeeklySchedule();
                bootstrap.Modal.getInstance(document.getElementById('lessonModal')).hide();
            } catch (error) {
                hideLoading();
                showToast('حدث خطأ في حفظ بيانات الدرس: ' + (error.message || 'خطأ غير معروف'), 'error', 'خطأ');
            }
        }
        
        function editLesson(id) {
            const lesson = lessonsData.find(l => l.id == id);
            if (!lesson) {
                showToast('الدرس غير موجود', 'error', 'خطأ');
                return;
            }
            
            document.getElementById('lessonId').value = lesson.id;
            document.getElementById('lessonModalTitle').textContent = 'تعديل درس';
            document.getElementById('lessonDay').value = lesson.day || '';
            document.getElementById('lessonPeriod').value = lesson.period || '';
            document.getElementById('lessonRoom').value = lesson.room || '';
            document.getElementById('lessonIsActive').value = lesson.is_active !== false ? 'true' : 'false';
            
            // تحديث القوائم المنسدلة
            updateLessonGradeSelect(lesson.grade);
            updateLessonSubjectSelect(lesson.subject_name);
            updateLessonTeacherSelect(lesson.teacher_name);
            
            const modal = new bootstrap.Modal(document.getElementById('lessonModal'));
            modal.show();
        }
        
        async function deleteLesson(id) {
            const confirmed = await showConfirmDialog('هل أنت متأكد من حذف هذا الدرس؟', 'تأكيد الحذف', 'نعم، احذف', 'إلغاء');
            if (confirmed) {
                try {
                    showLoading();
                    
                    // حذف من قاعدة البيانات
                    if (supabaseClient && databaseAvailable) {
                        try {
                            const { error } = await supabaseClient
                                .from('lessons')
                                .delete()
                                .eq('id', id);
                            
                            if (error) throw error;
                        } catch (error) {
                            console.error('خطأ في حذف الدرس:', error);
                            addToOfflineQueue({
                                type: 'delete',
                                table: 'lessons',
                                id: id
                            });
                        }
                    }
                    
                    // حذف من البيانات المحلية
                    lessonsData = lessonsData.filter(l => l.id != id);
                    safeLocalStorageSetItem('lessons', JSON.stringify(lessonsData));
                    
                    hideLoading();
                    renderLessonsTable();
                    updateLessonsFilters();
                    renderWeeklySchedule();
                    showToast('تم حذف الدرس', 'success', 'نجح');
                } catch (error) {
                    hideLoading();
                    showToast('حدث خطأ في حذف الدرس', 'error', 'خطأ');
                }
            }
        }
        
        function renderWeeklySchedule() {
            const container = document.getElementById('weeklyScheduleContainer');
            if (!container) return;
            
            // فلترة الدروس
            let filteredLessons = lessonsData;
            if (currentSchoolId && currentSchoolId !== 'admin') {
                filteredLessons = filteredLessons.filter(l => String(l.school_id) === String(currentSchoolId));
            }
            
            const gradeFilter = document.getElementById('lessonGradeFilter')?.value;
            if (gradeFilter && gradeFilter !== 'all') {
                filteredLessons = filteredLessons.filter(l => l.grade === gradeFilter);
            }
            
            const days = ['السبت', 'الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
            const periods = [1, 2, 3, 4, 5, 6, 7, 8];
            
            let html = '<div class="table-responsive"><table class="table table-bordered table-hover" style="font-size: 0.85rem;">';
            html += '<thead><tr><th>الحصة</th>';
            days.forEach(day => {
                html += `<th>${day}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            periods.forEach(period => {
                html += `<tr><td class="fw-bold" style="background: #f8f9fa;">الحصة ${period}</td>`;
                days.forEach(day => {
                    const lesson = filteredLessons.find(l => l.day === day && l.period == period && l.is_active !== false);
                    if (lesson) {
                        html += `<td style="background: linear-gradient(135deg, rgba(15, 118, 110, 0.1) 0%, rgba(20, 184, 166, 0.05) 100%);">
                            <strong>${lesson.subject_name || '---'}</strong><br>
                            <small>${lesson.teacher_name || '---'}</small><br>
                            <small class="text-muted">${lesson.room ? 'قاعة: ' + lesson.room : ''}</small>
                        </td>`;
                    } else {
                        html += '<td style="background: #f8f9fa;"></td>';
                    }
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

    </script>
</body>
</html>
